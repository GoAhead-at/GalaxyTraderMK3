<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Trader MK3 - Trade Search Process Flowcharts</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 40px;
            border-bottom: 2px solid #2196F3;
            padding-bottom: 5px;
        }
        .mermaid {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .instructions {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Galaxy Trader MK3 - Trade Search Process Flowcharts</h1>


    <h2>1. Main Trade Search Flow</h2>
    <div class="note">
        Complete process from search request to trade execution or rejection
    </div>
    <div class="mermaid">
flowchart TD
    Start([Trade Search Request<br/>SearchTradeRoutes]) --> ValidateParams{Parameters<br/>Valid?}
    
    ValidateParams -->|No| Cancel[Cancel Cue<br/>Log Error]
    ValidateParams -->|Yes| LoadParams[Load Parameters:<br/>Ship, MaxDistance, MinROI,<br/>MinAbsoluteProfit, etc.]
    
    LoadParams --> CalcSkill[Calculate Pilot Skill Level<br/>Apply Feature Gates<br/>Adjust Thresholds by Level]
    
    CalcSkill --> CheckCache[Search Cached Trades<br/>SearchCachedTrades]
    
    CheckCache --> CacheExists{Cache<br/>Exists?}
    
    CacheExists -->|No| CacheEmpty[Cache Empty]
    CacheExists -->|Yes| IterateCache[Iterate Cache Entries<br/>Check Each Entry]
    
    IterateCache --> ValidateEntry{Entry<br/>Valid?}
    
    ValidateEntry -->|Expired| RemoveExpired[Remove Entry]
    ValidateEntry -->|Invalid Structure| SkipEntry1[Skip Entry]
    ValidateEntry -->|Valid| CheckOffers{Offers<br/>Still Exist?}
    
    CheckOffers -->|No| SkipEntry1
    CheckOffers -->|Yes| CheckDistance1{Distance<br/>OK?}
    
    CheckDistance1 -->|No| SkipEntry1
    CheckDistance1 -->|Yes| CheckIllegal1{Illegal<br/>Ware?}
    
    CheckIllegal1 -->|Yes & Not Allowed| SkipEntry1
    CheckIllegal1 -->|No| CheckBasket1{Ware in<br/>Basket?}
    
    CheckBasket1 -->|No| SkipEntry1
    CheckBasket1 -->|Yes| CheckProfit1{Profit<br/>OK?}
    
    CheckProfit1 -->|No| SkipEntry1
    CheckProfit1 -->|Yes| QueryFresh[Query Fresh Offers<br/>From Stations]
    
    QueryFresh --> ValidateFresh{Fresh Offers<br/>Valid?}
    
    ValidateFresh -->|No| SkipEntry1
    ValidateFresh -->|Yes| CheckROIDrop{ROI Drop<br/>&lt; Tolerance?}
    
    CheckROIDrop -->|No| DeleteStale[Delete Stale<br/>Cache Entry]
    CheckROIDrop -->|Yes| AddToCacheList[Add to<br/>Trade List]
    
    RemoveExpired --> NextEntry{More<br/>Entries?}
    SkipEntry1 --> NextEntry
    DeleteStale --> NextEntry
    AddToCacheList --> NextEntry
    
    NextEntry -->|Yes| IterateCache
    NextEntry -->|No| BuildDiverseCache[Build Diverse List<br/>Top 5 per Ware<br/>Unique Station Pairs]
    
    CacheEmpty --> BuildDiverseCache
    BuildDiverseCache --> ResetCooldown{Found<br/>Cached Trade?}
    
    ResetCooldown -->|Yes| ClearCooldown[Reset Cooldown<br/>for Ship]
    ResetCooldown -->|No| KeepCooldown[Keep Cooldown<br/>Active]
    
    ClearCooldown --> CheckDiversity{Cache Diversity<br/>OK?<br/>2+ wares, 5+ trades}
    KeepCooldown --> CheckDiversity
    
    CheckDiversity -->|Yes| ReturnCache[Return Cached Trades]
    CheckDiversity -->|No| ShouldLiveSearch{Should Trigger<br/>Live Search?}
    
    ShouldLiveSearch -->|No Cache Found| CheckCooldown{Check Cooldown<br/>for Ship}
    ShouldLiveSearch -->|Low Diversity| AllowLive[Allow Live Search<br/>No Cooldown]
    
    CheckCooldown --> HasCooldown{Has Cooldown<br/>Data?}
    
    HasCooldown -->|No| FirstMiss[First Cache Miss<br/>Set Cooldown: 10s]
    HasCooldown -->|Yes| CalcRemaining[Calculate Remaining<br/>Cooldown Time]
    
    CalcRemaining --> CooldownActive{Cooldown<br/>Still Active?}
    
    CooldownActive -->|Yes| BlockLive[Block Live Search<br/>Return Empty Results]
    CooldownActive -->|No| UpdateCooldown[Update Cooldown<br/>Double Duration<br/>Max: 60s]
    
    FirstMiss --> AllowLive
    UpdateCooldown --> AllowLive
    
    AllowLive --> TriggerLive[Trigger Live Search<br/>SearchLiveTrades]
    
    TriggerLive --> FindOffers[Find Sell/Buy Offers<br/>Native C++ Actions]
    
    FindOffers --> FilterOffers[Pre-Filter Offers:<br/>Distance, Range Check]
    
    FilterOffers --> PrepareBatch[Prepare Batch Data<br/>Group by Ware<br/>Limit per Ware]
    
    PrepareBatch --> StartBatch[Start Batch Processing<br/>ProcessTradeMatchingBatch]
    
    StartBatch --> SetWaiting[Set WaitingForBatch = true<br/>Exit SearchTradeRoutes]
    
    SetWaiting --> BatchComplete[Batch Processing<br/>Complete]
    
    BatchComplete --> ResumeSearch[SearchLiveTrades_Resume<br/>Receives Results]
    
    ResumeSearch --> FilterByShip[Filter Trades by Ship:<br/>Ware Basket, Illegal,<br/>Blacklist, Path Blocked]
    
    FilterByShip --> BuildDiverseLive[Build Diverse List<br/>Top 5 per Ware<br/>Unique Station Pairs]
    
    BuildDiverseLive --> SignalBack[Signal SearchTradeRoutes<br/>with Results]
    
    SignalBack --> ExtractResults[Extract Live Search Results<br/>from global.$GT_SearchResult]
    
    ReturnCache --> HasBestTrade{Best Trade<br/>Found?}
    ExtractResults --> HasBestTrade
    
    BlockLive --> HasBestTrade
    
    HasBestTrade -->|Yes| ReserveTrade[Reserve Trade Route<br/>Fleet Coordination]
    
    ReserveTrade --> ExecuteTrade[Execute Trade<br/>Signal ExecuteTrade Cue<br/>Send Trade List to AI]
    
    ExecuteTrade --> Cleanup[Cleanup:<br/>Release Search Lock<br/>Remove AI Parameters]
    
    HasBestTrade -->|No| AnalyzeRejection[Analyze Rejection:<br/>Log Statistics<br/>Show Reasons]
    
    AnalyzeRejection --> SendNoTrade[Signal AI:<br/>GT_No_Trade_Found]
    
    SendNoTrade --> Cleanup
    Cleanup --> End([End])
    
    style Start fill:#e1f5ff
    style End fill:#e1f5ff
    style CheckCache fill:#fff4e6
    style CheckCooldown fill:#fff4e6
    style BlockLive fill:#ffcdd2
    style ReturnCache fill:#c8e6c9
    style ExecuteTrade fill:#c8e6c9
    style QueryFresh fill:#e3f2fd
    style FindOffers fill:#e3f2fd
    style BatchComplete fill:#f3e5f5
    </div>

    <h2>2. Cache Search Detailed Flow</h2>
    <div class="note">
        Detailed validation and filtering process for cached trade entries
    </div>
    <div class="mermaid">
flowchart TD
    CacheStart([SearchCachedTrades]) --> ValidateCache{Cache Exists<br/>& Count > 0?}
    
    ValidateCache -->|No| ReturnEmpty[Return Empty Results]
    ValidateCache -->|Yes| InitStats[Initialize Statistics:<br/>checkedEntries, validEntries,<br/>expiredEntries]
    
    InitStats --> LoopStart[For Each Cache Entry]
    
    LoopStart --> IncChecked[Increment<br/>checkedEntries]
    
    IncChecked --> CheckStructure{Entry Structure<br/>Valid?}
    
    CheckStructure -->|No| IncInvalid[Track: invalidStructure<br/>Skip Entry]
    CheckStructure -->|Yes| CheckAge{Entry Age<br/>&lt; Max Age?}
    
    CheckAge -->|No| RemoveExpired2[Remove Entry<br/>Track: expired]
    CheckAge -->|Yes| CheckOffers2{Offers<br/>Still Exist?}
    
    CheckOffers2 -->|No| TrackOffersGone[Track: offersNoLongerExist<br/>Skip Entry]
    CheckOffers2 -->|Yes| CheckAvailable{Offers<br/>Available?}
    
    CheckAvailable -->|No| TrackOutOfStock[Track: offersNotAvailable<br/>Skip Entry]
    CheckAvailable -->|Yes| CheckOperational{Stations<br/>Operational?}
    
    CheckOperational -->|No| TrackStationDown[Track: stationNotOperational<br/>Skip Entry]
    CheckOperational -->|Yes| CheckFailedSector{Failed<br/>Sector Pair?}
    
    CheckFailedSector -->|Yes| TrackFailedSector[Track: failedSectorPair<br/>Skip Entry]
    CheckFailedSector -->|No| CheckRange{Range Distance<br/>&lt;= MaxDistance?}
    
    CheckRange -->|No| TrackOutOfRange[Track: outOfRange<br/>Skip Entry]
    CheckRange -->|Yes| CheckReachable{Reachable<br/>Path?}
    
    CheckReachable -->|No| TrackUnreachable[Track: unreachable<br/>Skip Entry]
    CheckReachable -->|Yes| CheckIllegal2{Illegal<br/>Ware?}
    
    CheckIllegal2 -->|Yes & Not Allowed| TrackIllegal[Track: illegal<br/>Skip Entry]
    CheckIllegal2 -->|No| CheckBasket2{Ware in<br/>Basket?}
    
    CheckBasket2 -->|No| TrackBasket[Track: wareBasket<br/>Skip Entry]
    CheckBasket2 -->|Yes| CheckDistance2{Total Distance<br/>&lt;= MaxDistance?}
    
    CheckDistance2 -->|No| TrackDistance[Track: distanceConstraint<br/>Skip Entry]
    CheckDistance2 -->|Yes| CheckProfit2{Profit<br/>&gt;= MinProfit?}
    
    CheckProfit2 -->|No| TrackProfit[Track: profitConstraint<br/>Skip Entry]
    CheckProfit2 -->|Yes| CheckEfficiency{Efficiency<br/>Good Enough?}
    
    CheckEfficiency -->|No| TrackEfficiency[Track: efficiencyThreshold<br/>Skip Entry]
    CheckEfficiency -->|Yes| QueryFresh2[Query Fresh Offers]
    
    QueryFresh2 --> FreshValid{Fresh Offers<br/>Valid?}
    
    FreshValid -->|Stations Gone| TrackStationsGone[Track: stationsWaresNoLongerExist<br/>Skip Entry]
    FreshValid -->|Not Available| TrackFreshUnavailable[Track: freshOffersNotAvailable<br/>Skip Entry]
    FreshValid -->|Amount Too Low| TrackFreshLowAmount[Track: insufficientTradeableAmount<br/>Skip Entry]
    FreshValid -->|Valid| CheckROI2{ROI<br/>&gt;= Threshold?}
    
    CheckROI2 -->|No| TrackROI[Track: roiBelowThreshold<br/>Delete Entry]
    CheckROI2 -->|Yes| CheckProfit3{Profit<br/>&gt;= MinProfit?}
    
    CheckProfit3 -->|No| TrackProfitLow[Track: profitTooLow<br/>Delete Entry]
    CheckProfit3 -->|Yes| CheckROIDrop2{ROI Drop<br/>&lt;= Tolerance?}
    
    CheckROIDrop2 -->|No| TrackROIDrop[Track: roiDropTooHigh<br/>Delete Entry]
    CheckROIDrop2 -->|Yes| AddValid[Add to Trade List<br/>Increment validEntries]
    
    IncInvalid --> NextEntry2{More<br/>Entries?}
    RemoveExpired2 --> NextEntry2
    TrackOffersGone --> NextEntry2
    TrackOutOfStock --> NextEntry2
    TrackStationDown --> NextEntry2
    TrackFailedSector --> NextEntry2
    TrackOutOfRange --> NextEntry2
    TrackUnreachable --> NextEntry2
    TrackIllegal --> NextEntry2
    TrackBasket --> NextEntry2
    TrackDistance --> NextEntry2
    TrackProfit --> NextEntry2
    TrackEfficiency --> NextEntry2
    TrackStationsGone --> NextEntry2
    TrackFreshUnavailable --> NextEntry2
    TrackFreshLowAmount --> NextEntry2
    TrackROI --> NextEntry2
    TrackProfitLow --> NextEntry2
    TrackROIDrop --> NextEntry2
    AddValid --> NextEntry2
    
    NextEntry2 -->|Yes| LoopStart
    NextEntry2 -->|No| BuildDiverse[Build Diverse List:<br/>Group by Ware<br/>Select Top 5 per Ware<br/>Unique Station Pairs]
    
    BuildDiverse --> ReturnResults[Return Results via<br/>global.$GT_SearchResult]
    
    ReturnEmpty --> ReturnResults
    ReturnResults --> CacheEnd([End])
    
    style CacheStart fill:#e1f5ff
    style CacheEnd fill:#e1f5ff
    style QueryFresh2 fill:#e3f2fd
    style AddValid fill:#c8e6c9
    style TrackROIDrop fill:#ffcdd2
    style TrackROI fill:#ffcdd2
    </div>

    <h2>3. Cooldown Mechanism State Diagram</h2>
    <div class="note">
        How the cache miss cooldown prevents infinite loops (10s → 20s → 40s → 60s max)
    </div>
    <div class="mermaid">
stateDiagram-v2
    [*] --> NoCooldown: Search Request
    
    NoCooldown --> CacheSearch: Check Cache
    CacheSearch --> CacheHit: Trade Found
    CacheSearch --> CacheMiss: No Trade
    
    CacheHit --> ResetCooldown: Reset to 0
    ResetCooldown --> [*]
    
    CacheMiss --> CheckCooldown: Evaluate Cooldown
    
    CheckCooldown --> FirstMiss: No Cooldown Data
    CheckCooldown --> CooldownActive: Has Data
    
    FirstMiss: 10s cooldown set
    FirstMiss --> Wait10s: Wait Period
    
    CooldownActive --> CheckTime: Calculate Remaining
    CheckTime --> Blocked: Still Active
    CheckTime --> Expired: Cooldown Expired
    
    Blocked: Skip Live Search
    Blocked --> [*]: Return Empty
    
    Expired --> IncreaseCooldown: Double Duration
    Wait10s --> AllowLiveSearch: After 10s
    
    IncreaseCooldown --> SecondMiss: 20s cooldown
    IncreaseCooldown --> ThirdMiss: 40s cooldown
    IncreaseCooldown --> MaxCooldown: 60s max
    
    SecondMiss --> AllowLiveSearch: After 20s
    ThirdMiss --> AllowLiveSearch: After 40s
    MaxCooldown --> AllowLiveSearch: After 60s
    
    AllowLiveSearch --> ExecuteLiveSearch: Perform Search
    ExecuteLiveSearch --> UpdateCooldown: Update Timer
    UpdateCooldown --> [*]: Return Results
    </div>

    <h2>4. Cooldown Duration Progression</h2>
    <div class="note">
        Visual representation of cooldown escalation
    </div>
    <div class="mermaid">
stateDiagram-v2
    [*] --> FirstMiss: Cache Miss #1
    FirstMiss: 10s cooldown
    
    FirstMiss --> SecondMiss: Cache Miss #2<br/>(after 10s)
    SecondMiss: 20s cooldown
    
    SecondMiss --> ThirdMiss: Cache Miss #3<br/>(after 20s)
    ThirdMiss: 40s cooldown
    
    ThirdMiss --> MaxCooldown: Cache Miss #4<br/>(after 40s)
    MaxCooldown: 60s cooldown (max)
    
    MaxCooldown --> MaxCooldown: Cache Miss #5+<br/>(stays at 60s)
    
    FirstMiss --> [*]: Cache Hit
    SecondMiss --> [*]: Cache Hit
    ThirdMiss --> [*]: Cache Hit
    MaxCooldown --> [*]: Cache Hit
    
    note right of FirstMiss
        Cooldown resets to 0
        when cache works
    end note
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>

