<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_CoreSystem" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- Core System Initialization -->
    <cue name="SystemInit" instantiate="true" version="1">
      <conditions>
        <check_any>
          <event_player_created/>
          <event_game_loaded/>
        </check_any>
        <check_value value="not global.$GT_Initialized? or not global.$GT_Initialized"/>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Core system initializing...'" chance="100"/>
        </do_if>

        <!-- Initialize global data structures -->
        <set_value name="global.$GT_Ships" exact="table[]" comment="Registry of all managed ships"/>
        <set_value name="global.$GT_FleetData" exact="table[]" comment="Fleet coordination data"/>
        <set_value name="global.$GT_MarketData" exact="table[]" comment="Market intelligence cache"/>
        <set_value name="global.$GT_TerritoryData" exact="table[]" comment="Territory management data"/>
        <set_value name="global.$GT_SessionStats" exact="table[]" comment="Current session statistics"/>
        <set_value name="global.$GT_TradesAwaitingValidation" exact="table[]" comment="Trades found by MD, awaiting AI validation"/>
        
        <!-- PHASE 1: Initialize event-driven signaling system -->
        <set_value name="global.$GT_XPEventQueue" exact="[]" comment="Event queue for instant XP processing"/>
        
        <!-- PHASE 2: Initialize training event system -->
        <set_value name="global.$GT_TrainingEventQueue" exact="[]" comment="Event queue for instant training processing"/>
        
        <!-- PHASE 3: Initialize fleet and market event systems -->
        <set_value name="global.$GT_FleetEventQueue" exact="[]" comment="Event queue for instant fleet coordination"/>
        <set_value name="global.$GT_MarketEventQueue" exact="[]" comment="Event queue for instant market intelligence"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Event-driven signaling system initialized (XP + Training + Fleet + Market)'" chance="100"/>
        </do_if>
        
        <!-- Initialize configuration settings for re-enabled features -->
        <do_if value="not global.$GT_Config?">
          <set_value name="global.$GT_Config" exact="table[]"/>
        </do_if>
        
        <do_if value="not global.$GT_Config.$Fleet?">
          <set_value name="global.$GT_Config.$Fleet" exact="table[]"/>
        </do_if>
        
        <do_if value="not global.$GT_Config.$Territory?">
          <set_value name="global.$GT_Config.$Territory" exact="table[]"/>
        </do_if>
        
        <!-- RE-ENABLED FEATURES: Set defaults to enabled since event-driven system is now stable -->
        <!-- Legacy load balancing config removed - pure event-driven system -->
        
        <do_if value="not global.$GT_Config.$Fleet.$EnablePerformanceMonitoring?">
          <set_value name="global.$GT_Config.$Fleet.$EnablePerformanceMonitoring" exact="true" comment="Fleet performance monitoring"/>
        </do_if>
        
        <do_if value="not global.$GT_Config.$Territory.$EnableConflictResolution?">
          <set_value name="global.$GT_Config.$Territory.$EnableConflictResolution" exact="true" comment="Territory conflict resolution"/>
        </do_if>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Previously disabled features have been re-enabled with event-driven architecture'" chance="100"/>
        </do_if>
        
        <!-- Initialize subsystems -->
        <set_value name="global.$GT_SessionStats.$StartTime" exact="player.age"/>
        <set_value name="global.$GT_SessionStats.$TotalProfit" exact="0Cr"/>
        <set_value name="global.$GT_SessionStats.$TradesCompleted" exact="0"/>
        <set_value name="global.$GT_SessionStats.$XPGained" exact="0"/>
        
        <!-- Cleanup: Remove incorrect legacy globals (these were local variables incorrectly saved as globals) -->
        <set_value name="$cleanupCount" exact="0"/>
        <do_if value="global.$gt_AdvancedAnalytics?">
          <remove_value name="global.$gt_AdvancedAnalytics"/>
          <set_value name="$cleanupCount" exact="$cleanupCount + 1"/>
        </do_if>
        <do_if value="global.$gt_FleetCoord?">
          <remove_value name="global.$gt_FleetCoord"/>
          <set_value name="$cleanupCount" exact="$cleanupCount + 1"/>
        </do_if>
        <do_if value="global.$gt_SatelliteIntel?">
          <remove_value name="global.$gt_SatelliteIntel"/>
          <set_value name="$cleanupCount" exact="$cleanupCount + 1"/>
        </do_if>
        <do_if value="global.$gt_ThreatIntel?">
          <remove_value name="global.$gt_ThreatIntel"/>
          <set_value name="$cleanupCount" exact="$cleanupCount + 1"/>
        </do_if>
        <do_if value="$cleanupCount gt 0 and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Core] Cleaned up ' + $cleanupCount + ' incorrect legacy globals (gt_AdvancedAnalytics, gt_FleetCoord, gt_SatelliteIntel, gt_ThreatIntel)'" chance="100"/>
        </do_if>
        
        <!-- Station Subordinate Order Access: Protected order IDs list -->
        <!-- Orders in this list are protected from being replaced by vanilla TradeRoutine -->
        <!-- when the ship is assigned as a station subordinate (lib.request.orders patch) -->
        <set_value name="global.$GT_ProtectedOrderIDs" exact="['GalaxyTraderMK3', 'GalaxyTraderMK2', 'GalaxyTraderMK1']" comment="Protected GT order IDs"/>
        
        <!-- Set initialization complete flag -->
        <set_value name="global.$GT_Initialized" exact="true"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Core system initialization complete'" chance="100"/>
        </do_if>
        
        <!-- Show welcome notification -->
        <show_notification text="'GalaxyTrader MK3 Activated'" timeout="5s"/>
        <!-- Broadcast initialization signal for dependent modules -->
        <signal_cue cue="md.GT_CoreSystem.SystemInit"/>
        <!-- Legacy registration catch-up: seed original ship names for already-registered pilots -->
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0 and global.$GT_Pilots?">
          <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
          <do_all exact="$shipKeys.count" counter="$i">
            <set_value name="$ship" exact="$shipKeys.{$i}"/>
            <set_value name="$pilot" exact="$ship.pilot"/>
            <do_if value="$pilot and global.$GT_Pilots.{$pilot}? and not global.$GT_Pilots.{$pilot}.$OriginalShipName?">
              <run_actions ref="md.GT_Ship_Management.Strip_GT_Name_Formatting" result="$cleanedName">
                <param name="shipName" value="$ship.knownname"/>
              </run_actions>
              <set_value name="global.$GT_Pilots.{$pilot}.$OriginalShipName" exact="$cleanedName"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Core] SystemInit: Seeded cleaned original name for pilot ' + $pilot.name + ': ' + $cleanedName + ' (from: ' + $ship.knownname + ')'" chance="100"/>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
      </actions>
    </cue>
    
    <!-- Ship Registration System -->
    <cue name="RegisterShip" instantiate="true">
      <conditions>
        <event_object_order_ready object="player.entity" comment="Detect when ship gets trading order"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        
        <!-- Validate ship -->
        <do_if value="$ship.isplayerowned and $ship.primarypurpose == purpose.trade">
          <!-- Check if already registered -->
          <do_if value="not global.$GT_Ships.{$ship}?">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] Registering new trading ship: ' + $ship.knownname" chance="100"/>
            </do_if>
            
            <!-- Create ship data structure -->
            <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
            <set_value name="global.$GT_Ships.{$ship}.$RegisterTime" exact="player.age"/>
            <set_value name="global.$GT_Ships.{$ship}.$Level" exact="1"/>
            <set_value name="global.$GT_Ships.{$ship}.$XP" exact="0"/>
            <set_value name="global.$GT_Ships.{$ship}.$TotalProfit" exact="0Cr"/>
            <set_value name="global.$GT_Ships.{$ship}.$TradesCompleted" exact="0"/>
            <set_value name="global.$GT_Ships.{$ship}.$TotalTrades" exact="0"/>
            <set_value name="global.$GT_Ships.{$ship}.$LastTradeProfit" exact="0Cr"/>
            <set_value name="global.$GT_Ships.{$ship}.$LastMoney" exact="$ship.money"/>
            <set_value name="global.$GT_Ships.{$ship}.$TrainingCompleted" exact="[]"/>
            <set_value name="global.$GT_Ships.{$ship}.$ThreatReports" exact="0"/>
            <set_value name="global.$GT_Ships.{$ship}.$LastThreatTime" exact="0"/>
            <set_value name="global.$GT_Ships.{$ship}.$Territory" exact="null"/>
            <set_value name="global.$GT_Ships.{$ship}.$LastUpdate" exact="player.age"/>
            
            <!-- Notify player -->
            <do_if value="global.$GT_Config.$Notifications.$FleetUpdates?">
              <show_notification text="'GalaxyTrader MK3: ' + $ship.knownname + ' registered for advanced trading'" timeout="3s"/>
            </do_if>
            <!-- Trigger XP system pilot registration for ship renaming -->
            <set_value name="global.$GT_RegisterPilot" exact="$ship.pilot"/>
            <set_value name="global.$GT_RegisterShip" exact="$ship"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] XP registration triggered for pilot ' + $ship.pilot.name + ' on ship ' + $ship.knownname" chance="100"/>
            </do_if>
            <!-- Event-driven registration processing -->
            <signal_cue_instantly cue="md.GT_XP_Training.RegisterPilot" param="table[$Pilot=$ship.pilot, $Ship=$ship]"/>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Ship Unregistration System -->
    <cue name="UnregisterShip" instantiate="true">
      <conditions>
        <event_object_destroyed object="player.entity"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        
        <!-- Check if ship was registered -->
        <do_if value="global.$GT_Ships.{$ship}?">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Unregistering destroyed ship: ' + $ship.knownname" chance="100"/>
          </do_if>
          
          <!-- OPTIMIZATION: Update cached active trader count incrementally -->
          <!-- Only decrement if ship was operational (matches counting logic) -->
          <do_if value="$ship.exists and $ship.isoperational and global.$GT_ActiveTraderCount? and global.$GT_ActiveTraderCount gt 0">
            <set_value name="global.$GT_ActiveTraderCount" operation="subtract"/>
          </do_if>
          
          <!-- Clean up data -->
          <remove_value name="global.$GT_Ships.{$ship}"/>
          <remove_value name="global.$GT_FleetData.{$ship}"/>
          <!-- Use library function to clear pending trade data -->
          <!-- Phase 3: Enhanced cleanup includes reservations, work items, scheduler state -->
          <run_actions ref="md.GT_Libraries_General.GT_ClearPendingTradeData">
            <param name="ship" value="$ship"/>
          </run_actions>
          <run_actions ref="md.GT_Libraries_General.GT_ClearUICreditsDueForShip">
            <param name="ship" value="$ship"/>
          </run_actions>
          
          <!-- Legacy SearchQueue cleanup removed in AI migration -->
          
          <!-- M2 FIX: Clean up dead/despawned pilots from GT_Pilots to prevent unbounded growth -->
          <do_if value="global.$GT_Pilots? and global.$GT_Pilots.keys.count gt 0">
            <set_value name="$deadPilots" exact="[]"/>
            <do_all exact="global.$GT_Pilots.keys.count" counter="$pi">
              <set_value name="$checkPilot" exact="global.$GT_Pilots.keys.{$pi}"/>
              <set_value name="$pilotAlive" exact="@$checkPilot.exists"/>
              <do_if value="not $pilotAlive">
                <append_to_list name="$deadPilots" exact="$checkPilot"/>
              </do_if>
            </do_all>
            <do_all exact="$deadPilots.count" counter="$di">
              <remove_value name="global.$GT_Pilots.{$deadPilots.{$di}}"/>
            </do_all>
            <do_if value="$deadPilots.count gt 0 and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] Cleaned up ' + $deadPilots.count + ' dead/despawned pilot(s) from GT_Pilots'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Commander Destruction Handler - Handle Subordinates When Commander is Destroyed -->
    <cue name="HandleCommanderDestroyed" instantiate="true">
      <conditions>
        <event_object_destroyed object="player.entity"/>
      </conditions>
      <actions>
        <set_value name="$destroyedCommander" exact="event.object"/>
        
        <!-- BUG C6 FIX: Don't gate on global.$GT_Ships.{$destroyedCommander} alone.
             UnregisterShip listens on the same event and may run first, removing the
             commander from the registry before we get here.  Instead, collect
             subordinates directly from the ship object and check for GT-registered ones. -->
        
        <!-- Find all subordinates of this commander -->
        <!-- Use safe operator since ship is destroyed and allsubordinates might not be accessible -->
        <set_value name="$subordinates" exact="[]"/>
        <do_if value="$destroyedCommander.allsubordinates?">
          <set_value name="$subordinates" exact="@$destroyedCommander.allsubordinates"/>
        </do_if>
        <do_if value="(if $subordinates != null then $subordinates.count else 0) gt 0">
          <!-- Quick scan: does this commander have any GT subordinates? -->
          <set_value name="$hasGTSubordinates" exact="false"/>
          <do_all exact="$subordinates.count" counter="$chk">
            <do_if value="global.$GT_Ships.{$subordinates.{$chk}}?">
              <set_value name="$hasGTSubordinates" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          <do_if value="$hasGTSubordinates">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] Commander destroyed: ' + @$destroyedCommander.knownname + ' (ID: ' + @$destroyedCommander.idcode + ') - checking ' + $subordinates.count + ' subordinates'" chance="100"/>
            </do_if>
            <!-- First pass: Identify promoted subordinate (if any) -->
            <!-- When X4 promotes a subordinate to commander, it:
                 1. No longer has a commander (or commander is destroyed)
                 2. Gets a GT order directly (not via Assist)
                 3. May have subordinates assigned (but timing can vary) -->
            <set_value name="$promotedSubordinate" exact="null"/>
            <do_all exact="$subordinates.count" counter="$i">
              <set_value name="$subordinate" exact="$subordinates.{$i}"/>
              <do_if value="$subordinate.exists and global.$GT_Ships.{$subordinate}?">
                <!-- Check if this subordinate was promoted -->
                <set_value name="$hasNoCommander" exact="false"/>
                <do_if value="not $subordinate.commander? or not $subordinate.commander.exists or $subordinate.commander == $destroyedCommander">
                  <set_value name="$hasNoCommander" exact="true"/>
                </do_if>
                
                <!-- Check if subordinate has GT order directly (not via Assist) - indicates promotion -->
                <set_value name="$hasDirectGTOrder" exact="false"/>
                <do_if value="$hasNoCommander and $subordinate.defaultorder? and (@$subordinate.defaultorder.id == 'GalaxyTraderMK3' or @$subordinate.defaultorder.id == 'GalaxyTraderMK2' or @$subordinate.defaultorder.id == 'GalaxyTraderMK1')">
                  <set_value name="$hasDirectGTOrder" exact="true"/>
                </do_if>
                
                <!-- Also check if subordinate has subordinates (another indicator) -->
                <set_value name="$hasSubordinates" exact="false"/>
                <do_if value="$subordinate.allsubordinates? and @$subordinate.allsubordinates.count gt 0">
                  <set_value name="$hasSubordinates" exact="true"/>
                </do_if>
                
                <!-- If subordinate has no commander AND (has direct GT order OR has subordinates), it was promoted -->
                <do_if value="$hasNoCommander and ($hasDirectGTOrder or $hasSubordinates)">
                  <set_value name="$promotedSubordinate" exact="$subordinate"/>
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-Core] Subordinate ' + $subordinate.idcode + ' was promoted to commander (has direct GT order: ' + $hasDirectGTOrder + ', has subordinates: ' + $hasSubordinates + ')'" chance="100"/>
                  </do_if>
                  <break/>
                </do_if>
              </do_if>
            </do_all>
            
            <!-- Second pass: Process all subordinates -->
            <do_all exact="$subordinates.count" counter="$i">
              <set_value name="$subordinate" exact="$subordinates.{$i}"/>
              
              <!-- Check if subordinate is in GT registry -->
              <do_if value="$subordinate.exists and global.$GT_Ships.{$subordinate}?">
                <!-- Skip cleanup if this subordinate was promoted to commander -->
                <do_if value="$promotedSubordinate? and $subordinate == $promotedSubordinate">
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-Core] Skipping cleanup for promoted subordinate ' + $subordinate.idcode + ' (now commander)'" chance="100"/>
                  </do_if>
                  
                  <!-- Update state to reflect promotion (no longer subordinate, now commander) -->
                  <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
                    $Ship = $subordinate,
                    $UpdateType = 'Promoted_To_Commander',
                    $Commander = null,
                    $CommanderHasGT = false
                  ]"/>
                </do_if>
                <do_else>
                  <!-- Check if X4 automatically assigned a new commander -->
                  <set_value name="$newCommander" exact="null"/>
                  <set_value name="$hasNewCommander" exact="false"/>
                  <do_if value="$subordinate.commander? and $subordinate.commander.exists and $subordinate.commander != $destroyedCommander">
                    <set_value name="$newCommander" exact="$subordinate.commander"/>
                    <set_value name="$hasNewCommander" exact="true"/>
                  </do_if>
                  
                  <!-- If no explicit commander but promoted subordinate exists, check if subordinate should follow promoted one -->
                  <!-- CRITICAL: Check both commander property AND promoted subordinate's subordinates list -->
                  <!-- X4 might not have updated $subordinate.commander yet, but subordinates list is updated immediately -->
                  <do_if value="not $hasNewCommander and @$promotedSubordinate.exists">
                    <!-- Check 1: Is subordinate's commander property updated? -->
                    <do_if value="$subordinate.commander? and $subordinate.commander == $promotedSubordinate">
                      <set_value name="$newCommander" exact="$promotedSubordinate"/>
                      <set_value name="$hasNewCommander" exact="true"/>
                      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                        <debug_text text="'[GT-Core] Subordinate ' + $subordinate.idcode + ' has commander property updated to ' + $promotedSubordinate.idcode" chance="100"/>
                      </do_if>
                    </do_if>
                    <!-- Check 2: Is subordinate in promoted subordinate's subordinates list? (handles timing issues) -->
                    <do_if value="not $hasNewCommander and $promotedSubordinate.allsubordinates?">
                      <set_value name="$promotedSubordinates" exact="@$promotedSubordinate.allsubordinates"/>
                      <do_if value="(if $promotedSubordinates != null then $promotedSubordinates.count else 0) gt 0">
                        <do_all exact="$promotedSubordinates.count" counter="$j">
                          <do_if value="$promotedSubordinates.{$j} == $subordinate">
                            <set_value name="$newCommander" exact="$promotedSubordinate"/>
                            <set_value name="$hasNewCommander" exact="true"/>
                            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                              <debug_text text="'[GT-Core] Subordinate ' + $subordinate.idcode + ' found in promoted commander ' + $promotedSubordinate.idcode + ' subordinates list (timing workaround)'" chance="100"/>
                            </do_if>
                            <break/>
                          </do_if>
                        </do_all>
                      </do_if>
                    </do_if>
                    <!-- Debug: Log if subordinate still not found -->
                    <do_if value="not $hasNewCommander and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                      <set_value name="$subCommander" exact="null"/>
                      <do_if value="$subordinate.commander?">
                        <set_value name="$subCommander" exact="$subordinate.commander"/>
                      </do_if>
                      <debug_text text="'[GT-Core] Subordinate ' + $subordinate.idcode + ' not reassigned to promoted commander ' + $promotedSubordinate.idcode + ' (commander: ' + $subCommander + ', promoted has ' + (@$promotedSubordinate.allsubordinates.count) + ' subordinates)'" chance="100"/>
                    </do_if>
                  </do_if>
                  
                  <!-- Check if new commander has GT order -->
                  <set_value name="$newCommanderHasGT" exact="false"/>
                  <do_if value="$hasNewCommander and $newCommander.defaultorder? and (@$newCommander.defaultorder.id == 'GalaxyTraderMK3' or @$newCommander.defaultorder.id == 'GalaxyTraderMK2' or @$newCommander.defaultorder.id == 'GalaxyTraderMK1')">
                    <set_value name="$newCommanderHasGT" exact="true"/>
                  </do_if>
                  
                  <do_if value="$hasNewCommander and $newCommanderHasGT">
                    <!-- New commander exists and has GT order - subordinate continues with new commander -->
                    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                      <debug_text text="'[GT-Core] Subordinate ' + $subordinate.idcode + ' automatically reassigned to new GT commander ' + $newCommander.idcode + ' (X4 auto-promotion)'" chance="100"/>
                    </do_if>
                    
                    <!-- Update state to reflect new commander -->
                    <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
                      $Ship = $subordinate,
                      $UpdateType = 'Commander_Changed',
                      $Commander = $newCommander,
                      $CommanderHasGT = true
                    ]"/>
                  </do_if>
                  <do_else>
                    <!-- No new commander OR new commander doesn't have GT order - trigger cleanup -->
                    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                      <debug_text text="'[GT-Core] Subordinate ' + $subordinate.idcode + ' lost GT commander (destroyed) - triggering cleanup'" chance="100"/>
                    </do_if>
                    
                    <!-- Get original name for cleanup -->
                    <set_value name="$originalName" exact="null"/>
                    <do_if value="global.$GT_Ships.{$subordinate}? and global.$GT_Ships.{$subordinate}.$OriginalShipName?">
                      <set_value name="$originalName" exact="global.$GT_Ships.{$subordinate}.$OriginalShipName"/>
                    </do_if>
                    <do_elseif value="$subordinate.pilot? and global.$GT_Pilots.{$subordinate.pilot}? and global.$GT_Pilots.{$subordinate.pilot}.$OriginalShipName?">
                      <set_value name="$originalName" exact="global.$GT_Pilots.{$subordinate.pilot}.$OriginalShipName"/>
                    </do_elseif>
                    <do_elseif value="$subordinate.macro?">
                      <set_value name="$originalName" exact="@$subordinate.macro.name"/>
                    </do_elseif>
                    
                    <!-- Trigger cleanup -->
                    <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
                      $Ship = $subordinate,
                      $Pilot = $subordinate.pilot,
                      $Reason = 'Commander destroyed (no new GT commander)',
                      $OriginalName = $originalName
                    ]"/>
                  </do_else>
                </do_else>
              </do_if>
            </do_all>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Periodic System Maintenance removed: migrated to event-driven triggers -->
    
    <!-- System Shutdown Handler -->
    <cue name="SystemShutdown" instantiate="true">
      <conditions>
        <event_game_saved/>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Saving system state...'" chance="100"/>
        </do_if>
        
        <!-- PERFORMANCE: LastUpdate timestamp update removed -->
        <!-- LastUpdate should only be updated when ships actually do something (trade completes, registers, etc.) -->
        <!-- Periodic update made all ships appear "active" even when idle, breaking the active check -->
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] System state saved'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    <!-- Ship Registration Signal Handler - QUEUED VERSION -->
    <!-- Queues registrations to prevent stutter when assigning orders to many ships -->
    <cue name="HandleShipRegistration" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Register_Ship'" comment="Handle ship registration from AI scripts"/>
      </conditions>
      <actions>
        <set_value name="$registrationData" exact="event.param2"/>
        
        <!-- Initialize registration queue if needed -->
        <do_if value="not global.$GT_RegistrationQueue?">
          <set_value name="global.$GT_RegistrationQueue" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_RegistrationQueue.$Ships?">
          <set_value name="global.$GT_RegistrationQueue.$Ships" exact="[]"/>
        </do_if>
        <do_if value="not global.$GT_RegistrationQueue.$Processing?">
          <set_value name="global.$GT_RegistrationQueue.$Processing" exact="false"/>
        </do_if>
        
        <!-- Add to queue -->
        <append_to_list name="global.$GT_RegistrationQueue.$Ships" exact="$registrationData"/>
        
        <!-- Process queue if not already processing -->
        <do_if value="not global.$GT_RegistrationQueue.$Processing">
          <signal_cue_instantly cue="ProcessRegistrationQueue"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Process Registration Queue - Batched with delays to prevent stutter -->
    <cue name="ProcessRegistrationQueue" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <!-- Prevent concurrent processing -->
        <do_if value="not global.$GT_RegistrationQueue.$Processing and global.$GT_RegistrationQueue.$Ships.count gt 0">
          <set_value name="global.$GT_RegistrationQueue.$Processing" exact="true"/>
          
          <!-- Process ONE ship at a time to prevent stutter -->
          <set_value name="$registrationData" exact="global.$GT_RegistrationQueue.$Ships.{1}"/>
          <remove_from_list name="global.$GT_RegistrationQueue.$Ships" exact="$registrationData"/>
          
          <set_value name="$ship" exact="$registrationData.$Ship"/>
          <set_value name="$config" exact="$registrationData.$Config"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Processing queued registration for ' + $ship.knownname + ' (queue: ' + global.$GT_RegistrationQueue.$Ships.count + ' remaining)'" chance="100"/>
          </do_if>
          
          <!-- Process this ship -->
          <do_if value="md.GT_Ship_Management.Register_Ship?">
            <run_actions ref="md.GT_Ship_Management.Register_Ship">
              <param name="ship" value="$ship"/>
              <param name="pilot" value="$ship.pilot"/>
              <param name="config" value="$config"/>
            </run_actions>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] Ship registered using GT_Ship_Management library: ' + $ship.knownname" chance="100"/>
            </do_if>

            <!-- Restore paused training state if it was preserved during order replacement -->
            <do_if value="$ship.pilot and global.$GT_Pilots.{$ship.pilot}? and global.$GT_Pilots.{$ship.pilot}.$PausedWithTrainingNeeded?">
              <set_value name="global.$GT_Pilots.{$ship.pilot}.$XPBlocked" exact="true"/>
              <set_value name="global.$GT_Pilots.{$ship.pilot}.$BlockedLevel" exact="global.$GT_Pilots.{$ship.pilot}.$PausedBlockedLevel"/>

              <!-- Clean up paused training placeholders -->
              <remove_value name="global.$GT_Pilots.{$ship.pilot}.$PausedWithTrainingNeeded"/>
              <remove_value name="global.$GT_Pilots.{$ship.pilot}.$PausedBlockedLevel"/>

              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3] TRAINING STATE RESTORED (library path): Pilot ' + $ship.pilot.name + ' still needs level ' + global.$GT_Pilots.{$ship.pilot}.$BlockedLevel + ' training'" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- Ensure ship name update happens (deferred to prevent stutter during registration) -->
            <!-- Register_Pilot sends GT_Update_Ship_Name signal, but we ensure it happens here too -->
            <do_if value="$ship.pilot and global.$GT_Pilots.{$ship.pilot}? and md.GT_Ship_Management.Update_Pilot_Ship_Name?">
              <!-- Defer name update slightly to spread load -->
              <signal_cue_instantly cue="DeferredShipNameUpdate" param="table[$ship=$ship, $pilot=$ship.pilot]"/>
            </do_if>
            
            <!-- Trigger blacklist application for newly registered ship (event-driven) -->
            <signal_cue_instantly cue="md.GT_ThreatIntelligence.ApplyBlacklistToFleet"/>
          </do_if>
          <do_else>
            <!-- Fallback registration if library not available -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] Library not available, using fallback registration for ' + $ship.knownname" chance="100"/>
            </do_if>
            
            <!-- Register ship if not already registered -->
            <do_if value="not global.$GT_Ships.{$ship}?">
              <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
              <set_value name="global.$GT_Ships.{$ship}.$RegisterTime" exact="player.age"/>
              <set_value name="global.$GT_Ships.{$ship}.$Config" exact="$config"/>
              <set_value name="global.$GT_Ships.{$ship}.$LastUpdate" exact="player.age"/>
              <set_value name="global.$GT_Ships.{$ship}.$Status" exact="'active'"/>
              
              <!-- Register pilot if provided and trigger ship renaming -->
              <do_if value="$ship.pilot">
                <!-- Use extracted initialization library -->
              <run_actions ref="md.GT_Ship_Management.Initialize_Pilot_Data" result="$wasNewPilot">
                <param name="pilot" value="$ship.pilot"/>
                <param name="ship" value="$ship"/>
              </run_actions>
              
              <do_if value="$wasNewPilot">
                <!-- NEW PILOT - Ship name update deferred to prevent stutter -->
                <!-- Name update handled by DeferredShipNameUpdate cue -->
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GalaxyTrader MK3] XP System: NEW pilot ' + $ship.pilot.name + ' initialized with 0 XP, skill level 1 (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
                </do_if>
              </do_if>
              <do_else>
                <!-- EXISTING PILOT (including paused pilots) -->
                
                <!-- Check if pilot was paused and restore them -->
                <do_if value="global.$GT_Pilots.{$ship.pilot}.$Status? and global.$GT_Pilots.{$ship.pilot}.$Status == 'paused'">
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GalaxyTrader MK3] PAUSED PILOT DETECTED: Restoring ' + $ship.pilot.name + ' with XP: ' + global.$GT_Pilots.{$ship.pilot}.$XP + ' (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
                  </do_if>
                  
                  <!-- RESTORE TRAINING STATE if it was preserved -->
                  <do_if value="global.$GT_Pilots.{$ship.pilot}.$PausedWithTrainingNeeded?">
                    <set_value name="global.$GT_Pilots.{$ship.pilot}.$XPBlocked" exact="true"/>
                    <set_value name="global.$GT_Pilots.{$ship.pilot}.$BlockedLevel" exact="global.$GT_Pilots.{$ship.pilot}.$PausedBlockedLevel"/>
                    
                    <!-- Clean up paused training state -->
                    <remove_value name="global.$GT_Pilots.{$ship.pilot}.$PausedWithTrainingNeeded"/>
                    <remove_value name="global.$GT_Pilots.{$ship.pilot}.$PausedBlockedLevel"/>
                    
                    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                      <debug_text text="'[GalaxyTrader MK3] TRAINING STATE RESTORED: Pilot ' + $ship.pilot.name + ' still needs level ' + global.$GT_Pilots.{$ship.pilot}.$BlockedLevel + ' training'" chance="100"/>
                    </do_if>
                  </do_if>
                  
                  <!-- Restore pilot to active status -->
                  <set_value name="global.$GT_Pilots.{$ship.pilot}.$Status" exact="'active'"/>
                  <set_value name="global.$GT_Pilots.{$ship.pilot}.$ResumedTime" exact="player.age"/>
                  <remove_value name="global.$GT_Pilots.{$ship.pilot}.$PausedTime"/>
                  <remove_value name="global.$GT_Pilots.{$ship.pilot}.$PausedReason"/>
                  
                  <!-- Update associated ship -->
                  <set_value name="global.$GT_Pilots.{$ship.pilot}.$AssociatedShip" exact="$ship"/>
                </do_if>
                
                <!-- Ensure all fields exist (defensive programming) -->
                <run_actions ref="md.GT_Ship_Management.Ensure_Pilot_Fields">
                  <param name="pilot" value="$ship.pilot"/>
                </run_actions>
                
                <!-- Store original ship name if not already stored (strip any existing GT formatting) -->
                <do_if value="not global.$GT_Pilots.{$ship.pilot}.$OriginalShipName?">
                  <run_actions ref="md.GT_Ship_Management.Strip_GT_Name_Formatting" result="$cleanedName">
                    <param name="shipName" value="$ship.knownname"/>
                  </run_actions>
                  <set_value name="global.$GT_Pilots.{$ship.pilot}.$OriginalShipName" exact="$cleanedName"/>
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-Core] Stored cleaned original ship name for existing pilot: ' + $cleanedName + ' (from: ' + $ship.knownname + ') (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
                  </do_if>
                </do_if>
                
                <!-- Ship name update deferred to prevent stutter -->
                <!-- Name update handled by DeferredShipNameUpdate cue -->
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GalaxyTrader MK3] XP System: EXISTING pilot ' + $ship.pilot.name + ' restored with XP: ' + global.$GT_Pilots.{$ship.pilot}.$XP + ' (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
                </do_if>
              </do_else>
            </do_if>
            </do_if>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] Fallback registration complete for ship: ' + $ship.knownname" chance="100"/>
            </do_if>
            
            <!-- Ensure ship name update happens (deferred to prevent stutter during registration) -->
            <do_if value="$ship.pilot and global.$GT_Pilots.{$ship.pilot}? and md.GT_Ship_Management.Update_Pilot_Ship_Name?">
              <!-- Defer name update slightly to spread load -->
              <signal_cue_instantly cue="DeferredShipNameUpdate" param="table[$ship=$ship, $pilot=$ship.pilot]"/>
            </do_if>
            
            <!-- Trigger blacklist application for newly registered ship (event-driven) -->
            <signal_cue_instantly cue="md.GT_ThreatIntelligence.ApplyBlacklistToFleet"/>
          </do_else>
        </do_if>
        
        <!-- Signal post-processing delay (yields CPU after processing this ship) -->
        <signal_cue_instantly cue="PostRegistrationDelay"/>
      </actions>
    </cue>
    
    <!-- Post-processing delay - yields CPU after each ship registration -->
    <cue name="PostRegistrationDelay" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <!-- 200ms delay after processing each ship (gives game CPU time to catch up) -->
      <!-- Increased from 100ms to prevent stutter when initializing large fleets -->
      <delay exact="200ms"/>
      <actions>
        <set_value name="global.$GT_RegistrationQueue.$Processing" exact="false"/>
        
        <!-- Continue processing if more ships in queue WITH DELAY to prevent stutter -->
        <do_if value="global.$GT_RegistrationQueue.$Ships.count gt 0">
          <signal_cue_instantly cue="DelayedRegistrationProcessing"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Delayed registration queue processing to prevent stuttering -->
    <cue name="DelayedRegistrationProcessing" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <!-- 300ms delay to spread load and prevent stutter (increased from 200ms) -->
      <!-- Gives game more CPU time between registrations -->
      <!-- Higher delay = smoother but slower registration (acceptable trade-off) -->
      <!-- Total delay per ship: 300ms before + 200ms after = 500ms per ship -->
      <delay exact="300ms"/>
      <actions>
        <signal_cue_instantly cue="ProcessRegistrationQueue"/>
      </actions>
    </cue>
    
    <!-- Deferred Ship Name Update - ensures ship names are updated after registration -->
    <cue name="DeferredShipNameUpdate" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <!-- 100ms delay to spread name update load (increased from 50ms to prevent stutter) -->
      <delay exact="100ms"/>
      <actions>
        <set_value name="$updateData" exact="event.param"/>
        <set_value name="$ship" exact="$updateData.$ship"/>
        <set_value name="$pilot" exact="$updateData.$pilot"/>
        
        <!-- Update ship name if ship and pilot still exist -->
        <do_if value="$ship.exists and $ship.isoperational and $pilot and global.$GT_Pilots.{$pilot}?">
          <run_actions ref="md.GT_Ship_Management.Update_Pilot_Ship_Name">
            <param name="pilot" value="$pilot"/>
            <param name="ship" value="$ship"/>
            <param name="forceUpdate" value="true"/>
          </run_actions>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Deferred ship name update completed for ' + $ship.knownname" chance="100"/>
          </do_if>
        </do_if>
      </actions>
    </cue>

    <!-- Ship Order Aborted Handler with Name Restoration -->
    <cue name="HandleShipOrderAborted" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Ship_Order_Aborted'" comment="Handle ship order abortion"/>
      </conditions>
      <actions>
        <set_value name="$abortData" exact="event.param2"/>
        <set_value name="$ship" exact="$abortData.$Ship"/>
        <set_value name="$pilot" exact="$abortData.$Pilot"/>
        <set_value name="$cleanupSource" exact="'UNKNOWN'"/>
        <set_value name="$cleanupTraceId" exact="if $ship? and $ship.exists then $ship.idcode + '|HANDLE_ABORT|' + (player.age / 1s)i else 'UNKNOWN|HANDLE_ABORT|' + (player.age / 1s)i"/>
        <!-- Ensure $reason is always a string -->
        <!-- Default to empty string, then set from signal if present -->
        <set_value name="$reason" exact="''"/>
        <do_if value="$abortData.$Reason?">
          <set_value name="$reasonTemp" exact="$abortData.$Reason"/>
          <!-- Force string conversion by concatenating with empty string -->
          <!-- This ensures $reason is always a string type that supports indexof -->
          <do_if value="$reasonTemp?">
            <set_value name="$reason" exact="'' + $reasonTemp"/>
          </do_if>
        </do_if>
        <set_value name="$originalName" exact="$abortData.$OriginalName"/>
        <do_if value="$abortData.$Source?">
          <set_value name="$cleanupSource" exact="$abortData.$Source"/>
        </do_if>
        <do_if value="$abortData.$TraceId?">
          <set_value name="$cleanupTraceId" exact="$abortData.$TraceId"/>
        </do_if>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <set_value name="$dbgDefaultOrder" exact="'NONE'"/>
          <do_if value="$ship.defaultorder?">
            <set_value name="$dbgDefaultOrder" exact="@$ship.defaultorder.id"/>
          </do_if>
          <debug_text text="'[GT-CleanupTrace] trace=' + $cleanupTraceId + ' source=' + $cleanupSource + ' cue=HandleShipOrderAborted ship=' + (if $ship? then $ship.idcode else 'NONE') + ' default=' + $dbgDefaultOrder + ' reason=' + $reason" chance="100"/>
        </do_if>
        
        <!-- Check if ship is a subordinate with Assist order -->
        <set_value name="$isSubordinate" exact="false"/>
        <do_if value="$ship.defaultorder?">
          <do_if value="@$ship.defaultorder.id == 'Assist'">
            <set_value name="$isSubordinate" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Check if cleanup reason is commander-related -->
        <set_value name="$isCommanderCleanup" exact="false"/>
        <!-- Check reason string - only check exact known reason strings to avoid indexof errors -->
        <!-- Known reasons that indicate commander cleanup (from various sources): -->
        <do_if value="$reason? and $reason != ''">
          <!-- Check for exact known commander-related reason strings -->
          <do_if value="$reason == 'Commander lost GT order' or $reason == 'Commander removed' or $reason == 'Commander lost GT order (Lua detection)' or $reason == 'Commander cleanup'">
            <set_value name="$isCommanderCleanup" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Handle subordinates differently when commander is cleaned up -->
        <!-- Subordinates get cleaned up (registry removal, name restoration) but keep their active orders -->
        <do_if value="$isSubordinate and $isCommanderCleanup">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Cleanup] Cleaning up subordinate (commander lost GT order): ' + $ship.knownname + ' (ID: ' + $ship.idcode + ') - preserving active orders'" chance="100"/>
          </do_if>
          
          <!-- Skip order cancellation - subordinates keep their active orders (trade orders continue) -->
          <!-- Only do registry cleanup and name restoration -->
          
          <!-- ============================================= -->
          <!-- SHIP NAME RESTORATION                        -->
          <!-- ============================================= -->
          
          <!-- Use extracted library function to restore original ship name -->
          <run_actions ref="md.GT_Ship_Management.Restore_Original_Ship_Name">
            <param name="ship" value="$ship"/>
            <param name="pilot" value="$pilot"/>
            <param name="originalName" value="$originalName"/>
          </run_actions>

          <!-- ============================================= -->
          <!-- SHIP MODIFICATION CLEANUP                   -->
          <!-- ============================================= -->
          
          <!-- Remove GT equipment mods BEFORE registry cleanup (needs $GT_Ships data) -->
          <!-- Remove penalty mods -->
          <do_if value="md.GT_Ship_Modifications.Remove_Penalty_Modifications?">
            <run_actions ref="md.GT_Ship_Modifications.Remove_Penalty_Modifications">
              <param name="ship" value="$ship"/>
            </run_actions>
          </do_if>
          
          <!-- Remove bonus mods (check GTInstalledSlots and call Lua) -->
          <do_if value="global.$GT_Ships.{$ship}? and global.$GT_Ships.{$ship}.$GTModifications? and global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots?">
            <set_value name="$installedSlots" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots"/>
            <set_value name="$hasShipMod" exact="false"/>
            <set_value name="$hasEngineMod" exact="false"/>
            <do_all exact="$installedSlots.count" counter="$i">
              <do_if value="$installedSlots.{$i} == 'ship'">
                <set_value name="$hasShipMod" exact="true"/>
              </do_if>
              <do_if value="$installedSlots.{$i} == 'engine'">
                <set_value name="$hasEngineMod" exact="true"/>
              </do_if>
            </do_all>
            
            <do_if value="$hasShipMod">
              <set_value name="$shipIdCode" exact="@$ship.idcode"/>
              <raise_lua_event name="'GT_DismantleMod'" param="'ship|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|null'"/>
            </do_if>
            <do_if value="$hasEngineMod">
              <set_value name="$shipIdCode" exact="@$ship.idcode"/>
              <raise_lua_event name="'GT_DismantleMod'" param="'engine|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|null'"/>
            </do_if>
            
            <!-- Clear tracking -->
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="[]"/>
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$InstalledLevel" exact="0"/>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Cleanup] Removed GT equipment mods from ' + $ship.idcode + ' (ship=' + $hasShipMod + ', engine=' + $hasEngineMod + ')'" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- Clean up legacy modification tracking -->
          <do_if value="global.$GT_Applied_Mods? and global.$GT_Applied_Mods.{$ship}?">
            <remove_value name="global.$GT_Applied_Mods.{$ship}"/>
          </do_if>
          
          <!-- ============================================= -->
          <!-- REGISTRY CLEANUP                             -->
          <!-- ============================================= -->
          
          <!-- Remove ship from GT_Ships registry -->
          <do_if value="global.$GT_Ships.{$ship}?">
            <remove_value name="global.$GT_Ships.{$ship}"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] Ship removed from GT_Ships registry: ' + $ship.idcode" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- ============================================= -->
          <!-- PILOT DATA PRESERVATION (CRITICAL)            -->
          <!-- ============================================= -->
          
          <!-- CRITICAL: DO NOT remove pilot from GT_Pilots registry - preserve XP data -->
          <!-- When commander gets GT order again, subordinates will be re-registered and need their XP -->
          <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
            <!-- Mark pilot as paused/inactive but keep all XP data -->
            <set_value name="global.$GT_Pilots.{$pilot}.$Status" exact="'paused'"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$PausedTime" exact="player.age"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$PausedReason" exact="'Commander lost GT order'"/>
            
            <!-- PRESERVE TRAINING STATE: Save training requirements if active -->
            <!-- Don't clear training flags - keep them so training requirement is preserved when pilot is reactivated -->
            <do_if value="global.$GT_Pilots.{$pilot}.$XPBlocked?">
              <set_value name="global.$GT_Pilots.{$pilot}.$PausedWithTrainingNeeded" exact="true"/>
              <set_value name="global.$GT_Pilots.{$pilot}.$PausedBlockedLevel" exact="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3] TRAINING STATE PRESERVED: Pilot ' + $pilot.name + ' was XP blocked at level ' + global.$GT_Pilots.{$pilot}.$BlockedLevel + ' - will restore training requirement'" chance="100"/>
              </do_if>
              <!-- Keep XPBlocked and BlockedLevel flags - Initialize_Pilot_Data will handle restoration -->
              <!-- Only clear TrainingInProgress since training is paused -->
              <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingInProgress"/>
            </do_if>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] Pilot marked as paused (XP preserved): ' + $pilot.name + ' - XP: ' + global.$GT_Pilots.{$pilot}.$XP + ' (will be restored when re-registered)'" chance="100"/>
            </do_if>
          </do_if>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Ship cleanup completed for ' + $ship.idcode + ' (pilot XP preserved)'" chance="100"/>
          </do_if>
        </do_if>
        <do_else>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Cleanup] Cleaning up ship: ' + $ship.knownname + ' (ID: ' + $ship.idcode + ') - ' + $reason" chance="100"/>
          </do_if>
          
          <!-- ============================================= -->
          <!-- ORDER CANCELLATION (only if no pilot)        -->
          <!-- ============================================= -->
          
          <!-- Determine if orders should be cancelled -->
          <!-- Trust Lua detection: if reason indicates missing pilot, cancel orders -->
          <!-- Also check if passed pilot is null or ship has no pilot -->
          <set_value name="$shouldCancelOrders" exact="false"/>
          <do_if value="not $pilot">
            <set_value name="$shouldCancelOrders" exact="true"/>
          </do_if>
          <do_elseif value="$reason? and $reason != ''">
            <!-- Check if reason indicates missing pilot -->
            <!-- Only check exact known reason strings to avoid indexof errors -->
            <do_if value="$reason == 'Missing pilot (Lua detection)' or $reason == 'Missing pilot' or $reason == 'Pilot transferred away - GT order cannot run without pilot' or $reason == 'No pilot assigned'">
              <set_value name="$shouldCancelOrders" exact="true"/>
            </do_if>
          </do_elseif>
          <do_else>
            <!-- Double-check ship's current pilot status -->
            <!-- CRITICAL: Check if pilot is actually assigned to THIS ship, not just if pilot exists -->
            <set_value name="$hasPilot" exact="false"/>
            <do_if value="$ship.pilot?">
              <set_value name="$pilotObj" exact="@$ship.pilot"/>
              <do_if value="$pilotObj and $pilotObj.exists">
                <!-- Verify pilot is actually assigned to THIS ship (not transferred to another ship) -->
                <do_if value="$pilotObj.ship? and $pilotObj.ship == $ship">
                  <set_value name="$hasPilot" exact="true"/>
                </do_if>
              </do_if>
            </do_if>
            <do_if value="not $hasPilot">
              <set_value name="$shouldCancelOrders" exact="true"/>
            </do_if>
          </do_else>
          
          <do_if value="$shouldCancelOrders">
            <!-- No pilot => Remove everything (default order and current orders) -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Cleanup] No pilot detected - cancelling all orders and removing default order: ' + $ship.knownname + ' (ID: ' + $ship.idcode + ')'" chance="100"/>
            </do_if>
            
            <!-- First: Cancel default order (stops order script from creating new orders) -->
            <do_if value="$ship.defaultorder?">
              <cancel_order order="$ship.defaultorder"/>
            </do_if>
            
            <!-- Then: Cancel all active orders on the ship (including trade orders, etc.) -->
            <cancel_all_orders object="$ship"/>
          </do_if>
          <do_else>
            <!-- Pilot present => Only remove from registry, don't touch orders -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Cleanup] Ship has pilot - removing from registry only, leaving orders intact: ' + $ship.knownname + ' (ID: ' + $ship.idcode + ')'" chance="100"/>
            </do_if>
          </do_else>
          
          <!-- ============================================= -->
          <!-- SHIP NAME RESTORATION                        -->
          <!-- ============================================= -->
          
          <!-- Use extracted library function to restore original ship name -->
          <run_actions ref="md.GT_Ship_Management.Restore_Original_Ship_Name">
            <param name="ship" value="$ship"/>
            <param name="pilot" value="$pilot"/>
            <param name="originalName" value="$originalName"/>
          </run_actions>

          <!-- ============================================= -->
          <!-- SHIP MODIFICATION CLEANUP                   -->
          <!-- ============================================= -->
          
          <!-- Remove GT equipment mods BEFORE registry cleanup (needs $GT_Ships data) -->
          <!-- Remove penalty mods -->
          <do_if value="md.GT_Ship_Modifications.Remove_Penalty_Modifications?">
            <run_actions ref="md.GT_Ship_Modifications.Remove_Penalty_Modifications">
              <param name="ship" value="$ship"/>
            </run_actions>
          </do_if>
          
          <!-- Remove bonus mods (check GTInstalledSlots and call Lua) -->
          <do_if value="global.$GT_Ships.{$ship}? and global.$GT_Ships.{$ship}.$GTModifications? and global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots?">
            <set_value name="$installedSlots" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots"/>
            <set_value name="$hasShipMod" exact="false"/>
            <set_value name="$hasEngineMod" exact="false"/>
            <do_all exact="$installedSlots.count" counter="$i">
              <do_if value="$installedSlots.{$i} == 'ship'">
                <set_value name="$hasShipMod" exact="true"/>
              </do_if>
              <do_if value="$installedSlots.{$i} == 'engine'">
                <set_value name="$hasEngineMod" exact="true"/>
              </do_if>
            </do_all>
            
            <do_if value="$hasShipMod">
              <set_value name="$shipIdCode" exact="@$ship.idcode"/>
              <raise_lua_event name="'GT_DismantleMod'" param="'ship|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|null'"/>
            </do_if>
            <do_if value="$hasEngineMod">
              <set_value name="$shipIdCode" exact="@$ship.idcode"/>
              <raise_lua_event name="'GT_DismantleMod'" param="'engine|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|null'"/>
            </do_if>
            
            <!-- Clear tracking -->
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="[]"/>
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$InstalledLevel" exact="0"/>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Cleanup] Removed GT equipment mods from ' + $ship.idcode + ' (ship=' + $hasShipMod + ', engine=' + $hasEngineMod + ')'" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- Clean up legacy modification tracking -->
          <do_if value="global.$GT_Applied_Mods? and global.$GT_Applied_Mods.{$ship}?">
            <remove_value name="global.$GT_Applied_Mods.{$ship}"/>
          </do_if>
          
          <!-- ============================================= -->
          <!-- SEARCH STATE CLEANUP                         -->
          <!-- ============================================= -->
          
          <!-- Phase 3: Use comprehensive cleanup function (includes reservations, work items, scheduler state) -->
          <!-- Only cleanup for non-subordinate ships (subordinates keep their orders) -->
          <do_if value="not $isSubordinate">
            <run_actions ref="md.GT_Libraries_General.GT_ClearPendingTradeData">
              <param name="ship" value="$ship"/>
            </run_actions>
            <run_actions ref="md.GT_Libraries_General.GT_ClearUICreditsDueForShip">
              <param name="ship" value="$ship"/>
            </run_actions>
          </do_if>
          <do_else>
            <!-- For subordinates, GT_ClearPendingTradeData handles current pipeline cleanup. -->
          </do_else>
          
          <!-- Remove from pathfinding queue if present -->
          <do_if value="global.$GT_PathfindingQueue? and global.$GT_PathfindingQueue.$ActiveShips?">
            <do_all exact="global.$GT_PathfindingQueue.$ActiveShips.count" counter="$i" reverse="true">
              <do_if value="global.$GT_PathfindingQueue.$ActiveShips.{$i} == $ship">
                <remove_from_list name="global.$GT_PathfindingQueue.$ActiveShips" exact="$ship"/>
                <!-- Decrement active instances if ship was active -->
                <do_if value="global.$GT_PathfindingQueue.$ActiveInstances? and global.$GT_PathfindingQueue.$ActiveInstances gt 0">
                  <set_value name="global.$GT_PathfindingQueue.$ActiveInstances" operation="subtract"/>
                </do_if>
              </do_if>
            </do_all>
          </do_if>
          
          <!-- Remove from pathfinding request queue if present -->
          <do_if value="global.$GT_PathfindingQueue? and global.$GT_PathfindingQueue.$Requests?">
            <do_all exact="global.$GT_PathfindingQueue.$Requests.count" counter="$i" reverse="true">
              <set_value name="$request" exact="global.$GT_PathfindingQueue.$Requests.{$i}"/>
              <do_if value="$request.$Ship? and $request.$Ship == $ship">
                <remove_from_list name="global.$GT_PathfindingQueue.$Requests" exact="$request"/>
              </do_if>
            </do_all>
          </do_if>
          
          <!-- Legacy batch processor cleanup removed in AI migration -->
          
          <!-- LiveSearchQueue removed (hub finalization): remove ship from home-refresh waiters if present -->
          <do_if value="global.$GT_TS_LiveRefreshBySector? and global.$GT_TS_LiveRefreshBySector.keys.count gt 0">
            <do_all exact="global.$GT_TS_LiveRefreshBySector.keys.count" counter="$hsIdx">
              <set_value name="$hs" exact="global.$GT_TS_LiveRefreshBySector.keys.{$hsIdx}"/>
              <do_if value="$hs? and global.$GT_TS_LiveRefreshBySector.{$hs}?">
                <do_if value="global.$GT_TS_LiveRefreshBySector.{$hs}.$WaiterQueued? and global.$GT_TS_LiveRefreshBySector.{$hs}.$WaiterQueued.{$ship}?">
                  <remove_value name="global.$GT_TS_LiveRefreshBySector.{$hs}.$WaiterQueued.{$ship}"/>
                </do_if>
                <do_if value="global.$GT_TS_LiveRefreshBySector.{$hs}.$Waiters? and global.$GT_TS_LiveRefreshBySector.{$hs}.$Waiters.count gt 0">
                  <do_all exact="global.$GT_TS_LiveRefreshBySector.{$hs}.$Waiters.count" counter="$wi" reverse="true">
                    <set_value name="$w" exact="global.$GT_TS_LiveRefreshBySector.{$hs}.$Waiters.{$wi}"/>
                    <do_if value="$w? and $w.$Ship? and $w.$Ship == $ship">
                      <remove_from_list name="global.$GT_TS_LiveRefreshBySector.{$hs}.$Waiters" exact="$w"/>
                    </do_if>
                  </do_all>
                </do_if>
              </do_if>
            </do_all>
          </do_if>
          
          <!-- Clear search results -->
          <do_if value="global.$GT_SearchResult? and global.$GT_SearchResult.{$ship}?">
            <remove_value name="global.$GT_SearchResult.{$ship}"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Cleanup] Cleared search results for ' + $ship.idcode" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- Clear fallback flags -->
          <do_if value="global.$GT_FallbackAttempted? and global.$GT_FallbackAttempted.{$ship}?">
            <remove_value name="global.$GT_FallbackAttempted.{$ship}"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Cleanup] Cleared fallback attempted flag for ' + $ship.idcode" chance="100"/>
            </do_if>
          </do_if>
          <do_if value="global.$GT_FallbackLogbookWritten? and global.$GT_FallbackLogbookWritten.{$ship}?">
            <remove_value name="global.$GT_FallbackLogbookWritten.{$ship}"/>
          </do_if>
          
          <!-- ============================================= -->
          <!-- REGISTRY CLEANUP                             -->
          <!-- ============================================= -->
          
          <!-- Remove ship from GT_Ships registry -->
          <do_if value="global.$GT_Ships.{$ship}?">
            <remove_value name="global.$GT_Ships.{$ship}"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] Ship removed from GT_Ships registry: ' + $ship.idcode" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- ============================================= -->
          <!-- PILOT DATA PRESERVATION                       -->
          <!-- ============================================= -->
          
          <!-- Preserve pilot XP data - NEVER remove pilots from registry -->
          <!-- Instead, mark them as paused/inactive so they can be reactivated later with their XP intact -->
          <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
            <set_value name="$pilotHasOtherShips" exact="false"/>
            
            <!-- Check if pilot has other active GalaxyTrader ships -->
            <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
              <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
              <do_all exact="$shipKeys.count" counter="$i">
                <set_value name="$otherShip" exact="$shipKeys.{$i}"/>
                <do_if value="$otherShip? and $otherShip.exists and $otherShip.pilot == $pilot">
                  <set_value name="$pilotHasOtherShips" exact="true"/>
                  <break/>
                </do_if>
              </do_all>
            </do_if>
            
            <!-- Mark pilot as paused instead of removing from registry -->
            <!-- This preserves XP, skill level, trades, profit, and all training data -->
            <do_if value="not $pilotHasOtherShips">
              <!-- No other active ships - mark pilot as paused to preserve all data -->
              <set_value name="global.$GT_Pilots.{$pilot}.$Status" exact="'paused'"/>
              <set_value name="global.$GT_Pilots.{$pilot}.$PausedTime" exact="player.age"/>
              <set_value name="global.$GT_Pilots.{$pilot}.$PausedReason" exact="'Order aborted - preserving XP data for reactivation'"/>
              <!-- Clear ship association since order is aborted -->
              <remove_value name="global.$GT_Pilots.{$pilot}.$AssociatedShip"/>
              <remove_value name="global.$GT_Pilots.{$pilot}.$Ship"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3] Pilot paused (preserving XP data): ' + $pilot.name + ' (XP: ' + global.$GT_Pilots.{$pilot}.$XP + ', Level: ' + (if global.$GT_Pilots.{$pilot}.$Level? then global.$GT_Pilots.{$pilot}.$Level else 1) + ')'" chance="100"/>
              </do_if>
              
              <!-- Send logbook message thanking player for holiday -->
              <!-- Construct logbook message using TextDB syntax (vanilla pattern) -->
              <set_value name="$logbookMessage" exact="{77000,3215}.[player.name]"/>
              
              <run_actions ref="md.GT_Libraries_General.WriteLogbookMessage">
                <param name="Message" value="$logbookMessage"/>
                <param name="Category" value="'general'"/>
                <param name="Title" value="'Pilot Status: ' + $pilot.name"/>
                <param name="Object" value="$ship"/>
                <param name="Interaction" value="'showonmap'"/>
              </run_actions>
            </do_if>
            <do_else>
              <!-- Pilot has other active ships - keep them active -->
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3] Pilot kept active (has other active ships): ' + $pilot.name" chance="100"/>
              </do_if>
            </do_else>
          </do_if>
          
          <!-- Update ship status (legacy compatibility) -->
          <do_if value="md.GT_Ship_Management.Update_Ship_Status?">
            <run_actions ref="md.GT_Ship_Management.Update_Ship_Status">
              <param name="ship" value="$ship"/>
              <param name="status" value="'aborted'"/>
            </run_actions>
          </do_if>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Ship cleanup completed for ' + $ship.idcode" chance="100"/>
          </do_if>
        </do_else>
      </actions>
    </cue>

    <!-- Ship Order Paused Handler with XP Preservation -->
    <cue name="HandleShipOrderPaused" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Ship_Order_Paused'" comment="Handle ship order pause (preserve XP)"/>
      </conditions>
      <actions>
        <set_value name="$pauseData" exact="event.param2"/>
        <set_value name="$ship" exact="$pauseData.$Ship"/>
        <set_value name="$pilot" exact="$pauseData.$Pilot"/>
        <set_value name="$reason" exact="$pauseData.$Reason"/>
        <set_value name="$preserveData" exact="$pauseData.$PreserveData"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Ship order paused for ' + $ship.knownname + ': ' + $reason + ' (preserving XP: ' + $preserveData + ')'" chance="100"/>
        </do_if>
        
        <!-- ============================================= -->
        <!-- SHIP NAME PRESERVATION (DO NOT RESTORE)      -->
        <!-- ============================================= -->
        <!-- NOTE: When pausing (not aborting), we KEEP the current ship name with rank/level/XP.
             Name restoration to original only happens on permanent order removal (HandleShipOrderAborted).
             This preserves the player's view of their pilot's progression even during order changes. -->
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Ship name PRESERVED during pause: ' + $ship.knownname + ' (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
        </do_if>
        
        <!-- ============================================= -->
        <!-- SHIP MODIFICATION CLEANUP (PAUSE)           -->
        <!-- ============================================= -->
        
        <!-- Clean up any ship modification tracking -->
        <do_if value="global.$GT_Applied_Mods? and global.$GT_Applied_Mods.{$ship}?">
          <remove_value name="global.$GT_Applied_Mods.{$ship}"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Ship modification tracking cleared for ' + $ship.knownname" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- ============================================= -->
        <!-- SELECTIVE REGISTRY CLEANUP (PRESERVE XP)    -->
        <!-- ============================================= -->
        
        <!-- Remove ship from GT_Ships registry (ship-specific data) -->
        <do_if value="global.$GT_Ships.{$ship}?">
          <remove_value name="global.$GT_Ships.{$ship}"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Ship removed from GT_Ships registry: ' + $ship.idcode" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- CRITICAL: DO NOT remove pilot from GT_Pilots registry - preserve XP data -->
        <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
          <!-- Mark pilot as temporarily inactive but keep all XP data -->
          <set_value name="global.$GT_Pilots.{$pilot}.$Status" exact="'paused'"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$PausedTime" exact="player.age"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$PausedReason" exact="$reason"/>
          
          <!-- PRESERVE TRAINING STATE: Save training requirements if active -->
          <do_if value="global.$GT_Pilots.{$pilot}.$XPBlocked?">
            <set_value name="global.$GT_Pilots.{$pilot}.$PausedWithTrainingNeeded" exact="true"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$PausedBlockedLevel" exact="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] TRAINING STATE PRESERVED: Pilot ' + $pilot.name + ' was XP blocked at level ' + global.$GT_Pilots.{$pilot}.$BlockedLevel + ' - will restore training requirement'" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- Clear active training flags (but preserve paused state) -->
          <remove_value name="global.$GT_Pilots.{$pilot}.$XPBlocked"/>
          <remove_value name="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
          <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingInProgress"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Pilot marked as paused (XP preserved): ' + $pilot.name + ' - XP: ' + global.$GT_Pilots.{$pilot}.$XP" chance="100"/>
          </do_if>
        </do_if>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Ship pause completed for ' + $ship.idcode + ' (pilot XP data preserved)'" chance="100"/>
        </do_if>
      </actions>
    </cue>

    <!-- Ship Pilot Change Monitor removed -->
    <!-- Polling monitor has been removed. Order removal is now detected instantly via signal from AI script's <on_abort> handler. -->
    <!-- This provides instant response (0ms latency) and zero CPU overhead. Professional code doesn't crash - we trust the signal system. -->

    <!-- Event-Driven Orphaned Ship Check - Checks a single ship when triggered -->
    <!-- This replaces polling-based cleanup with event-driven checks -->
    <!-- Triggered from: GT_Update_Ship (pilot_change), GT_Ship_State_Update (GT_Order_Cancelled), Wait/Assist orders, GT order on_abort -->
    <cue name="CheckShipOrphaned" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Check_Ship_Orphaned'"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.param2.$Ship"/>
        <set_value name="$force" exact="false"/>
        <set_value name="$cleanupSource" exact="'UNKNOWN'"/>
        <set_value name="$cleanupTraceId" exact="if $ship? and $ship.exists then $ship.idcode + '|CHECK_ORPHANED|' + (player.age / 1s)i else 'UNKNOWN|CHECK_ORPHANED|' + (player.age / 1s)i"/>
        <do_if value="event.param2? and event.param2.$Force? and event.param2.$Force">
          <set_value name="$force" exact="true"/>
        </do_if>
        <do_if value="event.param2? and event.param2.$Source?">
          <set_value name="$cleanupSource" exact="event.param2.$Source"/>
        </do_if>
        <do_if value="event.param2? and event.param2.$TraceId?">
          <set_value name="$cleanupTraceId" exact="event.param2.$TraceId"/>
        </do_if>
        
        <!-- Skip if ship doesn't exist -->
        <do_if value="not $ship.exists">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-CleanupTrace] trace=' + $cleanupTraceId + ' source=' + $cleanupSource + ' cue=CheckShipOrphaned ship=NONE action=FILTERED_SHIP_NOT_EXISTS'" chance="100"/>
          </do_if>
        </do_if>
        <do_else>
          <!-- Check if ship is in registry -->
          <set_value name="$shipInRegistry" exact="false"/>
          <do_if value="global.$GT_Ships? and global.$GT_Ships.{$ship}?">
            <set_value name="$shipInRegistry" exact="true"/>
          </do_if>
          
          <!-- Only process cleanup if ship is in registry (reliable data source) -->
          <do_if value="not $shipInRegistry">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-CleanupTrace] trace=' + $cleanupTraceId + ' source=' + $cleanupSource + ' cue=CheckShipOrphaned ship=' + $ship.idcode + ' action=FILTERED_NOT_IN_REGISTRY'" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <!-- Ship is in registry - continue with orphaned check -->
            
            <!-- PROMOTION / TRANSITION GUARD:
                 During commander destruction + promotion, ships can briefly have no default order.
                 Do NOT purge registry on the first observation; schedule a delayed verify once. -->
            <set_value name="$exitEarly" exact="false"/>
            <set_value name="$defaultOrderId" exact="@$ship.defaultorder.id"/>
            <set_value name="$commander" exact="@$ship.commander"/>
            <set_value name="$commanderExists" exact="false"/>
            <set_value name="$commanderDefaultNull" exact="false"/>
            <do_if value="$commander? and $commander.exists and $commander != $ship">
              <set_value name="$commanderExists" exact="true"/>
              <!-- Commander exists but has no default order yet (promotion window) -->
              <do_if value="(not @$commander.defaultorder) or (@$commander.defaultorder == null)">
                <set_value name="$commanderDefaultNull" exact="true"/>
              </do_if>
            </do_if>
            
            <!-- Defer cleanup if:
                 - ship has no default order id yet, OR
                 - ship has no commander yet (transition), OR
                 - commander exists but default order is null (promotion window) -->
            <do_if value="not $force and ((not $defaultOrderId or $defaultOrderId == null) or (not $commanderExists) or $commanderDefaultNull)">
              <set_value name="$exitEarly" exact="true"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-CleanupTrace] trace=' + $cleanupTraceId + ' source=' + $cleanupSource + ' cue=CheckShipOrphaned ship=' + $ship.idcode + ' action=FILTERED_PROMOTION_WINDOW default=' + (if $defaultOrderId then $defaultOrderId else 'NONE') + ' commanderExists=' + $commanderExists + ' commanderDefaultNull=' + $commanderDefaultNull + ' force=' + $force" chance="100"/>
              </do_if>
              <do_if value="not global.$GT_OrphanVerifyPending?">
                <set_value name="global.$GT_OrphanVerifyPending" exact="table[]"/>
              </do_if>
              <do_if value="not global.$GT_OrphanVerifyPending.{$ship}?">
                <set_value name="global.$GT_OrphanVerifyPending.{$ship}" exact="player.age"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Cleanup] Deferring orphan cleanup (promotion window): ' + $ship.idcode + ' (defaultOrder=' + (if $defaultOrderId then $defaultOrderId else 'null') + ', commanderExists=' + $commanderExists + ', commanderDefaultNull=' + $commanderDefaultNull + ')'" chance="100"/>
                </do_if>
                <signal_cue_instantly cue="md.GT_CoreSystem.VerifyShipOrphaned" param="table[
                  $Ship = $ship,
                  $Source = $cleanupSource,
                  $TraceId = $cleanupTraceId
                ]"/>
              </do_if>
            </do_if>
            
            <do_if value="not $exitEarly">
        
        <!-- Unified cleanup decision engine -->
        <run_actions ref="md.GT_Ship_State_Utilities.GT_CheckGTOrderStatus" result="$gtStatus">
          <param name="ship" value="$ship"/>
          <param name="checkRegistry" value="true"/>
          <param name="checkState" value="true"/>
        </run_actions>
        
        <set_value name="$cleanupDecision" exact="'NO_ACTION'"/>
        <do_if value="$gtStatus.$IsGTControlled">
          <set_value name="$cleanupDecision" exact="'KEEP_GT_CONTROLLED'"/>
        </do_if>
        <do_elseif value="$gtStatus.$ShouldCleanup">
          <set_value name="$cleanupDecision" exact="'DETACHED_CLEANUP_REQUIRED'"/>
        </do_elseif>
        <do_elseif value="$ship.defaultorder? and @$ship.defaultorder.id == 'Assist'">
          <set_value name="$cleanupDecision" exact="'TRANSIENT_RECHECK_REQUIRED'"/>
        </do_elseif>
        
        <!-- Detach intent handling:
             producer-side snapshots (on_abort/wait) can be ahead of commander/default-order reflection.
             Keep intent active during grace window, then force detach if still unresolved. -->
        <set_value name="$intentActive" exact="false"/>
        <set_value name="$intentExpired" exact="false"/>
        <set_value name="$intentSource" exact="'NONE'"/>
        <set_value name="$intentTraceId" exact="'NONE'"/>
        <do_if value="global.$GT_CleanupIntent? and global.$GT_CleanupIntent.{$ship}?">
          <set_value name="$intent" exact="global.$GT_CleanupIntent.{$ship}"/>
          <do_if value="$intent.$Active? and $intent.$Active">
            <set_value name="$intentActive" exact="true"/>
          </do_if>
          <do_if value="$intent.$Source?">
            <set_value name="$intentSource" exact="$intent.$Source"/>
          </do_if>
          <do_if value="$intent.$TraceId?">
            <set_value name="$intentTraceId" exact="$intent.$TraceId"/>
          </do_if>
          <do_if value="$intent.$ExpireTime? and player.age ge $intent.$ExpireTime">
            <set_value name="$intentExpired" exact="true"/>
          </do_if>
        </do_if>
        
        <do_if value="$intentActive">
          <!-- Strong re-control signal: direct GT order means intent is obsolete. -->
          <do_if value="$gtStatus.$HasDirectGTOrder">
            <remove_value name="global.$GT_CleanupIntent.{$ship}"/>
            <set_value name="$intentActive" exact="false"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-CleanupTrace] trace=' + $cleanupTraceId + ' source=' + $cleanupSource + ' cue=CheckShipOrphaned ship=' + $ship.idcode + ' intent=CLEARED_DIRECT_GT'" chance="100"/>
            </do_if>
          </do_if>
          <do_elseif value="$intentExpired and $cleanupDecision != 'DETACHED_CLEANUP_REQUIRED'">
            <!-- Expired intent:
                 - Force detach only if GT control is truly missing now.
                 - If still subordinate to GT commander (Assist + hasGTCommander), intent was stale/noise -> clear it. -->
            <do_if value="(not $gtStatus.$IsGTControlled) or (not $ship.defaultorder?) or (@$ship.defaultorder.id != 'Assist') or (not $gtStatus.$HasGTCommander)">
              <set_value name="$cleanupDecision" exact="'DETACHED_CLEANUP_REQUIRED'"/>
            </do_if>
            <do_else>
              <remove_value name="global.$GT_CleanupIntent.{$ship}"/>
              <set_value name="$intentActive" exact="false"/>
              <set_value name="$cleanupDecision" exact="'KEEP_GT_CONTROLLED'"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-CleanupTrace] trace=' + $cleanupTraceId + ' source=' + $cleanupSource + ' cue=CheckShipOrphaned ship=' + $ship.idcode + ' intent=EXPIRED_BUT_STILL_SUBORDINATE -> CLEARED'" chance="100"/>
              </do_if>
            </do_else>
          </do_elseif>
          <do_elseif value="$cleanupDecision == 'KEEP_GT_CONTROLLED'">
            <!-- During grace window, treat as transitional and re-check instead of accepting stale keep-controlled state. -->
            <set_value name="$cleanupDecision" exact="'TRANSIENT_RECHECK_REQUIRED'"/>
          </do_elseif>
        </do_if>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <set_value name="$dbgCommanderId" exact="'NONE'"/>
          <set_value name="$dbgCommanderOrder" exact="'NONE'"/>
          <do_if value="$gtStatus.$Commander? and $gtStatus.$Commander.exists">
            <set_value name="$dbgCommanderId" exact="@$gtStatus.$Commander.idcode"/>
            <do_if value="$gtStatus.$Commander.defaultorder?">
              <set_value name="$dbgCommanderOrder" exact="@$gtStatus.$Commander.defaultorder.id"/>
            </do_if>
          </do_if>
          <debug_text text="'[GT-CleanupTrace] trace=' + $cleanupTraceId + ' source=' + $cleanupSource + ' cue=CheckShipOrphaned ship=' + $ship.idcode + ' force=' + $force + ' inRegistry=' + $shipInRegistry + ' default=' + @$ship.defaultorder.id + ' commander=' + $dbgCommanderId + ' commanderOrder=' + $dbgCommanderOrder + ' intentActive=' + $intentActive + ' intentExpired=' + $intentExpired + ' intentSource=' + $intentSource + ' intentTrace=' + $intentTraceId" chance="100"/>
          <debug_text text="'[GT-Cleanup] Decision=' + $cleanupDecision + ' ship=' + $ship.idcode + ' default=' + @$ship.defaultorder.id + ' commander=' + $dbgCommanderId + ' commanderOrder=' + $dbgCommanderOrder + ' hasDirect=' + $gtStatus.$HasDirectGTOrder + ' hasGTCommander=' + $gtStatus.$HasGTCommander + ' inRegistry=' + $gtStatus.$InRegistry" chance="100"/>
        </do_if>
        
        <do_if value="$cleanupDecision == 'DETACHED_CLEANUP_REQUIRED'">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Cleanup] Cleaning up detached ship: ' + $ship.knownname + ' (ID: ' + $ship.idcode + ')'" chance="100"/>
          </do_if>
          
          <!-- Get original ship name from ship registry (try multiple sources) -->
          <set_value name="$originalName" exact="null"/>
          <!-- Try ship registry first -->
          <do_if value="global.$GT_Ships.{$ship}? and global.$GT_Ships.{$ship}.$OriginalShipName?">
            <set_value name="$originalName" exact="global.$GT_Ships.{$ship}.$OriginalShipName"/>
          </do_if>
          <!-- Fallback: Try pilot registry -->
          <do_elseif value="$ship.pilot? and global.$GT_Pilots.{$ship.pilot}? and global.$GT_Pilots.{$ship.pilot}.$OriginalShipName?">
            <set_value name="$originalName" exact="global.$GT_Pilots.{$ship.pilot}.$OriginalShipName"/>
          </do_elseif>
          <!-- Last resort: Use macro name (unformatted) -->
          <do_elseif value="$ship.macro?">
            <set_value name="$originalName" exact="@$ship.macro.name"/>
          </do_elseif>
          
          <!-- Idempotency guard: suppress duplicate detached-cleanup signals per ship/time bucket -->
          <set_value name="$cleanupSignalType" exact="'DETACHED_CLEANUP_REQUIRED'"/>
          <set_value name="$cleanupTokenBucket" exact="(player.age / 1s)i"/>
          <set_value name="$cleanupToken" exact="$cleanupSignalType + '|' + $cleanupTokenBucket"/>
          <do_if value="not global.$GT_CleanupSignalState?">
            <set_value name="global.$GT_CleanupSignalState" exact="table[]"/>
          </do_if>
          <do_if value="not global.$GT_CleanupSignalState.{$ship}?">
            <set_value name="global.$GT_CleanupSignalState.{$ship}" exact="table[
              $LastCleanupToken = '',
              $LastCleanupTime = 0s
            ]"/>
          </do_if>
          <set_value name="$signalState" exact="global.$GT_CleanupSignalState.{$ship}"/>
          <do_if value="not $signalState.$LastCleanupToken? or $signalState.$LastCleanupToken != $cleanupToken">
            <set_value name="$signalState.$LastCleanupToken" exact="$cleanupToken"/>
            <set_value name="$signalState.$LastCleanupTime" exact="player.age"/>
            <!-- Send cleanup signal (reuses existing HandleShipOrderAborted logic) -->
            <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
              $Ship = $ship,
              $Pilot = $ship.pilot,
              $Reason = 'Orphaned ship detected (decision: ' + $cleanupDecision + ')',
              $OriginalName = $originalName,
              $Source = 'CHECK_SHIP_ORPHANED',
              $TraceId = $cleanupTraceId
            ]"/>
            <do_if value="global.$GT_CleanupIntent? and global.$GT_CleanupIntent.{$ship}?">
              <remove_value name="global.$GT_CleanupIntent.{$ship}"/>
            </do_if>
          </do_if>
          <do_elseif value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Cleanup] Duplicate cleanup signal suppressed for ' + $ship.idcode + ' token=' + $cleanupToken" chance="100"/>
          </do_elseif>
        </do_if>
        <do_elseif value="$cleanupDecision == 'TRANSIENT_RECHECK_REQUIRED'">
          <!-- Schedule forced re-check while detach intent is active. -->
          <do_if value="not global.$GT_OrphanVerifyPending?">
            <set_value name="global.$GT_OrphanVerifyPending" exact="table[]"/>
          </do_if>
          <do_if value="not global.$GT_OrphanVerifyPending.{$ship}?">
            <set_value name="global.$GT_OrphanVerifyPending.{$ship}" exact="player.age"/>
            <signal_cue_instantly cue="md.GT_CoreSystem.VerifyShipOrphaned" param="table[
              $Ship = $ship,
              $Source = $cleanupSource,
              $TraceId = $cleanupTraceId
            ]"/>
          </do_if>
        </do_elseif>
        
        <!-- Check for missing pilot (ship has GT order but no pilot) -->
        <do_elseif value="$gtStatus.$IsGTControlled and not $ship.pilot?">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Cleanup] Cleaning up ship without pilot: ' + $ship.knownname + ' (ID: ' + $ship.idcode + ')'" chance="100"/>
          </do_if>
          
          <!-- Set default order to Wait (hold position) before cleanup -->
          <do_if value="$ship.defaultorder?">
            <create_order id="'Wait'" object="$ship" default="true">
              <param name="allowdocked" value="true"/>
              <param name="holdfire" value="false"/>
              <param name="noattackresponse" value="false"/>
            </create_order>
          </do_if>
          
          <!-- Get original ship name from ship registry -->
          <set_value name="$originalName" exact="null"/>
          <do_if value="global.$GT_Ships.{$ship}? and global.$GT_Ships.{$ship}.$OriginalShipName?">
            <set_value name="$originalName" exact="global.$GT_Ships.{$ship}.$OriginalShipName"/>
          </do_if>
          
          <!-- Send cleanup signal -->
          <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
            $Ship = $ship,
            $Pilot = null,
            $Reason = 'Pilot transferred away - GT order cannot run without pilot (event-driven check)',
            $OriginalName = $originalName
          ]"/>
        </do_elseif>
        
            </do_if>
          </do_else>
        </do_else>
      </actions>
    </cue>
    
    <!-- Delayed verify for transient "no default order" states (promotion window). -->
    <cue name="VerifyShipOrphaned" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_CoreSystem.VerifyShipOrphaned"/>
      </conditions>
      <delay exact="3s"/>
      <actions>
        <set_value name="$ship" exact="event.param.$Ship"/>
        <set_value name="$cleanupSource" exact="'VERIFY_ORPHANED'"/>
        <set_value name="$cleanupTraceId" exact="if $ship? and $ship.exists then $ship.idcode + '|VERIFY_ORPHANED|' + (player.age / 1s)i else 'UNKNOWN|VERIFY_ORPHANED|' + (player.age / 1s)i"/>
        <do_if value="event.param.$Source?">
          <set_value name="$cleanupSource" exact="event.param.$Source"/>
        </do_if>
        <do_if value="event.param.$TraceId?">
          <set_value name="$cleanupTraceId" exact="event.param.$TraceId"/>
        </do_if>
        <do_if value="$ship? and $ship.exists">
          <do_if value="global.$GT_OrphanVerifyPending? and global.$GT_OrphanVerifyPending.{$ship}?">
            <remove_value name="global.$GT_OrphanVerifyPending.{$ship}"/>
          </do_if>
          <signal_objects object="player.galaxy" param="'GT_Check_Ship_Orphaned'" param2="table[
            $Ship = $ship,
            $Force = true,
            $Source = $cleanupSource,
            $TraceId = $cleanupTraceId
          ]"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Savegame Compatibility: Migrate Original Ship Names from Pilot Registry to Ship Registry -->
    <!-- This migration runs once per savegame to move OriginalShipName from pilot to ship registry -->
    <cue name="MigrateOriginalShipNames" instantiate="true" version="1">
      <conditions>
        <check_any>
          <event_player_created/>
          <event_game_loaded/>
        </check_any>
        <check_value value="global.$GT_Initialized and not global.$GT_OriginalShipNamesMigrated?"/>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Core] Starting migration: Original ship names from pilot to ship registry...'" chance="100"/>
        </do_if>
        
        <!-- Initialize ship registry if needed -->
        <do_if value="not global.$GT_Ships?">
          <set_value name="global.$GT_Ships" exact="table[]"/>
        </do_if>
        
        <set_value name="$migratedCount" exact="0"/>
        <set_value name="$skippedCount" exact="0"/>
        
        <!-- Iterate through all pilots -->
        <do_if value="global.$GT_Pilots? and global.$GT_Pilots.keys.count gt 0">
          <set_value name="$pilotKeys" exact="global.$GT_Pilots.keys.list"/>
          <do_all exact="$pilotKeys.count" counter="$i">
            <set_value name="$pilot" exact="$pilotKeys.{$i}"/>
            <set_value name="$pilotData" exact="global.$GT_Pilots.{$pilot}"/>
            
            <!-- Check if pilot has OriginalShipName and associated ship -->
            <do_if value="$pilotData.$OriginalShipName? and $pilotData.$Ship? and $pilotData.$Ship.exists">
              <set_value name="$ship" exact="$pilotData.$Ship"/>
              
              <!-- Initialize ship registry entry if needed -->
              <do_if value="not global.$GT_Ships.{$ship}?">
                <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
              </do_if>
              
              <!-- Migrate OriginalShipName to ship registry (only if not already set) -->
              <!-- Note: If pilot was transferred, their OriginalShipName might be for old ship -->
              <!-- But we migrate to current ship - Register_Pilot will handle old ship cleanup -->
              <do_if value="not global.$GT_Ships.{$ship}.$OriginalShipName?">
                <set_value name="global.$GT_Ships.{$ship}.$OriginalShipName" exact="$pilotData.$OriginalShipName"/>
                <set_value name="$migratedCount" operation="add"/>
                
                <!-- <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Core] Migrated original name for ship ' + $ship.knownname + ' (ID: ' + $ship.idcode + ') from pilot ' + $pilot.name + ': ' + $pilotData.$OriginalShipName" chance="100"/>
                </do_if> -->
              </do_if>
              <do_else>
                <!-- Ship already has OriginalShipName - skip migration -->
                <set_value name="$skippedCount" operation="add"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Core] Skipped migration for ship ' + $ship.knownname + ' - already has OriginalShipName: ' + global.$GT_Ships.{$ship}.$OriginalShipName" chance="100"/>
                </do_if>
              </do_else>
            </do_if>
          </do_all>
        </do_if>
        
        <!-- Mark migration as complete -->
        <set_value name="global.$GT_OriginalShipNamesMigrated" exact="true"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Core] Migration complete: ' + $migratedCount + ' ship names migrated, ' + $skippedCount + ' skipped (already in ship registry)'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Polling-based cleanup removed - now using event-driven checks -->
    <!-- Orphaned ships are checked when:
         - Pilot is transferred (GT_Update_Ship with pilot_change) checks old ship
         - GT order is canceled (GT_Ship_State_Update with GT_Order_Cancelled) checks ship
         - Wait/Assist orders detect GT order removal checks ship
    -->
    
    <!-- Handler for GT_Ship_State_Update - Triggers orphaned check when GT order is cancelled -->
    <cue name="HandleShipStateUpdate" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Ship_State_Update'"/>
      </conditions>
      <actions>
        <set_value name="$params" exact="event.param2"/>
        <set_value name="$updateType" exact="@$params.$UpdateType"/>
        <set_value name="$ship" exact="$params.$Ship"/>
        
        <!-- Trigger orphaned check when GT order is cancelled -->
        <do_if value="$updateType == 'GT_Order_Cancelled' and $ship.exists">
          <do_if value="global.$GT_Ships? and global.$GT_Ships.{$ship}?">
            <signal_objects object="player.galaxy" param="'GT_Check_Ship_Orphaned'" param2="table[$Ship = $ship]"/>
          </do_if>
          
          <!-- EVENT-DRIVEN: Defer subordinate cleanup verification to avoid transient false positives
               during commander order transitions (e.g. promotion/station-assignment handover). -->
          <signal_cue_instantly cue="md.GT_CoreSystem.VerifyCommanderSubordinateCleanup" param="table[$Commander = $ship]"/>
        </do_if>
      </actions>
    </cue>

    <!-- Verify commander-lost-GT cleanup after a short delay.
         This prevents subordinate purge when commander order state is transiently inconsistent. -->
    <cue name="VerifyCommanderSubordinateCleanup" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_CoreSystem.VerifyCommanderSubordinateCleanup"/>
      </conditions>
      <delay exact="3s"/>
      <actions>
        <set_value name="$commander" exact="event.param.$Commander"/>
        <do_if value="$commander? and $commander.exists and global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
          <set_value name="$commanderHasGTNow" exact="false"/>
          <set_value name="$commanderDefaultOrderNull" exact="false"/>
          <do_if value="$commander.defaultorder? and (@$commander.defaultorder.id == 'GalaxyTraderMK3' or @$commander.defaultorder.id == 'GalaxyTraderMK2' or @$commander.defaultorder.id == 'GalaxyTraderMK1')">
            <set_value name="$commanderHasGTNow" exact="true"/>
          </do_if>
          <do_elseif value="(not @$commander.defaultorder) or (@$commander.defaultorder == null)">
            <set_value name="$commanderDefaultOrderNull" exact="true"/>
          </do_elseif>

          <!-- If still GT-controlled (or in null-order transition), skip subordinate cleanup. -->
          <do_if value="$commanderHasGTNow or $commanderDefaultOrderNull">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Cleanup] Skipping subordinate cleanup for commander ' + $commander.idcode + ' after verify (hasGT=' + $commanderHasGTNow + ', defaultOrderNull=' + $commanderDefaultOrderNull + ')'" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
            <do_all exact="$shipKeys.count" counter="$i">
              <set_value name="$potentialSubordinate" exact="$shipKeys.{$i}"/>
              <do_if value="$potentialSubordinate.exists and $potentialSubordinate.commander? and $potentialSubordinate.commander.exists and $potentialSubordinate.commander == $commander and global.$GT_Ships.{$potentialSubordinate}?">
                <!-- Safety: do not purge ships that now have direct GT orders. -->
                <set_value name="$subHasDirectGT" exact="false"/>
                <do_if value="$potentialSubordinate.defaultorder? and (@$potentialSubordinate.defaultorder.id == 'GalaxyTraderMK3' or @$potentialSubordinate.defaultorder.id == 'GalaxyTraderMK2' or @$potentialSubordinate.defaultorder.id == 'GalaxyTraderMK1')">
                  <set_value name="$subHasDirectGT" exact="true"/>
                </do_if>
                <do_if value="not $subHasDirectGT">
                  <set_value name="$originalName" exact="null"/>
                  <do_if value="global.$GT_Ships.{$potentialSubordinate}? and global.$GT_Ships.{$potentialSubordinate}.$OriginalShipName?">
                    <set_value name="$originalName" exact="global.$GT_Ships.{$potentialSubordinate}.$OriginalShipName"/>
                  </do_if>
                  <do_elseif value="$potentialSubordinate.pilot? and global.$GT_Pilots.{$potentialSubordinate.pilot}? and global.$GT_Pilots.{$potentialSubordinate.pilot}.$OriginalShipName?">
                    <set_value name="$originalName" exact="global.$GT_Pilots.{$potentialSubordinate.pilot}.$OriginalShipName"/>
                  </do_elseif>
                  <do_elseif value="$potentialSubordinate.macro?">
                    <set_value name="$originalName" exact="@$potentialSubordinate.macro.name"/>
                  </do_elseif>

                  <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
                    $Ship = $potentialSubordinate,
                    $Pilot = $potentialSubordinate.pilot,
                    $Reason = 'Commander lost GT order',
                    $OriginalName = $originalName
                  ]"/>
                </do_if>
              </do_if>
            </do_all>
          </do_else>
        </do_if>
      </actions>
    </cue>

    <!-- One-Time Legacy Ship Name Fix (for ships active before fixes were applied) -->
    <cue name="LegacyShipNameFix" instantiate="true" version="1">
      <conditions>
        <event_game_loaded/>
        <check_value value="global.$GT_Initialized and not global.$GT_LegacyShipNamesFixed?"/>
      </conditions>
      <actions>
        <!-- Mark as fixed so this only runs once -->
        <set_value name="global.$GT_LegacyShipNamesFixed" exact="true"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Running one-time legacy ship name fix...'" chance="100"/>
        </do_if>
        
        <set_value name="$fixedCount" exact="0"/>
        <set_value name="$skippedCount" exact="0"/>
        
        <!-- Check all registered GT ships -->
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
          <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
          <do_all exact="$shipKeys.count" counter="$i">
            <set_value name="$ship" exact="$shipKeys.{$i}"/>
            
            <!-- Skip if ship no longer exists -->
            <do_if value="not $ship.exists or not $ship.isoperational or not $ship.pilot">
              <continue/>
            </do_if>
            
            <!-- Check if pilot exists in registry -->
            <do_if value="global.$GT_Pilots.{$ship.pilot}?">
              <set_value name="$pilotData" exact="global.$GT_Pilots.{$ship.pilot}"/>
              
              <!-- Check if ship needs name update - ONLY if name is EXACTLY the original base name -->
              <set_value name="$needsUpdate" exact="false"/>
              
              <!-- Ship needs update if it has the exact original name (no rank/level/XP added yet) -->
              <do_if value="$pilotData.$OriginalShipName? and $ship.knownname == $pilotData.$OriginalShipName and $pilotData.$XP? and $pilotData.$XP gt 0">
                <set_value name="$needsUpdate" exact="true"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Legacy] Ship ' + $ship.idcode + ' needs update: name matches original exactly'" chance="100"/>
                </do_if>
              </do_if>
              <do_else>
                <set_value name="$skippedCount" exact="$skippedCount + 1"/>
              </do_else>
              
              <do_if value="$needsUpdate">
                <!-- Store original name if not already stored (strip any existing GT formatting) -->
                <do_if value="not $pilotData.$OriginalShipName?">
                  <run_actions ref="md.GT_Ship_Management.Strip_GT_Name_Formatting" result="$cleanedName">
                    <param name="shipName" value="$ship.knownname"/>
                  </run_actions>
                  <set_value name="global.$GT_Pilots.{$ship.pilot}.$OriginalShipName" exact="$cleanedName"/>
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-Core] Cleanup: Stored cleaned original name: ' + $cleanedName + ' (from: ' + $ship.knownname + ')'" chance="if $cleanedName != $ship.knownname then 100 else 0"/>
                  </do_if>
                </do_if>
                
                <!-- OPTIMIZED: Use extracted libraries for skill level and ship name update -->
                <set_value name="$currentXP" exact="$pilotData.$XP"/>
                <run_actions ref="md.GT_Ship_Management.Update_Pilot_Ship_Name">
                  <param name="pilot" value="$ship.pilot"/>
                  <param name="ship" value="$ship"/>
                </run_actions>
                
                <set_value name="$fixedCount" exact="$fixedCount + 1"/>
                <run_actions ref="md.GT_Ship_Management.Calculate_Skill_Level_From_XP" result="$currentSkillLevel">
                  <param name="pilot" value="$ship.pilot"/>
                  <param name="xp" value="$currentXP"/>
                </run_actions>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GalaxyTrader MK3] Fixed ship name: ' + $ship.idcode + ' (Pilot: ' + $ship.pilot.name + ', Level: ' + $currentSkillLevel + ', XP: ' + $currentXP + ')'" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Legacy ship name fix complete: ' + $fixedCount + ' ships updated, ' + $skippedCount + ' ships already properly named'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Update All Ship Names Based on Configuration -->
    <cue name="UpdateAllShipNames" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Updating all ship names based on new naming configuration...'" chance="100"/>
        </do_if>
        
        <set_value name="$updatedCount" exact="0"/>
        
        <!-- Update all registered GT ships -->
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
          <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
          <do_all exact="$shipKeys.count" counter="$i">
            <set_value name="$ship" exact="$shipKeys.{$i}"/>
            
            <!-- Skip if ship no longer exists -->
            <do_if value="not $ship.exists or not $ship.isoperational">
              <continue/>
            </do_if>
            
            <!-- Get the pilot -->
            <set_value name="$pilot" exact="$ship.pilot"/>
            <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
              <!-- Get pilot data -->
              <set_value name="$pilotData" exact="global.$GT_Pilots.{$pilot}"/>
              <set_value name="$currentXP" exact="$pilotData.$XP"/>
              
              <!-- OPTIMIZED: Use extracted library for skill level calculation -->
              <run_actions ref="md.GT_Ship_Management.Calculate_Skill_Level_From_XP" result="$skillLevel">
                <param name="pilot" value="$pilot"/>
                <param name="xp" value="$currentXP"/>
              </run_actions>
              
              <!-- Build new ship name using configuration -->
              <do_if value="$pilotData.$OriginalShipName?">
                <set_value name="$originalName" exact="$pilotData.$OriginalShipName"/>
              </do_if>
              <do_else>
                <set_value name="$originalName" exact="$ship.knownname"/>
              </do_else>
              <set_value name="$nameElements" exact="[]"/>
              <set_value name="$prefixElements" exact="[]"/>
              <set_value name="$suffixElements" exact="[]"/>
              
              <!-- Status (training/blocked/advance indicators) -->
              <do_if value="global.$GT_GlobalSettings.$ShipNaming.$DisplayStatus">
                <set_value name="$statusText" exact="''"/>
                <!-- ADVANCE takes priority - pilot is eligible for advancement exam -->
                <do_if value="$pilotData.$XPBlocked?">
                  <set_value name="$statusText" exact="'ADVANCE'"/>
                </do_if>
                <!-- TRAINING only shown for non-advancement training -->
                <do_elseif value="$pilotData.$TrainingInProgress? and not $pilotData.$XPBlocked?">
                  <set_value name="$statusText" exact="'[TRAINING]'"/>
                </do_elseif>
                
                <do_if value="$statusText != ''">
                  <do_if value="global.$GT_GlobalSettings.$ShipNaming.$StatusPosition == 'prefix'">
                    <append_to_list name="$prefixElements" exact="$statusText"/>
                  </do_if>
                  <do_else>
                    <append_to_list name="$suffixElements" exact="$statusText"/>
                  </do_else>
                </do_if>
              </do_if>
              
              <!-- Pilot Rank -->
              <do_if value="global.$GT_GlobalSettings.$ShipNaming.$DisplayRank">
                <set_value name="$rankTitle" exact="'Lehrling'"/>
                <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                  <set_value name="$rankIndex" exact="1"/>
                  <do_if value="$skillLevel ge 15">
                    <set_value name="$rankIndex" exact="6"/>
                  </do_if>
                  <do_elseif value="$skillLevel ge 13">
                    <set_value name="$rankIndex" exact="5"/>
                  </do_elseif>
                  <do_elseif value="$skillLevel ge 10">
                    <set_value name="$rankIndex" exact="4"/>
                  </do_elseif>
                  <do_elseif value="$skillLevel ge 7">
                    <set_value name="$rankIndex" exact="3"/>
                  </do_elseif>
                  <do_elseif value="$skillLevel ge 4">
                    <set_value name="$rankIndex" exact="2"/>
                  </do_elseif>
                  
                  <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                    <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                  </do_if>
                </do_if>
                
                <do_if value="global.$GT_GlobalSettings.$ShipNaming.$RankPosition == 'prefix'">
                  <append_to_list name="$prefixElements" exact="$rankTitle"/>
                </do_if>
                <do_else>
                  <append_to_list name="$suffixElements" exact="$rankTitle"/>
                </do_else>
              </do_if>
              
              <!-- Level -->
              <do_if value="global.$GT_GlobalSettings.$ShipNaming.$DisplayLevel">
                <set_value name="$levelText" exact="'Lv.' + $skillLevel"/>
                <do_if value="global.$GT_GlobalSettings.$ShipNaming.$LevelPosition == 'prefix'">
                  <append_to_list name="$prefixElements" exact="$levelText"/>
                </do_if>
                <do_else>
                  <append_to_list name="$suffixElements" exact="$levelText"/>
                </do_else>
              </do_if>
              
              <!-- XP -->
              <do_if value="global.$GT_GlobalSettings.$ShipNaming.$DisplayXP">
                <set_value name="$xpText" exact="'XP:' + $currentXP"/>
                <do_if value="global.$GT_GlobalSettings.$ShipNaming.$XPPosition == 'prefix'">
                  <append_to_list name="$prefixElements" exact="$xpText"/>
                </do_if>
                <do_else>
                  <append_to_list name="$suffixElements" exact="$xpText"/>
                </do_else>
              </do_if>
              
              <!-- Build final name -->
              <set_value name="$newName" exact="$originalName"/>
              
              <!-- Add prefix elements -->
              <do_if value="$prefixElements.count gt 0">
                <set_value name="$prefixString" exact="''"/>
                <do_all exact="$prefixElements.count" counter="$j">
                  <do_if value="$j gt 1">
                    <set_value name="$prefixString" exact="$prefixString + ' '"/>
                  </do_if>
                  <set_value name="$prefixString" exact="$prefixString + $prefixElements.{$j}"/>
                </do_all>
                <set_value name="$newName" exact="$prefixString + ' ' + $newName"/>
              </do_if>
              
              <!-- Add suffix elements -->
              <do_if value="$suffixElements.count gt 0">
                <set_value name="$suffixString" exact="''"/>
                <do_all exact="$suffixElements.count" counter="$j">
                  <do_if value="$j gt 1">
                    <set_value name="$suffixString" exact="$suffixString + ' '"/>
                  </do_if>
                  <set_value name="$suffixString" exact="$suffixString + $suffixElements.{$j}"/>
                </do_all>
                <set_value name="$newName" exact="$newName + ' (' + $suffixString + ')'"/>
              </do_if>
              
              <!-- Apply the new name -->
              <set_object_name object="$ship" name="$newName"/>
              <set_value name="$updatedCount" exact="$updatedCount + 1"/>
              
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3] Updated ship name: ' + $ship.idcode + ' -> ' + $newName" chance="100"/>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Ship name update complete: ' + $updatedCount + ' ships updated'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Ship Modification Update Handler (Queue Wrapper) -->
    <!-- PERFORMANCE: Coalesce & spread ship-update work across frames to prevent stutter bursts -->
    <cue name="HandleShipModificationUpdate" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Update_Ship'" comment="Handle ship updates from AI scripts"/>
      </conditions>
      <actions>
        <set_value name="$data" exact="event.param2"/>
        <set_value name="$ship" exact="$data.$ship"/>
        <set_value name="$updateType" exact="$data.$updateType"/>

        <!-- Initialize queue state if missing (save/load safe) -->
        <do_if value="not global.$GT_ShipUpdateQueue?">
          <set_value name="global.$GT_ShipUpdateQueue" exact="table[
            $Ships = [],
            $Params = table[],
            $QueuedShips = table[],
            $Processing = false
          ]"/>
        </do_if>
        <do_if value="not global.$GT_ShipUpdateQueue.$Ships? or global.$GT_ShipUpdateQueue.$Ships == null">
          <set_value name="global.$GT_ShipUpdateQueue.$Ships" exact="[]"/>
        </do_if>
        <do_if value="not global.$GT_ShipUpdateQueue.$Params? or global.$GT_ShipUpdateQueue.$Params == null">
          <set_value name="global.$GT_ShipUpdateQueue.$Params" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_ShipUpdateQueue.$QueuedShips? or global.$GT_ShipUpdateQueue.$QueuedShips == null">
          <set_value name="global.$GT_ShipUpdateQueue.$QueuedShips" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_ShipUpdateQueue.$Processing?">
          <set_value name="global.$GT_ShipUpdateQueue.$Processing" exact="false"/>
        </do_if>

        <!-- Always store the latest update for the ship (coalescing by ship) -->
        <set_value name="global.$GT_ShipUpdateQueue.$Params.{$ship}" exact="$data"/>

        <!-- Enqueue ship only once -->
        <do_if value="not global.$GT_ShipUpdateQueue.$QueuedShips.{$ship}?">
          <set_value name="global.$GT_ShipUpdateQueue.$QueuedShips.{$ship}" exact="true"/>
          <append_to_list name="global.$GT_ShipUpdateQueue.$Ships" exact="$ship"/>
        </do_if>

        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Core] Ship modification update QUEUED: ' + (if $ship? then $ship.knownname else 'NULL') + ' (Type: ' + $updateType + ', queued=' + global.$GT_ShipUpdateQueue.$Ships.count + ')'" chance="100"/>
        </do_if>

        <!-- Kick the queue processor (single-threaded) -->
        <signal_cue_instantly cue="md.GT_CoreSystem.ProcessShipModificationUpdateQueue"/>
      </actions>
    </cue>

    <!-- Ship Modification Update Queue Processor -->
    <cue name="ProcessShipModificationUpdateQueue" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <!-- Yield a little to avoid same-frame stampedes -->
      <delay min="5ms" max="25ms"/>
      <actions>
        <set_value name="$proceed" exact="true"/>
        <do_if value="not global.$GT_ShipUpdateQueue?">
          <set_value name="$proceed" exact="false"/>
          <cancel_cue cue="this"/>
        </do_if>
        <do_if value="global.$GT_ShipUpdateQueue.$Processing">
          <set_value name="$proceed" exact="false"/>
          <cancel_cue cue="this"/>
        </do_if>
        <do_if value="$proceed">
          <set_value name="global.$GT_ShipUpdateQueue.$Processing" exact="true"/>

          <!-- Process ONE ship per invocation (smooth gameplay > speed) -->
          <do_if value="global.$GT_ShipUpdateQueue.$Ships.count gt 0">
            <set_value name="$ship" exact="global.$GT_ShipUpdateQueue.$Ships.{1}"/>
            <remove_from_list name="global.$GT_ShipUpdateQueue.$Ships" exact="$ship"/>
            <do_if value="global.$GT_ShipUpdateQueue.$QueuedShips.{$ship}?">
              <remove_value name="global.$GT_ShipUpdateQueue.$QueuedShips.{$ship}"/>
            </do_if>

            <set_value name="$data" exact="global.$GT_ShipUpdateQueue.$Params.{$ship}"/>
            <do_if value="global.$GT_ShipUpdateQueue.$Params.{$ship}?">
              <remove_value name="global.$GT_ShipUpdateQueue.$Params.{$ship}"/>
            </do_if>

            <do_if value="$data? and $ship? and $ship.exists">
              <signal_cue_instantly cue="md.GT_CoreSystem.HandleShipModificationUpdate_Process" param="$data"/>
            </do_if>
          </do_if>

          <set_value name="global.$GT_ShipUpdateQueue.$Processing" exact="false"/>
        </do_if>

        <!-- Continue draining if needed -->
        <do_if value="global.$GT_ShipUpdateQueue.$Ships.count gt 0">
          <signal_cue_instantly cue="md.GT_CoreSystem.ProcessShipModificationUpdateQueue"/>
        </do_if>
      </actions>
    </cue>

    <!-- Ship Modification Update Processor (was HandleShipModificationUpdate) -->
    <cue name="HandleShipModificationUpdate_Process" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.param.$ship"/>
        <set_value name="$pilot" exact="event.param.$pilot"/>
        <set_value name="$updateType" exact="event.param.$updateType"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Core] Ship modification update requested: ' + $ship.knownname + ' (Type: ' + $updateType + ')'" chance="100"/>
        </do_if>
        
        <!-- DEBUG: Check library availability -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Core] DEBUG: GT_Ship_Management library check result: ' + md.GT_Ship_Management.Handle_Pilot_Ship_Assignment?" chance="100"/>
        </do_if>
        
        <!-- Handle different update types -->
        <do_if value="$updateType == 'training_completion'">
          <!-- Apply modifications after training completion -->
          <do_if value="md.GT_Ship_Management.Handle_Pilot_Ship_Assignment?">
            <run_actions ref="md.GT_Ship_Management.Handle_Pilot_Ship_Assignment">
              <param name="ship" value="$ship"/>
              <param name="new_pilot" value="$pilot"/>
              <param name="old_pilot" value="$pilot"/>
            </run_actions>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] Applied ship modifications after training completion for ' + $pilot.name" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] GT_Ship_Management library not available - ship modifications skipped'" chance="100"/>
            </do_if>
          </do_else>
          
        </do_if>
        <do_elseif value="$updateType == 'pilot_change'">
          <!-- Handle pilot assignment changes -->
          <set_value name="$oldPilot" exact="event.param.$oldPilot"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Core] Processing pilot change on ' + $ship.knownname + ' - Old: ' + @$oldPilot.name + ', New: ' + @$pilot.name" chance="100"/>
          </do_if>
          
          <!-- EVENT-DRIVEN: Check old ship for orphaned status (if old pilot was transferred away) -->
          <!-- CRITICAL: Don't require registry membership - ship might have been cleaned up already, but we should still check -->
          <!-- The CheckShipOrphaned cue will handle registry checks internally -->
          <do_if value="$oldPilot and $oldPilot.exists and $oldPilot.ship? and $oldPilot.ship.exists and $oldPilot.ship != $ship">
            <set_value name="$oldShip" exact="$oldPilot.ship"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <set_value name="$oldShipInRegistry" exact="false"/>
              <do_if value="global.$GT_Ships? and global.$GT_Ships.{$oldShip}?">
                <set_value name="$oldShipInRegistry" exact="true"/>
              </do_if>
              <debug_text text="'[GT-Core] Pilot change: Checking old ship ' + $oldShip.idcode + ' (inRegistry=' + (if $oldShipInRegistry then 'YES' else 'NO') + ')'" chance="100"/>
            </do_if>
            <!-- Always trigger check - CheckShipOrphaned will handle registry membership internally -->
            <signal_objects object="player.galaxy" param="'GT_Check_Ship_Orphaned'" param2="table[$Ship = $oldShip]"/>
          </do_if>
          
          <!-- Check if new pilot is a registered GT pilot -->
          <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
            <!-- New pilot is already registered - update ship name with their XP/rank -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] New pilot ' + $pilot.name + ' is registered GT pilot - updating ship name'" chance="100"/>
            </do_if>
            
            <!-- Register new pilot for this ship -->
            <do_if value="md.GT_Ship_Management.Register_Pilot?">
              <run_actions ref="md.GT_Ship_Management.Register_Pilot">
                <param name="pilot" value="$pilot"/>
                <param name="ship" value="$ship"/>
              </run_actions>
            </do_if>
          </do_if>
          <do_elseif value="$pilot">
            <!-- New pilot is NOT registered - restore original ship name and clean up old pilot -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] New pilot ' + $pilot.name + ' is NOT registered GT pilot - restoring original ship name'" chance="100"/>
            </do_if>
            
            <!-- Get original name from ship registry (per ship, not per pilot) -->
            <set_value name="$originalName" exact="null"/>
            <do_if value="global.$GT_Ships? and global.$GT_Ships.{$ship}? and global.$GT_Ships.{$ship}.$OriginalShipName?">
              <set_value name="$originalName" exact="global.$GT_Ships.{$ship}.$OriginalShipName"/>
            </do_if>
            <do_elseif value="$ship.knownname?">
              <!-- Fallback: use current name if ship registry doesn't have original name -->
              <set_value name="$originalName" exact="$ship.knownname"/>
            </do_elseif>
            
            <!-- Restore original ship name -->
            <do_if value="$originalName">
              <set_object_name object="$ship" name="$originalName"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Core] Ship name restored to: ' + $originalName" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- CRITICAL FIX: Register the new unregistered pilot -->
            <!-- This ensures unregistered pilots get registered when swapped in -->
            <do_if value="md.GT_Ship_Management.Register_Pilot?">
              <run_actions ref="md.GT_Ship_Management.Register_Pilot">
                <param name="pilot" value="$pilot"/>
                <param name="ship" value="$ship"/>
              </run_actions>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Core] Registered new unregistered pilot: ' + $pilot.name" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- Clean up old pilot if no other ships -->
            <do_if value="$oldPilot and global.$GT_Pilots.{$oldPilot}?">
              <!-- CRITICAL FIX: Preserve old pilot's XP data when pilot changes -->
              <!-- Mark old pilot as paused instead of removing, so they can be reactivated later -->
              <set_value name="$oldPilotHasOtherShips" exact="false"/>
              <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
                <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
                <do_all exact="$shipKeys.count" counter="$i">
                  <set_value name="$otherShip" exact="$shipKeys.{$i}"/>
                  <do_if value="$otherShip? and $otherShip.exists and $otherShip.pilot == $oldPilot">
                    <set_value name="$oldPilotHasOtherShips" exact="true"/>
                    <break/>
                  </do_if>
                </do_all>
              </do_if>
              
              <do_if value="not $oldPilotHasOtherShips">
                <!-- Old pilot has no other ships - mark as paused to preserve XP data -->
                <set_value name="global.$GT_Pilots.{$oldPilot}.$Status" exact="'paused'"/>
                <set_value name="global.$GT_Pilots.{$oldPilot}.$PausedTime" exact="player.age"/>
                <set_value name="global.$GT_Pilots.{$oldPilot}.$PausedReason" exact="'Pilot changed on ship - preserving XP data'"/>
                <remove_value name="global.$GT_Pilots.{$oldPilot}.$AssociatedShip"/>
                <remove_value name="global.$GT_Pilots.{$oldPilot}.$Ship"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Core] Old pilot paused (preserving XP): ' + $oldPilot.name + ' (XP: ' + (if global.$GT_Pilots.{$oldPilot}.$XP? then global.$GT_Pilots.{$oldPilot}.$XP else 0) + ')'" chance="100"/>
                </do_if>
                
                <!-- ROLEPLAY: Send logbook message thanking player for holiday -->
                <set_value name="$message" exact="{77000,3215}.[player.name]"/>
                <write_to_logbook 
                  category="general" 
                  title="'Pilot Status: ' + $oldPilot.name" 
                  interaction="showonmap" 
                  object="$ship" 
                  text="$message"/>
              </do_if>
            </do_if>
          </do_elseif>
          
          <!-- Apply performance modifications -->
          <do_if value="md.GT_Ship_Management.Handle_Pilot_Ship_Assignment?">
            <run_actions ref="md.GT_Ship_Management.Handle_Pilot_Ship_Assignment">
              <param name="ship" value="$ship"/>
              <param name="new_pilot" value="$pilot"/>
              <param name="old_pilot" value="$oldPilot"/>
            </run_actions>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] Applied ship modifications after pilot change on ' + $ship.knownname" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] GT_Ship_Management library not available - pilot change modifications skipped'" chance="100"/>
            </do_if>
          </do_else>
          
        </do_elseif>
        <do_elseif value="$updateType == 'level_up'">
          <!-- Handle skill level increases -->
          <do_if value="md.GT_Ship_Management.Handle_Pilot_Ship_Assignment?">
            <run_actions ref="md.GT_Ship_Management.Handle_Pilot_Ship_Assignment">
              <param name="ship" value="$ship"/>
              <param name="new_pilot" value="$pilot"/>
              <param name="old_pilot" value="$pilot"/>
            </run_actions>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] Applied ship modifications after level up for ' + $pilot.name" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] GT_Ship_Management library not available - level up modifications skipped'" chance="100"/>
            </do_if>
          </do_else>
          
        </do_elseif>
      </actions>
    </cue>

  </cues>
</mdscript> 
