<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_CoreSystem" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- Core System Initialization -->
    <cue name="SystemInit" instantiate="true">
      <conditions>
        <check_any>
          <event_player_created/>
          <event_game_loaded/>
        </check_any>
        <check_value value="not global.$GT_Initialized? or not global.$GT_Initialized"/>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Core system initializing...'" chance="100"/>
        </do_if>

        <!-- Initialize global data structures -->
        <set_value name="global.$GT_Ships" exact="table[]" comment="Registry of all managed ships"/>
        <set_value name="global.$GT_FleetData" exact="table[]" comment="Fleet coordination data"/>
        <set_value name="global.$GT_MarketData" exact="table[]" comment="Market intelligence cache"/>
        <set_value name="global.$GT_TerritoryData" exact="table[]" comment="Territory management data"/>
        <set_value name="global.$GT_SessionStats" exact="table[]" comment="Current session statistics"/>
        <set_value name="global.$GT_PendingTrades" exact="table[]" comment="Trade completion tracking"/>
        
        <!-- PHASE 1: Initialize event-driven signaling system -->
        <set_value name="global.$GT_XPEventQueue" exact="[]" comment="Event queue for instant XP processing"/>
        
        <!-- PHASE 2: Initialize training event system -->
        <set_value name="global.$GT_TrainingEventQueue" exact="[]" comment="Event queue for instant training processing"/>
        
        <!-- PHASE 3: Initialize fleet and market event systems -->
        <set_value name="global.$GT_FleetEventQueue" exact="[]" comment="Event queue for instant fleet coordination"/>
        <set_value name="global.$GT_MarketEventQueue" exact="[]" comment="Event queue for instant market intelligence"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Event-driven signaling system initialized (XP + Training + Fleet + Market)'" chance="100"/>
        </do_if>
        
        <!-- Initialize configuration settings for re-enabled features -->
        <do_if value="not global.$GT_Config?">
          <set_value name="global.$GT_Config" exact="table[]"/>
        </do_if>
        
        <do_if value="not global.$GT_Config.$Fleet?">
          <set_value name="global.$GT_Config.$Fleet" exact="table[]"/>
        </do_if>
        
        <do_if value="not global.$GT_Config.$Territory?">
          <set_value name="global.$GT_Config.$Territory" exact="table[]"/>
        </do_if>
        
        <!-- RE-ENABLED FEATURES: Set defaults to enabled since event-driven system is now stable -->
        <!-- Legacy load balancing config removed - pure event-driven system -->
        
        <do_if value="not global.$GT_Config.$Fleet.$EnablePerformanceMonitoring?">
          <set_value name="global.$GT_Config.$Fleet.$EnablePerformanceMonitoring" exact="true" comment="Fleet performance monitoring"/>
        </do_if>
        
        <do_if value="not global.$GT_Config.$Territory.$EnableConflictResolution?">
          <set_value name="global.$GT_Config.$Territory.$EnableConflictResolution" exact="true" comment="Territory conflict resolution"/>
        </do_if>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Previously disabled features have been re-enabled with event-driven architecture'" chance="100"/>
        </do_if>
        
        <!-- Initialize subsystems -->
        <set_value name="global.$GT_SessionStats.$StartTime" exact="player.age"/>
        <set_value name="global.$GT_SessionStats.$TotalProfit" exact="0Cr"/>
        <set_value name="global.$GT_SessionStats.$TradesCompleted" exact="0"/>
        <set_value name="global.$GT_SessionStats.$XPGained" exact="0"/>
        
        <!-- Set initialization complete flag -->
        <set_value name="global.$GT_Initialized" exact="true"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Core system initialization complete'" chance="100"/>
        </do_if>
        
        <!-- Show welcome notification -->
        <show_notification text="'GalaxyTrader MK3 Activated'" timeout="5s"/>
        <!-- Broadcast initialization signal for dependent modules -->
        <signal_cue cue="md.GT_CoreSystem.SystemInit"/>
        <!-- Legacy registration catch-up: seed original ship names for already-registered pilots -->
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0 and global.$GT_Pilots?">
          <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
          <do_all exact="$shipKeys.count" counter="$i">
            <set_value name="$ship" exact="$shipKeys.{$i}"/>
            <set_value name="$pilot" exact="$ship.pilot"/>
            <do_if value="$pilot and global.$GT_Pilots.{$pilot}? and not global.$GT_Pilots.{$pilot}.$OriginalShipName?">
              <run_actions ref="md.GT_Ship_Management.Strip_GT_Name_Formatting" result="$cleanedName">
                <param name="shipName" value="$ship.knownname"/>
              </run_actions>
              <set_value name="global.$GT_Pilots.{$pilot}.$OriginalShipName" exact="$cleanedName"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Core] SystemInit: Seeded cleaned original name for pilot ' + $pilot.name + ': ' + $cleanedName + ' (from: ' + $ship.knownname + ')'" chance="100"/>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
      </actions>
    </cue>
    
    <!-- Ship Registration System -->
    <cue name="RegisterShip" instantiate="true">
      <conditions>
        <event_object_order_ready object="player.entity" comment="Detect when ship gets trading order"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        
        <!-- Validate ship -->
        <do_if value="$ship.isplayerowned and $ship.primarypurpose == purpose.trade">
          <!-- Check if already registered -->
          <do_if value="not global.$GT_Ships.{$ship}?">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] Registering new trading ship: ' + $ship.knownname" chance="100"/>
            </do_if>
            
            <!-- Create ship data structure -->
            <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
            <set_value name="global.$GT_Ships.{$ship}.$RegisterTime" exact="player.age"/>
            <set_value name="global.$GT_Ships.{$ship}.$Level" exact="1"/>
            <set_value name="global.$GT_Ships.{$ship}.$XP" exact="0"/>
            <set_value name="global.$GT_Ships.{$ship}.$TotalProfit" exact="0Cr"/>
            <set_value name="global.$GT_Ships.{$ship}.$TradesCompleted" exact="0"/>
            <set_value name="global.$GT_Ships.{$ship}.$TotalTrades" exact="0"/>
            <set_value name="global.$GT_Ships.{$ship}.$LastTradeProfit" exact="0Cr"/>
            <set_value name="global.$GT_Ships.{$ship}.$LastMoney" exact="$ship.money"/>
            <set_value name="global.$GT_Ships.{$ship}.$TrainingCompleted" exact="[]"/>
            <set_value name="global.$GT_Ships.{$ship}.$ThreatReports" exact="0"/>
            <set_value name="global.$GT_Ships.{$ship}.$LastThreatTime" exact="0"/>
            <set_value name="global.$GT_Ships.{$ship}.$Territory" exact="null"/>
            <set_value name="global.$GT_Ships.{$ship}.$LastUpdate" exact="player.age"/>
            
            <!-- Notify player -->
            <do_if value="global.$GT_Config.$Notifications.$FleetUpdates?">
              <show_notification text="'GalaxyTrader MK3: ' + $ship.knownname + ' registered for advanced trading'" timeout="3s"/>
            </do_if>
            <!-- Trigger XP system pilot registration for ship renaming -->
            <set_value name="global.$GT_RegisterPilot" exact="$ship.pilot"/>
            <set_value name="global.$GT_RegisterShip" exact="$ship"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] XP registration triggered for pilot ' + $ship.pilot.name + ' on ship ' + $ship.knownname" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Ship Unregistration System -->
    <cue name="UnregisterShip" instantiate="true">
      <conditions>
        <event_object_destroyed object="player.entity"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        
        <!-- Check if ship was registered -->
        <do_if value="global.$GT_Ships.{$ship}?">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Unregistering destroyed ship: ' + $ship.knownname" chance="100"/>
          </do_if>
          
          <!-- OPTIMIZATION: Update cached active trader count incrementally -->
          <!-- Only decrement if ship was operational (matches counting logic) -->
          <do_if value="$ship.exists and $ship.isoperational and global.$GT_ActiveTraderCount? and global.$GT_ActiveTraderCount gt 0">
            <set_value name="global.$GT_ActiveTraderCount" operation="subtract"/>
          </do_if>
          
          <!-- Clean up data -->
          <remove_value name="global.$GT_Ships.{$ship}"/>
          <remove_value name="global.$GT_FleetData.{$ship}"/>
          <!-- Use library function to clear pending trade data -->
          <run_actions ref="md.GT_Libraries_General.GT_ClearPendingTradeData">
            <param name="ship" value="$ship"/>
          </run_actions>
        </do_if>
      </actions>
    </cue>
    
    <!-- Periodic System Maintenance -->
    <cue name="SystemMaintenance" instantiate="true" checkinterval="60s">
      <conditions>
        <check_value value="@global.$GT_Initialized"/>
      </conditions>
      <actions>
        <!-- Clean up invalid ship entries -->
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
          <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
          <do_all exact="$shipKeys.count" counter="$i">
            <set_value name="$ship" exact="$shipKeys.{$i}"/>
            <do_if value="not $ship.exists">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3] Cleaning up invalid ship entry'" chance="100"/>
              </do_if>
              <remove_value name="global.$GT_Ships.{$ship}"/>
              <!-- Use library function to clear pending trade data -->
              <run_actions ref="md.GT_Libraries_General.GT_ClearPendingTradeData">
                <param name="ship" value="$ship"/>
              </run_actions>
            </do_if>
          </do_all>
        </do_if>
        
        <!-- Update session statistics -->
        <set_value name="global.$GT_SessionStats.$Duration" exact="player.age - global.$GT_SessionStats.$StartTime"/>
        
        <!-- Trigger periodic simple report if enabled and frequency > 0 -->
        <set_value name="$simpleReportFrequencyMinutes" exact="1"/>
        <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Notifications? and global.$GT_GlobalSettings.$Notifications.$SimpleReportFrequency?">
          <set_value name="$simpleReportFrequencyMinutes" exact="global.$GT_GlobalSettings.$Notifications.$SimpleReportFrequency"/>
        </do_if>
        <do_if value="$simpleReportFrequencyMinutes gt 0">
          <!-- Check if enough time has passed since last simple report -->
          <set_value name="$lastSimpleReport" exact="0"/>
          <do_if value="global.$GT_Reports? and global.$GT_Reports.$LastSimpleReport?">
            <set_value name="$lastSimpleReport" exact="global.$GT_Reports.$LastSimpleReport"/>
          </do_if>
          <set_value name="$timeSinceSimpleReport" exact="player.age - $lastSimpleReport"/>
          <set_value name="$simpleReportIntervalSeconds" exact="$simpleReportFrequencyMinutes * 60"/>
          <do_if value="$timeSinceSimpleReport ge $simpleReportIntervalSeconds">
            <signal_cue cue="md.GT_Reporting.GeneratePeriodicReport"/>
            <!-- Update timestamp -->
            <do_if value="not global.$GT_Reports?">
              <set_value name="global.$GT_Reports" exact="table[]"/>
            </do_if>
            <set_value name="global.$GT_Reports.$LastSimpleReport" exact="player.age"/>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- System Shutdown Handler -->
    <cue name="SystemShutdown" instantiate="true">
      <conditions>
        <event_game_saved/>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Saving system state...'" chance="100"/>
        </do_if>
        
        <!-- Update all ship data -->
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
          <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
          <do_all exact="$shipKeys.count" counter="$i">
            <set_value name="$ship" exact="$shipKeys.{$i}"/>
            <set_value name="global.$GT_Ships.{$ship}.$LastUpdate" exact="player.age"/>
          </do_all>
        </do_if>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] System state saved'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    <!-- Ship Registration Signal Handler - QUEUED VERSION -->
    <!-- Queues registrations to prevent stutter when assigning orders to many ships -->
    <cue name="HandleShipRegistration" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Register_Ship'" comment="Handle ship registration from AI scripts"/>
      </conditions>
      <actions>
        <set_value name="$registrationData" exact="event.param2"/>
        
        <!-- Initialize registration queue if needed -->
        <do_if value="not global.$GT_RegistrationQueue?">
          <set_value name="global.$GT_RegistrationQueue" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_RegistrationQueue.$Ships?">
          <set_value name="global.$GT_RegistrationQueue.$Ships" exact="[]"/>
        </do_if>
        <do_if value="not global.$GT_RegistrationQueue.$Processing?">
          <set_value name="global.$GT_RegistrationQueue.$Processing" exact="false"/>
        </do_if>
        
        <!-- Add to queue -->
        <append_to_list name="global.$GT_RegistrationQueue.$Ships" exact="$registrationData"/>
        
        <!-- Process queue if not already processing -->
        <do_if value="not global.$GT_RegistrationQueue.$Processing">
          <signal_cue_instantly cue="ProcessRegistrationQueue"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Process Registration Queue - Batched with delays to prevent stutter -->
    <cue name="ProcessRegistrationQueue" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <!-- Prevent concurrent processing -->
        <do_if value="not global.$GT_RegistrationQueue.$Processing and global.$GT_RegistrationQueue.$Ships.count gt 0">
          <set_value name="global.$GT_RegistrationQueue.$Processing" exact="true"/>
          
          <!-- Process ONE ship at a time to prevent stutter -->
          <set_value name="$registrationData" exact="global.$GT_RegistrationQueue.$Ships.{1}"/>
          <remove_from_list name="global.$GT_RegistrationQueue.$Ships" exact="$registrationData"/>
          
          <set_value name="$ship" exact="$registrationData.$Ship"/>
          <set_value name="$config" exact="$registrationData.$Config"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Processing queued registration for ' + $ship.knownname + ' (queue: ' + global.$GT_RegistrationQueue.$Ships.count + ' remaining)'" chance="100"/>
          </do_if>
          
          <!-- Process this ship -->
          <do_if value="md.GT_Ship_Management.Register_Ship?">
            <run_actions ref="md.GT_Ship_Management.Register_Ship">
              <param name="ship" value="$ship"/>
              <param name="pilot" value="$ship.pilot"/>
              <param name="config" value="$config"/>
            </run_actions>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] Ship registered using GT_Ship_Management library: ' + $ship.knownname" chance="100"/>
            </do_if>

            <!-- Restore paused training state if it was preserved during order replacement -->
            <do_if value="$ship.pilot and global.$GT_Pilots.{$ship.pilot}? and global.$GT_Pilots.{$ship.pilot}.$PausedWithTrainingNeeded?">
              <set_value name="global.$GT_Pilots.{$ship.pilot}.$XPBlocked" exact="true"/>
              <set_value name="global.$GT_Pilots.{$ship.pilot}.$BlockedLevel" exact="global.$GT_Pilots.{$ship.pilot}.$PausedBlockedLevel"/>

              <!-- Clean up paused training placeholders -->
              <remove_value name="global.$GT_Pilots.{$ship.pilot}.$PausedWithTrainingNeeded"/>
              <remove_value name="global.$GT_Pilots.{$ship.pilot}.$PausedBlockedLevel"/>

              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3] TRAINING STATE RESTORED (library path): Pilot ' + $ship.pilot.name + ' still needs level ' + global.$GT_Pilots.{$ship.pilot}.$BlockedLevel + ' training'" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- Ensure ship name update happens (deferred to prevent stutter during registration) -->
            <!-- Register_Pilot sends GT_Update_Ship_Name signal, but we ensure it happens here too -->
            <do_if value="$ship.pilot and global.$GT_Pilots.{$ship.pilot}? and md.GT_Ship_Management.Update_Pilot_Ship_Name?">
              <!-- Defer name update slightly to spread load -->
              <signal_cue_instantly cue="DeferredShipNameUpdate" param="table[$ship=$ship, $pilot=$ship.pilot]"/>
            </do_if>
          </do_if>
          <do_else>
            <!-- Fallback registration if library not available -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] Library not available, using fallback registration for ' + $ship.knownname" chance="100"/>
            </do_if>
            
            <!-- Register ship if not already registered -->
            <do_if value="not global.$GT_Ships.{$ship}?">
              <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
              <set_value name="global.$GT_Ships.{$ship}.$RegisterTime" exact="player.age"/>
              <set_value name="global.$GT_Ships.{$ship}.$Config" exact="$config"/>
              <set_value name="global.$GT_Ships.{$ship}.$LastUpdate" exact="player.age"/>
              <set_value name="global.$GT_Ships.{$ship}.$Status" exact="'active'"/>
              
              <!-- Register pilot if provided and trigger ship renaming -->
              <do_if value="$ship.pilot">
                <!-- Use extracted initialization library -->
              <run_actions ref="md.GT_Ship_Management.Initialize_Pilot_Data" result="$wasNewPilot">
                <param name="pilot" value="$ship.pilot"/>
                <param name="ship" value="$ship"/>
              </run_actions>
              
              <do_if value="$wasNewPilot">
                <!-- NEW PILOT - Update ship name with initial state -->
                <run_actions ref="md.GT_Ship_Management.Update_Pilot_Ship_Name">
                  <param name="pilot" value="$ship.pilot"/>
                  <param name="ship" value="$ship"/>
                </run_actions>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GalaxyTrader MK3] XP System: NEW pilot ' + $ship.pilot.name + ' initialized with 0 XP, skill level 1, ship renamed to: ' + $ship.knownname + ' (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
                </do_if>
              </do_if>
              <do_else>
                <!-- EXISTING PILOT (including paused pilots) -->
                
                <!-- Check if pilot was paused and restore them -->
                <do_if value="global.$GT_Pilots.{$ship.pilot}.$Status? and global.$GT_Pilots.{$ship.pilot}.$Status == 'paused'">
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GalaxyTrader MK3] PAUSED PILOT DETECTED: Restoring ' + $ship.pilot.name + ' with XP: ' + global.$GT_Pilots.{$ship.pilot}.$XP + ' (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
                  </do_if>
                  
                  <!-- RESTORE TRAINING STATE if it was preserved -->
                  <do_if value="global.$GT_Pilots.{$ship.pilot}.$PausedWithTrainingNeeded?">
                    <set_value name="global.$GT_Pilots.{$ship.pilot}.$XPBlocked" exact="true"/>
                    <set_value name="global.$GT_Pilots.{$ship.pilot}.$BlockedLevel" exact="global.$GT_Pilots.{$ship.pilot}.$PausedBlockedLevel"/>
                    
                    <!-- Clean up paused training state -->
                    <remove_value name="global.$GT_Pilots.{$ship.pilot}.$PausedWithTrainingNeeded"/>
                    <remove_value name="global.$GT_Pilots.{$ship.pilot}.$PausedBlockedLevel"/>
                    
                    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                      <debug_text text="'[GalaxyTrader MK3] TRAINING STATE RESTORED: Pilot ' + $ship.pilot.name + ' still needs level ' + global.$GT_Pilots.{$ship.pilot}.$BlockedLevel + ' training'" chance="100"/>
                    </do_if>
                  </do_if>
                  
                  <!-- Restore pilot to active status -->
                  <set_value name="global.$GT_Pilots.{$ship.pilot}.$Status" exact="'active'"/>
                  <set_value name="global.$GT_Pilots.{$ship.pilot}.$ResumedTime" exact="player.age"/>
                  <remove_value name="global.$GT_Pilots.{$ship.pilot}.$PausedTime"/>
                  <remove_value name="global.$GT_Pilots.{$ship.pilot}.$PausedReason"/>
                  
                  <!-- Update associated ship -->
                  <set_value name="global.$GT_Pilots.{$ship.pilot}.$AssociatedShip" exact="$ship"/>
                </do_if>
                
                <!-- Ensure all fields exist (defensive programming) -->
                <run_actions ref="md.GT_Ship_Management.Ensure_Pilot_Fields">
                  <param name="pilot" value="$ship.pilot"/>
                </run_actions>
                
                <!-- Store original ship name if not already stored (strip any existing GT formatting) -->
                <do_if value="not global.$GT_Pilots.{$ship.pilot}.$OriginalShipName?">
                  <run_actions ref="md.GT_Ship_Management.Strip_GT_Name_Formatting" result="$cleanedName">
                    <param name="shipName" value="$ship.knownname"/>
                  </run_actions>
                  <set_value name="global.$GT_Pilots.{$ship.pilot}.$OriginalShipName" exact="$cleanedName"/>
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-Core] Stored cleaned original ship name for existing pilot: ' + $cleanedName + ' (from: ' + $ship.knownname + ') (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
                  </do_if>
                </do_if>
                
                <!-- Use extracted ship name update library -->
                <!-- Update ship name to match current XP level (for existing pilots) -->
                <run_actions ref="md.GT_Ship_Management.Update_Pilot_Ship_Name">
                  <param name="pilot" value="$ship.pilot"/>
                  <param name="ship" value="$ship"/>
                </run_actions>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GalaxyTrader MK3] XP System: EXISTING pilot ' + $ship.pilot.name + ' restored with XP: ' + global.$GT_Pilots.{$ship.pilot}.$XP + ', ship renamed to: ' + $ship.knownname + ' (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
                </do_if>
              </do_else>
            </do_if>
            </do_if>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] Fallback registration complete for ship: ' + $ship.knownname" chance="100"/>
            </do_if>
            
            <!-- Ensure ship name update happens (deferred to prevent stutter during registration) -->
            <do_if value="$ship.pilot and global.$GT_Pilots.{$ship.pilot}? and md.GT_Ship_Management.Update_Pilot_Ship_Name?">
              <!-- Defer name update slightly to spread load -->
              <signal_cue_instantly cue="DeferredShipNameUpdate" param="table[$ship=$ship, $pilot=$ship.pilot]"/>
            </do_if>
          </do_else>
        </do_if>
        
        <!-- Signal post-processing delay (yields CPU after processing this ship) -->
        <signal_cue_instantly cue="PostRegistrationDelay"/>
      </actions>
    </cue>
    
    <!-- Post-processing delay - yields CPU after each ship registration -->
    <cue name="PostRegistrationDelay" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <!-- 100ms delay after processing each ship (gives game CPU time to catch up) -->
      <!-- Increased from 30ms to prevent stutter -->
      <delay exact="100ms"/>
      <actions>
        <set_value name="global.$GT_RegistrationQueue.$Processing" exact="false"/>
        
        <!-- Continue processing if more ships in queue WITH DELAY to prevent stutter -->
        <do_if value="global.$GT_RegistrationQueue.$Ships.count gt 0">
          <signal_cue_instantly cue="DelayedRegistrationProcessing"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Delayed registration queue processing to prevent stuttering -->
    <cue name="DelayedRegistrationProcessing" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <!-- 200ms delay to spread load and prevent stutter (increased from 100ms) -->
      <!-- Gives game more CPU time between registrations -->
      <!-- Higher delay = smoother but slower registration (acceptable trade-off) -->
      <!-- Total delay per ship: 200ms before + 100ms after = 300ms per ship -->
      <delay exact="200ms"/>
      <actions>
        <signal_cue_instantly cue="ProcessRegistrationQueue"/>
      </actions>
    </cue>
    
    <!-- Deferred Ship Name Update - ensures ship names are updated after registration -->
    <cue name="DeferredShipNameUpdate" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <!-- 50ms delay to spread name update load -->
      <delay exact="50ms"/>
      <actions>
        <set_value name="$updateData" exact="event.param"/>
        <set_value name="$ship" exact="$updateData.$ship"/>
        <set_value name="$pilot" exact="$updateData.$pilot"/>
        
        <!-- Update ship name if ship and pilot still exist -->
        <do_if value="$ship.exists and $ship.isoperational and $pilot and global.$GT_Pilots.{$pilot}?">
          <run_actions ref="md.GT_Ship_Management.Update_Pilot_Ship_Name">
            <param name="pilot" value="$pilot"/>
            <param name="ship" value="$ship"/>
            <param name="forceUpdate" value="true"/>
          </run_actions>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Deferred ship name update completed for ' + $ship.knownname" chance="100"/>
          </do_if>
        </do_if>
      </actions>
    </cue>

    <!-- Ship Order Aborted Handler with Name Restoration -->
    <cue name="HandleShipOrderAborted" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Ship_Order_Aborted'" comment="Handle ship order abortion"/>
      </conditions>
      <actions>
        <set_value name="$abortData" exact="event.param2"/>
        <set_value name="$ship" exact="$abortData.$Ship"/>
        <set_value name="$pilot" exact="$abortData.$Pilot"/>
        <set_value name="$reason" exact="$abortData.$Reason"/>
        <set_value name="$originalName" exact="$abortData.$OriginalName"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Ship order aborted for ' + $ship.knownname + ': ' + $reason" chance="100"/>
        </do_if>
        
        <!-- ============================================= -->
        <!-- SHIP NAME RESTORATION                        -->
        <!-- ============================================= -->
        
        <!-- Use extracted library function to restore original ship name -->
        <run_actions ref="md.GT_Ship_Management.Restore_Original_Ship_Name">
          <param name="ship" value="$ship"/>
          <param name="pilot" value="$pilot"/>
          <param name="originalName" value="$originalName"/>
        </run_actions>

        <!-- ============================================= -->
        <!-- SHIP MODIFICATION CLEANUP                   -->
        <!-- ============================================= -->
        
        <!-- Clean up any ship modification tracking -->
        <do_if value="global.$GT_Applied_Mods? and global.$GT_Applied_Mods.{$ship}?">
          <remove_value name="global.$GT_Applied_Mods.{$ship}"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Ship modification tracking cleared for ' + $ship.knownname" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- ============================================= -->
        <!-- REGISTRY CLEANUP                             -->
        <!-- ============================================= -->
        
        <!-- Remove ship from GT_Ships registry -->
        <do_if value="global.$GT_Ships.{$ship}?">
          <remove_value name="global.$GT_Ships.{$ship}"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Ship removed from GT_Ships registry: ' + $ship.idcode" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Preserve pilot XP data - NEVER remove pilots from registry -->
        <!-- Instead, mark them as paused/inactive so they can be reactivated later with their XP intact -->
        <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
          <set_value name="$pilotHasOtherShips" exact="false"/>
          
          <!-- Check if pilot has other active GalaxyTrader ships -->
          <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
            <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
            <do_all exact="$shipKeys.count" counter="$i">
              <set_value name="$otherShip" exact="$shipKeys.{$i}"/>
              <do_if value="$otherShip.pilot == $pilot">
                <set_value name="$pilotHasOtherShips" exact="true"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>
          
          <!-- Mark pilot as paused instead of removing from registry -->
          <!-- This preserves XP, skill level, trades, profit, and all training data -->
          <do_if value="not $pilotHasOtherShips">
            <!-- No other active ships - mark pilot as paused to preserve all data -->
            <set_value name="global.$GT_Pilots.{$pilot}.$Status" exact="'paused'"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$PausedTime" exact="player.age"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$PausedReason" exact="'Order aborted - preserving XP data for reactivation'"/>
            <!-- Clear ship association since order is aborted -->
            <remove_value name="global.$GT_Pilots.{$pilot}.$AssociatedShip"/>
            <remove_value name="global.$GT_Pilots.{$pilot}.$Ship"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] Pilot paused (preserving XP data): ' + $pilot.name + ' (XP: ' + global.$GT_Pilots.{$pilot}.$XP + ', Level: ' + (if global.$GT_Pilots.{$pilot}.$Level? then global.$GT_Pilots.{$pilot}.$Level else 1) + ')'" chance="100"/>
            </do_if>
            
            <!-- Send logbook message thanking player for holiday -->
            <!-- Construct logbook message using TextDB syntax (vanilla pattern) -->
            <set_value name="$logbookMessage" exact="{77000,3215}.[player.name]"/>
            
            <run_actions ref="md.GT_Libraries_General.WriteLogbookMessage">
              <param name="Message" value="$logbookMessage"/>
              <param name="Category" value="'general'"/>
              <param name="Title" value="'Pilot Status: ' + $pilot.name"/>
              <param name="Object" value="$ship"/>
              <param name="Interaction" value="'showonmap'"/>
            </run_actions>
          </do_if>
          <do_else>
            <!-- Pilot has other active ships - keep them active -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] Pilot kept active (has other active ships): ' + $pilot.name" chance="100"/>
            </do_if>
          </do_else>
        </do_if>
        
        <!-- Update ship status (legacy compatibility) -->
        <do_if value="md.GT_Ship_Management.Update_Ship_Status?">
          <run_actions ref="md.GT_Ship_Management.Update_Ship_Status">
            <param name="ship" value="$ship"/>
            <param name="status" value="'aborted'"/>
          </run_actions>
        </do_if>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Ship cleanup completed for ' + $ship.idcode" chance="100"/>
        </do_if>
      </actions>
    </cue>

    <!-- Ship Order Paused Handler with XP Preservation -->
    <cue name="HandleShipOrderPaused" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Ship_Order_Paused'" comment="Handle ship order pause (preserve XP)"/>
      </conditions>
      <actions>
        <set_value name="$pauseData" exact="event.param2"/>
        <set_value name="$ship" exact="$pauseData.$Ship"/>
        <set_value name="$pilot" exact="$pauseData.$Pilot"/>
        <set_value name="$reason" exact="$pauseData.$Reason"/>
        <set_value name="$preserveData" exact="$pauseData.$PreserveData"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Ship order paused for ' + $ship.knownname + ': ' + $reason + ' (preserving XP: ' + $preserveData + ')'" chance="100"/>
        </do_if>
        
        <!-- ============================================= -->
        <!-- SHIP NAME PRESERVATION (DO NOT RESTORE)      -->
        <!-- ============================================= -->
        <!-- NOTE: When pausing (not aborting), we KEEP the current ship name with rank/level/XP.
             Name restoration to original only happens on permanent order removal (HandleShipOrderAborted).
             This preserves the player's view of their pilot's progression even during order changes. -->
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Ship name PRESERVED during pause: ' + $ship.knownname + ' (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
        </do_if>
        
        <!-- ============================================= -->
        <!-- SHIP MODIFICATION CLEANUP (PAUSE)           -->
        <!-- ============================================= -->
        
        <!-- Clean up any ship modification tracking -->
        <do_if value="global.$GT_Applied_Mods? and global.$GT_Applied_Mods.{$ship}?">
          <remove_value name="global.$GT_Applied_Mods.{$ship}"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Ship modification tracking cleared for ' + $ship.knownname" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- ============================================= -->
        <!-- SELECTIVE REGISTRY CLEANUP (PRESERVE XP)    -->
        <!-- ============================================= -->
        
        <!-- Remove ship from GT_Ships registry (ship-specific data) -->
        <do_if value="global.$GT_Ships.{$ship}?">
          <remove_value name="global.$GT_Ships.{$ship}"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Ship removed from GT_Ships registry: ' + $ship.idcode" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- CRITICAL: DO NOT remove pilot from GT_Pilots registry - preserve XP data -->
        <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
          <!-- Mark pilot as temporarily inactive but keep all XP data -->
          <set_value name="global.$GT_Pilots.{$pilot}.$Status" exact="'paused'"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$PausedTime" exact="player.age"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$PausedReason" exact="$reason"/>
          
          <!-- PRESERVE TRAINING STATE: Save training requirements if active -->
          <do_if value="global.$GT_Pilots.{$pilot}.$XPBlocked?">
            <set_value name="global.$GT_Pilots.{$pilot}.$PausedWithTrainingNeeded" exact="true"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$PausedBlockedLevel" exact="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] TRAINING STATE PRESERVED: Pilot ' + $pilot.name + ' was XP blocked at level ' + global.$GT_Pilots.{$pilot}.$BlockedLevel + ' - will restore training requirement'" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- Clear active training flags (but preserve paused state) -->
          <remove_value name="global.$GT_Pilots.{$pilot}.$XPBlocked"/>
          <remove_value name="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
          <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingInProgress"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Pilot marked as paused (XP preserved): ' + $pilot.name + ' - XP: ' + global.$GT_Pilots.{$pilot}.$XP" chance="100"/>
          </do_if>
        </do_if>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Ship pause completed for ' + $ship.idcode + ' (pilot XP data preserved)'" chance="100"/>
        </do_if>
      </actions>
    </cue>

    <!-- Ship Pilot Change Monitor removed -->
    <!-- Polling monitor has been removed. Order removal is now detected instantly via signal from AI script's <on_abort> handler. -->
    <!-- This provides instant response (0ms latency) and zero CPU overhead. Professional code doesn't crash - we trust the signal system. -->

    <!-- Orphaned Pilot Registry Cleanup - Catches edge cases where pilots are registered but ships no longer have GT orders -->
    <cue name="OrphanedPilotCleanup" instantiate="true">
      <conditions>
        <event_cue_signalled/>
        <check_value value="global.$GT_Pilots? and global.$GT_Pilots.keys.count gt 0"/>
      </conditions>
      <delay exact="1s"/><!-- Small delay to let game stabilize after load -->
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Core] Running orphaned pilot registry cleanup check...'" chance="100"/>
        </do_if>
        
        <set_value name="$cleanedCount" exact="0"/>
        <set_value name="$pilotKeys" exact="global.$GT_Pilots.keys.list"/>
        
        <do_all exact="$pilotKeys.count" counter="$i">
          <set_value name="$pilot" exact="$pilotKeys.{$i}"/>
          
          <!-- Skip if pilot object no longer exists -->
          <do_if value="not $pilot.exists">
            <continue/>
          </do_if>
          
          <!-- Get pilot's current ship -->
          <set_value name="$currentShip" exact="@$pilot.ship"/>
          <do_if value="not $currentShip or not $currentShip.exists">
            <!-- Pilot not on any ship - skip -->
            <continue/>
          </do_if>
          
          <!-- Check if ship has active GT order -->
          <set_value name="$hasGTOrder" exact="false"/>
          
          <!-- Direct GT order check -->
          <do_if value="$currentShip.defaultorder?">
            <do_if value="@$currentShip.defaultorder.id == 'GalaxyTraderMK3'">
              <set_value name="$hasGTOrder" exact="true"/>
            </do_if>
            
            <!-- Subordinate check: If ship has Assist order, check commander -->
            <do_elseif value="@$currentShip.defaultorder.id == 'Assist'">
              <do_if value="$currentShip.commander and $currentShip.commander.exists and $currentShip.commander != $currentShip">
                <do_if value="$currentShip.commander.defaultorder?">
                  <do_if value="@$currentShip.commander.defaultorder.id == 'GalaxyTraderMK3'">
                    <set_value name="$hasGTOrder" exact="true"/>
                  </do_if>
                </do_if>
              </do_if>
            </do_elseif>
          </do_if>
          
          <!-- If ship doesn't have GT order but pilot is registered (active OR paused), check if name needs restoration -->
          <do_if value="not $hasGTOrder and global.$GT_Pilots.{$pilot}?">
            <!-- Check if ship name is different from original (indicating it still has GT-style name) -->
            <set_value name="$needsNameRestore" exact="false"/>
            <do_if value="global.$GT_Pilots.{$pilot}.$OriginalShipName?">
              <set_value name="$originalName" exact="global.$GT_Pilots.{$pilot}.$OriginalShipName"/>
              <!-- If current name differs from original, it needs restoration -->
              <do_if value="$currentShip.knownname != $originalName">
                <set_value name="$needsNameRestore" exact="true"/>
              </do_if>
            </do_if>
            
            <do_if value="$needsNameRestore">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Core] ORPHANED PILOT DETECTED: ' + $pilot.name + ' on ship ' + $currentShip.knownname + ' (original: ' + $originalName + ') - no GT order found!'" chance="100"/>
              </do_if>
              
              <!-- OPTIMIZED: Use extracted library function to restore original ship name -->
              <run_actions ref="md.GT_Ship_Management.Restore_Original_Ship_Name">
                <param name="ship" value="$currentShip"/>
                <param name="pilot" value="$pilot"/>
                <param name="originalName" value="$originalName"/>
              </run_actions>
              
              <!-- Mark pilot as paused if not already (preserve XP) -->
              <do_if value="not global.$GT_Pilots.{$pilot}.$Status? or global.$GT_Pilots.{$pilot}.$Status != 'paused'">
                <set_value name="global.$GT_Pilots.{$pilot}.$Status" exact="'paused'"/>
                <set_value name="global.$GT_Pilots.{$pilot}.$PausedTime" exact="player.age"/>
                <set_value name="global.$GT_Pilots.{$pilot}.$PausedReason" exact="'Orphaned registration cleanup - ship no longer has GT order'"/>
              </do_if>
              
              <set_value name="$cleanedCount" exact="$cleanedCount + 1"/>
            </do_if>
          </do_if>
        </do_all>
        
        <do_if value="$cleanedCount gt 0">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Core] Orphaned pilot cleanup complete: ' + $cleanedCount + ' pilots cleaned up'" chance="100"/>
          </do_if>
        </do_if>
        <do_else>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Core] Orphaned pilot cleanup complete: No orphaned pilots found'" chance="100"/>
          </do_if>
        </do_else>
        
        <!-- Schedule next cleanup in 5 minutes -->
        <signal_cue_instantly cue="OrphanedPilotCleanupScheduler"/>
      </actions>
    </cue>
    
    <!-- Trigger orphaned cleanup on game load (scheduler will be started by cleanup cue itself) -->
    <cue name="TriggerCleanupOnLoad" instantiate="true">
      <conditions>
        <event_game_loaded/>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Core] Game loaded - triggering orphaned pilot cleanup...'" chance="100"/>
        </do_if>
        <signal_cue_instantly cue="OrphanedPilotCleanup"/>
        <!-- Scheduler will be triggered by OrphanedPilotCleanup when it completes -->
      </actions>
    </cue>
    
    <!-- Scheduler for recurring cleanup every 5 minutes -->
    <cue name="OrphanedPilotCleanupScheduler" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <delay exact="5min"/>
      <actions>
        <signal_cue_instantly cue="OrphanedPilotCleanup"/>
        <reset_cue cue="OrphanedPilotCleanupScheduler"/>
      </actions>
    </cue>

    <!-- One-Time Legacy Ship Name Fix (for ships active before fixes were applied) -->
    <cue name="LegacyShipNameFix" instantiate="true">
      <conditions>
        <event_game_loaded/>
        <check_value value="global.$GT_Initialized and not global.$GT_LegacyShipNamesFixed?"/>
      </conditions>
      <actions>
        <!-- Mark as fixed so this only runs once -->
        <set_value name="global.$GT_LegacyShipNamesFixed" exact="true"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Running one-time legacy ship name fix...'" chance="100"/>
        </do_if>
        
        <set_value name="$fixedCount" exact="0"/>
        <set_value name="$skippedCount" exact="0"/>
        
        <!-- Check all registered GT ships -->
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
          <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
          <do_all exact="$shipKeys.count" counter="$i">
            <set_value name="$ship" exact="$shipKeys.{$i}"/>
            
            <!-- Skip if ship no longer exists -->
            <do_if value="not $ship.exists or not $ship.isoperational or not $ship.pilot">
              <continue/>
            </do_if>
            
            <!-- Check if pilot exists in registry -->
            <do_if value="global.$GT_Pilots.{$ship.pilot}?">
              <set_value name="$pilotData" exact="global.$GT_Pilots.{$ship.pilot}"/>
              
              <!-- Check if ship needs name update - ONLY if name is EXACTLY the original base name -->
              <set_value name="$needsUpdate" exact="false"/>
              
              <!-- Ship needs update if it has the exact original name (no rank/level/XP added yet) -->
              <do_if value="$pilotData.$OriginalShipName? and $ship.knownname == $pilotData.$OriginalShipName and $pilotData.$XP? and $pilotData.$XP gt 0">
                <set_value name="$needsUpdate" exact="true"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Legacy] Ship ' + $ship.idcode + ' needs update: name matches original exactly'" chance="100"/>
                </do_if>
              </do_if>
              <do_else>
                <set_value name="$skippedCount" exact="$skippedCount + 1"/>
              </do_else>
              
              <do_if value="$needsUpdate">
                <!-- Store original name if not already stored (strip any existing GT formatting) -->
                <do_if value="not $pilotData.$OriginalShipName?">
                  <run_actions ref="md.GT_Ship_Management.Strip_GT_Name_Formatting" result="$cleanedName">
                    <param name="shipName" value="$ship.knownname"/>
                  </run_actions>
                  <set_value name="global.$GT_Pilots.{$ship.pilot}.$OriginalShipName" exact="$cleanedName"/>
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-Core] Cleanup: Stored cleaned original name: ' + $cleanedName + ' (from: ' + $ship.knownname + ')'" chance="if $cleanedName != $ship.knownname then 100 else 0"/>
                  </do_if>
                </do_if>
                
                <!-- OPTIMIZED: Use extracted libraries for skill level and ship name update -->
                <set_value name="$currentXP" exact="$pilotData.$XP"/>
                <run_actions ref="md.GT_Ship_Management.Update_Pilot_Ship_Name">
                  <param name="pilot" value="$ship.pilot"/>
                  <param name="ship" value="$ship"/>
                </run_actions>
                
                <set_value name="$fixedCount" exact="$fixedCount + 1"/>
                <run_actions ref="md.GT_Ship_Management.Calculate_Skill_Level_From_XP" result="$currentSkillLevel">
                  <param name="pilot" value="$ship.pilot"/>
                  <param name="xp" value="$currentXP"/>
                </run_actions>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GalaxyTrader MK3] Fixed ship name: ' + $ship.idcode + ' (Pilot: ' + $ship.pilot.name + ', Level: ' + $currentSkillLevel + ', XP: ' + $currentXP + ')'" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Legacy ship name fix complete: ' + $fixedCount + ' ships updated, ' + $skippedCount + ' ships already properly named'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Update All Ship Names Based on Configuration -->
    <cue name="UpdateAllShipNames" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Updating all ship names based on new naming configuration...'" chance="100"/>
        </do_if>
        
        <set_value name="$updatedCount" exact="0"/>
        
        <!-- Update all registered GT ships -->
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
          <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
          <do_all exact="$shipKeys.count" counter="$i">
            <set_value name="$ship" exact="$shipKeys.{$i}"/>
            
            <!-- Skip if ship no longer exists -->
            <do_if value="not $ship.exists or not $ship.isoperational">
              <continue/>
            </do_if>
            
            <!-- Get the pilot -->
            <set_value name="$pilot" exact="$ship.pilot"/>
            <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
              <!-- Get pilot data -->
              <set_value name="$pilotData" exact="global.$GT_Pilots.{$pilot}"/>
              <set_value name="$currentXP" exact="$pilotData.$XP"/>
              
              <!-- OPTIMIZED: Use extracted library for skill level calculation -->
              <run_actions ref="md.GT_Ship_Management.Calculate_Skill_Level_From_XP" result="$skillLevel">
                <param name="pilot" value="$pilot"/>
                <param name="xp" value="$currentXP"/>
              </run_actions>
              
              <!-- Build new ship name using configuration -->
              <do_if value="$pilotData.$OriginalShipName?">
                <set_value name="$originalName" exact="$pilotData.$OriginalShipName"/>
              </do_if>
              <do_else>
                <set_value name="$originalName" exact="$ship.knownname"/>
              </do_else>
              <set_value name="$nameElements" exact="[]"/>
              <set_value name="$prefixElements" exact="[]"/>
              <set_value name="$suffixElements" exact="[]"/>
              
              <!-- Status (training/blocked/advance indicators) -->
              <do_if value="global.$GT_GlobalSettings.$ShipNaming.$DisplayStatus">
                <set_value name="$statusText" exact="''"/>
                <!-- ADVANCE takes priority - pilot is eligible for advancement exam -->
                <do_if value="$pilotData.$XPBlocked?">
                  <set_value name="$statusText" exact="'ADVANCE'"/>
                </do_if>
                <!-- TRAINING only shown for non-advancement training -->
                <do_elseif value="$pilotData.$TrainingInProgress? and not $pilotData.$XPBlocked?">
                  <set_value name="$statusText" exact="'[TRAINING]'"/>
                </do_elseif>
                
                <do_if value="$statusText != ''">
                  <do_if value="global.$GT_GlobalSettings.$ShipNaming.$StatusPosition == 'prefix'">
                    <append_to_list name="$prefixElements" exact="$statusText"/>
                  </do_if>
                  <do_else>
                    <append_to_list name="$suffixElements" exact="$statusText"/>
                  </do_else>
                </do_if>
              </do_if>
              
              <!-- Pilot Rank -->
              <do_if value="global.$GT_GlobalSettings.$ShipNaming.$DisplayRank">
                <set_value name="$rankTitle" exact="'Lehrling'"/>
                <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                  <set_value name="$rankIndex" exact="1"/>
                  <do_if value="$skillLevel ge 15">
                    <set_value name="$rankIndex" exact="6"/>
                  </do_if>
                  <do_elseif value="$skillLevel ge 13">
                    <set_value name="$rankIndex" exact="5"/>
                  </do_elseif>
                  <do_elseif value="$skillLevel ge 10">
                    <set_value name="$rankIndex" exact="4"/>
                  </do_elseif>
                  <do_elseif value="$skillLevel ge 7">
                    <set_value name="$rankIndex" exact="3"/>
                  </do_elseif>
                  <do_elseif value="$skillLevel ge 4">
                    <set_value name="$rankIndex" exact="2"/>
                  </do_elseif>
                  
                  <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                    <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                  </do_if>
                </do_if>
                
                <do_if value="global.$GT_GlobalSettings.$ShipNaming.$RankPosition == 'prefix'">
                  <append_to_list name="$prefixElements" exact="$rankTitle"/>
                </do_if>
                <do_else>
                  <append_to_list name="$suffixElements" exact="$rankTitle"/>
                </do_else>
              </do_if>
              
              <!-- Level -->
              <do_if value="global.$GT_GlobalSettings.$ShipNaming.$DisplayLevel">
                <set_value name="$levelText" exact="'Lv.' + $skillLevel"/>
                <do_if value="global.$GT_GlobalSettings.$ShipNaming.$LevelPosition == 'prefix'">
                  <append_to_list name="$prefixElements" exact="$levelText"/>
                </do_if>
                <do_else>
                  <append_to_list name="$suffixElements" exact="$levelText"/>
                </do_else>
              </do_if>
              
              <!-- XP -->
              <do_if value="global.$GT_GlobalSettings.$ShipNaming.$DisplayXP">
                <set_value name="$xpText" exact="'XP:' + $currentXP"/>
                <do_if value="global.$GT_GlobalSettings.$ShipNaming.$XPPosition == 'prefix'">
                  <append_to_list name="$prefixElements" exact="$xpText"/>
                </do_if>
                <do_else>
                  <append_to_list name="$suffixElements" exact="$xpText"/>
                </do_else>
              </do_if>
              
              <!-- Build final name -->
              <set_value name="$newName" exact="$originalName"/>
              
              <!-- Add prefix elements -->
              <do_if value="$prefixElements.count gt 0">
                <set_value name="$prefixString" exact="''"/>
                <do_all exact="$prefixElements.count" counter="$j">
                  <do_if value="$j gt 1">
                    <set_value name="$prefixString" exact="$prefixString + ' '"/>
                  </do_if>
                  <set_value name="$prefixString" exact="$prefixString + $prefixElements.{$j}"/>
                </do_all>
                <set_value name="$newName" exact="$prefixString + ' ' + $newName"/>
              </do_if>
              
              <!-- Add suffix elements -->
              <do_if value="$suffixElements.count gt 0">
                <set_value name="$suffixString" exact="''"/>
                <do_all exact="$suffixElements.count" counter="$j">
                  <do_if value="$j gt 1">
                    <set_value name="$suffixString" exact="$suffixString + ' '"/>
                  </do_if>
                  <set_value name="$suffixString" exact="$suffixString + $suffixElements.{$j}"/>
                </do_all>
                <set_value name="$newName" exact="$newName + ' (' + $suffixString + ')'"/>
              </do_if>
              
              <!-- Apply the new name -->
              <set_object_name object="$ship" name="$newName"/>
              <set_value name="$updatedCount" exact="$updatedCount + 1"/>
              
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3] Updated ship name: ' + $ship.idcode + ' -> ' + $newName" chance="100"/>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Ship name update complete: ' + $updatedCount + ' ships updated'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Ship Modification Update Handler -->
    <cue name="HandleShipModificationUpdate" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Update_Ship'" comment="Handle ship updates from AI scripts"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.param2.$ship"/>
        <set_value name="$pilot" exact="event.param2.$pilot"/>
        <set_value name="$updateType" exact="event.param2.$updateType"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Core] Ship modification update requested: ' + $ship.knownname + ' (Type: ' + $updateType + ')'" chance="100"/>
        </do_if>
        
        <!-- DEBUG: Check library availability -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Core] DEBUG: GT_Ship_Management library check result: ' + md.GT_Ship_Management.Handle_Pilot_Ship_Assignment?" chance="100"/>
        </do_if>
        
        <!-- Handle different update types -->
        <do_if value="$updateType == 'training_completion'">
          <!-- Apply modifications after training completion -->
          <do_if value="md.GT_Ship_Management.Handle_Pilot_Ship_Assignment?">
            <run_actions ref="md.GT_Ship_Management.Handle_Pilot_Ship_Assignment">
              <param name="ship" value="$ship"/>
              <param name="new_pilot" value="$pilot"/>
              <param name="old_pilot" value="$pilot"/>
            </run_actions>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] Applied ship modifications after training completion for ' + $pilot.name" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] GT_Ship_Management library not available - ship modifications skipped'" chance="100"/>
            </do_if>
          </do_else>
          
        </do_if>
        <do_elseif value="$updateType == 'pilot_change'">
          <!-- Handle pilot assignment changes -->
          <set_value name="$oldPilot" exact="event.param2.$oldPilot"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] Processing pilot change on ' + $ship.knownname + ' - Old: ' + @$oldPilot.name + ', New: ' + @$pilot.name" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- Check if new pilot is a registered GT pilot -->
          <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
            <!-- New pilot is already registered - update ship name with their XP/rank -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] New pilot ' + $pilot.name + ' is registered GT pilot - updating ship name'" chance="100"/>
            </do_if>
            
            <!-- Register new pilot for this ship -->
            <do_if value="md.GT_Ship_Management.Register_Pilot?">
              <run_actions ref="md.GT_Ship_Management.Register_Pilot">
                <param name="pilot" value="$pilot"/>
                <param name="ship" value="$ship"/>
              </run_actions>
            </do_if>
          </do_if>
          <do_elseif value="$pilot">
            <!-- New pilot is NOT registered - restore original ship name and clean up old pilot -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] New pilot ' + $pilot.name + ' is NOT registered GT pilot - restoring original ship name'" chance="100"/>
            </do_if>
            
            <!-- Get original name from old pilot's registry -->
            <set_value name="$originalName" exact="null"/>
            <do_if value="$oldPilot and global.$GT_Pilots.{$oldPilot}? and global.$GT_Pilots.{$oldPilot}.$OriginalShipName?">
              <set_value name="$originalName" exact="global.$GT_Pilots.{$oldPilot}.$OriginalShipName"/>
            </do_if>
            <do_elseif value="$ship.knownname?">
              <set_value name="$originalName" exact="$ship.knownname"/>
            </do_elseif>
            
            <!-- Restore original ship name -->
            <do_if value="$originalName">
              <set_object_name object="$ship" name="$originalName"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Core] Ship name restored to: ' + $originalName" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- CRITICAL FIX: Register the new unregistered pilot -->
            <!-- This ensures unregistered pilots get registered when swapped in -->
            <do_if value="md.GT_Ship_Management.Register_Pilot?">
              <run_actions ref="md.GT_Ship_Management.Register_Pilot">
                <param name="pilot" value="$pilot"/>
                <param name="ship" value="$ship"/>
              </run_actions>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Core] Registered new unregistered pilot: ' + $pilot.name" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- Clean up old pilot if no other ships -->
            <do_if value="$oldPilot and global.$GT_Pilots.{$oldPilot}?">
              <!-- CRITICAL FIX: Preserve old pilot's XP data when pilot changes -->
              <!-- Mark old pilot as paused instead of removing, so they can be reactivated later -->
              <set_value name="$oldPilotHasOtherShips" exact="false"/>
              <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
                <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
                <do_all exact="$shipKeys.count" counter="$i">
                  <set_value name="$otherShip" exact="$shipKeys.{$i}"/>
                  <do_if value="@$otherShip.pilot == $oldPilot">
                    <set_value name="$oldPilotHasOtherShips" exact="true"/>
                    <break/>
                  </do_if>
                </do_all>
              </do_if>
              
              <do_if value="not $oldPilotHasOtherShips">
                <!-- Old pilot has no other ships - mark as paused to preserve XP data -->
                <set_value name="global.$GT_Pilots.{$oldPilot}.$Status" exact="'paused'"/>
                <set_value name="global.$GT_Pilots.{$oldPilot}.$PausedTime" exact="player.age"/>
                <set_value name="global.$GT_Pilots.{$oldPilot}.$PausedReason" exact="'Pilot changed on ship - preserving XP data'"/>
                <remove_value name="global.$GT_Pilots.{$oldPilot}.$AssociatedShip"/>
                <remove_value name="global.$GT_Pilots.{$oldPilot}.$Ship"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Core] Old pilot paused (preserving XP): ' + $oldPilot.name + ' (XP: ' + (if global.$GT_Pilots.{$oldPilot}.$XP? then global.$GT_Pilots.{$oldPilot}.$XP else 0) + ')'" chance="100"/>
                </do_if>
                
                <!-- ROLEPLAY: Send logbook message thanking player for holiday -->
                <set_value name="$message" exact="{77000,3215}.[player.name]"/>
                <write_to_logbook 
                  category="general" 
                  title="'Pilot Status: ' + $oldPilot.name" 
                  interaction="showonmap" 
                  object="$ship" 
                  text="$message"/>
              </do_if>
            </do_if>
          </do_elseif>
          
          <!-- Apply performance modifications -->
          <do_if value="md.GT_Ship_Management.Handle_Pilot_Ship_Assignment?">
            <run_actions ref="md.GT_Ship_Management.Handle_Pilot_Ship_Assignment">
              <param name="ship" value="$ship"/>
              <param name="new_pilot" value="$pilot"/>
              <param name="old_pilot" value="$oldPilot"/>
            </run_actions>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] Applied ship modifications after pilot change on ' + $ship.knownname" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] GT_Ship_Management library not available - pilot change modifications skipped'" chance="100"/>
            </do_if>
          </do_else>
          
        </do_elseif>
        <do_elseif value="$updateType == 'level_up'">
          <!-- Handle skill level increases -->
          <do_if value="md.GT_Ship_Management.Handle_Pilot_Ship_Assignment?">
            <run_actions ref="md.GT_Ship_Management.Handle_Pilot_Ship_Assignment">
              <param name="ship" value="$ship"/>
              <param name="new_pilot" value="$pilot"/>
              <param name="old_pilot" value="$pilot"/>
            </run_actions>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] Applied ship modifications after level up for ' + $pilot.name" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Core] GT_Ship_Management library not available - level up modifications skipped'" chance="100"/>
            </do_if>
          </do_else>
          
        </do_elseif>
      </actions>
    </cue>

  </cues>
</mdscript> 
