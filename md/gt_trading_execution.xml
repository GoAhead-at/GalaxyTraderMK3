<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Trading_Execution" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - TRADE EXECUTION
         Handles trade order creation and completion tracking
         ======================================== -->
    
    <!-- Execute Trade -->
    <cue name="ExecuteTrade" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$params" exact="event.param"/>
        <set_value name="$ship" exact="$params.$Ship"/>
        <set_value name="$trade" exact="$params.$Trade"/>
        
        <!-- Enhanced execution logging -->
        <debug_text text="'[GalaxyTrader MK3] ' + $ship.knownname + ' executing trade for ' + ($trade.$Profit / 100) + ' Cr profit' + '\n  📦 Ware: ' + $trade.$BuyOffer.ware.name + ' (x' + $trade.$Amount + ')' + '\n  📍 BUY from: ' + $trade.$BuyOffer.owner.knownname + ' @ ' + ($trade.$BuyPrice / 100) + ' Cr' + '\n  📍 SELL to: ' + $trade.$SellOffer.owner.knownname + ' @ ' + ($trade.$SellPrice / 100) + ' Cr' + '\n  🚀 Distance: ' + $trade.$Distance + ' jumps' + '\n  💰 Profit: ' + ($trade.$Profit / 100) + ' Cr'" chance="100"/>
        
        <!-- CRITICAL FIX: Validate offers are still available -->
        <set_value name="$buyOfferValid" exact="$trade.$BuyOffer.available and $trade.$BuyOffer.amount gt 0"/>
        <set_value name="$sellOfferValid" exact="$trade.$SellOffer.available and $trade.$SellOffer.amount gt 0"/>
        <set_value name="$canExecute" exact="true"/>
        
        <do_if value="not $buyOfferValid or not $sellOfferValid">
          <debug_text text="'[GalaxyTrader MK3] ⚠ Trade offer(s) no longer valid for ' + $ship.knownname" chance="100"/>
          <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
          <set_value name="$canExecute" exact="false"/>
        </do_if>
        
        <!-- CRITICAL FIX: Verify ship can carry the ware -->
        <do_if value="$canExecute">
          <set_value name="$ware" exact="$trade.$BuyOffer.ware"/>
          <do_if value="$ship.cargo.{$ware}.max le 0">
            <debug_text text="'[GalaxyTrader MK3] ⚠ Ship ' + $ship.knownname + ' cannot carry ware ' + $ware.name + ' - aborting trade'" chance="100"/>
            <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
            <set_value name="$canExecute" exact="false"/>
          </do_if>
        </do_if>
        
        <!-- CRITICAL FIX: Final check for illegal wares -->
        <do_if value="$canExecute">
          <set_value name="$allowIllegal" exact="@global.$GT_AIParameters.{$ship}.$AllowIllegal"/>
          <do_if value="not $allowIllegal">
            <!-- Simple type check: is this ware illegal to any faction? -->
            <do_if value="$ware.illegal">
              <debug_text text="'[GT-Execution] 🚫 ILLEGAL WARE BLOCKED: ' + $ship.knownname + ' attempted to trade ' + $ware.name + ' (ware type is illegal, AllowIllegal: ' + @$params.$AllowIllegal + ')'" chance="100"/>
              <!-- <debug_text text="'[GT-Execution] 📡 Sending GT_No_Trade_Found signal to ' + $ship.idcode" chance="100"/> -->
              <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
              <!-- <debug_text text="'[GT-Execution] ✅ GT_No_Trade_Found signal sent successfully'" chance="100"/> -->
              <set_value name="$canExecute" exact="false"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- ═══════════════════════════════════════════════════════════════════════════ -->
        <!-- OPTIMIZATION 4: Final blacklist validation (catches mid-search updates) -->
        <!-- This check runs ONCE per trade execution (vs. 1.3M times during search) -->
        <!-- If blacklisted, restart search - pre-filtering will catch updated blacklist -->
        <!-- Impact: 12 property lookups once per execution (minimal overhead) -->
        <!-- ═══════════════════════════════════════════════════════════════════════════ -->
        <do_if value="$canExecute">
          <!-- Determine ship's blacklistgroup (same logic as vanilla) -->
          <set_value name="$blacklistgroup" exact="blacklistgroup.civilian"/>
          <do_if value="(@$ship.primarypurpose == purpose.fight) or (@$ship.primarypurpose == purpose.auxiliary)">
            <set_value name="$blacklistgroup" exact="blacklistgroup.military"/>
          </do_if>
          
          <!-- CRITICAL: Check path reachability FIRST (faster to fail on unreachable) -->
          <!-- Extract stations from trade structure (handle both formats) -->
          <set_value name="$buyStation" exact="if $trade.$BuyStation? then $trade.$BuyStation else $trade.$BuyOffer.owner"/>
          <set_value name="$sellStation" exact="if $trade.$SellStation? then $trade.$SellStation else $trade.$SellOffer.owner"/>
          
          <!-- Use BLACKLIST-AWARE gatedistance so it respects blocked paths from threat system -->
          <!-- Correct syntax: $ship.gatedistance.{$targetSector}.{$blacklistgroup}.{$ship} (NO blacklisttype!) -->
          <set_value name="$buySector" exact="$buyStation.sector"/>
          <set_value name="$sellSector" exact="$sellStation.sector"/>
          <set_value name="$buyDistance" exact="$ship.gatedistance.{$buySector}.{$blacklistgroup}.{$ship}"/>
          <set_value name="$sellDistance" exact="$ship.gatedistance.{$sellSector}.{$blacklistgroup}.{$ship}"/>
          
          <do_if value="$buyDistance lt 0 or $sellDistance lt 0">
            <debug_text text="'[GT-Execution] 🚫 PATH BLOCKED: Trade became unreachable - restarting' +
              '\n  Ware: ' + @$trade.$BuyOffer.ware.name +
              '\n  BUY: ' + @$buyStation.knownname + ' (Sector: ' + @$buyStation.sector.knownname + ', Distance: ' + $buyDistance + ')' +
              '\n  SELL: ' + @$sellStation.knownname + ' (Sector: ' + @$sellStation.sector.knownname + ', Distance: ' + $sellDistance + ')' +
              '\n  Reason: No path exists (disconnected sectors, war, or gates destroyed)' +
              '\n  → Trade execution aborted, ship will search again with updated connectivity'" 
              chance="100"/>
            <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
            <set_value name="$canExecute" exact="false"/>
          </do_if>
          
          <do_if value="$canExecute">
            <!-- Check buy/sell station blacklists (matches vanilla order.trade.perform) -->
            <!-- Vanilla line 156: checks objectactivity, sectoractivity, sectortravel -->
            <set_value name="$buyStationBlacklisted" exact="@$buyStation.isblacklisted.{blacklisttype.objectactivity}.{$blacklistgroup}.{$ship}"/>
            <set_value name="$buySectorActivityBlacklisted" exact="@$buyStation.sector.isblacklisted.{blacklisttype.sectoractivity}.{$blacklistgroup}.{$ship}"/>
            <set_value name="$buySectorTravelBlacklisted" exact="@$buyStation.sector.isblacklisted.{blacklisttype.sectortravel}.{$blacklistgroup}.{$ship}"/>
            
            <set_value name="$sellStationBlacklisted" exact="@$sellStation.isblacklisted.{blacklisttype.objectactivity}.{$blacklistgroup}.{$ship}"/>
            <set_value name="$sellSectorActivityBlacklisted" exact="@$sellStation.sector.isblacklisted.{blacklisttype.sectoractivity}.{$blacklistgroup}.{$ship}"/>
            <set_value name="$sellSectorTravelBlacklisted" exact="@$sellStation.sector.isblacklisted.{blacklisttype.sectortravel}.{$blacklistgroup}.{$ship}"/>
            
            <set_value name="$isBlacklisted" exact="$buyStationBlacklisted or $buySectorActivityBlacklisted or $buySectorTravelBlacklisted or $sellStationBlacklisted or $sellSectorActivityBlacklisted or $sellSectorTravelBlacklisted"/>
            
            <do_if value="$isBlacklisted">
              <debug_text text="'[GT-Execution] ⚠️ BLACKLIST DETECTED: Trade became unsafe mid-search - restarting' +
                '\n  Ware: ' + @$trade.$BuyOffer.ware.name +
                '\n  BUY: ' + @$buyStation.knownname + ' (Sector: ' + @$buyStation.sector.knownname + ')' +
                '\n    Station: ' + $buyStationBlacklisted + ', SectorActivity: ' + $buySectorActivityBlacklisted + ', SectorTravel: ' + $buySectorTravelBlacklisted +
                '\n  SELL: ' + @$sellStation.knownname + ' (Sector: ' + @$sellStation.sector.knownname + ')' +
                '\n    Station: ' + $sellStationBlacklisted + ', SectorActivity: ' + $sellSectorActivityBlacklisted + ', SectorTravel: ' + $sellSectorTravelBlacklisted +
                '\n  → Trade execution aborted, ship will search again (updated blacklist will be applied)'" 
                chance="100"/>
              <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
              <set_value name="$canExecute" exact="false"/>
            </do_if>
          </do_if>
        </do_if>
        <!-- ═══════════════════════════════════════════════════════════════════════════ -->
        
        <!-- Only proceed if all checks passed -->
        <do_if value="$canExecute">
          <!-- CRITICAL FIX: Verify sufficient funds -->
          <set_value name="$availableMoney" exact="player.money"/>
          <set_value name="$moneySource" exact="'player'"/>
          
          <!-- Check if ship has a homebase station - use station's money instead -->
          <set_value name="$homeBase" exact="@$ship.defaultorder.$home"/>
          <do_if value="$homeBase? and $homeBase.exists and $homeBase.isclass.station">
            <set_value name="$availableMoney" exact="$homeBase.money"/>
            <set_value name="$moneySource" exact="'homebase: ' + $homeBase.knownname"/>
          </do_if>
          
          <set_value name="$tradeCost" exact="$trade.$Amount * $trade.$BuyPrice"/>
          <do_if value="$availableMoney lt $tradeCost">
            <debug_text text="'[GalaxyTrader MK3] ⚠ INSUFFICIENT FUNDS: ' + $ship.knownname + ' needs ' + ($tradeCost / 100) + ' Cr but only has ' + ($availableMoney / 100) + ' Cr'" chance="100"/>
            <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
            <set_value name="$canExecute" exact="false"/>
          </do_if>
          
          <do_if value="$canExecute">
            <!-- PHASE 4.1: ActiveTrades tracking DEPRECATED - Now handled by diff patch signals -->
            <!-- The diff patch in order.trade.perform.xml sends signals directly when trades complete/fail -->
            
            <!-- Create X4 native TradePerform orders for buy-sell cycle -->
            <!-- 
              ✅ CRITICAL: internal="true" enables blacklist routing in vanilla pathfinding
              - When internal="true", X4's TradePerform order uses strictblacklist mode
              - This makes move.generic route AROUND blacklisted sectors instead of through them
              - Ships can still reach destinations if an alternate path exists
              - Without this parameter, ships ignore blacklists and fly through hostile sectors
              
              How it works:
              1. create_trade_order with internal="true" creates TradePerform order
              2. TradePerform passes internalorder="true" to move.generic (via order.dock.xml)
              3. move.generic uses strictblacklist="true" when calculating paths
              4. Vanilla pathfinding automatically finds routes that avoid blacklisted sectors
              5. If no valid path exists, order fails gracefully (better than ship destruction)
              
              Reference: ORIGINAL_MODS_DO NOT_MODIFY/x4Original/aiscripts/order.trade.routine.xml
            -->
            <!-- ✅ NEW: Store complete trade LIST for AI validation and execution -->
            <!-- AI script will iterate through list and validate blacklist for each trade -->
            <do_if value="not global.$GT_PendingTrades?">
              <set_value name="global.$GT_PendingTrades" exact="table[]"/>
            </do_if>
            
            <!-- Get trade list from params (if available, otherwise use single trade for backward compat) -->
            <set_value name="$tradeList" exact="@event.param.$TradeList"/>
            <do_if value="not $tradeList? or $tradeList.count == 0">
              <!-- Fallback: wrap single trade in list -->
              <set_value name="$tradeList" exact="[$trade]"/>
            </do_if>
            
            <!-- Store the full trade list -->
            <set_value name="global.$GT_PendingTrades.{$ship}" exact="$tradeList"/>
            
            <!-- DEBUG: Log exact trade list stored for AI validation -->
            <set_value name="$logStoredList" exact="'[GT-Execution] 💾 STORED ' + $tradeList.count + ' trades for AI validation: ' + $ship.idcode"/>
            <do_all exact="$tradeList.count" counter="$i">
              <set_value name="$listTrade" exact="$tradeList.{$i}"/>
              <set_value name="$logStoredList" exact="$logStoredList + 
                '\n  [' + $i + '] ' + @$listTrade.$BuyOffer.ware.name + 
                ' | Buy: ' + @$listTrade.$BuyStation.knownname + ' (Sector: ' + @$listTrade.$BuyStation.sector.knownname + ') @ ' + (@$listTrade.$BuyPrice / 100) + ' Cr' +
                ' | Sell: ' + @$listTrade.$SellStation.knownname + ' (Sector: ' + @$listTrade.$SellStation.sector.knownname + ') @ ' + (@$listTrade.$SellPrice / 100) + ' Cr' +
                ' | Score: ' + $listTrade.$Score + ' | Profit: ' + (@$listTrade.$Profit / 100) + ' Cr | ROI: ' + @$listTrade.$ROI + '% | Dist: ' + $listTrade.$Distance + ' jumps'"/>
            </do_all>
            <set_value name="$logStoredList" exact="$logStoredList + '\n  ⚠ AI will iterate through list and validate blacklist for each trade'"/>
            <debug_text text="$logStoredList" chance="100"/>
            
            <!-- NOTE: Orders are NOT created here anymore! -->
            <!-- AI script will validate blacklist and create orders if valid -->
            <!-- This prevents wasted order creation for blacklisted stations -->
            
            <!-- SKIP logbook for now - will be logged after AI validates and creates orders -->
            <!-- Logbook signal was causing cue to complete before GT_Trade_Found could be sent -->
            
            <!-- Update ship statistics -->
            <do_if value="global.$GT_Ships.{$ship}?">
              <set_value name="global.$GT_Ships.{$ship}.$LastUpdate" exact="player.age"/>
            </do_if>
            
            <!-- CRITICAL: Signal AI that trade is ready for validation -->
            <!-- <debug_text text="'[GT-Execution] 📤 SENDING GT_Trade_Found signal to ' + $ship.idcode + ' at game time ' + player.age" chance="100"/> -->
            <signal_objects object="$ship" param="'GT_Trade_Found'"/>
            <!-- <debug_text text="'[GT-Execution] ✅ GT_Trade_Found signal SENT to ' + $ship.idcode + ' at game time ' + player.age" chance="100"/> -->
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- PHASE 4.2: TradeCompleted event monitoring REMOVED
         
         The old TradeCompleted cue (140+ lines) has been completely removed and replaced with
         the new diff patch signal system in gt_trading_signals.xml. The new system:
         
         Benefits:
         - Uses order.trade.perform.xml diff patch to inject signals directly from X4 native code
         - Provides richer trade data (actual transferred amounts, quality, exact failure reasons)
         - Eliminates complex buyer/seller matching logic
         - No longer needs ActiveTrades buy/sell phase tracking
         - More reliable and event-driven
         
         What was removed:
         - event_player_trade_completed monitoring (slow, requires matching)
         - Manual buy/sell phase tracking with global.$GT_TradingData.$ActiveTrades
         - Complex buyer/seller identification logic
         - Stale entry cleanup code
         
         The new system handles all of this automatically via diff patch signals.
    -->
    
  </cues>
</mdscript>
