<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Trading_Execution" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - TRADE EXECUTION
         Handles trade order creation and completion tracking
         ======================================== -->
    
    <!-- Execute Trade -->
    <cue name="ExecuteTrade" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$params" exact="event.param"/>
        <set_value name="$ship" exact="$params.$Ship"/>
        <set_value name="$trade" exact="$params.$Trade"/>
        
        <!-- Enhanced execution logging -->
        <debug_text text="'[GalaxyTrader MK3] ' + $ship.knownname + ' executing trade for ' + ($trade.$Profit / 100) + ' Cr profit' + '\n  ðŸ“¦ Ware: ' + $trade.$BuyOffer.ware.name + ' (x' + $trade.$Amount + ')' + '\n  ðŸ“ BUY from: ' + $trade.$BuyOffer.owner.knownname + ' @ ' + ($trade.$BuyPrice / 100) + ' Cr' + '\n  ðŸ“ SELL to: ' + $trade.$SellOffer.owner.knownname + ' @ ' + ($trade.$SellPrice / 100) + ' Cr' + '\n  ðŸš€ Distance: ' + $trade.$Distance + ' jumps' + '\n  ðŸ’° Profit: ' + ($trade.$Profit / 100) + ' Cr'" chance="100"/>
        
        <!-- CRITICAL FIX: Validate offers are still available -->
        <set_value name="$buyOfferValid" exact="$trade.$BuyOffer.available and $trade.$BuyOffer.amount gt 0"/>
        <set_value name="$sellOfferValid" exact="$trade.$SellOffer.available and $trade.$SellOffer.amount gt 0"/>
        <set_value name="$canExecute" exact="true"/>
        
        <do_if value="not $buyOfferValid or not $sellOfferValid">
          <debug_text text="'[GalaxyTrader MK3] âš  Trade offer(s) no longer valid for ' + $ship.knownname" chance="100"/>
          <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
          <set_value name="$canExecute" exact="false"/>
        </do_if>
        
        <!-- CRITICAL FIX: Verify ship can carry the ware -->
        <do_if value="$canExecute">
          <set_value name="$ware" exact="$trade.$BuyOffer.ware"/>
          <do_if value="$ship.cargo.{$ware}.max le 0">
            <debug_text text="'[GalaxyTrader MK3] âš  Ship ' + $ship.knownname + ' cannot carry ware ' + $ware.name + ' - aborting trade'" chance="100"/>
            <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
            <set_value name="$canExecute" exact="false"/>
          </do_if>
        </do_if>
        
        <!-- CRITICAL FIX: Final check for illegal wares -->
        <do_if value="$canExecute">
          <set_value name="$allowIllegal" exact="@global.$GT_AIParameters.{$ship}.$AllowIllegal"/>
          <do_if value="not $allowIllegal">
            <!-- Check buy zone, sell zone, ship's current zone AND home zone -->
            <set_value name="$buyZone" exact="$trade.$BuyOffer.owner.zone"/>
            <set_value name="$sellZone" exact="$trade.$SellOffer.owner.zone"/>
            <set_value name="$shipZone" exact="$ship.zone"/>
            
            <!-- Get ship's home zone -->
            <set_value name="$homeBase" exact="@$ship.defaultorder.$home"/>
            <set_value name="$homeZone" exact="null"/>
            <do_if value="$homeBase? and $homeBase.exists">
              <do_if value="$homeBase.isclass.station">
                <set_value name="$homeZone" exact="$homeBase.zone"/>
              </do_if>
              <do_elseif value="$homeBase.isclass.sector">
                <set_value name="$homeZone" exact="$homeBase"/>
              </do_elseif>
            </do_if>
            
            <set_value name="$isIllegal" exact="false"/>
            
            <!-- Check each zone for illegal status -->
            <do_if value="$homeZone and $homeZone.policefaction and $homeZone.policefaction != $ship.owner">
              <do_if value="$ware.illegalto.{$homeZone.policefaction}.{$ship.owner}">
                <set_value name="$isIllegal" exact="true"/>
              </do_if>
            </do_if>
            
            <do_if value="not $isIllegal and $shipZone.policefaction and $shipZone.policefaction != $ship.owner">
              <do_if value="$ware.illegalto.{$shipZone.policefaction}.{$ship.owner}">
                <set_value name="$isIllegal" exact="true"/>
              </do_if>
            </do_if>
            
            <do_if value="not $isIllegal and $buyZone.policefaction and $buyZone.policefaction != $ship.owner">
              <do_if value="$ware.illegalto.{$buyZone.policefaction}.{$ship.owner}">
                <set_value name="$isIllegal" exact="true"/>
              </do_if>
            </do_if>
            
            <do_if value="not $isIllegal and $sellZone.policefaction and $sellZone.policefaction != $ship.owner">
              <do_if value="$ware.illegalto.{$sellZone.policefaction}.{$ship.owner}">
                <set_value name="$isIllegal" exact="true"/>
              </do_if>
            </do_if>
            
            <do_if value="$isIllegal">
              <debug_text text="'[GT-Execution] ðŸš« ILLEGAL WARE BLOCKED: ' + $ship.knownname + ' attempted to trade ' + $ware.name + ' (AllowIllegal: ' + @$params.$AllowIllegal + ')'" chance="100"/>
              <debug_text text="'[GT-Execution] ðŸ“¡ Sending GT_No_Trade_Found signal to ' + $ship.idcode" chance="100"/>
              <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
              <debug_text text="'[GT-Execution] âœ… GT_No_Trade_Found signal sent successfully'" chance="100"/>
              <set_value name="$canExecute" exact="false"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Only proceed if all checks passed -->
        <do_if value="$canExecute">
          <!-- CRITICAL FIX: Verify sufficient funds -->
          <set_value name="$availableMoney" exact="player.money"/>
          <set_value name="$moneySource" exact="'player'"/>
          
          <!-- Check if ship has a homebase station - use station's money instead -->
          <set_value name="$homeBase" exact="@$ship.defaultorder.$home"/>
          <do_if value="$homeBase? and $homeBase.exists and $homeBase.isclass.station">
            <set_value name="$availableMoney" exact="$homeBase.money"/>
            <set_value name="$moneySource" exact="'homebase: ' + $homeBase.knownname"/>
          </do_if>
          
          <set_value name="$tradeCost" exact="$trade.$Amount * $trade.$BuyPrice"/>
          <do_if value="$availableMoney lt $tradeCost">
            <debug_text text="'[GalaxyTrader MK3] âš  INSUFFICIENT FUNDS: ' + $ship.knownname + ' needs ' + ($tradeCost / 100) + ' Cr but only has ' + ($availableMoney / 100) + ' Cr'" chance="100"/>
            <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
            <set_value name="$canExecute" exact="false"/>
          </do_if>
          
          <do_if value="$canExecute">
            <!-- PHASE 4.1: ActiveTrades tracking DEPRECATED - Now handled by diff patch signals -->
            <!-- The diff patch in order.trade.perform.xml sends signals directly when trades complete/fail -->
            
            <!-- Create X4 native TradePerform orders for buy-sell cycle -->
            <create_trade_order object="$ship" tradeoffer="$trade.$BuyOffer" amount="$trade.$Amount" immediate="false"/>
            <create_trade_order object="$ship" tradeoffer="$trade.$SellOffer" amount="$trade.$Amount" immediate="false"/>
            
            <debug_text text="'[GT-AI] âœ… Trade orders created for ' + $ship.knownname + ' (ID: ' + $ship.idcode + ')'" chance="100"/>
            
            <!-- Log trade order to ship logbook if enabled -->
            <set_value name="$logbookEnabled" exact="false"/>
            <do_if value="@$ship.defaultorder.id == 'GalaxyTraderMK3' and @$ship.defaultorder.$logbookentries">
              <set_value name="$logbookEnabled" exact="true"/>
            </do_if>
            <do_elseif value="@$ship.defaultorder.id == 'Assist' and @$ship.commander.defaultorder.id == 'GalaxyTraderMK3' and @$ship.commander.defaultorder.$logbookentries">
              <set_value name="$logbookEnabled" exact="true"/>
            </do_elseif>
            
            <do_if value="$logbookEnabled">
              <!-- âœ… BUGFIX: Use cached prices from search, not current offer prices! -->
              <!-- Validate trade offers before accessing properties -->
              <set_value name="$buyOfferValid" exact="$trade.$BuyOffer.exists"/>
              <set_value name="$sellOfferValid" exact="$trade.$SellOffer.exists"/>
              
              <!-- Build debug message with safe property access -->
              <set_value name="$debugMsg" exact="'[GT-Execution] ========== SENDING TO LOGBOOK ==========\nðŸš¢ Ship: ' + $ship.knownname + ' (' + $ship.idcode + ')'"/>
              
              <do_if value="$buyOfferValid">
                <set_value name="$debugMsg" exact="$debugMsg + '\nðŸ“¥ BuyOffer: ' + $trade.$BuyOffer.owner.knownname + ', CurrentPrice: ' + ($trade.$BuyOffer.unitprice/100) + ' Cr, CACHED: ' + ($trade.$BuyPrice/100) + ' Cr'"/>
              </do_if>
              <do_else>
                <set_value name="$debugMsg" exact="$debugMsg + '\nðŸ“¥ BuyOffer: [INVALID] - Using CACHED: ' + ($trade.$BuyPrice/100) + ' Cr'"/>
              </do_else>
              
              <do_if value="$sellOfferValid">
                <set_value name="$debugMsg" exact="$debugMsg + '\nðŸ“¤ SellOffer: ' + $trade.$SellOffer.owner.knownname + ', CurrentPrice: ' + ($trade.$SellOffer.unitprice/100) + ' Cr, CACHED: ' + ($trade.$SellPrice/100) + ' Cr'"/>
              </do_if>
              <do_else>
                <set_value name="$debugMsg" exact="$debugMsg + '\nðŸ“¤ SellOffer: [INVALID] - Using CACHED: ' + ($trade.$SellPrice/100) + ' Cr'"/>
              </do_else>
              
              <set_value name="$debugMsg" exact="$debugMsg + '\nðŸ’µ Sending BuyPrice (CACHED): ' + ($trade.$BuyPrice / 100) + ' Cr' + '\nðŸ’µ Sending SellPrice (CACHED): ' + ($trade.$SellPrice / 100) + ' Cr'"/>
              <debug_text text="$debugMsg" chance="100"/>
              
              <signal_objects object="player.galaxy" param="'GT_TradeLogging_LogTradeOrder'" param2="table[
                $Ship = $ship,
                $BuyOffer = $trade.$BuyOffer,
                $SellOffer = $trade.$SellOffer,
                $Amount = $trade.$Amount,
                $Profit = $trade.$Profit,
                $BuyPrice = $trade.$BuyPrice / 100,
                $SellPrice = $trade.$SellPrice / 100
              ]"/>
            </do_if>
            
            <!-- Update ship statistics -->
            <do_if value="global.$GT_Ships.{$ship}?">
              <set_value name="global.$GT_Ships.{$ship}.$LastUpdate" exact="player.age"/>
            </do_if>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- PHASE 4.2: TradeCompleted event monitoring REMOVED
         
         The old TradeCompleted cue (140+ lines) has been completely removed and replaced with
         the new diff patch signal system in gt_trading_signals.xml. The new system:
         
         Benefits:
         - Uses order.trade.perform.xml diff patch to inject signals directly from X4 native code
         - Provides richer trade data (actual transferred amounts, quality, exact failure reasons)
         - Eliminates complex buyer/seller matching logic
         - No longer needs ActiveTrades buy/sell phase tracking
         - More reliable and event-driven
         
         What was removed:
         - event_player_trade_completed monitoring (slow, requires matching)
         - Manual buy/sell phase tracking with global.$GT_TradingData.$ActiveTrades
         - Complex buyer/seller identification logic
         - Stale entry cleanup code
         
         The new system handles all of this automatically via diff patch signals.
    -->
    
  </cues>
</mdscript>
