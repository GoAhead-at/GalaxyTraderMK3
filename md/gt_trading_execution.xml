<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Trading_Execution" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - TRADE EXECUTION
         Handles trade order creation and completion tracking
         ======================================== -->
    
    <!-- Execute Trade -->
    <cue name="ExecuteTrade" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$params" exact="event.param"/>
        <set_value name="$ship" exact="$params.$Ship"/>
        <set_value name="$trade" exact="$params.$Trade"/>
        
        <!-- Enhanced execution logging -->
        <debug_text text="'[GalaxyTrader MK3] ' + $ship.knownname + ' executing trade for ' + ($trade.$Profit / 100) + ' Cr profit' + '\n  📦 Ware: ' + $trade.$BuyOffer.ware.name + ' (x' + $trade.$Amount + ')' + '\n  📍 BUY from: ' + $trade.$BuyOffer.owner.knownname + ' @ ' + ($trade.$BuyPrice / 100) + ' Cr' + '\n  📍 SELL to: ' + $trade.$SellOffer.owner.knownname + ' @ ' + ($trade.$SellPrice / 100) + ' Cr' + '\n  🚀 Distance: ' + $trade.$Distance + ' jumps' + '\n  💰 Profit: ' + ($trade.$Profit / 100) + ' Cr'" chance="100"/>
        
        <!-- CRITICAL FIX: Validate offers are still available -->
        <set_value name="$buyOfferValid" exact="$trade.$BuyOffer.available and $trade.$BuyOffer.amount gt 0"/>
        <set_value name="$sellOfferValid" exact="$trade.$SellOffer.available and $trade.$SellOffer.amount gt 0"/>
        <set_value name="$canExecute" exact="true"/>
        
        <do_if value="not $buyOfferValid or not $sellOfferValid">
          <debug_text text="'[GalaxyTrader MK3] ⚠ Trade offer(s) no longer valid for ' + $ship.knownname" chance="100"/>
          <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
          <set_value name="$canExecute" exact="false"/>
        </do_if>
        
        <!-- CRITICAL FIX: Verify ship can carry the ware -->
        <do_if value="$canExecute">
          <set_value name="$ware" exact="$trade.$BuyOffer.ware"/>
          <do_if value="$ship.cargo.{$ware}.max le 0">
            <debug_text text="'[GalaxyTrader MK3] ⚠ Ship ' + $ship.knownname + ' cannot carry ware ' + $ware.name + ' - aborting trade'" chance="100"/>
            <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
            <set_value name="$canExecute" exact="false"/>
          </do_if>
        </do_if>
        
        <!-- CRITICAL FIX: Final check for illegal wares -->
        <do_if value="$canExecute">
          <set_value name="$allowIllegal" exact="@global.$GT_AIParameters.{$ship}.$AllowIllegal"/>
          <do_if value="not $allowIllegal">
            <!-- Check buy zone, sell zone, ship's current zone AND home zone -->
            <set_value name="$buyZone" exact="$trade.$BuyOffer.owner.zone"/>
            <set_value name="$sellZone" exact="$trade.$SellOffer.owner.zone"/>
            <set_value name="$shipZone" exact="$ship.zone"/>
            
            <!-- Get ship's home zone -->
            <set_value name="$homeBase" exact="@$ship.defaultorder.$home"/>
            <set_value name="$homeZone" exact="null"/>
            <do_if value="$homeBase? and $homeBase.exists">
              <do_if value="$homeBase.isclass.station">
                <set_value name="$homeZone" exact="$homeBase.zone"/>
              </do_if>
              <do_elseif value="$homeBase.isclass.sector">
                <set_value name="$homeZone" exact="$homeBase"/>
              </do_elseif>
            </do_if>
            
            <set_value name="$isIllegal" exact="false"/>
            
            <!-- Check each zone for illegal status -->
            <do_if value="$homeZone and $homeZone.policefaction and $homeZone.policefaction != $ship.owner">
              <do_if value="$ware.illegalto.{$homeZone.policefaction}.{$ship.owner}">
                <set_value name="$isIllegal" exact="true"/>
              </do_if>
            </do_if>
            
            <do_if value="not $isIllegal and $shipZone.policefaction and $shipZone.policefaction != $ship.owner">
              <do_if value="$ware.illegalto.{$shipZone.policefaction}.{$ship.owner}">
                <set_value name="$isIllegal" exact="true"/>
              </do_if>
            </do_if>
            
            <do_if value="not $isIllegal and $buyZone.policefaction and $buyZone.policefaction != $ship.owner">
              <do_if value="$ware.illegalto.{$buyZone.policefaction}.{$ship.owner}">
                <set_value name="$isIllegal" exact="true"/>
              </do_if>
            </do_if>
            
            <do_if value="not $isIllegal and $sellZone.policefaction and $sellZone.policefaction != $ship.owner">
              <do_if value="$ware.illegalto.{$sellZone.policefaction}.{$ship.owner}">
                <set_value name="$isIllegal" exact="true"/>
              </do_if>
            </do_if>
            
            <do_if value="$isIllegal">
              <debug_text text="'[GalaxyTrader MK3] 🚫 ILLEGAL WARE BLOCKED: ' + $ship.knownname + ' attempted to trade ' + $ware.name" chance="100"/>
              <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
              <set_value name="$canExecute" exact="false"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Only proceed if all checks passed -->
        <do_if value="$canExecute">
          <!-- CRITICAL FIX: Verify sufficient funds -->
          <set_value name="$availableMoney" exact="player.money"/>
          <set_value name="$moneySource" exact="'player'"/>
          
          <!-- Check if ship has a homebase station - use station's money instead -->
          <set_value name="$homeBase" exact="@$ship.defaultorder.$home"/>
          <do_if value="$homeBase? and $homeBase.exists and $homeBase.isclass.station">
            <set_value name="$availableMoney" exact="$homeBase.money"/>
            <set_value name="$moneySource" exact="'homebase: ' + $homeBase.knownname"/>
          </do_if>
          
          <set_value name="$tradeCost" exact="$trade.$Amount * $trade.$BuyPrice"/>
          <do_if value="$availableMoney lt $tradeCost">
            <debug_text text="'[GalaxyTrader MK3] ⚠ INSUFFICIENT FUNDS: ' + $ship.knownname + ' needs ' + ($tradeCost / 100) + ' Cr but only has ' + ($availableMoney / 100) + ' Cr'" chance="100"/>
            <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
            <set_value name="$canExecute" exact="false"/>
          </do_if>
          
          <do_if value="$canExecute">
            <!-- Initialize TradingData if needed -->
            <do_if value="not global.$GT_TradingData?">
              <set_value name="global.$GT_TradingData" exact="table[]"/>
              <set_value name="global.$GT_TradingData.$ActiveTrades" exact="table[]"/>
              <set_value name="global.$GT_TradingData.$LastUpdate" exact="player.age"/>
            </do_if>
            
            <!-- Record trade in active trades -->
            <set_value name="global.$GT_TradingData.$ActiveTrades.{$ship}" exact="table[]"/>
            <set_value name="global.$GT_TradingData.$ActiveTrades.{$ship}.$StartTime" exact="player.age"/>
            <set_value name="global.$GT_TradingData.$ActiveTrades.{$ship}.$Trade" exact="$trade"/>
            
            <!-- Create X4 native TradePerform orders for buy-sell cycle -->
            <create_trade_order object="$ship" tradeoffer="$trade.$BuyOffer" amount="$trade.$Amount" immediate="false"/>
            <create_trade_order object="$ship" tradeoffer="$trade.$SellOffer" amount="$trade.$Amount" immediate="false"/>
            
            <debug_text text="'[GT-AI] ✅ Trade orders created for ' + $ship.knownname + ' (ID: ' + $ship.idcode + ')'" chance="100"/>
            
            <!-- Log trade order to ship logbook if enabled -->
            <set_value name="$logbookEnabled" exact="false"/>
            <do_if value="@$ship.defaultorder.id == 'GalaxyTraderMK3' and @$ship.defaultorder.$logbookentries">
              <set_value name="$logbookEnabled" exact="true"/>
            </do_if>
            <do_elseif value="@$ship.defaultorder.id == 'Assist' and @$ship.commander.defaultorder.id == 'GalaxyTraderMK3' and @$ship.commander.defaultorder.$logbookentries">
              <set_value name="$logbookEnabled" exact="true"/>
            </do_elseif>
            
            <do_if value="$logbookEnabled">
              <!-- ✅ BUGFIX: Use cached prices from search, not current offer prices! -->
              <!-- Validate trade offers before accessing properties -->
              <set_value name="$buyOfferValid" exact="$trade.$BuyOffer.exists"/>
              <set_value name="$sellOfferValid" exact="$trade.$SellOffer.exists"/>
              
              <!-- Build debug message with safe property access -->
              <set_value name="$debugMsg" exact="'[GT-Execution] ========== SENDING TO LOGBOOK ==========\n🚢 Ship: ' + $ship.knownname + ' (' + $ship.idcode + ')'"/>
              
              <do_if value="$buyOfferValid">
                <set_value name="$debugMsg" exact="$debugMsg + '\n📥 BuyOffer: ' + $trade.$BuyOffer.owner.knownname + ', CurrentPrice: ' + ($trade.$BuyOffer.unitprice/100) + ' Cr, CACHED: ' + ($trade.$BuyPrice/100) + ' Cr'"/>
              </do_if>
              <do_else>
                <set_value name="$debugMsg" exact="$debugMsg + '\n📥 BuyOffer: [INVALID] - Using CACHED: ' + ($trade.$BuyPrice/100) + ' Cr'"/>
              </do_else>
              
              <do_if value="$sellOfferValid">
                <set_value name="$debugMsg" exact="$debugMsg + '\n📤 SellOffer: ' + $trade.$SellOffer.owner.knownname + ', CurrentPrice: ' + ($trade.$SellOffer.unitprice/100) + ' Cr, CACHED: ' + ($trade.$SellPrice/100) + ' Cr'"/>
              </do_if>
              <do_else>
                <set_value name="$debugMsg" exact="$debugMsg + '\n📤 SellOffer: [INVALID] - Using CACHED: ' + ($trade.$SellPrice/100) + ' Cr'"/>
              </do_else>
              
              <set_value name="$debugMsg" exact="$debugMsg + '\n💵 Sending BuyPrice (CACHED): ' + ($trade.$BuyPrice / 100) + ' Cr' + '\n💵 Sending SellPrice (CACHED): ' + ($trade.$SellPrice / 100) + ' Cr'"/>
              <debug_text text="$debugMsg" chance="100"/>
              
              <signal_objects object="player.galaxy" param="'GT_TradeLogging_LogTradeOrder'" param2="table[
                $Ship = $ship,
                $BuyOffer = $trade.$BuyOffer,
                $SellOffer = $trade.$SellOffer,
                $Amount = $trade.$Amount,
                $Profit = $trade.$Profit,
                $BuyPrice = $trade.$BuyPrice / 100,
                $SellPrice = $trade.$SellPrice / 100
              ]"/>
            </do_if>
            
            <!-- Update ship statistics -->
            <do_if value="global.$GT_Ships.{$ship}?">
              <set_value name="global.$GT_Ships.{$ship}.$LastUpdate" exact="player.age"/>
            </do_if>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Trade Completion Handler -->
    <cue name="TradeCompleted" instantiate="true">
      <conditions>
        <event_player_trade_completed/>
      </conditions>
      <actions>
        <set_value name="$trade" exact="event.param"/>
        <set_value name="$buyer" exact="$trade.buyer"/>
        <set_value name="$seller" exact="$trade.seller"/>
        <set_value name="$price" exact="$trade.unitprice * $trade.transferredamount"/>
        <set_value name="$gtShip" exact="null"/>
        <set_value name="$isBuyTrade" exact="false"/>
        
        <!-- Check if buyer is a GalaxyTrader MK3 ship -->
        <do_if value="$buyer.isoperational and $buyer.trueowner == faction.player and $buyer.isclass.ship and $buyer.defaultorder?">
          <do_if value="@$buyer.defaultorder.id == 'GalaxyTraderMK3' or ((@$buyer.defaultorder.id == 'Assist') and (@$buyer.commander.defaultorder.id == 'GalaxyTraderMK3'))">
            <set_value name="$gtShip" exact="$buyer"/>
            <set_value name="$isBuyTrade" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Check if seller is a GalaxyTrader MK3 ship -->
        <do_elseif value="$seller.isoperational and $seller.trueowner == faction.player and $seller.isclass.ship and $seller.defaultorder?">
          <do_if value="@$seller.defaultorder.id == 'GalaxyTraderMK3' or ((@$seller.defaultorder.id == 'Assist') and (@$seller.commander.defaultorder.id == 'GalaxyTraderMK3'))">
            <set_value name="$gtShip" exact="$seller"/>
            <set_value name="$isBuyTrade" exact="false"/>
          </do_if>
        </do_elseif>
        
        <!-- Process trade completion if this is a GalaxyTrader MK3 ship -->
        <do_if value="$gtShip">
          <!-- Ensure ship is registered -->
          <do_if value="not global.$GT_Ships.{$gtShip}?">
            <debug_text text="'[GalaxyTrader MK3] FALLBACK: Registering ship ' + $gtShip.knownname + ' during trade completion'" chance="100"/>
            <set_value name="global.$GT_Ships.{$gtShip}" exact="table[]"/>
            <set_value name="global.$GT_Ships.{$gtShip}.$RegisterTime" exact="player.age"/>
            <set_value name="global.$GT_Ships.{$gtShip}.$TotalProfit" exact="0"/>
            <set_value name="global.$GT_Ships.{$gtShip}.$TradesCompleted" exact="0"/>
          </do_if>
          
          <!-- Initialize active trades tracking if needed -->
          <do_if value="not global.$GT_TradingData?">
            <set_value name="global.$GT_TradingData" exact="table[]"/>
            <set_value name="global.$GT_TradingData.$ActiveTrades" exact="table[]"/>
          </do_if>
          
          <do_if value="$isBuyTrade">
            <!-- Buying - subtract cost -->
            <do_if value="global.$GT_Ships.{$gtShip}.$TotalProfit?">
              <set_value name="global.$GT_Ships.{$gtShip}.$TotalProfit" exact="$price" operation="subtract"/>
            </do_if>
            <do_else>
              <set_value name="global.$GT_Ships.{$gtShip}.$TotalProfit" exact="$price * -1"/>
            </do_else>
            
            <debug_text text="'[GalaxyTrader MK3] ' + $gtShip.knownname + ' BOUGHT ' + $trade.transferredamount + ' ' + $trade.ware + ' for ' + ($price / 100) + ' Cr'" chance="100"/>
            
            <!-- Mark buy phase complete -->
            <do_if value="global.$GT_TradingData.$ActiveTrades.{$gtShip}?">
              <set_value name="global.$GT_TradingData.$ActiveTrades.{$gtShip}.$BuyCompleted" exact="true"/>
            </do_if>
          </do_if>
          <do_else>
            <!-- Selling - add revenue -->
            <do_if value="global.$GT_Ships.{$gtShip}.$TotalProfit?">
              <set_value name="global.$GT_Ships.{$gtShip}.$TotalProfit" exact="$price" operation="add"/>
            </do_if>
            <do_else>
              <set_value name="global.$GT_Ships.{$gtShip}.$TotalProfit" exact="$price"/>
            </do_else>
            
            <!-- Increment completed trades count -->
            <do_if value="global.$GT_Ships.{$gtShip}.$TradesCompleted?">
              <set_value name="global.$GT_Ships.{$gtShip}.$TradesCompleted" operation="add"/>
            </do_if>
            <do_else>
              <set_value name="global.$GT_Ships.{$gtShip}.$TradesCompleted" exact="1"/>
            </do_else>
            
            <!-- Update session statistics -->
            <do_if value="not global.$GT_SessionStats?">
              <set_value name="global.$GT_SessionStats" exact="table[]"/>
              <set_value name="global.$GT_SessionStats.$TotalProfit" exact="0"/>
              <set_value name="global.$GT_SessionStats.$TradesCompleted" exact="0"/>
            </do_if>
            <set_value name="global.$GT_SessionStats.$TotalProfit" exact="$price" operation="add"/>
            <set_value name="global.$GT_SessionStats.$TradesCompleted" operation="add"/>
            
            <debug_text text="'[GalaxyTrader MK3] ' + $gtShip.knownname + ' SOLD ' + $trade.transferredamount + ' ' + $trade.ware + ' for ' + ($price / 100) + ' Cr (Trade #' + global.$GT_Ships.{$gtShip}.$TradesCompleted + ')'" chance="100"/>
            
            <!-- Mark sell phase complete and check if full trade cycle is done -->
            <do_if value="global.$GT_TradingData.$ActiveTrades.{$gtShip}?">
              <set_value name="global.$GT_TradingData.$ActiveTrades.{$gtShip}.$SellCompleted" exact="true"/>
              
              <!-- Check if both buy and sell are complete -->
              <do_if value="global.$GT_TradingData.$ActiveTrades.{$gtShip}.$BuyCompleted? and global.$GT_TradingData.$ActiveTrades.{$gtShip}.$SellCompleted?">
                <debug_text text="'[GalaxyTrader MK3] ' + $gtShip.knownname + ' completed full trade cycle'" chance="100"/>
                
                <!-- FLEET COORDINATION: Release trade reservation -->
                <set_value name="$shipFleetCoordination" exact="true"/>
                <do_if value="global.$GT_AIParameters.{$gtShip}? and global.$GT_AIParameters.{$gtShip}.$FleetCoordination?">
                  <set_value name="$shipFleetCoordination" exact="global.$GT_AIParameters.{$gtShip}.$FleetCoordination"/>
                </do_if>
                
                <do_if value="$shipFleetCoordination and global.$GT_ActiveTradeReservations.{$gtShip}?">
                  <remove_value name="global.$GT_ActiveTradeReservations.{$gtShip}"/>
                  <debug_text text="'[GT-FLEET] (' + $gtShip.idcode + ') ✅ Trade reservation released'" chance="100"/>
                </do_if>
                
                <!-- Signal AI script that trade is complete -->
                <signal_objects object="$gtShip" param="'GT_Trade_Completed'"/>
                
                <!-- AUTO-REPAIR: Check if ship needs repairs -->
                <do_if value="$gtShip.hullpercentage lt 95">
                  <signal_objects object="player.galaxy" param="'GT_CheckAutoRepair'" param2="$gtShip"/>
                </do_if>
                
                <!-- Clean up active trade data -->
                <remove_value name="global.$GT_TradingData.$ActiveTrades.{$gtShip}"/>
              </do_if>
            </do_if>
            <do_else>
              <!-- Handle single sell operation -->
              <signal_objects object="$gtShip" param="'GT_Trade_Completed'"/>
              
              <!-- AUTO-REPAIR check -->
              <do_if value="$gtShip.hullpercentage lt 95">
                <signal_objects object="player.galaxy" param="'GT_CheckAutoRepair'" param2="$gtShip"/>
              </do_if>
            </do_else>
          </do_else>
          
          <!-- Update ship last activity -->
          <set_value name="global.$GT_Ships.{$gtShip}.$LastUpdate" exact="player.age"/>
        </do_if>
      </actions>
    </cue>
  </cues>
</mdscript>
