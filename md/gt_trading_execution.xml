<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Trading_Execution" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - TRADE EXECUTION
         Handles trade order creation and completion tracking
         ======================================== -->
    
    <!-- Execute Trade -->
    <cue name="ExecuteTrade" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$params" exact="event.param"/>
        <set_value name="$ship" exact="$params.$Ship"/>
        <set_value name="$trade" exact="@$params.$Trade"/>  <!-- Use @ operator - Trade may not exist -->
        <set_value name="$tradeList" exact="@$params.$TradeList"/> <!-- Trade list for fallback -->
        
        <!-- ✅ FIX: Extract trade from TradeList if Trade is null (cache hits send only TradeList) -->
        <do_if value="not $trade? and $tradeList? and $tradeList.count gt 0">
          <set_value name="$trade" exact="$tradeList.{1}"/>
          <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Execution] (' + $ship.idcode + ') Extracted trade from TradeList (cache hit path)'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- ✅ FIX: Validate trade is not null before accessing properties -->
        <do_if value="not $trade?">
          <debug_text text="'[GT-Execution] ⚠️ ERROR: ExecuteTrade called with null trade for ' + $ship.idcode + ' (TradeList count: ' + (if $tradeList? then $tradeList.count else 0) + ')'" chance="100"/>
          <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
          <cancel_cue cue="this"/>
        </do_if>
        
        <!-- ✅ FIX: Validate trade has required properties -->
        <!-- ✅ FIX: Support sell-only trades (forced sell) where BuyOffer is null -->
        <set_value name="$tradeValid" exact="false"/>
        <set_value name="$isSellOnly" exact="false"/>
        <do_if value="$trade?">
          <set_value name="$testBuyOffer" exact="@$trade.$BuyOffer"/>
          <set_value name="$testSellOffer" exact="@$trade.$SellOffer"/>
          <set_value name="$testIsSellOnly" exact="@$trade.$IsSellOnly"/>
          <do_if value="$testIsSellOnly">
            <!-- Sell-only trade: only SellOffer required -->
            <do_if value="$testSellOffer?">
              <set_value name="$tradeValid" exact="true"/>
              <set_value name="$isSellOnly" exact="true"/>
            </do_if>
          </do_if>
          <do_else>
            <!-- Normal trade: both offers required -->
            <do_if value="$testBuyOffer? and $testSellOffer?">
              <set_value name="$tradeValid" exact="true"/>
            </do_if>
          </do_else>
        </do_if>
        
        <do_if value="not $tradeValid">
          <debug_text text="'[GT-Execution] ⚠️ ERROR: ExecuteTrade called with invalid trade (missing BuyOffer/SellOffer) for ' + $ship.idcode" chance="100"/>
          <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
          <cancel_cue cue="this"/>
        </do_if>
        
        <!-- Enhanced execution logging (will be updated if fallback trade is used) -->
        <set_value name="$executionLogDone" exact="false"/>
        <do_if value="$tradeValid">
          <set_value name="$profit" exact="@$trade.$Profit"/>
          <set_value name="$amount" exact="@$trade.$Amount"/>
          <set_value name="$buyPrice" exact="@$trade.$BuyPrice"/>
          <set_value name="$sellPrice" exact="@$trade.$SellPrice"/>
          <set_value name="$distance" exact="@$trade.$Distance"/>
          <!-- ✅ FIX: Handle sell-only trades (BuyOffer may be null) -->
          <set_value name="$wareName" exact="'Unknown'"/>
          <set_value name="$buyStationName" exact="'N/A (sell-only)'"/>
          <set_value name="$sellStationName" exact="'Unknown'"/>
          <do_if value="not $isSellOnly and $trade.$BuyOffer?">
            <set_value name="$wareName" exact="@$trade.$BuyOffer.ware.name"/>
            <set_value name="$buyStationName" exact="@$trade.$BuyOffer.owner.knownname"/>
          </do_if>
          <do_elseif value="$isSellOnly and $trade.$SellOffer?">
            <set_value name="$wareName" exact="@$trade.$Ware.name"/>
            <set_value name="$buyStationName" exact="'Ship cargo (sell-only)'"/>
          </do_elseif>
          <do_if value="$trade.$SellOffer?">
            <set_value name="$sellStationName" exact="@$trade.$SellOffer.owner.knownname"/>
          </do_if>
          <!-- Note: This log will be skipped if trade becomes invalid and fallback is used -->
          <!-- Fallback trade logging happens in the fallback block -->
        </do_if>
        
        <!-- Only proceed if trade is valid -->
        <do_if value="$tradeValid">
          <!-- CRITICAL FIX: Validate offers are still available -->
          <!-- ✅ FIX: Use safe operators to access trade properties -->
          <!-- ✅ FIX: Handle sell-only trades (BuyOffer may be null) -->
          <set_value name="$buyOffer" exact="@$trade.$BuyOffer"/>
          <set_value name="$sellOffer" exact="@$trade.$SellOffer"/>
          <set_value name="$buyOfferValid" exact="false"/>
          <set_value name="$sellOfferValid" exact="false"/>
          <do_if value="$isSellOnly">
            <!-- Sell-only trade: only validate SellOffer -->
            <do_if value="$sellOffer?">
              <set_value name="$sellOfferValid" exact="$sellOffer.available and $sellOffer.amount gt 0"/>
            </do_if>
            <set_value name="$buyOfferValid" exact="true"/>  <!-- Always valid for sell-only -->
          </do_if>
          <do_else>
            <!-- Normal trade: validate both offers -->
            <do_if value="$buyOffer? and $sellOffer?">
              <set_value name="$buyOfferValid" exact="$buyOffer.available and $buyOffer.amount gt 0"/>
              <set_value name="$sellOfferValid" exact="$sellOffer.available and $sellOffer.amount gt 0"/>
            </do_if>
          </do_else>
          <set_value name="$canExecute" exact="true"/>
          
          <!-- Log original trade execution (only if trade is still valid) -->
          <do_if value="$buyOfferValid and $sellOfferValid">
            <do_if value="$isSellOnly">
              <debug_text text="'[GalaxyTrader MK3] ' + $ship.knownname + ' executing SELL-ONLY trade for ' + ($profit / 100) + ' Cr profit' + '\n  📦 Ware: ' + $wareName + ' (x' + $amount + ')' + '\n  📍 SELL to: ' + $sellStationName + ' @ ' + ($sellPrice / 100) + ' Cr' + '\n  🚀 Distance: ' + $distance + ' jumps' + '\n  💰 Profit: ' + ($profit / 100) + ' Cr'" chance="100"/>
            </do_if>
            <do_else>
              <debug_text text="'[GalaxyTrader MK3] ' + $ship.knownname + ' executing trade for ' + ($profit / 100) + ' Cr profit' + '\n  📦 Ware: ' + $wareName + ' (x' + $amount + ')' + '\n  📍 BUY from: ' + $buyStationName + ' @ ' + ($buyPrice / 100) + ' Cr' + '\n  📍 SELL to: ' + $sellStationName + ' @ ' + ($sellPrice / 100) + ' Cr' + '\n  🚀 Distance: ' + $distance + ' jumps' + '\n  💰 Profit: ' + ($profit / 100) + ' Cr'" chance="100"/>
            </do_else>
          </do_if>
          
          <!-- ✅ RACE CONDITION FIX: If selected trade is invalid, try fallback trades from list -->
          <do_if value="not $buyOfferValid or not $sellOfferValid">
            <debug_text text="'[GT-Execution] ⚠ Selected trade offer(s) no longer valid for ' + $ship.idcode + ' - trying fallback trades'" chance="100"/>
            
            <!-- Try fallback trades from tradeList -->
            <set_value name="$foundValidTrade" exact="false"/>
            <set_value name="$fallbackTrade" exact="null"/>
            <do_if value="$tradeList? and $tradeList.count gt 0">
              <do_all exact="$tradeList.count" counter="$i">
                <do_if value="not $foundValidTrade">
                  <set_value name="$candidateTrade" exact="$tradeList.{$i}"/>
                  <do_if value="$candidateTrade?">
                    <set_value name="$candidateBuyOffer" exact="@$candidateTrade.$BuyOffer"/>
                    <set_value name="$candidateSellOffer" exact="@$candidateTrade.$SellOffer"/>
                    <set_value name="$candidateBuyValid" exact="false"/>
                    <set_value name="$candidateSellValid" exact="false"/>
                    <do_if value="$candidateBuyOffer? and $candidateSellOffer?">
                      <set_value name="$candidateBuyValid" exact="$candidateBuyOffer.available and $candidateBuyOffer.amount gt 0"/>
                      <set_value name="$candidateSellValid" exact="$candidateSellOffer.available and $candidateSellOffer.amount gt 0"/>
                    </do_if>
                    <do_if value="$candidateBuyValid and $candidateSellValid">
                      <set_value name="$foundValidTrade" exact="true"/>
                      <set_value name="$fallbackTrade" exact="$candidateTrade"/>
                      <set_value name="$trade" exact="$candidateTrade"/>  <!-- Replace selected trade with valid fallback -->
                      <set_value name="$buyOffer" exact="$candidateBuyOffer"/>
                      <set_value name="$sellOffer" exact="$candidateSellOffer"/>
                      <set_value name="$buyOfferValid" exact="true"/>
                      <set_value name="$sellOfferValid" exact="true"/>
                      <set_value name="$canExecute" exact="true"/>
                      <!-- Update execution logging variables for fallback trade -->
                      <set_value name="$profit" exact="@$candidateTrade.$Profit"/>
                      <set_value name="$amount" exact="@$candidateTrade.$Amount"/>
                      <set_value name="$buyPrice" exact="@$candidateTrade.$BuyPrice"/>
                      <set_value name="$sellPrice" exact="@$candidateTrade.$SellPrice"/>
                      <set_value name="$distance" exact="@$candidateTrade.$Distance"/>
                      <set_value name="$wareName" exact="@$candidateBuyOffer.ware.name"/>
                      <set_value name="$buyStationName" exact="@$candidateBuyOffer.owner.knownname"/>
                      <set_value name="$sellStationName" exact="@$candidateSellOffer.owner.knownname"/>
                      <debug_text text="'[GT-Execution] ✅ Found valid fallback trade #' + ($i + 1) + ' for ' + $ship.idcode + ': ' + $wareName + ' (Profit: ' + ($profit / 100) + ' Cr)'" chance="100"/>
                      <break/>
                    </do_if>
                  </do_if>
                </do_if>
              </do_all>
            </do_if>
            
            <!-- If no valid fallback trade found, signal no trade found -->
            <do_if value="not $foundValidTrade">
              <debug_text text="'[GT-Execution] ❌ No valid trades found in fallback list for ' + $ship.idcode + ' - restarting search'" chance="100"/>
              <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
              <set_value name="$canExecute" exact="false"/>
            </do_if>
          </do_if>
          
          <!-- CRITICAL FIX: Verify ship can carry the ware -->
          <!-- ✅ FIX: Handle sell-only trades (ware comes from $trade.$Ware, not $buyOffer.ware) -->
          <do_if value="$canExecute">
            <set_value name="$ware" exact="null"/>
            <do_if value="$isSellOnly">
              <!-- Sell-only trade: extract ware from trade structure -->
              <set_value name="$ware" exact="@$trade.$Ware"/>
            </do_if>
            <do_else>
              <!-- Normal trade: extract ware from buy offer -->
              <set_value name="$ware" exact="@$buyOffer.ware"/>
            </do_else>
            
            <do_if value="not $ware?">
              <debug_text text="'[GalaxyTrader MK3] ⚠ Trade missing ware information for ' + $ship.knownname + ' (IsSellOnly: ' + $isSellOnly + ')'" chance="100"/>
              <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
              <set_value name="$canExecute" exact="false"/>
            </do_if>
            <do_if value="$canExecute and $ware?">
              <!-- ✅ FIX: Skip cargo capacity check for sell-only trades (ship already has cargo) -->
              <do_if value="not $isSellOnly">
                <do_if value="$ship.cargo.{$ware}.max le 0">
                  <debug_text text="'[GalaxyTrader MK3] ⚠ Ship ' + $ship.knownname + ' cannot carry ware ' + $ware.name + ' - aborting trade'" chance="100"/>
                  <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
                  <set_value name="$canExecute" exact="false"/>
                </do_if>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- CRITICAL FIX: Final check for illegal wares -->
          <do_if value="$canExecute">
          <set_value name="$allowIllegal" exact="@global.$GT_AIParameters.{$ship}.$AllowIllegal"/>
          <do_if value="not $allowIllegal">
            <!-- Simple type check: is this ware illegal to any faction? -->
            <do_if value="$ware? and $ware.illegal">
              <debug_text text="'[GT-Execution] 🚫 ILLEGAL WARE BLOCKED: ' + $ship.knownname + ' attempted to trade ' + $ware.name + ' (ware type is illegal, AllowIllegal: ' + @$params.$AllowIllegal + ')'" chance="100"/>
              <!-- <debug_text text="'[GT-Execution] 📡 Sending GT_No_Trade_Found signal to ' + $ship.idcode" chance="100"/> -->
              <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
              <!-- <debug_text text="'[GT-Execution] ✅ GT_No_Trade_Found signal sent successfully'" chance="100"/> -->
              <set_value name="$canExecute" exact="false"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- ═══════════════════════════════════════════════════════════════════════════ -->
        <!-- OPTIMIZATION 4: Final blacklist validation (catches mid-search updates) -->
        <!-- This check runs ONCE per trade execution (vs. 1.3M times during search) -->
        <!-- If blacklisted, restart search - pre-filtering will catch updated blacklist -->
        <!-- Impact: 12 property lookups once per execution (minimal overhead) -->
        <!-- ═══════════════════════════════════════════════════════════════════════════ -->
        <do_if value="$canExecute">
          <!-- Determine ship's blacklistgroup (same logic as vanilla) -->
          <run_actions ref="md.GT_Libraries_Blacklist.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
          
          <!-- CRITICAL: Check path reachability FIRST (faster to fail on unreachable) -->
          <!-- Extract stations from trade structure (handle both formats) -->
          <!-- ✅ FIX: Use pre-extracted $buyOffer and $sellOffer -->
          <!-- ✅ FIX: Handle sell-only trades (BuyStation may be ship object or null) -->
          <set_value name="$buyStation" exact="null"/>
          <set_value name="$sellStation" exact="null"/>
          <do_if value="$isSellOnly">
            <!-- Sell-only trade: BuyStation is ship's docked station or ship itself -->
            <set_value name="$buyStation" exact="@$trade.$BuyStation"/>
            <set_value name="$sellStation" exact="@$trade.$SellStation"/>
          </do_if>
          <do_else>
            <!-- Normal trade: Extract from trade structure or offers -->
            <do_if value="$trade.$BuyStation?">
              <set_value name="$buyStation" exact="$trade.$BuyStation"/>
            </do_if>
            <do_else>
              <set_value name="$buyStation" exact="@$buyOffer.owner"/>
            </do_else>
            <do_if value="$trade.$SellStation?">
              <set_value name="$sellStation" exact="$trade.$SellStation"/>
            </do_if>
            <do_else>
              <set_value name="$sellStation" exact="@$sellOffer.owner"/>
            </do_else>
          </do_else>
          
          <!-- Use BLACKLIST-AWARE gatedistance so it respects blocked paths from threat system -->
          <!-- Correct syntax: $ship.gatedistance.{$targetSector}.{$blacklistgroup}.{$ship} (NO blacklisttype!) -->
          <!-- ✅ FIX: Handle sell-only trades (BuyStation may be ship object, extract sector safely) -->
          <set_value name="$currentSector" exact="$ship.sector"/>
          <set_value name="$buySector" exact="null"/>
          <set_value name="$sellSector" exact="null"/>
          
          <do_if value="$isSellOnly">
            <!-- Sell-only trade: Ship already has cargo, no buy path needed -->
            <!-- BuySector = ship's current sector (cargo already on board) -->
            <set_value name="$buySector" exact="$currentSector"/>
            <!-- Extract sell sector from sell station -->
            <do_if value="$sellStation?">
              <set_value name="$sellSector" exact="@$sellStation.sector"/>
            </do_if>
          </do_if>
          <do_else>
            <!-- Normal trade: Extract sectors from stations -->
            <do_if value="$buyStation?">
              <set_value name="$buySector" exact="@$buyStation.sector"/>
            </do_if>
            <do_if value="$sellStation?">
              <set_value name="$sellSector" exact="@$sellStation.sector"/>
            </do_if>
          </do_else>
          
          <!-- ✅ FIX: Validate sectors extracted before pathfinding -->
          <do_if value="not $buySector? or not $sellSector?">
            <debug_text text="'[GT-Execution] ⚠️ ERROR: Failed to extract sectors for ' + $ship.idcode + ' (IsSellOnly: ' + $isSellOnly + ', BuyStation: ' + (if $buyStation? then 'exists' else 'null') + ', SellStation: ' + (if $sellStation? then 'exists' else 'null') + ')'" chance="100"/>
            <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
            <set_value name="$canExecute" exact="false"/>
          </do_if>
          
          <do_if value="$canExecute">
            <!-- ✅ ESCAPE LOGIC: Calculate path distances with escape support -->
            <!-- Check if current sector is blacklisted for escape logic -->
            <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$currentSectorIsBlacklistedForEscape">
              <param name="sector" value="$currentSector"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            
            <!-- ✅ FIX: Handle sell-only trades (no buy path needed, only sell path) -->
            <do_if value="$isSellOnly">
              <!-- Sell-only trade: Only calculate sell path (from current sector to sell sector) -->
              <set_value name="$buyDistance" exact="0"/>  <!-- No buy path - cargo already on board -->
              <do_if value="$sellSector == $currentSector">
                <!-- Ship and sell station in same sector -->
                <set_value name="$sellDistance" exact="0"/>
              </do_if>
              <do_else>
                <!-- Calculate path from ship's current location to sell station -->
                <run_actions ref="md.GT_Libraries_Pathfinding.GT_CalculatePathDistance" result="$sellDistance">
                  <param name="ship" value="$ship"/>
                  <param name="fromSector" value="$currentSector"/>
                  <param name="toSector" value="$sellSector"/>
                  <param name="blacklistgroup" value="$blacklistgroup"/>
                  <param name="useEscapeMode" value="$currentSectorIsBlacklistedForEscape"/>
                </run_actions>
              </do_else>
            </do_if>
            <do_else>
              <!-- Normal trade: Calculate both buy and sell paths -->
              <!-- ✅ ESCAPE LOGIC: Buy path calculation with escape support -->
              <run_actions ref="md.GT_Libraries_Pathfinding.GT_CalculatePathDistance" result="$buyDistance">
                <param name="ship" value="$ship"/>
                <param name="fromSector" value="$currentSector"/>
                <param name="toSector" value="$buySector"/>
                <param name="blacklistgroup" value="$blacklistgroup"/>
                <param name="useEscapeMode" value="$currentSectorIsBlacklistedForEscape"/>
              </run_actions>
              
              <!-- Sell path: Calculate based on buy location -->
              <do_if value="$sellSector == $buySector">
                <!-- Buy and sell in same sector -->
                <set_value name="$sellDistance" exact="0"/>
              </do_if>
              <do_elseif value="$buySector == $currentSector">
                <!-- ✅ ESCAPE CASE: Ship is in buy sector (same as current) - check path FROM ship's current position to sell sector -->
                <run_actions ref="md.GT_Libraries_Pathfinding.GT_CalculatePathDistance" result="$sellDistance">
                  <param name="ship" value="$ship"/>
                  <param name="fromSector" value="$currentSector"/>
                  <param name="toSector" value="$sellSector"/>
                  <param name="blacklistgroup" value="$blacklistgroup"/>
                  <param name="useEscapeMode" value="$currentSectorIsBlacklistedForEscape"/>
                </run_actions>
              </do_elseif>
              <do_else>
                <!-- Normal case: Need to travel from buy to sell sector -->
                <do_if value="$buySector == $sellSector">
                  <set_value name="$sellDistance" exact="0"/>
                </do_if>
                <do_else>
                  <set_value name="$sellDistance" exact="$buySector.gatedistance.{$sellSector}.{$blacklistgroup}.{$ship}"/>
                </do_else>
              </do_else>
            </do_else>
          </do_if>
          
          <do_if value="$buyDistance lt 0 or $sellDistance lt 0">
            <!-- ✅ FIX: Use pre-extracted $ware and safe operators -->
            <!-- ✅ FIX: Handle sell-only trades (BuyStation may be null or ship object) -->
            <set_value name="$wareNameForLog" exact="@$ware.name"/>
            <set_value name="$buyStationNameForLog" exact="'N/A (sell-only)'"/>
            <set_value name="$buySectorNameForLog" exact="'N/A (sell-only)'"/>
            <do_if value="not $isSellOnly and $buyStation?">
              <set_value name="$buyStationNameForLog" exact="@$buyStation.knownname"/>
              <set_value name="$buySectorNameForLog" exact="@$buyStation.sector.knownname"/>
            </do_if>
            <set_value name="$sellStationNameForLog" exact="'Unknown'"/>
            <set_value name="$sellSectorNameForLog" exact="'Unknown'"/>
            <do_if value="$sellStation?">
              <set_value name="$sellStationNameForLog" exact="@$sellStation.knownname"/>
              <set_value name="$sellSectorNameForLog" exact="@$sellStation.sector.knownname"/>
            </do_if>
            <debug_text text="'[GT-Execution] 🚫 PATH BLOCKED: Trade became unreachable - restarting' +
              '\n  Ware: ' + $wareNameForLog +
              '\n  Trade Type: ' + (if $isSellOnly then 'Sell-Only' else 'Normal') +
              '\n  BUY: ' + $buyStationNameForLog + ' (Sector: ' + $buySectorNameForLog + ', Distance: ' + $buyDistance + ')' +
              '\n  SELL: ' + $sellStationNameForLog + ' (Sector: ' + $sellSectorNameForLog + ', Distance: ' + $sellDistance + ')' +
              '\n  Reason: No path exists (disconnected sectors, war, or gates destroyed)' +
              '\n  → Trade execution aborted, ship will search again with updated connectivity'" 
              chance="100"/>
            <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
            <set_value name="$canExecute" exact="false"/>
          </do_if>
          
          <!-- ✅ PERFORMANCE: Blacklist validation removed from ExecuteTrade -->
          <!-- AI script (order.trade.galaxytrader.xml) handles all blacklist validation -->
          <!-- This eliminates double-checking and reduces CPU overhead -->
          <!-- AI script validates each trade with delays (cooperative multitasking) -->
        </do_if>
        <!-- ═══════════════════════════════════════════════════════════════════════════ -->
        
        <!-- Only proceed if all checks passed (inside $tradeValid block) -->
        <do_if value="$canExecute">
          <!-- CRITICAL FIX: Verify sufficient funds -->
          <set_value name="$availableMoney" exact="player.money"/>
          <set_value name="$moneySource" exact="'player'"/>
          
          <!-- Check if ship has a homebase station - use station's money instead -->
          <set_value name="$homeBase" exact="@$ship.defaultorder.$home"/>
          <do_if value="$homeBase? and $homeBase.exists and $homeBase.isclass.station">
            <set_value name="$availableMoney" exact="$homeBase.money"/>
            <set_value name="$moneySource" exact="'homebase: ' + $homeBase.knownname"/>
          </do_if>
          
          <!-- ✅ FIX: Use safe operators to access trade properties -->
          <set_value name="$tradeAmount" exact="@$trade.$Amount"/>
          <set_value name="$tradeBuyPrice" exact="@$trade.$BuyPrice"/>
          <set_value name="$tradeCost" exact="0"/>
          <do_if value="$tradeAmount? and $tradeBuyPrice?">
            <set_value name="$tradeCost" exact="$tradeAmount * $tradeBuyPrice"/>
          </do_if>
          <do_if value="$availableMoney lt $tradeCost">
            <debug_text text="'[GalaxyTrader MK3] ⚠ INSUFFICIENT FUNDS: ' + $ship.knownname + ' needs ' + ($tradeCost / 100) + ' Cr but only has ' + ($availableMoney / 100) + ' Cr'" chance="100"/>
            <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
            <set_value name="$canExecute" exact="false"/>
          </do_if>
          
          <do_if value="$canExecute">
            <!-- PHASE 4.1: ActiveTrades tracking DEPRECATED - Now handled by diff patch signals -->
            <!-- The diff patch in order.trade.perform.xml sends signals directly when trades complete/fail -->
            
            <!-- Create X4 native TradePerform orders for buy-sell cycle -->
            <!-- 
              ✅ CRITICAL: internal="true" enables blacklist routing in vanilla pathfinding
              - When internal="true", X4's TradePerform order uses strictblacklist mode
              - This makes move.generic route AROUND blacklisted sectors instead of through them
              - Ships can still reach destinations if an alternate path exists
              - Without this parameter, ships ignore blacklists and fly through hostile sectors
              
              How it works:
              1. create_trade_order with internal="true" creates TradePerform order
              2. TradePerform passes internalorder="true" to move.generic (via order.dock.xml)
              3. move.generic uses strictblacklist="true" when calculating paths
              4. Vanilla pathfinding automatically finds routes that avoid blacklisted sectors
              5. If no valid path exists, order fails gracefully (better than ship destruction)
              
              Reference: ORIGINAL_MODS_DO NOT_MODIFY/x4Original/aiscripts/order.trade.routine.xml
            -->
            <!-- ✅ NEW: Store complete trade LIST for AI validation and execution -->
            <!-- AI script will iterate through list and validate blacklist for each trade -->
            <!-- ✅ SIMPLIFIED: Initialization guarantees global.$GT_PendingTrades exists -->
            
            <!-- Get trade list from params (if available, otherwise use single trade for backward compat) -->
            <set_value name="$tradeList" exact="@event.param.$TradeList"/>
            <do_if value="not $tradeList? or $tradeList.count == 0">
              <!-- Fallback: wrap single trade in list -->
              <set_value name="$tradeList" exact="[$trade]"/>
            </do_if>
            
            <!-- Store the full trade list -->
            <set_value name="global.$GT_PendingTrades.{$ship}" exact="$tradeList"/>
            
            <!-- ✅ NEW: Store search method so AI knows if trades came from cache or live search -->
            <!-- Store separately since $tradeList is a list and we need to track the source -->
            <set_value name="$searchMethod" exact="@event.param.$SearchMethod"/>
            <do_if value="$searchMethod?">
              <!-- ✅ RACE CONDITION FIX: Ensure table exists before accessing (handles race condition) -->
              <do_if value="not global.$GT_PendingTradesSearchMethod?">
                <set_value name="global.$GT_PendingTradesSearchMethod" exact="table[]"/>
              </do_if>
              <!-- Store search method in a separate table keyed by ship -->
              <set_value name="global.$GT_PendingTradesSearchMethod.{$ship}" exact="$searchMethod"/>
            </do_if>
            
            <!-- DEBUG: Log exact trade list stored for AI validation -->
            <!-- Split into multiple messages if list is large (X4 string limit ~4096 chars) -->
            <set_value name="$maxTradesPerLog" exact="25"/>
            <set_value name="$totalTrades" exact="$tradeList.count"/>
            <set_value name="$currentBatch" exact="0"/>
            
            <do_if value="$totalTrades gt $maxTradesPerLog">
              <!-- Large list: Split into batches -->
              <!-- Calculate number of batches needed (rounds up: (n-1)/k + 1) -->
              <set_value name="$numBatches" exact="(($totalTrades - 1) / $maxTradesPerLog) + 1"/>
              <do_all exact="$numBatches" counter="$batch">
                <set_value name="$startIdx" exact="$batch * $maxTradesPerLog"/>
                <set_value name="$endIdx" exact="[$startIdx + $maxTradesPerLog, $totalTrades].min"/>
                <!-- Ensure endIdx is valid: not less than startIdx, not greater than totalTrades -->
                <set_value name="$actualEndIdx" exact="[[$endIdx, $startIdx + 1].max, $totalTrades].min"/>
                <!-- Ensure we don't loop beyond list bounds -->
                <set_value name="$loopCount" exact="[[$actualEndIdx - $startIdx, $totalTrades - $startIdx].min, 0].max"/>
                <!-- Only process and log if there are trades in this batch -->
                <do_if value="$loopCount gt 0">
                  <set_value name="$logStoredList" exact="'[GT-Execution] 💾 STORED trades for AI validation: ' + $ship.idcode + ' (batch ' + ($batch + 1) + '/' + $numBatches + ', trades ' + $startIdx + '-' + ($actualEndIdx - 1) + ' of ' + $totalTrades + ')'"/>
                  <do_all exact="$loopCount" counter="$offset">
                    <set_value name="$i" exact="$startIdx + $offset"/>
                    <!-- Safety check: ensure index is within bounds -->
                    <do_if value="$i lt $totalTrades">
                      <set_value name="$listTrade" exact="$tradeList.{$i}"/>
                      <!-- ✅ FIX: Handle sell-only trades (BuyOffer and BuyStation may be null) -->
                      <set_value name="$isSellOnlyLog" exact="false"/>
                      <set_value name="$wareNameLog" exact="'Unknown'"/>
                      <set_value name="$buyStationNameLog" exact="'N/A'"/>
                      <set_value name="$buySectorNameLog" exact="'N/A'"/>
                      <set_value name="$buyPriceLog" exact="0"/>
                      <do_if value="@$listTrade.$IsSellOnly">
                        <set_value name="$isSellOnlyLog" exact="true"/>
                        <set_value name="$wareNameLog" exact="if $listTrade.$Ware? then @$listTrade.$Ware.name else 'Unknown'"/>
                        <set_value name="$buyStationNameLog" exact="'Ship cargo (sell-only)'"/>
                        <set_value name="$buySectorNameLog" exact="'N/A'"/>
                        <set_value name="$buyPriceLog" exact="0"/>
                      </do_if>
                      <do_elseif value="$listTrade.$BuyOffer?">
                        <set_value name="$wareNameLog" exact="@$listTrade.$BuyOffer.ware.name"/>
                        <set_value name="$buyStationNameLog" exact="if $listTrade.$BuyStation? then @$listTrade.$BuyStation.knownname else (if $listTrade.$BuyOffer? then @$listTrade.$BuyOffer.owner.knownname else 'Unknown')"/>
                        <set_value name="$buySectorNameLog" exact="if $listTrade.$BuyStation? then @$listTrade.$BuyStation.sector.knownname else (if $listTrade.$BuyOffer? then @$listTrade.$BuyOffer.owner.sector.knownname else 'Unknown')"/>
                        <set_value name="$buyPriceLog" exact="@$listTrade.$BuyPrice"/>
                      </do_elseif>
                      <set_value name="$sellStationNameLog" exact="if $listTrade.$SellStation? then @$listTrade.$SellStation.knownname else (if $listTrade.$SellOffer? then @$listTrade.$SellOffer.owner.knownname else 'Unknown')"/>
                      <set_value name="$sellSectorNameLog" exact="if $listTrade.$SellStation? then @$listTrade.$SellStation.sector.knownname else (if $listTrade.$SellOffer? then @$listTrade.$SellOffer.owner.sector.knownname else 'Unknown')"/>
                      <set_value name="$logStoredList" exact="$logStoredList + 
                        '\n  [' + $i + '] ' + $wareNameLog + 
                        ' | Buy: ' + $buyStationNameLog + ' (Sector: ' + $buySectorNameLog + ') @ ' + ($buyPriceLog / 100) + ' Cr' +
                        ' | Sell: ' + $sellStationNameLog + ' (Sector: ' + $sellSectorNameLog + ') @ ' + (@$listTrade.$SellPrice / 100) + ' Cr' +
                        ' | Score: ' + $listTrade.$Score + ' | Profit: ' + (@$listTrade.$Profit / 100) + ' Cr | ROI: ' + @$listTrade.$ROI + '% | Dist: ' + $listTrade.$Distance + ' jumps'"/>
                    </do_if>
                  </do_all>
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="$logStoredList" chance="100"/>
                  </do_if>
                </do_if>
              </do_all>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Execution] ⚠ AI will iterate through list and validate blacklist for each trade'" chance="100"/>
              </do_if>
            </do_if>
            <do_else>
              <!-- Small list: Single message -->
              <set_value name="$logStoredList" exact="'[GT-Execution] 💾 STORED ' + $totalTrades + ' trades for AI validation: ' + $ship.idcode"/>
              <do_all exact="$totalTrades" counter="$i">
                <set_value name="$listTrade" exact="$tradeList.{$i}"/>
                <!-- ✅ FIX: Handle sell-only trades (BuyOffer and BuyStation may be null) -->
                <set_value name="$isSellOnlyLog" exact="false"/>
                <set_value name="$wareNameLog" exact="'Unknown'"/>
                <set_value name="$buyStationNameLog" exact="'N/A'"/>
                <set_value name="$buySectorNameLog" exact="'N/A'"/>
                <set_value name="$buyPriceLog" exact="0"/>
                <do_if value="@$listTrade.$IsSellOnly">
                  <set_value name="$isSellOnlyLog" exact="true"/>
                  <set_value name="$wareNameLog" exact="if $listTrade.$Ware? then @$listTrade.$Ware.name else 'Unknown'"/>
                  <set_value name="$buyStationNameLog" exact="'Ship cargo (sell-only)'"/>
                  <set_value name="$buySectorNameLog" exact="'N/A'"/>
                  <set_value name="$buyPriceLog" exact="0"/>
                </do_if>
                <do_elseif value="$listTrade.$BuyOffer?">
                  <set_value name="$wareNameLog" exact="@$listTrade.$BuyOffer.ware.name"/>
                  <set_value name="$buyStationNameLog" exact="if $listTrade.$BuyStation? then @$listTrade.$BuyStation.knownname else (if $listTrade.$BuyOffer? then @$listTrade.$BuyOffer.owner.knownname else 'Unknown')"/>
                  <set_value name="$buySectorNameLog" exact="if $listTrade.$BuyStation? then @$listTrade.$BuyStation.sector.knownname else (if $listTrade.$BuyOffer? then @$listTrade.$BuyOffer.owner.sector.knownname else 'Unknown')"/>
                  <set_value name="$buyPriceLog" exact="@$listTrade.$BuyPrice"/>
                </do_elseif>
                <set_value name="$sellStationNameLog" exact="if $listTrade.$SellStation? then @$listTrade.$SellStation.knownname else (if $listTrade.$SellOffer? then @$listTrade.$SellOffer.owner.knownname else 'Unknown')"/>
                <set_value name="$sellSectorNameLog" exact="if $listTrade.$SellStation? then @$listTrade.$SellStation.sector.knownname else (if $listTrade.$SellOffer? then @$listTrade.$SellOffer.owner.sector.knownname else 'Unknown')"/>
                <set_value name="$logStoredList" exact="$logStoredList + 
                  '\n  [' + $i + '] ' + $wareNameLog + 
                  ' | Buy: ' + $buyStationNameLog + ' (Sector: ' + $buySectorNameLog + ') @ ' + ($buyPriceLog / 100) + ' Cr' +
                  ' | Sell: ' + $sellStationNameLog + ' (Sector: ' + $sellSectorNameLog + ') @ ' + (@$listTrade.$SellPrice / 100) + ' Cr' +
                  ' | Score: ' + $listTrade.$Score + ' | Profit: ' + (@$listTrade.$Profit / 100) + ' Cr | ROI: ' + @$listTrade.$ROI + '% | Dist: ' + $listTrade.$Distance + ' jumps'"/>
              </do_all>
              <set_value name="$logStoredList" exact="$logStoredList + '\n  ⚠ AI will iterate through list and validate blacklist for each trade'"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="$logStoredList" chance="100"/>
              </do_if>
            </do_else>
            
            <!-- NOTE: Orders are NOT created here anymore! -->
            <!-- AI script will validate blacklist and create orders if valid -->
            <!-- This prevents wasted order creation for blacklisted stations -->
            
            <!-- SKIP logbook for now - will be logged after AI validates and creates orders -->
            <!-- Logbook signal was causing cue to complete before GT_Trade_Found could be sent -->
            
            <!-- Update ship statistics -->
            <do_if value="global.$GT_Ships.{$ship}?">
              <set_value name="global.$GT_Ships.{$ship}.$LastUpdate" exact="player.age"/>
            </do_if>
            
            <!-- CRITICAL: Signal AI that trade is ready for validation -->
            <!-- ✅ FIX: Use delayed cue to ensure AI wait block is active before sending signal -->
            <!-- This prevents race condition where signal is sent before wait block is ready -->
            <!-- Signal via delayed cue ensures wait block is definitely active -->
            <signal_cue_instantly cue="md.GT_Trading_Execution.SignalTradeFound" param="table[$Ship = $ship]"/>
          </do_if>
        </do_if>
        <!-- ✅ Close $tradeValid block -->
        </do_if>
      </actions>
    </cue>
    
    <!-- PHASE 4.2: TradeCompleted event monitoring REMOVED
         
         The old TradeCompleted cue (140+ lines) has been completely removed and replaced with
         the new diff patch signal system in gt_trading_signals.xml. The new system:
         
         Benefits:
         - Uses order.trade.perform.xml diff patch to inject signals directly from X4 native code
         - Provides richer trade data (actual transferred amounts, quality, exact failure reasons)
         - Eliminates complex buyer/seller matching logic
         - No longer needs ActiveTrades buy/sell phase tracking
         - More reliable and event-driven
         
         What was removed:
         - event_player_trade_completed monitoring (slow, requires matching)
         - Manual buy/sell phase tracking with global.$GT_TradingData.$ActiveTrades
         - Complex buyer/seller identification logic
         - Stale entry cleanup code
         
         The new system handles all of this automatically via diff patch signals.
    -->
    
    <!-- Delayed Signal Cue - Ensures AI wait block is active before sending signal -->
    <cue name="SignalTradeFound" instantiate="true">
      <conditions>
        <event_cue_signalled/>
        <check_value value="event.param.$Ship.exists"/>
      </conditions>
      <delay exact="500ms" comment="Ensure AI wait block is fully initialized before sending signal"/>
      <actions>
        <set_value name="$ship" exact="event.param.$Ship"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Execution] 📤 SENDING GT_Trade_Found signal to ' + $ship.idcode + ' at game time ' + player.age" chance="100"/>
        </do_if>
        <signal_objects object="$ship" param="'GT_Trade_Found'"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Execution] ✅ GT_Trade_Found signal SENT to ' + $ship.idcode + ' at game time ' + player.age" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- ========================================= -->
    <!-- MAINTENANCE TASKS -->
    <!-- Consolidated from: gt_trading_maintenance.xml -->
    <!-- ========================================= -->
    
    <!-- Periodic Cache Cleanup -->
    <cue name="RouteCacheCleanup" instantiate="true" checkinterval="300s">
      <conditions>
        <check_value value="global.$GT_TradingData?"/>
      </conditions>
      <actions>
        <!-- Clear outdated route cache entries -->
        <set_value name="$cacheAge" exact="player.age - global.$GT_TradingData.$LastUpdate"/>
        
        <do_if value="$cacheAge gt 600s">
          <set_value name="global.$GT_TradingData.$RouteCache" exact="table[]"/>
          <set_value name="global.$GT_TradingData.$LastUpdate" exact="player.age"/>
          <debug_text text="'[GalaxyTrader MK3] Route cache cleared'" chance="100"/>
        </do_if>
        
        <!-- Clean trade cache (rebuild list without old entries) -->
        <!-- ✅ FIX: Handle v5 per-home-sector cache structure (table indexed by home sector) -->
        <do_if value="global.$GT_TradeCache?">
          <set_value name="$cleanedEntries" exact="0"/>
          <set_value name="$cacheMaxAge" exact="600s"/>  <!-- 10 minutes -->
          
          <!-- Iterate through all home sectors in cache (v5 structure: table indexed by home sector) -->
          <!-- ✅ FIX: Use safe operator and null checks to prevent property lookup errors -->
          <do_all exact="global.$GT_TradeCache.keys.count" counter="$sectorIdx">
            <!-- Extract key with safe operator and validate it's not null -->
            <set_value name="$homeSector" exact="@global.$GT_TradeCache.keys.{$sectorIdx}"/>
            <do_if value="$homeSector?">
              <!-- Only proceed if we have a valid home sector key -->
              <set_value name="$sectorCache" exact="@global.$GT_TradeCache.{$homeSector}"/>
              
              <!-- Process this home sector's cache list -->
              <do_if value="$sectorCache? and $sectorCache.count gt 0">
                <set_value name="$cleanSectorCache" exact="[]"/>
                
                <!-- Iterate through entries in this home sector's cache -->
                <do_all exact="$sectorCache.count" counter="$i">
                  <set_value name="$entry" exact="$sectorCache.{$i}"/>
                  
                  <!-- Check if entry is too old or invalid -->
                  <set_value name="$isExpired" exact="false"/>
                  <do_if value="$entry.$Timestamp? and (player.age - $entry.$Timestamp) gt $cacheMaxAge">
                    <set_value name="$isExpired" exact="true"/>
                    <set_value name="$cleanedEntries" operation="add"/>
                  </do_if>
                  
                  <!-- Check if offers still exist -->
                  <do_if value="not $isExpired and $entry.$BuyOffer? and $entry.$SellOffer?">
                    <do_if value="$entry.$BuyOffer.exists and $entry.$SellOffer.exists">
                      <!-- Keep this entry - it's still valid -->
                      <append_to_list name="$cleanSectorCache" exact="$entry"/>
                    </do_if>
                    <do_else>
                      <!-- Offer no longer exists - count as cleaned -->
                      <set_value name="$cleanedEntries" operation="add"/>
                    </do_else>
                  </do_if>
                </do_all>
                
                <!-- Replace this home sector's cache with cleaned version -->
                <set_value name="global.$GT_TradeCache.{$homeSector}" exact="$cleanSectorCache"/>
                
                <!-- Remove home sector entry if cache is now empty -->
                <do_if value="$cleanSectorCache.count == 0">
                  <remove_value name="global.$GT_TradeCache.{$homeSector}"/>
                </do_if>
              </do_if>
            </do_if>
            <!-- If homeSector was null, skip this iteration -->
          </do_all>
          
          <do_if value="$cleanedEntries gt 0">
            <debug_text text="'[GalaxyTrader MK3] Trade cache cleanup: removed ' + $cleanedEntries + ' old/invalid entries'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Clean up stale trade reservations (older than 5 minutes) -->
        <do_if value="global.$GT_ActiveTradeReservations?">
          <set_value name="$shipsToRemove" exact="[]"/>
          <do_all exact="global.$GT_ActiveTradeReservations.keys.count" counter="$i">
            <set_value name="$ship" exact="global.$GT_ActiveTradeReservations.keys.{$i}"/>
            <set_value name="$reservation" exact="global.$GT_ActiveTradeReservations.{$ship}"/>
            <set_value name="$age" exact="player.age - $reservation.$Timestamp"/>
            
            <!-- Remove if older than 5 minutes or ship no longer exists -->
            <do_if value="$age gt 300s or not $ship.exists">
              <append_to_list name="$shipsToRemove" exact="$ship"/>
            </do_if>
          </do_all>
          
          <do_all exact="$shipsToRemove.count" counter="$i">
            <remove_value name="global.$GT_ActiveTradeReservations.{$shipsToRemove.{$i}}"/>
          </do_all>
          
          <do_if value="$shipsToRemove.count gt 0">
            <debug_text text="'[GT-FLEET] Cleaned up ' + $shipsToRemove.count + ' stale trade reservations'" chance="100"/>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Emergency Ship Recovery -->
    <cue name="ShipRecovery" instantiate="true" checkinterval="60s">
      <conditions>
        <check_value value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0"/>
      </conditions>
      <actions>
        <!-- Check for stuck ships -->
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
          <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
          <do_all exact="$shipKeys.count" counter="$i">
            <set_value name="$ship" exact="$shipKeys.{$i}"/>
          
            <do_if value="$ship.exists and $ship.isoperational">
              <!-- Check if ship has been idle too long -->
              <set_value name="$idleTime" exact="0s"/>
              <do_if value="global.$GT_Ships.{$ship}.$LastUpdate?">
                <set_value name="$idleTime" exact="player.age - global.$GT_Ships.{$ship}.$LastUpdate"/>
              </do_if>
              
              <do_if value="$idleTime gt 300s and not $ship.order">
                <!-- ✅ DEDUPLICATION FIX: Only add ship if not already in queue -->
                <!-- Check if ship already in queue using explicit loop (indexof unreliable for lists) -->
                <set_value name="$alreadyInQueue" exact="false"/>
                <do_if value="global.$GT_TradingQueue.$Ships?">
                  <do_all exact="global.$GT_TradingQueue.$Ships.count" counter="$i">
                    <do_if value="global.$GT_TradingQueue.$Ships.{$i} == $ship">
                      <set_value name="$alreadyInQueue" exact="true"/>
                      <break/>
                    </do_if>
                  </do_all>
                </do_if>
                
                <do_if value="not $alreadyInQueue">
                  <debug_text text="'[GalaxyTrader MK3] Recovering idle ship: ' + $ship.knownname" chance="100"/>
                  
                  <!-- Add back to queue -->
                  <append_to_list name="global.$GT_TradingQueue.$Ships" exact="$ship"/>
                  <signal_cue_instantly cue="md.GT_Trading_Queue.ProcessTradingQueue"/>
                </do_if>
                
                <!-- Update last activity -->
                <set_value name="global.$GT_Ships.{$ship}.$LastUpdate" exact="player.age"/>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
        
        <!-- Clean up stale search locks (older than 60 seconds) -->
        <do_if value="global.$GT_SearchLocks?">
          <set_value name="$staleLocks" exact="0"/>
          <set_value name="$lockKeys" exact="global.$GT_SearchLocks.keys.list"/>
          <do_all exact="$lockKeys.count" counter="$i">
            <set_value name="$ship" exact="$lockKeys.{$i}"/>
            <set_value name="$lockTime" exact="global.$GT_SearchLocks.{$ship}"/>
            <do_if value="(player.age - $lockTime) gt 60s">
              <remove_value name="global.$GT_SearchLocks.{$ship}"/>
              <set_value name="$staleLocks" operation="add"/>
            </do_if>
          </do_all>
          <do_if value="$staleLocks gt 0">
            <debug_text text="'[GalaxyTrader MK3] Cleaned up ' + $staleLocks + ' stale search locks'" chance="100"/>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
  </cues>
</mdscript>
