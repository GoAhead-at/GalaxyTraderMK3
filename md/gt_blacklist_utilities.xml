<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Blacklist_Utilities" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================= -->
    <!-- BLACKLIST UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Get Blacklist Group -->
    <library name="GT_GetBlacklistGroup" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to determine blacklist group for"/>
      </params>
      <actions>
        <set_value name="$blacklistgroup" exact="blacklistgroup.civilian"/>
        <do_if value="(@$ship.primarypurpose == purpose.fight) or (@$ship.primarypurpose == purpose.auxiliary)">
          <set_value name="$blacklistgroup" exact="blacklistgroup.military"/>
        </do_if>
        <return value="$blacklistgroup"/>
      </actions>
    </library>
    
    <!-- Is Sector Blacklisted -->
    <library name="GT_IsSectorBlacklisted" purpose="run_actions">
      <params>
        <param name="sector" comment="Sector to check"/>
        <param name="ship" comment="Ship for blacklist context"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group (will be auto-determined if null)"/>
        <param name="returnDetails" default="false" comment="If true, returns table with activity/travel flags"/>
      </params>
      <actions>
        <!-- Auto-determine blacklist group if not provided or null (memory:10529400 - ? checks existence, not null) -->
        <do_if value="not $blacklistgroup? or $blacklistgroup == null">
          <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
        </do_if>
        
        <set_value name="$activityBlacklisted" exact="@$sector.isblacklisted.{blacklisttype.sectoractivity}.{$blacklistgroup}.{$ship}"/>
        <set_value name="$travelBlacklisted" exact="@$sector.isblacklisted.{blacklisttype.sectortravel}.{$blacklistgroup}.{$ship}"/>
        <set_value name="$isBlacklisted" exact="$activityBlacklisted or $travelBlacklisted"/>
        
        <do_if value="$returnDetails">
          <set_value name="$result" exact="table[]"/>
          <set_value name="$result.$IsBlacklisted" exact="$isBlacklisted"/>
          <set_value name="$result.$ActivityBlacklisted" exact="$activityBlacklisted"/>
          <set_value name="$result.$TravelBlacklisted" exact="$travelBlacklisted"/>
          <return value="$result"/>
        </do_if>
        <do_else>
          <return value="$isBlacklisted"/>
        </do_else>
      </actions>
    </library>
    
    <!-- Is Station Blacklisted -->
    <library name="GT_IsStationBlacklisted" purpose="run_actions">
      <params>
        <param name="station" comment="Station to check"/>
        <param name="ship" comment="Ship for blacklist context"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group (auto-determined if null)"/>
      </params>
      <actions>
        <do_if value="not $blacklistgroup?">
          <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
        </do_if>
        <return value="@$station.isblacklisted.{blacklisttype.objectactivity}.{$blacklistgroup}.{$ship}"/>
      </actions>
    </library>
    
    <!-- Check Trade Blacklist -->
    <library name="GT_CheckTradeBlacklist" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship executing trade"/>
        <param name="buyStation" comment="Buy station"/>
        <param name="sellStation" comment="Sell station"/>
        <param name="currentSector" default="null" comment="Ship's current sector (for escape logic)"/>
        <param name="enableEscapeLogic" default="true" comment="Enable escape logic (block buying in blacklisted sectors)"/>
      </params>
      <actions>
        <!-- Initialize result -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IsBlacklisted" exact="false"/>
        <set_value name="$result.$Reason" exact="''"/>
        
        <!-- Get blacklist group -->
        <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <!-- Extract sectors -->
        <set_value name="$buySector" exact="@$buyStation.sector"/>
        <set_value name="$sellSector" exact="@$sellStation.sector"/>
        <set_value name="$currentSector" exact="if $currentSector? then $currentSector else $ship.sector"/>
        
        <!-- Check current sector for intra-sector trades -->
        <run_actions ref="md.GT_Trade_Utilities.GT_IsIntraSectorTrade" result="$isIntraSector">
          <param name="buySector" value="$buySector"/>
          <param name="sellSector" value="$sellSector"/>
          <param name="currentSector" value="$currentSector"/>
        </run_actions>
        
        <do_if value="$isIntraSector">
          <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$currentSectorBlacklisted">
            <param name="sector" value="$currentSector"/>
            <param name="ship" value="$ship"/>
            <param name="blacklistgroup" value="$blacklistgroup"/>
          </run_actions>
          <do_if value="$currentSectorBlacklisted">
            <set_value name="$result.$IsBlacklisted" exact="true"/>
            <set_value name="$result.$Reason" exact="'Intra-sector trade in blacklisted sector'"/>
            <return value="$result"/>
          </do_if>
        </do_if>
        
        <!-- Check stations -->
        <run_actions ref="md.GT_Blacklist_Utilities.GT_IsStationBlacklisted" result="$buyStationBlacklisted">
          <param name="station" value="$buyStation"/>
          <param name="ship" value="$ship"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
        </run_actions>
        <do_if value="$buyStationBlacklisted">
          <set_value name="$result.$IsBlacklisted" exact="true"/>
          <set_value name="$result.$Reason" exact="'Buy station blacklisted'"/>
          <return value="$result"/>
        </do_if>
        
        <run_actions ref="md.GT_Blacklist_Utilities.GT_IsStationBlacklisted" result="$sellStationBlacklisted">
          <param name="station" value="$sellStation"/>
          <param name="ship" value="$ship"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
        </run_actions>
        <do_if value="$sellStationBlacklisted">
          <set_value name="$result.$IsBlacklisted" exact="true"/>
          <set_value name="$result.$Reason" exact="'Sell station blacklisted'"/>
          <return value="$result"/>
        </do_if>
        
        <!-- Check sectors (with escape logic) -->
        <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$buySectorBlacklisted">
          <param name="sector" value="$buySector"/>
          <param name="ship" value="$ship"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
        </run_actions>
        <do_if value="$enableEscapeLogic and $buySectorBlacklisted">
          <!-- Escape logic: block buying in blacklisted sector -->
          <set_value name="$result.$IsBlacklisted" exact="true"/>
          <set_value name="$result.$Reason" exact="'Buy sector blacklisted (escape logic)'"/>
          <return value="$result"/>
        </do_if>
        
        <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$sellSectorBlacklisted">
          <param name="sector" value="$sellSector"/>
          <param name="ship" value="$ship"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
        </run_actions>
        <do_if value="$enableEscapeLogic and $sellSectorBlacklisted and $sellSector != $currentSector">
          <!-- Escape logic: block selling to blacklisted sector (unless already there) -->
          <set_value name="$result.$IsBlacklisted" exact="true"/>
          <set_value name="$result.$Reason" exact="'Sell sector blacklisted (escape logic)'"/>
          <return value="$result"/>
        </do_if>
        
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Check if Ship Needs Escape (is in blacklisted sector) -->
    <library name="GT_CheckNeedsEscape" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to check"/>
      </params>
      <actions>
        <set_value name="$needsEscape" exact="false"/>
        <set_value name="$currentSector" exact="$ship.sector"/>
        <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
          <param name="ship" value="$ship"/>
        </run_actions>
        <do_if value="$blacklistgroup? and $currentSector?">
          <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$needsEscape">
            <param name="sector" value="$currentSector"/>
            <param name="ship" value="$ship"/>
            <param name="blacklistgroup" value="$blacklistgroup"/>
          </run_actions>
        </do_if>
        <return value="$needsEscape"/>
      </actions>
    </library>
    
    <!-- Check Connected Sectors Blacklist Status -->
    <!-- Returns information about connected sectors and whether the sector is isolated -->
    <library name="GT_CheckConnectedSectorsBlacklisted" purpose="run_actions">
      <params>
        <param name="sector" comment="Sector to check connected sectors from"/>
        <param name="ship" comment="Ship for blacklist context and reference object"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group (auto-determined if null)"/>
        <param name="returnDetails" default="false" comment="If true, returns detailed table with sector lists"/>
      </params>
      <actions>
        <!-- Initialize result -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IsIsolated" exact="false"/>
        <set_value name="$result.$ConnectedSectorsCount" exact="0"/>
        <set_value name="$result.$BlacklistedSectorsCount" exact="0"/>
        <set_value name="$result.$NonBlacklistedSectorsCount" exact="0"/>
        
        <!-- Auto-determine blacklist group if not provided -->
        <do_if value="not $blacklistgroup? or $blacklistgroup == null">
          <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
        </do_if>
        
        <!-- Validate inputs -->
        <do_if value="not $sector? or not $ship? or not $blacklistgroup?">
          <return value="$result"/>
        </do_if>
        
        <!-- Find all sectors directly connected via gates and accelerators -->
        <!-- Use find_gate to enumerate all gates and accelerators in the target sector -->
        <set_value name="$validConnectedSectors" exact="[]"/>
        <set_value name="$blacklistedSectors" exact="[]"/>
        <set_value name="$nonBlacklistedSectors" exact="[]"/>
        <set_value name="$foundSectors" exact="table[]"/>
        
        <!-- Find all gates in the target sector -->
        <find_gate name="$gates" multiple="true" space="$sector"/>
        <set_value name="$gatesExist" exact="if $gates? then 'YES' else 'NO'"/>
        <set_value name="$gateCount" exact="if $gates? then $gates.count else 0"/>
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <set_value name="$sectorName" exact="@$sector.knownname"/>
          <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ') ðŸ” ISOLATION CHECK: Gates exist=' + $gatesExist + ', Found ' + $gateCount + ' gates in sector ' + $sectorName" chance="100"/>
        </do_if>
        <do_for_each name="$gate" in="$gates">
          <!-- âœ… DEBUG: Log each gate found (even if exit is invalid) -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$gateExit" exact="@$gate.exit"/>
            <set_value name="$gateExitSector" exact="@$gate.exit.sector"/>
            <set_value name="$hasExit" exact="if $gateExit? then 'YES' else 'NO'"/>
            <set_value name="$exitSectorName" exact="if $gateExitSector? then @$gateExitSector.knownname else 'NULL'"/>
            <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   GATE found: exit=' + $hasExit + ', exit.sector=' + $exitSectorName" chance="100"/>
          </do_if>
          <set_value name="$connectedSector" exact="@$gate.exit.sector"/>
          <!-- âœ… FIX: Check that connectedSector exists AND is not null before using as table key -->
          <!-- The ? operator checks existence, not null - a variable can exist but be null -->
          <!-- We need to verify the sector is valid before using it as a table key -->
          <do_if value="$connectedSector? and $connectedSector != null and $connectedSector != $sector">
            <!-- Gate connects to a different sector - check if we've already seen this sector -->
            <do_if value="not $foundSectors.{$connectedSector}?">
              <set_value name="$foundSectors.{$connectedSector}" exact="true"/>
              <!-- Check blacklist status -->
              <set_value name="$isBlacklisted" exact="false"/>
              <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$isBlacklisted">
                <param name="sector" value="$connectedSector"/>
                <param name="ship" value="$ship"/>
                <param name="blacklistgroup" value="$blacklistgroup"/>
              </run_actions>
              
              <!-- âœ… DEBUG: Log each connected sector -->
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <set_value name="$connectedSectorName" exact="@$connectedSector.knownname"/>
                <set_value name="$blacklistStatus" exact="if $isBlacklisted then 'BLACKLISTED' else 'OK'"/>
                <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   GATE â†’ ' + $connectedSectorName + ' (' + $blacklistStatus + ')'" chance="100"/>
              </do_if>
              
              <!-- Add to appropriate list -->
              <append_to_list name="$validConnectedSectors" exact="$connectedSector"/>
              <do_if value="$isBlacklisted">
                <append_to_list name="$blacklistedSectors" exact="$connectedSector"/>
                <set_value name="$result.$BlacklistedSectorsCount" exact="$result.$BlacklistedSectorsCount + 1"/>
              </do_if>
              <do_else>
                <append_to_list name="$nonBlacklistedSectors" exact="$connectedSector"/>
                <set_value name="$result.$NonBlacklistedSectorsCount" exact="$result.$NonBlacklistedSectorsCount + 1"/>
              </do_else>
            </do_if>
          </do_if>
        </do_for_each>
        
        <!-- Find all accelerators in the target sector -->
        <!-- Note: Accelerators are bidirectional, so we need to check both:
             1. Accelerators IN this sector (pointing out)
             2. Accelerators pointing TO this sector (from other sectors)
        -->
        <find_gate name="$accelerators" multiple="true" space="$sector" accelerator="true"/>
        <set_value name="$acceleratorsExist" exact="if $accelerators? then 'YES' else 'NO'"/>
        <set_value name="$acceleratorCount" exact="if $accelerators? then $accelerators.count else 0"/>
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ') ðŸ” ISOLATION CHECK: Accelerators exist=' + $acceleratorsExist + ', Found ' + $acceleratorCount + ' accelerators IN sector ' + $sectorName" chance="100"/>
        </do_if>
        <do_for_each name="$accelerator" in="$accelerators">
          <!-- âœ… DEBUG: Log each accelerator found (even if exit is invalid) -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$acceleratorExit" exact="@$accelerator.exit"/>
            <set_value name="$acceleratorExitSector" exact="@$accelerator.exit.sector"/>
            <set_value name="$hasExit" exact="if $acceleratorExit? then 'YES' else 'NO'"/>
            <set_value name="$exitSectorName" exact="if $acceleratorExitSector? then @$acceleratorExitSector.knownname else 'NULL'"/>
            <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   ACCELERATOR found: exit=' + $hasExit + ', exit.sector=' + $exitSectorName" chance="100"/>
          </do_if>
          <set_value name="$connectedSector" exact="@$accelerator.exit.sector"/>
          <!-- âœ… FIX: Check that connectedSector exists AND is not null before using as table key -->
          <do_if value="$connectedSector? and $connectedSector != null and $connectedSector != $sector">
            <!-- Accelerator connects to a different sector - check if we've already seen this sector -->
            <do_if value="not $foundSectors.{$connectedSector}?">
              <set_value name="$foundSectors.{$connectedSector}" exact="true"/>
              <!-- Check blacklist status -->
              <set_value name="$isBlacklisted" exact="false"/>
              <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$isBlacklisted">
                <param name="sector" value="$connectedSector"/>
                <param name="ship" value="$ship"/>
                <param name="blacklistgroup" value="$blacklistgroup"/>
              </run_actions>
              
              <!-- âœ… DEBUG: Log each connected sector -->
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <set_value name="$connectedSectorName" exact="@$connectedSector.knownname"/>
                <set_value name="$blacklistStatus" exact="if $isBlacklisted then 'BLACKLISTED' else 'OK'"/>
                <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   ACCELERATOR â†’ ' + $connectedSectorName + ' (' + $blacklistStatus + ')'" chance="100"/>
              </do_if>
              
              <!-- Add to appropriate list -->
              <append_to_list name="$validConnectedSectors" exact="$connectedSector"/>
              <do_if value="$isBlacklisted">
                <append_to_list name="$blacklistedSectors" exact="$connectedSector"/>
                <set_value name="$result.$BlacklistedSectorsCount" exact="$result.$BlacklistedSectorsCount + 1"/>
              </do_if>
              <do_else>
                <append_to_list name="$nonBlacklistedSectors" exact="$connectedSector"/>
                <set_value name="$result.$NonBlacklistedSectorsCount" exact="$result.$NonBlacklistedSectorsCount + 1"/>
              </do_else>
            </do_if>
          </do_if>
        </do_for_each>
        
        <!-- âœ… FALLBACK: Also search for accelerators pointing TO this sector (bidirectional check) -->
        <!-- Accelerators are bidirectional but may be defined from either direction -->
        <!-- Search in player.galaxy for all accelerators, then filter by exit.sector == our sector -->
        <!-- This catches accelerators defined from the opposite direction -->
        <do_if value="$acceleratorCount == 0">
          <!-- No accelerators found IN this sector - search for accelerators pointing TO this sector -->
          <find_gate name="$allAccelerators" multiple="true" space="player.galaxy" accelerator="true"/>
          <set_value name="$allAcceleratorCount" exact="if $allAccelerators? then $allAccelerators.count else 0"/>
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ') ðŸ” FALLBACK: Searching ' + $allAcceleratorCount + ' accelerators in galaxy for ones pointing TO sector ' + $sectorName" chance="100"/>
          </do_if>
          <do_for_each name="$accelerator" in="$allAccelerators">
            <set_value name="$acceleratorExitSector" exact="@$accelerator.exit.sector"/>
            <set_value name="$acceleratorSector" exact="@$accelerator.sector"/>
            <!-- Check if this accelerator points TO our sector -->
            <do_if value="$acceleratorExitSector? and $acceleratorExitSector == $sector">
              <!-- This accelerator points TO our sector - get the source sector (where accelerator is located) -->
              <set_value name="$sourceSector" exact="@$accelerator.sector"/>
              <do_if value="$sourceSector? and $sourceSector != $sector">
                <!-- Source sector is different from our sector - check if we've already seen this sector -->
                <do_if value="not $foundSectors.{$sourceSector}?">
                  <set_value name="$foundSectors.{$sourceSector}" exact="true"/>
                  <!-- Check blacklist status of source sector -->
                  <set_value name="$isBlacklisted" exact="false"/>
                  <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$isBlacklisted">
                    <param name="sector" value="$sourceSector"/>
                    <param name="ship" value="$ship"/>
                    <param name="blacklistgroup" value="$blacklistgroup"/>
                  </run_actions>
                  
                  <!-- âœ… DEBUG: Log accelerator found from opposite direction -->
                  <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <set_value name="$sourceSectorName" exact="@$sourceSector.knownname"/>
                    <set_value name="$blacklistStatus" exact="if $isBlacklisted then 'BLACKLISTED' else 'OK'"/>
                    <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   ACCELERATOR (FROM OPPOSITE): ' + $sourceSectorName + ' â†’ ' + $sectorName + ' (' + $blacklistStatus + ')'" chance="100"/>
                  </do_if>
                  
                  <!-- Add to appropriate list -->
                  <append_to_list name="$validConnectedSectors" exact="$sourceSector"/>
                  <do_if value="$isBlacklisted">
                    <append_to_list name="$blacklistedSectors" exact="$sourceSector"/>
                    <set_value name="$result.$BlacklistedSectorsCount" exact="$result.$BlacklistedSectorsCount + 1"/>
                  </do_if>
                  <do_else>
                    <append_to_list name="$nonBlacklistedSectors" exact="$sourceSector"/>
                    <set_value name="$result.$NonBlacklistedSectorsCount" exact="$result.$NonBlacklistedSectorsCount + 1"/>
                  </do_else>
                </do_if>
              </do_if>
            </do_if>
          </do_for_each>
        </do_if>
        
        <!-- Find all highway entry gates in the target sector -->
        <!-- Highway entry gates connect sectors via highways (super highways) -->
        <!-- They use "destination" property instead of "exit" -->
        <find_object name="$highwayEntries" class="class.highwayentrygate" space="$sector" multiple="true"/>
        <set_value name="$highwayEntriesExist" exact="if $highwayEntries? then 'YES' else 'NO'"/>
        <set_value name="$highwayEntryCount" exact="if $highwayEntries? then $highwayEntries.count else 0"/>
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ') ðŸ” ISOLATION CHECK: Highway entries exist=' + $highwayEntriesExist + ', Found ' + $highwayEntryCount + ' highway entries IN sector ' + $sectorName" chance="100"/>
        </do_if>
        <do_for_each name="$highwayEntry" in="$highwayEntries">
          <!-- âœ… DEBUG: Log each highway entry found (even if destination is invalid) -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$hwDestination" exact="@$highwayEntry.destination"/>
            <set_value name="$hwDestinationSector" exact="@$highwayEntry.destination.sector"/>
            <set_value name="$hasDestination" exact="if $hwDestination? then 'YES' else 'NO'"/>
            <set_value name="$destinationSectorName" exact="if $hwDestinationSector? then @$hwDestinationSector.knownname else 'NULL'"/>
            <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   HIGHWAY ENTRY found: destination=' + $hasDestination + ', destination.sector=' + $destinationSectorName" chance="100"/>
          </do_if>
          <set_value name="$connectedSector" exact="@$highwayEntry.destination.sector"/>
          <!-- âœ… FIX: Check that connectedSector exists AND is not null before using as table key -->
          <do_if value="$connectedSector? and $connectedSector != null and $connectedSector != $sector">
            <!-- Highway entry connects to a different sector - check if we've already seen this sector -->
            <do_if value="not $foundSectors.{$connectedSector}?">
              <set_value name="$foundSectors.{$connectedSector}" exact="true"/>
              <!-- Check blacklist status -->
              <set_value name="$isBlacklisted" exact="false"/>
              <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$isBlacklisted">
                <param name="sector" value="$connectedSector"/>
                <param name="ship" value="$ship"/>
                <param name="blacklistgroup" value="$blacklistgroup"/>
              </run_actions>
              
              <!-- âœ… DEBUG: Log each connected sector -->
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <set_value name="$connectedSectorName" exact="@$connectedSector.knownname"/>
                <set_value name="$blacklistStatus" exact="if $isBlacklisted then 'BLACKLISTED' else 'OK'"/>
                <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   HIGHWAY â†’ ' + $connectedSectorName + ' (' + $blacklistStatus + ')'" chance="100"/>
              </do_if>
              
              <!-- Add to appropriate list -->
              <append_to_list name="$validConnectedSectors" exact="$connectedSector"/>
              <do_if value="$isBlacklisted">
                <append_to_list name="$blacklistedSectors" exact="$connectedSector"/>
                <set_value name="$result.$BlacklistedSectorsCount" exact="$result.$BlacklistedSectorsCount + 1"/>
              </do_if>
              <do_else>
                <append_to_list name="$nonBlacklistedSectors" exact="$connectedSector"/>
                <set_value name="$result.$NonBlacklistedSectorsCount" exact="$result.$NonBlacklistedSectorsCount + 1"/>
              </do_else>
            </do_if>
          </do_if>
        </do_for_each>
        
        <!-- âœ… FALLBACK: Also search for highway entries pointing TO this sector (bidirectional check) -->
        <!-- Highways are bidirectional, so we need to check both directions -->
        <do_if value="$highwayEntryCount == 0">
          <!-- No highway entries found IN this sector - search for highway entries pointing TO this sector -->
          <find_object name="$allHighwayEntries" class="class.highwayentrygate" space="player.galaxy" multiple="true"/>
          <set_value name="$allHighwayEntryCount" exact="if $allHighwayEntries? then $allHighwayEntries.count else 0"/>
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ') ðŸ” FALLBACK: Searching ' + $allHighwayEntryCount + ' highway entries in galaxy for ones pointing TO sector ' + $sectorName" chance="100"/>
          </do_if>
          <do_for_each name="$highwayEntry" in="$allHighwayEntries">
            <set_value name="$hwDestinationSector" exact="@$highwayEntry.destination.sector"/>
            <set_value name="$hwSourceSector" exact="@$highwayEntry.sector"/>
            <!-- Check if this highway entry points TO our sector -->
            <do_if value="$hwDestinationSector? and $hwDestinationSector == $sector">
              <!-- This highway entry points TO our sector - get the source sector (where highway entry is located) -->
              <set_value name="$sourceSector" exact="@$highwayEntry.sector"/>
              <do_if value="$sourceSector? and $sourceSector != $sector">
                <!-- Source sector is different from our sector - check if we've already seen this sector -->
                <do_if value="not $foundSectors.{$sourceSector}?">
                  <set_value name="$foundSectors.{$sourceSector}" exact="true"/>
                  <!-- Check blacklist status of source sector -->
                  <set_value name="$isBlacklisted" exact="false"/>
                  <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$isBlacklisted">
                    <param name="sector" value="$sourceSector"/>
                    <param name="ship" value="$ship"/>
                    <param name="blacklistgroup" value="$blacklistgroup"/>
                  </run_actions>
                  
                  <!-- âœ… DEBUG: Log highway entry found from opposite direction -->
                  <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <set_value name="$sourceSectorName" exact="@$sourceSector.knownname"/>
                    <set_value name="$blacklistStatus" exact="if $isBlacklisted then 'BLACKLISTED' else 'OK'"/>
                    <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   HIGHWAY (FROM OPPOSITE): ' + $sourceSectorName + ' â†’ ' + $sectorName + ' (' + $blacklistStatus + ')'" chance="100"/>
                  </do_if>
                  
                  <!-- Add to appropriate list -->
                  <append_to_list name="$validConnectedSectors" exact="$sourceSector"/>
                  <do_if value="$isBlacklisted">
                    <append_to_list name="$blacklistedSectors" exact="$sourceSector"/>
                    <set_value name="$result.$BlacklistedSectorsCount" exact="$result.$BlacklistedSectorsCount + 1"/>
                  </do_if>
                  <do_else>
                    <append_to_list name="$nonBlacklistedSectors" exact="$sourceSector"/>
                    <set_value name="$result.$NonBlacklistedSectorsCount" exact="$result.$NonBlacklistedSectorsCount + 1"/>
                  </do_else>
                </do_if>
              </do_if>
            </do_if>
          </do_for_each>
        </do_if>
        
        <!-- Update result counts -->
        <set_value name="$result.$ConnectedSectorsCount" exact="$validConnectedSectors.count"/>
        
        <!-- Sector is isolated if it has connected sectors AND all of them are blacklisted -->
        <do_if value="$validConnectedSectors.count gt 0">
          <set_value name="$result.$IsIsolated" exact="$result.$NonBlacklistedSectorsCount == 0"/>
        </do_if>
        <do_else>
          <!-- No connected sectors found - might be a dead-end or single-sector zone -->
          <!-- Consider it NOT isolated (can't be isolated if there's nothing to isolate from) -->
          <set_value name="$result.$IsIsolated" exact="false"/>
        </do_else>
        
        <!-- Return detailed information if requested -->
        <do_if value="$returnDetails">
          <set_value name="$result.$ConnectedSectors" exact="$validConnectedSectors"/>
          <set_value name="$result.$BlacklistedSectors" exact="$blacklistedSectors"/>
          <set_value name="$result.$NonBlacklistedSectors" exact="$nonBlacklistedSectors"/>
        </do_if>
        
        <!-- âœ… DEBUG: Log final isolation check summary -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <set_value name="$finalStatus" exact="if $result.$IsIsolated then 'ðŸš¨ ISOLATED' else 'âœ… NOT ISOLATED'"/>
          <set_value name="$sectorName" exact="@$sector.knownname"/>
          <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ') ' + $finalStatus + ': ' + $result.$ConnectedSectorsCount + ' connected sectors (' + $result.$BlacklistedSectorsCount + ' blacklisted, ' + $result.$NonBlacklistedSectorsCount + ' OK) in ' + $sectorName" chance="100"/>
        </do_if>
        
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Check And Handle Isolation -->
    <!-- âœ… REFACTORED: Extracted from gt_trading_batch_processor.xml for reusability and maintainability -->
    <!-- This function checks if a ship is isolated, manages state, handles logging, and writes logbook messages -->
    <library name="GT_CheckAndHandleIsolation" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to check isolation for"/>
        <param name="state" comment="Batch state table (will be updated and returned)"/>
      </params>
      <actions>
        <set_value name="$shipIsIsolated" exact="false"/>
        
        <!-- âœ… VALIDATION: Ensure state is valid (save game compatibility) -->
        <!-- If state is null or invalid, initialize as empty table -->
        <!-- âœ… CRITICAL FIX: Always initialize $updatedState to prevent null property access errors -->
        <set_value name="$updatedState" exact="table[]"/>
        <set_value name="$stateValid" exact="false"/>
        <do_if value="$state?">
          <!-- State variable exists - check if it's actually a valid table (not null) -->
          <!-- âœ… CRITICAL: Try to access .keys property - if state is null, this will fail safely with @ operator -->
          <set_value name="$stateKeysTest" exact="@$state.keys"/>
          <!-- âœ… CRITICAL: Check if keys test returned a valid list (not null) -->
          <!-- In X4, if $state is null, @$state.keys returns null, and null? returns true (variable exists) -->
          <!-- So we need to check if the result is actually a valid list by trying to access .count -->
          <set_value name="$stateKeysCountTest" exact="@$stateKeysTest.count"/>
          <!-- âœ… CRITICAL: Only valid if count test succeeded AND returned a number >= 0 -->
          <!-- If $stateKeysTest was null, then $stateKeysCountTest will be null, and null ge 0 is false -->
          <do_if value="$stateKeysCountTest? and $stateKeysCountTest ge 0">
            <!-- State is valid table - safe to use -->
            <set_value name="$stateValid" exact="true"/>
          </do_if>
        </do_if>
        <do_if value="$stateValid">
          <!-- State is valid - use it instead of empty table -->
          <!-- âœ… CRITICAL: Final safety check - ensure state is still valid before overwriting -->
          <set_value name="$stateFinalKeysCheck" exact="@$state.keys"/>
          <set_value name="$stateFinalCountCheck" exact="@$stateFinalKeysCheck.count"/>
          <do_if value="$stateFinalCountCheck? and $stateFinalCountCheck ge 0">
            <set_value name="$updatedState" exact="$state"/>
          </do_if>
        </do_if>
        <!-- If not valid, $updatedState already initialized to table[] above -->
        
        <!-- âœ… CRITICAL SAFETY CHECK: Ensure $updatedState is never null before using it -->
        <!-- This must happen BEFORE any property access on $updatedState -->
        <!-- âœ… CRITICAL: Direct validation - check if $updatedState is a valid table -->
        <set_value name="$updatedStateIsValid" exact="false"/>
        <do_if value="$updatedState?">
          <!-- $updatedState variable exists - verify it's actually a valid table (not null) -->
          <!-- Try accessing .keys property - if $updatedState is null, @ operator returns null safely -->
          <set_value name="$updatedStateKeysTest" exact="@$updatedState.keys"/>
          <!-- If $updatedState is null, $updatedStateKeysTest will be null -->
          <!-- Check if we got a valid list back (not null) by trying to access .count -->
          <set_value name="$updatedStateCountTest" exact="@$updatedStateKeysTest.count"/>
          <!-- âœ… CRITICAL: Check if count is actually a number (not null) -->
          <!-- If $updatedStateCountTest is null, we can't compare it, so check if it exists AND is >= 0 -->
          <do_if value="$updatedStateCountTest?">
            <!-- Count variable exists - verify it's actually a number by checking it's >= 0 -->
            <!-- If count is null, the comparison will fail or be false -->
            <do_if value="$updatedStateCountTest ge 0">
              <!-- Comparison succeeded - count is >= 0, so it's a valid number and $updatedState is valid table -->
              <set_value name="$updatedStateIsValid" exact="true"/>
            </do_if>
          </do_if>
        </do_if>
        <do_if value="not $updatedStateIsValid">
          <!-- $updatedState is null or invalid - reinitialize to empty table -->
          <set_value name="$updatedState" exact="table[]"/>
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Blacklist] âš ï¸ $updatedState was null/invalid - reinitialized to empty table (countTest: ' + $updatedStateCountTest + ')'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- âœ… FINAL SAFETY CHECK: Ensure $updatedState is still valid before property access -->
        <!-- Double-check that $updatedState hasn't become null somehow -->
        <set_value name="$updatedStateFinalKeysCheck" exact="@$updatedState.keys"/>
        <set_value name="$updatedStateFinalCountCheck" exact="@$updatedStateFinalKeysCheck.count"/>
        <do_if value="not $updatedStateFinalCountCheck? or $updatedStateFinalCountCheck lt 0">
          <!-- $updatedState became invalid - reinitialize to empty table -->
          <set_value name="$updatedState" exact="table[]"/>
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Blacklist] âš ï¸ $updatedState became invalid after validation - reinitialized to empty table'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Check if isolation has already been checked for this ship -->
        <!-- âœ… CRITICAL: Use safe operator @ for property access to prevent null errors -->
        <set_value name="$isolationAlreadyChecked" exact="@$updatedState.$shipIsIsolatedChecked"/>
        <do_if value="not $isolationAlreadyChecked?">
          <!-- First time checking isolation for this ship -->
          <set_value name="$currentSector" exact="$ship.sector"/>
          <do_if value="$currentSector?">
            <!-- Check if current sector is blacklisted (if yes, not isolated, it's just blacklisted) -->
            <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
              <param name="ship" value="$ship"/>
            </run_actions>
            <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$currentSectorIsBlacklisted">
              <param name="sector" value="$currentSector"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="not $currentSectorIsBlacklisted">
              <!-- Ship is in non-blacklisted sector - check if all routes are blocked -->
              <run_actions ref="md.GT_Blacklist_Utilities.GT_CheckConnectedSectorsBlacklisted" result="$isolationCheck">
                <param name="sector" value="$currentSector"/>
                <param name="ship" value="$ship"/>
                <param name="returnDetails" value="false"/>
              </run_actions>
              <set_value name="$isolatedValue" exact="@$isolationCheck.$IsIsolated"/>
              <set_value name="$shipIsIsolated" exact="if $isolatedValue? and ($isolatedValue == true or $isolatedValue == 1) then true else false"/>
              <!-- âœ… CRITICAL: Final safety check before setting properties -->
              <!-- Ensure $updatedState is still valid (not null) before setting properties -->
              <set_value name="$updatedStatePreSetCheck" exact="@$updatedState.keys"/>
              <do_if value="$updatedStatePreSetCheck?">
                <!-- $updatedState is valid - safe to set properties -->
                <set_value name="$updatedState.$shipIsIsolated" exact="if $shipIsIsolated then 1 else 0"/>
                <set_value name="$updatedState.$shipIsIsolatedChecked" exact="1"/>
              </do_if>
              <do_else>
                <!-- $updatedState is null - reinitialize and set properties -->
                <set_value name="$updatedState" exact="table[]"/>
                <set_value name="$updatedState.$shipIsIsolated" exact="if $shipIsIsolated then 1 else 0"/>
                <set_value name="$updatedState.$shipIsIsolatedChecked" exact="1"/>
                <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                  <debug_text text="'[GT-Blacklist] âš ï¸ $updatedState was null before setting isolation properties - reinitialized'" chance="100"/>
                </do_if>
              </do_else>
              
              <!-- Log isolation status -->
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <set_value name="$connectedCount" exact="@$isolationCheck.$ConnectedSectorsCount"/>
                <set_value name="$blacklistedCount" exact="@$isolationCheck.$BlacklistedSectorsCount"/>
                <set_value name="$nonBlacklistedCount" exact="@$isolationCheck.$NonBlacklistedSectorsCount"/>
                <set_value name="$currentSectorName" exact="@$currentSector.knownname"/>
                <do_if value="$shipIsIsolated">
                  <debug_text text="'[GT-Batch] (' + $ship.idcode + ') ðŸš¨ ISOLATED: All ' + $connectedCount + ' connected sectors are blacklisted (ship in ' + $currentSectorName + ')'" chance="100"/>
                </do_if>
                <do_else>
                  <debug_text text="'[GT-Batch] (' + $ship.idcode + ') âœ… NOT ISOLATED: ' + $nonBlacklistedCount + ' of ' + $connectedCount + ' connected sectors are non-blacklisted (ship in ' + $currentSectorName + ')'" chance="100"/>
                </do_else>
              </do_if>
              
              <!-- Log isolation message if isolated -->
              <do_if value="$shipIsIsolated">
                <set_value name="$isolationAlreadyLogged" exact="false"/>
                <do_if value="global.$GT_Ships? and global.$GT_Ships.{$ship}? and global.$GT_Ships.{$ship}.$IsolationLogged?">
                  <set_value name="$isolationAlreadyLogged" exact="global.$GT_Ships.{$ship}.$IsolationLogged"/>
                </do_if>
                <do_if value="not $isolationAlreadyLogged">
                  <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_Ships exists -->
                  <do_if value="not global.$GT_Ships.{$ship}?">
                    <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
                  </do_if>
                  <set_value name="global.$GT_Ships.{$ship}.$IsolationLogged" exact="true"/>
                  <set_value name="$currentSectorName" exact="@$currentSector.knownname"/>
                  <do_if value="not $currentSectorName?">
                    <set_value name="$currentSectorName" exact="'Unknown Sector'"/>
                  </do_if>
                  <set_value name="$shipName" exact="@$ship.knownname"/>
                  <do_if value="not $shipName?">
                    <set_value name="$shipName" exact="$ship.idcode"/>
                  </do_if>
                  <debug_text text="'[GT-Batch] (' + $ship.idcode + ') ðŸš¨ ISOLATION DETECTED: Ship in ' + $currentSectorName + ' (non-blacklisted) but ALL routes to other sectors blocked by blacklist - prioritizing intra-sector trades'" chance="100"/>
                  <set_value name="$logbookEnabled" exact="true"/>
                  <do_if value="global.$GT_Ships.{$ship}.$LogbookEntries?">
                    <set_value name="$logbookEnabled" exact="global.$GT_Ships.{$ship}.$LogbookEntries"/>
                  </do_if>
                  <do_if value="$logbookEnabled">
                    <!-- Construct logbook message using TextDB syntax (vanilla pattern) -->
                    <set_value name="$logbookMessage" exact="{77000,3211}.[$shipName, $currentSectorName]"/>
                    
                    <run_actions ref="md.GT_Logbook_Utilities.WriteLogbookMessage">
                      <param name="Message" value="$logbookMessage"/>
                      <param name="Category" value="'general'"/>
                      <param name="Title" value="'Isolated Trading: ' + $shipName"/>
                      <param name="Object" value="$ship"/>
                      <param name="Interaction" value="'showonmap'"/>
                      <param name="CheckGlobalSettings" value="false"/>
                    </run_actions>
                    <debug_text text="'[GT-Batch] (' + $ship.idcode + ') ðŸ“ ISOLATION LOGBOOK MESSAGE WRITTEN: Ship ' + $shipName + ' in sector ' + $currentSectorName + ' - forced to intra-sector trades only due to blacklisted hub sectors'" chance="100"/>
                  </do_if>
                </do_if>
              </do_if>
            </do_if>
            <do_else>
              <!-- Current sector is blacklisted - ship is not isolated, it's just in a blacklisted sector -->
              <set_value name="$shipIsIsolated" exact="false"/>
              <!-- âœ… CRITICAL: Final safety check before setting properties -->
              <set_value name="$updatedStatePreSetCheck2" exact="@$updatedState.keys"/>
              <do_if value="$updatedStatePreSetCheck2?">
                <!-- $updatedState is valid - safe to set properties -->
                <set_value name="$updatedState.$shipIsIsolated" exact="0"/>
                <set_value name="$updatedState.$shipIsIsolatedChecked" exact="1"/>
              </do_if>
              <do_else>
                <!-- $updatedState is null - reinitialize and set properties -->
                <set_value name="$updatedState" exact="table[]"/>
                <set_value name="$updatedState.$shipIsIsolated" exact="0"/>
                <set_value name="$updatedState.$shipIsIsolatedChecked" exact="1"/>
                <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                  <debug_text text="'[GT-Blacklist] âš ï¸ $updatedState was null before setting isolation properties (blacklisted sector) - reinitialized'" chance="100"/>
                </do_if>
              </do_else>
            </do_else>
          </do_if>
        </do_if>
        <do_else>
          <!-- Isolation already checked - retrieve from state -->
          <set_value name="$isolatedStateValue" exact="@$updatedState.$shipIsIsolated"/>
          <set_value name="$shipIsIsolated" exact="if $isolatedStateValue? and ($isolatedStateValue == 1 or $isolatedStateValue == true) then true else false"/>
        </do_else>
        
        <!-- Return result table -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IsIsolated" exact="$shipIsIsolated"/>
        <set_value name="$result.$UpdatedState" exact="$updatedState"/>
        <return value="$result"/>
      </actions>
    </library>
    
  </cues>
</mdscript>
