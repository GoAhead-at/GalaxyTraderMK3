<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Blacklist_Utilities" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================= -->
    <!-- BLACKLIST UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Get Blacklist Group -->
    <library name="GT_GetBlacklistGroup" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to determine blacklist group for"/>
      </params>
      <actions>
        <set_value name="$blacklistgroup" exact="blacklistgroup.civilian"/>
        <do_if value="(@$ship.primarypurpose == purpose.fight) or (@$ship.primarypurpose == purpose.auxiliary)">
          <set_value name="$blacklistgroup" exact="blacklistgroup.military"/>
        </do_if>
        <return value="$blacklistgroup"/>
      </actions>
    </library>
    
    <!-- Is Sector Blacklisted -->
    <library name="GT_IsSectorBlacklisted" purpose="run_actions">
      <params>
        <param name="sector" comment="Sector to check"/>
        <param name="ship" comment="Ship for blacklist context"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group (will be auto-determined if null)"/>
        <param name="returnDetails" default="false" comment="If true, returns table with activity/travel flags"/>
      </params>
      <actions>
        <!-- Auto-determine blacklist group if not provided or null (memory:10529400 - ? checks existence, not null) -->
        <do_if value="not $blacklistgroup? or $blacklistgroup == null">
          <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
        </do_if>
        
        <set_value name="$activityBlacklisted" exact="@$sector.isblacklisted.{blacklisttype.sectoractivity}.{$blacklistgroup}.{$ship}"/>
        <set_value name="$travelBlacklisted" exact="@$sector.isblacklisted.{blacklisttype.sectortravel}.{$blacklistgroup}.{$ship}"/>
        <set_value name="$isBlacklisted" exact="$activityBlacklisted or $travelBlacklisted"/>
        
        <do_if value="$returnDetails">
          <set_value name="$result" exact="table[]"/>
          <set_value name="$result.$IsBlacklisted" exact="$isBlacklisted"/>
          <set_value name="$result.$ActivityBlacklisted" exact="$activityBlacklisted"/>
          <set_value name="$result.$TravelBlacklisted" exact="$travelBlacklisted"/>
          <return value="$result"/>
        </do_if>
        <do_else>
          <return value="$isBlacklisted"/>
        </do_else>
      </actions>
    </library>
    
    <!-- Is Station Blacklisted -->
    <library name="GT_IsStationBlacklisted" purpose="run_actions">
      <params>
        <param name="station" comment="Station to check"/>
        <param name="ship" comment="Ship for blacklist context"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group (auto-determined if null)"/>
      </params>
      <actions>
        <do_if value="not $blacklistgroup?">
          <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
        </do_if>
        <return value="@$station.isblacklisted.{blacklisttype.objectactivity}.{$blacklistgroup}.{$ship}"/>
      </actions>
    </library>
    
    <!-- Check Trade Blacklist -->
    <library name="GT_CheckTradeBlacklist" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship executing trade"/>
        <param name="buyStation" comment="Buy station"/>
        <param name="sellStation" comment="Sell station"/>
        <param name="currentSector" default="null" comment="Ship's current sector (for escape logic)"/>
        <param name="enableEscapeLogic" default="true" comment="Enable escape logic (block buying in blacklisted sectors)"/>
      </params>
      <actions>
        <!-- Initialize result -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IsBlacklisted" exact="false"/>
        <set_value name="$result.$Reason" exact="''"/>
        
        <!-- Get blacklist group -->
        <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <!-- Extract sectors -->
        <set_value name="$buySector" exact="@$buyStation.sector"/>
        <set_value name="$sellSector" exact="@$sellStation.sector"/>
        <set_value name="$currentSector" exact="if $currentSector? then $currentSector else $ship.sector"/>
        
        <!-- Check current sector for intra-sector trades -->
        <run_actions ref="md.GT_Trade_Utilities.GT_IsIntraSectorTrade" result="$isIntraSector">
          <param name="buySector" value="$buySector"/>
          <param name="sellSector" value="$sellSector"/>
          <param name="currentSector" value="$currentSector"/>
        </run_actions>
        
        <do_if value="$isIntraSector">
          <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$currentSectorBlacklisted">
            <param name="sector" value="$currentSector"/>
            <param name="ship" value="$ship"/>
            <param name="blacklistgroup" value="$blacklistgroup"/>
          </run_actions>
          <do_if value="$currentSectorBlacklisted">
            <set_value name="$result.$IsBlacklisted" exact="true"/>
            <set_value name="$result.$Reason" exact="'Intra-sector trade in blacklisted sector'"/>
            <return value="$result"/>
          </do_if>
        </do_if>
        
        <!-- Check stations -->
        <run_actions ref="md.GT_Blacklist_Utilities.GT_IsStationBlacklisted" result="$buyStationBlacklisted">
          <param name="station" value="$buyStation"/>
          <param name="ship" value="$ship"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
        </run_actions>
        <do_if value="$buyStationBlacklisted">
          <set_value name="$result.$IsBlacklisted" exact="true"/>
          <set_value name="$result.$Reason" exact="'Buy station blacklisted'"/>
          <return value="$result"/>
        </do_if>
        
        <run_actions ref="md.GT_Blacklist_Utilities.GT_IsStationBlacklisted" result="$sellStationBlacklisted">
          <param name="station" value="$sellStation"/>
          <param name="ship" value="$ship"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
        </run_actions>
        <do_if value="$sellStationBlacklisted">
          <set_value name="$result.$IsBlacklisted" exact="true"/>
          <set_value name="$result.$Reason" exact="'Sell station blacklisted'"/>
          <return value="$result"/>
        </do_if>
        
        <!-- Check sectors (with escape logic) -->
        <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$buySectorBlacklisted">
          <param name="sector" value="$buySector"/>
          <param name="ship" value="$ship"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
        </run_actions>
        <do_if value="$enableEscapeLogic and $buySectorBlacklisted">
          <!-- Escape logic: block buying in blacklisted sector -->
          <set_value name="$result.$IsBlacklisted" exact="true"/>
          <set_value name="$result.$Reason" exact="'Buy sector blacklisted (escape logic)'"/>
          <return value="$result"/>
        </do_if>
        
        <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$sellSectorBlacklisted">
          <param name="sector" value="$sellSector"/>
          <param name="ship" value="$ship"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
        </run_actions>
        <do_if value="$enableEscapeLogic and $sellSectorBlacklisted and $sellSector != $currentSector">
          <!-- Escape logic: block selling to blacklisted sector (unless already there) -->
          <set_value name="$result.$IsBlacklisted" exact="true"/>
          <set_value name="$result.$Reason" exact="'Sell sector blacklisted (escape logic)'"/>
          <return value="$result"/>
        </do_if>
        
        <return value="$result"/>
      </actions>
    </library>
    
  </cues>
</mdscript>
