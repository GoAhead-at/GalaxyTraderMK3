<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Libraries_Search" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================= -->
    <!-- SEARCH UTILITIES -->
    <!-- Extracted from gt_trading_search.xml for better maintainability -->
    <!-- ========================================= -->
    
    <!-- Validate Search Parameters -->
    <!-- Returns: table[$Valid = bool, $Ship = ship/null, $TraceId = string, $UseSearchQueueCounter = bool, $FromLiveQueue = bool, $Reason = string] -->
    <library name="GT_ValidateSearchParams" purpose="run_actions">
      <params>
        <param name="params" comment="Search parameters from event"/>
      </params>
      <actions>
        <set_value name="$result" exact="table[
          $Valid = false,
          $Ship = null,
          $TraceId = '',
          $UseSearchQueueCounter = false,
          $FromLiveQueue = false,
          $Reason = 'invalid'
        ]"/>
        
        <!-- Try to get params from event or queue -->
        <set_value name="$searchParams" exact="$params"/>
        <do_if value="not $searchParams?">
          <!-- Try to reconstruct from queue or batch data -->
          <set_value name="$shipFromQueue" exact="null"/>
          <do_if value="$shipFromQueue?">
            <do_if value="global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$shipFromQueue}?">
              <set_value name="$searchParams" exact="global.$GT_SearchQueue.$Params.{$shipFromQueue}"/>
            </do_if>
            <do_else>
              <set_value name="$batchData" exact="@global.$GT_BatchDataList.{$shipFromQueue}"/>
              <do_if value="$batchData?">
                <set_value name="$searchParams" exact="table[
                  $Ship = $shipFromQueue,
                  $MaxDistance = @$batchData.$maxDistance,
                  $MinROI = @$batchData.$minROI,
                  $MinAbsoluteProfit = @$batchData.$minAbsoluteProfit,
                  $FactionPriority = @$batchData.$factionPriority,
                  $AllowIllegal = false
                ]"/>
              </do_if>
            </do_else>
          </do_if>
        </do_if>
        
        <!-- Extract concurrency flags -->
        <do_if value="$searchParams?">
          <set_value name="$testShip" exact="@$searchParams.$Ship"/>
          <do_if value="$testShip? and $testShip.exists">
            <set_value name="$result.$Valid" exact="true"/>
            <set_value name="$result.$Ship" exact="$testShip"/>
            <set_value name="$result.$Reason" exact="'valid'"/>
            
            <!-- Extract trace ID -->
            <do_if value="$searchParams.$TraceId?">
              <set_value name="$result.$TraceId" exact="$searchParams.$TraceId"/>
            </do_if>
            
            <!-- Extract concurrency flags -->
            <do_if value="$searchParams.$UseSearchQueueCounter?">
              <set_value name="$result.$UseSearchQueueCounter" exact="$searchParams.$UseSearchQueueCounter"/>
            </do_if>
            <do_if value="$searchParams.$FromLiveQueue? and $searchParams.$FromLiveQueue == true">
              <set_value name="$result.$FromLiveQueue" exact="true"/>
            </do_if>
          </do_if>
        </do_if>
        
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Detect Search State -->
    <!-- Returns: table[$State = string, $OriginalMaxDistance = number] -->
    <!-- State values: 'fresh', 'cache', 'live', 'fallback' -->
    <library name="GT_DetectSearchState" purpose="run_actions">
      <params>
        <param name="params" comment="Search parameters"/>
        <param name="ship" comment="Ship object"/>
      </params>
      <actions>
        <set_value name="$result" exact="table[
          $State = 'fresh',
          $OriginalMaxDistance = 0
        ]"/>
        
        <!-- Check explicit SearchState parameter -->
        <set_value name="$searchState" exact="@$params.$SearchState"/>
        <do_if value="$searchState == null">
          <remove_value name="$searchState"/>
        </do_if>
        
        <!-- Extract originalMaxDistance -->
        <set_value name="$maxDistance" exact="@$params.$MaxDistance"/>
        <set_value name="$result.$OriginalMaxDistance" exact="$maxDistance"/>
        <do_if value="$params.$OriginalMaxDistance?">
          <set_value name="$result.$OriginalMaxDistance" exact="$params.$OriginalMaxDistance"/>
        </do_if>
        
        <!-- If SearchState not provided, infer from context -->
        <do_if value="not $searchState?">
          <set_value name="$savedWaitingForBatch" exact="true"/>
          <do_if value="global.$GT_SearchResult.{$ship}?">
            <set_value name="$shipResults" exact="global.$GT_SearchResult.{$ship}"/>
            <set_value name="$savedWaitingForBatch" exact="@$shipResults.$WaitingForBatch"/>
            <do_if value="not $savedWaitingForBatch">
              <!-- Live search just completed -->
              <do_if value="$result.$OriginalMaxDistance? and $result.$OriginalMaxDistance != $maxDistance">
                <set_value name="$searchState" exact="'fallback'"/>
              </do_if>
              <do_else>
                <set_value name="$searchState" exact="'live'"/>
              </do_else>
            </do_if>
            <do_else>
              <!-- Still waiting or cache search -->
              <set_value name="$cacheFound" exact="@$shipResults.$Found"/>
              <do_if value="$cacheFound">
                <set_value name="$searchState" exact="'cache'"/>
              </do_if>
              <do_else>
                <set_value name="$searchState" exact="'fresh'"/>
              </do_else>
            </do_else>
          </do_if>
        </do_if>
        
        <set_value name="$result.$State" exact="$searchState"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Check Live Search State Staleness -->
    <!-- Returns: table[$IsStale = bool, $ShouldProceed = bool, $Reason = string] -->
    <library name="GT_CheckLiveSearchStateStaleness" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship object"/>
        <param name="searchState" comment="Current search state"/>
      </params>
      <actions>
        <set_value name="$result" exact="table[
          $IsStale = false,
          $ShouldProceed = true,
          $Reason = 'proceed'
        ]"/>
        
        <!-- Only check for fresh searches -->
        <do_if value="$searchState == 'fresh' and global.$GT_SearchLiveTrades_State? and global.$GT_SearchLiveTrades_State.{$ship}?">
          <set_value name="$lsState" exact="@global.$GT_SearchLiveTrades_State.{$ship}"/>
          <set_value name="$stateStarted" exact="null"/>
          <do_if value="$lsState != null and $lsState.$Started? and $lsState.$Started != null">
            <set_value name="$stateStarted" exact="$lsState.$Started"/>
          </do_if>
          
          <!-- State without Started timestamp is stale -->
          <do_if value="$stateStarted == null">
            <set_value name="$result.$IsStale" exact="true"/>
            <set_value name="$result.$ShouldProceed" exact="true"/>
            <set_value name="$result.$Reason" exact="'missing_started_timestamp'"/>
          </do_if>
          <do_else>
            <set_value name="$stateAgeSeconds" exact="(player.age - $stateStarted) / 1s"/>
            
            <!-- Load pacing settings -->
            <set_value name="$sliceIntervalMs" exact="500"/>
            <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$LiveOfferSliceInterval?">
              <set_value name="$tmpMs" exact="@global.$GT_GlobalSettings.$Performance.$LiveOfferSliceInterval"/>
              <do_if value="$tmpMs? and $tmpMs != null and $tmpMs gt 0">
                <set_value name="$sliceIntervalMs" exact="$tmpMs"/>
              </do_if>
            </do_if>
            <do_if value="$sliceIntervalMs lt 5"><set_value name="$sliceIntervalMs" exact="5"/></do_if>
            <do_if value="$sliceIntervalMs gt 2000"><set_value name="$sliceIntervalMs" exact="2000"/></do_if>
            
            <set_value name="$baseStaleThreshold" exact="300"/>
            <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$StaleThresholdSeconds?">
              <set_value name="$baseStaleThreshold" exact="global.$GT_GlobalSettings.$Performance.$StaleThresholdSeconds"/>
            </do_if>
            <set_value name="$staleThresholdSeconds" exact="$baseStaleThreshold"/>
            
            <!-- Calculate dynamic threshold based on remaining work -->
            <set_value name="$remainingSectors" exact="0"/>
            <do_if value="$lsState != null">
              <set_value name="$buyCount" exact="0"/>
              <set_value name="$sellCount" exact="0"/>
              <do_if value="$lsState.$BuySpaces? and $lsState.$BuySpaces != null">
                <set_value name="$buyCount" exact="$lsState.$BuySpaces.count"/>
              </do_if>
              <do_if value="$lsState.$SellSpaces? and $lsState.$SellSpaces != null">
                <set_value name="$sellCount" exact="$lsState.$SellSpaces.count"/>
              </do_if>
              <set_value name="$buyIndex" exact="0"/>
              <do_if value="$lsState.$BuyIndex? and $lsState.$BuyIndex != null">
                <set_value name="$buyIndex" exact="$lsState.$BuyIndex"/>
              </do_if>
              <set_value name="$sellIndex" exact="0"/>
              <do_if value="$lsState.$SellIndex? and $lsState.$SellIndex != null">
                <set_value name="$sellIndex" exact="$lsState.$SellIndex"/>
              </do_if>
              <set_value name="$remainingSectors" exact="[$buyCount - $buyIndex, 0].max + [$sellCount - $sellIndex, 0].max"/>
              
              <do_if value="$remainingSectors gt 0">
                <set_value name="$sliceQueueShips" exact="1"/>
                <do_if value="global.$GT_LiveOfferSliceQueue? and global.$GT_LiveOfferSliceQueue.$Ships?">
                  <set_value name="$tmpQ" exact="@global.$GT_LiveOfferSliceQueue.$Ships.count"/>
                  <do_if value="$tmpQ? and $tmpQ != null and $tmpQ gt 0">
                    <set_value name="$sliceQueueShips" exact="$tmpQ"/>
                  </do_if>
                </do_if>
                <set_value name="$sliceSeconds" exact="($remainingSectors * $sliceIntervalMs * $sliceQueueShips) / 1000.0"/>
                <set_value name="$staleThresholdSeconds" exact="[$sliceSeconds + 60, $baseStaleThreshold].max"/>
              </do_if>
            </do_if>
            
            <!-- Check if stale -->
            <do_if value="$stateAgeSeconds ge 0 and $stateAgeSeconds gt $staleThresholdSeconds">
              <set_value name="$result.$IsStale" exact="true"/>
              <set_value name="$result.$ShouldProceed" exact="true"/>
              <set_value name="$result.$Reason" exact="'stale_threshold_exceeded'"/>
            </do_if>
            <do_else>
              <!-- State is fresh - don't proceed -->
              <set_value name="$result.$ShouldProceed" exact="false"/>
              <set_value name="$result.$Reason" exact="'live_search_in_progress'"/>
            </do_else>
          </do_else>
        </do_if>
        
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Select Best Trade from Diverse List -->
    <!-- Returns: table[$BestTrade = trade/null, $BestScore = number] -->
    <library name="GT_SelectBestTradeFromDiverseList" purpose="run_actions">
      <params>
        <param name="diverseList" comment="List of diverse trades"/>
        <param name="nonConflictedTrade" default="null" comment="Non-conflicted trade candidate"/>
        <param name="nonConflictedScore" default="0" comment="Score of non-conflicted trade"/>
        <param name="crossStationTrade" default="null" comment="Cross-station trade candidate"/>
        <param name="crossStationScore" default="0" comment="Score of cross-station trade"/>
        <param name="homeSector" comment="Home sector for distance validation"/>
        <param name="maxDistance" comment="Maximum distance allowed"/>
      </params>
      <actions>
        <set_value name="$result" exact="table[
          $BestTrade = null,
          $BestScore = 0
        ]"/>
        
        <set_value name="$bestTrade" exact="null"/>
        <set_value name="$bestScore" exact="0"/>
        
        <!-- Validate non-conflicted trade -->
        <set_value name="$validatedNonConflictedTrade" exact="null"/>
        <set_value name="$nonConflictedBestScore" exact="0"/>
        <do_if value="$nonConflictedTrade? and $nonConflictedScore gt 0">
          <run_actions ref="md.GT_Libraries_General.GT_IsTradeValid" result="$isValid">
            <param name="trade" value="$nonConflictedTrade"/>
            <param name="minScore" value="0"/>
          </run_actions>
          <do_if value="$isValid">
            <set_value name="$validatedNonConflictedTrade" exact="$nonConflictedTrade"/>
            <set_value name="$nonConflictedBestScore" exact="$nonConflictedScore"/>
          </do_if>
        </do_if>
        
        <!-- Validate cross-station trade -->
        <set_value name="$validatedCrossStationTrade" exact="null"/>
        <set_value name="$crossStationBestScore" exact="0"/>
        <do_if value="$crossStationTrade? and $crossStationScore gt 0">
          <set_value name="$tradeBuySector" exact="@$crossStationTrade.$BuyStation.sector"/>
          <set_value name="$tradeSellSector" exact="@$crossStationTrade.$SellStation.sector"/>
          <set_value name="$tradeBuyDistance" exact="-1"/>
          <set_value name="$tradeSellDistance" exact="-1"/>
          
          <do_if value="$tradeBuySector == $homeSector">
            <set_value name="$tradeBuyDistance" exact="0"/>
          </do_if>
          <do_else>
            <set_value name="$tradeBuyDistance" exact="$homeSector.gatedistance.{$tradeBuySector}"/>
          </do_else>
          
          <do_if value="$tradeSellSector == $homeSector">
            <set_value name="$tradeSellDistance" exact="0"/>
          </do_if>
          <do_else>
            <set_value name="$tradeSellDistance" exact="$homeSector.gatedistance.{$tradeSellSector}"/>
          </do_else>
          
          <!-- Check if trade exists in diverse list -->
          <set_value name="$tradeExistsInDiverseList" exact="false"/>
          <do_if value="$tradeBuyDistance ge 0 and $tradeSellDistance ge 0 and $tradeBuyDistance le $maxDistance and $tradeSellDistance le $maxDistance">
            <do_all exact="$diverseList.count" counter="$i">
              <set_value name="$diverseTrade" exact="$diverseList.{$i}"/>
              <do_if value="$diverseTrade.$BuyStation == $crossStationTrade.$BuyStation and 
                             $diverseTrade.$SellStation == $crossStationTrade.$SellStation and
                             $diverseTrade.$BuyOffer.ware == $crossStationTrade.$BuyOffer.ware">
                <set_value name="$tradeExistsInDiverseList" exact="true"/>
                <break/>
              </do_if>
            </do_all>
            
            <do_if value="$tradeExistsInDiverseList">
              <run_actions ref="md.GT_Libraries_General.GT_IsTradeValid" result="$isValid">
                <param name="trade" value="$crossStationTrade"/>
                <param name="minScore" value="0"/>
              </run_actions>
              <do_if value="$isValid">
                <set_value name="$validatedCrossStationTrade" exact="$crossStationTrade"/>
                <set_value name="$crossStationBestScore" exact="$crossStationScore"/>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Select best trade: prefer non-conflicted, then cross-station, then best from diverse list -->
        <do_if value="$validatedNonConflictedTrade? and $nonConflictedBestScore gt 0">
          <set_value name="$bestTrade" exact="$validatedNonConflictedTrade"/>
          <set_value name="$bestScore" exact="$nonConflictedBestScore"/>
        </do_if>
        <do_else>
          <do_if value="$validatedCrossStationTrade? and $crossStationBestScore gt 0">
            <set_value name="$bestTrade" exact="$validatedCrossStationTrade"/>
            <set_value name="$bestScore" exact="$crossStationBestScore"/>
          </do_if>
          <do_else>
            <!-- Fallback: Find best from diverse list -->
            <do_all exact="$diverseList.count" counter="$i">
              <set_value name="$trade" exact="$diverseList.{$i}"/>
              <run_actions ref="md.GT_Libraries_General.GT_IsTradeValid" result="$isValid">
                <param name="trade" value="$trade"/>
                <param name="minScore" value="$bestScore"/>
              </run_actions>
              <do_if value="$isValid">
                <set_value name="$testScore" exact="@$trade.$Score"/>
                <do_if value="$testScore gt $bestScore">
                  <set_value name="$bestScore" exact="$testScore"/>
                  <set_value name="$bestTrade" exact="$trade"/>
                </do_if>
              </do_if>
            </do_all>
          </do_else>
        </do_else>
        
        <!-- If bestScore is still 0, all trades have Score = 0 -->
        <do_if value="$bestScore le 0">
          <set_value name="$bestTrade" exact="null"/>
        </do_if>
        
        <set_value name="$result.$BestTrade" exact="$bestTrade"/>
        <set_value name="$result.$BestScore" exact="$bestScore"/>
        <return value="$result"/>
      </actions>
    </library>
    
  </cues>
</mdscript>
