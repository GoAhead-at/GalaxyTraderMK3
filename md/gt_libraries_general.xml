<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Libraries_General" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================= -->
    <!-- GENERAL UTILITIES -->
    <!-- Consolidated from: gt_trade_utilities.xml, gt_data_utilities.xml, gt_utilities.xml, gt_ai_script_utilities.xml, gt_logbook_utilities.xml -->
    <!-- ========================================= -->
    <!-- ========================================= -->
    <!-- TRADE UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Is Intra-Sector Trade -->
    <library name="GT_IsIntraSectorTrade" purpose="run_actions">
      <params>
        <param name="buySector" comment="Buy station sector"/>
        <param name="sellSector" comment="Sell station sector"/>
        <param name="currentSector" comment="Ship's current sector"/>
      </params>
      <actions>
        <do_if value="$buySector? and $sellSector? and $currentSector?">
          <do_if value="$buySector == $currentSector and $sellSector == $currentSector">
            <return value="true"/>
          </do_if>
        </do_if>
        <return value="false"/>
      </actions>
    </library>
    
    <!-- Calculate Trade Efficiency -->
    <library name="GT_CalculateTradeEfficiency" purpose="run_actions">
      <params>
        <param name="profit" comment="Trade profit"/>
        <param name="distance" default="0" comment="Trade distance (jumps) - legacy parameter, used as fallback"/>
        <param name="distancePenaltyMultiplier" default="1.0" comment="Distance penalty multiplier (0.0-2.0)"/>
        <param name="factionPriority" default="2" comment="Faction priority (0=Player, 1=Foreign, 2=Equal)"/>
        <param name="buyStationOwner" default="null" comment="Buy station owner faction"/>
        <param name="sellStationOwner" default="null" comment="Sell station owner faction"/>
        <param name="homeSector" default="null" comment="Home sector for path efficiency calculation"/>
        <param name="shipSector" default="null" comment="Ship's current sector"/>
        <param name="buySector" default="null" comment="Buy station sector"/>
        <param name="sellSector" default="null" comment="Sell station sector"/>
        <param name="shipToBuyDistance" default="-1" comment="Distance from ship to buy station (for path efficiency)"/>
        <param name="buyToSellDistance" default="-1" comment="Distance from buy station to sell station"/>
        <param name="homeToBuyDistance" default="-1" comment="Distance from home sector to buy station"/>
        <param name="homeToSellDistance" default="-1" comment="Distance from home sector to sell station"/>
      </params>
      <actions>
        <!-- Multi-factor distance penalty system -->
        <!-- Improved scoring that separately penalizes:
             1. Shipâ†’Buy distance (HEAVY weight - ship must travel first)
             2. Buyâ†’Sell distance (MODERATE weight - trade route length)
             3. Home distance (LIGHT weight - territorial control)
        -->
        <set_value name="$adjustedDistance" exact="0.0"/>
        
        <!-- Check if we have all required parameters for new multi-factor system -->
        <set_value name="$useMultiFactor" exact="false"/>
        <do_if value="$shipToBuyDistance ge 0 and $buyToSellDistance ge 0 and $homeToBuyDistance ge 0 and $homeToSellDistance ge 0 and $buySector? and $sellSector?">
          <set_value name="$useMultiFactor" exact="true"/>
        </do_if>
        
        <!-- Log which system is being used -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Efficiency] Multi-factor=' + $useMultiFactor + ', Shipâ†’Buy=' + $shipToBuyDistance + ', Buyâ†’Sell=' + $buyToSellDistance + ', Homeâ†’Buy=' + $homeToBuyDistance + ', Homeâ†’Sell=' + $homeToSellDistance" chance="100"/>
        </do_if>
        
        <do_if value="$useMultiFactor">
          <!-- Factor 1: Ship to Buy Distance Penalty (HEAVY WEIGHT - ship must travel first) -->
          <!-- This is the most important - ship has to get to buy station first -->
          <!-- Weight: 4.0 (increased from 3.0), Quadratic base: 3.5 (steeper penalty for longer distances) -->
          <!-- Example: 7 jumps = 7 * 4 * (1 + 4) = 140 penalty units (with multiplier=2: 280 units) -->
          <!-- Apply user's distance penalty multiplier setting -->
          <set_value name="$shipToBuyBase" exact="3.5"/>
          <set_value name="$shipToBuyRatio" exact="$shipToBuyDistance / $shipToBuyBase"/>
          <set_value name="$shipToBuyNonLinear" exact="1.0 + ($shipToBuyRatio * $shipToBuyRatio)"/>
          <set_value name="$shipToBuyPenalty" exact="$shipToBuyDistance * 4.0 * $shipToBuyNonLinear * $distancePenaltyMultiplier"/>
          
          <!-- Factor 2: Buy to Sell Distance Penalty (MODERATE WEIGHT - trade route length) -->
          <!-- Encourages shorter trade routes between stations -->
          <!-- Weight: 1.5, Quadratic base: 8.0 (moderate penalty) -->
          <!-- Apply user's distance penalty multiplier setting -->
          <set_value name="$buyToSellBase" exact="8.0"/>
          <set_value name="$buyToSellRatio" exact="$buyToSellDistance / $buyToSellBase"/>
          <set_value name="$buyToSellNonLinear" exact="1.0 + ($buyToSellRatio * $buyToSellRatio)"/>
          <set_value name="$buyToSellPenalty" exact="$buyToSellDistance * 1.5 * $buyToSellNonLinear * $distancePenaltyMultiplier"/>
          
          <!-- Factor 3: Home Distance Penalty (LIGHT WEIGHT - territorial control) -->
          <!-- Penalize trades far from home (both stations) - encourages staying near home base -->
          <!-- Weight: 0.5, Quadratic base: 10.0 (light penalty) -->
          <!-- Apply user's distance penalty multiplier setting -->
          <set_value name="$maxHomeDistance" exact="[$homeToBuyDistance, $homeToSellDistance].max"/>
          <set_value name="$homeDistanceBase" exact="10.0"/>
          <set_value name="$homeDistanceRatio" exact="$maxHomeDistance / $homeDistanceBase"/>
          <set_value name="$homeDistanceNonLinear" exact="1.0 + ($homeDistanceRatio * $homeDistanceRatio)"/>
          <set_value name="$homeDistancePenalty" exact="$maxHomeDistance * 0.5 * $homeDistanceNonLinear * $distancePenaltyMultiplier"/>
          
          <!-- Combined Adjusted Distance -->
          <set_value name="$adjustedDistance" exact="$shipToBuyPenalty + $buyToSellPenalty + $homeDistancePenalty"/>
          
          <!-- Log penalty breakdown -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Efficiency] Multi-factor penalties (multiplier=' + $distancePenaltyMultiplier + '): Shipâ†’Buy=' + $shipToBuyPenalty + ', Buyâ†’Sell=' + $buyToSellPenalty + ', Home=' + $homeDistancePenalty + ', Total=' + $adjustedDistance" chance="100"/>
          </do_if>
        </do_if>
        <do_else>
          <!-- Legacy single-factor distance penalty (for batch processor, etc.) -->
          <!-- Formula: adjustedDistance = distance * multiplier * (1 + (distance / 10)^2) -->
          <!-- This creates quadratic penalty: longer distances get exponentially more penalized -->
          <!-- Examples with multiplier=2.0:
               - Distance 1:  1 * 2 * (1 + 0.01) = 2.02   (minimal penalty)
               - Distance 5:  5 * 2 * (1 + 0.25) = 12.5   (25% extra)
               - Distance 10: 10 * 2 * (1 + 1)   = 40     (100% extra = 2x)
               - Distance 20: 20 * 2 * (1 + 4)   = 200    (400% extra = 5x)
          -->
          <set_value name="$distanceBase" exact="10.0"/>
          <set_value name="$distanceRatio" exact="$distance / $distanceBase"/>
          <set_value name="$nonLinearFactor" exact="1.0 + ($distanceRatio * $distanceRatio)"/>
          <set_value name="$adjustedDistance" exact="$distance * $distancePenaltyMultiplier * $nonLinearFactor"/>
        </do_else>
        
        <!-- Convert money to number before division to avoid "Loss of data while converting floating point" error -->
        <!-- Convert profit (money in cents) to numeric value using f suffix to force float conversion -->
        <!-- Pattern from order.trade.perform.xml:243: (money / 1Cr)f forces float conversion -->
        <!-- Apply non-linear profit scaling to reduce profit dominance in scoring -->
        <!-- Formula: profitNum_scaled = profitNum / (1.0 + profitNum / profitBase) -->
        <!-- This creates diminishing returns: higher profits get scaled down more -->
        <!-- Examples:
             - Profit 10,000 Cr â†’ profitNum = 1,000,000 â†’ scaled = 1,000,000 / (1 + 1) = 500,000 (50% reduction)
             - Profit 20,000 Cr â†’ profitNum = 2,000,000 â†’ scaled = 2,000,000 / (1 + 2) = 666,667 (67% reduction)
             - Profit 260,090 Cr â†’ profitNum = 26,009,000 â†’ scaled = 26,009,000 / (1 + 26) = 962,556 (96% reduction)
        -->
        <!-- This means: 2x profit â†’ ~1.33x score (instead of 2x), significantly reducing profit's overwhelming influence -->
        <set_value name="$efficiency" exact="0.0"/>
        <do_if value="$adjustedDistance gt 0">
          <!-- Convert profit from money (cents) to number by dividing by 1ct, then scale by 100 -->
          <!-- Use f suffix to force float conversion (pattern from order.trade.perform.xml:243) -->
          <set_value name="$profitNum" exact="(($profit / 1ct) * 100)f"/>
          
          <!-- Apply diminishing returns to reduce profit dominance -->
          <!-- profitBase controls where scaling kicks in - lower = more aggressive scaling -->
          <!-- Formula: profitNum_scaled = profitNum / (1.0 + profitNum / profitBase) -->
          <set_value name="$profitBase" exact="1000000.0"/>
          <set_value name="$profitRatio" exact="$profitNum / $profitBase"/>
          <set_value name="$profitScalingFactor" exact="1.0 + $profitRatio"/>
          <set_value name="$profitNumScaled" exact="$profitNum / $profitScalingFactor"/>
          
          <!-- Scale adjustedDistance by 10000 for precision -->
          <set_value name="$scaledDistance" exact="$adjustedDistance * 10000.0"/>
          <!-- Division: number / number = number (efficiency scaled by 10000) -->
          <!-- Note: Efficiency is now scaled by 10000, but all comparisons/scoring work correctly with scaled values -->
          <set_value name="$efficiency" exact="$profitNumScaled / $scaledDistance"/>
        </do_if>
        <do_else>
          <!-- If distance is 0, efficiency equals profit (converted to number) with same scaling -->
          <set_value name="$profitNum" exact="(($profit / 1ct) * 100)f"/>
          <set_value name="$profitBase" exact="1000000.0"/>
          <set_value name="$profitRatio" exact="$profitNum / $profitBase"/>
          <set_value name="$profitScalingFactor" exact="1.0 + $profitRatio"/>
          <set_value name="$profitNumScaled" exact="$profitNum / $profitScalingFactor"/>
          <set_value name="$efficiency" exact="$profitNumScaled"/>
        </do_else>
        
        <!-- Apply faction priority boost -->
        <do_if value="$factionPriority == 0 and ($buyStationOwner == faction.player or $sellStationOwner == faction.player)">
          <set_value name="$boost" exact="$efficiency / 5"/>
          <set_value name="$efficiency" exact="$efficiency + $boost"/>
        </do_if>
        <do_elseif value="$factionPriority == 1 and $buyStationOwner != faction.player and $sellStationOwner != faction.player">
          <set_value name="$boost" exact="$efficiency / 5"/>
          <set_value name="$efficiency" exact="$efficiency + $boost"/>
        </do_elseif>
        
        <!-- Apply "same path" bonus for efficient routing -->
        <!-- Favors trades where stations are "in order" relative to home and ship position -->
        <!-- Example: Home=E, Ship=B, Buy=C, Sell=E â†’ Efficient (moves toward home) -->
        <!-- Example: Home=E, Ship=B, Buy=E, Sell=C â†’ Less efficient (backtracks) -->
        <set_value name="$pathBonus" exact="1.0"/>
        <do_if value="$homeSector? and $shipSector? and $buySector? and $sellSector? and $shipToBuyDistance ge 0">
          <!-- Use passed distance parameters if available, otherwise calculate -->
          <set_value name="$homeToBuy" exact="-1"/>
          <set_value name="$homeToSell" exact="-1"/>
          <do_if value="$homeToBuyDistance ge 0 and $homeToSellDistance ge 0">
            <!-- Use passed parameters (from new multi-factor system) -->
            <set_value name="$homeToBuy" exact="$homeToBuyDistance"/>
            <set_value name="$homeToSell" exact="$homeToSellDistance"/>
          </do_if>
          <do_else>
            <!-- Fallback: Calculate distances (for backward compatibility) -->
            <set_value name="$homeToBuy" exact="$homeSector.gatedistance.{$buySector}"/>
            <set_value name="$homeToSell" exact="$homeSector.gatedistance.{$sellSector}"/>
          </do_else>
          
          <!-- Calculate shipâ†’sell distance directly (path might differ from shipâ†’buy + buyâ†’sell) -->
          <set_value name="$shipToSell" exact="$shipSector.gatedistance.{$sellSector}"/>
          
          <!-- Only apply bonus if all distances are valid (non-negative, paths exist) -->
          <do_if value="$homeToBuy ge 0 and $homeToSell ge 0 and $shipToSell ge 0">
            <!-- Case 1: Buy station is further from home than sell station -->
            <!-- Efficient route: Ship â†’ Buy (further) â†’ Sell (closer) â†’ Home -->
            <!-- This is efficient if ship is closer to buy than sell (ship between buy and sell, or beyond buy) -->
            <do_if value="$homeToBuy gt $homeToSell">
              <!-- Efficient if ship is closer to buy station than sell station -->
              <!-- This means ship can move forward (toward sell/home) without backtracking -->
              <do_if value="$shipToBuyDistance le $shipToSell">
                <!-- Same path bonus: 10% efficiency boost -->
                <set_value name="$pathBonus" exact="1.1"/>
              </do_if>
            </do_if>
            <!-- Case 2: Sell station is further from home than buy station -->
            <!-- Efficient route: Ship â†’ Sell (further) â†’ Buy (closer) â†’ Home -->
            <!-- This is efficient if ship is closer to sell than buy -->
            <do_elseif value="$homeToSell gt $homeToBuy">
              <!-- Efficient if ship is closer to sell station than buy station -->
              <do_if value="$shipToSell le $shipToBuyDistance">
                <!-- Same path bonus: 10% efficiency boost -->
                <set_value name="$pathBonus" exact="1.1"/>
              </do_if>
            </do_elseif>
            <!-- Case 3: Both stations same distance from home (same sector or equidistant) -->
            <!-- Already efficient - smaller bonus -->
            <do_elseif value="$homeToBuy == $homeToSell">
              <set_value name="$pathBonus" exact="1.05"/>
            </do_elseif>
          </do_if>
        </do_if>
        
        <!-- Apply path bonus to efficiency -->
        <set_value name="$efficiency" exact="$efficiency * $pathBonus"/>
        
        <return value="$efficiency"/>
      </actions>
    </library>
    
    <!-- Get Distance Penalty Multiplier -->
    <library name="GT_GetDistancePenaltyMultiplier" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to get distance penalty for"/>
        <param name="defaultMultiplier" default="1.0" comment="Default multiplier (for 50% distance penalty)"/>
      </params>
      <actions>
        <set_value name="$distancePenalty" exact="@global.$GT_AIParameters.{$ship}.$DistancePenalty"/>
        <do_if value="$distancePenalty?">
          <!-- Convert 0-100% to 0.0-2.0: 0%=0.0, 50%=1.0, 100%=2.0 -->
          <return value="$distancePenalty / 50.0"/>
        </do_if>
        <return value="$defaultMultiplier"/>
      </actions>
    </library>
    
    <!-- Get Faction Priority Text -->
    <library name="GT_GetFactionPriorityText" purpose="run_actions">
      <params>
        <param name="factionPriority" comment="Faction priority value (0, 1, or 2)"/>
      </params>
      <actions>
        <return value="if $factionPriority == 0 then 'Player Only' else if $factionPriority == 1 then 'Foreign First' else 'Equal Priority'"/>
      </actions>
    </library>
    
    <!-- Calculate ROI from Prices -->
    <library name="GT_CalculateROIFromPrices" purpose="run_actions">
      <params>
        <param name="buyPrice" comment="Price per unit to buy"/>
        <param name="sellPrice" comment="Price per unit to sell"/>
      </params>
      <actions>
        <!-- Calculate ROI as percentage: ((sellPrice - buyPrice) / buyPrice) * 100 -->
        <do_if value="$buyPrice gt 0">
          <return value="(($sellPrice - $buyPrice) * 100) / $buyPrice"/>
        </do_if>
        <return value="0"/>
      </actions>
    </library>
    
    <!-- Request Registry: Acquire Search Lock and Parameters -->
    <!-- Centralizes lock and parameter management to prevent cleanup leaks -->
    <library name="GT_RequestRegistry_Acquire" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship requesting trade search"/>
        <param name="parameters" comment="AI parameters table (must match structure from gt_trading_ai.xml)"/>
      </params>
      <actions>
        <!-- Initialize tables if needed -->
        <do_if value="not global.$GT_SearchLocks?">
          <set_value name="global.$GT_SearchLocks" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_AIParameters?">
          <set_value name="global.$GT_AIParameters" exact="table[]"/>
        </do_if>
        
        <!-- Check if already locked -->
        <set_value name="this.$alreadyLocked" exact="false"/>
        <do_if value="global.$GT_SearchLocks.{$ship}?">
          <set_value name="this.$alreadyLocked" exact="true"/>
        </do_if>
        
        <!-- Acquire lock and store parameters -->
        <do_if value="not this.$alreadyLocked">
          <set_value name="global.$GT_SearchLocks.{$ship}" exact="player.age"/>
          <set_value name="global.$GT_AIParameters.{$ship}" exact="$parameters"/>
          <set_value name="this.$acquired" exact="true"/>
        </do_if>
        <do_else>
          <set_value name="this.$acquired" exact="false"/>
        </do_else>
      </actions>
    </library>
    
    <!-- Request Registry: Release Search Lock and Parameters -->
    <!-- Centralizes cleanup to prevent leaks and ensure consistent behavior -->
    <library name="GT_RequestRegistry_Release" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to release"/>
        <param name="reason" default="'search_complete'" comment="Reason for release (for debugging)"/>
      </params>
      <actions>
        <!-- Release lock -->
        <do_if value="global.$GT_SearchLocks? and global.$GT_SearchLocks.{$ship}?">
          <remove_value name="global.$GT_SearchLocks.{$ship}"/>
          <do_if value="global.$GT_Config? and global.$GT_Config.$Debug? and global.$GT_Config.$Debug.$TradeSearch? and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Registry] Search lock released for ' + $ship.idcode + ' (' + $reason + ')'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Clean up parameters -->
        <do_if value="global.$GT_AIParameters? and global.$GT_AIParameters.{$ship}?">
          <remove_value name="global.$GT_AIParameters.{$ship}"/>
          <do_if value="global.$GT_Config? and global.$GT_Config.$Debug? and global.$GT_Config.$Debug.$TradeSearch? and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Registry] AI parameters cleaned up for ' + $ship.idcode + ' (' + $reason + ')'" chance="100"/>
          </do_if>
        </do_if>
        
        <set_value name="this.$released" exact="true"/>
      </actions>
    </library>
    
    <!-- Get Skill-Based Multiplier -->
    <library name="GT_GetSkillMultiplier" purpose="run_actions">
      <params>
        <param name="skillLevel" comment="Pilot skill level (1-15+)"/>
      </params>
      <actions>
        <!-- Returns multiplier: 0.5 at Lv1 â†’ 2.0 at Lv15 -->
        <!-- Formula: 0.5 + ((skillLevel - 1) * (1.5 / 14)) -->
        <return value="0.5 + (($skillLevel - 1) * (1.5 / 14))"/>
      </actions>
    </library>
    
    <!-- Get Pilot Level-Based Profit Threshold -->
    <library name="GT_GetPilotLevelProfitThreshold" purpose="run_actions">
      <params>
        <param name="skillLevel" comment="Pilot skill level (1-15+)"/>
        <param name="shipCargoCapacity" comment="Ship's max cargo capacity (for scaling threshold)"/>
        <param name="configBaseProfit" default="10000" comment="Base profit from config (deprecated - kept for compatibility but not used)"/>
      </params>
      <actions>
        <!-- Returns profit threshold in raw format (centicredits) based on pilot level:
             Non-linear (quadratic) progression from Level 1 (0 Cr) to Level 15 (10000 Cr)
             Formula: 1000000 * ((skillLevel - 1) / 14)^2
             This creates a quadratic curve that starts at 0 Cr and accelerates to 10000 Cr:
             Level 1: 0 Cr (0 raw)
             Level 2: ~51 Cr (5,102 raw)
             Level 3: ~204 Cr (20,408 raw)
             Level 4: ~459 Cr (45,918 raw)
             Level 5: ~816 Cr (81,633 raw)
             Level 10: ~3,673 Cr (367,347 raw)
             Level 15: 10,000 Cr (1,000,000 raw)
             
             âœ… NEW: Threshold is scaled by ship cargo capacity
             - Reference cargo: 8200 (Merkur - baseline for Level 15 = 10,000 Cr)
             - Small ships (2200 cargo) get proportionally lower thresholds
             - Minimum floor: 25% of base threshold (prevents thresholds from being too low)
        -->
        <!-- Level 1-15+: Non-linear (quadratic) progression from 0 Cr to 10000 Cr -->
        <!-- Avoid integer division by rearranging formula -->
        <!-- Original: 1000000 * ((skillLevel - 1) / 14)^2 -->
        <!-- Rearranged: ((skillLevel - 1)^2 * 1000000) / 196 -->
        <!-- This avoids floating-point division issues in MD by doing integer math -->
        <!-- This creates an accelerating curve - lower levels have lower thresholds, -->
        <!-- higher levels require much more profit (more selective traders) -->
        <set_value name="$numerator" exact="($skillLevel - 1) * ($skillLevel - 1) * 1000000"/>
        <set_value name="$baseThreshold" exact="$numerator / 196"/>
        
        <!-- Scale threshold by ship cargo capacity -->
        <!-- Reference cargo: 8200 (Merkur - baseline for Level 15 = 10,000 Cr) -->
        <!-- Small ships get proportionally lower thresholds -->
        <set_value name="$referenceCargo" exact="8200"/>
        <do_if value="$shipCargoCapacity? and $shipCargoCapacity gt 0">
          <!-- Calculate scaling factor: shipCargo / referenceCargo -->
          <!-- Use integer math to avoid floating-point issues -->
          <set_value name="$scalingFactor" exact="($shipCargoCapacity * 100) / $referenceCargo"/>
          <set_value name="$scaledThreshold" exact="($baseThreshold * $scalingFactor) / 100"/>
          
          <!-- Apply minimum floor: At least 25% of base threshold -->
          <set_value name="$minFloor" exact="($baseThreshold * 25) / 100"/>
          <set_value name="$result" exact="[$scaledThreshold, $minFloor].max"/>
        </do_if>
        <do_else>
          <!-- Fallback: Use base threshold if cargo capacity not available -->
          <set_value name="$result" exact="$baseThreshold"/>
        </do_else>
        
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Validate Trade -->
    <library name="GT_IsTradeValid" purpose="run_actions">
      <params>
        <param name="trade" comment="Trade object to validate"/>
        <param name="minScore" default="0" comment="Minimum score required (default: 0 = any positive score)"/>
      </params>
      <actions>
        <!-- Validate trade has all required properties -->
        <set_value name="$testBuyOffer" exact="@$trade.$BuyOffer"/>
        <set_value name="$testSellOffer" exact="@$trade.$SellOffer"/>
        <set_value name="$testScore" exact="@$trade.$Score"/>
        <do_if value="$testBuyOffer? and $testSellOffer? and $testScore? and $testScore gt $minScore">
          <set_value name="$testWare" exact="@$testBuyOffer.ware"/>
          <do_if value="$testWare?">
            <return value="true"/>
          </do_if>
        </do_if>
        <return value="false"/>
      </actions>
    </library>
    
    <!-- Calculate Max Tradeable Amount -->
    <library name="GT_CalculateMaxTradeableAmount" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship for cargo capacity calculation"/>
        <param name="ware" comment="Ware to calculate capacity for"/>
        <param name="buyOfferAmount" comment="Buy offer amount"/>
        <param name="sellOfferAmount" comment="Sell offer amount"/>
        <param name="availableMoney" default="999999Cr" comment="Available money"/>
        <param name="buyPrice" default="0" comment="Buy price per unit"/>
      </params>
      <actions>
        <!-- Calculate max cargo capacity for this ware -->
        <set_value name="$maxCargoCapacity" exact="($ship.cargo.free.all / $ware.volume)i"/>
        <!-- Calculate max affordable based on available money -->
        <set_value name="$maxAffordable" exact="99999"/>
        <do_if value="$buyPrice gt 0">
          <set_value name="$maxAffordable" exact="($availableMoney / $buyPrice)i"/>
        </do_if>
        <!-- Return minimum of offer amounts, cargo capacity, and money limit -->
        <return value="[$buyOfferAmount, $sellOfferAmount, $maxCargoCapacity, $maxAffordable].min"/>
      </actions>
    </library>
    
    <!-- Index Offers By Ware -->
    <library name="GT_IndexOffersByWare" purpose="run_actions">
      <params>
        <param name="offersList" comment="List of trade offers to index"/>
      </params>
      <actions>
        <set_value name="$offersByWare" exact="table[]"/>
        <do_all exact="$offersList.count" counter="$i">
          <set_value name="$offer" exact="$offersList.{$i}"/>
          <do_if value="not $offersByWare.{$offer.ware}?">
            <set_value name="$offersByWare.{$offer.ware}" exact="[]"/>
          </do_if>
          <append_to_list name="$offersByWare.{$offer.ware}" exact="$offer"/>
        </do_all>
        <return value="$offersByWare"/>
      </actions>
    </library>
    
    <!-- Filter Offers By Distance -->
    <library name="GT_FilterOffersByDistance" purpose="run_actions">
      <params>
        <param name="offersList" comment="List of offers to filter"/>
        <param name="homeSector" comment="Home/base sector for distance calculation"/>
        <param name="maxDistance" comment="Maximum distance (jumps)"/>
      </params>
      <actions>
        <set_value name="$filteredOffers" exact="[]"/>
        <set_value name="$filteredCount" exact="0"/>
        <do_all exact="$offersList.count" counter="$i">
          <set_value name="$offer" exact="$offersList.{$i}"/>
          <set_value name="$targetSector" exact="$offer.owner.sector"/>
          
          <!-- Calculate range-only distance (using library function) -->
          <run_actions ref="md.GT_Libraries_Pathfinding.GT_CalculateRangeOnlyDistance" result="$distance">
            <param name="fromSector" value="$homeSector"/>
            <param name="toSector" value="$targetSector"/>
          </run_actions>
          
          <!-- Keep offer if within max distance and path exists (distance >= 0) -->
          <do_if value="$distance ge 0 and $distance le $maxDistance">
            <append_to_list name="$filteredOffers" exact="$offer"/>
          </do_if>
          <do_else>
            <set_value name="$filteredCount" exact="$filteredCount + 1"/>
          </do_else>
        </do_all>
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$FilteredOffers" exact="$filteredOffers"/>
        <set_value name="$result.$FilteredCount" exact="$filteredCount"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Sort and Limit Offers -->
    <library name="GT_SortAndLimitOffers" purpose="run_actions">
      <params>
        <param name="offersList" comment="List of offers to sort and limit"/>
        <param name="maxCount" comment="Maximum number of offers to return"/>
        <param name="sortAscending" default="true" comment="If true, sort ascending (take first N), if false sort descending (take last N)"/>
      </params>
      <actions>
        <set_value name="$offers" exact="$offersList"/>
        <!-- Sort by relativeprice -->
        <sort_trades name="$offers" tradelist="$offers" sorter="relativeprice"/>
        
        <set_value name="$limitedOffers" exact="[]"/>
        <do_if value="$sortAscending">
          <!-- Take first N offers (lowest price for buy offers) -->
          <set_value name="$limitCount" exact="[$offers.count, $maxCount].min"/>
          <do_all exact="$limitCount" counter="$idx">
            <append_to_list name="$limitedOffers" exact="$offers.{$idx}"/>
          </do_all>
        </do_if>
        <do_else>
          <!-- Take last N offers (highest price for sell offers) -->
          <do_if value="$offers.count gt $maxCount">
            <set_value name="$startIndex" exact="$offers.count - $maxCount + 1"/>
            <do_all exact="$maxCount" counter="$idx">
              <set_value name="$actualIndex" exact="$startIndex + $idx - 1"/>
              <append_to_list name="$limitedOffers" exact="$offers.{$actualIndex}"/>
            </do_all>
          </do_if>
          <do_else>
            <!-- Less than limit, take all -->
            <do_all exact="$offers.count" counter="$idx">
              <append_to_list name="$limitedOffers" exact="$offers.{$idx}"/>
            </do_all>
          </do_else>
        </do_else>
        <return value="$limitedOffers"/>
      </actions>
    </library>
    
    <!-- Sort Trades By Score (highest first) -->
    <library name="GT_SortTradesByScore" purpose="run_actions">
      <params>
        <param name="tradeList" comment="List of trades to sort"/>
      </params>
      <actions>
        <!-- Optimize sort for small lists (≤10 items: O(n) vs O(n²)) -->
        <do_if value="$tradeList? and $tradeList.count gt 1">
          <do_if value="$tradeList.count gt 10">
            <!-- Large list: Full selection sort (necessary for proper ordering) -->
            <set_value name="$sortedTradeList" exact="[]"/>
            <set_value name="$remainingTrades" exact="$tradeList"/>
            <do_all exact="$tradeList.count" counter="$sortIdx">
              <set_value name="$maxScore" exact="-999999999"/>
              <set_value name="$maxIdx" exact="-1"/>
              <do_all exact="$remainingTrades.count" counter="$i">
                <set_value name="$trade" exact="$remainingTrades.{$i}"/>
                <set_value name="$tradeScore" exact="$trade.$Score"/>
                <do_if value="$tradeScore gt $maxScore">
                  <set_value name="$maxScore" exact="$tradeScore"/>
                  <set_value name="$maxIdx" exact="$i"/>
                </do_if>
              </do_all>
              <do_if value="$maxIdx ge 0">
                <append_to_list name="$sortedTradeList" exact="$remainingTrades.{$maxIdx}"/>
                <remove_value name="$remainingTrades.{$maxIdx}"/>
              </do_if>
            </do_all>
            <set_value name="$tradeList" exact="$sortedTradeList"/>
          </do_if>
          <do_elseif value="$tradeList.count gt 1">
            <!-- Small list (2-10): Single pass bubble-like sort (O(nÂ²) but n is small) -->
            <set_value name="$sortedTradeList" exact="$tradeList"/>
            <!-- Single pass: swap adjacent elements if wrong order (n-1 comparisons) -->
            <do_all exact="$tradeList.count - 1" counter="$pass">
              <set_value name="$swapped" exact="false"/>
              <do_all exact="$tradeList.count - 1 - $pass" counter="$i">
                <set_value name="$currentScore" exact="$sortedTradeList.{$i}.$Score"/>
                <set_value name="$nextScore" exact="$sortedTradeList.{$i + 1}.$Score"/>
                <do_if value="$currentScore lt $nextScore">
                  <!-- Swap -->
                  <set_value name="$temp" exact="$sortedTradeList.{$i}"/>
                  <set_value name="$sortedTradeList.{$i}" exact="$sortedTradeList.{$i + 1}"/>
                  <set_value name="$sortedTradeList.{$i + 1}" exact="$temp"/>
                  <set_value name="$swapped" exact="true"/>
                </do_if>
              </do_all>
              <!-- Early exit if no swaps (already sorted) -->
              <do_if value="not $swapped">
                <break/>
              </do_if>
            </do_all>
            <set_value name="$tradeList" exact="$sortedTradeList"/>
          </do_elseif>
          <!-- Single item or empty: no sort needed -->
        </do_if>
        <return value="$tradeList"/>
      </actions>
    </library>
    
    <!-- Filter Trade For Ship (ware basket, illegal, blacklist, path availability) -->
    <library name="GT_FilterTradeForShip" purpose="run_actions">
      <params>
        <param name="trade" comment="Trade to filter"/>
        <param name="ship" comment="Ship that would execute the trade"/>
        <param name="ware" comment="Ware being traded"/>
        <param name="wareBasket" comment="Allowed ware basket (empty = all wares allowed)"/>
        <param name="allowIllegal" default="false" comment="Whether to allow illegal wares"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group"/>
        <param name="currentSector" comment="Ship's current sector"/>
        <param name="buySector" comment="Buy station sector"/>
        <param name="sellSector" comment="Sell station sector"/>
        <param name="filterStats" default="null" comment="Optional filter statistics table to update"/>
        <param name="isIntraSectorTrade" default="false" comment="Whether this is an intra-sector trade"/>
      </params>
      <actions>
        <!-- Initialize result -->
        <set_value name="$isAllowed" exact="true"/>
        <set_value name="$filterReason" exact="''"/>
        
        <!-- Skip wares ship cannot carry -->
        <!-- Some wares (like Methane/gas, Feststoffe/solids) require special cargo bays -->
        <set_value name="$canCarryWareType" exact="false"/>
        <do_if value="$ware? and $ware != null">
          <!-- Check if ship has cargo bay capacity for this specific ware type -->
          <set_value name="$canCarryWareType" exact="$ship.cargo.{$ware}.max gt 0"/>
        </do_if>
        <do_if value="not $canCarryWareType">
          <set_value name="$isAllowed" exact="false"/>
          <set_value name="$filterReason" exact="'incompatible_cargo'"/>
          <do_if value="$filterStats?">
            <!-- Track in filter stats if provided -->
            <do_if value="not $filterStats.$filteredByIncompatibleCargo?">
              <set_value name="$filterStats.$filteredByIncompatibleCargo" exact="0"/>
            </do_if>
            <set_value name="$filterStats.$filteredByIncompatibleCargo" exact="$filterStats.$filteredByIncompatibleCargo + 1"/>
          </do_if>
          <!-- Return early - ship cannot carry this ware type -->
          <set_value name="$result" exact="table[]"/>
          <set_value name="$result.$IsAllowed" exact="$isAllowed"/>
          <set_value name="$result.$FilterReason" exact="$filterReason"/>
          <return value="$result"/>
        </do_if>
        
        <!-- Cheap checks first (ware basket, illegal) -->
        <!-- Ware basket check -->
        <set_value name="$wareAllowed" exact="true"/>
        <do_if value="$wareBasket? and $wareBasket != null and $wareBasket.count gt 0">
          <run_actions ref="md.GT_Libraries_General.GT_IsWareInBasket" result="$wareAllowed">
            <param name="ware" value="$ware"/>
            <param name="basket" value="$wareBasket"/>
          </run_actions>
          <do_if value="not $wareAllowed">
            <set_value name="$isAllowed" exact="false"/>
            <set_value name="$filterReason" exact="'ware_basket'"/>
            <do_if value="$filterStats?">
              <set_value name="$filterStats.$filteredByWareBasket" exact="$filterStats.$filteredByWareBasket + 1"/>
            </do_if>
            <!-- Early return - skip expensive checks (blacklist, pathfinding) -->
            <set_value name="$result" exact="table[]"/>
            <set_value name="$result.$IsAllowed" exact="$isAllowed"/>
            <set_value name="$result.$FilterReason" exact="$filterReason"/>
            <return value="$result"/>
          </do_if>
        </do_if>
        
        <!-- Illegal ware check -->
        <do_if value="$wareAllowed and not $allowIllegal and @$ware.illegal">
          <set_value name="$wareAllowed" exact="false"/>
          <set_value name="$isAllowed" exact="false"/>
          <set_value name="$filterReason" exact="'illegal'"/>
          <do_if value="$filterStats?">
            <set_value name="$filterStats.$filteredByIllegal" exact="$filterStats.$filteredByIllegal + 1"/>
          </do_if>
          <!-- âœ… PERFORMANCE OPTIMIZATION: Early return - skip expensive checks (blacklist, pathfinding) -->
          <set_value name="$result" exact="table[]"/>
          <set_value name="$result.$IsAllowed" exact="$isAllowed"/>
          <set_value name="$result.$FilterReason" exact="$filterReason"/>
          <return value="$result"/>
        </do_if>
        
        <!-- âœ… PERFORMANCE OPTIMIZATION: Expensive checks only if cheap checks pass -->
        <!-- Blacklist check -->
        <set_value name="$isBlacklisted" exact="false"/>
        <do_if value="$wareAllowed">
          <!-- âœ… FIX: Block intra-sector trades in blacklisted sectors (force escape) -->
          <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$currentSectorIsBlacklisted">
            <param name="sector" value="$currentSector"/>
            <param name="ship" value="$ship"/>
            <param name="blacklistgroup" value="$blacklistgroup"/>
          </run_actions>
          <do_if value="$currentSectorIsBlacklisted">
            <do_if value="$buySector == $currentSector and $sellSector == $currentSector">
              <!-- Intra-sector trade in blacklisted sector - BLOCK to force escape -->
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_intra'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check buy station blacklist -->
          <do_if value="not $isBlacklisted">
            <set_value name="$buyStation" exact="@$trade.$BuyStation"/>
            <run_actions ref="md.GT_Libraries_Blacklist.GT_IsStationBlacklisted" result="$buyStationBlacklisted">
              <param name="station" value="$buyStation"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$buyStationBlacklisted">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_buy_station'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check sell station blacklist -->
          <do_if value="not $isBlacklisted">
            <set_value name="$sellStation" exact="@$trade.$SellStation"/>
            <run_actions ref="md.GT_Libraries_Blacklist.GT_IsStationBlacklisted" result="$sellStationBlacklisted">
              <param name="station" value="$sellStation"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$sellStationBlacklisted">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_sell_station'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check buy sector blacklist -->
          <do_if value="not $isBlacklisted">
            <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$buySectorBlacklisted">
              <param name="sector" value="$buySector"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$buySectorBlacklisted">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_buy_sector'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check sell sector blacklist -->
          <do_if value="not $isBlacklisted">
            <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$sellSectorBlacklisted">
              <param name="sector" value="$sellSector"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$sellSectorBlacklisted">
              <do_if value="$sellSector != $currentSector">
                <!-- Ship needs to travel TO a blacklisted sector - BLOCK -->
                <set_value name="$isBlacklisted" exact="true"/>
                <set_value name="$isAllowed" exact="false"/>
                <set_value name="$filterReason" exact="'blacklist_sell_sector'"/>
                <do_if value="$filterStats?">
                  <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
                </do_if>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Path availability check -->
          <do_if value="not $isBlacklisted">
            <run_actions ref="md.GT_Libraries_Pathfinding.GT_CalculateTradePathDistances" result="$pathResult">
              <param name="ship" value="$ship"/>
              <param name="currentSector" value="$currentSector"/>
              <param name="buySector" value="$buySector"/>
              <param name="sellSector" value="$sellSector"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            
            <!-- Debug logging (if enabled) -->
            <!-- âœ… FIX: Only log intra-sector trades for isolated ships (they're common for non-isolated ships) -->
            <!-- Always log unreachable paths as they indicate problems -->
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <set_value name="$shouldLogIntraSector" exact="false"/>
              <do_if value="$pathResult.$IsIntraSectorTrade">
                <!-- Check if ship is isolated - only log intra-sector trades for isolated ships -->
                <do_if value="$currentSector?">
                  <run_actions ref="md.GT_Libraries_Blacklist.GT_CheckConnectedSectorsBlacklisted" result="$isolationCheck">
                    <param name="sector" value="$currentSector"/>
                    <param name="ship" value="$ship"/>
                    <param name="returnDetails" value="false"/>
                  </run_actions>
                  <set_value name="$isolatedValue" exact="@$isolationCheck.$IsIsolated"/>
                  <set_value name="$shouldLogIntraSector" exact="if $isolatedValue? and ($isolatedValue == true or $isolatedValue == 1) then true else false"/>
                </do_if>
              </do_if>
              <do_if value="$shouldLogIntraSector or not $pathResult.$IsReachable">
                <set_value name="$buySectorName" exact="@$buySector.knownname"/>
                <set_value name="$sellSectorName" exact="@$sellSector.knownname"/>
                <set_value name="$currentSectorName" exact="@$currentSector.knownname"/>
                <set_value name="$wareName" exact="@$ware.name"/>
                <set_value name="$tradeType" exact="if $pathResult.$IsIntraSectorTrade then 'INTRA-SECTOR' else 'CROSS-SECTOR'"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Resume] ' + $ship.idcode + ': ' + $tradeType + ' trade (' + $wareName + '):' +
                    '\n  Current sector: ' + $currentSectorName + ' (blacklisted: ' + $pathResult.$CurrentSectorIsBlacklisted + ')' +
                    '\n  Buy sector: ' + $buySectorName + ' (distance: ' + $pathResult.$BuyPathDistance + ', same as current: ' + ($buySector == $currentSector) + ')' +
                    '\n  Sell sector: ' + $sellSectorName + ' (distance: ' + $pathResult.$SellPathDistance + ', same as buy: ' + ($sellSector == $buySector) + ', same as current: ' + ($sellSector == $currentSector) + ')' +
                    (if not $pathResult.$IsReachable then ' [PATH BLOCKED]' else '')"
                    chance="100"/>
                </do_if>
              </do_if>
            </do_if>
            
            <!-- Block if paths are unreachable -->
            <do_if value="not $pathResult.$IsReachable">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'path_blocked'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByPathBlocked" exact="$filterStats.$filteredByPathBlocked + 1"/>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Return result -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IsAllowed" exact="$isAllowed"/>
        <set_value name="$result.$FilterReason" exact="$filterReason"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Build Docking Cache -->
    <library name="GT_BuildDockingCache" purpose="run_actions">
      <params>
        <param name="sellOffers" comment="List of sell offers"/>
        <param name="buyOffers" comment="List of buy offers"/>
        <param name="ship" comment="Ship to check docking for"/>
      </params>
      <actions>
        <set_value name="$dockingCache" exact="table[]"/>
        <set_value name="$uniqueStations" exact="table[]"/>
        
        <!-- Collect all unique stations from sell offers -->
        <do_all exact="$sellOffers.count" counter="$i">
          <set_value name="$offer" exact="$sellOffers.{$i}"/>
          <set_value name="$station" exact="@$offer.owner"/>
          <!-- Validate station is valid before using as table key -->
          <set_value name="$stationValid" exact="false"/>
          <do_if value="$station? and not ($station == null)">
            <set_value name="$stationId" exact="@$station.idcode"/>
            <do_if value="$stationId?">
              <set_value name="$stationValid" exact="true"/>
            </do_if>
          </do_if>
          <do_if value="$stationValid and $station? and not ($station == null)">
            <do_if value="not $uniqueStations.{$station}?">
              <set_value name="$uniqueStations.{$station}" exact="true"/>
            </do_if>
          </do_if>
        </do_all>
        
        <!-- Collect all unique stations from buy offers -->
        <do_all exact="$buyOffers.count" counter="$i">
          <set_value name="$offer" exact="$buyOffers.{$i}"/>
          <set_value name="$station" exact="@$offer.owner"/>
          <!-- Validate station is valid before using as table key -->
          <set_value name="$stationValid" exact="false"/>
          <do_if value="$station? and not ($station == null)">
            <set_value name="$stationId" exact="@$station.idcode"/>
            <do_if value="$stationId?">
              <set_value name="$stationValid" exact="true"/>
            </do_if>
          </do_if>
          <do_if value="$stationValid and $station? and not ($station == null)">
            <do_if value="not $uniqueStations.{$station}?">
              <set_value name="$uniqueStations.{$station}" exact="true"/>
            </do_if>
          </do_if>
        </do_all>
        
        <!-- Pre-cache docking permissions for all unique stations -->
        <do_all exact="$uniqueStations.keys.count" counter="$stationIdx">
          <set_value name="$station" exact="$uniqueStations.keys.{$stationIdx}"/>
          <set_value name="$canDock" exact="@$station.dockingallowed.{$ship}"/>
          <set_value name="$dockingCache.{$station}" exact="$canDock"/>
        </do_all>
        
        <return value="$dockingCache"/>
      </actions>
    </library>
    
    <!-- Separate Offers By Sector -->
    <library name="GT_SeparateOffersBySector" purpose="run_actions">
      <params>
        <param name="sellOffers" comment="List of sell offers"/>
        <param name="buyOffers" comment="List of buy offers"/>
        <param name="currentSector" comment="Current sector to compare against"/>
      </params>
      <actions>
        <set_value name="$intraSectorSellOffers" exact="[]"/>
        <set_value name="$intraSectorBuyOffers" exact="[]"/>
        <set_value name="$crossSectorSellOffers" exact="[]"/>
        <set_value name="$crossSectorBuyOffers" exact="[]"/>
        
        <!-- âœ… FIX: Validate currentSector is set and not null -->
        <do_if value="not $currentSector?">
          <!-- If currentSector is null, all offers are cross-sector -->
          <set_value name="$crossSectorSellOffers" exact="$sellOffers"/>
          <set_value name="$crossSectorBuyOffers" exact="$buyOffers"/>
        </do_if>
        <do_else>
          <!-- Separate sell offers -->
          <do_all exact="$sellOffers.count" counter="$idx">
            <set_value name="$offer" exact="$sellOffers.{$idx}"/>
            <set_value name="$offerSector" exact="@$offer.owner.sector"/>
            <!-- âœ… FIX: Compare sectors directly - == should work for same component reference -->
            <do_if value="$offerSector? and $offerSector == $currentSector">
              <append_to_list name="$intraSectorSellOffers" exact="$offer"/>
            </do_if>
            <do_else>
              <append_to_list name="$crossSectorSellOffers" exact="$offer"/>
            </do_else>
          </do_all>
          
          <!-- Separate buy offers -->
          <do_all exact="$buyOffers.count" counter="$idx">
            <set_value name="$offer" exact="$buyOffers.{$idx}"/>
            <set_value name="$offerSector" exact="@$offer.owner.sector"/>
            <!-- âœ… FIX: Compare sectors directly - == should work for same component reference -->
            <do_if value="$offerSector? and $offerSector == $currentSector">
              <append_to_list name="$intraSectorBuyOffers" exact="$offer"/>
            </do_if>
            <do_else>
              <append_to_list name="$crossSectorBuyOffers" exact="$offer"/>
            </do_else>
          </do_all>
        </do_else>
        
        <!-- Return result table -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IntraSectorSell" exact="$intraSectorSellOffers"/>
        <set_value name="$result.$IntraSectorBuy" exact="$intraSectorBuyOffers"/>
        <set_value name="$result.$CrossSectorSell" exact="$crossSectorSellOffers"/>
        <set_value name="$result.$CrossSectorBuy" exact="$crossSectorBuyOffers"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Calculate Trade Thresholds -->
    <library name="GT_CalculateTradeThresholds" purpose="run_actions">
      <params>
        <param name="minROI" comment="Base minimum ROI"/>
        <param name="minAbsoluteProfit" comment="Base minimum profit"/>
        <param name="useAdvancedAnalytics" default="false" comment="Apply 95% multiplier"/>
        <param name="isIntraSector" default="false" comment="Is intra-sector trade"/>
        <param name="isIsolated" default="false" comment="Is ship isolated"/>
      </params>
      <actions>
        <set_value name="$roiThreshold" exact="$minROI"/>
        <set_value name="$profitThreshold" exact="$minAbsoluteProfit"/>
        
        <!-- Apply advanced analytics adjustment -->
        <!-- âœ… FIX: Use integer math to avoid floating-point to money conversion warnings -->
        <!-- CRITICAL: $profitThreshold is already in raw format (centicredits), so don't use Cr suffix -->
        <do_if value="$useAdvancedAnalytics">
          <set_value name="$roiThreshold" exact="$roiThreshold * 0.95"/>
          <set_value name="$profitThreshold" exact="$profitThreshold * 95 / 100"/>
        </do_if>
        
        <!-- Apply intra-sector/isolation adjustments -->
        <!-- âœ… FIX: Use integer math to avoid floating-point to money conversion warnings -->
        <!-- CRITICAL: $profitThreshold is already in raw format (centicredits), so divide by 2 (or multiply by 50/100) without Cr suffix -->
        <do_if value="$isIntraSector">
          <do_if value="$isIsolated">
            <!-- Isolated intra-sector: 25% of threshold -->
            <set_value name="$roiThreshold" exact="$roiThreshold * 0.25"/>
            <set_value name="$profitThreshold" exact="$profitThreshold * 25 / 100"/>
          </do_if>
          <do_else>
            <!-- Normal intra-sector: 50% of threshold -->
            <set_value name="$roiThreshold" exact="$roiThreshold * 0.5"/>
            <set_value name="$profitThreshold" exact="$profitThreshold / 2"/>
          </do_else>
        </do_if>
        
        <!-- Return result table -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$ROIThreshold" exact="$roiThreshold"/>
        <set_value name="$result.$ProfitThreshold" exact="$profitThreshold"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Create Trade Object -->
    <library name="GT_CreateTradeObject" purpose="run_actions">
      <params>
        <param name="sellOffer" comment="Sell offer"/>
        <param name="buyOffer" comment="Buy offer"/>
        <param name="sellStation" comment="Sell station"/>
        <param name="buyStation" comment="Buy station"/>
        <param name="amount" comment="Trade amount"/>
        <param name="profit" comment="Trade profit"/>
        <param name="roi" comment="Trade ROI"/>
        <param name="efficiency" comment="Trade efficiency score"/>
        <param name="buyPrice" comment="Buy price"/>
        <param name="sellPrice" comment="Sell price"/>
        <param name="distance" default="0" comment="Route distance"/>
        <param name="risk" default="0" comment="Trade risk"/>
      </params>
      <actions>
        <set_value name="$trade" exact="table[
          $BuyOffer = $sellOffer,
          $SellOffer = $buyOffer,
          $BuyStation = $sellStation,
          $SellStation = $buyStation,
          $Amount = $amount,
          $Profit = $profit,
          $ROI = $roi,
          $Score = $efficiency,
          $BuyPrice = $buyPrice,
          $SellPrice = $sellPrice,
          $Distance = $distance,
          $Risk = $risk
        ]"/>
        <return value="$trade"/>
      </actions>
    </library>
    
    <!-- Add Intra-Sector Offers -->
    <library name="GT_AddIntraSectorOffers" purpose="run_actions">
      <params>
        <param name="originalSellOffers" comment="Original sell offers before limiting"/>
        <param name="originalBuyOffers" comment="Original buy offers before limiting"/>
        <param name="limitedSellOffers" comment="Limited sell offers (will be modified)"/>
        <param name="limitedBuyOffers" comment="Limited buy offers (will be modified)"/>
        <param name="currentSector" comment="Current sector"/>
        <param name="currentSectorIsBlacklisted" default="false" comment="Is current sector blacklisted"/>
      </params>
      <actions>
        <set_value name="$addedSellCount" exact="0"/>
        <set_value name="$addedBuyCount" exact="0"/>
        
        <!-- Only add intra-sector offers if current sector is not blacklisted -->
        <do_if value="$currentSector? and not $currentSectorIsBlacklisted">
          <!-- Scan original sell offers for intra-sector ones not in limited list -->
          <do_all exact="$originalSellOffers.count" counter="$idx">
            <set_value name="$offer" exact="$originalSellOffers.{$idx}"/>
            <set_value name="$offerSector" exact="@$offer.owner.sector"/>
            <do_if value="$offerSector? and $offerSector == $currentSector">
              <!-- Check if already in limited list -->
              <set_value name="$alreadyIncluded" exact="false"/>
              <do_all exact="$limitedSellOffers.count" counter="$checkIdx">
                <do_if value="$limitedSellOffers.{$checkIdx} == $offer">
                  <set_value name="$alreadyIncluded" exact="true"/>
                  <break/>
                </do_if>
              </do_all>
              <!-- Add if not already included -->
              <do_if value="not $alreadyIncluded">
                <append_to_list name="$limitedSellOffers" exact="$offer"/>
                <set_value name="$addedSellCount" operation="add"/>
              </do_if>
            </do_if>
          </do_all>
          
          <!-- Scan original buy offers for intra-sector ones not in limited list -->
          <do_all exact="$originalBuyOffers.count" counter="$idx">
            <set_value name="$offer" exact="$originalBuyOffers.{$idx}"/>
            <set_value name="$offerSector" exact="@$offer.owner.sector"/>
            <do_if value="$offerSector? and $offerSector == $currentSector">
              <!-- Check if already in limited list -->
              <set_value name="$alreadyIncluded" exact="false"/>
              <do_all exact="$limitedBuyOffers.count" counter="$checkIdx">
                <do_if value="$limitedBuyOffers.{$checkIdx} == $offer">
                  <set_value name="$alreadyIncluded" exact="true"/>
                  <break/>
                </do_if>
              </do_all>
              <!-- Add if not already included -->
              <do_if value="not $alreadyIncluded">
                <append_to_list name="$limitedBuyOffers" exact="$offer"/>
                <set_value name="$addedBuyCount" operation="add"/>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
        
        <!-- Return result table -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$UpdatedSellOffers" exact="$limitedSellOffers"/>
        <set_value name="$result.$UpdatedBuyOffers" exact="$limitedBuyOffers"/>
        <set_value name="$result.$AddedSellCount" exact="$addedSellCount"/>
        <set_value name="$result.$AddedBuyCount" exact="$addedBuyCount"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Validate Trade Offer Pair -->
    <library name="GT_ValidateTradeOfferPair" purpose="run_actions">
      <params>
        <param name="sellOffer" comment="Sell offer to validate"/>
        <param name="buyOffer" comment="Buy offer to validate"/>
      </params>
      <actions>
        <!-- Validate sell offer -->
        <set_value name="$sellOfferOwner" exact="@$sellOffer.owner"/>
        <set_value name="$sellOfferPrice" exact="@$sellOffer.unitprice"/>
        <do_if value="not $sellOffer? or not $sellOfferOwner? or not $sellOfferPrice?">
          <return value="false"/>
        </do_if>
        
        <!-- Validate buy offer -->
        <set_value name="$buyOfferOwner" exact="@$buyOffer.owner"/>
        <set_value name="$buyOfferPrice" exact="@$buyOffer.unitprice"/>
        <do_if value="not $buyOffer? or not $buyOfferOwner? or not $buyOfferPrice?">
          <return value="false"/>
        </do_if>
        
        <!-- Different stations only -->
        <do_if value="$sellOfferOwner == $buyOfferOwner">
          <return value="false"/>
        </do_if>
        
        <return value="true"/>
      </actions>
    </library>
    
    <!-- Check Failed Sector Pair -->
    <library name="GT_CheckFailedSectorPair" purpose="run_actions">
      <params>
        <param name="buySector" comment="Buy station sector"/>
        <param name="sellSector" comment="Sell station sector"/>
        <param name="failedTrades" comment="List of failed trades to check against"/>
      </params>
      <actions>
        <set_value name="$isFailed" exact="false"/>
        <do_if value="$failedTrades.count gt 0">
          <do_all exact="$failedTrades.count" counter="$failIdx">
            <set_value name="$failedTrade" exact="$failedTrades.{$failIdx}"/>
            <do_if value="$failedTrade.$BuySector? and $failedTrade.$SellSector?">
              <do_if value="$buySector == $failedTrade.$BuySector and $sellSector == $failedTrade.$SellSector">
                <set_value name="$isFailed" exact="true"/>
                <break/>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
        <return value="$isFailed"/>
      </actions>
    </library>
    
    <!-- Check Route Conflict -->
    <library name="GT_CheckRouteConflict" purpose="run_actions">
      <params>
        <param name="sellStation" comment="Sell station"/>
        <param name="buyStation" comment="Buy station"/>
        <param name="ware" comment="Ware being traded"/>
        <param name="reservedRoutes" comment="List of reserved route keys"/>
      </params>
      <actions>
        <set_value name="$isConflicted" exact="false"/>
        <do_if value="$reservedRoutes.count gt 0">
          <set_value name="$tradeCacheKey" exact="$sellStation.idcode + '_' + $buyStation.idcode + '_' + $ware"/>
          <!-- FIX: Use explicit loop instead of unreliable indexof check -->
          <do_all exact="$reservedRoutes.count" counter="$i">
            <do_if value="$reservedRoutes.{$i} == $tradeCacheKey">
              <set_value name="$isConflicted" exact="true"/>
              <break/>
            </do_if>
          </do_all>
        </do_if>
        <return value="$isConflicted"/>
      </actions>
    </library>
    
    <!-- Update Trade Quota -->
    <library name="GT_UpdateTradeQuota" purpose="run_actions">
      <params>
        <param name="tradesPerWare" comment="Table of trades per ware (may be null or invalid)"/>
        <param name="ware" comment="Ware to update quota for"/>
        <param name="increment" default="1" comment="Amount to increment"/>
      </params>
      <actions>
        <!-- Ensure tradesPerWare is a valid table -->
        <set_value name="$validTable" exact="$tradesPerWare"/>
        <set_value name="$keysCheck" exact="@$validTable.keys"/>
        <set_value name="$countCheck" exact="@$keysCheck.count"/>
        <do_if value="not $countCheck? or $countCheck lt 0">
          <set_value name="$validTable" exact="table[]"/>
        </do_if>
        
        <!-- Get current count for this ware -->
        <set_value name="$currentCount" exact="0"/>
        <do_if value="$validTable.{$ware}?">
          <set_value name="$currentCount" exact="$validTable.{$ware}"/>
        </do_if>
        
        <!-- Update count -->
        <set_value name="$newCount" exact="$currentCount + $increment"/>
        <set_value name="$validTable.{$ware}" exact="$newCount"/>
        
        <!-- Return updated table and new count -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$UpdatedTable" exact="$validTable"/>
        <set_value name="$result.$NewCount" exact="$newCount"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Clear Pending Trade Data -->
    <!-- âœ… EXTRACTED: Cleanup function for pending trade data to avoid code duplication -->
    <library name="GT_ClearPendingTradeData" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to clear pending trade data for"/>
      </params>
      <actions>
        <!-- Clear pending trade list -->
        <do_if value="global.$GT_PendingTrades? and global.$GT_PendingTrades.{$ship}?">
          <remove_value name="global.$GT_PendingTrades.{$ship}"/>
        </do_if>
        
        <!-- Clear search method tracking -->
        <do_if value="global.$GT_PendingTradesSearchMethod? and global.$GT_PendingTradesSearchMethod.{$ship}?">
          <remove_value name="global.$GT_PendingTradesSearchMethod.{$ship}"/>
        </do_if>
      </actions>
    </library>
    
    <!-- ========================================= -->
    <!-- CACHE UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Calculate Total Cache Count -->
    <library name="GT_CalculateTotalCacheCount" purpose="run_actions">
      <params>
      </params>
      <actions>
        <!-- âœ… PERFORMANCE OPTIMIZATION v5: Calculate total cache count from all home sectors -->
        <!-- global.$GT_TradeCache is now a table indexed by home sector -->
        <!-- Returns total count of all trades across all home sector caches -->
        <set_value name="$totalCount" exact="0"/>
        <do_if value="global.$GT_TradeCache?">
          <do_all exact="global.$GT_TradeCache.keys.count" counter="$sectorIdx">
            <set_value name="$sectorCache" exact="global.$GT_TradeCache.{global.$GT_TradeCache.keys.{$sectorIdx}}"/>
            <do_if value="$sectorCache? and $sectorCache.count?">
              <set_value name="$totalCount" exact="$totalCount + $sectorCache.count"/>
            </do_if>
          </do_all>
        </do_if>
        <return value="$totalCount"/>
      </actions>
    </library>
    
    <!-- Get Home Sector Cache -->
    <library name="GT_GetHomeSectorCache" purpose="run_actions">
      <params>
        <param name="homeSector" comment="Home sector to get cache for"/>
      </params>
      <actions>
        <!-- Returns the cache list for a specific home sector, or null if not found -->
        <!-- âœ… PERFORMANCE OPTIMIZATION v5: Per-home-sector cache -->
        <set_value name="$cache" exact="null"/>
        <do_if value="$homeSector? and $homeSector.exists and global.$GT_TradeCache? and global.$GT_TradeCache.{$homeSector}?">
          <set_value name="$cache" exact="global.$GT_TradeCache.{$homeSector}"/>
        </do_if>
        <return value="$cache"/>
      </actions>
    </library>
    
    <!-- Calculate Fallback Distance -->
    <library name="GT_CalculateFallbackDistance" purpose="run_actions">
      <params>
        <param name="maxDistance" comment="Maximum distance (pilot's maxJumps)"/>
        <param name="skillLevel" comment="Pilot skill level (for capping fallback distance)"/>
      </params>
      <actions>
        <!-- Calculates fallback search distance: max(1, min(pilotMaxJumps, maxDistance / 3)) -->
        <!-- Formula: 1/3 of maxDistance, capped by pilot level capability, minimum 1 jump -->
        <!-- This compensates for lower profit thresholds in fallback search -->
        
        <!-- Calculate pilot's max jump capability based on skill level -->
        <set_value name="$pilotMaxJumps" exact="1"/>
        <do_if value="$skillLevel le 2">
          <set_value name="$pilotMaxJumps" exact="1"/>
        </do_if>
        <do_elseif value="$skillLevel le 5">
          <set_value name="$pilotMaxJumps" exact="3"/>
        </do_elseif>
        <do_elseif value="$skillLevel le 8">
          <set_value name="$pilotMaxJumps" exact="5"/>
        </do_elseif>
        <do_elseif value="$skillLevel le 11">
          <set_value name="$pilotMaxJumps" exact="10"/>
        </do_elseif>
        <do_elseif value="$skillLevel le 13">
          <set_value name="$pilotMaxJumps" exact="15"/>
        </do_elseif>
        <do_else>
          <set_value name="$pilotMaxJumps" exact="25"/>
        </do_else>
        
        <!-- Calculate 1/3 of maxDistance -->
        <set_value name="$calculatedDistance" exact="($maxDistance / 3)"/>
        
        <!-- Cap by pilot capability, then ensure minimum of 1 -->
        <set_value name="$fallbackDistance" exact="[$calculatedDistance, $pilotMaxJumps].min"/>
        <set_value name="$fallbackDistance" exact="[$fallbackDistance, 1].max"/>  <!-- Minimum: 1 jump -->
        
        <return value="$fallbackDistance"/>
      </actions>
    </library>
    
    <!-- Check Batch Status -->
    <library name="GT_CheckBatchStatus" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to check batch status for"/>
      </params>
      <actions>
        <!-- Checks if batch processing is in progress and returns status information -->
        <!-- Returns table with: $IsBatchActive, $BatchShip, $ShouldProceed, $IsForThisShip -->
        <set_value name="$waitingForBatch" exact="false"/>
        <set_value name="$batchShip" exact="null"/>
        <do_if value="global.$GT_SearchResult.{$ship}?">
          <set_value name="$shipResults" exact="global.$GT_SearchResult.{$ship}"/>
          <do_if value="$shipResults.$WaitingForBatch? and $shipResults.$WaitingForBatch">
            <set_value name="$waitingForBatch" exact="true"/>
            <do_if value="$shipResults.$Ship?">
              <set_value name="$batchShip" exact="$shipResults.$Ship"/>
            </do_if>
          </do_if>
        </do_if>
        
        <set_value name="$isForThisShip" exact="false"/>
        <do_if value="$waitingForBatch and $batchShip? and $batchShip == $ship">
          <set_value name="$isForThisShip" exact="true"/>
        </do_if>
        
        <set_value name="$shouldProceed" exact="true"/>
        <do_if value="$waitingForBatch and $isForThisShip">
          <set_value name="$shouldProceed" exact="false"/>
        </do_if>
        
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IsBatchActive" exact="$waitingForBatch"/>
        <set_value name="$result.$BatchShip" exact="$batchShip"/>
        <set_value name="$result.$ShouldProceed" exact="$shouldProceed"/>
        <set_value name="$result.$IsForThisShip" exact="$isForThisShip"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Update Rejection Stats -->
    <library name="GT_UpdateRejectionStats" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to update stats for"/>
        <param name="stats" comment="Rejection statistics table"/>
      </params>
      <actions>
        <!-- Updates LastRejectionStats in global.$GT_SearchResult for a ship -->
        <!-- Preserves existing entries for other ships, updates/adds entry for this ship -->
        <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_SearchResult exists -->
        <set_value name="$existingLastRejectionStats" exact="null"/>
        <do_if value="global.$GT_SearchResult.$LastRejectionStats?">
          <set_value name="$existingLastRejectionStats" exact="global.$GT_SearchResult.$LastRejectionStats"/>
        </do_if>
        
        <!-- Build new $LastRejectionStats: preserve existing entries, update/add per-ship entry -->
        <set_value name="$newLastRejectionStats" exact="table[]"/>
        <!-- Copy existing entries if valid -->
        <do_if value="$existingLastRejectionStats?">
          <set_value name="$existingStatsKeys" exact="@$existingLastRejectionStats.keys"/>
          <do_if value="$existingStatsKeys?">
            <set_value name="$existingStatsKeysCount" exact="@$existingStatsKeys.count"/>
            <do_if value="$existingStatsKeysCount? and $existingStatsKeysCount gt 0">
              <do_all exact="$existingStatsKeysCount" counter="$k">
                <set_value name="$key" exact="$existingStatsKeys.{$k}"/>
                <do_if value="$key != $ship">
                  <set_value name="$newLastRejectionStats.{$key}" exact="@$existingLastRejectionStats.{$key}"/>
                </do_if>
              </do_all>
            </do_if>
          </do_if>
        </do_if>
        <!-- Add/update per-ship entry -->
        <set_value name="$newLastRejectionStats.{$ship}" exact="$stats"/>
        
        <!-- Build new $searchResultTable: preserve existing properties, set new $LastRejectionStats -->
        <set_value name="$newSearchResultTable" exact="table[$LastRejectionStats = $newLastRejectionStats]"/>
        <!-- Copy other existing properties -->
        <set_value name="$existingSearchResult" exact="global.$GT_SearchResult"/>
        <do_if value="$existingSearchResult?">
          <set_value name="$existingKeys" exact="@$existingSearchResult.keys"/>
          <do_if value="$existingKeys?">
            <set_value name="$existingKeysCount" exact="@$existingKeys.count"/>
            <do_if value="$existingKeysCount? and $existingKeysCount gt 0">
              <do_all exact="$existingKeysCount" counter="$tk">
                <set_value name="$tableKey" exact="$existingKeys.{$tk}"/>
                <do_if value="$tableKey != 'LastRejectionStats'">
                  <set_value name="$newSearchResultTable.{$tableKey}" exact="@$existingSearchResult.{$tableKey}"/>
                </do_if>
              </do_all>
            </do_if>
          </do_if>
        </do_if>
        <!-- Set atomically to global -->
        <set_value name="global.$GT_SearchResult" exact="$newSearchResultTable"/>
      </actions>
    </library>
    
    <!-- Get Price Range -->
    <library name="GT_GetPriceRange" purpose="run_actions">
      <params>
        <param name="shipIsIsolated" default="false" comment="Whether ship is isolated"/>
      </params>
      <actions>
        <!-- Returns price range from config: $sellPriceMax, $buyPriceMin -->
        <!-- For isolated ships, uses isolated-specific price ranges -->
        <set_value name="$sellPriceMax" exact="0.5"/>  <!-- Default fallback -->
        <set_value name="$buyPriceMin" exact="-0.5"/>  <!-- Default fallback -->
        <do_if value="global.$GT_Config? and global.$GT_Config.$Trading?">
          <do_if value="$shipIsIsolated">
            <!-- Isolated ships: Use isolated-specific price ranges -->
            <do_if value="global.$GT_Config.$Trading.$IsolatedSellPriceMax?">
              <set_value name="$sellPriceMax" exact="@global.$GT_Config.$Trading.$IsolatedSellPriceMax"/>
            </do_if>
            <do_if value="global.$GT_Config.$Trading.$IsolatedBuyPriceMin?">
              <set_value name="$buyPriceMin" exact="@global.$GT_Config.$Trading.$IsolatedBuyPriceMin"/>
            </do_if>
          </do_if>
          <do_else>
            <!-- Normal ships: Use standard price ranges -->
            <do_if value="global.$GT_Config.$Trading.$SellPriceMax?">
              <set_value name="$sellPriceMax" exact="@global.$GT_Config.$Trading.$SellPriceMax"/>
            </do_if>
            <do_if value="global.$GT_Config.$Trading.$BuyPriceMin?">
              <set_value name="$buyPriceMin" exact="@global.$GT_Config.$Trading.$BuyPriceMin"/>
            </do_if>
          </do_else>
        </do_if>
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$SellPriceMax" exact="$sellPriceMax"/>
        <set_value name="$result.$BuyPriceMin" exact="$buyPriceMin"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Sort Trades By Distance -->
    <library name="GT_SortTradesByDistance" purpose="run_actions">
      <params>
        <param name="tradesWithDistance" comment="List of trades with Distance field"/>
      </params>
      <actions>
        <!-- Sorts trades by distance (shortest first) using selection sort -->
        <!-- Input: List of tables with $Trade and $Distance fields -->
        <!-- Output: Sorted list (shortest distance first) -->
        <!-- Uses same pattern as original: check if already sorted to avoid duplicates -->
        <set_value name="$sortedTrades" exact="[]"/>
        <do_all exact="$tradesWithDistance.count" counter="$sortIdx">
          <set_value name="$minDistance" exact="999999999"/>
          <set_value name="$minIdx" exact="-1"/>
          <do_all exact="$tradesWithDistance.count" counter="$i">
            <set_value name="$alreadySorted" exact="false"/>
            <do_all exact="$sortedTrades.count" counter="$j">
              <do_if value="$sortedTrades.{$j}.$Trade == $tradesWithDistance.{$i}.$Trade">
                <set_value name="$alreadySorted" exact="true"/>
                <break/>
              </do_if>
            </do_all>
            <do_if value="not $alreadySorted">
              <set_value name="$tradeDistance" exact="@$tradesWithDistance.{$i}.$Distance"/>
              <do_if value="$tradeDistance? and $tradeDistance lt $minDistance">
                <set_value name="$minDistance" exact="$tradeDistance"/>
                <set_value name="$minIdx" exact="$i"/>
              </do_if>
            </do_if>
          </do_all>
          <do_if value="$minIdx ge 0">
            <append_to_list name="$sortedTrades" exact="$tradesWithDistance.{$minIdx}"/>
          </do_if>
        </do_all>
        <return value="$sortedTrades"/>
      </actions>
    </library>
    
    <!-- Calculate Fallback Trade Distances -->
    <library name="GT_CalculateFallbackTradeDistances" purpose="run_actions">
      <params>
        <param name="wareTrades" comment="List of trades for a specific ware"/>
        <param name="ship" comment="Ship executing the trade"/>
        <param name="homeSector" comment="Home sector for distance calculations"/>
        <param name="currentSector" comment="Current sector (ship's current position)"/>
        <param name="maxDistance" comment="Maximum distance from home sector"/>
        <param name="originalMaxDistance" comment="Original max distance (for fallback search)"/>
        <param name="isFallbackSearch" default="false" comment="Whether this is a fallback search"/>
      </params>
      <actions>
        <!-- Calculates distances for fallback search trades -->
        <!-- For fallback search: Filters by CURRENT LOCATION distance (2 jumps max), calculates home distance for reference -->
        <!-- For normal search: Filters by HOME SECTOR distance, calculates current distance for sorting -->
        <!-- Returns: $tradesWithDistance list, $rejectionStats -->
        <set_value name="$tradesWithDistance" exact="[]"/>
        <set_value name="$rejectedByUnreachable" exact="0"/>
        <set_value name="$rejectedByHomeDistance" exact="0"/>
        <set_value name="$evaluatedCount" exact="0"/>
        
        <!-- Get filterMaxDistance (home sector distance limit) -->
        <set_value name="$filterMaxDistance" exact="$maxDistance"/>  <!-- Default: use maxDistance -->
        <do_if value="$isFallbackSearch and $originalMaxDistance?">
          <set_value name="$filterMaxDistance" exact="$originalMaxDistance"/>  <!-- Fallback: use original pilot maxDistance (respects trading range) -->
        </do_if>
        
        <do_all exact="$wareTrades.count" counter="$i">
          <set_value name="$trade" exact="$wareTrades.{$i}"/>
          <set_value name="$buySector" exact="@$trade.$BuyStation.sector"/>
          <set_value name="$sellSector" exact="@$trade.$SellStation.sector"/>
          <set_value name="$buyStation" exact="@$trade.$BuyStation"/>
          <set_value name="$sellStation" exact="@$trade.$SellStation"/>
          <set_value name="$ware" exact="@$trade.$BuyOffer.ware"/>
          
          <do_if value="$isFallbackSearch">
            <!-- FALLBACK SEARCH: Filter by HOME SECTOR distance (respects pilot's trading range) -->
            <!-- Sector list was built from current location, but trades must still respect home sector range -->
            <set_value name="$buyDistance" exact="-1"/>
            <set_value name="$sellDistance" exact="-1"/>
            
            <do_if value="$buySector == $homeSector">
              <set_value name="$buyDistance" exact="0"/>
            </do_if>
            <do_else>
              <set_value name="$buyDistance" exact="$homeSector.gatedistance.{$buySector}"/>
            </do_else>
            
            <do_if value="$sellSector == $homeSector">
              <set_value name="$sellDistance" exact="0"/>
            </do_if>
            <do_else>
              <set_value name="$sellDistance" exact="$homeSector.gatedistance.{$sellSector}"/>
            </do_else>
            
            <set_value name="$maxStationDistance" exact="[$buyDistance, $sellDistance].max"/>
            
            <!-- Filter by home sector distance (using originalMaxDistance to respect pilot's trading range) -->
            <do_if value="$buyDistance lt 0 or $sellDistance lt 0">
              <!-- Unreachable from home sector - skip -->
              <set_value name="$rejectedByUnreachable" exact="$rejectedByUnreachable + 1"/>
              <continue/>
            </do_if>
            <do_if value="$maxStationDistance gt $filterMaxDistance">
              <!-- Too far from home sector - skip (respects pilot's trading range) -->
              <set_value name="$rejectedByHomeDistance" exact="$rejectedByHomeDistance + 1"/>
              <continue/>
            </do_if>
            
            <!-- Calculate current location distance for SORTING (prioritize nearby trades) -->
            <set_value name="$currentToBuyDistance" exact="-1"/>
            <set_value name="$currentToSellDistance" exact="-1"/>
            <do_if value="$buySector == $currentSector">
              <set_value name="$currentToBuyDistance" exact="0"/>
            </do_if>
            <do_else>
              <set_value name="$currentToBuyDistance" exact="$currentSector.gatedistance.{$buySector}"/>
            </do_else>
            <do_if value="$sellSector == $currentSector">
              <set_value name="$currentToSellDistance" exact="0"/>
            </do_if>
            <do_else>
              <set_value name="$currentToSellDistance" exact="$currentSector.gatedistance.{$sellSector}"/>
            </do_else>
            <set_value name="$maxDistanceFromCurrent" exact="[$currentToBuyDistance, $currentToSellDistance].max"/>
            
            <!-- Count trade as evaluated (passed home sector filter) -->
            <set_value name="$evaluatedCount" exact="$evaluatedCount + 1"/>
            
            <!-- Sort by distance from current position (prioritize nearby trades) -->
            <set_value name="$sortDistance" exact="$maxDistanceFromCurrent"/>
          </do_if>
          <do_else>
            <!-- NORMAL SEARCH: Filter by HOME SECTOR distance -->
            <set_value name="$buyDistance" exact="-1"/>
            <set_value name="$sellDistance" exact="-1"/>
            
            <do_if value="$buySector == $homeSector">
              <set_value name="$buyDistance" exact="0"/>
            </do_if>
            <do_else>
              <set_value name="$buyDistance" exact="$homeSector.gatedistance.{$buySector}"/>
            </do_else>
            
            <do_if value="$sellSector == $homeSector">
              <set_value name="$sellDistance" exact="0"/>
            </do_if>
            <do_else>
              <set_value name="$sellDistance" exact="$homeSector.gatedistance.{$sellSector}"/>
            </do_else>
            
            <!-- Use max distance (farthest station from home) for filtering -->
            <set_value name="$maxStationDistance" exact="[$buyDistance, $sellDistance].max"/>
            
            <!-- Filter by home distance -->
            <do_if value="$buyDistance lt 0 or $sellDistance lt 0">
              <!-- Unreachable from home sector - skip -->
              <set_value name="$rejectedByUnreachable" exact="$rejectedByUnreachable + 1"/>
              <continue/>
            </do_if>
            <do_if value="$maxStationDistance gt $filterMaxDistance">
              <!-- Too far from home sector - skip -->
              <set_value name="$rejectedByHomeDistance" exact="$rejectedByHomeDistance + 1"/>
              <continue/>
            </do_if>
            
            <!-- Trade passed home distance filter - calculate distance from current for SCORING/SORTING -->
            <set_value name="$currentToBuyDistance" exact="-1"/>
            <set_value name="$currentToSellDistance" exact="-1"/>
            <set_value name="$maxDistanceFromCurrent" exact="-1"/>
            <do_if value="$buySector == $currentSector">
              <set_value name="$currentToBuyDistance" exact="0"/>
            </do_if>
            <do_else>
              <set_value name="$currentToBuyDistance" exact="$currentSector.gatedistance.{$buySector}"/>
            </do_else>
            <do_if value="$sellSector == $currentSector">
              <set_value name="$currentToSellDistance" exact="0"/>
            </do_if>
            <do_else>
              <set_value name="$currentToSellDistance" exact="$currentSector.gatedistance.{$sellSector}"/>
            </do_else>
            <set_value name="$maxDistanceFromCurrent" exact="[$currentToBuyDistance, $currentToSellDistance].max"/>
            
            <!-- Count trade as evaluated (passed home distance filter) -->
            <set_value name="$evaluatedCount" exact="$evaluatedCount + 1"/>
            
            <!-- Sort by distance from home -->
            <set_value name="$sortDistance" exact="$maxStationDistance"/>
          </do_else>
          
          <append_to_list name="$tradesWithDistance" exact="table[
            $Trade = $trade,
            $Distance = $sortDistance,
            $HomeDistance = $maxStationDistance
          ]"/>
        </do_all>
        
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$TradesWithDistance" exact="$tradesWithDistance"/>
        <set_value name="$result.$RejectedByUnreachable" exact="$rejectedByUnreachable"/>
        <set_value name="$result.$RejectedByHomeDistance" exact="$rejectedByHomeDistance"/>
        <set_value name="$result.$EvaluatedCount" exact="$evaluatedCount"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Select Best Trades With Diversity -->
    <library name="GT_SelectBestTradesWithDiversity" purpose="run_actions">
      <params>
        <param name="sortedTrades" comment="List of trades sorted by distance"/>
        <param name="maxDistance" comment="Maximum distance limit"/>
        <param name="filterMaxDistance" comment="Filter max distance (for fallback search)"/>
        <param name="isFallbackSearch" default="false" comment="Whether this is a fallback search"/>
        <param name="ware" comment="Ware being traded (for logging)"/>
        <param name="ship" comment="Ship executing the trade"/>
      </params>
      <actions>
        <!-- Selects top 5 trades with station pair diversity -->
        <!-- Returns: $topTrades list (up to 5 trades), $skippedDueToDistance -->
        <set_value name="$topTrades" exact="[]"/>
        <set_value name="$skippedDueToDistance" exact="0"/>
        <set_value name="$distanceLimit" exact="$maxDistance"/>  <!-- Default: use maxDistance (home sector) -->
        <do_if value="$isFallbackSearch">
          <set_value name="$distanceLimit" exact="$filterMaxDistance"/>  <!-- Fallback: use home distance limit -->
        </do_if>
        
        <do_all exact="$sortedTrades.count" counter="$i">
          <!-- Early exit: If this trade exceeds distance limit, all subsequent trades are also too far -->
          <do_if value="$sortedTrades.{$i}.$HomeDistance gt $distanceLimit">
            <set_value name="$skippedDueToDistance" exact="$sortedTrades.count - $i"/>
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <set_value name="$distanceType" exact="'home sector'"/>  <!-- Always home sector for distance limit check -->
              <debug_text text="'[GT-Resume] (' + $ship.idcode + ') âš¡ EARLY EXIT for ware ' + @$ware.name + ': Reached distance limit (' + $distanceLimit + ' jumps from ' + $distanceType + ') at trade ' + $i + '/' + $sortedTrades.count + ' (skipped ' + $skippedDueToDistance + ' trades)'" chance="100"/>
            </do_if>
            <break/>
          </do_if>
          
          <!-- Trade is within distance - select top 5 by Score with STATION PAIR DIVERSITY -->
          <set_value name="$trade" exact="$sortedTrades.{$i}.$Trade"/>
          <set_value name="$buyStation" exact="$trade.$BuyStation"/>
          <set_value name="$sellStation" exact="$trade.$SellStation"/>
          
          <!-- Check if this station pair already exists in topTrades -->
          <set_value name="$stationPairExists" exact="false"/>
          <do_all exact="$topTrades.count" counter="$j">
            <set_value name="$existingBuyStation" exact="$topTrades.{$j}.$BuyStation"/>
            <set_value name="$existingSellStation" exact="$topTrades.{$j}.$SellStation"/>
            <do_if value="$existingBuyStation == $buyStation and $existingSellStation == $sellStation">
              <set_value name="$stationPairExists" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          
          <!-- Skip if station pair already exists (ensure diversity) -->
          <do_if value="not $stationPairExists">
            <set_value name="$shouldAdd" exact="false"/>
            <do_if value="$topTrades.count lt 5">
              <!-- Still building initial top 5 - add unique station pair -->
              <set_value name="$shouldAdd" exact="true"/>
            </do_if>
            <do_else>
              <!-- Top 5 full - check if this trade's Score is better than worst -->
              <set_value name="$worstScore" exact="999999999"/>
              <set_value name="$worstIdx" exact="-1"/>
              <do_all exact="5" counter="$j">
                <do_if value="$topTrades.{$j}.$Score lt $worstScore">
                  <set_value name="$worstScore" exact="$topTrades.{$j}.$Score"/>
                  <set_value name="$worstIdx" exact="$j"/>
                </do_if>
              </do_all>
              <do_if value="$trade.$Score gt $worstScore">
                <!-- Replace worst with this trade (unique station pair) -->
                <set_value name="$shouldAdd" exact="true"/>
              </do_if>
            </do_else>
            <do_if value="$shouldAdd">
              <do_if value="$topTrades.count lt 5">
                <append_to_list name="$topTrades" exact="$trade"/>
              </do_if>
              <do_else>
                <!-- Replace worst trade in top5 -->
                <set_value name="$worstScore" exact="999999999"/>
                <set_value name="$worstIdx" exact="-1"/>
                <do_all exact="5" counter="$j">
                  <do_if value="$topTrades.{$j}.$Score lt $worstScore">
                    <set_value name="$worstScore" exact="$topTrades.{$j}.$Score"/>
                    <set_value name="$worstIdx" exact="$j"/>
                  </do_if>
                </do_all>
                <do_if value="$worstIdx ge 0">
                  <set_value name="$topTrades.{$worstIdx}" exact="$trade"/>
                </do_if>
              </do_else>
            </do_if>
          </do_if>
        </do_all>
        
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$TopTrades" exact="$topTrades"/>
        <set_value name="$result.$SkippedDueToDistance" exact="$skippedDueToDistance"/>
        <return value="$result"/>
      </actions>
    </library>

<!-- Register pilot with the GT system -->
    <library name="Register_Pilot">
      <params>
        <param name="pilot" comment="Pilot to register"/>
        <param name="ship" comment="Ship associated with pilot"/>
        <param name="debuglevel" default="1" comment="Debug output level"/>
      </params>
      <actions>
        <!-- Initialize global pilot registry if needed -->
        <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_Pilots exists -->
        
        <!-- Check if pilot is new or existing -->
        <do_if value="not global.$GT_Pilots.{$pilot}?">
          <!-- New pilot - initialize data -->
          <set_value name="global.$GT_Pilots.{$pilot}" exact="table[
            $Name = $pilot.name,
            $RegistrationTime = player.age,
            $LastActiveTime = player.age,
            $TotalXP = 0,
            $TradesCompleted = 0,
            $ProfitGenerated = 0Cr,
            $RequiresTraining = false,
            $CurrentlyTraining = false,
            $Ship = $ship
          ]"/>
          
          <do_if value="$debuglevel ge 1">
            <debug_text text="'[GT Data] Registered new pilot: ' + $pilot.name + ' for ship ' + $ship.idcode" chance="100"/>
          </do_if>
        </do_if>
        <do_else>
          <!-- Existing pilot - update activity -->
          <set_value name="global.$GT_Pilots.{$pilot}.$LastActiveTime" exact="player.age"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$Ship" exact="$ship"/>
          
          <do_if value="$debuglevel ge 2">
            <debug_text text="'[GT Data] Updated existing pilot: ' + $pilot.name + ' for ship ' + $ship.idcode" chance="100"/>
          </do_if>
        </do_else>
      </actions>
    </library>
    
    <!-- Register ship with the GT system -->
    <library name="Register_Ship">
      <params>
        <param name="ship" comment="Ship to register"/>
        <param name="debuglevel" default="1" comment="Debug output level"/>
      </params>
      <actions>
        <!-- Initialize global ship registry if needed -->
        <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_Ships exists -->
        
        <!-- Register or update ship -->
        <do_if value="not global.$GT_Ships.{$ship}?">
          <!-- New ship - initialize data -->
          <set_value name="global.$GT_Ships.{$ship}" exact="table[
            $Name = $ship.knownname,
            $IDCode = $ship.idcode,
            $RegistrationTime = player.age,
            $LastActiveTime = player.age,
            $IsSubordinate = false,
            $Commander = null,
            $FleetPosition = 0,
            $TotalTrades = 0,
            $TotalProfit = 0,
            $LastTradeTime = null
          ]"/>
          
          <!-- Check if ship is subordinate -->
          <do_if value="$ship.commander and $ship.commander != $ship">
            <set_value name="global.$GT_Ships.{$ship}.$IsSubordinate" exact="true"/>
            <set_value name="global.$GT_Ships.{$ship}.$Commander" exact="$ship.commander"/>
            
            <!-- Calculate fleet position -->
            <set_value name="$fleetSubordinates" exact="$ship.commander.subordinates"/>
            <do_all exact="$fleetSubordinates.count" counter="$i">
              <do_if value="$fleetSubordinates.{$i} == $ship">
                <set_value name="global.$GT_Ships.{$ship}.$FleetPosition" exact="$i"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>
          
          <do_if value="$debuglevel ge 1">
            <debug_text text="'[GT Data] Registered new ship: ' + $ship.knownname + ' (' + $ship.idcode + ')'" chance="100"/>
          </do_if>
        </do_if>
        <do_else>
          <!-- Existing ship - update activity -->
          <set_value name="global.$GT_Ships.{$ship}.$LastActiveTime" exact="player.age"/>
          
          <do_if value="$debuglevel ge 2">
            <debug_text text="'[GT Data] Updated existing ship: ' + $ship.knownname + ' (' + $ship.idcode + ')'" chance="100"/>
          </do_if>
        </do_else>
      </actions>
    </library>
    
    <!-- Initialize global systems if needed -->
    <library name="Ensure_Global_Systems">
      <params>
        <param name="debuglevel" default="1" comment="Debug output level"/>
      </params>
      <actions>
        <set_value name="$systemsInitialized" exact="0"/>
        
        <!-- Initialize ThreatIntelligence system -->
        <do_if value="not global.$GT_ThreatIntelligence?">
          <set_value name="global.$GT_ThreatIntelligence" exact="table[]"/>
          <set_value name="$systemsInitialized" exact="$systemsInitialized + 1"/>
        </do_if>
        
        <!-- Trade cache is NOT pre-initialized - X4 locks empty table[] -->
        <!-- It will be created WITH data on first cache write -->
        
        <!-- Initialize global configuration if needed -->
        <do_if value="not global.$GT_GlobalSettings?">
          <set_value name="global.$GT_GlobalSettings" exact="table[
            $XP = table[
              $EnableXPProgression = true,
              $AutoTraining = true,
              $BaseXPPerTrade = 25,
              $DistanceBonus = 20,
              $RiskBonus = 25
            ],
            $Fleet = table[
              $EnableFleetCoordination = true,
              $EnableTradeCache = true,
              $CacheProfitThreshold = 20,
              $CacheDropoffTolerance = 15,
              $CacheTTL = 5min
            ],
            $Debug = table[
              $DebugLevel = 1,
              $TradeEvaluation = false
            ]
          ]"/>
          <set_value name="$systemsInitialized" exact="$systemsInitialized + 1"/>
        </do_if>
        
        <do_if value="$systemsInitialized gt 0 and $debuglevel ge 1">
          <debug_text text="'[GT Data] Initialized ' + $systemsInitialized + ' global systems'" chance="100"/>
        </do_if>
      </actions>
    </library>
    
    <!-- Clean up pilot data (safe removal) -->
    <library name="Cleanup_Pilot_Data">
      <params>
        <param name="pilot" comment="Pilot to remove data for"/>
        <param name="debuglevel" default="1" comment="Debug output level"/>
      </params>
      <actions>
        <do_if value="$pilot? and global.$GT_Pilots? and global.$GT_Pilots.{$pilot}?">
          <remove_value name="global.$GT_Pilots.{$pilot}"/>
          
          <do_if value="$debuglevel ge 1">
            <debug_text text="'[GT Data] Cleaned up data for pilot: ' + $pilot.name" chance="100"/>
          </do_if>
        </do_if>
      </actions>
    </library>
    
    <!-- Clean up ship data (safe removal) -->
    <library name="Cleanup_Ship_Data">
      <params>
        <param name="ship" comment="Ship to remove data for"/>
        <param name="debuglevel" default="1" comment="Debug output level"/>
      </params>
      <actions>
        <do_if value="$ship? and global.$GT_Ships? and global.$GT_Ships.{$ship}?">
          <remove_value name="global.$GT_Ships.{$ship}"/>
          
          <do_if value="$debuglevel ge 1">
            <debug_text text="'[GT Data] Cleaned up data for ship: ' + $ship.knownname + ' (' + $ship.idcode + ')'" chance="100"/>
          </do_if>
        </do_if>
      </actions>
    </library>
    
    <!-- Get fleet coordination delay for subordinate -->
    <library name="Get_Fleet_Startup_Delay" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to calculate delay for"/>
      </params>
      <actions>
        <set_value name="$delay" exact="0"/>
        
        <!-- Check if ship is subordinate -->
        <do_if value="global.$GT_Ships.{$ship}? and global.$GT_Ships.{$ship}.$IsSubordinate">
          <set_value name="$fleetPosition" exact="global.$GT_Ships.{$ship}.$FleetPosition"/>
          
          <!-- Calculate staggered startup delay -->
          <set_value name="$delay" exact="$fleetPosition * 30s"/>
          
          <!-- Cap maximum delay -->
          <do_if value="$delay gt 300s">
            <set_value name="$delay" exact="300s"/>
          </do_if>
        </do_if>
        
        <set_value name="this.$result" exact="$delay"/>
      </actions>
    </library>

<!-- ========================================= -->
    <!-- NOTIFICATION SYSTEM -->
    <!-- ========================================= -->
    
    <!-- Show Notification -->
    <library name="GT_ShowNotification" purpose="run_actions">
      <params>
        <param name="text" comment="Notification text"/>
        <param name="category" default="'info'" comment="Notification category"/>
        <param name="timeout" default="5s" comment="Notification timeout"/>
      </params>
      <actions>
        <show_notification text="$text" timeout="$timeout"/>
      </actions>
    </library>
    
    <!-- ========================================= -->
    <!-- VALIDATION HELPERS -->
    <!-- ========================================= -->
    
    <!-- Validate Ship -->
    <library name="GT_ValidateShip" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship object to validate"/>
      </params>
      <actions>
        <do_if value="$ship? and $ship.exists and $ship.isoperational and not $ship.iswreck and $ship.pilot">
          <return value="true"/>
        </do_if>
        <return value="false"/>
      </actions>
    </library>
    
    <!-- Validate Station -->
    <library name="GT_ValidateStation" purpose="run_actions">
      <params>
        <param name="station" comment="Station object to validate"/>
        <param name="ship" default="null" comment="Optional: Ship parameter (reserved for future use)"/>
      </params>
      <actions>
        <!-- 
          DESIGN NOTE: Threat avoidance is now handled by vanilla pathfinding
          - Trade orders created with internal="true" use strictblacklist mode
          - Vanilla pathfinding routes AROUND blacklisted sectors automatically
          - If no route exists, the order fails gracefully and ship requests new trade
          - No need for manual sector filtering here
        -->
        <do_if value="$station? and $station.exists and $station.isoperational">
          <return value="true"/>
        </do_if>
        <return value="false"/>
      </actions>
    </library>
    
    <!-- Check if Ware is Allowed -->
    <library name="GT_IsWareAllowed" purpose="run_actions">
      <params>
        <param name="ware" comment="Ware to check"/>
        <param name="allowIllegal" default="true" comment="Whether to allow illegal wares"/>
        <param name="zone" default="null" comment="Optional: Zone context for illegal check"/>
        <param name="shipOwner" default="null" comment="Optional: Ship owner for license check"/>
      </params>
      <actions>
        <!-- Context-aware illegal check when zone and ship owner are provided -->
        <do_if value="not $allowIllegal">
          <do_if value="$zone and $shipOwner">
            <!-- Check if ware is illegal to police faction in this zone, considering ship owner's licenses -->
            <set_value name="$policeFaction" exact="$zone.policefaction"/>
            <do_if value="$policeFaction and $policeFaction != $shipOwner">
              <do_if value="$ware.illegalto.{$policeFaction}.{$shipOwner}">
                <return value="false"/>
              </do_if>
            </do_if>
          </do_if>
          <do_else>
            <!-- Fallback: Global illegal check (may be overly restrictive - use context-aware check when possible) -->
            <do_if value="$ware.illegal">
              <return value="false"/>
            </do_if>
          </do_else>
        </do_if>
        
        <!-- Check blacklist -->
        <do_if value="global.$GT_Config.$WareFilter.$BlacklistedWares?">
          <do_all exact="global.$GT_Config.$WareFilter.$BlacklistedWares.count" counter="$i">
            <do_if value="global.$GT_Config.$WareFilter.$BlacklistedWares.{$i} == $ware">
              <return value="false"/>
            </do_if>
          </do_all>
        </do_if>
        
        <!-- Check whitelist if exists -->
        <do_if value="global.$GT_Config.$WareFilter.$WhitelistedWares? and global.$GT_Config.$WareFilter.$WhitelistedWares.count gt 0">
          <do_all exact="global.$GT_Config.$WareFilter.$WhitelistedWares.count" counter="$j">
            <do_if value="global.$GT_Config.$WareFilter.$WhitelistedWares.{$j} == $ware">
              <return value="true"/>
            </do_if>
          </do_all>
          <return value="false"/>
        </do_if>
        
        <return value="true"/>
      </actions>
    </library>
    
    <!-- ========================================= -->
    <!-- XP CALCULATIONS -->
    <!-- ========================================= -->
    
    <!-- Calculate XP Award -->
    <library name="GT_CalculateXP" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship that completed trade"/>
        <param name="profit" comment="Trade profit amount"/>
        <param name="jumps" default="1" comment="Number of jumps"/>
      </params>
      <actions>
        <!-- Get base XP from config -->
        <set_value name="$baseXP" exact="@global.$GT_Config.$XP.$BaseXPPerTrade"/>
        <do_if value="not $baseXP">
          <set_value name="$baseXP" exact="100"/>
        </do_if>
        
        <!-- Calculate distance bonus -->
        <set_value name="$distanceBonusPerJump" exact="@global.$GT_Config.$XP.$DistanceBonus"/>
        <do_if value="not $distanceBonusPerJump">
          <set_value name="$distanceBonusPerJump" exact="20"/>
        </do_if>
        <set_value name="$distanceBonus" exact="$jumps * $distanceBonusPerJump"/>
        
        <!-- Calculate risk bonus -->
        <set_value name="$riskBonus" exact="0"/>
              <!-- Risk bonus calculation disabled - sector security property uncertain -->
      <set_value name="$riskBonus" exact="0"/>
        
        <!-- Return total XP -->
        <return value="$baseXP + $distanceBonus + $riskBonus"/>
      </actions>
    </library>
    
    <!-- ========================================= -->
    <!-- CONFIGURATION HELPERS -->
    <!-- ========================================= -->
    
    <!-- Get Configuration Value -->
    <library name="GT_GetConfigValue" purpose="run_actions">
      <params>
        <param name="section" comment="Configuration section"/>
        <param name="key" comment="Configuration key"/>
        <param name="default" default="null" comment="Default value if not found"/>
      </params>
      <actions>
        <do_if value="global.$GT_Config? and global.$GT_Config.{$section}? and global.$GT_Config.{$section}.{$key}?">
          <return value="@global.$GT_Config.{$section}.{$key}"/>
        </do_if>
        <return value="$default"/>
      </actions>
    </library>
    
    <!-- ========================================= -->
    <!-- TRADE FILTERING AND ANALYSIS -->
    <!-- ========================================= -->
    
    <!-- Filter Trade Offer -->
    <library name="GT_FilterTradeOffer" purpose="run_actions">
      <params>
        <param name="offer" comment="Trade offer to filter"/>
        <param name="ship" comment="Ship that would execute the trade"/>
        <param name="allowIllegal" default="true" comment="Whether to allow illegal wares"/>
      </params>
      <actions>
        <!-- Check if ware is allowed (with context for illegal check) -->
        <run_actions ref="GT_IsWareAllowed" result="$wareAllowed">
          <param name="ware" value="$offer.ware"/>
          <param name="allowIllegal" value="$allowIllegal"/>
          <param name="zone" value="$offer.owner.zone"/>
          <param name="shipOwner" value="$ship.owner"/>
        </run_actions>
        <do_if value="not $wareAllowed">
          <return value="false"/>
        </do_if>
        
        <!-- Check if ship can carry this ware -->
        <do_if value="$ship.cargo.{$offer.ware}.max le 0">
          <return value="false"/>
        </do_if>
        
        <!-- Check if offer has sufficient amount -->
        <do_if value="$offer.amount le 0">
          <return value="false"/>
        </do_if>
        
        <return value="true"/>
      </actions>
    </library>
    
    <!-- Calculate Trade Profit -->
    <library name="GT_CalculateProfit" purpose="run_actions">
      <params>
        <param name="buyPrice" comment="Price to buy at"/>
        <param name="sellPrice" comment="Price to sell at"/>
        <param name="amount" comment="Amount to trade"/>
        <param name="expenses" default="0Cr" comment="Additional expenses"/>
      </params>
      <actions>
        <set_value name="$revenue" exact="$sellPrice * $amount"/>
        <set_value name="$cost" exact="$buyPrice * $amount"/>
        <return value="$revenue - $cost - $expenses"/>
      </actions>
    </library>
    
    <!-- Calculate ROI (Return on Investment) -->
    <library name="GT_CalculateROI" purpose="run_actions">
      <params>
        <param name="investment" comment="Investment amount in credits"/>
        <param name="profit" comment="Profit amount in credits"/>
      </params>
      <actions>
        <!-- Returns ROI as percentage (21 = 21%) to avoid integer division issues -->
        <!-- OLD approach with decimals (0.15 = 15%) failed due to X4 MD integer truncation -->
        <do_if value="$investment gt 0">
          <return value="(($profit * 100) / $investment)"/>
        </do_if>
        <return value="0"/>
      </actions>
    </library>
    
    <!-- Calculate Trade Risk -->
    <library name="GT_CalculateRisk" purpose="run_actions">
      <params>
        <param name="sector" comment="Sector to assess risk for"/>
        <param name="ship" comment="Ship that would travel there"/>
      </params>
      <actions>
              <!-- Calculate security based on faction relations and sector characteristics -->
      <set_value name="$sectorSecurity" exact="0.5"/>
      
      <do_if value="$sector? and $sector.owner?">
                      <set_value name="$relation" exact="faction.player.relationto.{$sector.owner}"/>
        <do_if value="$relation ge 0.1">
          <set_value name="$sectorSecurity" exact="1.0"/>  <!-- Friendly = very safe -->
        </do_if>
        <do_elseif value="$relation ge -0.1">
          <set_value name="$sectorSecurity" exact="0.75"/> <!-- Neutral = safe -->
        </do_elseif>
        <do_elseif value="$relation ge -0.5">
          <set_value name="$sectorSecurity" exact="0.5"/>  <!-- Hostile = moderate -->
        </do_elseif>
        <do_else>
          <set_value name="$sectorSecurity" exact="0.25"/> <!-- Very hostile = dangerous -->
        </do_else>
        
        <!-- Extra danger for Xenon/Kha'ak sectors -->
        <do_if value="$sector.owner.id == 'xenon' or $sector.owner.id == 'khaak'">
          <set_value name="$sectorSecurity" exact="0.1"/>
        </do_if>
      </do_if>
      
      <!-- Base risk from security level -->
      <set_value name="$securityRisk" exact="1.0 - $sectorSecurity"/>
        
        <!-- Distance risk factor -->
        <set_value name="$distance" exact="$ship.distanceto.{$sector}"/>
        <set_value name="$distanceRisk" exact="[$distance / 100000, 0.5].min"/>
        
        <!-- Faction relation risk -->
        <set_value name="$relationRisk" exact="0"/>
        <do_if value="$sector.owner != $ship.owner">
          <set_value name="$relation" exact="$ship.owner.relationto.{$sector.owner}"/>
          <do_if value="$relation lt 0">
            <set_value name="$relationRisk" exact="($relation * -1) / 100"/>
          </do_if>
        </do_if>
        
        <!-- Combined risk (weighted average) -->
        <set_value name="$combinedRisk" exact="($securityRisk * 0.5) + ($distanceRisk * 0.3) + ($relationRisk * 0.2)"/>
        <return value="[$combinedRisk, 1.0].min"/>
      </actions>
    </library>
    
    <!-- ========================================= -->
    <!-- SHIP/SECTOR UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Get Home Sector -->
    <library name="GT_GetHomeSector" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to get home sector for"/>
      </params>
      <actions>
        <!-- âœ… CRITICAL: Subordinates ALWAYS use commander's home sector (not a fallback!) -->
        <set_value name="$homeBase" exact="null"/>
        <do_if value="$ship.commander? and $ship.commander.exists and $ship.commander != $ship">
          <!-- Ship is a subordinate - ALWAYS use commander's home sector -->
          <do_if value="$ship.commander.defaultorder?">
            <set_value name="$commanderHome" exact="@$ship.commander.defaultorder.$home"/>
            <do_if value="$commanderHome? and $commanderHome.exists">
              <set_value name="$homeBase" exact="$commanderHome"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- âœ… For non-subordinates: Always use defaultorder.$home as PRIMARY source (fixed value in order) -->
        <!-- Home sector is a fixed value in the order settings and should NEVER drift -->
        <do_if value="not $homeBase? or not $homeBase.exists">
          <set_value name="$homeBase" exact="@$ship.defaultorder.$home"/>
        </do_if>
        
        <!-- Fallback: Only if defaultorder.$home is not available, check GT_AIParameters -->
        <do_if value="not $homeBase? or not $homeBase.exists">
          <do_if value="global.$GT_AIParameters? and global.$GT_AIParameters.{$ship}? and global.$GT_AIParameters.{$ship}.$HomeBase?">
            <set_value name="$homeBase" exact="global.$GT_AIParameters.{$ship}.$HomeBase"/>
          </do_if>
        </do_if>
        
        <!-- âŒ REMOVED: Never fall back to $ship.sector (causes cascading drift) -->
        <!-- If home is still null, log critical error -->
        <do_if value="not $homeBase? or not $homeBase.exists">
          <debug_text text="'[GT-ERROR] Home sector not found for ' + $ship.idcode + ' - defaultorder.$home is null and GT_AIParameters.$HomeBase is null! This should never happen.'" chance="100"/>
        </do_if>
        
        <!-- Extract sector from home base (station/sector) -->
        <set_value name="$homeSector" exact="null"/>
        <do_if value="$homeBase? and $homeBase.exists">
          <do_if value="$homeBase.isclass.station">
            <set_value name="$homeSector" exact="$homeBase.sector"/>
          </do_if>
          <do_elseif value="$homeBase.isclass.sector">
            <set_value name="$homeSector" exact="$homeBase"/>
          </do_elseif>
        </do_if>
        
        <!-- Validate final home sector -->
        <do_if value="not $homeSector? or not $homeSector.exists">
          <debug_text text="'[GT-ERROR] Failed to extract home sector from homeBase for ' + $ship.idcode + ' - using ship.sector as emergency fallback (THIS WILL CAUSE DRIFT!)'" chance="100"/>
          <!-- Emergency fallback only - this should never happen -->
          <set_value name="$homeSector" exact="$ship.sector"/>
        </do_if>
        
        <return value="$homeSector"/>
      </actions>
    </library>
    
    <!-- Get Sector Name Safe -->
    <library name="GT_GetSectorNameSafe" purpose="run_actions">
      <params>
        <param name="sector" default="null" comment="Sector to get name for (or null to use ship.sector)"/>
        <param name="ship" default="null" comment="Ship to get sector from if sector not provided"/>
      </params>
      <actions>
        <set_value name="$targetSector" exact="$sector"/>
        <do_if value="not $targetSector?">
          <do_if value="$ship?">
            <set_value name="$targetSector" exact="$ship.sector"/>
          </do_if>
        </do_if>
        <set_value name="$sectorName" exact="@$targetSector.knownname"/>
        <do_if value="not $sectorName?">
          <set_value name="$sectorName" exact="'Unknown Sector'"/>
        </do_if>
        <return value="$sectorName"/>
      </actions>
    </library>
    
    <!-- Get Ware Basket Safe (with null-checking pattern) -->
    <library name="GT_GetWareBasketSafe" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to get ware basket for"/>
      </params>
      <actions>
        <!-- âœ… CRITICAL: Initialize to safe default FIRST (memory:10529400 - ? checks existence, not null) -->
        <set_value name="$wareBasket" exact="[]"/>
        <!-- Step 2: Check if source exists -->
        <do_if value="global.$GT_AIParameters.{$ship}.$WareBasket?">
          <!-- Step 3: Get value with @ (returns null if missing) -->
          <set_value name="$tempBasket" exact="@global.$GT_AIParameters.{$ship}.$WareBasket"/>
          <!-- Step 4: Extract count property with @ to check if result is valid list -->
          <set_value name="$tempCount" exact="@$tempBasket.count"/>
          <!-- Step 5: Check if COUNT result exists and is valid (>= 0 means it's a list, not null) -->
          <do_if value="$tempCount? and $tempCount ge 0">
            <!-- Step 6: Now safe to use the original temp value -->
            <set_value name="$wareBasket" exact="$tempBasket"/>
          </do_if>
        </do_if>
        <return value="$wareBasket"/>
      </actions>
    </library>
    
    <!-- Check if Ware is in Basket -->
    <library name="GT_IsWareInBasket" purpose="run_actions">
      <params>
        <param name="ware" comment="Ware to check"/>
        <param name="basket" comment="Ware basket list to check against"/>
      </params>
      <actions>
        <!-- Use explicit loop for reliable list membership check (indexof unreliable) -->
        <set_value name="$found" exact="false"/>
        <do_if value="$basket? and $basket.count gt 0">
          <do_all exact="$basket.count" counter="$i">
            <do_if value="$basket.{$i} == $ware">
              <set_value name="$found" exact="true"/>
              <break/>
            </do_if>
          </do_all>
        </do_if>
        <return value="$found"/>
      </actions>
    </library>
    
    <!-- ========================================= -->
    <!-- MARKET ANALYSIS -->
    <!-- ========================================= -->
    
    <!-- Find Best Trade -->
    <library name="GT_FindBestTrade">
      <params>
        <param name="ship" comment="Ship to find trade for"/>
        <param name="warebasket" comment="List of allowed wares"/>
      </params>
      <actions>
        <set_value name="$return" exact="null"/>
        <set_value name="$bestProfit" exact="0"/>
        
        <!-- Find buy offers -->
        <find_buy_offer space="player.galaxy" result="$buyoffers" multiple="true">
          <match_buyer tradesknownto="@this.owner"/>
          <match_seller tradesknownto="@this.owner"/>
        </find_buy_offer>
        
        <!-- Evaluate trades -->
        <do_all exact="[$buyoffers.count, 20].min" counter="$i">
          <set_value name="$buyoffer" exact="$buyoffers.{$i}"/>
          
          <!-- Check if ware is in basket using explicit loop (indexof unreliable for lists) -->
          <set_value name="$wareInBasket" exact="false"/>
          <do_all exact="$warebasket.count" counter="$k">
            <do_if value="$warebasket.{$k} == $buyoffer.ware">
              <set_value name="$wareInBasket" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          
          <do_if value="$wareInBasket">
            <!-- Find sell offers -->
            <find_sell_offer buyer="$buyoffer.buyer" wares="$buyoffer.ware" result="$selloffer">
              <match_seller tradesknownto="@this.owner"/>
            </find_sell_offer>
            
            <do_if value="$selloffer">
              <!-- Calculate profit -->
              <set_value name="$amount" exact="[this.ship.cargo.{$buyoffer.ware}.free, $buyoffer.amount, $selloffer.amount].min"/>
              <do_if value="$amount gt 0">
                <set_value name="$profit" exact="($selloffer.unitprice - $buyoffer.unitprice) * $amount"/>
                
                <!-- Check ROI and absolute profit thresholds -->
                <set_value name="$minROI" exact="@global.$GT_Config.$Trading.$MinROI"/>
                <do_if value="not $minROI">
                  <set_value name="$minROI" exact="0.10"/>
                </do_if>
                
                <set_value name="$minAbsoluteProfit" exact="@global.$GT_Config.$Trading.$MinAbsoluteProfit"/>
                <do_if value="not $minAbsoluteProfit">
                  <set_value name="$minAbsoluteProfit" exact="10000"/> <!-- 100 Cr in RAW format -->
                </do_if>
                
                <!-- Calculate ROI -->
                <set_value name="$investment" exact="$buyoffer.unitprice * $amount"/>
                <set_value name="$roi" exact="if $investment gt 0 then (($profit * 100.0) / $investment) else 0.0"/>
                
                <do_if value="$roi ge ($minROI * 100) and $profit ge $minAbsoluteProfit and $profit gt $bestProfit">
                  <set_value name="$bestProfit" exact="$profit"/>
                  <set_value name="$return" exact="$buyoffer"/>
                </do_if>
              </do_if>
            </do_if>
          </do_if>
        </do_all>
      </actions>
    </library>
    
    <!-- Analyze Route Threat -->
    <library name="GT_AnalyzeRouteThreat" purpose="run_actions">
      <params>
        <param name="buyStation" comment="Station to buy from"/>
        <param name="sellStation" comment="Station to sell to"/>
        <param name="ship" comment="Ship for context"/>
      </params>
      <actions>
        <!-- Initialize return table -->
        <set_value name="$return" exact="table[]"/>
        <set_value name="$return.$MaxThreat" exact="0"/>
        <set_value name="$return.$TotalThreatScore" exact="0"/>
        <set_value name="$return.$ThreatSectors" exact="[]"/>
        <set_value name="$return.$SectorCount" exact="0"/>
        
        <!-- Check if threat avoidance is enabled -->
        <do_if value="not global.$GT_GlobalSettings.$ThreatAvoidance? or not global.$GT_GlobalSettings.$ThreatAvoidance.$Enabled">
          <return value="$return"/>
        </do_if>
        
        <!-- Get threat expiry time -->
        <set_value name="$threatExpiry" exact="if global.$GT_GlobalSettings.$ThreatAvoidance.$ThreatExpiry? then global.$GT_GlobalSettings.$ThreatAvoidance.$ThreatExpiry else 600s"/>
        
        <!-- Build list of sectors to check: buy sector and sell sector -->
        <set_value name="$sectorsToCheck" exact="[]"/>
        
        <!-- Add buy station sector -->
        <append_to_list name="$sectorsToCheck" exact="$buyStation.sector"/>
        
        <!-- Add sell station sector if different -->
        <do_if value="$sellStation.sector != $buyStation.sector">
          <append_to_list name="$sectorsToCheck" exact="$sellStation.sector"/>
        </do_if>
        
        <!-- Check if preferred route goes through threatened sectors -->
        <!-- Compare normal vs blacklist-aware gatedistance to detect threats in path -->
        <do_if value="$ship? and $sellStation.sector != $buyStation.sector">
          <!-- Calculate distance from ship to sell station WITHOUT blacklist (preferred path) -->
          <set_value name="$normalDistance" exact="$ship.gatedistance.{$sellStation.sector}"/>
          
          <!-- Calculate distance WITH blacklist (avoiding threats) -->
          <!-- Vanilla pattern: order.dock.xml:503 -->
          <set_value name="$blacklistDistance" exact="$ship.gatedistance.{$sellStation.sector}.{blacklistgroup.civilian}.{$ship}"/>
          
          <!-- If blacklist distance > normal, preferred path goes through threat! -->
          <!-- Apply heavy penalty to discourage this route -->
          <do_if value="($normalDistance ge 0) and ($blacklistDistance gt $normalDistance or $blacklistDistance lt 0)">
            <!-- Route goes through threatened sector(s) - apply heavy threat penalty -->
            <set_value name="$return.$MaxThreat" exact="5"/>
            <set_value name="$return.$TotalThreatScore" exact="10"/>
            <debug_text text="'[GT-Threat] Route analysis: Preferred path threatened (normal: %s, blacklist: %s) - heavy penalty applied'.[$normalDistance, $blacklistDistance]" chance="0"/>
          </do_if>
        </do_if>
        
        <set_value name="$return.$SectorCount" exact="$sectorsToCheck.count"/>
        
        <!-- Check threat level for each sector -->
        <do_all exact="$sectorsToCheck.count" counter="$i">
          <set_value name="$sector" exact="$sectorsToCheck.{$i}"/>
          
          <!-- Check if we have threat data for this sector -->
          <do_if value="global.$GT_ThreatIntelligence.{$sector}?">
            <set_value name="$threatData" exact="global.$GT_ThreatIntelligence.{$sector}"/>
            
            <!-- Check if threat data is still valid (not expired) -->
            <do_if value="$threatData.$Timestamp?">
              <set_value name="$age" exact="player.age - $threatData.$Timestamp"/>
              
              <do_if value="$age le $threatExpiry">
                <set_value name="$threatLevel" exact="@$threatData.$ThreatLevel"/>
                
                <do_if value="$threatLevel?">
                  <!-- Update max threat -->
                  <do_if value="$threatLevel gt $return.$MaxThreat">
                    <set_value name="$return.$MaxThreat" exact="$threatLevel"/>
                  </do_if>
                  
                  <!-- Add to total threat score -->
                  <set_value name="$return.$TotalThreatScore" exact="$return.$TotalThreatScore + $threatLevel"/>
                  
                  <!-- Add sector to threat list if threat level > 1 -->
                  <do_if value="$threatLevel gt 1">
                    <set_value name="$threatSectorInfo" exact="table[]"/>
                    <set_value name="$threatSectorInfo.$Sector" exact="$sector"/>
                    <set_value name="$threatSectorInfo.$ThreatLevel" exact="$threatLevel"/>
                    <set_value name="$threatSectorInfo.$HostileCount" exact="@$threatData.$HostileCount"/>
                    <append_to_list name="$return.$ThreatSectors" exact="$threatSectorInfo"/>
                  </do_if>
                </do_if>
              </do_if>
            </do_if>
          </do_if>
        </do_all>
        
        <!-- Calculate average threat -->
        <set_value name="$return.$AverageThreat" exact="if $return.$SectorCount gt 0 then ($return.$TotalThreatScore / $return.$SectorCount) else 0"/>
        
        <!-- Return threat analysis result -->
        <return value="$return"/>
      </actions>
    </library>
    
    <!-- Validate Table Safe (null-checking pattern) -->
    <library name="GT_ValidateTableSafe" purpose="run_actions">
      <params>
        <param name="table" comment="Table to validate (may be null)"/>
      </params>
      <actions>
        <!-- CRITICAL: X4 MD null-checking pattern -->
        <!-- null? = true, so we check if .keys.count exists and is >= 0 -->
        <set_value name="$keysCheck" exact="@$table.keys"/>
        <set_value name="$countCheck" exact="@$keysCheck.count"/>
        <do_if value="$table? and $keysCheck? and $countCheck? and $countCheck ge 0">
          <return value="$table"/>
        </do_if>
        <!-- Return empty table if invalid -->
        <return value="table[]"/>
      </actions>
    </library>

<!-- Initialize AI Script Configuration -->
    <library name="Initialize_AI_Script">
      <params>
        <param name="ship" comment="Ship being initialized"/>
        <param name="order_params" comment="Order parameters"/>
      </params>
      <actions>
        <!-- Create configuration using the Configuration Manager -->
        <run_actions ref="md.GT_Configuration.Create_Ship_Config" result="$shipConfig">
          <param name="order_params" value="$order_params"/>
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <!-- Register ship and pilot -->
        <do_if value="$ship.pilot">
          <run_actions ref="md.GT_Ship_Management.Register_Ship">
            <param name="ship" value="$ship"/>
            <param name="pilot" value="$ship.pilot"/>
            <param name="config" value="$shipConfig"/>
          </run_actions>
        </do_if>
        
        <!-- Return the configuration for use in the AI script -->
        <set_value name="this.$result" exact="$shipConfig"/>
      </actions>
    </library>
    
    <!-- Validate Runtime Parameters -->
    <library name="Validate_Runtime_Parameters" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to validate"/>
        <param name="config" comment="Ship configuration"/>
      </params>
      <actions>
        <set_value name="$validationResult" exact="table[]"/>
        <set_value name="$isValid" exact="true"/>
        <create_list name="$warnings"/>
        <create_list name="$corrections"/>
        
        <!-- Get current skill level -->
        <run_actions ref="md.GT_Ship_Management.Calculate_Skill_Level" result="$skillInfo">
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <!-- Calculate skill-based jump distance -->
        <run_actions ref="md.GT_Ship_Management.Calculate_Jump_Distance" result="$skillMaxDistance">
          <param name="skill_level" value="$skillInfo.$Level"/>
        </run_actions>
        
        <!-- Check if pilot is XP blocked -->
        <set_value name="$pilotXPBlocked" exact="false"/>
        <do_if value="$ship.pilot and global.$GT_Pilots.{$ship.pilot}? and global.$GT_Pilots.{$ship.pilot}.$XPBlocked?">
          <set_value name="$pilotXPBlocked" exact="true"/>
        </do_if>
        
        <!-- Validate and correct MaxBuy distance -->
        <do_if value="not $pilotXPBlocked and $config.$MaxBuy gt $skillMaxDistance">
          <append_to_list name="$warnings" exact="'MaxBuy (' + $config.$MaxBuy + ') exceeds skill limit (' + $skillMaxDistance + ')'"/>
          <append_to_list name="$corrections" exact="'MaxBuy corrected to ' + $skillMaxDistance"/>
          <set_value name="$config.$MaxBuy" exact="$skillMaxDistance"/>
          <set_value name="$config.$MaxBuyDistance" exact="$skillMaxDistance"/>
        </do_if>
        
        <!-- Validate and correct MaxSell distance -->
        <do_if value="not $pilotXPBlocked and $config.$MaxSell gt $skillMaxDistance">
          <append_to_list name="$warnings" exact="'MaxSell (' + $config.$MaxSell + ') exceeds skill limit (' + $skillMaxDistance + ')'"/>
          <append_to_list name="$corrections" exact="'MaxSell corrected to ' + $skillMaxDistance"/>
          <set_value name="$config.$MaxSell" exact="$skillMaxDistance"/>
          <set_value name="$config.$MaxSellDistance" exact="$skillMaxDistance"/>
        </do_if>
        
        <!-- Store validation results -->
        <set_value name="$validationResult.$IsValid" exact="$isValid"/>
        <set_value name="$validationResult.$Warnings" exact="$warnings"/>
        <set_value name="$validationResult.$Corrections" exact="$corrections"/>
        <set_value name="$validationResult.$SkillInfo" exact="$skillInfo"/>
        <set_value name="$validationResult.$SkillMaxDistance" exact="$skillMaxDistance"/>
        <set_value name="$validationResult.$PilotXPBlocked" exact="$pilotXPBlocked"/>
        
        <set_value name="this.$result" exact="$validationResult"/>
      </actions>
    </library>
    
    <!-- Handle Fleet Coordination -->
    <library name="Handle_Fleet_Coordination" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship joining fleet"/>
        <param name="config" comment="Ship configuration"/>
      </params>
      <actions>
        <set_value name="$fleetResult" exact="table[]"/>
        <set_value name="$startupDelay" exact="0"/>
        <set_value name="$isSubordinate" exact="false"/>
        
        <!-- Check if fleet coordination is enabled AND pilot level gate passed (>= 12) -->
        <do_if value="$config.$FleetCoordination">
          <set_value name="$fleetGatePassed" exact="false"/>
          <run_actions ref="md.GT_Ship_Management.Calculate_Skill_Level" result="$skillInfo">
            <param name="ship" value="$ship"/>
          </run_actions>
          <do_if value="$skillInfo? and $skillInfo.$Level? and $skillInfo.$Level ge 12">
            <set_value name="$fleetGatePassed" exact="true"/>
          </do_if>
          
          <!-- Only apply coordination delay if gate passed -->
          <do_if value="$fleetGatePassed">
          <!-- Count active traders -->
          <set_value name="$activeTraders" exact="0"/>
          <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
            <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
            <do_all exact="$shipKeys.count" counter="$i">
              <set_value name="$existingShip" exact="$shipKeys.{$i}"/>
              <do_if value="$existingShip.exists and $existingShip.isoperational and $existingShip != $ship">
                <set_value name="$activeTraders" exact="$activeTraders + 1"/>
              </do_if>
            </do_all>
          </do_if>
          
          <!-- Apply fleet coordination delay -->
          <do_if value="$activeTraders gt 0">
            <set_value name="$startupDelay" exact="[$activeTraders * 5, 30].min"/>
            <set_value name="$isSubordinate" exact="true"/>
            
            <debug_text text="'[GT-AI] ' + $ship.idcode + ': Fleet coordination: delaying startup for ' + $startupDelay + 's (found ' + $activeTraders + ' active traders)'" chance="100"/>
          </do_if>
          </do_if>
          <do_if value="not $fleetGatePassed">
            <debug_text text="'[GT-AI] ' + $ship.idcode + ': Fleet coordination gated by level (requires 12), current=' + (if $skillInfo? then $skillInfo.$Level else 1)" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Store results -->
        <set_value name="$fleetResult.$StartupDelay" exact="$startupDelay"/>
        <set_value name="$fleetResult.$IsSubordinate" exact="$isSubordinate"/>
        <set_value name="$fleetResult.$ActiveTraders" exact="$activeTraders"/>
        
        <set_value name="this.$result" exact="$fleetResult"/>
      </actions>
    </library>
    
    <!-- Check Training Requirements -->
    <library name="Check_Training_Requirements" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to check"/>
        <param name="pilot" comment="Pilot to check"/>
        <param name="config" comment="Ship configuration"/>
      </params>
      <actions>
        <set_value name="$trainingResult" exact="table[]"/>
        <set_value name="$needsTraining" exact="false"/>
        <set_value name="$trainingAction" exact="'none'"/>
        
        <!-- Only check if auto-training is enabled -->
        <do_if value="$config.$AutoTraining and $pilot">
          <!-- Check training requirements using XP system -->
          <set_value name="$trainingStatus" exact="table[$Required = false, $Level = 1, $IsBlocked = false]"/>
          <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
            <set_value name="$currentLevel" exact="@global.$GT_Pilots.{$pilot}.$Level"/>
            <do_if value="not $currentLevel">
              <set_value name="$currentLevel" exact="1"/>
            </do_if>
            
            <!-- Check if training is beneficial (level < 5) -->
            <do_if value="$currentLevel lt 5">
              <set_value name="$trainingStatus.$Required" exact="true"/>
              <set_value name="$trainingStatus.$Level" exact="$currentLevel + 1"/>
            </do_if>
          </do_if>
          
          <set_value name="$needsTraining" exact="$trainingStatus.$Required"/>
          
          <do_if value="$needsTraining">
            <!-- Find training station -->
            <set_value name="$stationResult" exact="table[$Found = false, $Station = null]"/>
            <find_station name="$nearestStation" space="$ship.zone">
              <match class="class.station"/>
            </find_station>
            <do_if value="$nearestStation">
              <set_value name="$stationResult.$Found" exact="true"/>
              <set_value name="$stationResult.$Station" exact="$nearestStation"/>
            </do_if>
            
            <do_if value="$stationResult.$Found">
              <set_value name="$trainingAction" exact="'start_training'"/>
              <set_value name="$trainingResult.$TrainingStation" exact="$stationResult.$Station"/>
              <set_value name="$trainingResult.$RequiredLevel" exact="$trainingStatus.$Level"/>
            </do_if>
            <do_else>
              <set_value name="$trainingAction" exact="'no_station'"/>
            </do_else>
          </do_if>
          <do_elseif value="$trainingStatus.$IsBlocked">
            <!-- Pilot is blocked but no training needed - this shouldn't happen -->
            <set_value name="$trainingAction" exact="'clear_block'"/>
          </do_elseif>
        </do_if>
        
        <!-- Store results -->
        <set_value name="$trainingResult.$NeedsTraining" exact="$needsTraining"/>
        <set_value name="$trainingResult.$Action" exact="$trainingAction"/>
        <set_value name="$trainingResult.$TrainingStatus" exact="@$trainingStatus"/>
        
        <set_value name="this.$result" exact="$trainingResult"/>
      </actions>
    </library>
    
    <!-- Extract Configuration Variables for AI Script Compatibility -->
    <library name="Extract_Config_Variables" purpose="run_actions">
      <params>
        <param name="config" comment="Ship configuration"/>
      </params>
      <actions>
        <!-- Extract all configuration values into individual variables for backward compatibility -->
        <set_value name="$variables" exact="table[]"/>
        
        <!-- Basic trading settings -->
        <set_value name="$variables.$gt_allowillegal" exact="$config.$AllowIllegal"/>
        <set_value name="$variables.$gt_risktolerance" exact="$config.$RiskTolerance"/>
        <set_value name="$variables.$gt_distancepenalty" exact="$config.$DistancePenalty"/>
        <set_value name="$variables.$gt_cargotarget" exact="$config.$CargoTarget"/>
        <set_value name="$variables.$gt_marketupdatefreq" exact="$config.$MarketUpdateFreq"/>
        
        <!-- System settings -->
        <set_value name="$variables.$gt_enablexp" exact="$config.$EnableXP"/>
        <set_value name="$variables.$gt_autotraining" exact="$config.$AutoTraining"/>
        <set_value name="$variables.$gt_fleetcoord" exact="$config.$FleetCoordination"/>
        <set_value name="$variables.$gt_tradecache" exact="$config.$TradeCache"/>
        <set_value name="$variables.$gt_cachethreshold" exact="$config.$CacheThreshold"/>
        <set_value name="$variables.$gt_cachettl" exact="$config.$CacheTTL"/>
        <set_value name="$variables.$gt_cachedropoff" exact="$config.$CacheDropoffTolerance"/>
        <set_value name="$variables.$gt_debuglevel" exact="$config.$DebugLevel"/>
        
        <!-- Jump distances -->
        <set_value name="$variables.$maxbuy" exact="$config.$MaxBuyDistance"/>
        <set_value name="$variables.$maxsell" exact="$config.$MaxSellDistance"/>
        
        <!-- Ware settings -->
        <set_value name="$variables.$warebasket" exact="$config.$WareBasket"/>
        <set_value name="$variables.$gt_notifications" exact="$config.$Notifications"/>
        <set_value name="$variables.$gt_tradeeval" exact="$config.$TradeEval"/>
        
        <!-- Debug settings -->
        <set_value name="$variables.$debugchance" exact="100"/>
        
        <set_value name="this.$result" exact="$variables"/>
      </actions>
    </library>
    
    <!-- Log Configuration Summary -->
    <library name="Log_Configuration_Summary">
      <params>
        <param name="ship" comment="Ship being configured"/>
        <param name="config" comment="Ship configuration"/>
        <param name="debug_level" default="1" comment="Minimum debug level to log"/>
      </params>
      <actions>
        <do_if value="$config.$DebugLevel ge $debug_level">
          <debug_text text="'[GT-AI] ' + $ship.idcode + ': === CONFIGURATION SUMMARY ==='" chance="100"/>
          <debug_text text="'[GT-AI] ' + $ship.idcode + ': Risk=' + $config.$RiskTolerance + ', Illegal=' + $config.$AllowIllegal + ', DistancePenalty=' + $config.$DistancePenalty + '%'" chance="100"/>
          <debug_text text="'[GT-AI] ' + $ship.idcode + ': XP=' + $config.$EnableXP + ', AutoTraining=' + $config.$AutoTraining + ', Fleet=' + $config.$FleetCoordination" chance="100"/>
          <debug_text text="'[GT-AI] ' + $ship.idcode + ': Distance limits: MaxBuy=' + $config.$MaxBuyDistance + ' jumps, MaxSell=' + $config.$MaxSellDistance + ' jumps'" chance="100"/>
          <debug_text text="'[GT-AI] ' + $ship.idcode + ': Ware basket: ' + $config.$WareBasket.count + ' wares configured (AutoWares=' + $config.$AutoWares + ')'" chance="100"/>
          
          <!-- Log skill information if available -->
          <do_if value="$config.$SkillInfo?">
            <debug_text text="'[GT-AI] ' + $ship.idcode + ': Skill Level=' + $config.$SkillInfo.$Level + ', Using MD System=' + $config.$SkillInfo.$UsingMDSystem" chance="100"/>
          </do_if>
        </do_if>
        
        <set_value name="this.$result" exact="true"/>
      </actions>
    </library>
    
    <!-- Handle Order Parameter Updates -->
    <library name="Update_Order_Parameters">
      <params>
        <param name="ship" comment="Ship with order to update"/>
        <param name="config" comment="Current configuration"/>
        <param name="pilot_xp_blocked" default="false" comment="Whether pilot is XP blocked"/>
      </params>
      <actions>
        <!-- Only update order parameters if pilot is not XP blocked to prevent restart loops -->
        <do_if value="not $pilot_xp_blocked and $ship.order?">
          <!-- Update MaxBuy parameter if corrected -->
          <do_if value="$config.$MaxBuy != $config.$MaxBuyDistance">
            <edit_order_param order="$ship.order" param="'maxbuy'" value="$config.$MaxBuyDistance"/>
          </do_if>
          
          <!-- Update MaxSell parameter if corrected -->
          <do_if value="$config.$MaxSell != $config.$MaxSellDistance">
            <edit_order_param order="$ship.order" param="'maxsell'" value="$config.$MaxSellDistance"/>
          </do_if>
        </do_if>
        
        <set_value name="this.$result" exact="true"/>
      </actions>
    </library>
    
    <!-- Clean Up Stale Flags -->
    <library name="Cleanup_Stale_Flags">
      <params>
        <param name="ship" comment="Ship to clean up"/>
      </params>
      <actions>
        <!-- Clear stale predictive training flags -->
        <do_if value="$ship.$TrainingRequiredAfterThisTrade?">
          <debug_text text="'[GT-AI] ' + $ship.idcode + ': ðŸ§¹ Clearing stale predictive training flag'" chance="100"/>
          <remove_value name="$ship.$TrainingRequiredAfterThisTrade"/>
        </do_if>
        
        <!-- Clear stale training in progress flags (older than 5 minutes) -->
        <do_if value="$ship.$TrainingInProgress? and $ship.$TrainingStartTime?">
          <do_if value="(player.age - $ship.$TrainingStartTime) gt 300s">
            <debug_text text="'[GT-AI] ' + $ship.idcode + ': ðŸ§¹ Clearing stale training-in-progress flag (older than 5 minutes)'" chance="100"/>
            <remove_value name="$ship.$TrainingInProgress"/>
            <remove_value name="$ship.$TrainingStartTime"/>
          </do_if>
        </do_if>
        
        <set_value name="this.$result" exact="true"/>
      </actions>
    </library>
    
    <!-- ========================================= -->
    <!-- NUMBER FORMATTING UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Format Number with Thousand Separators and M Suffix -->
    <!-- Formats numbers according to global settings: thousand separator, decimal separator, M suffix threshold -->
    <library name="GT_FormatNumber" purpose="run_actions">
      <params>
        <param name="number" comment="Number to format (in credits, not RAW format)"/>
        <param name="suffix" default="' Cr'" comment="Suffix to append (default: ' Cr')"/>
      </params>
      <actions>
        <!-- Get formatting settings from global config -->
        <set_value name="$format" exact="if global.$GT_GlobalSettings.$NumberFormat.$Format? then global.$GT_GlobalSettings.$NumberFormat.$Format else 'german'"/>
        <!-- Set separators based on format choice -->
        <set_value name="$thousandSep" exact="if $format == 'german' then '.' else ','"/>
        <set_value name="$decimalSep" exact="if $format == 'german' then ',' else '.'"/>
        <set_value name="$useMSuffix" exact="if global.$GT_GlobalSettings.$NumberFormat.$UseMSuffix? then global.$GT_GlobalSettings.$NumberFormat.$UseMSuffix else true"/>
        <set_value name="$mThreshold" exact="if global.$GT_GlobalSettings.$NumberFormat.$MSuffixThreshold? then global.$GT_GlobalSettings.$NumberFormat.$MSuffixThreshold else 999999"/>
        
        <!-- Handle negative numbers -->
        <set_value name="$isNegative" exact="false"/>
        <set_value name="$absNumber" exact="$number"/>
        <do_if value="$number lt 0">
          <set_value name="$isNegative" exact="true"/>
          <set_value name="$absNumber" exact="-$number"/>
        </do_if>
        
        <!-- Check if we should use M suffix -->
        <set_value name="$useM" exact="false"/>
        <do_if value="$useMSuffix and $absNumber gt $mThreshold">
          <set_value name="$useM" exact="true"/>
        </do_if>
        
        <!-- Format the number -->
        <set_value name="$formatted" exact="''"/>
        <do_if value="$useM">
          <!-- Format as M suffix: e.g., "1,0 M" or "1.0 M" -->
          <!-- Use integer arithmetic: calculate value in tenths of millions, then round to nearest tenth -->
          <!-- Example: 1500000 -> 15 tenths -> 1.5 M -->
          <!-- Example: 1550000 -> 15.5 tenths -> round to 16 tenths -> 1.6 M -->
          <!-- Calculate value in hundredths for rounding precision -->
          <set_value name="$mValueTimes100" exact="($absNumber * 100) / 1000000"/>
          <!-- Round to nearest tenth: add 5 hundredths, then divide by 10 to get rounded tenths -->
          <set_value name="$mRoundedTimes10" exact="($mValueTimes100 + 5) / 10"/>
          <!-- Extract integer part (millions) -->
          <set_value name="$mInt" exact="$mRoundedTimes10 / 10"/>
          <!-- Extract decimal part (tenths) -->
          <set_value name="$mDec" exact="$mRoundedTimes10 - ($mInt * 10)"/>
          
          <!-- Build formatted string: "1,0" or "1.0" -->
          <set_value name="$mStr" exact="$mInt + ''"/>
          <do_if value="$mDec gt 0">
            <set_value name="$mStr" exact="$mStr + $decimalSep + $mDec"/>
          </do_if>
          <do_else>
            <!-- Always show at least one decimal: "1,0" or "1.0" -->
            <set_value name="$mStr" exact="$mStr + $decimalSep + '0'"/>
          </do_else>
          
          <set_value name="$formatted" exact="$mStr + ' M'"/>
        </do_if>
        <do_else>
          <!-- Format with thousand separators: e.g., "123.456" or "123,456" -->
          <!-- Use integer arithmetic to extract digits (more reliable than string operations) -->
          <set_value name="$result" exact="''"/>
          <set_value name="$remaining" exact="$absNumber"/>
          <set_value name="$digitCount" exact="0"/>
          
          <!-- Handle zero case -->
          <do_if value="$remaining == 0">
            <set_value name="$formatted" exact="'0'"/>
          </do_if>
          <do_else>
            <!-- Extract digits from right to left using integer arithmetic (no mod operator) -->
            <do_while value="$remaining gt 0">
              <!-- Get last digit using integer arithmetic: remaining - (remaining / 10) * 10 -->
              <set_value name="$digit" exact="$remaining - ($remaining / 10) * 10"/>
              <set_value name="$remaining" exact="$remaining / 10"/>
              
              <!-- Insert thousand separator every 3 digits (but not before first digit) -->
              <!-- Check if digitCount is divisible by 3 using integer arithmetic -->
              <set_value name="$digitCountDiv3" exact="$digitCount / 3"/>
              <set_value name="$digitCountMod3" exact="$digitCount - ($digitCountDiv3 * 3)"/>
              <do_if value="$digitCount gt 0 and $digitCountMod3 == 0">
                <set_value name="$result" exact="$thousandSep + $result"/>
              </do_if>
              
              <!-- Prepend digit to result -->
              <set_value name="$result" exact="$digit + $result"/>
              <set_value name="$digitCount" exact="$digitCount + 1"/>
            </do_while>
            
            <set_value name="$formatted" exact="$result"/>
          </do_else>
        </do_else>
        
        <!-- Add negative sign if needed -->
        <do_if value="$isNegative">
          <set_value name="$formatted" exact="'-' + $formatted"/>
        </do_if>
        
        <!-- Add suffix -->
        <set_value name="$formatted" exact="$formatted + $suffix"/>
        
        <!-- Return formatted string -->
        <return value="$formatted"/>
      </actions>
    </library>
    
    <!-- ========================================= -->
    <!-- LOGBOOK UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Is Logbook Enabled -->
    <library name="GT_IsLogbookEnabled" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to check logbook setting for"/>
      </params>
      <actions>
        <set_value name="$logEnabled" exact="false"/>
        <do_if value="@$ship.defaultorder.id == 'GalaxyTraderMK3' and @$ship.defaultorder.$logbookentries">
          <set_value name="$logEnabled" exact="true"/>
        </do_if>
        <do_elseif value="@$ship.defaultorder.id == 'Assist' and @$ship.commander.defaultorder.id == 'GalaxyTraderMK3' and @$ship.commander.defaultorder.$logbookentries">
          <set_value name="$logEnabled" exact="true"/>
        </do_elseif>
        <return value="$logEnabled"/>
      </actions>
    </library>
    
    <!-- Write Logbook Message -->
    <!-- Centralized logbook message creation for MD scripts -->
    <!-- IMPORTANT: X4 TextDB doesn't support list variables, so callers must construct message string first -->
    <!-- Use: {77000,ID}.[param1, param2, ...] to create message, then pass as Message parameter -->
    <library name="WriteLogbookMessage" purpose="run_actions">
      <params>
        <param name="Message" comment="Message string (REQUIRED - construct using {77000,ID}.[params] before calling)"/>
        <param name="Category" comment="Logbook category: alerts, upkeep, news, general, tips"/>
        <param name="Title" comment="Logbook entry title"/>
        <param name="Object" default="null" comment="Object to attach message to (ship, station, etc.)"/>
        <param name="Interaction" default="null" comment="Interaction type: 'showonmap' or null"/>
        <param name="Highlighted" default="false" comment="Whether to highlight message (true/false)"/>
        <param name="Money" default="null" comment="Money amount to display (negative for expenses, positive for income)"/>
        <param name="Bonus" default="null" comment="Bonus amount to display (typically profit)"/>
        <param name="CheckGlobalSettings" default="true" comment="Check global logbook settings before writing (default true)"/>
      </params>
      <actions>
        <!-- âœ… DEBUG MODE: Check if debug logging is enabled (if CheckGlobalSettings is true) -->
        <!-- Logbook messages now only write when debug is enabled -->
        <set_value name="$shouldWrite" exact="true"/>
        <do_if value="$CheckGlobalSettings">
          <set_value name="$shouldWrite" exact="false"/>
          <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Debug? and global.$GT_GlobalSettings.$Debug.$EnableDebugLogging? and global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$shouldWrite" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Write logbook if enabled -->
        <do_if value="$shouldWrite">
          <!-- Message is already constructed by caller using TextDB syntax -->
          <!-- Example: {77000,3218}.[@$newSector.knownname, @$currentDestination.knownname, ...] -->
          <!-- Determine object value -->
          <set_value name="$objectValue" exact="null"/>
          <do_if value="$Object? and $Object != null">
            <set_value name="$objectValue" exact="$Object"/>
          </do_if>
          
          <!-- Check if interaction is 'showonmap' -->
          <set_value name="$hasInteraction" exact="false"/>
          <do_if value="$Interaction? and $Interaction != null and $Interaction == 'showonmap'">
            <set_value name="$hasInteraction" exact="true"/>
          </do_if>
          
          <!-- Debug: Log before writing logbook -->
          <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Debug? and global.$GT_GlobalSettings.$Debug.$EnableDebugLogging? and global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$msgExists" exact="if $Message? then 'true' else 'false'"/>
            <set_value name="$msgNull" exact="if $Message == null then 'true' else 'false'"/>
            <set_value name="$msgEmpty" exact="if $Message == '' then 'true' else 'false'"/>
            <debug_text text="'[GT-Logbook] WriteLogbookMessage: Category=' + $Category + ', Title=' + $Title" chance="100"/>
            <debug_text text="'[GT-Logbook] Message exists=' + $msgExists + ', null=' + $msgNull + ', empty=' + $msgEmpty" chance="100"/>
          </do_if>
          
          <!-- Write logbook entry with conditional blocks for interaction, category, and money/bonus -->
          <!-- XSD requires literal values for category and interaction attributes -->
          <!-- Structure: interaction (with/without) -> category -> money/bonus -->
          <do_if value="$hasInteraction">
            <!-- WITH interaction="showonmap" -->
            <do_if value="$Category == 'alerts'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="alerts" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="alerts" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="alerts" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="alerts" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_if>
            <do_elseif value="$Category == 'upkeep'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="upkeep" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="upkeep" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="upkeep" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="upkeep" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_elseif value="$Category == 'news'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="news" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="news" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="news" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="news" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_elseif value="$Category == 'general'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_elseif value="$Category == 'tips'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="tips" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="tips" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="tips" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="tips" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_else>
              <!-- Default to 'general' if category not recognized -->
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_else>
          </do_if>
          <do_else>
            <!-- WITHOUT interaction attribute -->
            <do_if value="$Category == 'alerts'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="alerts" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="alerts" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="alerts" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="alerts" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_if>
            <do_elseif value="$Category == 'upkeep'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="upkeep" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="upkeep" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="upkeep" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="upkeep" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_elseif value="$Category == 'news'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="news" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="news" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="news" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="news" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_elseif value="$Category == 'general'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_elseif value="$Category == 'tips'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="tips" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="tips" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="tips" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="tips" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_else>
              <!-- Default to 'general' if category not recognized -->
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_else>
          </do_else>
        </do_if>
      </actions>
    </library>
    
    <!-- Handle Logbook Message from AI Scripts -->
    <!-- AI scripts cannot call MD libraries directly, so they signal this cue -->
    <!-- AI scripts construct messages using TextDB syntax before sending (vanilla pattern) -->
    <cue name="HandleLogbookMessage" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_WriteLogbook'"/>
      </conditions>
      <actions>
        <set_value name="$data" exact="event.param2"/>
        
        <!-- Call library with data from signal -->
        <!-- Message is already constructed by AI script using TextDB syntax -->
        <run_actions ref="md.GT_Libraries_General.WriteLogbookMessage">
          <param name="Message" value="$data.$Message"/>
          <param name="Category" value="$data.$Category"/>
          <param name="Title" value="$data.$Title"/>
          <param name="Object" value="if $data.$Object? then $data.$Object else null"/>
          <param name="Interaction" value="if $data.$Interaction? then $data.$Interaction else null"/>
          <param name="Highlighted" value="if $data.$Highlighted? then $data.$Highlighted else false"/>
          <param name="Money" value="if $data.$Money? then $data.$Money else null"/>
          <param name="Bonus" value="if $data.$Bonus? then $data.$Bonus else null"/>
          <param name="CheckGlobalSettings" value="if $data.$CheckGlobalSettings? then $data.$CheckGlobalSettings else true"/>
        </run_actions>
      </actions>
    </cue>

  </cues>
</mdscript>