<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Configuration" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- SINGLE SOURCE OF TRUTH: All configuration settings are managed here -->
    <!-- NO configuration should exist anywhere else in the mod -->
    <cue name="ConfigInit">
      <conditions>
        <check_any>
          <event_player_created/>
          <event_game_loaded/>
        </check_any>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3] Initializing configuration system...'" chance="100"/>
        
        <!-- âœ… ONE-TIME INITIALIZATION: Ensure all global table structures are valid -->
        <!-- This runs once on game start/load and guarantees all tables exist with proper structure -->
        <!-- This eliminates the need for repetitive checks throughout the codebase -->
        <run_actions ref="md.GT_Configuration.GT_InitializeGlobalTables"/>
        
        <!-- Trading Configuration -->
        <set_value name="global.$GT_Config" exact="table[]"/>
        <set_value name="global.$GT_Config.$Trading" exact="table[]"/>
        <set_value name="global.$GT_Config.$Trading.$MinROI" exact="0.10" comment="Minimum ROI percentage (10% = 0.10)"/>
        <set_value name="global.$GT_Config.$Trading.$MinAbsoluteProfit" exact="10000" comment="Absolute minimum profit (100 Cr in RAW format)"/>
        <set_value name="global.$GT_Config.$Trading.$CacheThresholdROI" exact="0.20" comment="Minimum ROI for caching trades (20% = 0.20)"/>
        <set_value name="global.$GT_Config.$Trading.$MaxTradeDistance" exact="5" comment="Maximum jump distance for trades"/>
        <set_value name="global.$GT_Config.$Trading.$RiskTolerance" exact="0.5" comment="0=safe only, 1=accept all risks"/>
        <set_value name="global.$GT_Config.$Trading.$CargoUtilization" exact="0.9" comment="Target cargo fill percentage"/>
        <set_value name="global.$GT_Config.$Trading.$UpdateInterval" exact="30s" comment="Market data refresh interval"/>
        <set_value name="global.$GT_Config.$Trading.$FactionPriority" exact="1" comment="0=Player only, 1=Foreign first, 2=Equal priority"/>
        
        <!-- Price Range Configuration (for trade offer collection) -->
        <!-- relativeprice ranges: -1.0 to +1.0, where negative = below average, positive = above average -->
        <set_value name="global.$GT_Config.$Trading.$SellPriceMax" exact="0.5" comment="Maximum relative price for sell offers (ship buys FROM stations). Default: 0.5 (50% above average). Higher = more expensive but more options"/>
        <set_value name="global.$GT_Config.$Trading.$BuyPriceMin" exact="-0.5" comment="Minimum relative price for buy offers (ship sells TO stations). Default: -0.5 (50% below average). Lower = cheaper buyers but more options"/>
        <set_value name="global.$GT_Config.$Trading.$IsolatedSellPriceMax" exact="1.0" comment="Sell price max for isolated ships (stuck in single sector). Default: 1.0 (accepts up to 100% above average - lowest profit margins)"/>
        <set_value name="global.$GT_Config.$Trading.$IsolatedBuyPriceMin" exact="0.0" comment="Buy price min for isolated ships (stuck in single sector). Default: 0.0 (accepts at average or above - lowest profit margins)"/>
        <set_value name="global.$GT_Config.$Trading.$FallbackSellPriceMax" exact="0.7" comment="Sell price max for fallback search (last resort when normal search fails). Default: 0.7 (accepts up to 70% above average - lower profit margins)"/>
        <set_value name="global.$GT_Config.$Trading.$FallbackBuyPriceMin" exact="-0.3" comment="Buy price min for fallback search (last resort when normal search fails). Default: -0.3 (accepts 30% below average - lower profit margins)"/>
        
        <!-- XP and Training Configuration -->
        <set_value name="global.$GT_Config.$XP" exact="table[]"/>
        <set_value name="global.$GT_Config.$XP.$Enabled" exact="true" comment="Enable XP progression system"/>
        
        <!-- DIFF PATCH XP CALCULATION PARAMETERS (Single Source of Truth) -->
        <!-- BALANCED FOR: ~500 trades to reach Level 15 (6000 XP) = ~12 XP average per trade -->
        <set_value name="global.$GT_Config.$XP.$BaseXPPerTrade" exact="8" comment="Base XP awarded per successful trade (diff patch system)"/>
        <set_value name="global.$GT_Config.$XP.$ValueDivisor" exact="100000" comment="Trade value divisor for value multiplier calculation"/>
        <set_value name="global.$GT_Config.$XP.$QualityMultiplier" exact="0.15" comment="Quality bonus multiplier (X4 quality * this value)"/>
        <set_value name="global.$GT_Config.$XP.$MaxDistanceForBonus" exact="10" comment="Maximum sector distance for distance bonus"/>
        <set_value name="global.$GT_Config.$XP.$DistanceBonusDivisor" exact="50.0" comment="Distance bonus calculation divisor"/>
        <set_value name="global.$GT_Config.$XP.$MinXPPerTrade" exact="5" comment="Minimum XP per trade (floor)"/>
        <set_value name="global.$GT_Config.$XP.$MaxXPPerTrade" exact="50" comment="Maximum XP per trade (ceiling)"/>
        
        <!-- LEGACY PARAMETERS - REMOVED: Event-driven system replaces polling -->
        
        <!-- XP Level Requirements (deprecated - kept for compatibility) -->
        <set_value name="global.$GT_Config.$XP.$LevelRequirements" exact="table[]"/>
        <set_value name="global.$GT_Config.$XP.$LevelRequirements.{1}" exact="0" comment="Level 1 (starting)"/>
        <set_value name="global.$GT_Config.$XP.$LevelRequirements.{2}" exact="500" comment="Level 2 (20-30 trades)"/>
        <set_value name="global.$GT_Config.$XP.$LevelRequirements.{3}" exact="1500" comment="Level 3"/>
        <set_value name="global.$GT_Config.$XP.$LevelRequirements.{4}" exact="3000" comment="Level 4"/>
        <set_value name="global.$GT_Config.$XP.$LevelRequirements.{5}" exact="5000" comment="Level 5 - Basic Training Required"/>
        <set_value name="global.$GT_Config.$XP.$LevelRequirements.{6}" exact="8000" comment="Level 6"/>
        <set_value name="global.$GT_Config.$XP.$LevelRequirements.{7}" exact="12000" comment="Level 7"/>
        <set_value name="global.$GT_Config.$XP.$LevelRequirements.{8}" exact="17000" comment="Level 8"/>
        <set_value name="global.$GT_Config.$XP.$LevelRequirements.{9}" exact="24000" comment="Level 9"/>
        <set_value name="global.$GT_Config.$XP.$LevelRequirements.{10}" exact="35000" comment="Level 10 - Advanced Training Required"/>
        
        <!-- XP to X4 Skill Level Mapping (1-15 skill levels, 3 per star) -->
        <set_value name="global.$GT_Config.$XP.$SkillThresholds" exact="table[]"/>
        <set_value name="global.$GT_Config.$XP.$SkillThresholds.{1}" exact="0" comment="Skill 1 - â­ (starting)"/>
        <set_value name="global.$GT_Config.$XP.$SkillThresholds.{2}" exact="100" comment="Skill 2 - â­"/>
        <set_value name="global.$GT_Config.$XP.$SkillThresholds.{3}" exact="250" comment="Skill 3 - â­"/>
        <set_value name="global.$GT_Config.$XP.$SkillThresholds.{4}" exact="450" comment="Skill 4 - â­â­"/>
        <set_value name="global.$GT_Config.$XP.$SkillThresholds.{5}" exact="700" comment="Skill 5 - â­â­"/>
        <set_value name="global.$GT_Config.$XP.$SkillThresholds.{6}" exact="1000" comment="Skill 6 - â­â­"/>
        <set_value name="global.$GT_Config.$XP.$SkillThresholds.{7}" exact="1350" comment="Skill 7 - â­â­â­"/>
        <set_value name="global.$GT_Config.$XP.$SkillThresholds.{8}" exact="1750" comment="Skill 8 - â­â­â­"/>
        <set_value name="global.$GT_Config.$XP.$SkillThresholds.{9}" exact="2200" comment="Skill 9 - â­â­â­"/>
        <set_value name="global.$GT_Config.$XP.$SkillThresholds.{10}" exact="2700" comment="Skill 10 - â­â­â­â­"/>
        <set_value name="global.$GT_Config.$XP.$SkillThresholds.{11}" exact="3250" comment="Skill 11 - â­â­â­â­"/>
        <set_value name="global.$GT_Config.$XP.$SkillThresholds.{12}" exact="3850" comment="Skill 12 - â­â­â­â­"/>
        <set_value name="global.$GT_Config.$XP.$SkillThresholds.{13}" exact="4500" comment="Skill 13 - â­â­â­â­â­"/>
        <set_value name="global.$GT_Config.$XP.$SkillThresholds.{14}" exact="5200" comment="Skill 14 - â­â­â­â­â­"/>
        <set_value name="global.$GT_Config.$XP.$SkillThresholds.{15}" exact="6000" comment="Skill 15 - â­â­â­â­â­ (max)"/>
        
        <!-- Trader Rank Titles for Ship Names (Translation IDs) -->
        <set_value name="global.$GT_Config.$XP.$TraderTitles" exact="table[]"/>
        <set_value name="global.$GT_Config.$XP.$TraderTitles.{1}" exact="{77000,6001}" comment="0-1 stars (skill 1-5) - Apprentice"/>
        <set_value name="global.$GT_Config.$XP.$TraderTitles.{2}" exact="{77000,6002}" comment="2 stars (skill 6-8) - Courier"/>
        <set_value name="global.$GT_Config.$XP.$TraderTitles.{3}" exact="{77000,6003}" comment="3 stars (skill 9-11) - Supplier"/>
        <set_value name="global.$GT_Config.$XP.$TraderTitles.{4}" exact="{77000,6004}" comment="4 stars (skill 12-14) - Trader"/>
        <set_value name="global.$GT_Config.$XP.$TraderTitles.{5}" exact="{77000,6005}" comment="5 stars (skill 15) - Merchant"/>
        <set_value name="global.$GT_Config.$XP.$TraderTitles.{6}" exact="{77000,6006}" comment="5 stars MAX (skill 15+) - Long-distance Merchant"/>
        
        <!-- Training Configuration -->
        <set_value name="global.$GT_Config.$Training" exact="table[]"/>
        <set_value name="global.$GT_Config.$Training.$RequiredLevels" exact="[3, 6, 9, 12]" comment="Levels that require training (every 3rd skill level for rank progression)"/>
        <set_value name="global.$GT_Config.$Training.$DurationMode" exact="'skill_based'" comment="skill_based, fixed, or progressive"/>
        <set_value name="global.$GT_Config.$Training.$BaseDuration" exact="600s" comment="Base training duration (10 minutes)"/>
        <set_value name="global.$GT_Config.$Training.$SkillMultiplier" exact="60s" comment="Additional time per skill level (skill_based mode)"/>
        <set_value name="global.$GT_Config.$Training.$ProgressiveIncrement" exact="30s" comment="Time increase per level (progressive mode)"/>
        <set_value name="global.$GT_Config.$Training.$RequireStation" exact="true" comment="Must be docked at valid station"/>
        <set_value name="global.$GT_Config.$Training.$ValidStationTypes" exact="['shipyard', 'wharf', 'tradestation', 'equipmentdock']"/>
        
        <!-- Fleet Coordination Configuration -->
        <set_value name="global.$GT_Config.$Fleet" exact="table[]"/>
        <set_value name="global.$GT_Config.$Fleet.$Enabled" exact="true" comment="Enable fleet coordination"/>
        <set_value name="global.$GT_Config.$Fleet.$MaxShipsPerRoute" exact="2" comment="Maximum ships on same trade route"/>
        <set_value name="global.$GT_Config.$Fleet.$RouteReservationTime" exact="300s" comment="Route exclusive reservation duration"/>
        <set_value name="global.$GT_Config.$Fleet.$TerritoryManagement" exact="true" comment="Enable sector specialization"/>
        <set_value name="global.$GT_Config.$Fleet.$LoadBalancing" exact="true" comment="Dynamic workload distribution"/>
        
        <!-- Market Intelligence Configuration -->
        <set_value name="global.$GT_Config.$Market" exact="table[]"/>
        <set_value name="global.$GT_Config.$Market.$PriceHistorySize" exact="10" comment="Number of price points to track"/>
        <set_value name="global.$GT_Config.$Market.$TrendAnalysis" exact="true" comment="Enable market trend prediction"/>
        <set_value name="global.$GT_Config.$Market.$CompetitorTracking" exact="true" comment="Monitor other traders"/>
        <set_value name="global.$GT_Config.$Market.$UpdateFrequency" exact="60s" comment="Market analysis update interval"/>
        
        <!-- Notification Configuration -->
        <set_value name="global.$GT_Config.$Notifications" exact="table[]"/>
        <set_value name="global.$GT_Config.$Notifications.$LevelUp" exact="true" comment="Notify on level advancement"/>
        <set_value name="global.$GT_Config.$Notifications.$TrainingRequired" exact="true" comment="Alert when training needed"/>
        <set_value name="global.$GT_Config.$Notifications.$TrainingCompleted" exact="true" comment="Notify when training completes"/>
        <set_value name="global.$GT_Config.$Notifications.$ProfitReports" exact="true" comment="Periodic profit summaries"/>
        <set_value name="global.$GT_Config.$Notifications.$MarketAlerts" exact="true" comment="Exceptional market opportunities"/>
        <set_value name="global.$GT_Config.$Notifications.$FleetUpdates" exact="false" comment="Fleet coordination messages"/>
        
        <!-- Ware Filter Configuration -->
        <set_value name="global.$GT_Config.$WareFilter" exact="table[]"/>
        <set_value name="global.$GT_Config.$WareFilter.$BlacklistedWares" exact="[]" comment="List of wares to exclude from trading (populated dynamically)"/>
        <set_value name="global.$GT_Config.$WareFilter.$WhitelistedWares" exact="[]" comment="List of allowed wares (empty = all except blacklisted)"/>
        <set_value name="global.$GT_Config.$WareFilter.$DangerousWareHandling" exact="'avoid'" comment="avoid, allow, or priority"/>
        <set_value name="global.$GT_Config.$WareFilter.$RestrictedFactions" exact="[]" comment="Factions to avoid trading with"/>
        <set_value name="global.$GT_Config.$WareFilter.$MinWareValue" exact="0Cr" comment="Minimum value per unit to consider"/>
        <set_value name="global.$GT_Config.$WareFilter.$MaxWareValue" exact="0Cr" comment="Maximum value per unit (0 = no limit)"/>
        
        <!-- Dynamic Ware Categorization Settings -->
        <set_value name="global.$GT_Config.$WareFilter.$AutoCategorizeLowValue" exact="true" comment="Automatically blacklist low-value wares"/>
        <set_value name="global.$GT_Config.$WareFilter.$AutoCategorizeDangerous" exact="true" comment="Automatically handle illegal wares"/>
        <set_value name="global.$GT_Config.$WareFilter.$LowValueThreshold" exact="50Cr" comment="Price threshold for low-value classification"/>
        <set_value name="global.$GT_Config.$WareFilter.$HighValueThreshold" exact="100000" comment="Price threshold for high-value classification (1000 Cr in RAW format)"/>
        <set_value name="global.$GT_Config.$WareFilter.$RefreshInterval" exact="3600s" comment="How often to refresh ware categories"/>
        
        <!-- Defensive Equipment Configuration (Level 15 Feature) -->
        <set_value name="global.$GT_Config.$Defense" exact="table[]"/>
        <set_value name="global.$GT_Config.$Defense.$Enabled" exact="true" comment="Enable auto-replenishment for Level 15 pilots"/>
        
        <!-- Individual equipment type toggles -->
        <set_value name="global.$GT_Config.$Defense.$RestockCountermeasures" exact="true" comment="Enable countermeasure restocking (all ships)"/>
        <set_value name="global.$GT_Config.$Defense.$RestockDefenseDrones" exact="true" comment="Enable defense drone restocking (L/XL ships)"/>
        <set_value name="global.$GT_Config.$Defense.$RestockTradeDrones" exact="true" comment="Enable trade drone restocking (L/XL ships)"/>
        <set_value name="global.$GT_Config.$Defense.$RestockLaserTowers" exact="true" comment="Enable laser tower restocking (all ships)"/>
        <set_value name="global.$GT_Config.$Defense.$RestockRepairDrones" exact="true" comment="Enable repair drone restocking (L/XL ships)"/>
        
        <!-- Capacity thresholds -->
        <set_value name="global.$GT_Config.$Defense.$CountermeasureThreshold" exact="50" comment="Restock countermeasures when below 50% capacity"/>
        <set_value name="global.$GT_Config.$Defense.$UnifiedThreshold" exact="70" comment="Restock unified capacity when below 70% total usage"/>
        
        <!-- Balance profile: 0=Balanced, 1=Defensive, 2=Trading-Focused, 3=Heavy Defense, 4=Tower Support -->
        <set_value name="global.$GT_Config.$Defense.$BalanceProfile" exact="2" comment="2=Trading-Focused (20/50/20/10) - DEFAULT for traders"/>
        
        <!-- Debug Configuration -->
        <set_value name="global.$GT_Config.$Debug" exact="table[]"/>
        <set_value name="global.$GT_Config.$Debug.$Enabled" exact="true" comment="Enable debug logging"/>
        <set_value name="global.$GT_Config.$Debug.$LogLevel" exact="2" comment="0=errors only, 1=info, 2=verbose"/>
        <set_value name="global.$GT_Config.$Debug.$PerformanceMetrics" exact="true" comment="Track performance data"/>
        <set_value name="global.$GT_Config.$Debug.$TradeSearch" exact="true" comment="Enable detailed trade search logging"/>
        <set_value name="global.$GT_Config.$Debug.$MarketData" exact="true" comment="Log market analysis details"/>
        <set_value name="global.$GT_Config.$Debug.$RouteCalculation" exact="true" comment="Log route calculation steps"/>
        <set_value name="global.$GT_Config.$Debug.$DiagnosticQueries" exact="false" comment="Enable diagnostic queries (4 galaxy-wide scans per cache miss - expensive!)"/>
        
        <!-- Version Information -->
        <set_value name="global.$GT_Config.$Version" exact="'1.0.0'"/>
        <set_value name="global.$GT_Config.$ConfigVersion" exact="2" comment="Configuration schema version (v2 = fixed training levels)"/>
        
        <!-- RETROACTIVE FIX: Clear incorrectly blocked pilots from old configuration -->
        <do_if value="global.$GT_Pilots?">
          <debug_text text="'[GalaxyTrader MK3] Checking for pilots incorrectly blocked under old training system...'" chance="100"/>
          <set_value name="$fixedPilots" exact="0"/>
          
          <!-- âœ… FIX: Use @ operator to safely access keys.count -->
          <set_value name="$pilotKeysCount" exact="@global.$GT_Pilots.keys.count"/>
          <do_if value="$pilotKeysCount? and $pilotKeysCount gt 0">
            <set_value name="$pilotKeys" exact="global.$GT_Pilots.keys.list"/>
            <do_all exact="$pilotKeysCount" counter="$i">
              <set_value name="$pilot" exact="$pilotKeys.{$i}"/>
              
              <!-- Check if pilot is blocked -->
              <do_if value="global.$GT_Pilots.{$pilot}.$XPBlocked?">
                <!-- Calculate current skill level from XP -->
                <set_value name="$currentSkillLevel" exact="1"/>
                <do_all exact="15" counter="$skillLevel">
                  <do_if value="global.$GT_Pilots.{$pilot}.$XP ge global.$GT_Config.$XP.$SkillThresholds.{$skillLevel}">
                    <set_value name="$currentSkillLevel" exact="$skillLevel"/>
                  </do_if>
                </do_all>
                
                <!-- Check if this skill level should actually be blocked -->
                <set_value name="$shouldBeBlocked" exact="false"/>
                <!-- Check if skill level requires training using explicit loop (indexof unreliable for lists) -->
                <set_value name="$requiresTraining" exact="false"/>
                <do_if value="global.$GT_Config.$Training.$RequiredLevels?">
                  <do_all exact="global.$GT_Config.$Training.$RequiredLevels.count" counter="$i">
                    <do_if value="global.$GT_Config.$Training.$RequiredLevels.{$i} == $currentSkillLevel">
                      <set_value name="$requiresTraining" exact="true"/>
                      <break/>
                    </do_if>
                  </do_all>
                </do_if>
                
                <do_if value="$requiresTraining">
                  <!-- Check if training is completed using explicit loop (indexof unreliable for lists) -->
                  <set_value name="$hasCompletedTraining" exact="false"/>
                  <do_if value="global.$GT_Pilots.{$pilot}.$TrainingCompleted?">
                    <do_all exact="global.$GT_Pilots.{$pilot}.$TrainingCompleted.count" counter="$j">
                      <do_if value="global.$GT_Pilots.{$pilot}.$TrainingCompleted.{$j} == $currentSkillLevel">
                        <set_value name="$hasCompletedTraining" exact="true"/>
                        <break/>
                      </do_if>
                    </do_all>
                  </do_if>
                  
                  <do_if value="not $hasCompletedTraining">
                    <set_value name="$shouldBeBlocked" exact="true"/>
                  </do_if>
                </do_if>
                
                <!-- Fix incorrectly blocked pilots -->
                <do_if value="not $shouldBeBlocked">
                  <debug_text text="'[GalaxyTrader MK3] ðŸ”§ RETROACTIVE FIX: Clearing incorrect XP block for pilot ' + $pilot.name + ' (skill level ' + $currentSkillLevel + ', XP: ' + global.$GT_Pilots.{$pilot}.$XP + ')'" chance="100"/>
                  <remove_value name="global.$GT_Pilots.{$pilot}.$XPBlocked"/>
                  <remove_value name="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
                  <set_value name="$fixedPilots" exact="$fixedPilots + 1"/>
                </do_if>
              </do_if>
            </do_all>
          </do_if>
          
          <do_if value="$fixedPilots gt 0">
            <debug_text text="'[GalaxyTrader MK3] âœ… RETROACTIVE FIX COMPLETE: Cleared XP blocks for ' + $fixedPilots + ' pilots'" chance="100"/>
            <show_notification text="'GalaxyTrader MK3: Fixed XP progression for ' + $fixedPilots + ' pilots!'" timeout="8s" priority="7"/>
          </do_if>
          <do_else>
            <debug_text text="'[GalaxyTrader MK3] No incorrectly blocked pilots found'" chance="100"/>
          </do_else>
        </do_if>
        
        <debug_text text="'[GalaxyTrader MK3] Configuration system initialized successfully'" chance="100"/>
      </actions>
    </cue>
    
    <!-- PHASE 2 IMPROVEMENT: Event-Driven Configuration System -->
    <!-- Initialize configuration event system -->
    <cue name="InitConfigurationEvents" instantiate="true">
      <conditions>
        <event_cue_signalled cue="ConfigInit"/>
      </conditions>
      <actions>
        <!-- Initialize configuration event queue -->
        <set_value name="global.$GT_ConfigEventQueue" exact="[]"/>
        
        <debug_text text="'[GalaxyTrader MK3] âš¡ Configuration event system initialized (event-driven)'" chance="100"/>
      </actions>
    </cue>
    
    <!-- Event-Driven Configuration Processing -->
    <!-- âœ… EVENT-DRIVEN: Listen for signal instead of polling -->
    <!-- NOTE: Currently unused, but ready for future event-driven config updates -->
    <cue name="ProcessConfigurationEvents" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_Configuration.ProcessConfigurationEvents"/>
      </conditions>
      <actions>
        
        <!-- Process all queued configuration events -->
        <do_if value="global.$GT_ConfigEventQueue? and global.$GT_ConfigEventQueue.count gt 0">
          <debug_text text="'[GalaxyTrader MK3] âš¡ Processing ' + global.$GT_ConfigEventQueue.count + ' config events instantly'" chance="100"/>
          
          <do_while value="global.$GT_ConfigEventQueue.count gt 0">
            <!-- Get next event -->
            <set_value name="$event" exact="global.$GT_ConfigEventQueue.{1}"/>
            <remove_from_list name="global.$GT_ConfigEventQueue" exact="$event"/>
            
            <!-- Process based on event type -->
            <do_if value="$event.$eventType == 'config_update'">
              <signal_cue_instantly cue="HandleConfigUpdate" param="$event"/>
            </do_if>
            <do_elseif value="$event.$eventType == 'validation_request'">
              <signal_cue_instantly cue="HandleConfigValidation" param="$event"/>
            </do_elseif>
            <do_elseif value="$event.$eventType == 'reload_request'">
              <signal_cue_instantly cue="HandleConfigReload" param="$event"/>
            </do_elseif>
          </do_while>
        </do_if>
      </actions>
    </cue>
    
    <!-- Handle Configuration Updates -->
    <cue name="HandleConfigUpdate" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$event" exact="event.param"/>
        <set_value name="$section" exact="$event.$section"/>
        <set_value name="$key" exact="$event.$key"/>
        <set_value name="$value" exact="$event.$value"/>
        <set_value name="$source" exact="$event.$source"/>
        
        <debug_text text="'[GalaxyTrader MK3] Config update event: ' + $section + '.' + $key + ' = ' + $value + ' (source: ' + $source + ')'" chance="100"/>
        
        <!-- Apply the configuration change -->
        <do_if value="$section == 'Trading'">
          <set_value name="global.$GT_Config.$Trading.{$key}" exact="$value"/>
        </do_if>
        <do_elseif value="$section == 'XP'">
          <set_value name="global.$GT_Config.$XP.{$key}" exact="$value"/>
        </do_elseif>
        <do_elseif value="$section == 'Fleet'">
          <set_value name="global.$GT_Config.$Fleet.{$key}" exact="$value"/>
        </do_elseif>
        <do_elseif value="$section == 'Debug'">
          <set_value name="global.$GT_Config.$Debug.{$key}" exact="$value"/>
        </do_elseif>
        
        <!-- Trigger validation -->
        <signal_cue_instantly cue="ValidateConfigChange" param="table[$section = $section, $key = $key, $value = $value]"/>
        
        <!-- Notify other systems -->
        <signal_cue_instantly cue="md.GT_FleetCoordination.OnConfigurationChanged" param="table[$section = $section, $key = $key, $value = $value]"/>
        <signal_cue_instantly cue="md.GT_TradingAI.OnConfigurationChanged" param="table[$section = $section, $key = $key, $value = $value]"/>
      </actions>
    </cue>
    
    <!-- Validate Configuration Changes -->
    <cue name="ValidateConfigChange" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$params" exact="event.param"/>
        <set_value name="$section" exact="$params.$section"/>
        <set_value name="$key" exact="$params.$key"/>
        <set_value name="$value" exact="$params.$value"/>
        
        <!-- Validate based on section and key -->
        <set_value name="$isValid" exact="true"/>
        <set_value name="$message" exact="''"/>
        
        <do_if value="$section == 'Trading'">
          <do_if value="$key == 'MinROI'">
            <do_if value="$value lt 0 or $value gt 2.0">
              <set_value name="$isValid" exact="false"/>
              <set_value name="$message" exact="'MinROI must be between 0.0 and 2.0 (200%)'"/>
            </do_if>
          </do_if>
          <do_elseif value="$key == 'MinAbsoluteProfit'">
            <do_if value="$value le 0">
              <set_value name="$isValid" exact="false"/>
              <set_value name="$message" exact="'MinAbsoluteProfit must be positive'"/>
            </do_if>
          </do_elseif>
          <do_elseif value="$key == 'RiskTolerance'">
            <do_if value="$value lt 0 or $value gt 1">
              <set_value name="$isValid" exact="false"/>
              <set_value name="$message" exact="'RiskTolerance must be between 0.0 and 1.0'"/>
            </do_if>
          </do_elseif>
          <do_elseif value="$key == 'FactionPriority'">
            <do_if value="$value lt 0 or $value gt 2">
              <set_value name="$isValid" exact="false"/>
              <set_value name="$message" exact="'FactionPriority must be 0 (Player only), 1 (Foreign first), or 2 (Equal)'"/>
            </do_if>
          </do_elseif>
        </do_if>
        <do_elseif value="$section == 'Fleet'">
          <do_if value="$key == 'MaxShipsPerRoute'">
            <do_if value="$value le 0">
              <set_value name="$isValid" exact="false"/>
              <set_value name="$message" exact="'MaxShipsPerRoute must be positive'"/>
            </do_if>
          </do_if>
        </do_elseif>
        
        <do_if value="not $isValid">
          <debug_text text="'[GalaxyTrader MK3] âŒ Invalid configuration: ' + $message" chance="100"/>
          <show_notification text="'GalaxyTrader MK3: Invalid config - ' + $message" timeout="5s" priority="6"/>
        </do_if>
        <do_else>
          <debug_text text="'[GalaxyTrader MK3] âœ… Configuration validated: ' + $section + '.' + $key" chance="100"/>
        </do_else>
      </actions>
    </cue>

    <!-- Configuration Hot Reload Detection - REMOVED: Pure event-driven system -->
    
    <!-- Configuration Validation -->
    <cue name="ConfigValidation" instantiate="true">
      <conditions>
        <event_cue_signalled cue="ConfigInit"/>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3] Validating configuration...'" chance="100"/>
        
        <!-- Validate critical settings -->
        <do_if value="global.$GT_Config.$Trading.$MinROI lt 0 or global.$GT_Config.$Trading.$MinROI gt 2.0">
          <set_value name="global.$GT_Config.$Trading.$MinROI" exact="0.10"/>
          <debug_text text="'[GalaxyTrader MK3] WARNING: Invalid MinROI, reset to 10%'" chance="100"/>
        </do_if>
        
        <do_if value="global.$GT_Config.$Trading.$MinAbsoluteProfit le 0">
          <set_value name="global.$GT_Config.$Trading.$MinAbsoluteProfit" exact="10000"/>
          <debug_text text="'[GalaxyTrader MK3] WARNING: Invalid MinAbsoluteProfit, reset to 100Cr (10000 RAW)'" chance="100"/>
        </do_if>
        
        <do_if value="global.$GT_Config.$Trading.$RiskTolerance lt 0 or global.$GT_Config.$Trading.$RiskTolerance gt 1">
          <set_value name="global.$GT_Config.$Trading.$RiskTolerance" exact="0.5"/>
          <debug_text text="'[GalaxyTrader MK3] WARNING: Invalid RiskTolerance, reset to default'" chance="100"/>
        </do_if>
        
        <do_if value="global.$GT_Config.$Trading.$FactionPriority? and (global.$GT_Config.$Trading.$FactionPriority lt 0 or global.$GT_Config.$Trading.$FactionPriority gt 2)">
          <set_value name="global.$GT_Config.$Trading.$FactionPriority" exact="1"/>
          <debug_text text="'[GalaxyTrader MK3] WARNING: Invalid FactionPriority, reset to Foreign First'" chance="100"/>
        </do_if>
        
        <!-- Validate price range settings (relativeprice: -1.0 to +1.0) -->
        <do_if value="global.$GT_Config.$Trading.$SellPriceMax? and (global.$GT_Config.$Trading.$SellPriceMax lt -1.0 or global.$GT_Config.$Trading.$SellPriceMax gt 1.0)">
          <set_value name="global.$GT_Config.$Trading.$SellPriceMax" exact="0.5"/>
          <debug_text text="'[GalaxyTrader MK3] WARNING: Invalid SellPriceMax, reset to 0.5 (50% above average)'" chance="100"/>
        </do_if>
        <do_if value="global.$GT_Config.$Trading.$BuyPriceMin? and (global.$GT_Config.$Trading.$BuyPriceMin lt -1.0 or global.$GT_Config.$Trading.$BuyPriceMin gt 1.0)">
          <set_value name="global.$GT_Config.$Trading.$BuyPriceMin" exact="-0.5"/>
          <debug_text text="'[GalaxyTrader MK3] WARNING: Invalid BuyPriceMin, reset to -0.5 (50% below average)'" chance="100"/>
        </do_if>
        <do_if value="global.$GT_Config.$Trading.$IsolatedSellPriceMax? and (global.$GT_Config.$Trading.$IsolatedSellPriceMax lt -1.0 or global.$GT_Config.$Trading.$IsolatedSellPriceMax gt 1.0)">
          <set_value name="global.$GT_Config.$Trading.$IsolatedSellPriceMax" exact="1.0"/>
          <debug_text text="'[GalaxyTrader MK3] WARNING: Invalid IsolatedSellPriceMax, reset to 1.0'" chance="100"/>
        </do_if>
        <do_if value="global.$GT_Config.$Trading.$IsolatedBuyPriceMin? and (global.$GT_Config.$Trading.$IsolatedBuyPriceMin lt -1.0 or global.$GT_Config.$Trading.$IsolatedBuyPriceMin gt 1.0)">
          <set_value name="global.$GT_Config.$Trading.$IsolatedBuyPriceMin" exact="0.0"/>
          <debug_text text="'[GalaxyTrader MK3] WARNING: Invalid IsolatedBuyPriceMin, reset to 0.0'" chance="100"/>
        </do_if>
        <do_if value="global.$GT_Config.$Trading.$FallbackSellPriceMax? and (global.$GT_Config.$Trading.$FallbackSellPriceMax lt -1.0 or global.$GT_Config.$Trading.$FallbackSellPriceMax gt 1.0)">
          <set_value name="global.$GT_Config.$Trading.$FallbackSellPriceMax" exact="0.7"/>
          <debug_text text="'[GalaxyTrader MK3] WARNING: Invalid FallbackSellPriceMax, reset to 0.7'" chance="100"/>
        </do_if>
        <do_if value="global.$GT_Config.$Trading.$FallbackBuyPriceMin? and (global.$GT_Config.$Trading.$FallbackBuyPriceMin lt -1.0 or global.$GT_Config.$Trading.$FallbackBuyPriceMin gt 1.0)">
          <set_value name="global.$GT_Config.$Trading.$FallbackBuyPriceMin" exact="-0.3"/>
          <debug_text text="'[GalaxyTrader MK3] WARNING: Invalid FallbackBuyPriceMin, reset to -0.3'" chance="100"/>
        </do_if>
        
        <do_if value="global.$GT_Config.$XP.$LevelRequirements.count lt 10">
          <debug_text text="'[GalaxyTrader MK3] ERROR: Invalid level requirements table'" chance="100"/>
        </do_if>
        
        <!-- Validate ware filter settings -->
        <do_if value="not global.$GT_Config.$WareFilter.$BlacklistedWares?">
          <set_value name="global.$GT_Config.$WareFilter.$BlacklistedWares" exact="[]"/>
          <debug_text text="'[GalaxyTrader MK3] WARNING: Invalid BlacklistedWares, reset to empty'" chance="100"/>
        </do_if>
        
        <do_if value="global.$GT_Config.$WareFilter.$DangerousWareHandling != 'avoid' and global.$GT_Config.$WareFilter.$DangerousWareHandling != 'allow' and global.$GT_Config.$WareFilter.$DangerousWareHandling != 'priority'">
          <set_value name="global.$GT_Config.$WareFilter.$DangerousWareHandling" exact="'avoid'"/>
          <debug_text text="'[GalaxyTrader MK3] WARNING: Invalid DangerousWareHandling, reset to avoid'" chance="100"/>
        </do_if>
        
        <debug_text text="'[GalaxyTrader MK3] Configuration validation complete'" chance="100"/>
      </actions>
    </cue>
    
    <!-- Manual Cleanup Trigger for Development/Testing -->
    <cue name="ManualCleanup" instantiate="true" checkinterval="1s">
      <conditions>
        <check_value value="global.$GT_ForceCleanup?"/>
      </conditions>
      <actions>
        <remove_value name="global.$GT_ForceCleanup"/>
        <debug_text text="'[GalaxyTrader MK3] ðŸ”§ MANUAL CLEANUP: Forcing immediate pilot block cleanup...'" chance="100"/>
        
        <do_if value="global.$GT_Pilots?">
          <set_value name="$fixedPilots" exact="0"/>
          
          <!-- âœ… FIX: Use @ operator to safely access keys.count -->
          <set_value name="$pilotKeysCount" exact="@global.$GT_Pilots.keys.count"/>
          <do_if value="$pilotKeysCount? and $pilotKeysCount gt 0">
            <set_value name="$pilotKeys" exact="global.$GT_Pilots.keys.list"/>
            <do_all exact="$pilotKeysCount" counter="$i">
              <set_value name="$pilot" exact="$pilotKeys.{$i}"/>
              
              <!-- Check if pilot is blocked -->
              <do_if value="global.$GT_Pilots.{$pilot}.$XPBlocked?">
                <!-- Calculate current skill level from XP -->
                <set_value name="$currentSkillLevel" exact="1"/>
                <do_all exact="15" counter="$skillLevel">
                  <do_if value="global.$GT_Pilots.{$pilot}.$XP ge global.$GT_Config.$XP.$SkillThresholds.{$skillLevel}">
                    <set_value name="$currentSkillLevel" exact="$skillLevel"/>
                  </do_if>
                </do_all>
                
                <!-- Check if this skill level should actually be blocked using explicit loop (indexof unreliable for lists) -->
                <set_value name="$shouldBeBlocked" exact="false"/>
                <set_value name="$requiresTraining" exact="false"/>
                <do_if value="global.$GT_Config.$Training.$RequiredLevels?">
                  <do_all exact="global.$GT_Config.$Training.$RequiredLevels.count" counter="$k">
                    <do_if value="global.$GT_Config.$Training.$RequiredLevels.{$k} == $currentSkillLevel">
                      <set_value name="$requiresTraining" exact="true"/>
                      <break/>
                    </do_if>
                  </do_all>
                </do_if>
                
                <do_if value="$requiresTraining">
                  <!-- Check if training is completed using explicit loop (indexof unreliable for lists) -->
                  <set_value name="$hasCompletedTraining" exact="false"/>
                  <do_if value="global.$GT_Pilots.{$pilot}.$TrainingCompleted?">
                    <do_all exact="global.$GT_Pilots.{$pilot}.$TrainingCompleted.count" counter="$m">
                      <do_if value="global.$GT_Pilots.{$pilot}.$TrainingCompleted.{$m} == $currentSkillLevel">
                        <set_value name="$hasCompletedTraining" exact="true"/>
                        <break/>
                      </do_if>
                    </do_all>
                  </do_if>
                  
                  <do_if value="not $hasCompletedTraining">
                    <set_value name="$shouldBeBlocked" exact="true"/>
                  </do_if>
                </do_if>
                
                <!-- Debug the decision -->
                <debug_text text="'[GalaxyTrader MK3] ðŸ”§ Pilot ' + $pilot.name + ': skill=' + $currentSkillLevel + ', in training list=' + global.$GT_Config.$Training.$RequiredLevels.indexof.{$currentSkillLevel} + ', should be blocked=' + $shouldBeBlocked" chance="100"/>
                
                <!-- Fix incorrectly blocked pilots -->
                <do_if value="not $shouldBeBlocked">
                  <debug_text text="'[GalaxyTrader MK3] ðŸ”§ MANUAL CLEANUP: Clearing incorrect XP block for pilot ' + $pilot.name + ' (skill level ' + $currentSkillLevel + ', XP: ' + global.$GT_Pilots.{$pilot}.$XP + ')'" chance="100"/>
                  <remove_value name="global.$GT_Pilots.{$pilot}.$XPBlocked"/>
                  <remove_value name="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
                  <set_value name="$fixedPilots" exact="$fixedPilots + 1"/>
                </do_if>
              </do_if>
            </do_all>
          </do_if>
          
          <debug_text text="'[GalaxyTrader MK3] âœ… MANUAL CLEANUP COMPLETE: Fixed ' + $fixedPilots + ' pilots'" chance="100"/>
          <show_notification text="'GalaxyTrader MK3: Manual cleanup fixed ' + $fixedPilots + ' pilots!'" timeout="8s" priority="7"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- ========================================
         GLOBAL TABLES INITIALIZATION
         One-time initialization of all global table structures
         Runs on game start/load to ensure save game compatibility
         ======================================== -->
    <library name="GT_InitializeGlobalTables" purpose="run_actions">
      <actions>
        <debug_text text="'[GT-Init] Initializing global table structures...'" chance="100"/>
        
        <!-- Initialize global.$GT_SearchResult structure -->
        <set_value name="$initCount" exact="0"/>
        <!-- Extract existing data if valid, then rebuild structure atomically -->
        <set_value name="$existingSearchResult" exact="@global.$GT_SearchResult"/>
        <set_value name="$existingSearchResultValid" exact="false"/>
        <set_value name="$existingLastRejectionStats" exact="null"/>
        <do_if value="$existingSearchResult?">
          <set_value name="$existingKeysCount" exact="@$existingSearchResult.keys.count"/>
          <do_if value="$existingKeysCount? and $existingKeysCount ge 0">
            <set_value name="$existingSearchResultValid" exact="true"/>
            <!-- Extract existing $LastRejectionStats if valid -->
            <set_value name="$tempStats" exact="@$existingSearchResult.$LastRejectionStats"/>
            <do_if value="$tempStats?">
              <set_value name="$tempStatsKeysCount" exact="@$tempStats.keys.count"/>
              <do_if value="$tempStatsKeysCount? and $tempStatsKeysCount ge 0">
                <set_value name="$existingLastRejectionStats" exact="$tempStats"/>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
        <!-- Build new structure atomically: preserve existing $LastRejectionStats if valid, otherwise create empty -->
        <set_value name="$newLastRejectionStats" exact="table[]"/>
        <do_if value="$existingLastRejectionStats?">
          <set_value name="$newLastRejectionStats" exact="$existingLastRejectionStats"/>
        </do_if>
        <!-- Build new $searchResultTable with all existing properties (if valid) plus guaranteed $LastRejectionStats -->
        <set_value name="$newSearchResultTable" exact="table[$LastRejectionStats = $newLastRejectionStats]"/>
        <!-- Copy other existing properties if valid -->
        <do_if value="$existingSearchResultValid">
          <set_value name="$existingKeys" exact="@$existingSearchResult.keys"/>
          <do_if value="$existingKeys?">
            <do_all exact="$existingKeys.count" counter="$k">
              <set_value name="$key" exact="$existingKeys.{$k}"/>
              <!-- Skip $LastRejectionStats as we already set it -->
              <do_if value="$key != 'LastRejectionStats'">
                <set_value name="$newSearchResultTable.{$key}" exact="@$existingSearchResult.{$key}"/>
              </do_if>
            </do_all>
          </do_if>
        </do_if>
        <!-- Set atomically - this guarantees structure is always valid -->
        <set_value name="global.$GT_SearchResult" exact="$newSearchResultTable"/>
        <set_value name="$initCount" exact="$initCount + 1"/>
        
        <!-- Initialize global.$GT_TradeLogging structure -->
        <!-- Check if global.$GT_TradeLogging exists AND is a valid table (not null) -->
        <set_value name="$tradeLoggingValid" exact="false"/>
        <do_if value="global.$GT_TradeLogging?">
          <set_value name="$tradeLoggingKeysCount" exact="@global.$GT_TradeLogging.keys.count"/>
          <do_if value="$tradeLoggingKeysCount? and $tradeLoggingKeysCount ge 0">
            <set_value name="$tradeLoggingValid" exact="true"/>
          </do_if>
        </do_if>
        <do_if value="not $tradeLoggingValid">
          <set_value name="global.$GT_TradeLogging" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        <set_value name="$checkLifetime" exact="@global.$GT_TradeLogging.$LifetimeProfit"/>
        <set_value name="$lifetimeValid" exact="false"/>
        <do_if value="$checkLifetime?">
          <set_value name="$lifetimeKeysCount" exact="@$checkLifetime.keys.count"/>
          <do_if value="$lifetimeKeysCount? and $lifetimeKeysCount ge 0">
            <set_value name="$lifetimeValid" exact="true"/>
          </do_if>
        </do_if>
        <do_if value="not $lifetimeValid">
          <set_value name="global.$GT_TradeLogging.$LifetimeProfit" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_SearchQueue structure -->
        <!-- Check if global.$GT_SearchQueue exists AND is a valid table (not null) -->
        <set_value name="$searchQueueValid" exact="false"/>
        <do_if value="global.$GT_SearchQueue?">
          <set_value name="$searchQueueKeysCount" exact="@global.$GT_SearchQueue.keys.count"/>
          <do_if value="$searchQueueKeysCount? and $searchQueueKeysCount ge 0">
            <set_value name="$searchQueueValid" exact="true"/>
          </do_if>
        </do_if>
        <do_if value="not $searchQueueValid">
          <set_value name="global.$GT_SearchQueue" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        <set_value name="$checkParams" exact="@global.$GT_SearchQueue.$Params"/>
        <set_value name="$paramsValid" exact="false"/>
        <do_if value="$checkParams?">
          <set_value name="$paramsKeysCount" exact="@$checkParams.keys.count"/>
          <do_if value="$paramsKeysCount? and $paramsKeysCount ge 0">
            <set_value name="$paramsValid" exact="true"/>
          </do_if>
        </do_if>
        <do_if value="not $paramsValid">
          <set_value name="global.$GT_SearchQueue.$Params" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        <!-- Ensure other SearchQueue properties exist -->
        <do_if value="not global.$GT_SearchQueue.$Ships?">
          <set_value name="global.$GT_SearchQueue.$Ships" exact="[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        <do_if value="not global.$GT_SearchQueue.$ActiveSearches?">
          <set_value name="global.$GT_SearchQueue.$ActiveSearches" exact="0"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        <do_if value="not global.$GT_SearchQueue.$MaxConcurrent?">
          <set_value name="$maxConcurrent" exact="1"/>
          <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$MaxConcurrentSearches?">
            <set_value name="$maxConcurrent" exact="@global.$GT_GlobalSettings.$Performance.$MaxConcurrentSearches"/>
          </do_if>
          <set_value name="global.$GT_SearchQueue.$MaxConcurrent" exact="$maxConcurrent"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_FallbackAttempted structure -->
        <do_if value="not global.$GT_FallbackAttempted?">
          <set_value name="global.$GT_FallbackAttempted" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_BatchDataList structure (used for batch processing state) -->
        <!-- Check if global.$GT_BatchDataList exists AND is a valid table (not null) -->
        <set_value name="$batchDataListValid" exact="false"/>
        <do_if value="global.$GT_BatchDataList?">
          <set_value name="$batchDataListKeysCount" exact="@global.$GT_BatchDataList.keys.count"/>
          <do_if value="$batchDataListKeysCount? and $batchDataListKeysCount ge 0">
            <set_value name="$batchDataListValid" exact="true"/>
          </do_if>
        </do_if>
        <do_if value="not $batchDataListValid">
          <set_value name="global.$GT_BatchDataList" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        <!-- âœ… VALIDATION: Clean up invalid entries in existing batch data (save game compatibility) -->
        <!-- Old save games might have stale batch data with null or invalid entries -->
        <do_if value="$batchDataListValid">
          <set_value name="$batchDataKeys" exact="@global.$GT_BatchDataList.keys"/>
          <set_value name="$cleanedEntries" exact="0"/>
          <do_if value="$batchDataKeys?">
            <set_value name="$batchDataKeysCount" exact="@$batchDataKeys.count"/>
            <do_if value="$batchDataKeysCount? and $batchDataKeysCount gt 0">
              <!-- Iterate through all entries and validate them -->
              <do_all exact="$batchDataKeysCount" counter="$i">
                <set_value name="$shipKey" exact="$batchDataKeys.{$i}"/>
                <set_value name="$batchState" exact="@global.$GT_BatchDataList.{$shipKey}"/>
                <!-- Check if entry is valid table -->
                <set_value name="$entryValid" exact="false"/>
                <do_if value="$batchState?">
                  <set_value name="$batchStateKeysCount" exact="@$batchState.keys.count"/>
                  <do_if value="$batchStateKeysCount? and $batchStateKeysCount ge 0">
                    <!-- Check if critical list properties exist and are valid -->
                    <set_value name="$wareKeysList" exact="@$batchState.$wareKeysList"/>
                    <set_value name="$sellOffersList" exact="@$batchState.$sellOffersList"/>
                    <set_value name="$buyOffersList" exact="@$batchState.$buyOffersList"/>
                    <do_if value="$wareKeysList? and $sellOffersList? and $buyOffersList?">
                      <set_value name="$entryValid" exact="true"/>
                    </do_if>
                  </do_if>
                </do_if>
                <!-- Remove invalid entries -->
                <do_if value="not $entryValid">
                  <remove_value name="global.$GT_BatchDataList.{$shipKey}"/>
                  <set_value name="$cleanedEntries" exact="$cleanedEntries + 1"/>
                </do_if>
              </do_all>
            </do_if>
          </do_if>
          <do_if value="$cleanedEntries gt 0">
            <debug_text text="'[GT-Init] ðŸ§¹ Cleaned up ' + $cleanedEntries + ' invalid batch data entry/entries'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Initialize global.$GT_BatchResultsList structure (used for batch results) -->
        <do_if value="not global.$GT_BatchResultsList?">
          <set_value name="global.$GT_BatchResultsList" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_TradeCache structure (used for trade caching) -->
        <do_if value="not global.$GT_TradeCache?">
          <set_value name="global.$GT_TradeCache" exact="[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_FilterState structure (used for filtering state) -->
        <do_if value="not global.$GT_FilterState?">
          <set_value name="global.$GT_FilterState" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_CacheMissCooldowns structure (used for cooldown tracking) -->
        <!-- âœ… FIX: Handle both non-existent and null values (save game compatibility) -->
        <!-- Pattern: Check if global exists first, then extract and validate keys.count inside the check -->
        <set_value name="$cacheMissCooldownsValid" exact="false"/>
        <do_if value="global.$GT_CacheMissCooldowns?">
          <set_value name="$cacheMissCooldownsKeysCount" exact="@global.$GT_CacheMissCooldowns.keys.count"/>
          <do_if value="$cacheMissCooldownsKeysCount? and $cacheMissCooldownsKeysCount ge 0">
            <set_value name="$cacheMissCooldownsValid" exact="true"/>
          </do_if>
        </do_if>
        <do_if value="not $cacheMissCooldownsValid">
          <set_value name="global.$GT_CacheMissCooldowns" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_ActiveTradeReservations structure (used for fleet coordination) -->
        <do_if value="not global.$GT_ActiveTradeReservations?">
          <set_value name="global.$GT_ActiveTradeReservations" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_MaintenanceFailedResupply structure (used for resupply cooldowns) -->
        <do_if value="not global.$GT_MaintenanceFailedResupply?">
          <set_value name="global.$GT_MaintenanceFailedResupply" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_PendingTrades structure (used for trade tracking) -->
        <do_if value="not global.$GT_PendingTrades?">
          <set_value name="global.$GT_PendingTrades" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_TradeStats structure (used for trade statistics) -->
        <do_if value="not global.$GT_TradeStats?">
          <set_value name="global.$GT_TradeStats" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        <!-- Ensure TradeStats has default properties -->
        <do_if value="not global.$GT_TradeStats.$TotalTrades?">
          <set_value name="global.$GT_TradeStats.$TotalTrades" exact="0"/>
        </do_if>
        <do_if value="not global.$GT_TradeStats.$TotalProfit?">
          <set_value name="global.$GT_TradeStats.$TotalProfit" exact="0"/>
        </do_if>
        
        <!-- Initialize global.$GT_RepairOrders structure (used for repair orders) -->
        <do_if value="not global.$GT_RepairOrders?">
          <set_value name="global.$GT_RepairOrders" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_ResupplyOrders structure (used for resupply orders) -->
        <do_if value="not global.$GT_ResupplyOrders?">
          <set_value name="global.$GT_ResupplyOrders" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_LastResupplyTime structure (used for resupply timing) -->
        <do_if value="not global.$GT_LastResupplyTime?">
          <set_value name="global.$GT_LastResupplyTime" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_MaintenanceOrders structure (used for maintenance orders) -->
        <do_if value="not global.$GT_MaintenanceOrders?">
          <set_value name="global.$GT_MaintenanceOrders" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_Pilots structure (core pilot registry - used throughout mod) -->
        <do_if value="not global.$GT_Pilots?">
          <set_value name="global.$GT_Pilots" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_Ships structure (core ship registry - used throughout mod) -->
        <do_if value="not global.$GT_Ships?">
          <set_value name="global.$GT_Ships" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_FleetData structure (fleet coordination data) -->
        <do_if value="not global.$GT_FleetData?">
          <set_value name="global.$GT_FleetData" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_MarketData structure (market intelligence cache) -->
        <do_if value="not global.$GT_MarketData?">
          <set_value name="global.$GT_MarketData" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_TerritoryData structure (territory management data) -->
        <do_if value="not global.$GT_TerritoryData?">
          <set_value name="global.$GT_TerritoryData" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_SessionStats structure (current session statistics) -->
        <do_if value="not global.$GT_SessionStats?">
          <set_value name="global.$GT_SessionStats" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_XPEventQueue structure (event queue for instant XP processing) -->
        <do_if value="not global.$GT_XPEventQueue?">
          <set_value name="global.$GT_XPEventQueue" exact="[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_TrainingEventQueue structure (event queue for instant training processing) -->
        <do_if value="not global.$GT_TrainingEventQueue?">
          <set_value name="global.$GT_TrainingEventQueue" exact="[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_FleetEventQueue structure (event queue for instant fleet coordination) -->
        <do_if value="not global.$GT_FleetEventQueue?">
          <set_value name="global.$GT_FleetEventQueue" exact="[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_MarketEventQueue structure (event queue for instant market intelligence) -->
        <do_if value="not global.$GT_MarketEventQueue?">
          <set_value name="global.$GT_MarketEventQueue" exact="[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_ConfigEventQueue structure (configuration event queue) -->
        <do_if value="not global.$GT_ConfigEventQueue?">
          <set_value name="global.$GT_ConfigEventQueue" exact="[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_Reports structure (reporting system) -->
        <do_if value="not global.$GT_Reports?">
          <set_value name="global.$GT_Reports" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_ThreatIntelligence structure (threat intelligence system) -->
        <do_if value="not global.$GT_ThreatIntelligence?">
          <set_value name="global.$GT_ThreatIntelligence" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_ThreatCleanupTime structure (threat cleanup timing) -->
        <do_if value="not global.$GT_ThreatCleanupTime?">
          <set_value name="global.$GT_ThreatCleanupTime" exact="0"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_FailedTrades structure (failed trades tracking) -->
        <do_if value="not global.$GT_FailedTrades?">
          <set_value name="global.$GT_FailedTrades" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_SearchLocks structure (search locking system) -->
        <do_if value="not global.$GT_SearchLocks?">
          <set_value name="global.$GT_SearchLocks" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_AIParameters structure (AI parameters per ship) -->
        <do_if value="not global.$GT_AIParameters?">
          <set_value name="global.$GT_AIParameters" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_TradingQueue structure (trading queue system) -->
        <do_if value="not global.$GT_TradingQueue?">
          <set_value name="global.$GT_TradingQueue" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_PendingTradesSearchMethod structure (pending trades search method tracking) -->
        <do_if value="not global.$GT_PendingTradesSearchMethod?">
          <set_value name="global.$GT_PendingTradesSearchMethod" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_CargoCostTracking structure (cargo cost tracking) -->
        <do_if value="not global.$GT_CargoCostTracking?">
          <set_value name="global.$GT_CargoCostTracking" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_BuyCompleteQueue structure (buy completion queue) -->
        <do_if value="not global.$GT_BuyCompleteQueue?">
          <set_value name="global.$GT_BuyCompleteQueue" exact="[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_LastTradeScan structure (last trade scan timing) -->
        <do_if value="not global.$GT_LastTradeScan?">
          <set_value name="global.$GT_LastTradeScan" exact="0"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_CompetitorData structure (competitor data tracking) -->
        <do_if value="not global.$GT_CompetitorData?">
          <set_value name="global.$GT_CompetitorData" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_SectorAnalysis structure (sector analysis data) -->
        <do_if value="not global.$GT_SectorAnalysis?">
          <set_value name="global.$GT_SectorAnalysis" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_Territories structure (territories tracking) -->
        <do_if value="not global.$GT_Territories?">
          <set_value name="global.$GT_Territories" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_SectorExpertise structure (sector expertise tracking) -->
        <do_if value="not global.$GT_SectorExpertise?">
          <set_value name="global.$GT_SectorExpertise" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_TradeCacheVersion structure (trade cache version tracking) -->
        <do_if value="not global.$GT_TradeCacheVersion?">
          <set_value name="global.$GT_TradeCacheVersion" exact="4"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_TradeCacheLastCleanup structure (trade cache cleanup timing) -->
        <do_if value="not global.$GT_TradeCacheLastCleanup?">
          <set_value name="global.$GT_TradeCacheLastCleanup" exact="0"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_BatchDataListMigrated structure (batch data migration flag) -->
        <do_if value="not global.$GT_BatchDataListMigrated?">
          <set_value name="global.$GT_BatchDataListMigrated" exact="false"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Initialize global.$GT_Applied_Mods structure (applied modifications tracking) -->
        <do_if value="not global.$GT_Applied_Mods?">
          <set_value name="global.$GT_Applied_Mods" exact="table[]"/>
          <set_value name="$initCount" exact="$initCount + 1"/>
        </do_if>
        
        <!-- Log initialization results -->
        <do_if value="$initCount gt 0">
          <debug_text text="'[GT-Init] âœ… Initialized ' + $initCount + ' global table structure(s)'" chance="100"/>
        </do_if>
        <do_else>
          <debug_text text="'[GT-Init] âœ… All global table structures already valid'" chance="100"/>
        </do_else>
      </actions>
    </library>
  </cues>
</mdscript> 
