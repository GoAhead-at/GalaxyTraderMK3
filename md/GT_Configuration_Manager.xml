<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Configuration_Manager" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    
    <!-- Initialize Ship Configuration from Order Parameters -->
    <library name="Create_Ship_Config" purpose="run_actions">
      <params>
        <param name="order_params" comment="Order parameters from AI script"/>
        <param name="ship" comment="Ship to configure"/>
      </params>
      <actions>
        <set_value name="$config" exact="table[]"/>
        
        <!-- Extract and validate basic trading parameters -->
        <set_value name="$config.$Home" exact="$order_params.$home"/>
        <set_value name="$config.$MaxBuy" exact="$order_params.$maxbuy"/>
        <set_value name="$config.$MaxSell" exact="$order_params.$maxsell"/>
        <set_value name="$config.$AllowIllegal" exact="$order_params.$allowillegal"/>
        <set_value name="$config.$RiskTolerance" exact="$order_params.$risktolerance"/>
        <set_value name="$config.$DistancePenalty" exact="$order_params.$distancepenalty"/>
        <set_value name="$config.$CargoTarget" exact="$order_params.$cargotarget"/>
        <set_value name="$config.$MarketUpdateFreq" exact="$order_params.$marketupdatefreq"/>
        <set_value name="$config.$AutoWares" exact="$order_params.$autowares"/>
        <set_value name="$config.$WareBasket" exact="$order_params.$warebasket"/>
        <set_value name="$config.$Notifications" exact="$order_params.$notifications"/>
        <set_value name="$config.$DebugLevel" exact="$order_params.$debuglevel"/>
        <set_value name="$config.$TradeEval" exact="$order_params.$tradeeval"/>
        
        <!-- Apply global settings with fallbacks -->
        <run_actions ref="md.GT_Configuration_Manager.Apply_Global_Settings">
          <param name="config" value="$config"/>
        </run_actions>
        
        <!-- Calculate skill-based parameters -->
        <run_actions ref="md.GT_Configuration_Manager.Apply_Skill_Based_Config">
          <param name="config" value="$config"/>
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <!-- Generate ware list if auto-wares enabled (use all compatible wares) -->
        <do_if value="$config.$AutoWares">
          <!-- Auto-wares: Use empty list = trade all compatible wares -->
          <set_value name="$config.$WareBasket" exact="[]"/>
        </do_if>
        
        <!-- Validate configuration -->
        <run_actions ref="md.GT_Configuration_Manager.Validate_Ship_Config">
          <param name="config" value="$config"/>
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <!-- Log configuration summary for debugging -->
        <run_actions ref="md.GT_Libraries_General.Log_Configuration_Summary">
          <param name="ship" value="$ship"/>
          <param name="config" value="$config"/>
          <param name="debug_level" value="1"/>
        </run_actions>
        
        <set_value name="this.$result" exact="$config"/>
      </actions>
    </library>
    
    <!-- Apply Global Settings to Ship Configuration -->
    <library name="Apply_Global_Settings">
      <params>
        <param name="config" comment="Ship configuration to update"/>
      </params>
      <actions>
        <!-- XP System Settings -->
        <set_value name="$config.$EnableXP" exact="@global.$GT_GlobalSettings.$XP.$EnableXPProgression"/>
        <do_if value="not $config.$EnableXP?">
          <set_value name="$config.$EnableXP" exact="true"/>
        </do_if>
        
        <set_value name="$config.$AutoTraining" exact="@global.$GT_GlobalSettings.$XP.$AutoTraining"/>
        <do_if value="not $config.$AutoTraining?">
          <set_value name="$config.$AutoTraining" exact="true"/>
        </do_if>
        
        <!-- Fleet Coordination Settings -->
        <set_value name="$config.$FleetCoordination" exact="@global.$GT_GlobalSettings.$Fleet.$EnableFleetCoordination"/>
        <do_if value="not $config.$FleetCoordination?">
          <set_value name="$config.$FleetCoordination" exact="true"/>
        </do_if>
        
        <set_value name="$config.$TradeCache" exact="@global.$GT_GlobalSettings.$Fleet.$EnableTradeCache"/>
        <do_if value="not $config.$TradeCache?">
          <set_value name="$config.$TradeCache" exact="true"/>
        </do_if>
        
        <set_value name="$config.$CacheThreshold" exact="@global.$GT_GlobalSettings.$Fleet.$CacheProfitThreshold"/>
        <do_if value="not $config.$CacheThreshold?">
          <set_value name="$config.$CacheThreshold" exact="20"/>
        </do_if>
        
        <set_value name="$config.$CacheTTL" exact="@global.$GT_GlobalSettings.$Fleet.$CacheTTL"/>
        <do_if value="not $config.$CacheTTL?">
          <set_value name="$config.$CacheTTL" exact="300"/>
        </do_if>
        
        <set_value name="$config.$CacheDropoffTolerance" exact="@global.$GT_GlobalSettings.$Fleet.$CacheDropoffTolerance"/>
        <do_if value="not $config.$CacheDropoffTolerance?">
          <set_value name="$config.$CacheDropoffTolerance" exact="20"/>
        </do_if>
        
        <!-- Debug Settings Override -->
        <set_value name="$globalDebugLevel" exact="@global.$GT_GlobalSettings.$Debug.$DebugLevel"/>
        <do_if value="$globalDebugLevel?">
          <set_value name="$config.$DebugLevel" exact="$globalDebugLevel"/>
        </do_if>
        
        <set_value name="this.$result" exact="true"/>
      </actions>
    </library>
    
    <!-- Apply Skill-Based Configuration -->
    <library name="Apply_Skill_Based_Config">
      <params>
        <param name="config" comment="Ship configuration to update"/>
        <param name="ship" comment="Ship to analyze"/>
      </params>
      <actions>
        <!-- Calculate skill level -->
        <run_actions ref="md.GT_Ship_Management.Calculate_Skill_Level" result="$skillInfo">
          <param name="ship" value="$ship"/>
          <param name="use_md_system" value="true"/>
        </run_actions>
        
        <!-- Calculate jump distance based on skill -->
        <run_actions ref="md.GT_Ship_Management.Calculate_Jump_Distance" result="$jumpDistance">
          <param name="skill_level" value="$skillInfo.$Level"/>
        </run_actions>
        
        <!-- Apply skill-based limits -->
        <set_value name="$config.$SkillLevel" exact="$skillInfo.$Level"/>
        <set_value name="$config.$MaxBuyDistance" exact="[$config.$MaxBuy, $jumpDistance].min"/>
        <set_value name="$config.$MaxSellDistance" exact="[$config.$MaxSell, $jumpDistance].min"/>
        <set_value name="$config.$SkillBasedJumpLimit" exact="$jumpDistance"/>
        <set_value name="$config.$UsingMDSkill" exact="$skillInfo.$UsingMDSystem"/>
        
        <!-- Store skill information for debugging -->
        <set_value name="$config.$SkillInfo" exact="$skillInfo"/>
        
        <set_value name="this.$result" exact="true"/>
      </actions>
    </library>
    
    <!-- Validate Ship Configuration -->
    <library name="Validate_Ship_Config">
      <params>
        <param name="config" comment="Ship configuration to validate"/>
        <param name="ship" comment="Ship to validate for"/>
      </params>
      <actions>
        <set_value name="$errors" exact="[]"/>
        <set_value name="$warnings" exact="[]"/>
        
        <!-- Validate jump distances -->
        <do_if value="$config.$MaxBuyDistance le 0">
          <append_to_list name="$errors" exact="'MaxBuyDistance must be greater than 0'"/>
        </do_if>
        
        <do_if value="$config.$MaxSellDistance le 0">
          <append_to_list name="$errors" exact="'MaxSellDistance must be greater than 0'"/>
        </do_if>
        
        <!-- Validate ware basket -->
        <do_if value="$config.$WareBasket.count == 0">
          <append_to_list name="$warnings" exact="'No compatible wares found for this ship'"/>
        </do_if>
        
        <!-- Validate risk tolerance -->
        <do_if value="$config.$RiskTolerance lt 0 or $config.$RiskTolerance gt 100">
          <append_to_list name="$errors" exact="'RiskTolerance must be between 0 and 100'"/>
        </do_if>
        
        <!-- Store validation results -->
        <set_value name="$config.$ValidationErrors" exact="$errors"/>
        <set_value name="$config.$ValidationWarnings" exact="$warnings"/>
        <set_value name="$config.$IsValid" exact="$errors.count == 0"/>
        
        <set_value name="this.$result" exact="$config.$IsValid"/>
      </actions>
    </library>
    
  </cues>
</mdscript> 