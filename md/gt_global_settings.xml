<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_GlobalSettings" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <cue name="Init" instantiate="true" version="3">
      <conditions>
        <check_any>
          <event_game_loaded/>
          <event_player_created/>
        </check_any>
      </conditions>
      <actions>
        <!-- CRITICAL: Only initialize settings if they don't exist (preserve saved settings) -->
        <do_if value="not global.$GT_GlobalSettings?">
          <!-- Initialize global GalaxyTrader MK3 settings -->
          <set_value name="global.$GT_GlobalSettings" exact="table[]"/>
          
          <!-- XP and Training Settings -->
          <set_value name="global.$GT_GlobalSettings.$XP" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$XP.$EnableXPProgression" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$XP.$AutoTraining" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$XP.$XPMultiplier" exact="100"/> <!-- Percentage: 50-200% (100% = normal rate, balanced for ~500 trades) -->
          <set_value name="global.$GT_GlobalSettings.$XP.$MinTrainingDistance" exact="5"/> <!-- Max distance to training stations -->
          <set_value name="global.$GT_GlobalSettings.$XP.$TrainingCooldown" exact="600s"/> <!-- Cooldown between training sessions -->
          
          <!-- Fleet Coordination Settings -->
          <set_value name="global.$GT_GlobalSettings.$Fleet" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$Fleet.$EnableFleetCoordination" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$Fleet.$EnableTradeCache" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$Fleet.$CacheProfitThreshold" exact="20"/> <!-- Percentage -->
          <set_value name="global.$GT_GlobalSettings.$Fleet.$CacheDropoffTolerance" exact="15"/> <!-- Percentage -->
          <set_value name="global.$GT_GlobalSettings.$Fleet.$CacheTTL" exact="300s"/> <!-- Time to live -->
          <set_value name="global.$GT_GlobalSettings.$Fleet.$MaxCachedRoutes" exact="50"/> <!-- Max cached routes -->
          
          <!-- Notification Settings -->
          <set_value name="global.$GT_GlobalSettings.$Notifications" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$Notifications.$ShowXPGains" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$Notifications.$ShowTradeResults" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$Notifications.$ShowFleetStatus" exact="false"/>

          <!-- Mobile Satellite Intelligence Settings -->
          <set_value name="global.$GT_GlobalSettings.$MobileIntel" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$MobileIntel.$Enable" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$MobileIntel.$SubscriptionDuration" exact="10min"/>
          <set_value name="global.$GT_GlobalSettings.$MobileIntel.$StationCooldown" exact="60s"/>
          
          <!-- Threat Avoidance Settings -->
          <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$Enabled" exact="true"/>
          <!-- Note: RiskTolerance removed - now configured per-ship in command behavior (0.0-1.0 scale) -->
          <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$ScanInterval" exact="5s"/>
          <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$ThreatExpiry" exact="600s"/> <!-- 10 minutes -->
          <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$HostileRelationThreshold" exact="-0.20"/> <!-- Only flag factions with relation <= this value (default: -0.20 = -20%) -->
          <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$UseDynamicBlacklist" exact="true"/> <!-- Automatically blacklist dangerous sectors -->
          <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$BlockEnemyFactions" exact="true"/> <!-- Automatically block all sectors owned by enemy factions -->
          <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$BlacklistThreshold" exact="3"/> <!-- Threat level (1-5) required for blacklisting -->
          
          <!-- Debug Settings -->
          <set_value name="global.$GT_GlobalSettings.$Debug" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$Debug.$DebugLevel" exact="1"/> <!-- 0=None, 1=Basic, 2=Verbose -->
          <set_value name="global.$GT_GlobalSettings.$Debug.$TradeEvaluation" exact="false"/>
          
          <!-- Ship Naming Settings -->
          <set_value name="global.$GT_GlobalSettings.$ShipNaming" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayXP" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$XPPosition" exact="'suffix'"/> <!-- 'prefix' or 'suffix' -->
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayRank" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$RankPosition" exact="'suffix'"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayLevel" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$LevelPosition" exact="'suffix'"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayStatus" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$StatusPosition" exact="'prefix'"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayOperationalState" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$OperationalStatePosition" exact="'prefix'"/>
          
          <!-- Auto-Repair Settings -->
          <set_value name="global.$GT_GlobalSettings.$AutoRepair" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$AutoRepair.$Enabled" exact="true"/> <!-- Enable/disable auto-repair system -->
          <set_value name="global.$GT_GlobalSettings.$AutoRepair.$HullThreshold" exact="95"/> <!-- Hull percentage threshold (1-99) -->
          <set_value name="global.$GT_GlobalSettings.$AutoRepair.$MinPilotLevel" exact="12"/> <!-- Minimum pilot level required -->
          
          <debug_text text="'[GalaxyTrader MK3] Global settings initialized with defaults'" chance="100"/>
        </do_if>
        <do_else>
          <debug_text text="'[GalaxyTrader MK3] Global settings loaded from save'" chance="100"/>
        </do_else>
        
        <!-- Text Colors for UI -->
        <set_value name="$TextGreen" exact="'Color.text_success'"/>
        <set_value name="$TextRed" exact="'Color.text_failure'"/>
      </actions>
      
      <cues>
        <!-- Settings Validation and Restoration -->
        <cue name="ValidateSettings" instantiate="true" version="2">
          <conditions>
            <check_any>
              <event_universe_generated/>
              <event_game_loaded/>
              <event_cue_signalled/>
            </check_any>
          </conditions>
          <actions>
            <set_value name="$MissingVarCount" exact="0"/>
            
            <!-- Validate and restore missing settings -->
            <do_if value="not global.$GT_GlobalSettings?">
              <set_value name="global.$GT_GlobalSettings" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- XP Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$XP?">
              <set_value name="global.$GT_GlobalSettings.$XP" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$XP.$EnableXPProgression?">
              <set_value name="global.$GT_GlobalSettings.$XP.$EnableXPProgression" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$XP.$AutoTraining?">
              <set_value name="global.$GT_GlobalSettings.$XP.$AutoTraining" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$XP.$XPMultiplier?">
              <set_value name="global.$GT_GlobalSettings.$XP.$XPMultiplier" exact="100"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- Fleet Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$Fleet?">
              <set_value name="global.$GT_GlobalSettings.$Fleet" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$Fleet.$EnableFleetCoordination?">
              <set_value name="global.$GT_GlobalSettings.$Fleet.$EnableFleetCoordination" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$Fleet.$EnableTradeCache?">
              <set_value name="global.$GT_GlobalSettings.$Fleet.$EnableTradeCache" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$Fleet.$CacheProfitThreshold?">
              <set_value name="global.$GT_GlobalSettings.$Fleet.$CacheProfitThreshold" exact="20"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$Fleet.$CacheDropoffTolerance?">
              <set_value name="global.$GT_GlobalSettings.$Fleet.$CacheDropoffTolerance" exact="10"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$Fleet.$CacheTTL?">
              <set_value name="global.$GT_GlobalSettings.$Fleet.$CacheTTL" exact="300"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$Fleet.$MaxCachedRoutes?">
              <set_value name="global.$GT_GlobalSettings.$Fleet.$MaxCachedRoutes" exact="500"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- Initialize global trade cache system ALWAYS (early initialization to prevent race conditions) -->
            <!-- Even if global fleet coordination is disabled, individual ships may still use cache -->
            <!-- ✅ MIGRATION: Switch to list-based cache structure -->
            <!-- v4: Flat list structure - X4's nested tables are fundamentally broken for dynamic string keys -->
            <do_if value="not global.$GT_TradeCacheVersion? or global.$GT_TradeCacheVersion lt 4">
              <!-- Create cache as empty list - lists work reliably in X4, tables don't -->
              <set_value name="global.$GT_TradeCache" exact="[]"/>
              <set_value name="global.$GT_TradeCacheVersion" exact="4"/>
              <debug_text text="'[GalaxyTrader MK3] Trade cache initialized as list (v4 - flat structure)'" chance="100"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>            <!-- Ensure cleanup timestamp always exists -->
            <do_if value="not global.$GT_TradeCacheLastCleanup?">
              <set_value name="global.$GT_TradeCacheLastCleanup" exact="player.age"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- Notification Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$Notifications?">
              <set_value name="global.$GT_GlobalSettings.$Notifications" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- Remove old notification level setting if it exists (no longer used) -->
            <do_if value="global.$GT_GlobalSettings.$Notifications.$Level?">
              <remove_value name="global.$GT_GlobalSettings.$Notifications.$Level"/>
            </do_if>
            
            <!-- Debug Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$Debug?">
              <set_value name="global.$GT_GlobalSettings.$Debug" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <!-- Mobile Intel Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$MobileIntel?">
              <set_value name="global.$GT_GlobalSettings.$MobileIntel" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$MobileIntel.$Enable?">
              <set_value name="global.$GT_GlobalSettings.$MobileIntel.$Enable" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$MobileIntel.$SubscriptionDuration?">
              <set_value name="global.$GT_GlobalSettings.$MobileIntel.$SubscriptionDuration" exact="10min"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$MobileIntel.$StationCooldown?">
              <set_value name="global.$GT_GlobalSettings.$MobileIntel.$StationCooldown" exact="60s"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- Threat Avoidance Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$ThreatAvoidance?">
              <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ThreatAvoidance.$Enabled?">
              <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$Enabled" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <!-- Note: RiskTolerance validation removed - now per-ship parameter -->
            <do_if value="not global.$GT_GlobalSettings.$ThreatAvoidance.$ScanInterval?">
              <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$ScanInterval" exact="5s"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ThreatAvoidance.$ThreatExpiry?">
              <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$ThreatExpiry" exact="600s"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ThreatAvoidance.$HostileRelationThreshold?">
              <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$HostileRelationThreshold" exact="-0.20"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ThreatAvoidance.$UseDynamicBlacklist?">
              <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$UseDynamicBlacklist" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ThreatAvoidance.$BlacklistThreshold?">
              <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$BlacklistThreshold" exact="3"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ThreatAvoidance.$BlockEnemyFactions?">
              <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$BlockEnemyFactions" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <do_if value="not global.$GT_GlobalSettings.$Debug.$DebugLevel?">
              <set_value name="global.$GT_GlobalSettings.$Debug.$DebugLevel" exact="1"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- Ship Naming Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$DisplayXP?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayXP" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$XPPosition?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$XPPosition" exact="'suffix'"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$DisplayRank?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayRank" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$RankPosition?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$RankPosition" exact="'suffix'"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$DisplayLevel?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayLevel" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$LevelPosition?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$LevelPosition" exact="'suffix'"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$DisplayStatus?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayStatus" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$StatusPosition?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$StatusPosition" exact="'prefix'"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- Auto-Repair Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$AutoRepair?">
              <set_value name="global.$GT_GlobalSettings.$AutoRepair" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$AutoRepair.$Enabled?">
              <set_value name="global.$GT_GlobalSettings.$AutoRepair.$Enabled" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$AutoRepair.$HullThreshold?">
              <set_value name="global.$GT_GlobalSettings.$AutoRepair.$HullThreshold" exact="95"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$AutoRepair.$MinPilotLevel?">
              <set_value name="global.$GT_GlobalSettings.$AutoRepair.$MinPilotLevel" exact="12"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- Defensive Equipment Settings Validation (Level 15 Feature) -->
            <!-- CRITICAL: Validate BOTH config tables exist -->
            <do_if value="not global.$GT_Config.$Defense?">
              <set_value name="global.$GT_Config.$Defense" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_Config.$Defense.$Enabled?">
              <set_value name="global.$GT_Config.$Defense.$Enabled" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <do_if value="not global.$GT_GlobalSettings.$DefensiveEquipment?">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$DefensiveEquipment.$Enabled?">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$Enabled" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$DefensiveEquipment.$CountermeasureThreshold?">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$CountermeasureThreshold" exact="50"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$DefensiveEquipment.$UnifiedThreshold?">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$UnifiedThreshold" exact="70"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$DefensiveEquipment.$BalanceProfile?">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$BalanceProfile" exact="2"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <!-- Individual equipment type toggles -->
            <do_if value="not global.$GT_GlobalSettings.$DefensiveEquipment.$RestockCountermeasures?">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$RestockCountermeasures" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$DefensiveEquipment.$RestockDefenseDrones?">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$RestockDefenseDrones" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$DefensiveEquipment.$RestockTradeDrones?">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$RestockTradeDrones" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$DefensiveEquipment.$RestockLaserTowers?">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$RestockLaserTowers" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$DefensiveEquipment.$RestockRepairDrones?">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$RestockRepairDrones" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <do_if value="$MissingVarCount gt 0">
              <debug_text text="'[GalaxyTrader MK3] Restored ' + $MissingVarCount + ' missing global settings'" chance="100"/>
            </do_if>
          </actions>
        </cue>
        
      </cues>
    </cue>
    
    <!-- Simple Menu API Integration -->
    <!-- Follow Simple_Menu_API documentation pattern: instantiate="true", ONLY listen to Reloaded -->
    <!-- Renamed from RegisterOptionsMenu to GT_MenuRegistration to avoid "Cannot change parent cue" with existing saves -->
    <cue name="GT_MenuRegistration" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.Simple_Menu_API.Reloaded"/>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3] GT_MenuRegistration cue fired!'" chance="100"/>
        
        <!-- Ensure all settings are initialized before registering menu -->
        <do_if value="not global.$GT_GlobalSettings?">
          <set_value name="global.$GT_GlobalSettings" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_GlobalSettings.$DefensiveEquipment?">
          <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$Enabled" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$CountermeasureThreshold" exact="50"/>
          <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$UnifiedThreshold" exact="70"/>
          <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$BalanceProfile" exact="2"/>
          <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$RestockCountermeasures" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$RestockDefenseDrones" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$RestockTradeDrones" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$RestockLaserTowers" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$RestockRepairDrones" exact="true"/>
          <debug_text text="'[GalaxyTrader MK3] Initialized missing DefensiveEquipment settings'" chance="100"/>
        </do_if>
        
        <!-- Pre-load title text -->
        <set_value name="$menuTitle" exact="{77000,9000}"/>
        
        <!-- Register GalaxyTrader MK3 options menu -->
        <signal_cue_instantly cue="md.Simple_Menu_API.Register_Options_Menu" param="table[
          $id = 'gt_global_settings_menu',
          $columns = 8,
          $title = $menuTitle, 
          $onOpen = GT_SettingsMenu,
          $defaultFocus = false
        ]"/>
        
        <debug_text text="'[GalaxyTrader MK3] Global settings menu registered with Simple Menu API'" chance="100"/>
      </actions>
    </cue>
        
    <!-- Global Settings Menu Builder -->
    <cue name="GT_SettingsMenu" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
            <!-- Define color variables for UI -->
            <set_value name="$TextGreen" exact="'Color.text_success'"/>
            <set_value name="$TextRed" exact="'Color.text_failure'"/>
            
            <!-- XP and Training Section -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 8,
              $text = {77000,9010},
              $halign = 'center',
              $color = 'Color.text_positive'
            ]"/>
            
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
                      $text = {77000,9011},
        $mouseOverText = {77000,9111}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$XP.$EnableXPProgression then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$XP.$EnableXPProgression then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$XP', '$EnableXPProgression', global.$GT_GlobalSettings.$XP.$EnableXPProgression]
            ]"/>
            
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
                      $text = {77000,9012},
        $mouseOverText = {77000,9112}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$XP.$AutoTraining then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$XP.$AutoTraining then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$XP', '$AutoTraining', global.$GT_GlobalSettings.$XP.$AutoTraining]
            ]"/>
            
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
                      $text = {77000,9013},
        $mouseOverText = {77000,9113}
            ]"/>
            <!-- ✅ SAVE GAME COMPATIBILITY: Validate slider value is within range (50-200%) -->
            <do_if value="global.$GT_GlobalSettings.$XP.$XPMultiplier lt 50">
              <set_value name="global.$GT_GlobalSettings.$XP.$XPMultiplier" exact="100"/>
            </do_if>
            <do_if value="global.$GT_GlobalSettings.$XP.$XPMultiplier gt 200">
              <set_value name="global.$GT_GlobalSettings.$XP.$XPMultiplier" exact="100"/>
            </do_if>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Slider" param="table[
              $col = 5,
              $colSpan = 4,
              $min = 50,
              $max = 200,
              $start = global.$GT_GlobalSettings.$XP.$XPMultiplier,
              $step = 10,
              $suffix = '%',
              $onSliderCellChanged = GT_Slider_Update,
              $echo = table[$section = '$XP', $setting = '$XPMultiplier']
            ]"/>
            
            <!-- Fleet Coordination Section -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 8,
              $text = {77000,9020},
              $halign = 'center',
              $color = 'Color.text_positive'
            ]"/>
            
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
                      $text = {77000,9021},
        $mouseOverText = {77000,9121}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$Fleet.$EnableFleetCoordination then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$Fleet.$EnableFleetCoordination then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$Fleet', '$EnableFleetCoordination', global.$GT_GlobalSettings.$Fleet.$EnableFleetCoordination]
            ]"/>
            
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
                      $text = {77000,9023},
        $mouseOverText = {77000,9123}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$Fleet.$EnableTradeCache then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$Fleet.$EnableTradeCache then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$Fleet', '$EnableTradeCache', global.$GT_GlobalSettings.$Fleet.$EnableTradeCache]
            ]"/>
            
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
                      $text = {77000,9022},
        $mouseOverText = {77000,9122}
            ]"/>
            <!-- ✅ FIX: Validate slider value is within range before creating slider -->
            <do_if value="global.$GT_GlobalSettings.$Fleet.$CacheProfitThreshold lt 1">
              <set_value name="global.$GT_GlobalSettings.$Fleet.$CacheProfitThreshold" exact="20"/>
            </do_if>
            <do_if value="global.$GT_GlobalSettings.$Fleet.$CacheProfitThreshold gt 30">
              <set_value name="global.$GT_GlobalSettings.$Fleet.$CacheProfitThreshold" exact="20"/>
            </do_if>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Slider" param="table[
              $col = 5,
              $colSpan = 4,
              $min = 1,
              $max = 30,
              $start = global.$GT_GlobalSettings.$Fleet.$CacheProfitThreshold,
              $step = 1,
              $suffix = '%',
              $onSliderCellChanged = GT_Slider_Update,
              $echo = table[$section = '$Fleet', $setting = '$CacheProfitThreshold']
            ]"/>
            
            <!-- Threat Avoidance Section -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 8,
              $text = {77000,9050},
              $halign = 'center',
              $color = 'Color.text_positive'
            ]"/>
            
            <!-- Enable Threat Avoidance -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
              $text = {77000,9051},
              $mouseOverText = {77000,9151}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ThreatAvoidance.$Enabled then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$ThreatAvoidance.$Enabled then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$ThreatAvoidance', '$Enabled', global.$GT_GlobalSettings.$ThreatAvoidance.$Enabled]
            ]"/>
            
            <!-- Hostile Relation Threshold -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = {77000,9052},
              $mouseOverText = {77000,9152}
            ]"/>
            <!-- ✅ FIX: Validate slider value is within range -->
            <set_value name="$tempThreshold" exact="(global.$GT_GlobalSettings.$ThreatAvoidance.$HostileRelationThreshold * 100)"/>
            <do_if value="$tempThreshold lt -100">
              <set_value name="$tempThreshold" exact="-30"/>
            </do_if>
            <do_if value="$tempThreshold gt 0">
              <set_value name="$tempThreshold" exact="-30"/>
            </do_if>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Slider" param="table[
              $col = 5,
              $colSpan = 4,
              $min = -100,
              $max = 0,
              $start = $tempThreshold,
              $step = 1,
              $suffix = '%',
              $onSliderCellChanged = GT_Relation_Update,
              $echo = table[$section = '$ThreatAvoidance', $setting = '$HostileRelationThreshold']
            ]"/>
            
            <!-- Use Dynamic Blacklist -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
              $text = {77000,9053},
              $mouseOverText = {77000,9153}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ThreatAvoidance.$UseDynamicBlacklist then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$ThreatAvoidance.$UseDynamicBlacklist then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$ThreatAvoidance', '$UseDynamicBlacklist', global.$GT_GlobalSettings.$ThreatAvoidance.$UseDynamicBlacklist]
            ]"/>
            
            <!-- Block Enemy Factions -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
              $text = 'Block Enemy Faction Sectors',
              $mouseOverText = 'Automatically blacklist all sectors owned by enemy factions (relation checkbox in blacklist)'
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ThreatAvoidance.$BlockEnemyFactions then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$ThreatAvoidance.$BlockEnemyFactions then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$ThreatAvoidance', '$BlockEnemyFactions', global.$GT_GlobalSettings.$ThreatAvoidance.$BlockEnemyFactions]
            ]"/>
            
            <!-- Blacklist Threat Threshold -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = 'Blacklist Threat Level',
              $mouseOverText = 'Minimum threat level (1-5) required to blacklist a sector:\n2=Medium (single attack)\n3=Medium-High (hostile factions)\n4=High (capital ships/missiles)\n5=Very High (Xenon/Khaak)'
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Slider" param="table[
              $col = 5,
              $colSpan = 4,
              $min = 1,
              $max = 5,
              $start = global.$GT_GlobalSettings.$ThreatAvoidance.$BlacklistThreshold,
              $step = 1,
              $onSliderCellChanged = GT_Slider_Update,
              $echo = table[$section = '$ThreatAvoidance', $setting = '$BlacklistThreshold']
            ]"/>
            
            <!-- Recreate Blacklist Button -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 5,
              $text = 'Recreate Blacklist',
              $mouseOverText = 'Manually recreate the threat avoidance blacklist (useful if it was deleted)'
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 6,
              $colSpan = 3,
              $text = table[
                $text = 'Recreate',
                $color = 'Color.text_warning',
                $halign = 'center'
              ],
              $onClick = GT_RecreateBlacklist,
              $onRightClick = GT_RecreateBlacklist
            ]"/>
            
            <!-- Note: Risk Tolerance is now configured per-ship in the command behavior settings -->
            
            <!-- Auto-Repair Section -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 8,
              $text = {77000,9040},
              $halign = 'center',
              $color = 'Color.text_positive'
            ]"/>
            
            <!-- Enable Auto-Repair -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
              $text = {77000,9041},
              $mouseOverText = {77000,9141}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$AutoRepair.$Enabled then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$AutoRepair.$Enabled then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$AutoRepair', '$Enabled', global.$GT_GlobalSettings.$AutoRepair.$Enabled]
            ]"/>
            
            <!-- Hull Threshold Slider -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = {77000,9042},
              $mouseOverText = {77000,9142}
            ]"/>
            <!-- ✅ FIX: Validate slider value is within range -->
            <do_if value="global.$GT_GlobalSettings.$AutoRepair.$HullThreshold lt 50">
              <set_value name="global.$GT_GlobalSettings.$AutoRepair.$HullThreshold" exact="80"/>
            </do_if>
            <do_if value="global.$GT_GlobalSettings.$AutoRepair.$HullThreshold gt 99">
              <set_value name="global.$GT_GlobalSettings.$AutoRepair.$HullThreshold" exact="80"/>
            </do_if>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Slider" param="table[
              $col = 5,
              $colSpan = 4,
              $min = 50,
              $max = 99,
              $start = global.$GT_GlobalSettings.$AutoRepair.$HullThreshold,
              $step = 5,
              $suffix = '%',
              $onSliderCellChanged = GT_Slider_Update,
              $echo = table[$section = '$AutoRepair', $setting = '$HullThreshold']
            ]"/>
            
            <!-- Note: Minimum pilot level for auto-repair is hardcoded to Level 12+ -->
            
            <!-- Defensive Equipment Section (Level 15 Feature) -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 8,
              $text = {77000,9060},
              $halign = 'center',
              $color = 'Color.text_positive'
            ]"/>
            
            <!-- Enable Defensive Equipment -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
              $text = {77000,9061},
              $mouseOverText = {77000,9161}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$DefensiveEquipment.$Enabled then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$DefensiveEquipment.$Enabled then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$DefensiveEquipment', '$Enabled', global.$GT_GlobalSettings.$DefensiveEquipment.$Enabled]
            ]"/>
            
            <!-- Restock Countermeasures -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
              $text = {77000,9062},
              $mouseOverText = {77000,9162}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$DefensiveEquipment.$RestockCountermeasures then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$DefensiveEquipment.$RestockCountermeasures then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$DefensiveEquipment', '$RestockCountermeasures', global.$GT_GlobalSettings.$DefensiveEquipment.$RestockCountermeasures]
            ]"/>
            
            <!-- Restock Defense Drones -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
              $text = {77000,9063},
              $mouseOverText = {77000,9163}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$DefensiveEquipment.$RestockDefenseDrones then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$DefensiveEquipment.$RestockDefenseDrones then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$DefensiveEquipment', '$RestockDefenseDrones', global.$GT_GlobalSettings.$DefensiveEquipment.$RestockDefenseDrones]
            ]"/>
            
            <!-- Restock Trade Drones -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
              $text = {77000,9064},
              $mouseOverText = {77000,9164}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$DefensiveEquipment.$RestockTradeDrones then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$DefensiveEquipment.$RestockTradeDrones then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$DefensiveEquipment', '$RestockTradeDrones', global.$GT_GlobalSettings.$DefensiveEquipment.$RestockTradeDrones]
            ]"/>
            
            <!-- Restock Laser Towers -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
              $text = {77000,9065},
              $mouseOverText = {77000,9165}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$DefensiveEquipment.$RestockLaserTowers then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$DefensiveEquipment.$RestockLaserTowers then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$DefensiveEquipment', '$RestockLaserTowers', global.$GT_GlobalSettings.$DefensiveEquipment.$RestockLaserTowers]
            ]"/>
            
            <!-- Restock Repair Drones -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
              $text = {77000,9066},
              $mouseOverText = {77000,9166}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$DefensiveEquipment.$RestockRepairDrones then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$DefensiveEquipment.$RestockRepairDrones then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$DefensiveEquipment', '$RestockRepairDrones', global.$GT_GlobalSettings.$DefensiveEquipment.$RestockRepairDrones]
            ]"/>
            
            <!-- Countermeasure Threshold -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = {77000,9067},
              $mouseOverText = {77000,9167}
            ]"/>
            <!-- Validate slider value is within range -->
            <do_if value="global.$GT_GlobalSettings.$DefensiveEquipment.$CountermeasureThreshold lt 10">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$CountermeasureThreshold" exact="50"/>
            </do_if>
            <do_if value="global.$GT_GlobalSettings.$DefensiveEquipment.$CountermeasureThreshold gt 100">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$CountermeasureThreshold" exact="50"/>
            </do_if>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Slider" param="table[
              $col = 5,
              $colSpan = 4,
              $min = 10,
              $max = 100,
              $start = global.$GT_GlobalSettings.$DefensiveEquipment.$CountermeasureThreshold,
              $step = 5,
              $suffix = '%',
              $onSliderCellChanged = GT_Slider_Update,
              $echo = table[$section = '$DefensiveEquipment', $setting = '$CountermeasureThreshold']
            ]"/>
            
            <!-- Unified Capacity Threshold -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = {77000,9068},
              $mouseOverText = {77000,9168}
            ]"/>
            <!-- Validate slider value is within range -->
            <do_if value="global.$GT_GlobalSettings.$DefensiveEquipment.$UnifiedThreshold lt 10">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$UnifiedThreshold" exact="70"/>
            </do_if>
            <do_if value="global.$GT_GlobalSettings.$DefensiveEquipment.$UnifiedThreshold gt 100">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$UnifiedThreshold" exact="70"/>
            </do_if>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Slider" param="table[
              $col = 5,
              $colSpan = 4,
              $min = 10,
              $max = 100,
              $start = global.$GT_GlobalSettings.$DefensiveEquipment.$UnifiedThreshold,
              $step = 5,
              $suffix = '%',
              $onSliderCellChanged = GT_Slider_Update,
              $echo = table[$section = '$DefensiveEquipment', $setting = '$UnifiedThreshold']
            ]"/>
            
            <!-- Balance Profile Cycling Button -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = {77000,9069},
              $mouseOverText = {77000,9169}
            ]"/>
            <!-- Validate profile value is within range -->
            <do_if value="global.$GT_GlobalSettings.$DefensiveEquipment.$BalanceProfile lt 0">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$BalanceProfile" exact="2"/>
            </do_if>
            <do_if value="global.$GT_GlobalSettings.$DefensiveEquipment.$BalanceProfile gt 4">
              <set_value name="global.$GT_GlobalSettings.$DefensiveEquipment.$BalanceProfile" exact="2"/>
            </do_if>
            <!-- Get profile name for display using translation IDs -->
            <!-- Set profile name using conditional logic (translation IDs must be literals) -->
            <set_value name="$profileName" exact="{77000,6103}"/>  <!-- Default: Trading-Focused -->
            <do_if value="global.$GT_GlobalSettings.$DefensiveEquipment.$BalanceProfile == 0">
              <set_value name="$profileName" exact="{77000,6101}"/>  <!-- Balanced -->
            </do_if>
            <do_elseif value="global.$GT_GlobalSettings.$DefensiveEquipment.$BalanceProfile == 1">
              <set_value name="$profileName" exact="{77000,6102}"/>  <!-- Defensive -->
            </do_elseif>
            <do_elseif value="global.$GT_GlobalSettings.$DefensiveEquipment.$BalanceProfile == 2">
              <set_value name="$profileName" exact="{77000,6103}"/>  <!-- Trading-Focused -->
            </do_elseif>
            <do_elseif value="global.$GT_GlobalSettings.$DefensiveEquipment.$BalanceProfile == 3">
              <set_value name="$profileName" exact="{77000,6104}"/>  <!-- Heavy Defense -->
            </do_elseif>
            <do_elseif value="global.$GT_GlobalSettings.$DefensiveEquipment.$BalanceProfile == 4">
              <set_value name="$profileName" exact="{77000,6105}"/>  <!-- Tower Support -->
            </do_elseif>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 5,
              $colSpan = 4,
              $text = table[
                $text = $profileName,
                $color = 'Color.text_normal',
                $halign = 'center'
              ],
              $onClick = GT_Profile_Cycle,
              $onRightClick = GT_Profile_Cycle,
              $echo = ['$DefensiveEquipment', '$BalanceProfile', global.$GT_GlobalSettings.$DefensiveEquipment.$BalanceProfile]
            ]"/>
            
            <!-- Ship Naming Section -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 8,
              $text = {77000,9070},
              $halign = 'center',
              $color = 'Color.text_positive'
            ]"/>
            
            <!-- Display XP Setting -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = {77000,9071},
              $mouseOverText = {77000,9171}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 5,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$DisplayXP then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$ShipNaming.$DisplayXP then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$ShipNaming', '$DisplayXP', global.$GT_GlobalSettings.$ShipNaming.$DisplayXP]
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$XPPosition == 'prefix' then 'Prefix' else 'Suffix',
                $color = 'Color.text_normal',
                $halign = 'center'
              ],
              $onClick = GT_Position_Toggle,
              $onRightClick = GT_Position_Toggle,
              $echo = ['$ShipNaming', '$XPPosition', global.$GT_GlobalSettings.$ShipNaming.$XPPosition]
            ]"/>
            
            <!-- Display Rank Setting -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = {77000,9072},
              $mouseOverText = {77000,9172}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 5,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$DisplayRank then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$ShipNaming.$DisplayRank then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$ShipNaming', '$DisplayRank', global.$GT_GlobalSettings.$ShipNaming.$DisplayRank]
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$RankPosition == 'prefix' then 'Prefix' else 'Suffix',
                $color = 'Color.text_normal',
                $halign = 'center'
              ],
              $onClick = GT_Position_Toggle,
              $onRightClick = GT_Position_Toggle,
              $echo = ['$ShipNaming', '$RankPosition', global.$GT_GlobalSettings.$ShipNaming.$RankPosition]
            ]"/>
            
            <!-- Display Level Setting -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = {77000,9073},
              $mouseOverText = {77000,9173}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 5,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$DisplayLevel then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$ShipNaming.$DisplayLevel then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$ShipNaming', '$DisplayLevel', global.$GT_GlobalSettings.$ShipNaming.$DisplayLevel]
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$LevelPosition == 'prefix' then 'Prefix' else 'Suffix',
                $color = 'Color.text_normal',
                $halign = 'center'
              ],
              $onClick = GT_Position_Toggle,
              $onRightClick = GT_Position_Toggle,
              $echo = ['$ShipNaming', '$LevelPosition', global.$GT_GlobalSettings.$ShipNaming.$LevelPosition]
            ]"/>
            
            <!-- Display Status Setting -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = {77000,9074},
              $mouseOverText = {77000,9174}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 5,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$DisplayStatus then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$ShipNaming.$DisplayStatus then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = GT_Setting_Toggle,
              $onRightClick = GT_Setting_Toggle,
              $echo = ['$ShipNaming', '$DisplayStatus', global.$GT_GlobalSettings.$ShipNaming.$DisplayStatus]
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$StatusPosition == 'prefix' then 'Prefix' else 'Suffix',
                $color = 'Color.text_normal',
                $halign = 'center'
              ],
              $onClick = GT_Position_Toggle,
              $onRightClick = GT_Position_Toggle,
              $echo = ['$ShipNaming', '$StatusPosition', global.$GT_GlobalSettings.$ShipNaming.$StatusPosition]
            ]"/>
      </actions>
        </cue>
        
    <!-- Setting Toggle Handler -->
    <cue name="GT_Setting_Toggle" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
            <!-- Debug: Show the full parameter structure -->
            <debug_text text="'[GalaxyTrader MK3] ToggleSetting called with event.param: ' + event.param" chance="100"/>
            
            <!-- Extract parameters from the echo array -->
            <set_value name="$section" exact="event.param.$echo.{1}"/>
            <set_value name="$setting" exact="event.param.$echo.{2}"/>
            <set_value name="$currentValue" exact="event.param.$echo.{3}"/>
            
            <debug_text text="'[GalaxyTrader MK3] Extracted parameters - Section: ' + $section + ', Setting: ' + $setting + ', CurrentValue: ' + $currentValue" chance="100"/>
            
            <!-- Toggle the setting -->
            <set_value name="global.$GT_GlobalSettings.{$section}.{$setting}" exact="not $currentValue"/>
            
            <debug_text text="'[GalaxyTrader MK3] Global setting toggled: ' + $section + '.' + $setting + ' = ' + global.$GT_GlobalSettings.{$section}.{$setting}" chance="100"/>
            
            <!-- If this is a ship naming setting, update all ship names -->
            <do_if value="$section == '$ShipNaming'">
              <signal_cue_instantly cue="md.GT_CoreSystem.UpdateAllShipNames"/>
            </do_if>
            
            <!-- Refresh the menu -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Refresh_Menu"/>
      </actions>
        </cue>
        
    <!-- Position Toggle Handler -->
    <cue name="GT_Position_Toggle" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
            <!-- Debug: Show the full parameter structure -->
            <debug_text text="'[GalaxyTrader MK3] TogglePosition called with event.param: ' + event.param" chance="100"/>
            
            <!-- Extract parameters from the echo array -->
            <set_value name="$section" exact="event.param.$echo.{1}"/>
            <set_value name="$setting" exact="event.param.$echo.{2}"/>
            <set_value name="$currentValue" exact="event.param.$echo.{3}"/>
            
            <debug_text text="'[GalaxyTrader MK3] Extracted parameters - Section: ' + $section + ', Setting: ' + $setting + ', CurrentValue: ' + $currentValue" chance="100"/>
            
            <!-- Toggle between 'prefix' and 'suffix' -->
            <set_value name="global.$GT_GlobalSettings.{$section}.{$setting}" exact="if $currentValue == 'prefix' then 'suffix' else 'prefix'"/>
            
            <debug_text text="'[GalaxyTrader MK3] Position setting toggled: ' + $section + '.' + $setting + ' = ' + global.$GT_GlobalSettings.{$section}.{$setting}" chance="100"/>
            
            <!-- Update all ship names when position changes -->
            <signal_cue_instantly cue="md.GT_CoreSystem.UpdateAllShipNames"/>
            
            <!-- Refresh the menu -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Refresh_Menu"/>
      </actions>
        </cue>
        
    <!-- Balance Profile Cycle Handler -->
    <cue name="GT_Profile_Cycle" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
            <!-- Debug: Show the full parameter structure -->
            <debug_text text="'[GalaxyTrader MK3] ProfileCycle called with event.param: ' + event.param" chance="100"/>
            
            <!-- Extract parameters from the echo array -->
            <set_value name="$section" exact="event.param.$echo.{1}"/>
            <set_value name="$setting" exact="event.param.$echo.{2}"/>
            <set_value name="$currentValue" exact="event.param.$echo.{3}"/>
            
            <debug_text text="'[GalaxyTrader MK3] Extracted parameters - Section: ' + $section + ', Setting: ' + $setting + ', CurrentValue: ' + $currentValue" chance="100"/>
            
            <!-- Cycle through profiles: 0=Balanced, 1=Defensive, 2=Trading-Focused, 3=Heavy Defense, 4=Tower Support -->
            <set_value name="$newValue" exact="($currentValue + 1) % 5"/>
            <set_value name="global.$GT_GlobalSettings.{$section}.{$setting}" exact="$newValue"/>
            
            <!-- Get profile name for debug -->
            <set_value name="$profileName" exact="'Trading-Focused'"/>
            <do_if value="$newValue == 0">
              <set_value name="$profileName" exact="'Balanced'"/>
            </do_if>
            <do_elseif value="$newValue == 1">
              <set_value name="$profileName" exact="'Defensive'"/>
            </do_elseif>
            <do_elseif value="$newValue == 2">
              <set_value name="$profileName" exact="'Trading-Focused'"/>
            </do_elseif>
            <do_elseif value="$newValue == 3">
              <set_value name="$profileName" exact="'Heavy Defense'"/>
            </do_elseif>
            <do_elseif value="$newValue == 4">
              <set_value name="$profileName" exact="'Tower Support'"/>
            </do_elseif>
            
            <debug_text text="'[GalaxyTrader MK3] Profile cycled: ' + $section + '.' + $setting + ' = ' + $newValue + ' (' + $profileName + ')'" chance="100"/>
            
            <!-- Refresh the menu -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Refresh_Menu"/>
      </actions>
        </cue>
        
    <!-- Slider Value Update Handler -->
    <!-- Recreate Blacklist Button Handler -->
    <cue name="GT_RecreateBlacklist" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <debug_text text="'[GT-Blacklist] Manual blacklist recreation requested via menu button'" chance="100"/>
        
        <!-- Keep track of the old ID (don't clear it until we have a new one) -->
        <set_value name="$oldID" exact="@global.$GT_BlacklistID"/>
        
        <do_if value="$oldID?">
          <debug_text text="'[GT-Blacklist] Current stored ID: ' + $oldID + ' (will attempt to recreate)'" chance="100"/>
        </do_if>
        <do_else>
          <debug_text text="'[GT-Blacklist] No stored ID found - will create fresh blacklist'" chance="100"/>
        </do_else>
        
        <!-- Trigger blacklist recreation by calling dedicated Recreate event -->
        <!-- Only pass relation threshold if BlockEnemyFactions is enabled (default: true) -->
        <set_value name="$blockEnemyFactions" exact="@global.$GT_GlobalSettings.$ThreatAvoidance.$BlockEnemyFactions"/>
        <do_if value="not $blockEnemyFactions?">
          <set_value name="$blockEnemyFactions" exact="true"/> <!-- Default: enabled -->
        </do_if>
        
        <debug_text text="'[GT-Blacklist] Recreate: BlockEnemyFactions setting: ' + $blockEnemyFactions" chance="100"/>
        
        <set_value name="$relationValue" exact="''"/>
        <do_if value="$blockEnemyFactions">
          <set_value name="$relationValue" exact="'enemy'"/>
          <debug_text text="'[GT-Blacklist] Recreate: Enemy faction blocking ENABLED (X4 relation field = &quot;enemy&quot;)'" chance="100"/>
        </do_if>
        <do_else>
          <debug_text text="'[GT-Blacklist] Recreate: Enemy faction blocking DISABLED (X4 relation field = &quot;&quot;)'" chance="100"/>
        </do_else>
        
        <!-- Pass relation|0 to force recreation (Lua will reset initialized flag and recreate) -->
        <set_value name="$initData" exact="$relationValue + '|0'"/>
        <raise_lua_event name="'GT_Blacklist.Recreate'" param="$initData"/>
        
        <debug_text text="'[GT-Blacklist] Blacklist recreation triggered - StoreBlacklistID cue will update ID when Lua responds'" chance="100"/>
        
        <!-- Reload existing threats into the newly recreated blacklist -->
        <signal_cue_instantly cue="md.GT_ThreatIntelligence.UpdateBlacklistOnThreat"/>
        <debug_text text="'[GT-Blacklist] Reloading existing threat data into recreated blacklist'" chance="100"/>
        
        <!-- Refresh the menu to show any changes -->
        <signal_cue_instantly cue="md.Simple_Menu_API.Refresh_Menu"/>
      </actions>
    </cue>
    
    <cue name="GT_Slider_Update" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
            <!-- Debug: Print the entire event parameter structure -->
            <debug_text text="'[GalaxyTrader MK3] UpdateSliderValue called with event.param: ' + event.param" chance="100"/>
            
            <!-- Simple Menu API passes a table with $value and $echo -->
            <set_value name="$newValue" exact="null"/>
            <set_value name="$section" exact="null"/>
            <set_value name="$setting" exact="null"/>
            
            <!-- Get the new slider value from $value -->
            <do_if value="event.param.$value?">
              <set_value name="$newValue" exact="event.param.$value"/>
              <debug_text text="'[GalaxyTrader MK3] Slider new value: ' + $newValue" chance="100"/>
            </do_if>
            
            <!-- Get the echo data from $echo -->
            <do_if value="event.param.$echo? and event.param.$echo.$section? and event.param.$echo.$setting?">
              <set_value name="$section" exact="event.param.$echo.$section"/>
              <set_value name="$setting" exact="event.param.$echo.$setting"/>
              <debug_text text="'[GalaxyTrader MK3] Echo data - Section: ' + $section + ', Setting: ' + $setting" chance="100"/>
            </do_if>
            
            <!-- Update the setting if we have all required data -->
            <do_if value="$newValue? and $section and $setting">
              <!-- Use the section and setting names directly as they come from the echo parameter -->
              <!-- The global settings structure uses these exact names with dollar signs -->
              <set_value name="$cleanSection" exact="$section"/>
              <set_value name="$cleanSetting" exact="$setting"/>
              
              <!-- Update the setting -->
              <set_value name="global.$GT_GlobalSettings.{$cleanSection}.{$cleanSetting}" exact="$newValue"/>
              <debug_text text="'[GalaxyTrader MK3] Global setting updated: ' + $cleanSection + '.' + $cleanSetting + ' = ' + $newValue" chance="100"/>
            </do_if>
            <do_else>
              <debug_text text="'[GalaxyTrader MK3] ERROR: Missing required parameters - Value: ' + $newValue + ', Section: ' + $section + ', Setting: ' + $setting" chance="100"/>
            </do_else>
      </actions>
        </cue>
        
    <!-- Relation Threshold Update Handler (converts percentage to normalized value) -->
    <cue name="GT_Relation_Update" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
            <debug_text text="'[GalaxyTrader MK3] UpdateRelationThreshold called with event.param: ' + event.param" chance="100"/>
            
            <!-- Simple Menu API passes a table with $value (percentage -100 to 0) and $echo -->
            <set_value name="$percentageValue" exact="null"/>
            <set_value name="$section" exact="null"/>
            <set_value name="$setting" exact="null"/>
            
            <!-- Get the percentage value from $value -->
            <do_if value="event.param.$value?">
              <set_value name="$percentageValue" exact="event.param.$value"/>
              <debug_text text="'[GalaxyTrader MK3] Relation threshold percentage value: ' + $percentageValue + '%'" chance="100"/>
            </do_if>
            
            <!-- Get the echo data from $echo -->
            <do_if value="event.param.$echo? and event.param.$echo.$section? and event.param.$echo.$setting?">
              <set_value name="$section" exact="event.param.$echo.$section"/>
              <set_value name="$setting" exact="event.param.$echo.$setting"/>
            </do_if>
            
            <!-- Convert percentage to normalized value and update setting -->
            <do_if value="$percentageValue? and $section and $setting">
              <!-- Convert percentage (-100 to 0) to normalized (-1.0 to 0.0) -->
              <set_value name="$normalizedValue" exact="$percentageValue / 100"/>
              
              <!-- Update the setting -->
              <set_value name="global.$GT_GlobalSettings.{$section}.{$setting}" exact="$normalizedValue"/>
              <debug_text text="'[GalaxyTrader MK3] Relation threshold updated: ' + $section + '.' + $setting + ' = ' + $normalizedValue + ' (' + $percentageValue + '%)'" chance="100"/>
            </do_if>
            <do_else>
              <debug_text text="'[GalaxyTrader MK3] ERROR: Missing required parameters for relation threshold update'" chance="100"/>
            </do_else>
      </actions>
    </cue>
    
  </cues>
</mdscript> 
