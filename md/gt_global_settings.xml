<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_GlobalSettings" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <cue name="Init" instantiate="true" version="3">
      <conditions>
        <check_any>
          <event_game_loaded/>
          <event_player_created/>
        </check_any>
      </conditions>
      <actions>
        <!-- CRITICAL: Only initialize settings if they don't exist (preserve saved settings) -->
        <do_if value="not global.$GT_GlobalSettings?">
          <!-- Initialize global GalaxyTrader MK3 settings -->
          <set_value name="global.$GT_GlobalSettings" exact="table[]"/>
          
          <!-- XP and Training Settings -->
          <set_value name="global.$GT_GlobalSettings.$XP" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$XP.$EnableXPProgression" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$XP.$AutoTraining" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$XP.$XPMultiplier" exact="800"/> <!-- Percentage: 50-800% -->
          <set_value name="global.$GT_GlobalSettings.$XP.$MinTrainingDistance" exact="5"/> <!-- Max distance to training stations -->
          <set_value name="global.$GT_GlobalSettings.$XP.$TrainingCooldown" exact="600s"/> <!-- Cooldown between training sessions -->
          
          <!-- Fleet Coordination Settings -->
          <set_value name="global.$GT_GlobalSettings.$Fleet" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$Fleet.$EnableFleetCoordination" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$Fleet.$EnableTradeCache" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$Fleet.$CacheProfitThreshold" exact="20"/> <!-- Percentage -->
          <set_value name="global.$GT_GlobalSettings.$Fleet.$CacheDropoffTolerance" exact="15"/> <!-- Percentage -->
          <set_value name="global.$GT_GlobalSettings.$Fleet.$CacheTTL" exact="300s"/> <!-- Time to live -->
          <set_value name="global.$GT_GlobalSettings.$Fleet.$MaxCachedRoutes" exact="50"/> <!-- Max cached routes -->
          
          <!-- Notification Settings -->
          <set_value name="global.$GT_GlobalSettings.$Notifications" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$Notifications.$Level" exact="1"/> <!-- 0=Minimal, 1=Normal, 2=Detailed -->
          <set_value name="global.$GT_GlobalSettings.$Notifications.$ShowXPGains" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$Notifications.$ShowTradeResults" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$Notifications.$ShowFleetStatus" exact="false"/>

          <!-- Mobile Satellite Intelligence Settings -->
          <set_value name="global.$GT_GlobalSettings.$MobileIntel" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$MobileIntel.$Enable" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$MobileIntel.$SubscriptionDuration" exact="10min"/>
          <set_value name="global.$GT_GlobalSettings.$MobileIntel.$StationCooldown" exact="60s"/>
          
          <!-- Threat Avoidance Settings -->
          <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$Enabled" exact="true"/>
          <!-- Note: RiskTolerance removed - now configured per-ship in command behavior (0.0-1.0 scale) -->
          <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$ScanInterval" exact="5s"/>
          <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$ThreatExpiry" exact="600s"/> <!-- 10 minutes -->
          <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$HostileRelationThreshold" exact="-0.20"/> <!-- Only flag factions with relation <= this value (default: -0.20 = -20%) -->
          
          <!-- Debug Settings -->
          <set_value name="global.$GT_GlobalSettings.$Debug" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$Debug.$DebugLevel" exact="1"/> <!-- 0=None, 1=Basic, 2=Verbose -->
          <set_value name="global.$GT_GlobalSettings.$Debug.$TradeEvaluation" exact="false"/>
          
          <!-- Ship Naming Settings -->
          <set_value name="global.$GT_GlobalSettings.$ShipNaming" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayXP" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$XPPosition" exact="'suffix'"/> <!-- 'prefix' or 'suffix' -->
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayRank" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$RankPosition" exact="'suffix'"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayLevel" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$LevelPosition" exact="'suffix'"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayStatus" exact="true"/>
          <set_value name="global.$GT_GlobalSettings.$ShipNaming.$StatusPosition" exact="'prefix'"/>
          
          <!-- Auto-Repair Settings -->
          <set_value name="global.$GT_GlobalSettings.$AutoRepair" exact="table[]"/>
          <set_value name="global.$GT_GlobalSettings.$AutoRepair.$Enabled" exact="true"/> <!-- Enable/disable auto-repair system -->
          <set_value name="global.$GT_GlobalSettings.$AutoRepair.$HullThreshold" exact="95"/> <!-- Hull percentage threshold (1-99) -->
          <set_value name="global.$GT_GlobalSettings.$AutoRepair.$MinPilotLevel" exact="12"/> <!-- Minimum pilot level required -->
          
          <debug_text text="'[GalaxyTrader MK3] Global settings initialized with defaults'" chance="100"/>
        </do_if>
        <do_else>
          <debug_text text="'[GalaxyTrader MK3] Global settings loaded from save'" chance="100"/>
        </do_else>
        
        <!-- Text Colors for UI -->
        <set_value name="$TextGreen" exact="'Color.text_success'"/>
        <set_value name="$TextRed" exact="'Color.text_failure'"/>
      </actions>
      
      <cues>
        <!-- Settings Validation and Restoration -->
        <cue name="ValidateSettings" instantiate="true" version="2">
          <conditions>
            <check_any>
              <event_universe_generated/>
              <event_game_loaded/>
              <event_cue_signalled/>
            </check_any>
          </conditions>
          <actions>
            <set_value name="$MissingVarCount" exact="0"/>
            
            <!-- Validate and restore missing settings -->
            <do_if value="not global.$GT_GlobalSettings?">
              <set_value name="global.$GT_GlobalSettings" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- XP Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$XP?">
              <set_value name="global.$GT_GlobalSettings.$XP" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$XP.$EnableXPProgression?">
              <set_value name="global.$GT_GlobalSettings.$XP.$EnableXPProgression" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$XP.$AutoTraining?">
              <set_value name="global.$GT_GlobalSettings.$XP.$AutoTraining" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$XP.$XPMultiplier?">
              <set_value name="global.$GT_GlobalSettings.$XP.$XPMultiplier" exact="800"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- Fleet Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$Fleet?">
              <set_value name="global.$GT_GlobalSettings.$Fleet" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$Fleet.$EnableFleetCoordination?">
              <set_value name="global.$GT_GlobalSettings.$Fleet.$EnableFleetCoordination" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$Fleet.$EnableTradeCache?">
              <set_value name="global.$GT_GlobalSettings.$Fleet.$EnableTradeCache" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$Fleet.$CacheProfitThreshold?">
              <set_value name="global.$GT_GlobalSettings.$Fleet.$CacheProfitThreshold" exact="20"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$Fleet.$CacheDropoffTolerance?">
              <set_value name="global.$GT_GlobalSettings.$Fleet.$CacheDropoffTolerance" exact="10"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$Fleet.$CacheTTL?">
              <set_value name="global.$GT_GlobalSettings.$Fleet.$CacheTTL" exact="300"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$Fleet.$MaxCachedRoutes?">
              <set_value name="global.$GT_GlobalSettings.$Fleet.$MaxCachedRoutes" exact="500"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- Initialize global trade cache system ALWAYS (early initialization to prevent race conditions) -->
            <!-- Even if global fleet coordination is disabled, individual ships may still use cache -->
            <do_if value="not global.$GT_TradeCache?">
              <set_value name="global.$GT_TradeCache" exact="table[]"/>
              <debug_text text="'[GalaxyTrader MK3] Global trade cache initialized from global settings (early init to prevent race conditions)'" chance="100"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <!-- Ensure cleanup timestamp always exists -->
            <do_if value="not global.$GT_TradeCacheLastCleanup?">
              <set_value name="global.$GT_TradeCacheLastCleanup" exact="player.age"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- Notification Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$Notifications?">
              <set_value name="global.$GT_GlobalSettings.$Notifications" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$Notifications.$Level?">
              <set_value name="global.$GT_GlobalSettings.$Notifications.$Level" exact="1"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- Debug Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$Debug?">
              <set_value name="global.$GT_GlobalSettings.$Debug" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <!-- Mobile Intel Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$MobileIntel?">
              <set_value name="global.$GT_GlobalSettings.$MobileIntel" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$MobileIntel.$Enable?">
              <set_value name="global.$GT_GlobalSettings.$MobileIntel.$Enable" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$MobileIntel.$SubscriptionDuration?">
              <set_value name="global.$GT_GlobalSettings.$MobileIntel.$SubscriptionDuration" exact="10min"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$MobileIntel.$StationCooldown?">
              <set_value name="global.$GT_GlobalSettings.$MobileIntel.$StationCooldown" exact="60s"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- Threat Avoidance Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$ThreatAvoidance?">
              <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ThreatAvoidance.$Enabled?">
              <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$Enabled" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <!-- Note: RiskTolerance validation removed - now per-ship parameter -->
            <do_if value="not global.$GT_GlobalSettings.$ThreatAvoidance.$ScanInterval?">
              <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$ScanInterval" exact="5s"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ThreatAvoidance.$ThreatExpiry?">
              <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$ThreatExpiry" exact="600s"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ThreatAvoidance.$HostileRelationThreshold?">
              <set_value name="global.$GT_GlobalSettings.$ThreatAvoidance.$HostileRelationThreshold" exact="-0.20"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <do_if value="not global.$GT_GlobalSettings.$Debug.$DebugLevel?">
              <set_value name="global.$GT_GlobalSettings.$Debug.$DebugLevel" exact="1"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- Ship Naming Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$DisplayXP?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayXP" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$XPPosition?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$XPPosition" exact="'suffix'"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$DisplayRank?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayRank" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$RankPosition?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$RankPosition" exact="'suffix'"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$DisplayLevel?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayLevel" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$LevelPosition?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$LevelPosition" exact="'suffix'"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$DisplayStatus?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$DisplayStatus" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$ShipNaming.$StatusPosition?">
              <set_value name="global.$GT_GlobalSettings.$ShipNaming.$StatusPosition" exact="'prefix'"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <!-- Auto-Repair Settings Validation -->
            <do_if value="not global.$GT_GlobalSettings.$AutoRepair?">
              <set_value name="global.$GT_GlobalSettings.$AutoRepair" exact="table[]"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$AutoRepair.$Enabled?">
              <set_value name="global.$GT_GlobalSettings.$AutoRepair.$Enabled" exact="true"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$AutoRepair.$HullThreshold?">
              <set_value name="global.$GT_GlobalSettings.$AutoRepair.$HullThreshold" exact="95"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            <do_if value="not global.$GT_GlobalSettings.$AutoRepair.$MinPilotLevel?">
              <set_value name="global.$GT_GlobalSettings.$AutoRepair.$MinPilotLevel" exact="12"/>
              <set_value name="$MissingVarCount" exact="1" operation="add"/>
            </do_if>
            
            <do_if value="$MissingVarCount gt 0">
              <debug_text text="'[GalaxyTrader MK3] Restored ' + $MissingVarCount + ' missing global settings'" chance="100"/>
            </do_if>
          </actions>
        </cue>
        
        <!-- Simple Menu API Integration -->
        <cue name="RegisterOptionsMenu" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.Simple_Menu_API.Reloaded"/>
      </conditions>
      <actions>
        <!-- Only register if we haven't already (prevents duplicate registration errors) -->
        <do_if value="not global.$GT_MenuRegistered?">
          <set_value name="global.$GT_MenuRegistered" exact="true"/>
          <!-- Register GalaxyTrader MK3 options menu -->
          <signal_cue_instantly cue="md.Simple_Menu_API.Register_Options_Menu" param="table[
            $id = 'gt_global_settings_menu',
            $columns = 8,
            $title = {77000,9000}, 
            $onOpen = SettingsMenu,
            $defaultFocus = false
          ]"/>
          <debug_text text="'[GalaxyTrader MK3] Global settings menu registered with Simple Menu API'" chance="100"/>
        </do_if>
      </actions>
        </cue>
        
        <!-- Global Settings Menu Builder -->
        <cue name="SettingsMenu" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
            <!-- Define color variables for UI -->
            <set_value name="$TextGreen" exact="'Color.text_success'"/>
            <set_value name="$TextRed" exact="'Color.text_failure'"/>
            
            <!-- XP and Training Section -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 8,
              $text = {77000,9010},
              $halign = 'center',
              $color = 'Color.text_positive'
            ]"/>
            
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
                      $text = {77000,9011},
        $mouseOverText = {77000,9111}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$XP.$EnableXPProgression then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$XP.$EnableXPProgression then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = Setting_Toggle,
              $onRightClick = Setting_Toggle,
              $echo = ['$XP', '$EnableXPProgression', global.$GT_GlobalSettings.$XP.$EnableXPProgression]
            ]"/>
            
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
                      $text = {77000,9012},
        $mouseOverText = {77000,9112}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$XP.$AutoTraining then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$XP.$AutoTraining then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = Setting_Toggle,
              $onRightClick = Setting_Toggle,
              $echo = ['$XP', '$AutoTraining', global.$GT_GlobalSettings.$XP.$AutoTraining]
            ]"/>
            
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
                      $text = {77000,9013},
        $mouseOverText = {77000,9113}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Slider" param="table[
              $col = 5,
              $colSpan = 4,
              $min = 50,
              $max = 800,
              $start = global.$GT_GlobalSettings.$XP.$XPMultiplier,
              $step = 10,
              $suffix = '%',
              $onSliderCellChanged = Slider_Update,
              $echo = table[$section = '$XP', $setting = '$XPMultiplier']
            ]"/>
            
            <!-- Fleet Coordination Section -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 8,
              $text = {77000,9020},
              $halign = 'center',
              $color = 'Color.text_positive'
            ]"/>
            
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
                      $text = {77000,9021},
        $mouseOverText = {77000,9121}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$Fleet.$EnableFleetCoordination then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$Fleet.$EnableFleetCoordination then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = Setting_Toggle,
              $onRightClick = Setting_Toggle,
              $echo = ['$Fleet', '$EnableFleetCoordination', global.$GT_GlobalSettings.$Fleet.$EnableFleetCoordination]
            ]"/>
            
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
                      $text = {77000,9023},
        $mouseOverText = {77000,9123}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$Fleet.$EnableTradeCache then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$Fleet.$EnableTradeCache then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = Setting_Toggle,
              $onRightClick = Setting_Toggle,
              $echo = ['$Fleet', '$EnableTradeCache', global.$GT_GlobalSettings.$Fleet.$EnableTradeCache]
            ]"/>
            
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
                      $text = {77000,9022},
        $mouseOverText = {77000,9122}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Slider" param="table[
              $col = 5,
              $colSpan = 4,
              $min = 5,
              $max = 100,
              $start = global.$GT_GlobalSettings.$Fleet.$CacheProfitThreshold,
              $step = 5,
              $suffix = '%',
              $onSliderCellChanged = Slider_Update,
              $echo = table[$section = '$Fleet', $setting = '$CacheProfitThreshold']
            ]"/>
            
            <!-- Notification Section -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 8,
              $text = {77000,9030},
              $halign = 'center',
              $color = 'Color.text_positive'
            ]"/>
            
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
                      $text = {77000,9031},
        $mouseOverText = {77000,9131}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Slider" param="table[
              $col = 5,
              $colSpan = 4,
              $min = 0,
              $max = 2,
              $start = global.$GT_GlobalSettings.$Notifications.$Level,
              $step = 1,
              $onSliderCellChanged = Slider_Update,
              $echo = table[$section = '$Notifications', $setting = '$Level']
            ]"/>
            
            <!-- Threat Avoidance Section -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 8,
              $text = 'Threat Avoidance System',
              $halign = 'center',
              $color = 'Color.text_positive'
            ]"/>
            
            <!-- Enable Threat Avoidance -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
              $text = 'Enable Threat Avoidance:',
              $mouseOverText = 'Level 6+ traders detect hostile ships and avoid dangerous routes. Disabling stops all scanning (improves performance). Risk tolerance per ship in command behavior (0-10 scale).'
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ThreatAvoidance.$Enabled then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$ThreatAvoidance.$Enabled then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = Setting_Toggle,
              $onRightClick = Setting_Toggle,
              $echo = ['$ThreatAvoidance', '$Enabled', global.$GT_GlobalSettings.$ThreatAvoidance.$Enabled]
            ]"/>
            
            <!-- Hostile Relation Threshold -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = 'Hostile Relation Threshold:',
              $mouseOverText = 'Only flag factions with relation at or below this value as threats. Default: -20%'
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Slider" param="table[
              $col = 5,
              $colSpan = 4,
              $min = -100,
              $max = 0,
              $start = (global.$GT_GlobalSettings.$ThreatAvoidance.$HostileRelationThreshold * 100),
              $step = 1,
              $suffix = '%',
              $onSliderCellChanged = Relation_Update,
              $echo = table[$section = '$ThreatAvoidance', $setting = '$HostileRelationThreshold']
            ]"/>
            
            <!-- Note: Risk Tolerance is now configured per-ship in the command behavior settings -->
            
            <!-- Auto-Repair Section -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 8,
              $text = {77000,9040},
              $halign = 'center',
              $color = 'Color.text_positive'
            ]"/>
            
            <!-- Enable Auto-Repair -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 6,
              $text = {77000,9041},
              $mouseOverText = {77000,9141}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$AutoRepair.$Enabled then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$AutoRepair.$Enabled then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = Setting_Toggle,
              $onRightClick = Setting_Toggle,
              $echo = ['$AutoRepair', '$Enabled', global.$GT_GlobalSettings.$AutoRepair.$Enabled]
            ]"/>
            
            <!-- Hull Threshold Slider -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = {77000,9042},
              $mouseOverText = {77000,9142}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Slider" param="table[
              $col = 5,
              $colSpan = 4,
              $min = 50,
              $max = 99,
              $start = global.$GT_GlobalSettings.$AutoRepair.$HullThreshold,
              $step = 5,
              $suffix = '%',
              $onSliderCellChanged = Slider_Update,
              $echo = table[$section = '$AutoRepair', $setting = '$HullThreshold']
            ]"/>
            
            <!-- Minimum Pilot Level Slider -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = {77000,9043},
              $mouseOverText = {77000,9143}
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Slider" param="table[
              $col = 5,
              $colSpan = 4,
              $min = 1,
              $max = 15,
              $start = global.$GT_GlobalSettings.$AutoRepair.$MinPilotLevel,
              $step = 1,
              $onSliderCellChanged = Slider_Update,
              $echo = table[$section = '$AutoRepair', $setting = '$MinPilotLevel']
            ]"/>
            
            <!-- Ship Naming Section -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 8,
              $text = 'Ship Naming Configuration',
              $halign = 'center',
              $color = 'Color.text_positive'
            ]"/>
            
            <!-- Display XP Setting -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = 'Display XP:',
              $mouseOverText = 'Show XP values in ship names'
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 5,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$DisplayXP then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$ShipNaming.$DisplayXP then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = Setting_Toggle,
              $onRightClick = Setting_Toggle,
              $echo = ['$ShipNaming', '$DisplayXP', global.$GT_GlobalSettings.$ShipNaming.$DisplayXP]
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$XPPosition == 'prefix' then 'Prefix' else 'Suffix',
                $color = 'Color.text_normal',
                $halign = 'center'
              ],
              $onClick = Position_Toggle,
              $onRightClick = Position_Toggle,
              $echo = ['$ShipNaming', '$XPPosition', global.$GT_GlobalSettings.$ShipNaming.$XPPosition]
            ]"/>
            
            <!-- Display Rank Setting -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = 'Display Pilot Rank:',
              $mouseOverText = 'Show pilot skill rank in ship names'
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 5,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$DisplayRank then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$ShipNaming.$DisplayRank then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = Setting_Toggle,
              $onRightClick = Setting_Toggle,
              $echo = ['$ShipNaming', '$DisplayRank', global.$GT_GlobalSettings.$ShipNaming.$DisplayRank]
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$RankPosition == 'prefix' then 'Prefix' else 'Suffix',
                $color = 'Color.text_normal',
                $halign = 'center'
              ],
              $onClick = Position_Toggle,
              $onRightClick = Position_Toggle,
              $echo = ['$ShipNaming', '$RankPosition', global.$GT_GlobalSettings.$ShipNaming.$RankPosition]
            ]"/>
            
            <!-- Display Level Setting -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = 'Display Level:',
              $mouseOverText = 'Show pilot level in ship names'
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 5,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$DisplayLevel then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$ShipNaming.$DisplayLevel then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = Setting_Toggle,
              $onRightClick = Setting_Toggle,
              $echo = ['$ShipNaming', '$DisplayLevel', global.$GT_GlobalSettings.$ShipNaming.$DisplayLevel]
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$LevelPosition == 'prefix' then 'Prefix' else 'Suffix',
                $color = 'Color.text_normal',
                $halign = 'center'
              ],
              $onClick = Position_Toggle,
              $onRightClick = Position_Toggle,
              $echo = ['$ShipNaming', '$LevelPosition', global.$GT_GlobalSettings.$ShipNaming.$LevelPosition]
            ]"/>
            
            <!-- Display Status Setting -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
              $col = 1,
              $colSpan = 4,
              $text = 'Display Status:',
              $mouseOverText = 'Show training status in ship names'
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 5,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$DisplayStatus then {1001,4825} else {1001,8942},
                $color = if global.$GT_GlobalSettings.$ShipNaming.$DisplayStatus then $TextGreen else $TextRed,
                $halign = 'center'
              ],
              $onClick = Setting_Toggle,
              $onRightClick = Setting_Toggle,
              $echo = ['$ShipNaming', '$DisplayStatus', global.$GT_GlobalSettings.$ShipNaming.$DisplayStatus]
            ]"/>
            <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
              $col = 7,
              $colSpan = 2,
              $text = table[
                $text = if global.$GT_GlobalSettings.$ShipNaming.$StatusPosition == 'prefix' then 'Prefix' else 'Suffix',
                $color = 'Color.text_normal',
                $halign = 'center'
              ],
              $onClick = Position_Toggle,
              $onRightClick = Position_Toggle,
              $echo = ['$ShipNaming', '$StatusPosition', global.$GT_GlobalSettings.$ShipNaming.$StatusPosition]
            ]"/>
      </actions>
        </cue>
        
        <!-- Setting Toggle Handler -->
        <cue name="Setting_Toggle" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
            <!-- Debug: Show the full parameter structure -->
            <debug_text text="'[GalaxyTrader MK3] ToggleSetting called with event.param: ' + event.param" chance="100"/>
            
            <!-- Extract parameters from the echo array -->
            <set_value name="$section" exact="event.param.$echo.{1}"/>
            <set_value name="$setting" exact="event.param.$echo.{2}"/>
            <set_value name="$currentValue" exact="event.param.$echo.{3}"/>
            
            <debug_text text="'[GalaxyTrader MK3] Extracted parameters - Section: ' + $section + ', Setting: ' + $setting + ', CurrentValue: ' + $currentValue" chance="100"/>
            
            <!-- Toggle the setting -->
            <set_value name="global.$GT_GlobalSettings.{$section}.{$setting}" exact="not $currentValue"/>
            
            <debug_text text="'[GalaxyTrader MK3] Global setting toggled: ' + $section + '.' + $setting + ' = ' + global.$GT_GlobalSettings.{$section}.{$setting}" chance="100"/>
            
            <!-- If this is a ship naming setting, update all ship names -->
            <do_if value="$section == '$ShipNaming'">
              <signal_cue_instantly cue="md.GT_CoreSystem.UpdateAllShipNames"/>
            </do_if>
            
            <!-- Refresh the menu -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Refresh_Menu"/>
      </actions>
        </cue>
        
        <!-- Position Toggle Handler -->
        <cue name="Position_Toggle" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
            <!-- Debug: Show the full parameter structure -->
            <debug_text text="'[GalaxyTrader MK3] TogglePosition called with event.param: ' + event.param" chance="100"/>
            
            <!-- Extract parameters from the echo array -->
            <set_value name="$section" exact="event.param.$echo.{1}"/>
            <set_value name="$setting" exact="event.param.$echo.{2}"/>
            <set_value name="$currentValue" exact="event.param.$echo.{3}"/>
            
            <debug_text text="'[GalaxyTrader MK3] Extracted parameters - Section: ' + $section + ', Setting: ' + $setting + ', CurrentValue: ' + $currentValue" chance="100"/>
            
            <!-- Toggle between 'prefix' and 'suffix' -->
            <set_value name="global.$GT_GlobalSettings.{$section}.{$setting}" exact="if $currentValue == 'prefix' then 'suffix' else 'prefix'"/>
            
            <debug_text text="'[GalaxyTrader MK3] Position setting toggled: ' + $section + '.' + $setting + ' = ' + global.$GT_GlobalSettings.{$section}.{$setting}" chance="100"/>
            
            <!-- Update all ship names when position changes -->
            <signal_cue_instantly cue="md.GT_CoreSystem.UpdateAllShipNames"/>
            
            <!-- Refresh the menu -->
            <signal_cue_instantly cue="md.Simple_Menu_API.Refresh_Menu"/>
      </actions>
        </cue>
        
        <!-- Slider Value Update Handler -->
        <cue name="Slider_Update" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
            <!-- Debug: Print the entire event parameter structure -->
            <debug_text text="'[GalaxyTrader MK3] UpdateSliderValue called with event.param: ' + event.param" chance="100"/>
            
            <!-- Simple Menu API passes a table with $value and $echo -->
            <set_value name="$newValue" exact="null"/>
            <set_value name="$section" exact="null"/>
            <set_value name="$setting" exact="null"/>
            
            <!-- Get the new slider value from $value -->
            <do_if value="event.param.$value?">
              <set_value name="$newValue" exact="event.param.$value"/>
              <debug_text text="'[GalaxyTrader MK3] Slider new value: ' + $newValue" chance="100"/>
            </do_if>
            
            <!-- Get the echo data from $echo -->
            <do_if value="event.param.$echo? and event.param.$echo.$section? and event.param.$echo.$setting?">
              <set_value name="$section" exact="event.param.$echo.$section"/>
              <set_value name="$setting" exact="event.param.$echo.$setting"/>
              <debug_text text="'[GalaxyTrader MK3] Echo data - Section: ' + $section + ', Setting: ' + $setting" chance="100"/>
            </do_if>
            
            <!-- Update the setting if we have all required data -->
            <do_if value="$newValue? and $section and $setting">
              <!-- Use the section and setting names directly as they come from the echo parameter -->
              <!-- The global settings structure uses these exact names with dollar signs -->
              <set_value name="$cleanSection" exact="$section"/>
              <set_value name="$cleanSetting" exact="$setting"/>
              
              <!-- Update the setting -->
              <set_value name="global.$GT_GlobalSettings.{$cleanSection}.{$cleanSetting}" exact="$newValue"/>
              <debug_text text="'[GalaxyTrader MK3] Global setting updated: ' + $cleanSection + '.' + $cleanSetting + ' = ' + $newValue" chance="100"/>
            </do_if>
            <do_else>
              <debug_text text="'[GalaxyTrader MK3] ERROR: Missing required parameters - Value: ' + $newValue + ', Section: ' + $section + ', Setting: ' + $setting" chance="100"/>
            </do_else>
      </actions>
        </cue>
        
        <!-- Relation Threshold Update Handler (converts percentage to normalized value) -->
        <cue name="Relation_Update" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
            <debug_text text="'[GalaxyTrader MK3] UpdateRelationThreshold called with event.param: ' + event.param" chance="100"/>
            
            <!-- Simple Menu API passes a table with $value (percentage -100 to 0) and $echo -->
            <set_value name="$percentageValue" exact="null"/>
            <set_value name="$section" exact="null"/>
            <set_value name="$setting" exact="null"/>
            
            <!-- Get the percentage value from $value -->
            <do_if value="event.param.$value?">
              <set_value name="$percentageValue" exact="event.param.$value"/>
              <debug_text text="'[GalaxyTrader MK3] Relation threshold percentage value: ' + $percentageValue + '%'" chance="100"/>
            </do_if>
            
            <!-- Get the echo data from $echo -->
            <do_if value="event.param.$echo? and event.param.$echo.$section? and event.param.$echo.$setting?">
              <set_value name="$section" exact="event.param.$echo.$section"/>
              <set_value name="$setting" exact="event.param.$echo.$setting"/>
            </do_if>
            
            <!-- Convert percentage to normalized value and update setting -->
            <do_if value="$percentageValue? and $section and $setting">
              <!-- Convert percentage (-100 to 0) to normalized (-1.0 to 0.0) -->
              <set_value name="$normalizedValue" exact="$percentageValue / 100"/>
              
              <!-- Update the setting -->
              <set_value name="global.$GT_GlobalSettings.{$section}.{$setting}" exact="$normalizedValue"/>
              <debug_text text="'[GalaxyTrader MK3] Relation threshold updated: ' + $section + '.' + $setting + ' = ' + $normalizedValue + ' (' + $percentageValue + '%)'" chance="100"/>
            </do_if>
            <do_else>
              <debug_text text="'[GalaxyTrader MK3] ERROR: Missing required parameters for relation threshold update'" chance="100"/>
            </do_else>
      </actions>
        </cue>
        
      </cues>
    </cue>
    
  </cues>
</mdscript> 