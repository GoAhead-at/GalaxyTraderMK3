<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Ship_State_Manager" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - SHIP STATE MANAGER
         Event-driven state machine for tracking ship states
         ======================================== -->
    
    <!-- Update Ship State -->
    <cue name="UpdateState" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_Ship_State_Manager.UpdateState"/>
      </conditions>
      <actions>
        <set_value name="$params" exact="event.param"/>
        <set_value name="$ship" exact="$params.$Ship"/>
        <set_value name="$updateType" exact="$params.$UpdateType"/>
        
        <!-- Initialize registry if needed -->
        <do_if value="not global.$GT_Ship_State?">
          <set_value name="global.$GT_Ship_State" exact="table[]"/>
        </do_if>
        
        <!-- Initialize ship state if needed -->
        <do_if value="not global.$GT_Ship_State.{$ship}?">
          <set_value name="global.$GT_Ship_State.{$ship}" exact="table[
            $OperationalState = 'idle',
            $SubordinateState = 'independent',
            $Commander = null,
            $CommanderHasGT = false,
            $HasGTOrder = false,
            $HasAssistOrder = false,
            $ActiveTradeOrders = 0,
            $LastStateUpdate = player.age,
            $StateHistory = [],
            $MacroShipName = null,
            $OriginalShipName = null,
            $DefaultOrder = null,
            $CurrentOrder = null
          ]"/>
        </do_if>
        
        <set_value name="$state" exact="global.$GT_Ship_State.{$ship}"/>
        
        <!-- ✅ PHASE 3: Update state directly (removed library call that doesn't exist yet) -->
        <!-- This tests if the handler processing interferes with trade execution -->
        
        <!-- Update state based on update type -->
        <do_if value="$updateType == 'GT_Order_Assigned'">
          <!-- ✅ CRITICAL: Reset state completely when GT order is assigned -->
          <set_value name="$state.$HasGTOrder" exact="true"/>
          <set_value name="$state.$OperationalState" exact="'idle'"/>
          <set_value name="$state.$SubordinateState" exact="'independent'"/>
          <set_value name="$state.$ActiveTradeOrders" exact="0"/>
          <set_value name="$state.$HasAssistOrder" exact="false"/>
          
          <!-- Store macro ship name if provided -->
          <do_if value="$params.$MacroShipName?">
            <set_value name="$state.$MacroShipName" exact="$params.$MacroShipName"/>
            <set_value name="$state.$OriginalShipName" exact="$params.$MacroShipName"/>
          </do_if>
          <do_else>
            <!-- Fallback: capture from ship if not provided -->
            <set_value name="$macroName" exact="@$ship.macro.name"/>
            <do_if value="$macroName?">
              <set_value name="$state.$MacroShipName" exact="$macroName"/>
              <set_value name="$state.$OriginalShipName" exact="$macroName"/>
            </do_if>
          </do_else>
          
          <debug_text text="'[GT-State] ' + $ship.idcode + ': GT order assigned - state reset to idle'" chance="100"/>
        </do_if>
        <do_elseif value="$updateType == 'Trade_Order_Created'">
          <!-- ✅ PHASE 3: Handle Trade_Order_Created update -->
          <set_value name="$tradeOrderCount" exact="1"/>
          <do_if value="$params.$TradeOrderCount?">
            <set_value name="$tradeOrderCount" exact="$params.$TradeOrderCount"/>
          </do_if>
          <do_elseif value="$ship.tradeorders?">
            <set_value name="$tradeOrderCount" exact="$ship.tradeorders.count"/>
          </do_elseif>
          <set_value name="$state.$ActiveTradeOrders" exact="$tradeOrderCount"/>
          <set_value name="$state.$OperationalState" exact="'trading'"/>
          <debug_text text="'[GT-State] Phase 3: ' + $ship.idcode + ' - Trade order created, state updated to trading (orders: ' + $tradeOrderCount + ')'" chance="100"/>
        </do_elseif>
        <do_elseif value="$updateType == 'Trade_Order_Completed'">
          <!-- ✅ PHASE 3: Handle Trade_Order_Completed update (simplified, no library call) -->
          <set_value name="$remainingOrders" exact="0"/>
          <do_if value="$params.$RemainingOrders?">
            <set_value name="$remainingOrders" exact="$params.$RemainingOrders"/>
          </do_if>
          <do_elseif value="$ship.tradeorders?">
            <set_value name="$remainingOrders" exact="$ship.tradeorders.count"/>
          </do_elseif>
          <set_value name="$remainingOrders" exact="[$remainingOrders, 0].max"/>
          <set_value name="$state.$ActiveTradeOrders" exact="$remainingOrders"/>
          <do_if value="$state.$ActiveTradeOrders == 0">
            <set_value name="$state.$OperationalState" exact="'idle'"/>
          </do_if>
          <debug_text text="'[GT-State] Phase 4: ' + $ship.idcode + ' - Trade order completed, state updated (remaining orders: ' + $remainingOrders + ', operational state: ' + $state.$OperationalState + ')'" chance="100"/>
        </do_elseif>
        <do_elseif value="$updateType == 'Commander_Removed'">
          <set_value name="$state.$Commander" exact="null"/>
          <set_value name="$state.$CommanderHasGT" exact="false"/>
          <set_value name="$state.$IsSubordinate" exact="false"/>
          
          <!-- Check if ship still has GT order -->
          <set_value name="$hasGTOrder" exact="false"/>
          <do_if value="$params.$HasGTOrder?">
            <set_value name="$hasGTOrder" exact="$params.$HasGTOrder"/>
          </do_if>
          <do_elseif value="$currentState.$HasGTOrder?">
            <set_value name="$hasGTOrder" exact="$currentState.$HasGTOrder"/>
          </do_elseif>
          <set_value name="$state.$HasGTOrder" exact="$hasGTOrder"/>
          
          <!-- Determine subordinate state -->
          <do_if value="$hasGTOrder">
            <set_value name="$state.$SubordinateState" exact="'independent'"/>
          </do_if>
          <do_else>
            <set_value name="$state.$SubordinateState" exact="'orphaned'"/>
          </do_else>
        </do_elseif>
        <do_elseif value="$updateType == 'Commander_Changed'">
          <set_value name="$newCommander" exact="$params.$Commander"/>
          <set_value name="$commanderHasGT" exact="false"/>
          <do_if value="$params.$CommanderHasGT?">
            <set_value name="$commanderHasGT" exact="$params.$CommanderHasGT"/>
          </do_if>
          
          <set_value name="$state.$Commander" exact="$newCommander"/>
          <set_value name="$state.$CommanderHasGT" exact="$commanderHasGT"/>
          
          <!-- Recalculate subordinate state -->
          <set_value name="$state.$SubordinateState" exact="'independent'"/>
          <set_value name="$state.$IsSubordinate" exact="false"/>
          <do_if value="$newCommander? and $newCommander.exists">
            <set_value name="$state.$IsSubordinate" exact="true"/>
            <do_if value="$commanderHasGT">
              <set_value name="$state.$SubordinateState" exact="'subordinate'"/>
            </do_if>
            <do_else>
              <set_value name="$state.$SubordinateState" exact="'orphaned'"/>
            </do_else>
          </do_if>
          <debug_text text="'[GT-State] Phase 6: ' + $ship.idcode + ' - Commander changed (commander: ' + (if $newCommander? and $newCommander.exists then $newCommander.idcode else 'NONE') + ', has GT: ' + $commanderHasGT + ', subordinate state: ' + $state.$SubordinateState + ')'" chance="100"/>
        </do_elseif>
        <do_elseif value="$updateType == 'Subordinate_Count_Changed'">
          <!-- ✅ PHASE 6: Handle subordinate count changes (ship becomes commander or stops being one) -->
          <set_value name="$oldSubordinateCount" exact="0"/>
          <set_value name="$newSubordinateCount" exact="0"/>
          <set_value name="$wasCommander" exact="false"/>
          <set_value name="$isCommander" exact="false"/>
          
          <do_if value="$params.$OldSubordinateCount?">
            <set_value name="$oldSubordinateCount" exact="$params.$OldSubordinateCount"/>
          </do_if>
          <do_if value="$params.$NewSubordinateCount?">
            <set_value name="$newSubordinateCount" exact="$params.$NewSubordinateCount"/>
          </do_if>
          <do_if value="$params.$WasCommander?">
            <set_value name="$wasCommander" exact="$params.$WasCommander"/>
          </do_if>
          <do_if value="$params.$IsCommander?">
            <set_value name="$isCommander" exact="$params.$IsCommander"/>
          </do_if>
          
          <!-- Update state to reflect commander status -->
          <!-- Note: This doesn't change subordinate state (independent/subordinate/orphaned) -->
          <!-- It just tracks that this ship now has subordinates (is a commander) -->
          <!-- The subordinate state is about THIS ship's relationship to ITS commander -->
          <!-- This update is about THIS ship's relationship to ITS subordinates -->
          
          <debug_text text="'[GT-State] Phase 6: ' + $ship.idcode + ' - Subordinate count changed (old: ' + $oldSubordinateCount + ', new: ' + $newSubordinateCount + ', was commander: ' + $wasCommander + ', is commander: ' + $isCommander + ')'" chance="100"/>
        </do_elseif>
        <do_elseif value="$updateType == 'Order_Ready'">
          <!-- Update from current state -->
          <set_value name="$state.$DefaultOrder" exact="$currentState.$DefaultOrder"/>
          <set_value name="$state.$CurrentOrder" exact="$currentState.$CurrentOrder"/>
          <set_value name="$state.$HasGTOrder" exact="$currentState.$HasGTOrder"/>
          <set_value name="$state.$IsSubordinate" exact="$currentState.$IsSubordinate"/>
          <set_value name="$state.$CommanderHasGT" exact="$currentState.$CommanderHasGT"/>
          <set_value name="$state.$OperationalState" exact="$currentState.$State"/>
        </do_elseif>
        <do_elseif value="$updateType == 'Order_Cancelled'">
          <!-- Update from current state -->
          <set_value name="$state.$DefaultOrder" exact="$currentState.$DefaultOrder"/>
          <set_value name="$state.$CurrentOrder" exact="$currentState.$CurrentOrder"/>
          <set_value name="$state.$HasGTOrder" exact="$currentState.$HasGTOrder"/>
          <set_value name="$state.$IsSubordinate" exact="$currentState.$IsSubordinate"/>
          <set_value name="$state.$CommanderHasGT" exact="$currentState.$CommanderHasGT"/>
          
          <!-- Check if GT order was cancelled -->
          <set_value name="$cancelledOrderId" exact="null"/>
          <do_if value="$params.$CancelledOrder?">
            <set_value name="$cancelledOrderId" exact="$params.$CancelledOrder"/>
          </do_if>
          <do_if value="$cancelledOrderId == 'GalaxyTraderMK3'">
            <set_value name="$state.$HasGTOrder" exact="false"/>
            <set_value name="$state.$OperationalState" exact="'orphaned'"/>
          </do_if>
          <do_else>
            <set_value name="$state.$OperationalState" exact="$currentState.$State"/>
          </do_else>
        </do_elseif>
        <do_elseif value="$updateType == 'Order_Finished'">
          <!-- Update from current state -->
          <set_value name="$state.$DefaultOrder" exact="$currentState.$DefaultOrder"/>
          <set_value name="$state.$CurrentOrder" exact="$currentState.$CurrentOrder"/>
          <set_value name="$state.$HasGTOrder" exact="$currentState.$HasGTOrder"/>
          <set_value name="$state.$IsSubordinate" exact="$currentState.$IsSubordinate"/>
          <set_value name="$state.$CommanderHasGT" exact="$currentState.$CommanderHasGT"/>
          <set_value name="$state.$OperationalState" exact="$currentState.$State"/>
        </do_elseif>
        <do_elseif value="$updateType == 'Commander_Set'">
          <!-- Update from current state -->
          <set_value name="$state.$DefaultOrder" exact="$currentState.$DefaultOrder"/>
          <set_value name="$state.$CurrentOrder" exact="$currentState.$CurrentOrder"/>
          <set_value name="$state.$HasGTOrder" exact="$currentState.$HasGTOrder"/>
          <set_value name="$state.$IsSubordinate" exact="$currentState.$IsSubordinate"/>
          <set_value name="$state.$CommanderHasGT" exact="$currentState.$CommanderHasGT"/>
          <set_value name="$state.$OperationalState" exact="$currentState.$State"/>
          
          <!-- Update commander reference -->
          <set_value name="$newCommander" exact="$params.$NewCommander"/>
          <set_value name="$state.$Commander" exact="$newCommander"/>
          
          <!-- Recalculate subordinate state -->
          <set_value name="$state.$SubordinateState" exact="'independent'"/>
          <set_value name="$state.$IsSubordinate" exact="false"/>
          <do_if value="$newCommander? and $newCommander.exists">
            <set_value name="$state.$IsSubordinate" exact="true"/>
            <set_value name="$commanderHasGT" exact="false"/>
            <do_if value="$newCommander.defaultorder? and @$newCommander.defaultorder.id == 'GalaxyTraderMK3'">
              <set_value name="$commanderHasGT" exact="true"/>
            </do_if>
            <set_value name="$state.$CommanderHasGT" exact="$commanderHasGT"/>
            <do_if value="$commanderHasGT">
              <set_value name="$state.$SubordinateState" exact="'subordinate'"/>
            </do_if>
            <do_else>
              <set_value name="$state.$SubordinateState" exact="'orphaned'"/>
            </do_else>
          </do_if>
        </do_elseif>
        <do_elseif value="$updateType == 'Transition_To_Independent'">
          <set_value name="$state.$SubordinateState" exact="'independent'"/>
          <set_value name="$state.$IsSubordinate" exact="false"/>
          <set_value name="$state.$Commander" exact="null"/>
          <set_value name="$state.$CommanderHasGT" exact="false"/>
        </do_elseif>
        <do_elseif value="$updateType == 'Orphaned'">
          <set_value name="$state.$SubordinateState" exact="'orphaned'"/>
          <set_value name="$state.$OperationalState" exact="'orphaned'"/>
        </do_elseif>
        <do_else>
          <!-- Generic update: sync with current state -->
          <set_value name="$state.$DefaultOrder" exact="$currentState.$DefaultOrder"/>
          <set_value name="$state.$CurrentOrder" exact="$currentState.$CurrentOrder"/>
          <set_value name="$state.$HasTradeOrders" exact="$currentState.$HasTradeOrders"/>
          <set_value name="$state.$IsSubordinate" exact="$currentState.$IsSubordinate"/>
          <set_value name="$state.$CommanderHasGT" exact="$currentState.$CommanderHasGT"/>
          <set_value name="$state.$OperationalState" exact="$currentState.$State"/>
          
          <!-- Update commander reference -->
          <do_if value="$currentState.$IsSubordinate">
            <set_value name="$state.$Commander" exact="$ship.commander"/>
          </do_if>
          <do_else>
            <set_value name="$state.$Commander" exact="null"/>
          </do_else>
        </do_else>
        
        <!-- Update timestamp -->
        <set_value name="$state.$LastStateUpdate" exact="player.age"/>
        
        <!-- Add to history (for debugging) -->
        <do_if value="not $state.$StateHistory?">
          <set_value name="$state.$StateHistory" exact="[]"/>
        </do_if>
        
        <!-- Ensure DefaultOrder and CurrentOrder exist before accessing -->
        <do_if value="not $state.$DefaultOrder?">
          <set_value name="$state.$DefaultOrder" exact="@$currentState.$DefaultOrder"/>
        </do_if>
        <do_if value="not $state.$CurrentOrder?">
          <set_value name="$state.$CurrentOrder" exact="@$currentState.$CurrentOrder"/>
        </do_if>
        
        <append_to_list name="$state.$StateHistory" exact="table[
          $Time = player.age,
          $UpdateType = $updateType,
          $OperationalState = $state.$OperationalState,
          $SubordinateState = $state.$SubordinateState,
          $DefaultOrder = $state.$DefaultOrder,
          $CurrentOrder = $state.$CurrentOrder
        ]"/>
        
        <!-- Limit history size (keep last 50 entries) -->
        <do_if value="$state.$StateHistory.count gt 50">
          <set_value name="$historyCount" exact="$state.$StateHistory.count"/>
          <set_value name="$state.$StateHistory" exact="$state.$StateHistory.[$historyCount - 50, $historyCount]"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Signal Handler for AI Script Updates -->
    <!-- AI scripts use signal_objects, so we need to listen for that signal -->
    <cue name="HandleAIStateUpdate" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Ship_State_Update'"/>
      </conditions>
      <actions>
        <!-- Forward to UpdateState cue -->
        <signal_cue_instantly cue="md.GT_Ship_State_Manager.UpdateState" param="event.param2"/>
      </actions>
    </cue>
  </cues>
</mdscript>
