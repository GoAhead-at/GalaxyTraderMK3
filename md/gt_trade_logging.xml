<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_TradeLogging" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    
    <!-- Initialize Trade Logging System -->
    <cue name="SystemInit" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_CoreSystem.SystemInit"/>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3] Trade logging system initializing...'" chance="100"/>
        
        <!-- Initialize logbook settings -->
        <set_value name="global.$GT_TradeLogging" exact="table[]"/>
        <set_value name="global.$GT_TradeLogging.$Enabled" exact="true"/>
        <set_value name="global.$GT_TradeLogging.$TrainingMessages" exact="true"/>
        <set_value name="global.$GT_TradeLogging.$LifetimeProfit" exact="table[]"/>
        
        <debug_text text="'[GalaxyTrader MK3] Trade logging system initialized'" chance="100"/>
      </actions>
    </cue>
    
    <!-- Per-Trade Logbook Entry (TaterTrader Style) -->
    <cue name="LogTradeOrder" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_TradeLogging_LogTradeOrder'"/>
      </conditions>
      <actions>
        <debug_text text="'[GT-TradeLogging] LogTradeOrder cue triggered'" chance="100"/>
        
        <!-- Extract trade data from signal -->
        <set_value name="$ship" exact="event.param2.$Ship"/>
        <set_value name="$sellOffer" exact="event.param2.$SellOffer"/>
        <set_value name="$buyOffer" exact="event.param2.$BuyOffer"/>
        <set_value name="$amount" exact="event.param2.$Amount"/>
        <set_value name="$profit" exact="event.param2.$Profit"/>
        <set_value name="$sellPrice" exact="event.param2.$SellPrice"/>
        <set_value name="$buyPrice" exact="event.param2.$BuyPrice"/>
        
        <debug_text text="'[GT-TradeLogging] ========== RAW DATA RECEIVED ==========' + '\n🚢 Ship: ' + $ship.knownname + ' (' + $ship.idcode + ')' + '\n📥 BuyOffer object: ' + $buyOffer + ' → Station: ' + $buyOffer.owner.knownname + ', Ware: ' + $buyOffer.ware + ', UnitPrice: ' + ($buyOffer.unitprice/100) + ' Cr' + '\n📤 SellOffer object: ' + $sellOffer + ' → Station: ' + $sellOffer.owner.knownname + ', Ware: ' + $sellOffer.ware + ', UnitPrice: ' + ($sellOffer.unitprice/100) + ' Cr' + '\n📊 Amount: ' + $amount + '\n💰 Profit param: ' + ($profit/100) + ' Cr' + '\n💵 $buyPrice param: ' + $buyPrice + ' Cr' + '\n💵 $sellPrice param: ' + $sellPrice + ' Cr'" chance="100"/>
        
        <!-- Initialize logging system if not already done -->
        <do_if value="not global.$GT_TradeLogging?">
          <set_value name="global.$GT_TradeLogging" exact="table[]"/>
          <set_value name="global.$GT_TradeLogging.$Enabled" exact="true"/>
          <set_value name="global.$GT_TradeLogging.$TrainingMessages" exact="true"/>
          <set_value name="global.$GT_TradeLogging.$LifetimeProfit" exact="table[]"/>
          <debug_text text="'[GalaxyTrader MK3] Trade logging system auto-initialized'" chance="100"/>
        </do_if>
        
        <!-- Only log if enabled -->
        <do_if value="global.$GT_TradeLogging.$Enabled">
          
          <!-- Calculate lifetime profit for this ship -->
          <set_value name="$lifetimeProfit" exact="0"/>
          <do_if value="global.$GT_TradeLogging.$LifetimeProfit.{$ship}?">
            <set_value name="$lifetimeProfit" exact="global.$GT_TradeLogging.$LifetimeProfit.{$ship}"/>
          </do_if>
          
          <!-- Update lifetime profit -->
          <set_value name="global.$GT_TradeLogging.$LifetimeProfit.{$ship}" exact="$lifetimeProfit + $profit"/>
          
          <!-- ✅ BUGFIX: Parameters now correctly named - buyPrice is BUY price, sellPrice is SELL price -->
          <set_value name="$message" exact="{77000,3101}.[$amount,$buyOffer.ware,$buyPrice,$sellPrice,$profit/100]"/>
          
          <!-- Add lifetime profit info -->
          <set_value name="$message" exact="$message + {77000,3106}.[$lifetimeProfit/100]"/>
          
          <debug_text text="'[GT-TradeLogging] ========== LOGBOOK DATA BEING WRITTEN ==========' + '\n📝 Message params for {77000,3101}: Amount=' + $amount + ', Ware=' + $buyOffer.ware + ', BuyAt=' + $buyPrice + ', SellAt=' + $sellPrice + ', Profit=' + ($profit/100) + '\n💸 Money field: -' + ($amount * $buyPrice) + ' Cr' + '\n🎁 Bonus field: ' + ($profit/100) + ' Cr' + '\n📄 Final message text: ' + $message" chance="100"/>
          
          <!-- Write to ship logbook (TaterTrader style) -->
          <write_to_logbook 
            category="upkeep" 
            title="'GalaxyTrader MK3: ' + $ship.knownname + ' (' + $ship.idcode + ')'" 
            interaction="showonmap" 
            object="$ship" 
            money="-$amount * $buyPrice" 
            bonus="$profit" 
            text="$message"/>
          
          <debug_text text="'[GalaxyTrader MK3] Trade logged for ' + $ship.knownname + ' (' + $ship.idcode + '): ' + $amount + ' ' + $buyOffer.ware + ' (Profit: ' + ($profit/100) + ' Cr)'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Trade Completion Logbook Entry -->
    <cue name="LogTradeCompletion" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_TradeLogging_LogTradeCompletion'"/>
      </conditions>
      <actions>
        <!-- Extract completion data -->
        <set_value name="$ship" exact="event.param2.$Ship"/>
        <set_value name="$ware" exact="event.param2.$Ware"/>
        <set_value name="$amount" exact="event.param2.$Amount"/>
        <set_value name="$totalProfit" exact="event.param2.$TotalProfit"/>
        
        <!-- Initialize logging system if not already done -->
        <do_if value="not global.$GT_TradeLogging?">
          <set_value name="global.$GT_TradeLogging" exact="table[]"/>
          <set_value name="global.$GT_TradeLogging.$Enabled" exact="true"/>
          <set_value name="global.$GT_TradeLogging.$TrainingMessages" exact="true"/>
          <set_value name="global.$GT_TradeLogging.$LifetimeProfit" exact="table[]"/>
        </do_if>
        
        <!-- Only log if enabled -->
        <do_if value="global.$GT_TradeLogging.$Enabled">
          
          <!-- Write completion entry -->
          <write_to_logbook 
            category="upkeep" 
            title="'GalaxyTrader MK3: ' + $ship.knownname + ' (' + $ship.idcode + ')'" 
            interaction="showonmap" 
            object="$ship" 
            bonus="$totalProfit" 
            text="{77000,3104}.[$amount,$ware,$totalProfit/100]"/>
          
          <debug_text text="'[GalaxyTrader MK3] Trade completion logged for ' + $ship.knownname + ': ' + ($totalProfit/100) + ' Cr total profit'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Cached Trade Route Logbook Entry -->
    <cue name="LogCachedTrade" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_TradeLogging_LogCachedTrade'"/>
      </conditions>
      <actions>
        <!-- Extract cached trade data -->
        <set_value name="$ship" exact="event.param2.$Ship"/>
        <set_value name="$trade" exact="event.param2.$Trade"/>
        
        <!-- Initialize logging system if not already done -->
        <do_if value="not global.$GT_TradeLogging?">
          <set_value name="global.$GT_TradeLogging" exact="table[]"/>
          <set_value name="global.$GT_TradeLogging.$Enabled" exact="true"/>
          <set_value name="global.$GT_TradeLogging.$TrainingMessages" exact="true"/>
          <set_value name="global.$GT_TradeLogging.$LifetimeProfit" exact="table[]"/>
        </do_if>
        
        <!-- Only log if enabled -->
        <do_if value="global.$GT_TradeLogging.$Enabled">
          
          <!-- SAFETY: Validate station owners exist before logging (prevents "nil" display) -->
          <set_value name="$buyStationName" exact="'Unknown Station'"/>
          <set_value name="$sellStationName" exact="'Unknown Station'"/>
          
          <do_if value="$trade.$BuyOffer? and $trade.$BuyOffer.owner? and $trade.$BuyOffer.owner.exists">
            <set_value name="$buyStationName" exact="$trade.$BuyOffer.owner.knownname"/>
          </do_if>
          
          <do_if value="$trade.$SellOffer? and $trade.$SellOffer.owner? and $trade.$SellOffer.owner.exists">
            <set_value name="$sellStationName" exact="$trade.$SellOffer.owner.knownname"/>
          </do_if>
          
          <!-- Write cached trade entry with safe station names -->
          <write_to_logbook 
            category="upkeep" 
            title="'GalaxyTrader MK3: ' + $ship.knownname + ' (' + $ship.idcode + ')'" 
            interaction="showonmap" 
            object="$ship" 
            bonus="$trade.$Profit" 
            text="{77000,3105}.[$trade.$Amount,$trade.$BuyOffer.ware,$buyStationName,$sellStationName,$trade.$Profit/100]"/>
          
          <debug_text text="'[GalaxyTrader MK3] Cached trade logged for ' + $ship.knownname + ': ' + ($trade.$Profit/100) + ' Cr profit'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Training Started Message (Immersive) -->
    <cue name="LogTrainingStarted" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_TradeLogging_LogTrainingStarted'"/>
      </conditions>
      <actions>
        <debug_text text="'[GT-TradeLogging] LogTrainingStarted cue triggered'" chance="100"/>
        
        <!-- Extract training data -->
        <set_value name="$ship" exact="event.param2.$Ship"/>
        <set_value name="$pilot" exact="event.param2.$Pilot"/>
        <set_value name="$station" exact="event.param2.$Station"/>
        <set_value name="$trainingLevel" exact="event.param2.$TrainingLevel"/>
        <set_value name="$duration" exact="event.param2.$Duration"/>
        
        <debug_text text="'[GT-TradeLogging] Training data extracted - Ship: ' + $ship.knownname + ', Pilot: ' + $pilot.name + ', Station: ' + $station.knownname + ', Level: ' + $trainingLevel" chance="100"/>
        
        <!-- Initialize logging system if not already done -->
        <do_if value="not global.$GT_TradeLogging?">
          <set_value name="global.$GT_TradeLogging" exact="table[]"/>
          <set_value name="global.$GT_TradeLogging.$Enabled" exact="true"/>
          <set_value name="global.$GT_TradeLogging.$TrainingMessages" exact="true"/>
          <set_value name="global.$GT_TradeLogging.$LifetimeProfit" exact="table[]"/>
          <debug_text text="'[GT-TradeLogging] Training logging system auto-initialized'" chance="100"/>
        </do_if>
        
        <debug_text text="'[GT-TradeLogging] Training messages enabled: ' + global.$GT_TradeLogging.$TrainingMessages" chance="100"/>
        
        <!-- Only log if enabled -->
        <do_if value="global.$GT_TradeLogging.$TrainingMessages">
          <debug_text text="'[GT-TradeLogging] Training message will be created and sent to logbook'" chance="100"/>
          
          <!-- Get pilot title for the level -->
          <set_value name="$pilotTitle" exact="'Advanced Trader'"/>
          <do_if value="global.$GT_Config.$XP.$TraderTitles.{$trainingLevel}?">
            <set_value name="$pilotTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$trainingLevel}"/>
          </do_if>
          
          <!-- Calculate duration in minutes -->
          <set_value name="$durationMinutes" exact="($duration / 60)i"/>
          
          <!-- Build immersive training message -->
          <set_value name="$message" exact="{77000,3200}.[player.name,$pilotTitle,$durationMinutes,$station.knownname,$pilot.name,$ship.knownname]"/>
          
          <debug_text text="'[GT-TradeLogging] Training message built: ' + $message" chance="100"/>
          
          <!-- Write to ship logbook -->
          <write_to_logbook 
            category="upkeep" 
            title="'Training Notice: ' + $pilot.name + ' (' + $ship.knownname + ')'" 
            interaction="showonmap" 
            object="$ship" 
            text="$message"/>
          
          <debug_text text="'[GT-TradeLogging] ✅ Training started logbook entry created for ' + $pilot.name + ' on ' + $ship.knownname" chance="100"/>
        </do_if>
        <do_else>
          <debug_text text="'[GT-TradeLogging] ❌ Training messages are DISABLED - no logbook entry will be created'" chance="100"/>
        </do_else>
      </actions>
    </cue>
    
    <!-- Training En Route Message -->
    <cue name="LogTrainingEnRoute" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_TradeLogging_LogTrainingEnRoute'"/>
      </conditions>
      <actions>
        <!-- Extract training data -->
        <set_value name="$ship" exact="event.param2.$Ship"/>
        <set_value name="$pilot" exact="event.param2.$Pilot"/>
        <set_value name="$station" exact="event.param2.$Station"/>
        <set_value name="$arrivalTime" exact="event.param2.$ArrivalTime"/>
        <set_value name="$duration" exact="event.param2.$Duration"/>
        
        <!-- Only log if enabled -->
        <do_if value="global.$GT_TradeLogging.$TrainingMessages">
          
          <!-- Calculate times in minutes -->
          <set_value name="$arrivalMinutes" exact="($arrivalTime / 60)i"/>
          <set_value name="$durationMinutes" exact="($duration / 60)i"/>
          
          <!-- Build en route message -->
          <set_value name="$message" exact="{77000,3203}.[player.name,$station.knownname,$arrivalMinutes,$durationMinutes,$pilot.name,$ship.knownname]"/>
          
          <!-- Write to ship logbook -->
          <write_to_logbook 
            category="upkeep" 
            title="'Training Update: ' + $pilot.name + ' (' + $ship.knownname + ')'" 
            interaction="showonmap" 
            object="$ship" 
            text="$message"/>
          
          <debug_text text="'[GalaxyTrader MK3] Training en route message logged for ' + $pilot.name + ' on ' + $ship.knownname" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Training Completed Message (Success) -->
    <cue name="LogTrainingCompleted" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_TradeLogging_LogTrainingCompleted'"/>
      </conditions>
      <actions>
        <debug_text text="'[GT-TradeLogging] LogTrainingCompleted cue triggered'" chance="100"/>
        
        <!-- Extract completion data -->
        <set_value name="$ship" exact="event.param2.$Ship"/>
        <set_value name="$pilot" exact="event.param2.$Pilot"/>
        <set_value name="$newLevel" exact="event.param2.$Level"/>
        
        <debug_text text="'[GT-TradeLogging] Training completion data - Ship: ' + $ship.knownname + ', Pilot: ' + $pilot.name + ', New Level: ' + $newLevel" chance="100"/>
        
        <!-- Only log if enabled -->
        <do_if value="global.$GT_TradeLogging.$TrainingMessages">
          
          <!-- Get pilot's actual current skill level from their XP -->
          <set_value name="$currentXP" exact="@global.$GT_Pilots.{$pilot}.$XP"/>
          <set_value name="$actualSkillLevel" exact="1"/>
          <do_all exact="15" counter="$skillLevel">
            <do_if value="$currentXP ge global.$GT_Config.$XP.$SkillThresholds.{$skillLevel}">
              <set_value name="$actualSkillLevel" exact="$skillLevel"/>
            </do_if>
          </do_all>
          
          <!-- Map skill level to unified title index: floor(level/3)+1 -->
          <set_value name="$titleIndex" exact="($actualSkillLevel / 3)i + 1"/>
          <do_if value="$titleIndex lt 1">
            <set_value name="$titleIndex" exact="1"/>
          </do_if>
          <do_if value="$titleIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
            <set_value name="$titleIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
          </do_if>
          
          <!-- Get pilot title for the correct index -->
          <set_value name="$pilotTitle" exact="'Advanced Trader'"/>
          <do_if value="global.$GT_Config.$XP.$TraderTitles.{$titleIndex}?">
            <set_value name="$pilotTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$titleIndex}"/>
          </do_if>
          
          <debug_text text="'[GT-TradeLogging] Training completion: Skill Level ' + $actualSkillLevel + ' → Title Index ' + $titleIndex + ' → Title: ' + $pilotTitle" chance="100"/>
          
          <!-- Build success message -->
          <set_value name="$message" exact="{77000,3201}.[player.name,$pilotTitle,$pilot.name,$ship.knownname]"/>
          
          <!-- Write to ship logbook with bonus indicator -->
          <write_to_logbook 
            category="upkeep" 
            title="'Training Success: ' + $pilot.name + ' (' + $ship.knownname + ')'" 
            interaction="showonmap" 
            object="$ship" 
            text="$message" 
            highlighted="true"/>
          
          <debug_text text="'[GalaxyTrader MK3] Training completed message logged for ' + $pilot.name + ' on ' + $ship.knownname" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Training Interrupted Message -->
    <cue name="LogTrainingInterrupted" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_TradeLogging_LogTrainingInterrupted'"/>
      </conditions>
      <actions>
        <!-- Extract interruption data -->
        <set_value name="$ship" exact="event.param2.$Ship"/>
        <set_value name="$pilot" exact="event.param2.$Pilot"/>
        <set_value name="$reason" exact="event.param2.$Reason"/>
        
        <!-- Only log if enabled -->
        <do_if value="global.$GT_TradeLogging.$TrainingMessages">
          
          <!-- Build interruption message -->
          <set_value name="$message" exact="{77000,3202}.[player.name,$pilot.name,$ship.knownname]"/>
          
          <!-- Write to ship logbook -->
          <write_to_logbook 
            category="alerts" 
            title="'Training Interrupted: ' + $pilot.name + ' (' + $ship.knownname + ')'" 
            interaction="showonmap" 
            object="$ship" 
            text="$message"/>
          
          <debug_text text="'[GalaxyTrader MK3] Training interrupted message logged for ' + $pilot.name + ' on ' + $ship.knownname" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Auto-Repair Initiated Logbook Entry -->
    <cue name="LogAutoRepair" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_AutoRepair_Log'"/>
      </conditions>
      <actions>
        <!-- Extract repair data -->
        <set_value name="$ship" exact="event.param2.$Ship"/>
        <set_value name="$station" exact="event.param2.$Station"/>
        <set_value name="$hullBefore" exact="event.param2.$HullBefore"/>
        <set_value name="$pilotLevel" exact="event.param2.$PilotLevel"/>
        
        <debug_text text="'[GT-AutoRepair] Logging repair initiation for ' + $ship.knownname + ' at ' + $station.knownname" chance="100"/>
        
        <!-- Build repair message -->
        <set_value name="$message" exact="'=== AUTO-REPAIR INITIATED ===\n\n'"/>
        <set_value name="$message" exact="$message + 'Ship: ' + $ship.knownname + ' (' + $ship.idcode + ')\n'"/>
        <set_value name="$message" exact="$message + 'Pilot: ' + $ship.pilot.name + ' (Level ' + $pilotLevel + ')\n'"/>
        <set_value name="$message" exact="$message + 'Hull Damage Detected: ' + $hullBefore + '%\n'"/>
        <set_value name="$message" exact="$message + 'Repair Station: ' + $station.knownname + '\n'"/>
        <!-- Determine station type -->
        <set_value name="$stationType" exact="'Unknown'"/>
        <do_if value="$station.isshipyard">
          <set_value name="$stationType" exact="'Shipyard (Schiffswerft)'"/>
        </do_if>
        <do_elseif value="$station.iswharf">
          <set_value name="$stationType" exact="'Wharf (Raumdock)'"/>
        </do_elseif>
        <do_elseif value="$station.isequipmentdock">
          <set_value name="$stationType" exact="'Equipment Dock (Ausrüstungsdock)'"/>
        </do_elseif>
        <set_value name="$message" exact="$message + 'Station Type: ' + $stationType + '\n'"/>
        <set_value name="$message" exact="$message + 'Location: ' + $station.sector.knownname + '\n\n'"/>
        <set_value name="$message" exact="$message + 'The ship has been automatically sent for repairs.\n'"/>
        <set_value name="$message" exact="$message + 'Trading will resume after repairs are completed.'"/>
        
        <!-- Write to player logbook (not ship logbook) -->
        <write_to_logbook 
          category="general" 
          title="'GalaxyTrader MK3: Auto-Repair (' + $ship.knownname + ')'" 
          text="$message" 
          interaction="showonmap" 
          object="player.entity"/>
        
        <debug_text text="'[GalaxyTrader MK3] Auto-repair log entry created for ' + $ship.knownname" chance="100"/>
      </actions>
    </cue>
    
    <!-- Toggle Trade Logging -->
    <cue name="ToggleTradeLogging" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_TradeLogging_ToggleTradeLogging'"/>
      </conditions>
      <actions>
        <set_value name="global.$GT_TradeLogging.$Enabled" exact="not global.$GT_TradeLogging.$Enabled"/>
        <debug_text text="'[GalaxyTrader MK3] Trade logging ' + if global.$GT_TradeLogging.$Enabled then 'enabled' else 'disabled'" chance="100"/>
      </actions>
    </cue>
    
    <!-- Toggle Training Messages -->
    <cue name="ToggleTrainingMessages" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_TradeLogging_ToggleTrainingMessages'"/>
      </conditions>
      <actions>
        <set_value name="global.$GT_TradeLogging.$TrainingMessages" exact="not global.$GT_TradeLogging.$TrainingMessages"/>
        <debug_text text="'[GalaxyTrader MK3] Training messages ' + if global.$GT_TradeLogging.$TrainingMessages then 'enabled' else 'disabled'" chance="100"/>
      </actions>
    </cue>
    
  </cues>
</mdscript> 