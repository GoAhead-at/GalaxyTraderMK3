<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Reporting" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- Reporting System Initialization -->
    <cue name="SystemInit" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_CoreSystem.SystemInit"/>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3] Reporting system initializing...'" chance="100"/>
        
        <!-- Initialize reporting structures -->
        <set_value name="global.$GT_Reports" exact="table[]"/>
        <set_value name="global.$GT_Reports.$LastFleetReport" exact="0"/>
        <set_value name="global.$GT_Reports.$LastMarketReport" exact="0"/>
        <set_value name="global.$GT_Reports.$LastTrainingReport" exact="0"/>
        <!-- Report intervals now use global settings -->
        
        <debug_text text="'[GalaxyTrader MK3] Reporting system initialized'" chance="100"/>
      </actions>
    </cue>
    
    <!-- Periodic Fleet Report -->
    <!-- Check every 30s to support frequencies as low as 1 minute -->
    <cue name="FleetPerformanceReport" instantiate="true" checkinterval="30s">
      <conditions>
        <!-- Check if ships exist - check existence first, then count -->
        <check_value value="global.$GT_Ships?"/>
        <check_value value="global.$GT_Ships.keys.count gt 0"/>
      </conditions>
      <actions>
        <!-- Initialize reports table properties if missing -->
        <do_if value="not global.$GT_Reports.$LastFleetReport?">
          <set_value name="global.$GT_Reports.$LastFleetReport" exact="0"/>
          <set_value name="global.$GT_Reports.$LastMarketReport" exact="0"/>
          <set_value name="global.$GT_Reports.$LastTrainingReport" exact="0"/>
        </do_if>
        
        <!-- Get comprehensive report frequency from settings (0 = disabled) -->
        <set_value name="$reportFrequencyMinutes" exact="30"/>
        <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Notifications? and global.$GT_GlobalSettings.$Notifications.$ComprehensiveReportFrequency?">
          <set_value name="$reportFrequencyMinutes" exact="global.$GT_GlobalSettings.$Notifications.$ComprehensiveReportFrequency"/>
        </do_if>
        
        <!-- Check if report is due (skip if disabled) -->
        <do_if value="$reportFrequencyMinutes gt 0">
          <set_value name="$timeSinceReport" exact="player.age - global.$GT_Reports.$LastFleetReport"/>
          <set_value name="$reportIntervalSeconds" exact="$reportFrequencyMinutes * 60"/>
          
          <do_if value="$timeSinceReport ge $reportIntervalSeconds">
          
          <!-- Generate comprehensive fleet report -->
          <set_value name="$report" exact="'=== GALAXYTRADER MK3 FLEET PERFORMANCE REPORT ===\n\n'"/>
          
          <!-- Report timestamp -->
          <set_value name="$sessionTime" exact="player.age - global.$GT_SessionStats.$StartTime"/>
          <set_value name="$hours" exact="($sessionTime / 3600)i"/>
          <set_value name="$minutes" exact="(($sessionTime - ($hours * 3600)) / 60)i"/>
          <set_value name="$report" exact="$report + 'Session Duration: ' + $hours + ' hours, ' + $minutes + ' minutes\n'"/>
          <set_value name="$report" exact="$report + 'Report Generated: ' + player.age + '\n\n'"/>
          
          <!-- Fleet Overview -->
          <set_value name="$report" exact="$report + '=== FLEET OVERVIEW ===\n'"/>
          <set_value name="$activeShips" exact="0"/>
          <set_value name="$totalFleetProfit" exact="0"/>
          <set_value name="$totalFleetTrades" exact="0"/>
          
          <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
            <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
            <do_all exact="$shipKeys.count" counter="$i">
              <set_value name="$ship" exact="$shipKeys.{$i}"/>
              <do_if value="$ship.exists and $ship.isoperational">
                <set_value name="$activeShips" exact="$activeShips + 1"/>
                <do_if value="global.$GT_Ships.{$ship}.$TotalProfit?">
                  <set_value name="$totalFleetProfit" exact="$totalFleetProfit + global.$GT_Ships.{$ship}.$TotalProfit"/>
                </do_if>
                <do_if value="global.$GT_Ships.{$ship}.$TradesCompleted?">
                  <set_value name="$totalFleetTrades" exact="$totalFleetTrades + global.$GT_Ships.{$ship}.$TradesCompleted"/>
                </do_if>
              </do_if>
            </do_all>
          </do_if>
          
          <set_value name="$report" exact="$report + 'Active Ships: ' + $activeShips + '\n'"/>
          <!-- Format total fleet profit -->
          <run_actions ref="md.GT_Libraries_General.GT_FormatNumber" result="$formattedTotalProfit">
            <param name="number" value="$totalFleetProfit / 100"/>
            <param name="suffix" value="' Cr'"/>
          </run_actions>
          <set_value name="$report" exact="$report + 'Total Fleet Profit: ' + $formattedTotalProfit + '\n'"/>
          <set_value name="$report" exact="$report + 'Total Trades Completed: ' + $totalFleetTrades + '\n'"/>
          
          <do_if value="$totalFleetTrades gt 0">
            <set_value name="$avgProfitPerTrade" exact="$totalFleetProfit / $totalFleetTrades"/>
            <!-- Format average profit per trade -->
            <run_actions ref="md.GT_Libraries_General.GT_FormatNumber" result="$formattedAvgProfit">
              <param name="number" value="$avgProfitPerTrade / 100"/>
              <param name="suffix" value="' Cr'"/>
            </run_actions>
            <set_value name="$report" exact="$report + 'Average Profit per Trade: ' + $formattedAvgProfit + '\n'"/>
          </do_if>
          
          <!-- Individual Ship Performance (Top Performers Only) -->
          <set_value name="$report" exact="$report + '\n=== INDIVIDUAL SHIP PERFORMANCE (TOP 15) ===\n'"/>
          
          <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
            <!-- Build list of ships with their profit for sorting -->
            <set_value name="$shipProfitList" exact="[]"/>
            <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
            
            <do_all exact="$shipKeys.count" counter="$i">
              <set_value name="$ship" exact="$shipKeys.{$i}"/>
              <do_if value="$ship.exists and $ship.isoperational">
                <set_value name="$shipProfit" exact="0"/>
                <do_if value="global.$GT_Ships.{$ship}.$TotalProfit?">
                  <set_value name="$shipProfit" exact="global.$GT_Ships.{$ship}.$TotalProfit"/>
                </do_if>
                <append_to_list name="$shipProfitList" exact="table[$Ship=$ship, $Profit=$shipProfit]"/>
              </do_if>
            </do_all>
            
            <!-- Sort ships by profit (bubble sort - simple for small lists) -->
            <do_if value="$shipProfitList.count gt 1">
              <do_all exact="$shipProfitList.count - 1" counter="$i">
                <do_all exact="$shipProfitList.count - $i" counter="$j">
                  <do_if value="$shipProfitList.{$j}.$Profit lt $shipProfitList.{$j+1}.$Profit">
                    <!-- Swap -->
                    <set_value name="$temp" exact="$shipProfitList.{$j}"/>
                    <set_value name="$shipProfitList.{$j}" exact="$shipProfitList.{$j+1}"/>
                    <set_value name="$shipProfitList.{$j+1}" exact="$temp"/>
                  </do_if>
                </do_all>
              </do_all>
            </do_if>
            
            <!-- Display top 5 ships (X4 logbook message limit: ~20-30 lines) -->
            <set_value name="$displayCount" exact="[$shipProfitList.count, 5].min"/>
            <set_value name="$report" exact="$report + 'Showing top ' + $displayCount + ' of ' + $shipProfitList.count + ' active ships\n'"/>
            
            <do_all exact="$displayCount" counter="$i">
              <set_value name="$ship" exact="$shipProfitList.{$i}.$Ship"/>
              <set_value name="$shipData" exact="global.$GT_Ships.{$ship}"/>
              
              <!-- Compact format: Ship name, profit, trades, status on one line -->
              <!-- Format ship profit -->
              <set_value name="$shipProfitValue" exact="0"/>
              <do_if value="$shipData.$TotalProfit?">
                <set_value name="$shipProfitValue" exact="$shipData.$TotalProfit / 100"/>
              </do_if>
              <run_actions ref="md.GT_Libraries_General.GT_FormatNumber" result="$profitStr">
                <param name="number" value="$shipProfitValue"/>
                <param name="suffix" value="' Cr'"/>
              </run_actions>
              
              <set_value name="$tradesStr" exact="'0'"/>
              <do_if value="$shipData.$TradesCompleted?">
                <set_value name="$tradesStr" exact="$shipData.$TradesCompleted + ''"/>
              </do_if>
              
              <!-- Status: ACTIVE, TRAINING, or BLOCKED -->
              <set_value name="$status" exact="'ACTIVE'"/>
              <do_if value="global.$GT_Ships.{$ship}.$TrainingStarted?">
                <set_value name="$status" exact="'TRAINING'"/>
              </do_if>
              <do_elseif value="global.$GT_Ships.{$ship}.$XPBlocked?">
                <set_value name="$status" exact="'BLOCKED'"/>
              </do_elseif>
              
              <!-- Compact line: #1 ShipName: 1.2M Cr, 45 trades [ACTIVE] -->
              <set_value name="$report" exact="$report + '#' + $i + ' ' + $ship.idcode + ': ' + $profitStr + ', ' + $tradesStr + ' trades [' + $status + ']\n'"/>
            </do_all>
            
            <!-- Add note about remaining ships -->
            <do_if value="$shipProfitList.count gt 5">
              <set_value name="$remainingShips" exact="$shipProfitList.count - 5"/>
              <set_value name="$report" exact="$report + '\n+' + $remainingShips + ' more ships not shown\n'"/>
            </do_if>
          </do_if>
          
          <!-- XP Training System Status -->
          <do_if value="global.$GT_Config.$XP.$Enabled">
            <set_value name="$report" exact="$report + '\n=== XP TRAINING SYSTEM STATUS ===\n'"/>
            
            <set_value name="$blockedCount" exact="0"/>
            <set_value name="$trainingCount" exact="0"/>
            
            <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
              <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
              <do_all exact="$shipKeys.count" counter="$i">
                <set_value name="$ship" exact="$shipKeys.{$i}"/>
                <do_if value="global.$GT_Ships.{$ship}.$XPBlocked?">
                  <set_value name="$blockedCount" exact="$blockedCount + 1"/>
                </do_if>
                <do_if value="global.$GT_Ships.{$ship}.$TrainingStarted?">
                  <set_value name="$trainingCount" exact="$trainingCount + 1"/>
                </do_if>
              </do_all>
            </do_if>
            
            <set_value name="$report" exact="$report + 'Ships Blocked (Need Training): ' + $blockedCount + '\n'"/>
            <set_value name="$report" exact="$report + 'Ships Currently Training: ' + $trainingCount + '\n'"/>
            <!-- Build training levels list -->
            <set_value name="$trainingLevels" exact="''"/>
            <do_if value="global.$GT_Config.$Training.$RequiredLevels?">
              <do_all exact="global.$GT_Config.$Training.$RequiredLevels.count" counter="$i">
                <do_if value="$i gt 1">
                  <set_value name="$trainingLevels" exact="$trainingLevels + ', '"/>
                </do_if>
                <set_value name="$trainingLevels" exact="$trainingLevels + global.$GT_Config.$Training.$RequiredLevels.{$i}"/>
              </do_all>
            </do_if>
            <set_value name="$report" exact="$report + 'Training Required Levels: ' + $trainingLevels + '\n'"/>
          </do_if>
          
          <!-- Market Intelligence Summary -->
          <do_if value="global.$GT_Config.$Market.$TrendAnalysis? and global.$GT_MarketOpportunities?">
            <set_value name="$report" exact="$report + '\n=== MARKET INTELLIGENCE SUMMARY ===\n'"/>
            <set_value name="$report" exact="$report + 'Market Opportunities Found: ' + global.$GT_MarketOpportunities.count + '\n'"/>
            
            <do_if value="global.$GT_MarketOpportunities.count gt 0">
              <set_value name="$topOpp" exact="global.$GT_MarketOpportunities.{1}"/>
              <set_value name="$report" exact="$report + 'Best Opportunity: ' + $topOpp.$Type + ' ' + $topOpp.$Ware.name + ' (' + $topOpp.$Score + '% potential)\n'"/>
            </do_if>
          </do_if>
          
          <!-- Fleet Coordination Status -->
          <do_if value="global.$GT_Config.$Fleet.$Enabled? and global.$GT_FleetRoutes?">
            <set_value name="$report" exact="$report + '\n=== FLEET COORDINATION STATUS ===\n'"/>
            <set_value name="$report" exact="$report + 'Active Route Reservations: ' + global.$GT_FleetRoutes.$RouteReservations.keys.count + '\n'"/>
            <set_value name="$report" exact="$report + 'Max Ships per Route: ' + global.$GT_Config.$Fleet.$MaxShipsPerRoute + '\n'"/>
          </do_if>
          
          <!-- Configuration Summary -->
          <set_value name="$report" exact="$report + '\n=== CONFIGURATION SUMMARY ===\n'"/>
          <!-- Format min absolute profit -->
          <run_actions ref="md.GT_Libraries_General.GT_FormatNumber" result="$formattedMinProfit">
            <param name="number" value="global.$GT_Config.$Trading.$MinAbsoluteProfit / 100"/>
            <param name="suffix" value="' Cr'"/>
          </run_actions>
          <set_value name="$report" exact="$report + 'Min Absolute Profit: ' + $formattedMinProfit + '\n'"/>
          <set_value name="$report" exact="$report + 'XP System: ' + if global.$GT_Config.$XP.$Enabled then 'Enabled' else 'Disabled' + '\n'"/>
          <set_value name="$report" exact="$report + 'Fleet Coordination: ' + if global.$GT_Config.$Fleet.$Enabled then 'Enabled' else 'Disabled' + '\n'"/>
          
          <!-- Write to player logbook -->
          <!-- Write logbook entry - don't check global settings (comprehensive reports should always write) -->
          <run_actions ref="md.GT_Libraries_General.WriteLogbookMessage">
            <param name="Message" value="$report"/>
            <param name="Category" value="'general'"/>
            <param name="Title" value="'GalaxyTrader MK3 Fleet Report'"/>
            <param name="Object" value="player.entity"/>
            <param name="CheckGlobalSettings" value="false"/>
          </run_actions>
          
          <!-- Update timestamp -->
          <set_value name="global.$GT_Reports.$LastFleetReport" exact="player.age"/>
          
          <!-- Debug: Log report content to game log for debugging -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Fleet performance report generated:\n' + $report" chance="100"/>
          </do_if>
          <do_else>
            <debug_text text="'[GalaxyTrader MK3] Comprehensive fleet report generated and written to logbook'" chance="100"/>
          </do_else>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Trade Analytics Report -->
    <cue name="TradeAnalyticsReport" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$report" exact="'=== GALAXYTRADER MK3 TRADE ANALYTICS ===\n\n'"/>
        
        <!-- Trade Volume Analysis -->
        <set_value name="$report" exact="$report + '=== TRADE VOLUME ANALYSIS ===\n'"/>
        
        <!-- Collect trade data by ware -->
        <set_value name="$wareStats" exact="table[]"/>
        
        <!-- This would normally aggregate trade data - simplified for now -->
        <set_value name="$report" exact="$report + 'Total Unique Trade Routes: ' + global.$GT_FleetRoutes.$RouteReservations.keys.count + '\n'"/>
        <set_value name="$report" exact="$report + 'Active Trading Ships: ' + global.$GT_TradingQueue.$Ships.count + '\n'"/>
        
        <!-- Profitability Analysis -->
        <set_value name="$report" exact="$report + '\n=== PROFITABILITY ANALYSIS ===\n'"/>
        
        <set_value name="$mostProfitableShip" exact="null"/>
        <set_value name="$highestProfit" exact="0"/>
        
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
          <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
          <do_all exact="$shipKeys.count" counter="$i">
            <set_value name="$ship" exact="$shipKeys.{$i}"/>
            <do_if value="global.$GT_Ships.{$ship}.$TotalProfit gt $highestProfit">
              <set_value name="$highestProfit" exact="global.$GT_Ships.{$ship}.$TotalProfit"/>
              <set_value name="$mostProfitableShip" exact="$ship"/>
            </do_if>
          </do_all>
        </do_if>
        
        <do_if value="$mostProfitableShip">
          <!-- Format highest profit -->
          <run_actions ref="md.GT_Libraries_General.GT_FormatNumber" result="$formattedHighestProfit">
            <param name="number" value="$highestProfit / 100"/>
            <param name="suffix" value="' Cr'"/>
          </run_actions>
          <set_value name="$report" exact="$report + 'Most Profitable Ship: ' + $mostProfitableShip.knownname + ' (' + $formattedHighestProfit + ')\n'"/>
        </do_if>
        
        <!-- Return report -->
        <set_value name="global.$GT_TradeAnalyticsReport" exact="$report"/>
      </actions>
    </cue>
    
    <!-- Training Progress Report -->
    <cue name="TrainingProgressReport" instantiate="true" checkinterval="600s">
      <conditions>
        <check_value value="@global.$GT_Config.$XP.$Enabled"/>
      </conditions>
      <actions>
        <!-- Check for ships in training -->
        <set_value name="$shipsInTraining" exact="[]"/>
        
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
          <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
          <do_all exact="$shipKeys.count" counter="$i">
            <set_value name="$ship" exact="$shipKeys.{$i}"/>
            <do_if value="global.$GT_Ships.{$ship}.$TrainingStarted?">
              <append_to_list name="$shipsInTraining" exact="$ship"/>
            </do_if>
          </do_all>
        </do_if>
        
        <!-- Generate report if ships are training -->
        <do_if value="$shipsInTraining.count gt 0">
          <set_value name="$report" exact="'=== TRAINING PROGRESS UPDATE ===\n\n'"/>
          <set_value name="$report" exact="$report + 'Ships in training: ' + $shipsInTraining.count + '\n\n'"/>
          
          <!-- Show max 5 ships (X4 logbook line limit) -->
          <set_value name="$displayCount" exact="[$shipsInTraining.count, 5].min"/>
          
          <do_all exact="$displayCount" counter="$i">
            <set_value name="$ship" exact="$shipsInTraining.{$i}"/>
            <set_value name="$trainingData" exact="global.$GT_Ships.{$ship}"/>
            
            <set_value name="$elapsed" exact="player.age - $trainingData.$TrainingStarted"/>
            <set_value name="$remaining" exact="[$trainingData.$TrainingDuration - $elapsed, 0s].max"/>
            <set_value name="$progress" exact="($elapsed * 100) / $trainingData.$TrainingDuration"/>
            
            <!-- Compact format: Ship: 45% done, 12 min left -->
            <set_value name="$report" exact="$report + $ship.idcode + ': ' + $progress + '% done, ' + ($remaining / 60)i + ' min left\n'"/>
          </do_all>
          
          <!-- Show remaining count -->
          <do_if value="$shipsInTraining.count gt 5">
            <set_value name="$report" exact="$report + '\n+' + ($shipsInTraining.count - 5) + ' more ships not shown\n'"/>
          </do_if>
          
          <!-- Write to player logbook -->
          <run_actions ref="md.GT_Libraries_General.WriteLogbookMessage">
            <param name="Message" value="$report"/>
            <param name="Category" value="'upkeep'"/>
            <param name="Title" value="'GalaxyTrader MK3 Training Progress'"/>
            <param name="Object" value="player.entity"/>
          </run_actions>
          
          <debug_text text="'[GalaxyTrader MK3] Training progress report generated'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- On-Demand Report Generation -->
    <cue name="GenerateOnDemandReport" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$reportType" exact="event.param"/>
        
        <do_if value="$reportType == 'fleet'">
          <signal_cue cue="FleetPerformanceReport"/>
        </do_if>
        <do_elseif value="$reportType == 'market'">
          <signal_cue cue="md.GT_MarketIntelligence.GenerateMarketReport"/>
        </do_elseif>
        <do_elseif value="$reportType == 'territory'">
          <signal_cue cue="md.GT_TerritoryManagement.GenerateTerritoryReport"/>
        </do_elseif>
        <do_elseif value="$reportType == 'trade'">
          <signal_cue cue="TradeAnalyticsReport"/>
        </do_elseif>
        
        <debug_text text="'[GalaxyTrader MK3] On-demand ' + $reportType + ' report requested'" chance="100"/>
      </actions>
    </cue>
    
    <!-- Periodic Notification Report (Simple Popup) -->
    <!-- Triggered from SystemMaintenance every 60s when ProfitReports enabled -->
    <cue name="GeneratePeriodicReport" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <!-- Use @ operator to safely access keys.count -->
        <set_value name="$shipsKeysCount" exact="@global.$GT_Ships.keys.count"/>
        <do_if value="$shipsKeysCount? and $shipsKeysCount gt 0">
          <set_value name="$totalProfit" exact="0Cr"/>
          <set_value name="$totalTrades" exact="0"/>
          
          <!-- Calculate totals -->
          <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
          <do_all exact="$shipKeys.count" counter="$i">
            <set_value name="$ship" exact="$shipKeys.{$i}"/>
            <set_value name="$shipData" exact="global.$GT_Ships.{$ship}"/>
            <do_if value="$shipData.$TotalProfit?">
              <set_value name="$totalProfit" exact="$totalProfit + $shipData.$TotalProfit"/>
            </do_if>
            <do_if value="$shipData.$TradesCompleted?">
              <set_value name="$totalTrades" exact="$totalTrades + $shipData.$TradesCompleted"/>
            </do_if>
          </do_all>
          
          <!-- Generate report message -->
          <set_value name="$message" exact="'GalaxyTrader MK3 Fleet Report:\n'"/>
          <set_value name="$message" exact="$message + 'Active Ships: ' + global.$GT_Ships.keys.count + '\n'"/>
          <!-- Format total profit with thousand separators and M suffix -->
          <run_actions ref="md.GT_Libraries_General.GT_FormatNumber" result="$formattedTotalProfit">
            <param name="number" value="$totalProfit / 100"/>
            <param name="suffix" value="' Cr'"/>
          </run_actions>
          <set_value name="$message" exact="$message + 'Total Profit: ' + $formattedTotalProfit + '\n'"/>
          <set_value name="$message" exact="$message + 'Trades Completed: ' + $totalTrades"/>
          
          <!-- Show notification -->
          <show_notification text="$message" timeout="10s"/>
          
          <!-- Debug: Log report to game log -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Periodic fleet report:\n' + $message" chance="100"/>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Error Report Generator -->
    <cue name="GenerateErrorReport" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$errorType" exact="event.param.type"/>
        <set_value name="$errorData" exact="event.param.data"/>
        
        <set_value name="$report" exact="'GALAXYTRADER MK3 ERROR REPORT\n\n'"/>
        <set_value name="$report" exact="$report + 'Error Type: ' + $errorType + '\n'"/>
        <set_value name="$report" exact="$report + 'Timestamp: ' + player.age + '\n\n'"/>
        
        <do_if value="$errorType == 'ship_stuck'">
          <set_value name="$report" exact="$report + 'Ship: ' + $errorData.$Ship.knownname + '\n'"/>
          <set_value name="$report" exact="$report + 'Location: ' + $errorData.$Ship.sector.knownname + '\n'"/>
          <set_value name="$report" exact="$report + 'Last Order: ' + $errorData.$LastOrder + '\n'"/>
          <set_value name="$report" exact="$report + '\nRecommended Action: Check ship status and manually intervene if necessary.\n'"/>
        </do_if>
        <do_elseif value="$errorType == 'trade_failed'">
          <set_value name="$report" exact="$report + 'Ship: ' + $errorData.$Ship.knownname + '\n'"/>
          <set_value name="$report" exact="$report + 'Trade Route: ' + $errorData.$Route + '\n'"/>
          <set_value name="$report" exact="$report + 'Reason: ' + $errorData.$Reason + '\n'"/>
        </do_elseif>
        
        <!-- Write to logbook with high priority -->
        <run_actions ref="md.GT_Libraries_General.WriteLogbookMessage">
          <param name="Message" value="$report"/>
          <param name="Category" value="'alerts'"/>
          <param name="Title" value="'GalaxyTrader MK3 Error'"/>
          <param name="Object" value="$errorData.$Ship"/>
          <param name="Interaction" value="'showonmap'"/>
        </run_actions>
        
        <debug_text text="'[GalaxyTrader MK3] Error report generated: ' + $errorType" chance="100"/>
      </actions>
    </cue>
    
    <!-- Summary Dashboard -->
    <cue name="GenerateDashboard" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$dashboard" exact="'==========================================\n'"/>
        <set_value name="$dashboard" exact="$dashboard + '     GALAXYTRADER MK3 DASHBOARD\n'"/>
        <set_value name="$dashboard" exact="$dashboard + '==========================================\n\n'"/>
        
        <!-- Quick Stats -->
        <set_value name="$activeShips" exact="0"/>
        <set_value name="$totalProfit" exact="0"/>
        <set_value name="$shipsTraining" exact="0"/>
        <set_value name="$shipsBlocked" exact="0"/>
        
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
          <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
          <do_all exact="$shipKeys.count" counter="$i">
            <set_value name="$ship" exact="$shipKeys.{$i}"/>
            <do_if value="$ship.exists and $ship.isoperational">
              <set_value name="$activeShips" exact="$activeShips + 1"/>
              <set_value name="$totalProfit" exact="$totalProfit + global.$GT_Ships.{$ship}.$TotalProfit"/>
              
              <do_if value="global.$GT_Ships.{$ship}.$TrainingStarted?">
                <set_value name="$shipsTraining" exact="$shipsTraining + 1"/>
              </do_if>
              <do_if value="global.$GT_Ships.{$ship}.$XPBlocked?">
                <set_value name="$shipsBlocked" exact="$shipsBlocked + 1"/>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
        
        <set_value name="$dashboard" exact="$dashboard + 'Quick Stats:\n'"/>
        <set_value name="$dashboard" exact="$dashboard + '  - Active Ships: ' + $activeShips + '\n'"/>
        <!-- Format total profit for dashboard -->
        <run_actions ref="md.GT_Libraries_General.GT_FormatNumber" result="$formattedDashboardProfit">
          <param name="number" value="$totalProfit / 100"/>
          <param name="suffix" value="' Cr'"/>
        </run_actions>
        <set_value name="$dashboard" exact="$dashboard + '  - Total Profit: ' + $formattedDashboardProfit + '\n'"/>
        <set_value name="$dashboard" exact="$dashboard + '  - Ships Training: ' + $shipsTraining + '\n'"/>
        <set_value name="$dashboard" exact="$dashboard + '  - Ships Blocked: ' + $shipsBlocked + '\n\n'"/>
        
        <!-- System Status -->
        <set_value name="$dashboard" exact="$dashboard + 'System Status:\n'"/>
        <set_value name="$dashboard" exact="$dashboard + '  - XP System: ' + if global.$GT_Config.$XP.$Enabled then 'Enabled' else 'Disabled' + '\n'"/>
        <set_value name="$dashboard" exact="$dashboard + '  - Fleet Coord: ' + if global.$GT_Config.$Fleet.$Enabled then 'Enabled' else 'Disabled' + '\n'"/>
        <set_value name="$dashboard" exact="$dashboard + '  - Market Intel: ' + if global.$GT_Config.$Market.$TrendAnalysis then 'Enabled' else 'Disabled' + '\n'"/>
        <set_value name="$dashboard" exact="$dashboard + '  - Territory Mgmt: ' + if global.$GT_Config.$Fleet.$TerritoryManagement then 'Enabled' else 'Disabled' + '\n'"/>
        
        <!-- Show notification -->
        <show_notification text="$dashboard" timeout="15s" priority="5"/>
        
        <!-- Also write to player logbook for permanent record -->
        <run_actions ref="md.GT_Libraries_General.WriteLogbookMessage">
          <param name="Message" value="$dashboard"/>
          <param name="Category" value="'tips'"/>
          <param name="Title" value="'GalaxyTrader MK3 Dashboard'"/>
          <param name="Object" value="player.entity"/>
        </run_actions>
      </actions>
    </cue>
  </cues>
</mdscript> 
