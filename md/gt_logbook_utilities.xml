<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Logbook_Utilities" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================= -->
    <!-- LOGBOOK UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Is Logbook Enabled -->
    <library name="GT_IsLogbookEnabled" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to check logbook setting for"/>
      </params>
      <actions>
        <set_value name="$logEnabled" exact="false"/>
        <do_if value="@$ship.defaultorder.id == 'GalaxyTraderMK3' and @$ship.defaultorder.$logbookentries">
          <set_value name="$logEnabled" exact="true"/>
        </do_if>
        <do_elseif value="@$ship.defaultorder.id == 'Assist' and @$ship.commander.defaultorder.id == 'GalaxyTraderMK3' and @$ship.commander.defaultorder.$logbookentries">
          <set_value name="$logEnabled" exact="true"/>
        </do_elseif>
        <return value="$logEnabled"/>
      </actions>
    </library>
    
    <!-- Write Logbook Message -->
    <!-- Centralized logbook message creation for MD scripts -->
    <!-- IMPORTANT: X4 TextDB doesn't support list variables, so callers must construct message string first -->
    <!-- Use: {77000,ID}.[param1, param2, ...] to create message, then pass as Message parameter -->
    <library name="WriteLogbookMessage" purpose="run_actions">
      <params>
        <param name="Message" comment="Message string (REQUIRED - construct using {77000,ID}.[params] before calling)"/>
        <param name="Category" comment="Logbook category: alerts, upkeep, news, general, tips"/>
        <param name="Title" comment="Logbook entry title"/>
        <param name="Object" default="null" comment="Object to attach message to (ship, station, etc.)"/>
        <param name="Interaction" default="null" comment="Interaction type: 'showonmap' or null"/>
        <param name="Highlighted" default="false" comment="Whether to highlight message (true/false)"/>
        <param name="Money" default="null" comment="Money amount to display (negative for expenses, positive for income)"/>
        <param name="Bonus" default="null" comment="Bonus amount to display (typically profit)"/>
        <param name="CheckGlobalSettings" default="true" comment="Check global logbook settings before writing (default true)"/>
      </params>
      <actions>
        <!-- ✅ DEBUG MODE: Check if debug logging is enabled (if CheckGlobalSettings is true) -->
        <!-- Logbook messages now only write when debug is enabled -->
        <set_value name="$shouldWrite" exact="true"/>
        <do_if value="$CheckGlobalSettings">
          <set_value name="$shouldWrite" exact="false"/>
          <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Debug? and global.$GT_GlobalSettings.$Debug.$EnableDebugLogging? and global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$shouldWrite" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Write logbook if enabled -->
        <do_if value="$shouldWrite">
          <!-- Message is already constructed by caller using TextDB syntax -->
          <!-- Example: {77000,3218}.[@$newSector.knownname, @$currentDestination.knownname, ...] -->
          <!-- Determine object value -->
          <set_value name="$objectValue" exact="null"/>
          <do_if value="$Object? and $Object != null">
            <set_value name="$objectValue" exact="$Object"/>
          </do_if>
          
          <!-- Check if interaction is 'showonmap' -->
          <set_value name="$hasInteraction" exact="false"/>
          <do_if value="$Interaction? and $Interaction != null and $Interaction == 'showonmap'">
            <set_value name="$hasInteraction" exact="true"/>
          </do_if>
          
          <!-- Write logbook entry with conditional blocks for interaction, category, and money/bonus -->
          <!-- XSD requires literal values for category and interaction attributes -->
          <!-- Structure: interaction (with/without) -> category -> money/bonus -->
          <do_if value="$hasInteraction">
            <!-- WITH interaction="showonmap" -->
            <do_if value="$Category == 'alerts'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="alerts" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="alerts" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="alerts" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="alerts" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_if>
            <do_elseif value="$Category == 'upkeep'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="upkeep" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="upkeep" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="upkeep" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="upkeep" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_elseif value="$Category == 'news'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="news" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="news" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="news" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="news" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_elseif value="$Category == 'general'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_elseif value="$Category == 'tips'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="tips" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="tips" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="tips" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="tips" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_else>
              <!-- Default to 'general' if category not recognized -->
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="general" title="$Title" text="$Message" interaction="showonmap" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_else>
          </do_if>
          <do_else>
            <!-- WITHOUT interaction attribute -->
            <do_if value="$Category == 'alerts'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="alerts" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="alerts" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="alerts" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="alerts" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_if>
            <do_elseif value="$Category == 'upkeep'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="upkeep" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="upkeep" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="upkeep" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="upkeep" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_elseif value="$Category == 'news'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="news" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="news" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="news" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="news" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_elseif value="$Category == 'general'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_elseif value="$Category == 'tips'">
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="tips" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="tips" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="tips" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="tips" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_elseif>
            <do_else>
              <!-- Default to 'general' if category not recognized -->
              <do_if value="$Money? and $Money != null and $Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money" bonus="$Bonus"/>
              </do_if>
              <do_elseif value="$Money? and $Money != null">
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" money="$Money"/>
              </do_elseif>
              <do_elseif value="$Bonus? and $Bonus != null">
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted" bonus="$Bonus"/>
              </do_elseif>
              <do_else>
                <write_to_logbook category="general" title="$Title" text="$Message" object="$objectValue" highlighted="$Highlighted"/>
              </do_else>
            </do_else>
          </do_else>
        </do_if>
      </actions>
    </library>
    
    <!-- Handle Logbook Message from AI Scripts -->
    <!-- AI scripts cannot call MD libraries directly, so they signal this cue -->
    <!-- AI scripts construct messages using TextDB syntax before sending (vanilla pattern) -->
    <cue name="HandleLogbookMessage" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_WriteLogbook'"/>
      </conditions>
      <actions>
        <set_value name="$data" exact="event.param2"/>
        
        <!-- Call library with data from signal -->
        <!-- Message is already constructed by AI script using TextDB syntax -->
        <run_actions ref="md.GT_Libraries_General.WriteLogbookMessage">
          <param name="Message" value="$data.$Message"/>
          <param name="Category" value="$data.$Category"/>
          <param name="Title" value="$data.$Title"/>
          <param name="Object" value="if $data.$Object? then $data.$Object else null"/>
          <param name="Interaction" value="if $data.$Interaction? then $data.$Interaction else null"/>
          <param name="Highlighted" value="if $data.$Highlighted? then $data.$Highlighted else false"/>
          <param name="Money" value="if $data.$Money? then $data.$Money else null"/>
          <param name="Bonus" value="if $data.$Bonus? then $data.$Bonus else null"/>
          <param name="CheckGlobalSettings" value="if $data.$CheckGlobalSettings? then $data.$CheckGlobalSettings else true"/>
        </run_actions>
      </actions>
    </cue>
    
  </cues>
</mdscript>
