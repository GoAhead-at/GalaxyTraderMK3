<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Pilot_Field_Migration" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/x4Original/libraries/md.xsd">
  <cues>
    
    <!-- One-time migration: Add $Pilot field to existing ships -->
    <!-- Runs on both new games and save game loads -->
    <cue name="MigratePilotField" instantiate="true">
      <conditions>
        <check_any>
          <event_game_loaded/>
          <event_player_created/>
        </check_any>
      </conditions>
      <delay exact="1s"/>
      <actions>
        <set_value name="$updatedCount" exact="0"/>
        <set_value name="$skipCount" exact="0"/>
        
        <!-- Check if GT system is initialized -->
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
          <debug_text text="'[GT-PilotMigration] Checking ' + global.$GT_Ships.keys.count + ' ships for missing $Pilot field...'" chance="100"/>
          
          <!-- Iterate through all registered ships -->
          <do_all exact="global.$GT_Ships.keys.count" counter="$i">
            <set_value name="$ship" exact="global.$GT_Ships.keys.{$i}"/>
            <set_value name="$shipData" exact="global.$GT_Ships.{$ship}"/>
            
            <!-- Check if Pilot field is missing but ship has a pilot -->
            <do_if value="not $shipData.$Pilot? and @$ship.pilot">
              <set_value name="global.$GT_Ships.{$ship}.$Pilot" exact="$ship.pilot"/>
              <set_value name="$updatedCount" operation="add"/>
              <debug_text text="'[GT-PilotMigration] Added $Pilot field to: ' + @$ship.knownname + ' (Pilot: ' + @$ship.pilot.name + ')'" chance="100"/>
            </do_if>
            <do_else>
              <set_value name="$skipCount" operation="add"/>
            </do_else>
          </do_all>
          
          <debug_text text="'[GT-PilotMigration] ✅ Complete: ' + $updatedCount + ' ships updated, ' + $skipCount + ' ships skipped (already had pilot or no pilot assigned)'" chance="100"/>
          
          <!-- Signal info menu to refresh if it's initialized -->
          <do_if value="$updatedCount gt 0">
            <debug_text text="'[GT-PilotMigration] Triggering pilot data refresh for UI...'" chance="100"/>
            <signal_cue_instantly cue="md.GT_InfoMenu_Loader.SendPilotData"/>
          </do_if>
        </do_if>
        <do_else>
          <debug_text text="'[GT-PilotMigration] No ships registered yet - skipping migration'" chance="100"/>
        </do_else>
      </actions>
    </cue>
    
    <!-- One-time migration: Ensure all pilots have $TotalProfit field -->
    <cue name="MigratePilotProfit" instantiate="true">
      <conditions>
        <check_any>
          <event_game_loaded/>
          <event_player_created/>
        </check_any>
      </conditions>
      <delay exact="1.5s"/>
      <actions>
        <set_value name="$updatedCount" exact="0"/>
        
        <!-- Check if pilot system is initialized -->
        <do_if value="global.$GT_Pilots? and global.$GT_Pilots.keys.count gt 0">
          <debug_text text="'[GT-PilotMigration] Checking ' + global.$GT_Pilots.keys.count + ' pilots for missing $TotalProfit field...'" chance="100"/>
          
          <!-- Iterate through all registered pilots -->
          <do_all exact="global.$GT_Pilots.keys.count" counter="$i">
            <set_value name="$pilot" exact="global.$GT_Pilots.keys.{$i}"/>
            <set_value name="$pilotData" exact="global.$GT_Pilots.{$pilot}"/>
            
            <!-- Check if TotalProfit field is missing -->
            <do_if value="not $pilotData.$TotalProfit?">
              <set_value name="global.$GT_Pilots.{$pilot}.$TotalProfit" exact="0"/>
              <set_value name="$updatedCount" operation="add"/>
              <debug_text text="'[GT-PilotMigration] Added $TotalProfit field to pilot: ' + @$pilot.name" chance="100"/>
            </do_if>
          </do_all>
          
          <debug_text text="'[GT-PilotMigration] ✅ Pilot profit migration complete: ' + $updatedCount + ' pilots updated'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
  </cues>
</mdscript>
