<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Fleet_Coordination" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- Fleet Management Library - Shared logic for fleet coordination -->
    
    <!-- Register Ship in Fleet -->
    <library name="RegisterShip" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to register"/>
        <param name="preserveData" default="true" comment="Preserve existing ship data"/>
      </params>
      <actions>
        <!-- Initialize fleet registry if needed -->
        <do_if value="not global.$GT_Ships?">
          <set_value name="global.$GT_Ships" exact="table[]"/>
        </do_if>
        
        <!-- Register ship with data preservation -->
        <do_if value="$preserveData and global.$GT_Ships.{$ship}?">
          <!-- Update only essential fields, preserve statistics -->
          <set_value name="global.$GT_Ships.{$ship}.$LastUpdate" exact="player.age"/>
          <do_if value="$ship.pilot?">
            <set_value name="global.$GT_Ships.{$ship}.$Pilot" exact="$ship.pilot"/>
          </do_if>
        </do_if>
        <do_else>
          <!-- New ship registration -->
          <set_value name="global.$GT_Ships.{$ship}" exact="table[
            $Pilot = $ship.pilot,
            $LastUpdate = player.age,
            $TotalProfit = 0,
            $TradesCompleted = 0,
            $ThreatReports = 0,
            $LastThreatTime = 0,
            $RegistrationTime = player.age
          ]"/>
        </do_else>
        
        <set_value name="this.$result" exact="true"/>
      </actions>
    </library>
    
    <!-- Update Ship Statistics -->
    <library name="UpdateShipStats" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to update"/>
        <param name="profit" default="0" comment="Profit to add"/>
        <param name="tradesCompleted" default="0" comment="Trades to add"/>
      </params>
      <actions>
        <!-- Ensure ship is registered -->
        <do_if value="not global.$GT_Ships.{$ship}?">
          <set_value name="global.$GT_Ships.{$ship}" exact="table[
            $Pilot = $ship.pilot,
            $LastUpdate = player.age,
            $TotalProfit = 0,
            $TradesCompleted = 0,
            $ThreatReports = 0,
            $LastThreatTime = 0,
            $RegistrationTime = player.age
          ]"/>
        </do_if>
        
        <!-- Update statistics -->
        <set_value name="global.$GT_Ships.{$ship}.$TotalProfit" exact="global.$GT_Ships.{$ship}.$TotalProfit + $profit"/>
        <set_value name="global.$GT_Ships.{$ship}.$TradesCompleted" exact="global.$GT_Ships.{$ship}.$TradesCompleted + $tradesCompleted"/>
        <set_value name="global.$GT_Ships.{$ship}.$LastUpdate" exact="player.age"/>
        
        <set_value name="this.$result" exact="global.$GT_Ships.{$ship}"/>
      </actions>
    </library>
    
    <!-- Get Fleet Summary -->
    <library name="GetFleetSummary" purpose="run_actions">
      <params>
        <param name="includeInactive" default="false" comment="Include inactive ships"/>
      </params>
      <actions>
        <set_value name="$summary" exact="table[
          $TotalShips = 0,
          $ActiveShips = 0,
          $TotalProfit = 0,
          $TotalTrades = 0,
          $AverageProfit = 0
        ]"/>
        
        <do_if value="global.$GT_Ships?">
          <do_all exact="global.$GT_Ships.keys.count" counter="$i">
            <set_value name="$ship" exact="global.$GT_Ships.keys.{$i}"/>
            <set_value name="$shipData" exact="global.$GT_Ships.{$ship}"/>
            
            <!-- Check if ship is active (updated in last 10 minutes) -->
            <set_value name="$isActive" exact="(player.age - $shipData.$LastUpdate) lt 600s"/>
            
            <do_if value="$includeInactive or $isActive">
              <set_value name="$summary.$TotalShips" exact="$summary.$TotalShips + 1"/>
              <set_value name="$summary.$TotalProfit" exact="$summary.$TotalProfit + $shipData.$TotalProfit"/>
              <set_value name="$summary.$TotalTrades" exact="$summary.$TotalTrades + $shipData.$TradesCompleted"/>
              
              <do_if value="$isActive">
                <set_value name="$summary.$ActiveShips" exact="$summary.$ActiveShips + 1"/>
              </do_if>
            </do_if>
          </do_all>
          
          <!-- Calculate average -->
          <do_if value="$summary.$TotalShips gt 0">
            <set_value name="$summary.$AverageProfit" exact="$summary.$TotalProfit / $summary.$TotalShips"/>
          </do_if>
        </do_if>
        
        <set_value name="this.$result" exact="$summary"/>
      </actions>
    </library>
    
    <!-- Get Ship Performance Data -->
    <library name="GetShipPerformance" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to analyze"/>
      </params>
      <actions>
        <set_value name="$performance" exact="null"/>
        
        <do_if value="global.$GT_Ships.{$ship}?">
          <set_value name="$shipData" exact="global.$GT_Ships.{$ship}"/>
          <set_value name="$activeTime" exact="player.age - $shipData.$RegistrationTime"/>
          
          <!-- Calculate performance metrics -->
          <set_value name="$profitPerHour" exact="0"/>
          <set_value name="$tradesPerHour" exact="0"/>
          
          <do_if value="$activeTime gt 0">
            <set_value name="$hoursActive" exact="$activeTime / 3600"/>
            <set_value name="$profitPerHour" exact="$shipData.$TotalProfit / $hoursActive"/>
            <set_value name="$tradesPerHour" exact="$shipData.$TradesCompleted / $hoursActive"/>
          </do_if>
          
          <set_value name="$performance" exact="table[
            $Ship = $ship,
            $TotalProfit = $shipData.$TotalProfit,
            $TradesCompleted = $shipData.$TradesCompleted,
            $ProfitPerHour = $profitPerHour,
            $TradesPerHour = $tradesPerHour,
            $ActiveTime = $activeTime,
            $LastUpdate = $shipData.$LastUpdate,
            $IsActive = (player.age - $shipData.$LastUpdate) lt 600s
          ]"/>
        </do_if>
        
        <set_value name="this.$result" exact="$performance"/>
      </actions>
    </library>
    
    <!-- Clean Up Inactive Ships -->
    <library name="CleanupInactiveShips" purpose="run_actions">
      <params>
        <param name="maxAge" default="3600s" comment="Maximum age for inactive ships"/>
      </params>
      <actions>
        <set_value name="$removedShips" exact="0"/>
        
        <do_if value="global.$GT_Ships?">
          <do_all exact="global.$GT_Ships.keys.count" counter="$i" reverse="true">
            <set_value name="$ship" exact="global.$GT_Ships.keys.{$i}"/>
            <set_value name="$shipData" exact="global.$GT_Ships.{$ship}"/>
            
            <!-- Check if ship is too old and no longer exists -->
            <set_value name="$age" exact="player.age - $shipData.$LastUpdate"/>
            <do_if value="$age gt $maxAge and not $ship.exists">
              <remove_value name="global.$GT_Ships.{$ship}"/>
              <set_value name="$removedShips" exact="$removedShips + 1"/>
            </do_if>
          </do_all>
        </do_if>
        
        <set_value name="this.$result" exact="$removedShips"/>
      </actions>
    </library>
    
    <!-- Fleet Cache Statistics -->
    <library name="GetCacheStatistics" purpose="run_actions">
      <actions>
        <set_value name="$stats" exact="table[
          $TotalWares = 0,
          $TotalRoutes = 0,
          $OldestEntry = player.age,
          $NewestEntry = 0,
          $AverageAge = 0
        ]"/>
        
        <do_if value="global.$GT_TradeCache?">
          <!-- Calculate stats from flat list -->
          <set_value name="$stats.$TotalRoutes" exact="global.$GT_TradeCache.count"/>
          <set_value name="$totalAge" exact="0"/>
          <set_value name="$uniqueWares" exact="[]"/>
          
          <!-- Iterate through all cached trades -->
          <do_all exact="global.$GT_TradeCache.count" counter="$i">
            <set_value name="$entry" exact="global.$GT_TradeCache.{$i}"/>
            
            <!-- Track age statistics -->
            <set_value name="$age" exact="player.age - $entry.$Timestamp"/>
            <set_value name="$totalAge" exact="$totalAge + $age"/>
            
            <do_if value="$entry.$Timestamp lt $stats.$OldestEntry">
              <set_value name="$stats.$OldestEntry" exact="$entry.$Timestamp"/>
            </do_if>
            <do_if value="$entry.$Timestamp gt $stats.$NewestEntry">
              <set_value name="$stats.$NewestEntry" exact="$entry.$Timestamp"/>
            </do_if>
            
            <!-- Count unique wares using explicit loop (indexof unreliable for lists) -->
            <do_if value="$entry.$WareId?">
              <set_value name="$wareExists" exact="false"/>
              <do_all exact="$uniqueWares.count" counter="$i">
                <do_if value="$uniqueWares.{$i} == $entry.$WareId">
                  <set_value name="$wareExists" exact="true"/>
                  <break/>
                </do_if>
              </do_all>
              
              <do_if value="not $wareExists">
                <append_to_list name="$uniqueWares" exact="$entry.$WareId"/>
              </do_if>
            </do_if>
          </do_all>
          
          <set_value name="$stats.$TotalWares" exact="$uniqueWares.count"/>
          
          <do_if value="$stats.$TotalRoutes gt 0">
            <set_value name="$stats.$AverageAge" exact="$totalAge / $stats.$TotalRoutes"/>
          </do_if>
        </do_if>
        
        <set_value name="this.$result" exact="$stats"/>
      </actions>
    </library>
  </cues>
</mdscript> 
