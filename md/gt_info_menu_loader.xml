<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_InfoMenu_Loader" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/x4Original/libraries/md.xsd">
  
  <cues>
    <!-- DISABLED: UI Lua files are disabled, so don't try to load them -->
    <!-- Load Lua file via sn_mod_support_apis Lua Loader -->
    <!-- <cue name="Load_PilotDataBridge" instantiate="true">
      <conditions>
        <event_ui_triggered screen="'Lua_Loader'" control="'Ready'" />
      </conditions>
      <actions>
        <raise_lua_event 
          name="'Lua_Loader.Load'" 
          param="'extensions.galaxytradermk3.ui.gt_pilot_data_bridge'"/>
        
        <debug_text text="'[GT Info Menu] Loading pilot data bridge via Lua Loader...'" chance="100"/>
      </actions>
    </cue> -->
    
    <!-- Verify Lua module loaded successfully -->
    <!-- <cue name="Verify_PilotDataBridge" instantiate="true">
      <conditions>
        <event_ui_triggered screen="'Lua_Loader'" 
          control="'Loaded extensions.galaxytradermk3.ui.gt_pilot_data_bridge'" />
      </conditions>
      <actions>
        <debug_text text="'[GT Info Menu] Pilot data bridge loaded successfully!'" chance="100"/>
      </actions>
    </cue> -->
    
    <!-- Send pilot data when UI requests it -->
    <!-- <cue name="HandlePilotDataRequest" instantiate="true">
      <conditions>
        <event_ui_triggered screen="'gt_pilot_data_bridge'" control="'RequestPilotData'" />
      </conditions>
      <actions>
        <debug_text text="'[GT Info Menu] Received request for pilot data from UI'" chance="100"/>
        <signal_cue_instantly cue="SendPilotData" />
      </actions>
    </cue> -->
    
    <!-- Auto-send pilot data when ships are registered -->
    <!-- <cue name="AutoRefreshOnShipRegistration" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Register_Ship'" />
      </conditions>
      <delay exact="100ms"/>
      <actions>
        <debug_text text="'[GT Info Menu] Ship registered - auto-refreshing pilot data'" chance="100"/>
        <signal_cue_instantly cue="SendPilotData" />
      </actions>
    </cue> -->
    
    <!-- Collect and send pilot data to Lua -->
    <cue name="SendPilotData" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$pilotDataString" exact="''"/>
        <set_value name="$pilotCount" exact="0"/>
        
        <!-- SIMPLIFIED: Initialization guarantees global.$GT_Ships and global.$GT_Pilots exist -->
        <!-- FIX: Use @ operator to safely access keys.count -->
        <set_value name="$shipsKeysCount" exact="@global.$GT_Ships.keys.count"/>
        <set_value name="$pilotsKeysCount" exact="@global.$GT_Pilots.keys.count"/>
        <do_if value="not $shipsKeysCount? or not $pilotsKeysCount? or $shipsKeysCount == 0 or $pilotsKeysCount == 0">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT Info Menu] GT systems initialized but no data yet'" chance="100"/>
          </do_if>
          <raise_lua_event name="'GT_PilotData.Update'" param="''"/>
        </do_if>
        <do_else>
          <!-- Collect config flags for conditional UI controls -->
          <set_value name="$autoTraining" exact="1"/>
          <do_if value="global.$GT_Config? and global.$GT_Config.$Training? and global.$GT_Config.$Training.$AutomaticTraining?">
            <set_value name="$autoTraining" exact="global.$GT_Config.$Training.$AutomaticTraining"/>
          </do_if>
          
          <set_value name="$autoRepair" exact="1"/>
          <do_if value="global.$GT_Config? and global.$GT_Config.$Maintenance? and global.$GT_Config.$Maintenance.$AutoRepair?">
            <set_value name="$autoRepair" exact="global.$GT_Config.$Maintenance.$AutoRepair"/>
          </do_if>
          
          <set_value name="$autoResupply" exact="1"/>
          <do_if value="global.$GT_Config? and global.$GT_Config.$Maintenance? and global.$GT_Config.$Maintenance.$AutoResupply?">
            <set_value name="$autoResupply" exact="global.$GT_Config.$Maintenance.$AutoResupply"/>
          </do_if>
          
          <!-- Build config string: "CONFIG:autoTraining|autoRepair|autoResupply" -->
          <set_value name="$configString" exact="'CONFIG:' + $autoTraining + '|' + $autoRepair + '|' + $autoResupply"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT Info Menu] Config flags: AutoTraining=' + $autoTraining + ', AutoRepair=' + $autoRepair + ', AutoResupply=' + $autoResupply" chance="100"/>
            <debug_text text="'[GT Info Menu] Found ' + $shipsKeysCount + ' ships in registry'" chance="100"/>
          </do_if>
          
          <!-- Sort ships by idcode for stable, consistent order -->
          <create_list name="$sortedShips"/>
          <do_all exact="$shipsKeysCount" counter="$i">
            <append_to_list name="$sortedShips" exact="global.$GT_Ships.keys.{$i}"/>
          </do_all>
          <sort_list list="$sortedShips" sortbyvalue="loop.element.idcode"/>
          
          <!-- Iterate through sorted ship list -->
          <do_all exact="$sortedShips.count" counter="$i">
            <set_value name="$ship" exact="$sortedShips.{$i}"/>
            <set_value name="$shipData" exact="global.$GT_Ships.{$ship}"/>
            
            <!-- <debug_text text="'[GT Info Menu] Ship ' + $i + ': ' + @$ship.knownname + ' (operational: ' + $ship.isoperational + ', has pilot entry: ' + $shipData.$Pilot? + ')'" chance="100"/> -->
            
            <do_if value="$ship.isoperational and $shipData.$Pilot?">
              <set_value name="$pilot" exact="$shipData.$Pilot"/>
              
              <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
                <set_value name="$pilotData" exact="global.$GT_Pilots.{$pilot}"/>
                
                <!-- Calculate rank from level -->
                <set_value name="$level" exact="$pilotData.$Level"/>
                <set_value name="$rankIndex" exact="($level / 3)i + 1"/>
                <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                  <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                    <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
                  </do_if>
                  <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                </do_if>
                <do_else>
                  <set_value name="$rankTitle" exact="'Lehrling'"/>
                </do_else>
                
                <!-- Calculate XP to next level -->
                <set_value name="$xpToNext" exact="1000"/>
                <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$SkillThresholds?">
                  <do_if value="$level lt 15 and global.$GT_Config.$XP.$SkillThresholds.{$level + 1}?">
                    <set_value name="$xpToNext" exact="global.$GT_Config.$XP.$SkillThresholds.{$level + 1}"/>
                  </do_if>
                </do_if>
                
                <!-- Build status string from ship data flags -->
                <set_value name="$statusString" exact="''"/>
                <do_if value="$shipData.$Training? and $shipData.$Training">
                  <set_value name="$statusString" exact="$statusString + '[TRAINING] '"/>
                </do_if>
                <do_if value="$shipData.$NeedsRepair? and $shipData.$NeedsRepair">
                  <set_value name="$statusString" exact="$statusString + '[REPAIR] '"/>
                </do_if>
                <do_if value="$shipData.$NeedsResupply? and $shipData.$NeedsResupply">
                  <set_value name="$statusString" exact="$statusString + '[RESUPPLY] '"/>
                </do_if>
                <do_if value="$shipData.$Rerouting? and $shipData.$Rerouting">
                  <set_value name="$statusString" exact="$statusString + '[REROUTE] '"/>
                </do_if>
                <do_if value="$shipData.$Escaping? and $shipData.$Escaping">
                  <set_value name="$statusString" exact="$statusString + '[ESCAPE] '"/>
                </do_if>
                <do_if value="$shipData.$CargoDisposal? and $shipData.$CargoDisposal">
                  <set_value name="$statusString" exact="$statusString + '[CLEARANCE] '"/>
                </do_if>
                
                <!-- If no special status, check if ship is actively trading or idle -->
                <do_if value="$statusString == ''">
                  <do_if value="$ship.order and $ship.order.id == 'TradeAdvance'">
                    <set_value name="$statusString" exact="'[ADVANCE]'"/>
                  </do_if>
                  <do_elseif value="$ship.order and $ship.order.id == 'Trade'">
                    <set_value name="$statusString" exact="'[TRADING]'"/>
                  </do_elseif>
                  <do_else>
                    <set_value name="$statusString" exact="'[ACTIVE]'"/>
                  </do_else>
                </do_if>
                
                <!-- Get profit from PILOT data (follows pilot across ships) -->
                <set_value name="$pilotProfit" exact="0"/>
                <do_if value="$pilotData.$TotalProfit?">
                  <set_value name="$pilotProfit" exact="$pilotData.$TotalProfit"/>
                </do_if>
                
                <!-- Get profit from SHIP data (current ship's earnings) -->
                <set_value name="$shipProfit" exact="0"/>
                <do_if value="$shipData.$TotalProfit?">
                  <set_value name="$shipProfit" exact="$shipData.$TotalProfit"/>
                </do_if>
                
                <!-- Get trade count from PILOT data (follows pilot across ships) -->
                <set_value name="$tradeCount" exact="0"/>
                <do_if value="$pilotData.$TotalTrades?">
                  <set_value name="$tradeCount" exact="$pilotData.$TotalTrades"/>
                </do_if>
                
                <!-- Expose blocked level for context-sensitive control actions -->
                <set_value name="$blockedLevel" exact="0"/>
                <do_if value="$pilotData.$BlockedLevel?">
                  <set_value name="$blockedLevel" exact="$pilotData.$BlockedLevel"/>
                </do_if>
                
                <!-- Build pilot record string -->
                <!-- Format: shipId|pilotName|shipType|status|rank|rankIndex|level|xp|xpNext|pilotProfit|shipProfit|location|tradeCount|blockedLevel -->
                <set_value name="$pilotRecord" exact="
                  $ship.idcode + '|' +
                  $pilot.name + '|' +
                  $ship.knownname + '|' +
                  $statusString + '|' +
                  $rankTitle + '|' +
                  $rankIndex + '|' +
                  $level + '|' +
                  $pilotData.$XP + '|' +
                  $xpToNext + '|' +
                  $pilotProfit + '|' +
                  $shipProfit + '|' +
                  @$ship.sector.knownname + '|' +
                  $tradeCount + '|' +
                  $blockedLevel
                "/>
                
                <!-- Add to data string -->
                <do_if value="$pilotCount gt 0">
                  <set_value name="$pilotDataString" exact="$pilotDataString + '||'"/>
                </do_if>
                <set_value name="$pilotDataString" exact="$pilotDataString + $pilotRecord"/>
                <set_value name="$pilotCount" operation="add"/>
              </do_if>
            </do_if>
          </do_all>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT Info Menu] Sending data for ' + $pilotCount + ' pilots to Lua UI'" chance="100"/>
        </do_if>
        
        <!-- Send to Lua: config flags + pilot data -->
        <!-- Format: "CONFIG:1|0|1||pilot1data||pilot2data||..." -->
        <set_value name="$fullDataString" exact="$configString + '||' + $pilotDataString"/>
        <raise_lua_event name="'GT_PilotData.Update'" param="$fullDataString"/>
        </do_else>
      </actions>
    </cue>
    
    <!-- Queue manual training from GT control UI -->
    <cue name="HandleManualTrainingRequest" instantiate="true">
      <conditions>
        <event_ui_triggered screen="'GT_PilotControl'" control="'Training'" />
      </conditions>
      <actions>
        <set_value name="$shipId" exact="event.param3"/>
        <set_value name="$autoTrainingEnabled" exact="true"/>
        <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$XP? and global.$GT_GlobalSettings.$XP.$AutoTraining?">
          <set_value name="$autoTrainingEnabled" exact="global.$GT_GlobalSettings.$XP.$AutoTraining"/>
        </do_if>
        
        <set_value name="$ship" exact="null"/>
        <set_value name="$status" exact="'ok'"/>
        <set_value name="$message" exact="{77000,9904}"/>
        <set_value name="$shipsKeysCount" exact="@global.$GT_Ships.keys.count"/>
        <do_if value="$shipsKeysCount? and $shipsKeysCount gt 0">
          <do_all exact="$shipsKeysCount" counter="$i">
            <set_value name="$candidateShip" exact="global.$GT_Ships.keys.{$i}"/>
            <do_if value="$candidateShip? and $candidateShip.idcode == $shipId">
              <set_value name="$ship" exact="$candidateShip"/>
            </do_if>
          </do_all>
        </do_if>
        
        <set_value name="$pilot" exact="null"/>
        <set_value name="$blockedLevel" exact="0"/>
        
        <do_if value="not $ship? or not $ship.pilot?">
          <set_value name="$status" exact="'error'"/>
          <set_value name="$message" exact="{77000,9905}"/>
        </do_if>
        <do_else>
          <set_value name="$pilot" exact="$ship.pilot"/>
          <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{$pilot}? and global.$GT_Pilots.{$pilot}.$BlockedLevel?">
            <set_value name="$blockedLevel" exact="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
          </do_if>
        </do_else>
        
        <do_if value="$status == 'ok' and $autoTrainingEnabled">
          <set_value name="$status" exact="'error'"/>
          <set_value name="$message" exact="{77000,9906}"/>
        </do_if>
        
        <do_if value="$status == 'ok' and $blockedLevel le 1">
          <set_value name="$status" exact="'error'"/>
          <set_value name="$message" exact="{77000,9907}"/>
        </do_if>
        
        <do_if value="$status == 'ok' and $pilot and global.$GT_Pilots? and global.$GT_Pilots.{$pilot}?">
          <set_value name="global.$GT_Pilots.{$pilot}.$ManualTrainingRequested" exact="true"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$TrainingState" exact="'manual_training_queued'"/>
          <!-- Trigger pilot data refresh for UI status updates -->
          <signal_cue_instantly cue="SendPilotData"/>
        </do_if>
        
        <raise_lua_event name="'GT_PilotControl.Confirmation'" param="'training|' + $shipId + '|' + $status + '|' + $message"/>
      </actions>
    </cue>
    
  </cues>
  
</mdscript>
