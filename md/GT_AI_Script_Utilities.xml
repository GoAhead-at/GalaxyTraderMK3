<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_AI_Script_Utilities" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    
    <!-- Initialize AI Script Configuration -->
    <library name="Initialize_AI_Script">
      <params>
        <param name="ship" comment="Ship being initialized"/>
        <param name="order_params" comment="Order parameters"/>
      </params>
      <actions>
        <!-- Create configuration using the Configuration Manager -->
        <run_actions ref="md.GT_Configuration.Create_Ship_Config" result="$shipConfig">
          <param name="order_params" value="$order_params"/>
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <!-- Register ship and pilot -->
        <do_if value="$ship.pilot">
          <run_actions ref="md.GT_Ship_Management.Register_Ship">
            <param name="ship" value="$ship"/>
            <param name="pilot" value="$ship.pilot"/>
            <param name="config" value="$shipConfig"/>
          </run_actions>
        </do_if>
        
        <!-- Return the configuration for use in the AI script -->
        <set_value name="this.$result" exact="$shipConfig"/>
      </actions>
    </library>
    
    <!-- Validate Runtime Parameters -->
    <library name="Validate_Runtime_Parameters" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to validate"/>
        <param name="config" comment="Ship configuration"/>
      </params>
      <actions>
        <set_value name="$validationResult" exact="table[]"/>
        <set_value name="$isValid" exact="true"/>
        <create_list name="$warnings"/>
        <create_list name="$corrections"/>
        
        <!-- Get current skill level -->
        <run_actions ref="md.GT_Ship_Management.Calculate_Skill_Level" result="$skillInfo">
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <!-- Calculate skill-based jump distance -->
        <run_actions ref="md.GT_Ship_Management.Calculate_Jump_Distance" result="$skillMaxDistance">
          <param name="skill_level" value="$skillInfo.$Level"/>
        </run_actions>
        
        <!-- Check if pilot is XP blocked -->
        <set_value name="$pilotXPBlocked" exact="false"/>
        <do_if value="$ship.pilot and global.$GT_Pilots.{$ship.pilot}? and global.$GT_Pilots.{$ship.pilot}.$XPBlocked?">
          <set_value name="$pilotXPBlocked" exact="true"/>
        </do_if>
        
        <!-- Validate and correct MaxBuy distance -->
        <do_if value="not $pilotXPBlocked and $config.$MaxBuy gt $skillMaxDistance">
          <append_to_list name="$warnings" exact="'MaxBuy (' + $config.$MaxBuy + ') exceeds skill limit (' + $skillMaxDistance + ')'"/>
          <append_to_list name="$corrections" exact="'MaxBuy corrected to ' + $skillMaxDistance"/>
          <set_value name="$config.$MaxBuy" exact="$skillMaxDistance"/>
          <set_value name="$config.$MaxBuyDistance" exact="$skillMaxDistance"/>
        </do_if>
        
        <!-- Validate and correct MaxSell distance -->
        <do_if value="not $pilotXPBlocked and $config.$MaxSell gt $skillMaxDistance">
          <append_to_list name="$warnings" exact="'MaxSell (' + $config.$MaxSell + ') exceeds skill limit (' + $skillMaxDistance + ')'"/>
          <append_to_list name="$corrections" exact="'MaxSell corrected to ' + $skillMaxDistance"/>
          <set_value name="$config.$MaxSell" exact="$skillMaxDistance"/>
          <set_value name="$config.$MaxSellDistance" exact="$skillMaxDistance"/>
        </do_if>
        
        <!-- Store validation results -->
        <set_value name="$validationResult.$IsValid" exact="$isValid"/>
        <set_value name="$validationResult.$Warnings" exact="$warnings"/>
        <set_value name="$validationResult.$Corrections" exact="$corrections"/>
        <set_value name="$validationResult.$SkillInfo" exact="$skillInfo"/>
        <set_value name="$validationResult.$SkillMaxDistance" exact="$skillMaxDistance"/>
        <set_value name="$validationResult.$PilotXPBlocked" exact="$pilotXPBlocked"/>
        
        <set_value name="this.$result" exact="$validationResult"/>
      </actions>
    </library>
    
    <!-- Handle Fleet Coordination -->
    <library name="Handle_Fleet_Coordination" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship joining fleet"/>
        <param name="config" comment="Ship configuration"/>
      </params>
      <actions>
        <set_value name="$fleetResult" exact="table[]"/>
        <set_value name="$startupDelay" exact="0"/>
        <set_value name="$isSubordinate" exact="false"/>
        
        <!-- Check if fleet coordination is enabled AND pilot level gate passed (>= 12) -->
        <do_if value="$config.$FleetCoordination">
          <set_value name="$fleetGatePassed" exact="false"/>
          <run_actions ref="md.GT_Ship_Management.Calculate_Skill_Level" result="$skillInfo">
            <param name="ship" value="$ship"/>
          </run_actions>
          <do_if value="$skillInfo? and $skillInfo.$Level? and $skillInfo.$Level ge 12">
            <set_value name="$fleetGatePassed" exact="true"/>
          </do_if>
          
          <!-- Only apply coordination delay if gate passed -->
          <do_if value="$fleetGatePassed">
          <!-- Count active traders -->
          <set_value name="$activeTraders" exact="0"/>
          <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
            <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
            <do_all exact="$shipKeys.count" counter="$i">
              <set_value name="$existingShip" exact="$shipKeys.{$i}"/>
              <do_if value="$existingShip.exists and $existingShip.isoperational and $existingShip != $ship">
                <set_value name="$activeTraders" exact="$activeTraders + 1"/>
              </do_if>
            </do_all>
          </do_if>
          
          <!-- Apply fleet coordination delay -->
          <do_if value="$activeTraders gt 0">
            <set_value name="$startupDelay" exact="[$activeTraders * 5, 30].min"/>
            <set_value name="$isSubordinate" exact="true"/>
            
            <debug_text text="'[GT-AI] ' + $ship.idcode + ': Fleet coordination: delaying startup for ' + $startupDelay + 's (found ' + $activeTraders + ' active traders)'" chance="100"/>
          </do_if>
          </do_if>
          <do_if value="not $fleetGatePassed">
            <debug_text text="'[GT-AI] ' + $ship.idcode + ': Fleet coordination gated by level (requires 12), current=' + (if $skillInfo? then $skillInfo.$Level else 1)" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Store results -->
        <set_value name="$fleetResult.$StartupDelay" exact="$startupDelay"/>
        <set_value name="$fleetResult.$IsSubordinate" exact="$isSubordinate"/>
        <set_value name="$fleetResult.$ActiveTraders" exact="$activeTraders"/>
        
        <set_value name="this.$result" exact="$fleetResult"/>
      </actions>
    </library>
    
    <!-- Check Training Requirements -->
    <library name="Check_Training_Requirements" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to check"/>
        <param name="pilot" comment="Pilot to check"/>
        <param name="config" comment="Ship configuration"/>
      </params>
      <actions>
        <set_value name="$trainingResult" exact="table[]"/>
        <set_value name="$needsTraining" exact="false"/>
        <set_value name="$trainingAction" exact="'none'"/>
        
        <!-- Only check if auto-training is enabled -->
        <do_if value="$config.$AutoTraining and $pilot">
          <!-- Check training requirements using XP system -->
          <set_value name="$trainingStatus" exact="table[$Required = false, $Level = 1, $IsBlocked = false]"/>
          <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
            <set_value name="$currentLevel" exact="@global.$GT_Pilots.{$pilot}.$Level"/>
            <do_if value="not $currentLevel">
              <set_value name="$currentLevel" exact="1"/>
            </do_if>
            
            <!-- Check if training is beneficial (level < 5) -->
            <do_if value="$currentLevel lt 5">
              <set_value name="$trainingStatus.$Required" exact="true"/>
              <set_value name="$trainingStatus.$Level" exact="$currentLevel + 1"/>
            </do_if>
          </do_if>
          
          <set_value name="$needsTraining" exact="$trainingStatus.$Required"/>
          
          <do_if value="$needsTraining">
            <!-- Find training station -->
            <set_value name="$stationResult" exact="table[$Found = false, $Station = null]"/>
            <find_station name="$nearestStation" space="$ship.zone">
              <match class="class.station"/>
            </find_station>
            <do_if value="$nearestStation">
              <set_value name="$stationResult.$Found" exact="true"/>
              <set_value name="$stationResult.$Station" exact="$nearestStation"/>
            </do_if>
            
            <do_if value="$stationResult.$Found">
              <set_value name="$trainingAction" exact="'start_training'"/>
              <set_value name="$trainingResult.$TrainingStation" exact="$stationResult.$Station"/>
              <set_value name="$trainingResult.$RequiredLevel" exact="$trainingStatus.$Level"/>
            </do_if>
            <do_else>
              <set_value name="$trainingAction" exact="'no_station'"/>
            </do_else>
          </do_if>
          <do_elseif value="$trainingStatus.$IsBlocked">
            <!-- Pilot is blocked but no training needed - this shouldn't happen -->
            <set_value name="$trainingAction" exact="'clear_block'"/>
          </do_elseif>
        </do_if>
        
        <!-- Store results -->
        <set_value name="$trainingResult.$NeedsTraining" exact="$needsTraining"/>
        <set_value name="$trainingResult.$Action" exact="$trainingAction"/>
        <set_value name="$trainingResult.$TrainingStatus" exact="@$trainingStatus"/>
        
        <set_value name="this.$result" exact="$trainingResult"/>
      </actions>
    </library>
    
    <!-- Extract Configuration Variables for AI Script Compatibility -->
    <library name="Extract_Config_Variables" purpose="run_actions">
      <params>
        <param name="config" comment="Ship configuration"/>
      </params>
      <actions>
        <!-- Extract all configuration values into individual variables for backward compatibility -->
        <set_value name="$variables" exact="table[]"/>
        
        <!-- Basic trading settings -->
        <set_value name="$variables.$gt_allowillegal" exact="$config.$AllowIllegal"/>
        <set_value name="$variables.$gt_risktolerance" exact="$config.$RiskTolerance"/>
        <set_value name="$variables.$gt_distancepenalty" exact="$config.$DistancePenalty"/>
        <set_value name="$variables.$gt_cargotarget" exact="$config.$CargoTarget"/>
        <set_value name="$variables.$gt_marketupdatefreq" exact="$config.$MarketUpdateFreq"/>
        
        <!-- System settings -->
        <set_value name="$variables.$gt_enablexp" exact="$config.$EnableXP"/>
        <set_value name="$variables.$gt_autotraining" exact="$config.$AutoTraining"/>
        <set_value name="$variables.$gt_fleetcoord" exact="$config.$FleetCoordination"/>
        <set_value name="$variables.$gt_tradecache" exact="$config.$TradeCache"/>
        <set_value name="$variables.$gt_cachethreshold" exact="$config.$CacheThreshold"/>
        <set_value name="$variables.$gt_cachettl" exact="$config.$CacheTTL"/>
        <set_value name="$variables.$gt_cachedropoff" exact="$config.$CacheDropoffTolerance"/>
        <set_value name="$variables.$gt_debuglevel" exact="$config.$DebugLevel"/>
        
        <!-- Jump distances -->
        <set_value name="$variables.$maxbuy" exact="$config.$MaxBuyDistance"/>
        <set_value name="$variables.$maxsell" exact="$config.$MaxSellDistance"/>
        
        <!-- Ware settings -->
        <set_value name="$variables.$warebasket" exact="$config.$WareBasket"/>
        <set_value name="$variables.$gt_notifications" exact="$config.$Notifications"/>
        <set_value name="$variables.$gt_tradeeval" exact="$config.$TradeEval"/>
        
        <!-- Debug settings -->
        <set_value name="$variables.$debugchance" exact="100"/>
        
        <set_value name="this.$result" exact="$variables"/>
      </actions>
    </library>
    
    <!-- Log Configuration Summary -->
    <library name="Log_Configuration_Summary">
      <params>
        <param name="ship" comment="Ship being configured"/>
        <param name="config" comment="Ship configuration"/>
        <param name="debug_level" default="1" comment="Minimum debug level to log"/>
      </params>
      <actions>
        <do_if value="$config.$DebugLevel ge $debug_level">
          <debug_text text="'[GT-AI] ' + $ship.idcode + ': === CONFIGURATION SUMMARY ==='" chance="100"/>
          <debug_text text="'[GT-AI] ' + $ship.idcode + ': Risk=' + $config.$RiskTolerance + ', Illegal=' + $config.$AllowIllegal + ', DistancePenalty=' + $config.$DistancePenalty + '%'" chance="100"/>
          <debug_text text="'[GT-AI] ' + $ship.idcode + ': XP=' + $config.$EnableXP + ', AutoTraining=' + $config.$AutoTraining + ', Fleet=' + $config.$FleetCoordination" chance="100"/>
          <debug_text text="'[GT-AI] ' + $ship.idcode + ': Distance limits: MaxBuy=' + $config.$MaxBuyDistance + ' jumps, MaxSell=' + $config.$MaxSellDistance + ' jumps'" chance="100"/>
          <debug_text text="'[GT-AI] ' + $ship.idcode + ': Ware basket: ' + $config.$WareBasket.count + ' wares configured (AutoWares=' + $config.$AutoWares + ')'" chance="100"/>
          
          <!-- Log skill information if available -->
          <do_if value="$config.$SkillInfo?">
            <debug_text text="'[GT-AI] ' + $ship.idcode + ': Skill Level=' + $config.$SkillInfo.$Level + ', Using MD System=' + $config.$SkillInfo.$UsingMDSystem" chance="100"/>
          </do_if>
        </do_if>
        
        <set_value name="this.$result" exact="true"/>
      </actions>
    </library>
    
    <!-- Handle Order Parameter Updates -->
    <library name="Update_Order_Parameters">
      <params>
        <param name="ship" comment="Ship with order to update"/>
        <param name="config" comment="Current configuration"/>
        <param name="pilot_xp_blocked" default="false" comment="Whether pilot is XP blocked"/>
      </params>
      <actions>
        <!-- Only update order parameters if pilot is not XP blocked to prevent restart loops -->
        <do_if value="not $pilot_xp_blocked and $ship.order?">
          <!-- Update MaxBuy parameter if corrected -->
          <do_if value="$config.$MaxBuy != $config.$MaxBuyDistance">
            <edit_order_param order="$ship.order" param="'maxbuy'" value="$config.$MaxBuyDistance"/>
          </do_if>
          
          <!-- Update MaxSell parameter if corrected -->
          <do_if value="$config.$MaxSell != $config.$MaxSellDistance">
            <edit_order_param order="$ship.order" param="'maxsell'" value="$config.$MaxSellDistance"/>
          </do_if>
        </do_if>
        
        <set_value name="this.$result" exact="true"/>
      </actions>
    </library>
    
    <!-- Clean Up Stale Flags -->
    <library name="Cleanup_Stale_Flags">
      <params>
        <param name="ship" comment="Ship to clean up"/>
      </params>
      <actions>
        <!-- Clear stale predictive training flags -->
        <do_if value="$ship.$TrainingRequiredAfterThisTrade?">
          <debug_text text="'[GT-AI] ' + $ship.idcode + ': 🧹 Clearing stale predictive training flag'" chance="100"/>
          <remove_value name="$ship.$TrainingRequiredAfterThisTrade"/>
        </do_if>
        
        <!-- Clear stale training in progress flags (older than 5 minutes) -->
        <do_if value="$ship.$TrainingInProgress? and $ship.$TrainingStartTime?">
          <do_if value="(player.age - $ship.$TrainingStartTime) gt 300s">
            <debug_text text="'[GT-AI] ' + $ship.idcode + ': 🧹 Clearing stale training-in-progress flag (older than 5 minutes)'" chance="100"/>
            <remove_value name="$ship.$TrainingInProgress"/>
            <remove_value name="$ship.$TrainingStartTime"/>
          </do_if>
        </do_if>
        
        <set_value name="this.$result" exact="true"/>
      </actions>
    </library>
    
  </cues>
</mdscript> 