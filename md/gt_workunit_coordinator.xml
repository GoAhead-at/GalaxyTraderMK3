<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_WorkUnit_Coordinator" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- =====================================================================
         Work Unit Coordinator
         
         Purpose: Coordinate AI work units for trade search processing
         - Receives work unit completion signals from AI
         - Routes results back to search pipeline
         - Manages work unit state
         ===================================================================== -->
    
    <!-- Initialize work unit system -->
    <cue name="Init" instantiate="true">
      <conditions>
        <check_any>
          <event_game_loaded/>
          <event_player_created/>
        </check_any>
      </conditions>
      <actions>
        <!-- Initialize active work units tracking -->
        <do_if value="not global.$GT_WorkUnits?">
          <set_value name="global.$GT_WorkUnits" exact="table[
            $Active = table[],
            $Queue = []
          ]"/>
        </do_if>
        
        <!-- Initialize work item reference storage -->
        <do_if value="not global.$GT_WorkUnitWorkItems?">
          <set_value name="global.$GT_WorkUnitWorkItems" exact="table[]"/>
        </do_if>
        
        <!-- Initialize work unit offers storage -->
        <do_if value="not global.$GT_WorkUnitOffers?">
          <set_value name="global.$GT_WorkUnitOffers" exact="table[]"/>
        </do_if>
        
        <!-- Initialize filtered offers storage -->
        <do_if value="not global.$GT_WorkUnitOffersFiltered?">
          <set_value name="global.$GT_WorkUnitOffersFiltered" exact="table[]"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Handle work unit completion signal from AI -->
    <cue name="HandleWorkUnitComplete" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_WorkUnit_Complete'"/>
      </conditions>
      <actions>
        <set_value name="$data" exact="event.param2"/>
        <set_value name="$ship" exact="$data.$Ship"/>
        <set_value name="$workType" exact="$data.$WorkType"/>
        <set_value name="$result" exact="$data.$Result"/>
        
        <!-- Remove from active work units -->
        <do_if value="global.$GT_WorkUnits? and global.$GT_WorkUnits.$Active? and global.$GT_WorkUnits.$Active.{$ship}?">
          <remove_value name="global.$GT_WorkUnits.$Active.{$ship}"/>
        </do_if>
        
        <!-- Route result based on work type -->
        <do_if value="$workType == 'cache_search'">
          <!-- Cache search complete - finalize scheduler work item and route results -->
          <set_value name="$workItem" exact="null"/>
          <do_if value="global.$GT_WorkUnitWorkItems? and global.$GT_WorkUnitWorkItems.{$ship}?">
            <set_value name="$workItem" exact="global.$GT_WorkUnitWorkItems.{$ship}"/>
            <remove_value name="global.$GT_WorkUnitWorkItems.{$ship}"/>
          </do_if>
          
          <!-- Convert AI result to scheduler format -->
          <set_value name="$cacheResult" exact="table[
            $Found = if $result? and $result.$Found? then $result.$Found else false,
            $Trade = if $result? and $result.$Trade? then $result.$Trade else null,
            $Trades = if $result? and $result.$Trades? then $result.$Trades else [],
            $BestScore = if $result? and $result.$BestScore? then $result.$BestScore else 0,
            $ScanDone = true
          ]"/>
          
          <!-- Finalize scheduler work item if it exists -->
          <do_if value="$workItem?">
            <set_value name="$workItem.$Payload.$Result" exact="$cacheResult"/>
            <set_value name="$traceId" exact="if $workItem.$TraceId? then $workItem.$TraceId else '0'"/>
            
            <!-- Update work item state -->
            <run_actions ref="md.GT_Libraries_General.GT_UpdateWorkItemState">
              <param name="key" value="$workItem.$Key"/>
              <param name="newState" value="'completed'"/>
              <param name="traceId" value="$traceId"/>
              <param name="workItem" value="$workItem"/>
            </run_actions>
            
            <!-- Remove from ActiveWork -->
            <do_if value="$ship?">
              <remove_value name="global.$GT_Scheduler.$ActiveWork.{$ship}"/>
            </do_if>
          </do_if>
          
          <!-- Route to search pipeline with cache result -->
          <set_value name="$resumeParams" exact="table[
            $Ship = $ship,
            $SearchState = 'cache',
            $CacheResult = $cacheResult,
            $MaxDistance = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MaxDistance else 1,
            $MinROI = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MinROI else 0,
            $MinAbsoluteProfit = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MinAbsoluteProfit else 0,
            $FactionPriority = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$FactionPriority else 1
          ]"/>
          
          <!-- Signal search pipeline to process cache results -->
          <signal_cue_instantly cue="md.GT_Trading_Search.SearchTradeRoutes" param="$resumeParams"/>
        </do_if>
        <do_elseif value="$workType == 'live_offers'">
          <!-- Live offer collection complete - route to trade matching -->
          <set_value name="global.$GT_SearchLiveTrades_State.{$ship}.$SellOffers" exact="if $result? and $result.$SellOffers? then $result.$SellOffers else []"/>
          <set_value name="global.$GT_SearchLiveTrades_State.{$ship}.$BuyOffers" exact="if $result? and $result.$BuyOffers? then $result.$BuyOffers else []"/>
          
          <!-- Trigger trade matching work unit -->
          <set_value name="$workUnit" exact="table[
            $WorkType = 'trade_matching',
            $Ship = $ship,
            $SellOffers = if $result? and $result.$SellOffers? then $result.$SellOffers else [],
            $BuyOffers = if $result? and $result.$BuyOffers? then $result.$BuyOffers else [],
            $HomeSector = if global.$GT_SearchLiveTrades_State? and global.$GT_SearchLiveTrades_State.{$ship}? then @global.$GT_SearchLiveTrades_State.{$ship}.$HomeSector else null,
            $MaxDistance = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MaxDistance else 1,
            $MinROI = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MinROI else 0,
            $MinAbsoluteProfit = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MinAbsoluteProfit else 0,
            $DistancePenaltyMultiplier = if global.$GT_SearchLiveTrades_State? and global.$GT_SearchLiveTrades_State.{$ship}? then @global.$GT_SearchLiveTrades_State.{$ship}.$DistancePenaltyMultiplier else 0.5,
            $FactionPriority = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$FactionPriority else 1
          ]"/>
          
          <!-- Mark as active -->
          <do_if value="not global.$GT_WorkUnits?">
            <set_value name="global.$GT_WorkUnits" exact="table[$Active = table[], $Queue = []]"/>
          </do_if>
          <set_value name="global.$GT_WorkUnits.$Active.{$ship}" exact="$workUnit"/>
          
          <!-- Signal AI work unit -->
          <signal_objects object="$ship" param="'GT_ProcessWorkUnit'" param2="$workUnit"/>
        </do_elseif>
        <do_elseif value="$workType == 'trade_matching'">
          <!-- Trade matching complete - store results and signal search pipeline -->
          <set_value name="$tradeList" exact="if $result? and $result.$Trades? then $result.$Trades else []"/>
          <set_value name="global.$GT_SearchResult.{$ship}" exact="table[
            $Found = if $result? and $result.$Found? then $result.$Found else false,
            $BestTrade = if $result? and $result.$Trade? then $result.$Trade else null,
            $TradeList = $tradeList,
            $BestScore = if $result? and $result.$BestScore? then $result.$BestScore else 0,
            $WaitingForCache = false,
            $WaitingForBatch = false
          ]"/>
          
          <!-- Clear waiting flag -->
          <do_if value="global.$GT_SearchResult.{$ship}?">
            <set_value name="global.$GT_SearchResult.{$ship}.$WaitingForBatch" exact="false"/>
          </do_if>
          
          <!-- CRITICAL: Propagate trades to cache so other ships can use them -->
          <!-- Get home sector from live search state -->
          <set_value name="$homeSector" exact="null"/>
          <do_if value="global.$GT_SearchLiveTrades_State? and global.$GT_SearchLiveTrades_State.{$ship}? and global.$GT_SearchLiveTrades_State.{$ship}.$HomeSector?">
            <set_value name="$homeSector" exact="global.$GT_SearchLiveTrades_State.{$ship}.$HomeSector"/>
          </do_if>
          
          <!-- Propagate trades to cache if we have valid home sector and trade list -->
          <do_if value="$homeSector? and $homeSector.exists and $homeSector.isclass.sector and $tradeList? and $tradeList != null and $tradeList.count gt 0">
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-WorkUnit] (' + $ship.idcode + ') Propagating ' + $tradeList.count + ' trades to cache for home sector ' + (if $homeSector? then @$homeSector.knownname else 'null')" chance="100"/>
            </do_if>
            
            <!-- Initialize cache structure if needed -->
            <do_if value="not global.$GT_TradeCache? or typeof global.$GT_TradeCache != datatype.table">
              <set_value name="global.$GT_TradeCache" exact="table[]"/>
            </do_if>
            <do_if value="not global.$GT_TradeCache.{$homeSector}? or global.$GT_TradeCache.{$homeSector} == null or typeof global.$GT_TradeCache.{$homeSector} != datatype.list">
              <set_value name="global.$GT_TradeCache.{$homeSector}" exact="[]"/>
            </do_if>
            
            <!-- Loop through trades and add to cache -->
            <do_all exact="$tradeList.count" counter="$i">
              <set_value name="$trade" exact="$tradeList.{$i}"/>
              <do_if value="$trade? and $trade != null">
                <!-- Extract buy/sell offers from trade -->
                <set_value name="$buyOffer" exact="@$trade.$BuyOffer"/>
                <set_value name="$sellOffer" exact="@$trade.$SellOffer"/>
                
                <!-- Generate trade key and add to cache -->
                <do_if value="$buyOffer? and $buyOffer.exists and $sellOffer? and $sellOffer.exists">
                  <set_value name="$tradeKey" exact="''"/>
                  <run_actions ref="md.GT_Libraries_General.GT_GenerateTradeKey" result="$tradeKey">
                    <param name="buyOffer" value="$buyOffer"/>
                    <param name="sellOffer" value="$sellOffer"/>
                    <param name="traceId" value="''"/>
                  </run_actions>
                  
                  <!-- Add to cache if trade key is valid -->
                  <do_if value="$tradeKey != '' and $tradeKey != 'null_null'">
                    <!-- Extract trade data -->
                    <set_value name="$ware" exact="if $sellOffer.ware? then $sellOffer.ware else null"/>
                    <set_value name="$buyPrice" exact="if $trade.$BuyPrice? then $trade.$BuyPrice else (if $buyOffer.price? then $buyOffer.price else 0)"/>
                    <set_value name="$sellPrice" exact="if $trade.$SellPrice? then $trade.$SellPrice else (if $sellOffer.price? then $sellOffer.price else 0)"/>
                    <set_value name="$profit" exact="if $trade.$Profit? then $trade.$Profit else 0"/>
                    <set_value name="$roi" exact="if $trade.$ROI? then $trade.$ROI else 0"/>
                    <set_value name="$amount" exact="if $trade.$Amount? then $trade.$Amount else (if $buyOffer.amount? and $sellOffer.amount? then [$buyOffer.amount, $sellOffer.amount].min else 0)"/>
                    <set_value name="$distance" exact="if $trade.$Distance? then $trade.$Distance else 0"/>
                    <set_value name="$score" exact="if $trade.$Score? then $trade.$Score else $profit"/>
                    
                    <!-- Extract station IDs -->
                    <set_value name="$buyStationId" exact="if $buyOffer.owner? and $buyOffer.owner.exists then $buyOffer.owner.idcode else ''"/>
                    <set_value name="$sellStationId" exact="if $sellOffer.owner? and $sellOffer.owner.exists then $sellOffer.owner.idcode else ''"/>
                    
                    <!-- Create cache entry matching batch processor format -->
                    <set_value name="$cacheEntry" exact="table[
                      $WareId = if $ware? and $ware.exists then $ware.id else '',
                      $Ware = $ware,
                      $WareName = if $ware? and $ware.exists then $ware.name else '',
                      $SellStationId = $buyStationId,
                      $BuyStationId = $sellStationId,
                      $BuyOffer = $buyOffer,
                      $SellOffer = $sellOffer,
                      $BuyTargetType = if $buyOffer.owner? and $buyOffer.owner.exists then $buyOffer.owner.class else null,
                      $SellTargetType = if $sellOffer.owner? and $sellOffer.owner.exists then $sellOffer.owner.class else null,
                      $BuyDockCaps = null,
                      $SellDockCaps = null,
                      $TradeRulesRespected = true,
                      $OfferMaxAmount = $amount,
                      $ProfitPerUnit = if $amount gt 0 then ($profit / $amount) else 0,
                      $VolumePerUnit = if $ware? and $ware.exists and $ware.volume? then $ware.volume else 0,
                      $Amount = $amount,
                      $TotalVolume = if $ware? and $ware.exists and $ware.volume? then ($ware.volume * $amount) else 0,
                      $Profit = $profit,
                      $ROI = $roi,
                      $BuyPrice = $buyPrice,
                      $SellPrice = $sellPrice,
                      $Distance = $distance,
                      $Timestamp = player.age,
                      $HomeSector = $homeSector,
                      $HomeToBuyDistance = $distance,
                      $HomeToSellDistance = 0,
                      $FailCount = 0,
                      $FailedShips = [],
                      $Score = $score
                    ]"/>
                    
                    <!-- Insert cache entry in sorted order (by profit descending) -->
                    <set_value name="$homeSectorCache" exact="global.$GT_TradeCache.{$homeSector}"/>
                    <set_value name="$insertIndex" exact="0"/>
                    <set_value name="$insertionFound" exact="false"/>
                    <do_if value="$homeSectorCache.count gt 0">
                      <do_all exact="$homeSectorCache.count" counter="$j">
                        <set_value name="$existingProfit" exact="if $homeSectorCache.{$j}.$Profit? then $homeSectorCache.{$j}.$Profit else 0"/>
                        <do_if value="$profit gt $existingProfit">
                          <set_value name="$insertIndex" exact="$j"/>
                          <set_value name="$insertionFound" exact="true"/>
                          <break/>
                        </do_if>
                      </do_all>
                    </do_if>
                    
                    <!-- Insert or append cache entry -->
                    <do_if value="$insertionFound">
                      <set_value name="global.$GT_TradeCache.{$homeSector}.{$insertIndex}" exact="$cacheEntry" operation="insert"/>
                    </do_if>
                    <do_else>
                      <append_to_list name="global.$GT_TradeCache.{$homeSector}" exact="$cacheEntry"/>
                    </do_else>
                    
                    <!-- Add to cache index -->
                    <run_actions ref="md.GT_Libraries_General.GT_AddTradeToIndex">
                      <param name="tradeKey" value="$tradeKey"/>
                      <param name="homeSector" value="$homeSector"/>
                      <param name="traceId" value="if $ship? then $ship.idcode else '0'"/>
                    </run_actions>
                    
                    <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                      <debug_text text="'[GT-Coordinator] (' + $ship.idcode + ') Added trade to cache: ' + $tradeKey + ' for home sector ' + $homeSector.knownname + ' (profit=' + ($profit/100) + ' Cr, cache size=' + global.$GT_TradeCache.{$homeSector}.count + ')'" chance="10"/>
                    </do_if>
                  </do_if>
                </do_if>
              </do_if>
            </do_all>
          </do_if>
          
          <!-- Signal search pipeline to process live results -->
          <signal_cue_instantly cue="md.GT_Trading_Search.SearchTradeRoutes" param="table[
            $Ship = $ship,
            $SearchState = 'live',
            $MaxDistance = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MaxDistance else 1,
            $MinROI = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MinROI else 0,
            $MinAbsoluteProfit = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MinAbsoluteProfit else 0,
            $FactionPriority = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$FactionPriority else 1
          ]"/>
        </do_elseif>
      </actions>
    </cue>
    
    <!-- Handle offer filtering request from AI -->
    <cue name="FilterWorkUnitOffers" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_FilterWorkUnitOffers'"/>
      </conditions>
      <actions>
        <set_value name="$data" exact="event.param2"/>
        <set_value name="$ship" exact="$data.$Ship"/>
        
        <!-- Get offers from global state -->
        <set_value name="$offerData" exact="@global.$GT_WorkUnitOffers.{$ship}"/>
        <do_if value="$offerData?">
          <set_value name="$sellOffers" exact="$offerData.$SellOffers"/>
          <set_value name="$buyOffers" exact="$offerData.$BuyOffers"/>
          <set_value name="$homeSector" exact="$offerData.$HomeSector"/>
          <set_value name="$maxDistance" exact="$offerData.$MaxDistance"/>
          
          <!-- Filter offers by distance using MD library -->
          <run_actions ref="md.GT_Libraries_General.GT_FilterOffersByDistance" result="$filteredSell">
            <param name="offersList" value="$sellOffers"/>
            <param name="homeSector" value="$homeSector"/>
            <param name="maxDistance" value="$maxDistance"/>
          </run_actions>
          <run_actions ref="md.GT_Libraries_General.GT_FilterOffersByDistance" result="$filteredBuy">
            <param name="offersList" value="$buyOffers"/>
            <param name="homeSector" value="$homeSector"/>
            <param name="maxDistance" value="$maxDistance"/>
          </run_actions>
          
          <!-- Store filtered results -->
          <set_value name="global.$GT_WorkUnitOffersFiltered.{$ship}" exact="table[
            $SellOffers = if $filteredSell? and $filteredSell.$FilteredOffers? then $filteredSell.$FilteredOffers else [],
            $BuyOffers = if $filteredBuy? and $filteredBuy.$FilteredOffers? then $filteredBuy.$FilteredOffers else []
          ]"/>
          
          <!-- Signal AI that filtering is complete -->
          <signal_objects object="$ship" param="'GT_WorkUnitOffersFiltered'"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Queue work unit for processing -->
    <cue name="QueueWorkUnit" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$workUnit" exact="event.param"/>
        <set_value name="$ship" exact="$workUnit.$Ship"/>
        <set_value name="$workType" exact="if $workUnit.$WorkType? then $workUnit.$WorkType else 'unknown'"/>
        <set_value name="$traceId" exact="if $workUnit.$TraceId? then $workUnit.$TraceId else '0'"/>
        
        <!-- Initialize structures if needed -->
        <do_if value="not global.$GT_WorkUnits?">
          <set_value name="global.$GT_WorkUnits" exact="table[$Active = table[], $Queue = []]"/>
        </do_if>
        
        <!-- Check if ship already has active work unit -->
        <set_value name="$hasActive" exact="false"/>
        <do_if value="global.$GT_WorkUnits.$Active? and global.$GT_WorkUnits.$Active.{$ship}?">
          <set_value name="$hasActive" exact="true"/>
        </do_if>
        
        <!-- Queue if already active, otherwise start immediately -->
        <do_if value="$hasActive">
          <!-- Add to queue -->
          <do_if value="not global.$GT_WorkUnits.$Queue?">
            <set_value name="global.$GT_WorkUnits.$Queue" exact="[]"/>
          </do_if>
          <append_to_list name="global.$GT_WorkUnits.$Queue" exact="$workUnit"/>
          
          <!-- Log queuing -->
          <run_actions ref="md.GT_Libraries_General.GT_LogTradeSearch">
            <param name="traceId" value="$traceId"/>
            <param name="stage" value="'WorkUnitCoordinator'"/>
            <param name="action" value="'WorkUnitQueued'"/>
            <param name="details" value="'ship=' + $ship.idcode + ' type=' + $workType + ' (ship has active work unit)'"/>
            <param name="logLevel" value="1"/>
          </run_actions>
        </do_if>
        <do_else>
          <!-- Validate ship before signaling -->
          <do_if value="not $ship? or not $ship.exists">
            <run_actions ref="md.GT_Libraries_General.GT_LogTradeSearch">
              <param name="traceId" value="$traceId"/>
              <param name="stage" value="'WorkUnitCoordinator'"/>
              <param name="action" value="'Error'"/>
              <param name="details" value="'reason=invalid_ship_reference ship=' + (if $ship? then $ship.idcode else 'null') + ' type=' + $workType"/>
              <param name="logLevel" value="0"/>
            </run_actions>
          </do_if>
          <do_else>
            <!-- Start immediately -->
            <set_value name="global.$GT_WorkUnits.$Active.{$ship}" exact="$workUnit"/>
            
            <!-- Log signaling -->
            <run_actions ref="md.GT_Libraries_General.GT_LogTradeSearch">
              <param name="traceId" value="$traceId"/>
              <param name="stage" value="'WorkUnitCoordinator'"/>
              <param name="action" value="'WorkUnitSignaled'"/>
              <param name="details" value="'ship=' + $ship.idcode + ' type=' + $workType + ' signaling AI script'"/>
              <param name="logLevel" value="1"/>
            </run_actions>
            
            <signal_objects object="$ship" param="'GT_ProcessWorkUnit'" param2="$workUnit"/>
          </do_else>
        </do_else>
      </actions>
    </cue>
  </cues>
</mdscript>
