<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_WorkUnit_Coordinator" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- =====================================================================
         Work Unit Coordinator
         
         Purpose: Coordinate AI work units for trade search processing
         - Receives work unit completion signals from AI
         - Routes results back to search pipeline
         - Manages work unit state
         ===================================================================== -->
    
    <!-- Initialize work unit system -->
    <cue name="Init" instantiate="true">
      <conditions>
        <check_any>
          <event_game_loaded/>
          <event_player_created/>
        </check_any>
      </conditions>
      <actions>
        <!-- Initialize active work units tracking -->
        <do_if value="not global.$GT_WorkUnits?">
          <set_value name="global.$GT_WorkUnits" exact="table[
            $Active = table[],
            $Queue = []
          ]"/>
        </do_if>
        
        <!-- Initialize work item reference storage -->
        <do_if value="not global.$GT_WorkUnitWorkItems?">
          <set_value name="global.$GT_WorkUnitWorkItems" exact="table[]"/>
        </do_if>
        
        <!-- Initialize work unit offers storage -->
        <do_if value="not global.$GT_WorkUnitOffers?">
          <set_value name="global.$GT_WorkUnitOffers" exact="table[]"/>
        </do_if>
        
        <!-- Initialize filtered offers storage -->
        <do_if value="not global.$GT_WorkUnitOffersFiltered?">
          <set_value name="global.$GT_WorkUnitOffersFiltered" exact="table[]"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Handle work unit completion signal from AI -->
    <cue name="HandleWorkUnitComplete" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_WorkUnit_Complete'"/>
      </conditions>
      <actions>
        <set_value name="$data" exact="event.param2"/>
        <set_value name="$ship" exact="$data.$Ship"/>
        <set_value name="$workType" exact="$data.$WorkType"/>
        <set_value name="$result" exact="$data.$Result"/>
        
        <!-- Remove from active work units -->
        <do_if value="global.$GT_WorkUnits? and global.$GT_WorkUnits.$Active? and global.$GT_WorkUnits.$Active.{$ship}?">
          <remove_value name="global.$GT_WorkUnits.$Active.{$ship}"/>
        </do_if>
        
        <!-- Route result based on work type -->
        <do_if value="$workType == 'cache_search'">
          <!-- Cache search complete - finalize scheduler work item and route results -->
          <set_value name="$workItem" exact="null"/>
          <do_if value="global.$GT_WorkUnitWorkItems? and global.$GT_WorkUnitWorkItems.{$ship}?">
            <set_value name="$workItem" exact="global.$GT_WorkUnitWorkItems.{$ship}"/>
            <remove_value name="global.$GT_WorkUnitWorkItems.{$ship}"/>
          </do_if>
          
          <!-- Convert AI result to scheduler format -->
          <set_value name="$cacheResult" exact="table[
            $Found = if $result? and $result.$Found? then $result.$Found else false,
            $Trade = if $result? and $result.$Trade? then $result.$Trade else null,
            $Trades = if $result? and $result.$Trades? then $result.$Trades else [],
            $BestScore = if $result? and $result.$BestScore? then $result.$BestScore else 0,
            $ScanDone = true
          ]"/>
          
          <!-- Finalize scheduler work item if it exists -->
          <do_if value="$workItem?">
            <set_value name="$workItem.$Payload.$Result" exact="$cacheResult"/>
            <set_value name="$traceId" exact="if $workItem.$TraceId? then $workItem.$TraceId else '0'"/>
            
            <!-- Update work item state -->
            <run_actions ref="md.GT_Libraries_General.GT_UpdateWorkItemState">
              <param name="key" value="$workItem.$Key"/>
              <param name="newState" value="'completed'"/>
              <param name="traceId" value="$traceId"/>
              <param name="workItem" value="$workItem"/>
            </run_actions>
            
            <!-- Remove from ActiveWork -->
            <do_if value="$ship?">
              <remove_value name="global.$GT_Scheduler.$ActiveWork.{$ship}"/>
            </do_if>
          </do_if>
          
          <!-- Route to search pipeline with cache result -->
          <!-- CRITICAL FIX: Pass UseSearchQueueCounter so cache search slot is released when cache results are processed -->
          <set_value name="$usedCacheSlot" exact="false"/>
          <do_if value="global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}?">
            <set_value name="$usedCacheSlot" exact="true"/>
          </do_if>
          <set_value name="$resumeParams" exact="table[
            $Ship = $ship,
            $SearchState = 'cache',
            $CacheResult = $cacheResult,
            $UseSearchQueueCounter = $usedCacheSlot,
            $MaxDistance = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MaxDistance else 1,
            $MinROI = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MinROI else 0,
            $MinAbsoluteProfit = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MinAbsoluteProfit else 0,
            $FactionPriority = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$FactionPriority else 1
          ]"/>
          
          <!-- Signal search pipeline to process cache results -->
          <signal_cue_instantly cue="md.GT_Trading_Search.SearchTradeRoutes" param="$resumeParams"/>
        </do_if>
        <do_elseif value="$workType == 'live_offers'">
          <!-- Live offer collection complete - route to trade matching -->
          <set_value name="global.$GT_SearchLiveTrades_State.{$ship}.$SellOffers" exact="if $result? and $result.$SellOffers? then $result.$SellOffers else []"/>
          <set_value name="global.$GT_SearchLiveTrades_State.{$ship}.$BuyOffers" exact="if $result? and $result.$BuyOffers? then $result.$BuyOffers else []"/>
          
          <!-- CRITICAL FIX: ALWAYS recalculate home sector from order settings (not from search state) -->
          <!-- This ensures trade matching distance calculations use the correct home sector that matches what other ships will use -->
          <set_value name="$homeSectorForMatching" exact="null"/>
          <run_actions ref="md.GT_Libraries_General.GT_GetHomeSector" result="$homeSectorForMatching">
            <param name="ship" value="$ship"/>
          </run_actions>
          
          <!-- Trigger trade matching work unit -->
          <set_value name="$workUnit" exact="table[
            $WorkType = 'trade_matching',
            $Ship = $ship,
            $SellOffers = if $result? and $result.$SellOffers? then $result.$SellOffers else [],
            $BuyOffers = if $result? and $result.$BuyOffers? then $result.$BuyOffers else [],
            $HomeSector = if $homeSectorForMatching? then $homeSectorForMatching else (if global.$GT_SearchLiveTrades_State? and global.$GT_SearchLiveTrades_State.{$ship}? then @global.$GT_SearchLiveTrades_State.{$ship}.$HomeSector else null),
            $MaxDistance = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MaxDistance else 1,
            $MinROI = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MinROI else 0,
            $MinAbsoluteProfit = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MinAbsoluteProfit else 0,
            $DistancePenaltyMultiplier = if global.$GT_SearchLiveTrades_State? and global.$GT_SearchLiveTrades_State.{$ship}? then @global.$GT_SearchLiveTrades_State.{$ship}.$DistancePenaltyMultiplier else 0.5,
            $FactionPriority = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$FactionPriority else 1
          ]"/>
          
          <!-- Mark as active -->
          <do_if value="not global.$GT_WorkUnits?">
            <set_value name="global.$GT_WorkUnits" exact="table[$Active = table[], $Queue = []]"/>
          </do_if>
          <set_value name="global.$GT_WorkUnits.$Active.{$ship}" exact="$workUnit"/>
          
          <!-- Signal AI work unit -->
          <signal_objects object="$ship" param="'GT_ProcessWorkUnit'" param2="$workUnit"/>
        </do_elseif>
        <do_elseif value="$workType == 'trade_matching'">
          <!-- Trade matching complete - store results and signal search pipeline -->
          <set_value name="$tradeList" exact="if $result? and $result.$Trades? then $result.$Trades else []"/>
          <set_value name="global.$GT_SearchResult.{$ship}" exact="table[
            $Found = if $result? and $result.$Found? then $result.$Found else false,
            $BestTrade = if $result? and $result.$Trade? then $result.$Trade else null,
            $TradeList = $tradeList,
            $BestScore = if $result? and $result.$BestScore? then $result.$BestScore else 0,
            $WaitingForCache = false,
            $WaitingForBatch = false
          ]"/>
          
          <!-- Clear waiting flag -->
          <do_if value="global.$GT_SearchResult.{$ship}?">
            <set_value name="global.$GT_SearchResult.{$ship}.$WaitingForBatch" exact="false"/>
          </do_if>
          
          <!-- CRITICAL: Propagate trades to cache so other ships can use them -->
          <!-- CRITICAL FIX: ALWAYS recalculate home sector from order settings (not from search state or ship's current sector) -->
          <!-- This ensures distances are calculated relative to the correct home sector that matches what other ships will use -->
          <set_value name="$homeSector" exact="null"/>
          <run_actions ref="md.GT_Libraries_General.GT_GetHomeSector" result="$homeSector">
            <param name="ship" value="$ship"/>
          </run_actions>
          
          <!-- DEBUG: Log home sector used for cache population -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$homeSectorName" exact="if $homeSector? and $homeSector.exists then @$homeSector.knownname else 'null'"/>
            <debug_text text="'[GT-WorkUnit] (' + $ship.idcode + ') Cache population using homeSector: name=' + $homeSectorName + ', tradeList.count=' + (if $tradeList? then $tradeList.count else 0)" chance="100"/>
          </do_if>
          
          <!-- Extract max distance from live search state (for cache max distance tracking) -->
          <set_value name="$cacheMaxDistance" exact="null"/>
          <do_if value="global.$GT_SearchLiveTrades_State? and global.$GT_SearchLiveTrades_State.{$ship}? and global.$GT_SearchLiveTrades_State.{$ship}.$MaxDistance?">
            <set_value name="$cacheMaxDistance" exact="global.$GT_SearchLiveTrades_State.{$ship}.$MaxDistance"/>
          </do_if>
          
          <!-- Track whether batch cache insertion is running (finalization deferred if so) -->
          <set_value name="$batchCacheInsert" exact="false"/>
          
          <!-- Propagate trades to cache if we have valid home sector and trade list -->
          <do_if value="$homeSector? and $homeSector.exists and $homeSector.isclass.sector and $tradeList? and $tradeList != null and $tradeList.count gt 0">
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-WorkUnit] (' + $ship.idcode + ') Propagating ' + $tradeList.count + ' trades to cache for home sector ' + (if $homeSector? then @$homeSector.knownname else 'null') + ' (maxDistance=' + (if $cacheMaxDistance != null then $cacheMaxDistance else 'null') + ')'" chance="100"/>
            </do_if>
            
            <!-- Initialize cache structure if needed -->
            <do_if value="not global.$GT_TradeCache? or typeof global.$GT_TradeCache != datatype.table">
              <set_value name="global.$GT_TradeCache" exact="table[]"/>
            </do_if>
            <do_if value="not global.$GT_TradeCache.{$homeSector}? or global.$GT_TradeCache.{$homeSector} == null or typeof global.$GT_TradeCache.{$homeSector} != datatype.list">
              <set_value name="global.$GT_TradeCache.{$homeSector}" exact="[]"/>
            </do_if>
            
            <!-- Track max distance used for this cache (prevents ships with larger max distance from using incomplete cache) -->
            <do_if value="$cacheMaxDistance != null and $cacheMaxDistance gt 0">
              <do_if value="not global.$GT_TradeCacheMaxDistance?">
                <set_value name="global.$GT_TradeCacheMaxDistance" exact="table[]"/>
              </do_if>
              <set_value name="$currentCacheMax" exact="0"/>
              <do_if value="global.$GT_TradeCacheMaxDistance.{$homeSector}?">
                <set_value name="$currentCacheMax" exact="global.$GT_TradeCacheMaxDistance.{$homeSector}"/>
              </do_if>
              <!-- Update to maximum of current and new (allows cache to grow as ships with larger max distance populate it) -->
              <set_value name="global.$GT_TradeCacheMaxDistance.{$homeSector}" exact="[$currentCacheMax, $cacheMaxDistance].max"/>
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-WorkUnit] (' + $ship.idcode + ') Updated cache max distance for home sector ' + @$homeSector.knownname + ': ' + $currentCacheMax + ' -> ' + global.$GT_TradeCacheMaxDistance.{$homeSector}" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- Cooperative multitasking: insert trades into cache in batches -->
            <!-- Store batch state and signal batch cue instead of processing all in one frame -->
            <do_if value="not global.$GT_CacheInsertState?">
              <set_value name="global.$GT_CacheInsertState" exact="table[]"/>
            </do_if>
            <set_value name="global.$GT_CacheInsertState.{$ship}" exact="table[
              $TradeList = $tradeList,
              $HomeSector = $homeSector,
              $Ship = $ship,
              $Index = 1,
              $BatchSize = 10
            ]"/>
            <set_value name="$batchCacheInsert" exact="true"/>
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Coordinator] (' + $ship.idcode + ') Starting batched cache insertion for ' + $tradeList.count + ' trades (home=' + @$homeSector.knownname + ')'" chance="100"/>
            </do_if>
            <signal_cue_instantly cue="md.GT_WorkUnit_Coordinator.InsertTradesToCache_Batch" param="$ship"/>
          </do_if>
          
          <!-- Only do immediate finalization if NOT batching (deferred to batch completion otherwise) -->
          <do_if value="not $batchCacheInsert">
          <!-- CRITICAL FIX: Signal HomeRefreshFinished AFTER cache is populated -->
          <!-- This ensures waiters check cache AFTER it's populated, not before -->
          <!-- Cache is now populated, so ships waiting for home refresh can use it -->
          <do_if value="$homeSector? and $homeSector.exists">
            <!-- Initialize entry if missing (shouldn't happen, but be safe) -->
            <do_if value="not global.$GT_TS_LiveRefreshBySector?">
              <set_value name="global.$GT_TS_LiveRefreshBySector" exact="table[]"/>
            </do_if>
            <do_if value="not global.$GT_TS_LiveRefreshBySector.{$homeSector}?">
              <set_value name="global.$GT_TS_LiveRefreshBySector.{$homeSector}" exact="table[$Active = false, $Waiters = [], $WaiterQueued = table[]]"/>
            </do_if>
            
            <!-- Log for debugging -->
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <set_value name="$hasWaiters" exact="false"/>
              <do_if value="global.$GT_TS_LiveRefreshBySector.{$homeSector}.$Waiters? and global.$GT_TS_LiveRefreshBySector.{$homeSector}.$Waiters.count gt 0">
                <set_value name="$hasWaiters" exact="true"/>
              </do_if>
              <debug_text text="'[GT-Coordinator] (' + $ship.idcode + ') Signaling HomeRefreshFinished for home=' + @$homeSector.knownname + ' (hasWaiters=' + $hasWaiters + ', waiters.count=' + (if global.$GT_TS_LiveRefreshBySector.{$homeSector}.$Waiters? then global.$GT_TS_LiveRefreshBySector.{$homeSector}.$Waiters.count else 0) + ')'" chance="100"/>
            </do_if>
            
            <set_value name="global.$GT_TS_LiveRefreshBySector.{$homeSector}.$Active" exact="false"/>
            <set_value name="global.$GT_TS_LiveRefreshBySector.{$homeSector}.$LastFinished" exact="player.age"/>
            <!-- Wake any ships waiting silently for this home-sector refresh to finish -->
            <!-- Cache is now populated, so waiters will find trades in cache -->
            <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.HomeRefreshFinished" param="$homeSector"/>
          </do_if>
          <do_else>
            <!-- Log if homeSector is missing -->
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Coordinator] (' + $ship.idcode + ') WARNING: Cannot signal HomeRefreshFinished - homeSector is null or invalid (homeSector?=' + ($homeSector? and $homeSector.exists) + ')'" chance="100"/>
            </do_if>
          </do_else>
          
          <!-- Signal search pipeline to process live results -->
          <!-- CRITICAL FIX: Pass UseSearchQueueCounter so cache search slot is released when live results are processed -->
          <!-- Note: Slot should already be released when live search was triggered, but pass flag for safety -->
          <set_value name="$usedCacheSlot" exact="false"/>
          <do_if value="global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}?">
            <set_value name="$usedCacheSlot" exact="true"/>
          </do_if>
          <signal_cue_instantly cue="md.GT_Trading_Search.SearchTradeRoutes" param="table[
            $Ship = $ship,
            $SearchState = 'live',
            $UseSearchQueueCounter = $usedCacheSlot,
            $MaxDistance = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MaxDistance else 1,
            $MinROI = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MinROI else 0,
            $MinAbsoluteProfit = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MinAbsoluteProfit else 0,
            $FactionPriority = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$FactionPriority else 1
          ]"/>
          </do_if>
        </do_elseif>
      </actions>
    </cue>
    
    <!-- ===================================================================== -->
    <!-- Batched Cache Insertion                                                -->
    <!-- Inserts trades into cache in batches for cooperative multitasking      -->
    <!-- ===================================================================== -->
    <cue name="InsertTradesToCache_Batch" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <delay exact="1ms"/>
      <actions>
        <set_value name="$ship" exact="event.param"/>
        
        <!-- Validate batch state exists -->
        <do_if value="not global.$GT_CacheInsertState? or not global.$GT_CacheInsertState.{$ship}?">
          <!-- Batch state missing - nothing to process -->
          <cancel_cue cue="this"/>
        </do_if>
        <do_else>
          <set_value name="$state" exact="global.$GT_CacheInsertState.{$ship}"/>
          <set_value name="$tradeList" exact="$state.$TradeList"/>
          <set_value name="$homeSector" exact="$state.$HomeSector"/>
          <set_value name="$batchStart" exact="$state.$Index"/>
          <set_value name="$batchEnd" exact="[$batchStart + $state.$BatchSize - 1, $tradeList.count].min"/>
          
          <!-- Process batch of trades -->
          <do_all exact="$batchEnd - $batchStart + 1" counter="$offset">
            <set_value name="$idx" exact="$batchStart + $offset - 1"/>
            <set_value name="$trade" exact="$tradeList.{$idx}"/>
            <do_if value="$trade? and $trade != null">
              <!-- Extract buy/sell offers from trade -->
              <set_value name="$buyOffer" exact="@$trade.$BuyOffer"/>
              <set_value name="$sellOffer" exact="@$trade.$SellOffer"/>
              
              <!-- Generate trade key and add to cache -->
              <do_if value="$buyOffer? and $buyOffer.exists and $sellOffer? and $sellOffer.exists">
                <set_value name="$tradeKey" exact="''"/>
                <run_actions ref="md.GT_Libraries_General.GT_GenerateTradeKey" result="$tradeKey">
                  <param name="buyOffer" value="$buyOffer"/>
                  <param name="sellOffer" value="$sellOffer"/>
                  <param name="traceId" value="''"/>
                </run_actions>
                
                <do_if value="$tradeKey != '' and $tradeKey != 'null_null'">
                  <set_value name="$ware" exact="null"/>
                  <do_if value="$sellOffer? and $sellOffer.ware?">
                    <set_value name="$ware" exact="$sellOffer.ware"/>
                  </do_if>
                  <do_elseif value="$buyOffer? and $buyOffer.ware?">
                    <set_value name="$ware" exact="$buyOffer.ware"/>
                  </do_elseif>
                  <set_value name="$buyPrice" exact="if $trade.$BuyPrice? then $trade.$BuyPrice else (if $buyOffer.unitprice? then $buyOffer.unitprice else 0)"/>
                  <set_value name="$sellPrice" exact="if $trade.$SellPrice? then $trade.$SellPrice else (if $sellOffer.unitprice? then $sellOffer.unitprice else 0)"/>
                  <set_value name="$profit" exact="if $trade.$Profit? then $trade.$Profit else 0"/>
                  <set_value name="$roi" exact="if $trade.$ROI? then $trade.$ROI else 0"/>
                  <set_value name="$amount" exact="if $trade.$Amount? then $trade.$Amount else (if $buyOffer.amount? and $sellOffer.amount? then [$buyOffer.amount, $sellOffer.amount].min else 0)"/>
                  <set_value name="$distance" exact="if $trade.$Distance? then $trade.$Distance else 0"/>
                  <set_value name="$score" exact="if $trade.$Score? then $trade.$Score else $profit"/>
                  
                  <set_value name="$buyStationId" exact="if $buyOffer.owner? and $buyOffer.owner.exists then $buyOffer.owner.idcode else ''"/>
                  <set_value name="$sellStationId" exact="if $sellOffer.owner? and $sellOffer.owner.exists then $sellOffer.owner.idcode else ''"/>
                  
                  <!-- Compute distances from home sector -->
                  <set_value name="$buySector" exact="null"/>
                  <set_value name="$sellSector" exact="null"/>
                  <do_if value="$buyOffer.owner? and $buyOffer.owner.exists">
                    <set_value name="$buySector" exact="$buyOffer.owner.sector"/>
                  </do_if>
                  <do_if value="$sellOffer.owner? and $sellOffer.owner.exists">
                    <set_value name="$sellSector" exact="$sellOffer.owner.sector"/>
                  </do_if>
                  <set_value name="$homeToBuyDistance" exact="-1"/>
                  <set_value name="$homeToSellDistance" exact="-1"/>
                  <do_if value="$buySector? and $sellSector? and $homeSector? and $homeSector.exists and $homeSector.isclass.sector">
                    <set_value name="$homeToBuyDistance" exact="$homeSector.gatedistance.{$buySector}"/>
                    <set_value name="$homeToSellDistance" exact="$homeSector.gatedistance.{$sellSector}"/>
                    <do_if value="$homeToBuyDistance lt 0">
                      <set_value name="$homeToBuyDistance" exact="-1"/>
                    </do_if>
                    <do_if value="$homeToSellDistance lt 0">
                      <set_value name="$homeToSellDistance" exact="-1"/>
                    </do_if>
                  </do_if>
                  
                  <!-- Get trade rules setting -->
                  <set_value name="$ignoreTradeRules" exact="false"/>
                  <do_if value="global.$GT_AIParameters? and global.$GT_AIParameters.{$ship}? and global.$GT_AIParameters.{$ship}.$IgnoreTradeRules?">
                    <set_value name="$ignoreTradeRules" exact="global.$GT_AIParameters.{$ship}.$IgnoreTradeRules"/>
                  </do_if>
                  <set_value name="$tradeRulesRespected" exact="not $ignoreTradeRules"/>
                  
                  <!-- Compute dock caps (with DockCapsCache) -->
                  <set_value name="$buyStation" exact="@$buyOffer.owner"/>
                  <set_value name="$buyDockCaps" exact="null"/>
                  <do_if value="$buyStation? and $buyStation.exists">
                    <do_if value="not global.$GT_DockCapsCache?">
                      <set_value name="global.$GT_DockCapsCache" exact="table[]"/>
                    </do_if>
                    <do_if value="global.$GT_DockCapsCache.{$buyStation}?">
                      <set_value name="$buyDockCaps" exact="global.$GT_DockCapsCache.{$buyStation}"/>
                    </do_if>
                    <do_else>
                      <set_value name="$buyDockCaps" exact="table[$S=false, $M=false, $L=false, $XL=false]"/>
                      <find_dockingbay name="$buyDockS" object="$buyStation" checkoperational="true" multiple="false">
                        <match_dock size="tag.dock_s" storage="false"/>
                      </find_dockingbay>
                      <do_if value="$buyDockS">
                        <set_value name="$buyDockCaps.$S" exact="true"/>
                      </do_if>
                      <find_dockingbay name="$buyDockM" object="$buyStation" checkoperational="true" multiple="false">
                        <match_dock size="tag.dock_m" storage="false"/>
                      </find_dockingbay>
                      <do_if value="$buyDockM">
                        <set_value name="$buyDockCaps.$M" exact="true"/>
                      </do_if>
                      <find_dockingbay name="$buyDockL" object="$buyStation" checkoperational="true" multiple="false">
                        <match_dock size="tag.dock_l" storage="false"/>
                      </find_dockingbay>
                      <do_if value="$buyDockL">
                        <set_value name="$buyDockCaps.$L" exact="true"/>
                      </do_if>
                      <find_dockingbay name="$buyDockXL" object="$buyStation" checkoperational="true" multiple="false">
                        <match_dock size="tag.dock_xl" storage="false"/>
                      </find_dockingbay>
                      <do_if value="$buyDockXL">
                        <set_value name="$buyDockCaps.$XL" exact="true"/>
                      </do_if>
                      <set_value name="global.$GT_DockCapsCache.{$buyStation}" exact="$buyDockCaps"/>
                    </do_else>
                  </do_if>
                  
                  <set_value name="$sellStation" exact="@$sellOffer.owner"/>
                  <set_value name="$sellDockCaps" exact="null"/>
                  <do_if value="$sellStation? and $sellStation.exists">
                    <do_if value="not global.$GT_DockCapsCache?">
                      <set_value name="global.$GT_DockCapsCache" exact="table[]"/>
                    </do_if>
                    <do_if value="global.$GT_DockCapsCache.{$sellStation}?">
                      <set_value name="$sellDockCaps" exact="global.$GT_DockCapsCache.{$sellStation}"/>
                    </do_if>
                    <do_else>
                      <set_value name="$sellDockCaps" exact="table[$S=false, $M=false, $L=false, $XL=false]"/>
                      <find_dockingbay name="$sellDockS" object="$sellStation" checkoperational="true" multiple="false">
                        <match_dock size="tag.dock_s" storage="false"/>
                      </find_dockingbay>
                      <do_if value="$sellDockS">
                        <set_value name="$sellDockCaps.$S" exact="true"/>
                      </do_if>
                      <find_dockingbay name="$sellDockM" object="$sellStation" checkoperational="true" multiple="false">
                        <match_dock size="tag.dock_m" storage="false"/>
                      </find_dockingbay>
                      <do_if value="$sellDockM">
                        <set_value name="$sellDockCaps.$M" exact="true"/>
                      </do_if>
                      <find_dockingbay name="$sellDockL" object="$sellStation" checkoperational="true" multiple="false">
                        <match_dock size="tag.dock_l" storage="false"/>
                      </find_dockingbay>
                      <do_if value="$sellDockL">
                        <set_value name="$sellDockCaps.$L" exact="true"/>
                      </do_if>
                      <find_dockingbay name="$sellDockXL" object="$sellStation" checkoperational="true" multiple="false">
                        <match_dock size="tag.dock_xl" storage="false"/>
                      </find_dockingbay>
                      <do_if value="$sellDockXL">
                        <set_value name="$sellDockCaps.$XL" exact="true"/>
                      </do_if>
                      <set_value name="global.$GT_DockCapsCache.{$sellStation}" exact="$sellDockCaps"/>
                    </do_else>
                  </do_if>
                  
                  <!-- Create cache entry -->
                  <set_value name="$cacheEntry" exact="table[
                    $WareId = if $ware? then (if $ware.id? then $ware.id else '') else '',
                    $Ware = $ware,
                    $WareName = if $ware? then (if $ware.name? then $ware.name else '') else '',
                    $SellStationId = $buyStationId,
                    $BuyStationId = $sellStationId,
                    $BuyOffer = $buyOffer,
                    $SellOffer = $sellOffer,
                    $BuyTargetType = if $buyOffer.owner? and $buyOffer.owner.exists then $buyOffer.owner.class else null,
                    $SellTargetType = if $sellOffer.owner? and $sellOffer.owner.exists then $sellOffer.owner.class else null,
                    $BuyDockCaps = $buyDockCaps,
                    $SellDockCaps = $sellDockCaps,
                    $TradeRulesRespected = $tradeRulesRespected,
                    $OfferMaxAmount = $amount,
                    $ProfitPerUnit = if $amount gt 0 then ($profit / $amount) else 0,
                    $VolumePerUnit = if $ware? and $ware.volume? then $ware.volume else 0,
                    $Amount = $amount,
                    $TotalVolume = if $ware? and $ware.volume? then ($ware.volume * $amount) else 0,
                    $Profit = $profit,
                    $ROI = $roi,
                    $BuyPrice = $buyPrice,
                    $SellPrice = $sellPrice,
                    $Distance = $distance,
                    $Timestamp = player.age,
                    $HomeSector = $homeSector,
                    $HomeToBuyDistance = $homeToBuyDistance,
                    $HomeToSellDistance = $homeToSellDistance,
                    $FailCount = 0,
                    $FailedShips = [],
                    $Score = $score
                  ]"/>
                  
                  <!-- Insert in sorted order (by score descending) -->
                  <set_value name="$homeSectorCache" exact="global.$GT_TradeCache.{$homeSector}"/>
                  <set_value name="$insertIndex" exact="0"/>
                  <set_value name="$insertionFound" exact="false"/>
                  <do_if value="$homeSectorCache.count gt 0">
                    <do_all exact="$homeSectorCache.count" counter="$j">
                      <set_value name="$existingScore" exact="if $homeSectorCache.{$j}.$Score? then $homeSectorCache.{$j}.$Score else 0"/>
                      <do_if value="$score gt $existingScore">
                        <set_value name="$insertIndex" exact="$j"/>
                        <set_value name="$insertionFound" exact="true"/>
                        <break/>
                      </do_if>
                    </do_all>
                  </do_if>
                  
                  <do_if value="$insertionFound">
                    <set_value name="global.$GT_TradeCache.{$homeSector}.{$insertIndex}" exact="$cacheEntry" operation="insert"/>
                  </do_if>
                  <do_else>
                    <append_to_list name="global.$GT_TradeCache.{$homeSector}" exact="$cacheEntry"/>
                  </do_else>
                  
                  <run_actions ref="md.GT_Libraries_General.GT_AddTradeToIndex">
                    <param name="tradeKey" value="$tradeKey"/>
                    <param name="homeSector" value="$homeSector"/>
                    <param name="traceId" value="if $ship? then $ship.idcode else '0'"/>
                  </run_actions>
                  
                  <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-Coordinator] (' + $ship.idcode + ') Added trade to cache: ' + $tradeKey + ' for home sector ' + $homeSector.knownname + ' (profit=' + ($profit/100) + ' Cr, cache size=' + global.$GT_TradeCache.{$homeSector}.count + ')'" chance="10"/>
                  </do_if>
                </do_if>
              </do_if>
            </do_if>
          </do_all>
          
          <!-- Update batch state -->
          <set_value name="global.$GT_CacheInsertState.{$ship}.$Index" exact="$batchEnd + 1"/>
          
          <!-- Check if more batches needed -->
          <do_if value="$batchEnd lt $tradeList.count">
            <!-- More trades to process - signal next batch -->
            <signal_cue_instantly cue="md.GT_WorkUnit_Coordinator.InsertTradesToCache_Batch" param="$ship"/>
          </do_if>
          <do_else>
            <!-- All trades inserted - do finalization (HomeRefreshFinished + SearchTradeRoutes) -->
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Coordinator] (' + $ship.idcode + ') Batched cache insertion complete (' + $tradeList.count + ' trades). Signaling finalization.'" chance="100"/>
            </do_if>
            
            <!-- Cleanup batch state -->
            <remove_value name="global.$GT_CacheInsertState.{$ship}"/>
            
            <!-- Signal HomeRefreshFinished -->
            <do_if value="$homeSector? and $homeSector.exists">
              <do_if value="not global.$GT_TS_LiveRefreshBySector?">
                <set_value name="global.$GT_TS_LiveRefreshBySector" exact="table[]"/>
              </do_if>
              <do_if value="not global.$GT_TS_LiveRefreshBySector.{$homeSector}?">
                <set_value name="global.$GT_TS_LiveRefreshBySector.{$homeSector}" exact="table[$Active = false, $Waiters = [], $WaiterQueued = table[]]"/>
              </do_if>
              
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <set_value name="$hasWaiters" exact="false"/>
                <do_if value="global.$GT_TS_LiveRefreshBySector.{$homeSector}.$Waiters? and global.$GT_TS_LiveRefreshBySector.{$homeSector}.$Waiters.count gt 0">
                  <set_value name="$hasWaiters" exact="true"/>
                </do_if>
                <debug_text text="'[GT-Coordinator] (' + $ship.idcode + ') Signaling HomeRefreshFinished for home=' + @$homeSector.knownname + ' (hasWaiters=' + $hasWaiters + ', waiters.count=' + (if global.$GT_TS_LiveRefreshBySector.{$homeSector}.$Waiters? then global.$GT_TS_LiveRefreshBySector.{$homeSector}.$Waiters.count else 0) + ')'" chance="100"/>
              </do_if>
              
              <set_value name="global.$GT_TS_LiveRefreshBySector.{$homeSector}.$Active" exact="false"/>
              <set_value name="global.$GT_TS_LiveRefreshBySector.{$homeSector}.$LastFinished" exact="player.age"/>
              <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.HomeRefreshFinished" param="$homeSector"/>
            </do_if>
            <do_else>
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Coordinator] (' + $ship.idcode + ') WARNING: Cannot signal HomeRefreshFinished - homeSector is null or invalid'" chance="100"/>
              </do_if>
            </do_else>
            
            <!-- Signal search pipeline to process live results -->
            <set_value name="$usedCacheSlot" exact="false"/>
            <do_if value="global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}?">
              <set_value name="$usedCacheSlot" exact="true"/>
            </do_if>
            <signal_cue_instantly cue="md.GT_Trading_Search.SearchTradeRoutes" param="table[
              $Ship = $ship,
              $SearchState = 'live',
              $UseSearchQueueCounter = $usedCacheSlot,
              $MaxDistance = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MaxDistance else 1,
              $MinROI = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MinROI else 0,
              $MinAbsoluteProfit = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$MinAbsoluteProfit else 0,
              $FactionPriority = if global.$GT_SearchQueue? and global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}? then @global.$GT_SearchQueue.$Params.{$ship}.$FactionPriority else 1
            ]"/>
          </do_else>
        </do_else>
      </actions>
    </cue>
    
    <!-- Handle offer filtering request from AI -->
    <cue name="FilterWorkUnitOffers" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_FilterWorkUnitOffers'"/>
      </conditions>
      <actions>
        <set_value name="$data" exact="event.param2"/>
        <set_value name="$ship" exact="$data.$Ship"/>
        
        <!-- Get offers from global state -->
        <set_value name="$offerData" exact="@global.$GT_WorkUnitOffers.{$ship}"/>
        <do_if value="$offerData?">
          <set_value name="$sellOffers" exact="$offerData.$SellOffers"/>
          <set_value name="$buyOffers" exact="$offerData.$BuyOffers"/>
          <set_value name="$homeSector" exact="$offerData.$HomeSector"/>
          <set_value name="$maxDistance" exact="$offerData.$MaxDistance"/>
          
          <!-- Filter offers by distance using MD library -->
          <run_actions ref="md.GT_Libraries_General.GT_FilterOffersByDistance" result="$filteredSell">
            <param name="offersList" value="$sellOffers"/>
            <param name="homeSector" value="$homeSector"/>
            <param name="maxDistance" value="$maxDistance"/>
          </run_actions>
          <run_actions ref="md.GT_Libraries_General.GT_FilterOffersByDistance" result="$filteredBuy">
            <param name="offersList" value="$buyOffers"/>
            <param name="homeSector" value="$homeSector"/>
            <param name="maxDistance" value="$maxDistance"/>
          </run_actions>
          
          <!-- Store filtered results -->
          <set_value name="global.$GT_WorkUnitOffersFiltered.{$ship}" exact="table[
            $SellOffers = if $filteredSell? and $filteredSell.$FilteredOffers? then $filteredSell.$FilteredOffers else [],
            $BuyOffers = if $filteredBuy? and $filteredBuy.$FilteredOffers? then $filteredBuy.$FilteredOffers else []
          ]"/>
          
          <!-- Signal AI that filtering is complete -->
          <signal_objects object="$ship" param="'GT_WorkUnitOffersFiltered'"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Queue work unit for processing -->
    <cue name="QueueWorkUnit" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$workUnit" exact="event.param"/>
        <set_value name="$ship" exact="$workUnit.$Ship"/>
        <set_value name="$workType" exact="if $workUnit.$WorkType? then $workUnit.$WorkType else 'unknown'"/>
        <set_value name="$traceId" exact="if $workUnit.$TraceId? then $workUnit.$TraceId else '0'"/>
        
        <!-- Initialize structures if needed -->
        <do_if value="not global.$GT_WorkUnits?">
          <set_value name="global.$GT_WorkUnits" exact="table[$Active = table[], $Queue = []]"/>
        </do_if>
        
        <!-- Check if ship already has active work unit -->
        <set_value name="$hasActive" exact="false"/>
        <do_if value="global.$GT_WorkUnits.$Active? and global.$GT_WorkUnits.$Active.{$ship}?">
          <set_value name="$hasActive" exact="true"/>
        </do_if>
        
        <!-- Queue if already active, otherwise start immediately -->
        <do_if value="$hasActive">
          <!-- Add to queue -->
          <do_if value="not global.$GT_WorkUnits.$Queue?">
            <set_value name="global.$GT_WorkUnits.$Queue" exact="[]"/>
          </do_if>
          <append_to_list name="global.$GT_WorkUnits.$Queue" exact="$workUnit"/>
          
          <!-- Log queuing -->
          <run_actions ref="md.GT_Libraries_General.GT_LogTradeSearch">
            <param name="traceId" value="$traceId"/>
            <param name="stage" value="'WorkUnitCoordinator'"/>
            <param name="action" value="'WorkUnitQueued'"/>
            <param name="details" value="'ship=' + $ship.idcode + ' type=' + $workType + ' (ship has active work unit)'"/>
            <param name="logLevel" value="1"/>
          </run_actions>
        </do_if>
        <do_else>
          <!-- Validate ship before signaling -->
          <do_if value="not $ship? or not $ship.exists">
            <run_actions ref="md.GT_Libraries_General.GT_LogTradeSearch">
              <param name="traceId" value="$traceId"/>
              <param name="stage" value="'WorkUnitCoordinator'"/>
              <param name="action" value="'Error'"/>
              <param name="details" value="'reason=invalid_ship_reference ship=' + (if $ship? then $ship.idcode else 'null') + ' type=' + $workType"/>
              <param name="logLevel" value="0"/>
            </run_actions>
          </do_if>
          <do_else>
            <!-- Start immediately -->
            <set_value name="global.$GT_WorkUnits.$Active.{$ship}" exact="$workUnit"/>
            
            <!-- Log signaling -->
            <run_actions ref="md.GT_Libraries_General.GT_LogTradeSearch">
              <param name="traceId" value="$traceId"/>
              <param name="stage" value="'WorkUnitCoordinator'"/>
              <param name="action" value="'WorkUnitSignaled'"/>
              <param name="details" value="'ship=' + $ship.idcode + ' type=' + $workType + ' signaling AI script'"/>
              <param name="logLevel" value="1"/>
            </run_actions>
            
            <signal_objects object="$ship" param="'GT_ProcessWorkUnit'" param2="$workUnit"/>
          </do_else>
        </do_else>
      </actions>
    </cue>
  </cues>
</mdscript>
