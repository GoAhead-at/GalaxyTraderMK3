<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Debug" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- Debug Commands Initialization -->
    <cue name="DebugInit" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_CoreSystem.SystemInit"/>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3 Debug] Debug system initialized'" chance="100"/>
        <debug_text text="'[GalaxyTrader MK3 Debug] Available commands:'" chance="100"/>
        <debug_text text="'- /gt status - Show mod status'" chance="100"/>
        <debug_text text="'- /gt ship [shipname] - Show ship details'" chance="100"/>
        <debug_text text="'- /gt xp [shipname] [amount] - Award XP to ships pilot'" chance="100"/>
        <debug_text text="'- /gt level [shipname] [level] - Set ship level'" chance="100"/>
        <debug_text text="'- /gt report [type] - Generate report (fleet/market/territory)'" chance="100"/>
        <debug_text text="'- /gt dashboard - Show quick dashboard'" chance="100"/>
      </actions>
    </cue>
    
    <!-- Periodic Debug Status -->
    <cue name="PeriodicDebugStatus" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_CoreSystem.SystemInit"/>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3 Debug] Starting periodic debug status (every 5 minutes)'" chance="100"/>
      </actions>
      <cues>
        <cue name="StatusLoop" instantiate="true">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$registeredShips" exact="global.$GT_Ships.keys.count"/>
            <set_value name="$activeTraders" exact="0"/>
            <set_value name="$blockedShips" exact="0"/>
            <set_value name="$trainingShips" exact="0"/>
            
            <!-- Count ship states -->
            <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
              <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
              <do_all exact="$shipKeys.count" counter="$i">
                <set_value name="$ship" exact="$shipKeys.{$i}"/>
                <set_value name="$shipData" exact="global.$GT_Ships.{$ship}"/>
                
                <do_if value="$shipData.$XPBlocked?">
                  <set_value name="$blockedShips" operation="add"/>
                </do_if>
                <do_elseif value="$shipData.$TrainingStarted?">
                  <set_value name="$trainingShips" operation="add"/>
                </do_elseif>
                <do_else>
                  <set_value name="$activeTraders" operation="add"/>
                </do_else>
              </do_all>
            </do_if>
            
            <debug_text text="'[GalaxyTrader MK3] Status: %s ships registered (%s active, %s blocked, %s training)'.[$registeredShips, $activeTraders, $blockedShips, $trainingShips]" chance="100"/>
            <debug_text text="'[GalaxyTrader MK3] Session Profit: %s Cr, Trades: %s'.[global.$GT_SessionStats.$TotalProfit, global.$GT_SessionStats.$TradesCompleted]" chance="100"/>
          </actions>
          <cues>
            <cue name="StatusDelay" checkinterval="5min">
              <conditions>
                <check_value value="true"/>
              </conditions>
              <actions>
                <reset_cue cue="StatusLoop"/>
              </actions>
            </cue>
          </cues>
        </cue>
      </cues>
    </cue>
    
    <!-- Show Status -->
    <cue name="ShowStatus" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$status" exact="'=== GALAXYTRADER MK3 STATUS ===\n\n'"/>
        
        <!-- System status -->
        <set_value name="$status" exact="$status + 'System Status:\n'"/>
        <set_value name="$status" exact="$status + '- Ships Registered: ' + if global.$GT_Ships? then global.$GT_Ships.keys.count else 0 + '\n'"/>
        <set_value name="$status" exact="$status + '- Pilots Registered: ' + if global.$GT_Pilots? then global.$GT_Pilots.keys.count else 0 + '\n'"/>
        <set_value name="$status" exact="$status + '- XP System: ' + if global.$GT_Config.$XP.$Enabled then 'Enabled' else 'Disabled' + '\n'"/>
        <set_value name="$status" exact="$status + '- Fleet Coordination: ' + if global.$GT_Config.$Fleet.$Enabled then 'Enabled' else 'Disabled' + '\n'"/>
        <set_value name="$status" exact="$status + '- Market Intelligence: ' + if global.$GT_Config.$Market.$TrendAnalysis then 'Enabled' else 'Disabled' + '\n'"/>
        <set_value name="$status" exact="$status + '- Territory Management: ' + if global.$GT_Config.$Fleet.$TerritoryManagement then 'Enabled' else 'Disabled' + '\n\n'"/>
        
        <!-- Session stats -->
        <set_value name="$sessionTime" exact="player.age - global.$GT_SessionStats.$StartTime"/>
        <set_value name="$hours" exact="($sessionTime / 3600)i"/>
        <set_value name="$minutes" exact="(($sessionTime - ($hours * 3600)) / 60)i"/>
        
        <set_value name="$status" exact="$status + 'Session Stats:\n'"/>
        <set_value name="$status" exact="$status + '- Session Duration: ' + $hours + 'h ' + $minutes + 'm\n'"/>
        <set_value name="$status" exact="$status + '- Total Session Profit: ' + (global.$GT_SessionStats.$TotalProfit / 100) + ' Cr\n'"/>
        <set_value name="$status" exact="$status + '- Total Trades Completed: ' + global.$GT_SessionStats.$TradesCompleted + '\n'"/>
        
        <show_notification text="$status" timeout="15s" priority="5"/>
      </actions>
    </cue>
    
    <!-- Show Ship Details -->
    <cue name="ShowShipDetails" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$shipname" exact="global.$GT_Debug_ShipName"/>
        
        <!-- Find ship by name -->
        <set_value name="$foundship" exact="null"/>
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
          <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
          <do_all exact="$shipKeys.count" counter="$i">
            <set_value name="$ship" exact="$shipKeys.{$i}"/>
            <do_if value="$ship.knownname.{$shipname}?">
              <set_value name="$foundship" exact="$ship"/>
              <break/>
            </do_if>
          </do_all>
        </do_if>
        
        <do_if value="$foundship">
          <set_value name="$pilot" exact="$foundship.pilot"/>
          <set_value name="$details" exact="'=== SHIP/PILOT DETAILS ===\n\n'"/>
          <set_value name="$details" exact="$details + 'Ship: ' + $foundship.knownname + ' (' + $foundship.idcode + ')\n'"/>
          
          <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
            <set_value name="$pilotdata" exact="global.$GT_Pilots.{$pilot}"/>
            <set_value name="$details" exact="$details + 'Pilot: ' + $pilot.name + '\n'"/>
            <set_value name="$details" exact="$details + 'Level: ' + $pilotdata.$Level + '\n'"/>
            <set_value name="$details" exact="$details + 'XP: ' + $pilotdata.$XP + '/' + if global.$GT_Config.$XP.$LevelRequirements.{$pilotdata.$Level + 1}? then global.$GT_Config.$XP.$LevelRequirements.{$pilotdata.$Level + 1} else 'MAX' + '\n'"/>
            <set_value name="$details" exact="$details + 'Total Trades: ' + $pilotdata.$TotalTrades + '\n'"/>
            <set_value name="$details" exact="$details + 'Last Trade Profit: ' + ($pilotdata.$LastTradeProfit / 100) + ' Cr\n'"/>
            
            <!-- PERFORMANCE INFORMATION DISPLAY -->
            <do_if value="global.$GT_Ships.{$foundship}?">
              <set_value name="$shipData" exact="global.$GT_Ships.{$foundship}"/>
              <do_if value="$shipData.$PerformanceInfo?">
                <set_value name="$details" exact="$details + '\n=== PERFORMANCE BONUSES ===\n'"/>
                <set_value name="$details" exact="$details + $shipData.$PerformanceInfo + '\n'"/>
                <set_value name="$details" exact="$details + 'Performance Modifier: ' + $shipData.$PerformanceModifier + '%\n'"/>
                <set_value name="$details" exact="$details + 'Status: ' + $shipData.$PerformanceStatus + '\n'"/>
                <set_value name="$details" exact="$details + 'Pilot Level: ' + $shipData.$PerformanceLevel + '\n'"/>
              </do_if>
              <do_else>
                <set_value name="$details" exact="$details + '\n=== PERFORMANCE BONUSES ===\n'"/>
                <set_value name="$details" exact="$details + 'Performance data not available\n'"/>
              </do_else>
            </do_if>
            
            <do_if value="$pilotdata.$XPBlocked?">
              <set_value name="$details" exact="$details + '\nStatus: BLOCKED FOR TRAINING (Level ' + $pilotdata.$BlockedLevel + ')\n'"/>
            </do_if>
            <do_elseif value="$pilotdata.$TrainingStarted?">
              <set_value name="$details" exact="$details + '\nStatus: IN TRAINING\n'"/>
            </do_elseif>
            <do_else>
              <set_value name="$details" exact="$details + '\nStatus: ACTIVE\n'"/>
            </do_else>
          </do_if>
          <do_else>
            <set_value name="$details" exact="$details + 'Pilot: NO PILOT or NOT REGISTERED\n'"/>
          </do_else>
          
          <show_notification text="$details" timeout="10s" priority="5"/>
        </do_if>
        <do_else>
          <show_notification text="'Ship not found: ' + $shipname" timeout="5s"/>
        </do_else>
      </actions>
    </cue>
    
    <!-- Award Debug XP -->
    <cue name="AwardDebugXP" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$params" exact="global.$GT_Debug_XPCommand"/>
        
        <!-- Parse parameters (simple split by space) -->
        <set_value name="$spaceindex" exact="1"/>
        <do_if value="$spaceindex gt 0">
          <set_value name="$shipname" exact="$params"/>
          <set_value name="$xpamount" exact="100"/>
          
          <!-- Find ship -->
          <set_value name="$foundship" exact="null"/>
          <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
            <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
            <do_all exact="$shipKeys.count" counter="$i">
              <set_value name="$ship" exact="$shipKeys.{$i}"/>
              <do_if value="$ship.knownname.{$shipname}?">
                <set_value name="$foundship" exact="$ship"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>
          
          <do_if value="$foundship">
            <set_value name="$pilot" exact="$foundship.pilot"/>
            <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
              <!-- Award XP to pilot -->
              <set_value name="global.$GT_Pilots.{$pilot}.$PendingXP" exact="$xpamount"/>
                        <!-- PHASE 1 IMPROVEMENT: Use event queue instead of polling -->
          <do_if value="not global.$GT_XPEventQueue?">
            <set_value name="global.$GT_XPEventQueue" exact="[]"/>
          </do_if>
          
          <append_to_list name="global.$GT_XPEventQueue" exact="table[
              $pilot = $pilot,
              $ship = $foundship,
              $xpAmount = 100,
              $ware = ware.energycells,
              $timestamp = player.age
          ]"/>
          <set_value name="global.$GT_XPEventPending" exact="true"/>
              
              <show_notification text="'Awarded ' + $xpamount + ' XP to pilot ' + $pilot.name + ' on ' + $foundship.knownname" timeout="5s"/>
            </do_if>
            <do_else>
              <show_notification text="'Ship has no pilot or pilot not registered'" timeout="5s"/>
            </do_else>
          </do_if>
          <do_else>
            <show_notification text="'Ship not found: ' + $shipname" timeout="5s"/>
          </do_else>
        </do_if>
        <do_else>
          <show_notification text="'Invalid XP command format. Use: /gt xp shipname amount'" timeout="5s"/>
        </do_else>
      </actions>
    </cue>
    
    <!-- Set Debug Level -->
    <cue name="SetDebugLevel" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$params" exact="global.$GT_Debug_LevelCommand"/>
        
        <!-- Parse parameters -->
        <set_value name="$spaceindex" exact="1"/>
        <do_if value="$spaceindex gt 0">
          <set_value name="$shipname" exact="$params"/>
          <set_value name="$level" exact="5"/>
          
          <!-- Find ship -->
          <set_value name="$foundship" exact="null"/>
          <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
            <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
            <do_all exact="$shipKeys.count" counter="$i">
              <set_value name="$ship" exact="$shipKeys.{$i}"/>
              <do_if value="$ship.knownname.{$shipname}?">
                <set_value name="$foundship" exact="$ship"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>
          
          <do_if value="$foundship and ($level ge 0) and ($level le 10)">
            <set_value name="$pilot" exact="$foundship.pilot"/>
            <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
              <!-- Set level for pilot -->
              <set_value name="global.$GT_Pilots.{$pilot}.$Level" exact="$level"/>
              <set_value name="global.$GT_Pilots.{$pilot}.$XP" exact="0"/>
              
              <!-- Clear any blocks -->
              <remove_value name="global.$GT_Pilots.{$pilot}.$XPBlocked"/>
              <remove_value name="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
              
              <show_notification text="'Set pilot ' + $pilot.name + ' on ' + $foundship.knownname + ' to level ' + $level" timeout="5s"/>
            </do_if>
            <do_else>
              <show_notification text="'Ship has no pilot or pilot not registered'" timeout="5s"/>
            </do_else>
          </do_if>
          <do_else>
            <show_notification text="'Invalid ship or level (0-10)'" timeout="5s"/>
          </do_else>
        </do_if>
        <do_else>
          <show_notification text="'Invalid level command format. Use: /gt level shipname level'" timeout="5s"/>
        </do_else>
      </actions>
    </cue>
    
    <!-- Test Trade Route -->
    <cue name="TestTradeRoute" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.param"/>
        
        <debug_text text="'[GalaxyTrader MK3 Debug] Testing trade route for ' + $ship.knownname" chance="100"/>
        
        <!-- Force a trade calculation -->
        <set_value name="global.$GT_FindTrades_Ship" exact="$ship"/>
        <signal_cue cue="md.GT_TradingAI.FindTrades"/>
        
        <show_notification text="'Testing trade route for ' + $ship.knownname + '...'" timeout="5s"/>
      </actions>
    </cue>
  </cues>
</mdscript> 
