<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_XP_Training" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- Main XP and Training System -->
    <cue name="Initialize">
      <conditions>
        <check_any>
          <event_player_created/>
          <event_game_loaded/>
        </check_any>
        <check_value value="global.$GT_Config?"/>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3] XP and Training System initialized'" chance="100"/>
        
        <!-- Initialize session stats properties if needed -->
        <do_if value="not global.$GT_SessionStats.$XPGained?">
          <set_value name="global.$GT_SessionStats.$XPGained" exact="0"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Pilot Registration -->
    <cue name="RegisterPilot" instantiate="true" checkinterval="1s">
      <conditions>
        <check_value value="global.$GT_RegisterPilot? or (global.$GT_ShipRegistrationQueue? and global.$GT_ShipRegistrationQueue.count gt 0)"/>
      </conditions>
      <actions>
        <!-- Process queue-based registration first (prevents race conditions) -->
        <do_if value="global.$GT_ShipRegistrationQueue? and global.$GT_ShipRegistrationQueue.count gt 0">
          <set_value name="$registrationData" exact="global.$GT_ShipRegistrationQueue.{1}"/>
          <set_value name="$ship" exact="$registrationData.$ship"/>
          <set_value name="$pilot" exact="$registrationData.$pilot"/>
          <remove_from_list name="global.$GT_ShipRegistrationQueue" exact="$registrationData"/>
          
          <debug_text text="'[GalaxyTrader MK3] 🔄 XP System: Processing ship from queue - ' + $pilot.name + ' on ' + $ship.knownname + ' (Ship ID: ' + $ship.idcode + ') [Queue remaining: ' + global.$GT_ShipRegistrationQueue.count + ']'" chance="100"/>
        </do_if>
        <!-- Fallback to single signal system (backward compatibility) -->
        <do_elseif value="global.$GT_RegisterPilot?">
          <set_value name="$pilot" exact="global.$GT_RegisterPilot"/>
          <set_value name="$ship" exact="global.$GT_RegisterShip"/>
          <remove_value name="global.$GT_RegisterPilot"/>
          <remove_value name="global.$GT_RegisterShip"/>
          
          <debug_text text="'[GalaxyTrader MK3] 🔄 XP System: Pilot registration - ' + $pilot.name + ' on ' + $ship.knownname + ' (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
        </do_elseif>
        
        

        
        <!-- Use extracted initialization library -->
        <run_actions ref="md.GT_Ship_Management.Initialize_Pilot_Data" result="$wasNewPilot">
          <param name="pilot" value="$pilot"/>
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <do_if value="$wasNewPilot">
          <!-- NEW PILOT - Update ship name with initial state -->
          <run_actions ref="md.GT_Ship_Management.Update_Pilot_Ship_Name">
            <param name="pilot" value="$pilot"/>
            <param name="ship" value="$ship"/>
          </run_actions>
          <debug_text text="'[GalaxyTrader MK3] XP System: NEW pilot ' + $pilot.name + ' initialized with 0 XP, skill level 1, ship renamed to: ' + $ship.knownname + ' (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
        </do_if>
        <do_else>
          <!-- EXISTING PILOT -->
          <!-- Store original ship name if not already stored (strip any existing GT formatting) -->
          <do_if value="not global.$GT_Pilots.{$pilot}.$OriginalShipName?">
            <run_actions ref="md.GT_Ship_Management.Strip_GT_Name_Formatting" result="$cleanedName">
              <param name="shipName" value="$ship.knownname"/>
            </run_actions>
            <set_value name="global.$GT_Pilots.{$pilot}.$OriginalShipName" exact="$cleanedName"/>
            <debug_text text="'[GT-XP] Stored cleaned original ship name for existing pilot: ' + $cleanedName + ' (from: ' + $ship.knownname + ') (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
          </do_if>
          
          <!-- Use extracted ship name update library -->
          <run_actions ref="md.GT_Ship_Management.Update_Pilot_Ship_Name">
            <param name="pilot" value="$pilot"/>
            <param name="ship" value="$ship"/>
          </run_actions>
          
          <!-- Calculate star rating for debug output -->
          <run_actions ref="md.GT_Ship_Management.Calculate_Skill_Level_From_XP" result="$currentSkillLevel">
            <param name="pilot" value="$pilot"/>
          </run_actions>
          <set_value name="$starRating" exact="($currentSkillLevel / 3)i"/>
          <do_if value="$starRating gt 5">
            <set_value name="$starRating" exact="5"/>
          </do_if>
          <debug_text text="'[GalaxyTrader MK3] XP System: EXISTING pilot ' + $pilot.name + ' - XP: ' + global.$GT_Pilots.{$pilot}.$XP + ', skill: ' + $currentSkillLevel + ' (' + $starRating + ' stars) (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
        </do_else>
        
        <!-- Use extracted library for skill level calculation -->
        <!-- Calculate current skill level from existing XP for registration validation -->
        <run_actions ref="md.GT_Ship_Management.Calculate_Skill_Level_From_XP" result="$currentSkillLevel">
          <param name="pilot" value="$pilot"/>
        </run_actions>
        
        <!-- Only block if current skill level requires training AND pilot doesn't have training completed -->
        <!-- Check if current skill level requires training using explicit loop (indexof unreliable for lists) -->
        <set_value name="$requiresTraining" exact="false"/>
        <do_if value="global.$GT_Config.$Training.$RequiredLevels?">
          <do_all exact="global.$GT_Config.$Training.$RequiredLevels.count" counter="$i">
            <do_if value="global.$GT_Config.$Training.$RequiredLevels.{$i} == $currentSkillLevel">
              <set_value name="$requiresTraining" exact="true"/>
              <break/>
            </do_if>
          </do_all>
        </do_if>
        
        <do_if value="$requiresTraining">
          <!-- This skill level requires training - check if pilot has completed it -->
          <!-- Check if pilot has completed training using explicit loop (indexof unreliable for lists) -->
          <set_value name="$hasCompletedTraining" exact="false"/>
          <do_if value="global.$GT_Pilots.{$pilot}.$TrainingCompleted?">
            <do_all exact="global.$GT_Pilots.{$pilot}.$TrainingCompleted.count" counter="$j">
              <do_if value="global.$GT_Pilots.{$pilot}.$TrainingCompleted.{$j} == $currentSkillLevel">
                <set_value name="$hasCompletedTraining" exact="true"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>
          
          <do_if value="not $hasCompletedTraining">
            <!-- Training required and not completed - block XP -->
            <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 🚨 BLOCKING PILOT: ' + $pilot.name + ' - skill level ' + $currentSkillLevel + ' requires training (this should NOT happen for level 1!)'" chance="100"/>
            <do_if value="not global.$GT_Pilots.{$pilot}.$XPBlocked?">
              <set_value name="global.$GT_Pilots.{$pilot}.$XPBlocked" exact="true"/>
              <set_value name="global.$GT_Pilots.{$pilot}.$BlockedLevel" exact="$currentSkillLevel"/>
              
              <!-- UPDATE SHIP NAME TO SHOW BLOCKED STATE -->
              <set_value name="$currentXP" exact="global.$GT_Pilots.{$pilot}.$XP"/>
              <set_value name="$rankTitle" exact="'Lehrling'"/>
              <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                <set_value name="$rankIndex" exact="($currentSkillLevel / 3)i + 1"/>
                <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                  <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
                </do_if>
                <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                  <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                </do_if>
              </do_if>
              <signal_cue_instantly cue="UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=$currentXP, $level=$currentSkillLevel, $rank=$rankTitle, $nameType='blocked']"/>
              <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 🏷️ Ship renamed to show blocked state: ' + $ship.knownname" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <!-- Training completed - ensure XP is not blocked -->
            <do_if value="global.$GT_Pilots.{$pilot}.$XPBlocked?">
              <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') Clearing XP block for pilot ' + $pilot.name + ' - training completed for skill level ' + $currentSkillLevel" chance="100"/>
              <remove_value name="global.$GT_Pilots.{$pilot}.$XPBlocked"/>
              <remove_value name="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
              
              <!-- UPDATE SHIP NAME TO CLEAR BLOCKED STATE (new format) -->
              <set_value name="$rankTitle" exact="'Lehrling'"/>
              <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                <set_value name="$rankIndex" exact="($currentSkillLevel / 3)i + 1"/>
                <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                  <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
                </do_if>
                <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                  <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                </do_if>
              </do_if>
              <signal_cue_instantly cue="UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=@global.$GT_Pilots.{$pilot}.$XP, $level=$currentSkillLevel, $rank=$rankTitle, $nameType='trader']"/>
            </do_if>
          </do_else>
        </do_if>
        <do_else>
          <!-- Skill level doesn't require training - ensure XP is not blocked -->
          <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ✅ NOT BLOCKING: Skill level ' + $currentSkillLevel + ' does not require training (correct for level 1)'" chance="100"/>
          <do_if value="global.$GT_Pilots.{$pilot}.$XPBlocked?">
            <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') Clearing XP block for pilot ' + $pilot.name + ' - skill level ' + $currentSkillLevel + ' does not require training'" chance="100"/>
            <remove_value name="global.$GT_Pilots.{$pilot}.$XPBlocked"/>
            <remove_value name="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
            
            <!-- UPDATE SHIP NAME TO CLEAR BLOCKED STATE (new format) -->
            <set_value name="$rankTitle" exact="'Lehrling'"/>
            <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
              <set_value name="$rankIndex" exact="($currentSkillLevel / 3)i + 1"/>
              <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
              </do_if>
              <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
              </do_if>
            </do_if>
            <signal_cue_instantly cue="UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=@global.$GT_Pilots.{$pilot}.$XP, $level=$currentSkillLevel, $rank=$rankTitle, $nameType='trader']"/>
          </do_if>
        </do_else>
        
        <!-- Ensure all required fields exist (defensive programming) -->
        <do_if value="not global.$GT_Pilots.{$pilot}.$XP?">
          <set_value name="global.$GT_Pilots.{$pilot}.$XP" exact="0"/>
        </do_if>
        <do_if value="not global.$GT_Pilots.{$pilot}.$TrainingCompleted?">
          <set_value name="global.$GT_Pilots.{$pilot}.$TrainingCompleted" exact="[]"/>
        </do_if>
        
        <debug_text text="'[GalaxyTrader MK3] XP system tracking pilot: ' + $pilot.name + ' (XP: ' + global.$GT_Pilots.{$pilot}.$XP + ') (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
      </actions>
    </cue>
    
    <!-- PHASE 1 IMPROVEMENT: Event-Driven XP Award Handler -->
    <!-- ✅ EVENT-DRIVEN: Listen for signal instead of polling -->
    <cue name="ProcessXPEvents" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_XP_Training.ProcessXPEvents"/>
      </conditions>
      <actions>
        
        <!-- Process all queued XP events -->
        <do_if value="global.$GT_XPEventQueue? and global.$GT_XPEventQueue.count gt 0">
          <debug_text text="'[GalaxyTrader MK3] ⚡ Processing ' + global.$GT_XPEventQueue.count + ' XP events instantly'" chance="100"/>
          
          <do_while value="global.$GT_XPEventQueue.count gt 0">
            <!-- Get next event -->
            <set_value name="$event" exact="global.$GT_XPEventQueue.{1}"/>
            <remove_from_list name="global.$GT_XPEventQueue" exact="$event"/>
            
            <!-- Extract event data -->
            <set_value name="$pilot" exact="$event.$pilot"/>
            <set_value name="$ship" exact="$event.$ship"/>
            <set_value name="$amount" exact="$event.$xpAmount"/>
            <set_value name="$ware" exact="$event.$ware"/>
            
            <!-- Store in pilot pending data for backward compatibility -->
            <set_value name="global.$GT_Pilots.{$pilot}.$PendingXP" exact="$amount"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$PendingTradeWare" exact="$ware"/>
            
            <!-- Check if pilot is valid and exists in our system -->
            <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
              <!-- Get current XP -->
              <set_value name="$currentXP" exact="global.$GT_Pilots.{$pilot}.$XP"/>
              
              <!-- Calculate current skill level from XP -->
              <set_value name="$currentSkillLevel" exact="1"/>
              <do_all exact="15" counter="$skillLevel">
                <do_if value="$currentXP ge global.$GT_Config.$XP.$SkillThresholds.{$skillLevel}">
                  <set_value name="$currentSkillLevel" exact="$skillLevel"/>
                </do_if>
              </do_all>
              
              <!-- Check if XP gain is blocked (at training threshold) -->
              <!-- Also check BlockedLevel - prevents XP gain when training stations unavailable -->
              <!-- When no training stations found, XPBlocked is cleared to allow trading, but BlockedLevel remains -->
              <!-- This ensures XP is still blocked until training can be completed -->
              <do_if value="global.$GT_Pilots.{$pilot}.$XPBlocked? or global.$GT_Pilots.{$pilot}.$BlockedLevel?">
                <set_value name="$blockedLevel" exact="@global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
                <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') XP gain blocked for pilot ' + $pilot.name + ' - training required at skill level ' + $blockedLevel" chance="100"/>
                
                <!-- Notify player occasionally -->
                <do_if value="global.$GT_Config.$Notifications.$TrainingRequired">
                  <show_notification text="'Pilot ' + $pilot.name + ' needs training to continue XP progression!'" timeout="5s" priority="8"/>
                </do_if>
              </do_if>
              <do_else>
                <!-- Add XP -->
                <set_value name="$newXP" exact="$currentXP + $amount"/>
                <set_value name="global.$GT_Pilots.{$pilot}.$XP" exact="$newXP"/>
                <set_value name="global.$GT_SessionStats.$XPGained" exact="global.$GT_SessionStats.$XPGained + $amount"/>
                
                <!-- Calculate new skill level from new XP total -->
                <set_value name="$newSkillLevel" exact="1"/>
                <do_all exact="15" counter="$skillLevel">
                  <do_if value="$newXP ge global.$GT_Config.$XP.$SkillThresholds.{$skillLevel}">
                    <set_value name="$newSkillLevel" exact="$skillLevel"/>
                  </do_if>
                </do_all>
                
                <!-- Calculate star rating for display (X4 management skill: 3 skill levels per star) -->
                <set_value name="$starRating" exact="($newSkillLevel / 3)i"/>
                <do_if value="$starRating gt 5">
                  <set_value name="$starRating" exact="5"/>
                </do_if>
                
                <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 🏆 Pilot ' + $pilot.name + ' gained ' + $amount + ' XP (total: ' + $newXP + ', skill: ' + $newSkillLevel + ', ' + $starRating + ' stars)'" chance="100"/>
                
                <!-- ALWAYS update ship name with new-format params (even without level change) -->
                <set_value name="$rankTitle" exact="'Lehrling'"/>
                <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                  <set_value name="$rankIndex" exact="($newSkillLevel / 3)i + 1"/>
                  <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                    <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
                  </do_if>
                  <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                    <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                  </do_if>
                </do_if>
                <signal_cue_instantly cue="UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=$newXP, $level=$newSkillLevel, $rank=$rankTitle, $nameType='trader']"/>
                
                <!-- CHECK FOR TRAINING REQUIREMENTS BEFORE SKILL LEVEL INCREASE -->
                <do_if value="$newSkillLevel gt $currentSkillLevel">
                  <!-- Potential skill level up - check if ANY level between current and new requires training -->
                  <set_value name="$trainingRequired" exact="false"/>
                  <set_value name="$requiredTrainingLevel" exact="0"/>
                  
                  <!-- Check all skill levels between current and new (inclusive of new level) -->
                  <do_all exact="($newSkillLevel - $currentSkillLevel)" counter="$levelCheck">
                    <set_value name="$checkLevel" exact="$currentSkillLevel + $levelCheck"/>
                    
                    <!-- Check if this intermediate level requires training using explicit loop (indexof unreliable for lists) -->
                    <set_value name="$levelRequiresTraining" exact="false"/>
                    <do_if value="global.$GT_Config.$Training.$RequiredLevels?">
                      <do_all exact="global.$GT_Config.$Training.$RequiredLevels.count" counter="$i">
                        <do_if value="global.$GT_Config.$Training.$RequiredLevels.{$i} == $checkLevel">
                          <set_value name="$levelRequiresTraining" exact="true"/>
                          <break/>
                        </do_if>
                      </do_all>
                    </do_if>
                    
                    <do_if value="$levelRequiresTraining">
                      <!-- This level requires training - check if pilot has completed it using explicit loop (indexof unreliable for lists) -->
                      <set_value name="$hasCompletedTraining" exact="false"/>
                      <do_if value="global.$GT_Pilots.{$pilot}.$TrainingCompleted?">
                        <do_all exact="global.$GT_Pilots.{$pilot}.$TrainingCompleted.count" counter="$j">
                          <do_if value="global.$GT_Pilots.{$pilot}.$TrainingCompleted.{$j} == $checkLevel">
                            <set_value name="$hasCompletedTraining" exact="true"/>
                            <break/>
                          </do_if>
                        </do_all>
                      </do_if>
                      
                      <do_if value="not $hasCompletedTraining">
                        <!-- Training required and not completed - block at this level -->
                        <set_value name="$trainingRequired" exact="true"/>
                        <set_value name="$requiredTrainingLevel" exact="$checkLevel"/>
                        <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 🚫 TRAINING BLOCK: Pilot would advance from ' + $currentSkillLevel + ' to ' + $newSkillLevel + ' but needs training at level ' + $checkLevel" chance="100"/>
                        <break/>  <!-- Stop checking - we found the first training requirement -->
                      </do_if>
                    </do_if>
                  </do_all>
                  
                  <do_if value="$trainingRequired">
                    <!-- Training required - BLOCK skill level increase at the training level -->
                    <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ⚠️ DIRECT: Skill level ' + $requiredTrainingLevel + ' requires training - blocking advancement (would have reached level ' + $newSkillLevel + ')'" chance="100"/>
                    
                    <!-- Keep pilot at current skill level until training is completed -->
                    <set_skill entity="$pilot" type="skilltype.management" exact="$currentSkillLevel"/>
                    <set_value name="global.$GT_Pilots.{$pilot}.$Level" exact="$currentSkillLevel"/>
                    
                    <!-- Update pilot skill proportionally based on current (blocked) management level -->
                    <!-- Formula: pilot_level = (management_level * 9) / 15 -->
                    <!-- Never reduce pilot skill, only increase if target is higher -->
                    <set_value name="$currentPilotSkill" exact="0"/>
                    <do_if value="$pilot.skill.piloting?">
                      <set_value name="$currentPilotSkill" exact="@$pilot.skill.piloting"/>
                    </do_if>
                    <!-- Calculate target pilot skill level based on current management level -->
                    <set_value name="$targetPilotLevel" exact="($currentSkillLevel * 9) / 15"/>
                    <do_if value="$targetPilotLevel lt 1">
                      <set_value name="$targetPilotLevel" exact="1"/>
                    </do_if>
                    <do_if value="$targetPilotLevel gt 9">
                      <set_value name="$targetPilotLevel" exact="9"/>
                    </do_if>
                    <!-- Only increase pilot skill if target is higher than current -->
                    <do_if value="$targetPilotLevel gt $currentPilotSkill">
                      <set_skill entity="$pilot" type="skilltype.piloting" exact="$targetPilotLevel"/>
                      <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ✈️ Pilot skill increased from ' + $currentPilotSkill + ' to ' + $targetPilotLevel + ' (management blocked at: ' + $currentSkillLevel + ')'" chance="100"/>
                    </do_if>
                    
                    <!-- Store the pending skill level for after training -->
                    <set_value name="global.$GT_Pilots.{$pilot}.$PendingSkillLevel" exact="$newSkillLevel"/>
                    
                    <!-- Block XP progression at the training level (not the final level) -->
                    <set_value name="global.$GT_Pilots.{$pilot}.$XPBlocked" exact="true"/>
                    <set_value name="global.$GT_Pilots.{$pilot}.$BlockedLevel" exact="$requiredTrainingLevel"/>
                    
                    <!-- UPDATE SHIP NAME TO SHOW BLOCKED STATE -->
                    <set_value name="$rankTitle" exact="'Lehrling'"/>
                    <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                      <set_value name="$rankIndex" exact="($requiredTrainingLevel / 3)i + 1"/>
                      <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                        <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
                      </do_if>
                      <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                        <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                      </do_if>
                    </do_if>
                    <signal_cue_instantly cue="UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=$newXP, $level=$requiredTrainingLevel, $rank=$rankTitle, $nameType='blocked']"/>
                    <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 🏷️ Ship renamed to show blocked state: ' + $ship.knownname" chance="100"/>
                    
                    <!-- Notify player -->
                    <do_if value="global.$GT_Config.$Notifications.$TrainingRequired">
                      <set_value name="$message" exact="'Pilot ' + $pilot.name + ' needs training to advance to skill level ' + $requiredTrainingLevel + '! Dock at a training station to unlock further progression.'"/>
                      <show_notification text="$message" timeout="8s" priority="7"/>
                      <run_actions ref="md.GT_Libraries_General.WriteLogbookMessage">
                        <param name="Message" value="$message"/>
                        <param name="Category" value="'upkeep'"/>
                        <param name="Title" value="'Training Required: ' + $pilot.name + ' (' + $ship.knownname + ')'"/>
                        <param name="Object" value="$ship"/>
                        <param name="Interaction" value="'showonmap'"/>
                        <param name="Highlighted" value="true"/>
                        <param name="CheckGlobalSettings" value="false"/>
                      </run_actions>
                    </do_if>
                    
                    <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 🔧 Management skill kept at level ' + $currentSkillLevel + ' until level ' + $requiredTrainingLevel + ' training completed'" chance="100"/>
                    
                    <!-- TRIGGER AUTO-TRAINING: Send training needed signal to start auto-training process -->
                    <signal_objects object="player.galaxy" param="'GT_Training_Needed'" param2="table[
                      $Ship = $ship,
                      $Pilot = $pilot,
                      $RequiredLevel = $requiredTrainingLevel,
                      $CurrentLevel = $currentSkillLevel,
                      $TargetLevel = $newSkillLevel,
                      $BlockedXP = $newXP
                    ]"/>
                    
                    <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 📡 AUTO-TRAINING: Sent training needed signal for pilot ' + $pilot.name + ' (requires level ' + $requiredTrainingLevel + ' training)'" chance="100"/>
                  </do_if>
                  <do_else>
                    <!-- No training required for any intermediate levels - allow skill level increase -->
                    <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ⭐ DIRECT: Pilot ' + $pilot.name + ' advanced from skill level ' + $currentSkillLevel + ' to ' + $newSkillLevel + ' (no training required)!'" chance="100"/>
                    
                    <!-- Set management skill to new level -->
                    <set_skill entity="$pilot" type="skilltype.management" exact="$newSkillLevel"/>
                    <set_value name="global.$GT_Pilots.{$pilot}.$Level" exact="$newSkillLevel"/>
                    
                    <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 🔧 Management skill set to level ' + $newSkillLevel + ' (' + $starRating + ' stars)'" chance="100"/>
                    
                    <!-- Update pilot skill proportionally: Management Level 15 (5 stars) → Pilot Level 9 (3 stars) -->
                    <!-- Formula: pilot_level = (management_level * 9) / 15 -->
                    <!-- Never reduce pilot skill, only increase if target is higher -->
                    <set_value name="$currentPilotSkill" exact="0"/>
                    <do_if value="$pilot.skill.piloting?">
                      <set_value name="$currentPilotSkill" exact="@$pilot.skill.piloting"/>
                    </do_if>
                    <!-- Calculate target pilot skill level -->
                    <set_value name="$targetPilotLevel" exact="($newSkillLevel * 9) / 15"/>
                    <do_if value="$targetPilotLevel lt 1">
                      <set_value name="$targetPilotLevel" exact="1"/>
                    </do_if>
                    <do_if value="$targetPilotLevel gt 9">
                      <set_value name="$targetPilotLevel" exact="9"/>
                    </do_if>
                    <!-- Only increase pilot skill if target is higher than current -->
                    <do_if value="$targetPilotLevel gt $currentPilotSkill">
                      <set_skill entity="$pilot" type="skilltype.piloting" exact="$targetPilotLevel"/>
                      <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ✈️ Pilot skill increased from ' + $currentPilotSkill + ' to ' + $targetPilotLevel + ' (management: ' + $newSkillLevel + ')'" chance="100"/>
                    </do_if>
                    <do_else>
                      <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ✈️ Pilot skill unchanged at ' + $currentPilotSkill + ' (already higher than target ' + $targetPilotLevel + ')'" chance="100"/>
                    </do_else>
                    
                    <!-- Notify player for level up with enhanced info -->
                    <do_if value="global.$GT_Config.$Notifications.$LevelUp">
                      <set_value name="$message" exact="'Pilot ' + $pilot.name + ' reached Skill Level ' + $newSkillLevel + ' (' + $starRating + ' stars) from ' + $ware + ' trade!'"/>
                      <show_notification text="$message" timeout="6s" priority="7"/>
                      <run_actions ref="md.GT_Libraries_General.WriteLogbookMessage">
                        <param name="Message" value="$message"/>
                        <param name="Category" value="'news'"/>
                        <param name="Title" value="'Level Up: ' + $pilot.name + ' (' + $ship.knownname + ')'"/>
                        <param name="Object" value="$ship"/>
                        <param name="Interaction" value="'showonmap'"/>
                        <param name="CheckGlobalSettings" value="false"/>
                      </run_actions>
                    </do_if>
                    
                    <!-- ALWAYS update ship name to reflect current skill level (new format) -->
                    <set_value name="$rankTitle" exact="'Lehrling'"/>
                    <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                      <set_value name="$rankIndex" exact="($newSkillLevel / 3)i + 1"/>
                      <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                        <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
                      </do_if>
                      <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                        <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                      </do_if>
                    </do_if>
                    <signal_cue_instantly cue="UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=@global.$GT_Pilots.{$pilot}.$XP, $level=$newSkillLevel, $rank=$rankTitle, $nameType='trader']"/>
                  </do_else>
                </do_if>
                <do_else>
                  <!-- No skill level change - just update stored level and ship name -->
                  <set_skill entity="$pilot" type="skilltype.management" exact="$newSkillLevel"/>
                  <set_value name="global.$GT_Pilots.{$pilot}.$Level" exact="$newSkillLevel"/>
                  
                  <!-- Update pilot skill proportionally: Management Level 15 (5 stars) → Pilot Level 9 (3 stars) -->
                  <!-- Formula: pilot_level = (management_level * 9) / 15 -->
                  <!-- Never reduce pilot skill, only increase if target is higher -->
                  <set_value name="$currentPilotSkill" exact="0"/>
                  <do_if value="$pilot.skill.piloting?">
                    <set_value name="$currentPilotSkill" exact="@$pilot.skill.piloting"/>
                  </do_if>
                  <!-- Calculate target pilot skill level -->
                  <set_value name="$targetPilotLevel" exact="($newSkillLevel * 9) / 15"/>
                  <do_if value="$targetPilotLevel lt 1">
                    <set_value name="$targetPilotLevel" exact="1"/>
                  </do_if>
                  <do_if value="$targetPilotLevel gt 9">
                    <set_value name="$targetPilotLevel" exact="9"/>
                  </do_if>
                  <!-- Only increase pilot skill if target is higher than current -->
                  <do_if value="$targetPilotLevel gt $currentPilotSkill">
                    <set_skill entity="$pilot" type="skilltype.piloting" exact="$targetPilotLevel"/>
                    <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ✈️ Pilot skill increased from ' + $currentPilotSkill + ' to ' + $targetPilotLevel + ' (management: ' + $newSkillLevel + ')'" chance="100"/>
                  </do_if>
                  
                  <!-- ALWAYS update ship name to reflect current XP (even without level change) (new format) -->
                  <set_value name="$rankTitle" exact="'Lehrling'"/>
                  <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                    <set_value name="$rankIndex" exact="($newSkillLevel / 3)i + 1"/>
                    <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                      <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
                    </do_if>
                    <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                      <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                    </do_if>
                  </do_if>
                  <signal_cue_instantly cue="UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=$newXP, $level=$newSkillLevel, $rank=$rankTitle, $nameType='trader']"/>
                </do_else>
              </do_else>
              
              <!-- Clean up pending data -->
              <remove_value name="global.$GT_Pilots.{$pilot}.$PendingXP"/>
              <remove_value name="global.$GT_Pilots.{$pilot}.$PendingTradeWare"/>
            </do_if>
          </do_while>
        </do_if>
      </actions>
    </cue>
    
    <!-- DEPRECATED: Direct Trade Completion Handler - Replaced by gt_trading_signals.xml
         
         This cue has been replaced by the centralized signal router in gt_trading_signals.xml
         which now handles all diff patch signals and routes them to appropriate systems.
         
         The new system (ProcessTradeSuccess in gt_trading_signals.xml) calls ProcessSingleXPEvent
         directly, making this intermediate handler obsolete.
    -->
    <!-- DirectTradeComplete cue removed - 60 lines of code that processed global.$GT_DirectTradeQueue
         has been replaced by gt_trading_signals.xml ProcessTradeSuccess which routes to ProcessSingleXPEvent -->
    
    <!-- PHASE 2 IMPROVEMENT: Optimized Single XP Event Processing -->
    <cue name="ProcessSingleXPEvent" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$trade_data" exact="event.param"/>
        <set_value name="$pilot" exact="$trade_data.$pilot"/>
        <set_value name="$ship" exact="$trade_data.$ship"/>
        <set_value name="$amount" exact="$trade_data.$xpAmount"/>
        <set_value name="$ware" exact="$trade_data.$ware"/>
        
        <!-- Check if pilot is valid and exists in our system -->
        <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
          <!-- Get current XP -->
          <set_value name="$currentXP" exact="global.$GT_Pilots.{$pilot}.$XP"/>
          
          <!-- Calculate current skill level from XP -->
          <set_value name="$currentSkillLevel" exact="1"/>
          <do_all exact="15" counter="$skillLevel">
            <do_if value="$currentXP ge global.$GT_Config.$XP.$SkillThresholds.{$skillLevel}">
              <set_value name="$currentSkillLevel" exact="$skillLevel"/>
            </do_if>
          </do_all>
          
          <!-- Check if XP gain is blocked (at training threshold) -->
          <!-- ✅ CRITICAL FIX: Also check BlockedLevel - prevents XP gain when training stations unavailable -->
          <!-- When no training stations found, XPBlocked is cleared to allow trading, but BlockedLevel remains -->
          <!-- This ensures XP is still blocked until training can be completed -->
          <do_if value="global.$GT_Pilots.{$pilot}.$XPBlocked? or global.$GT_Pilots.{$pilot}.$BlockedLevel?">
            <set_value name="$blockedLevel" exact="@global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
            <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 🚫 XP gain blocked for pilot ' + $pilot.name + ' - training required at skill level ' + $blockedLevel + ' (attempted award: ' + $amount + ' XP)'" chance="100"/>
            
            <!-- Store blocked XP for post-training award -->
            <do_if value="not global.$GT_Pilots.{$pilot}.$BlockedXPPending?">
              <set_value name="global.$GT_Pilots.{$pilot}.$BlockedXPPending" exact="0"/>
            </do_if>
            <set_value name="global.$GT_Pilots.{$pilot}.$BlockedXPPending" exact="global.$GT_Pilots.{$pilot}.$BlockedXPPending + $amount"/>
            
            <!-- Notify player occasionally about blocked XP -->
            <do_if value="global.$GT_Config.$Notifications.$TrainingRequired">
              <set_value name="$message" exact="'Pilot ' + $pilot.name + ' earned ' + $amount + ' XP but needs training to advance! Total blocked: ' + global.$GT_Pilots.{$pilot}.$BlockedXPPending + ' XP'"/>
              <show_notification text="$message" timeout="6s" priority="8"/>
              <run_actions ref="md.GT_Libraries_General.WriteLogbookMessage">
                <param name="Message" value="$message"/>
                <param name="Category" value="'upkeep'"/>
                <param name="Title" value="'XP Blocked: ' + $pilot.name + ' (' + $ship.knownname + ')'"/>
                <param name="Object" value="$ship"/>
                <param name="Interaction" value="'showonmap'"/>
                <param name="Highlighted" value="true"/>
                <param name="CheckGlobalSettings" value="false"/>
              </run_actions>
            </do_if>
          </do_if>
          <do_else>
            <!-- Add XP -->
            <set_value name="$newXP" exact="$currentXP + $amount"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$XP" exact="$newXP"/>
            <set_value name="global.$GT_SessionStats.$XPGained" exact="global.$GT_SessionStats.$XPGained + $amount"/>
            
            <!-- Calculate new skill level from new XP total -->
            <set_value name="$newSkillLevel" exact="1"/>
            <do_all exact="15" counter="$skillLevel">
              <do_if value="$newXP ge global.$GT_Config.$XP.$SkillThresholds.{$skillLevel}">
                <set_value name="$newSkillLevel" exact="$skillLevel"/>
              </do_if>
            </do_all>
            
            <!-- Calculate star rating for display (X4 management skill: 3 skill levels per star) -->
            <set_value name="$starRating" exact="($newSkillLevel / 3)i"/>
            <do_if value="$starRating gt 5">
              <set_value name="$starRating" exact="5"/>
            </do_if>
            
            <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 🏆 DIRECT XP: Pilot ' + $pilot.name + ' gained ' + $amount + ' XP (total: ' + $newXP + ', skill: ' + $newSkillLevel + ', ' + $starRating + ' stars) for ' + $ware + ' trade'" chance="100"/>
            
            <!-- CHECK FOR TRAINING REQUIREMENTS BEFORE SKILL LEVEL INCREASE -->
            <do_if value="$newSkillLevel gt $currentSkillLevel">
              <!-- Potential skill level up - check if ANY level between current and new requires training -->
              <set_value name="$trainingRequired" exact="false"/>
              <set_value name="$requiredTrainingLevel" exact="0"/>
              
              <!-- Check all skill levels between current and new (inclusive of new level) -->
              <do_all exact="($newSkillLevel - $currentSkillLevel)" counter="$levelCheck">
                <set_value name="$checkLevel" exact="$currentSkillLevel + $levelCheck"/>
                
                <!-- Check if this intermediate level requires training using explicit loop (indexof unreliable for lists) -->
                <set_value name="$levelRequiresTraining" exact="false"/>
                <do_if value="global.$GT_Config.$Training.$RequiredLevels?">
                  <do_all exact="global.$GT_Config.$Training.$RequiredLevels.count" counter="$i">
                    <do_if value="global.$GT_Config.$Training.$RequiredLevels.{$i} == $checkLevel">
                      <set_value name="$levelRequiresTraining" exact="true"/>
                      <break/>
                    </do_if>
                  </do_all>
                </do_if>
                
                <do_if value="$levelRequiresTraining">
                  <!-- This level requires training - check if pilot has completed it using explicit loop (indexof unreliable for lists) -->
                  <set_value name="$hasCompletedTraining" exact="false"/>
                  <do_if value="global.$GT_Pilots.{$pilot}.$TrainingCompleted?">
                    <do_all exact="global.$GT_Pilots.{$pilot}.$TrainingCompleted.count" counter="$j">
                      <do_if value="global.$GT_Pilots.{$pilot}.$TrainingCompleted.{$j} == $checkLevel">
                        <set_value name="$hasCompletedTraining" exact="true"/>
                        <break/>
                      </do_if>
                    </do_all>
                  </do_if>
                  
                  <do_if value="not $hasCompletedTraining">
                    <!-- Training required and not completed - block at this level -->
                    <set_value name="$trainingRequired" exact="true"/>
                    <set_value name="$requiredTrainingLevel" exact="$checkLevel"/>
                    <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 🚫 TRAINING BLOCK: Pilot would advance from ' + $currentSkillLevel + ' to ' + $newSkillLevel + ' but needs training at level ' + $checkLevel" chance="100"/>
                    <break/>  <!-- Stop checking - we found the first training requirement -->
                  </do_if>
                </do_if>
              </do_all>
              
              <do_if value="$trainingRequired">
                <!-- Training required - BLOCK skill level increase at the training level -->
                <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ⚠️ DIRECT: Skill level ' + $requiredTrainingLevel + ' requires training - blocking advancement (would have reached level ' + $newSkillLevel + ')'" chance="100"/>
                
                <!-- Keep pilot at current skill level until training is completed -->
                <set_skill entity="$pilot" type="skilltype.management" exact="$currentSkillLevel"/>
                <set_value name="global.$GT_Pilots.{$pilot}.$Level" exact="$currentSkillLevel"/>
                
                <!-- Update pilot skill proportionally based on current (blocked) management level -->
                <!-- Formula: pilot_level = (management_level * 9) / 15 -->
                <!-- Never reduce pilot skill, only increase if target is higher -->
                <set_value name="$currentPilotSkill" exact="0"/>
                <do_if value="$pilot.skill.piloting?">
                  <set_value name="$currentPilotSkill" exact="@$pilot.skill.piloting"/>
                </do_if>
                <!-- Calculate target pilot skill level based on current management level -->
                <set_value name="$targetPilotLevel" exact="($currentSkillLevel * 9) / 15"/>
                <do_if value="$targetPilotLevel lt 1">
                  <set_value name="$targetPilotLevel" exact="1"/>
                </do_if>
                <do_if value="$targetPilotLevel gt 9">
                  <set_value name="$targetPilotLevel" exact="9"/>
                </do_if>
                <!-- Only increase pilot skill if target is higher than current -->
                <do_if value="$targetPilotLevel gt $currentPilotSkill">
                  <set_skill entity="$pilot" type="skilltype.piloting" exact="$targetPilotLevel"/>
                  <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ✈️ Pilot skill increased from ' + $currentPilotSkill + ' to ' + $targetPilotLevel + ' (management blocked at: ' + $currentSkillLevel + ')'" chance="100"/>
                </do_if>
                
                <!-- Store the pending skill level for after training -->
                <set_value name="global.$GT_Pilots.{$pilot}.$PendingSkillLevel" exact="$newSkillLevel"/>
                
                <!-- Block XP progression at the training level (not the final level) -->
                <set_value name="global.$GT_Pilots.{$pilot}.$XPBlocked" exact="true"/>
                <set_value name="global.$GT_Pilots.{$pilot}.$BlockedLevel" exact="$requiredTrainingLevel"/>
                
                <!-- UPDATE SHIP NAME TO SHOW BLOCKED STATE -->
                <!-- Calculate rank title for display -->
                <set_value name="$rankTitle" exact="'Lehrling'"/>
                <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                  <set_value name="$rankIndex" exact="($requiredTrainingLevel / 3)i + 1"/>
                  <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                    <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
                  </do_if>
                  <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                    <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                  </do_if>
                </do_if>
                                     <signal_cue_instantly cue="UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=$newXP, $level=$requiredTrainingLevel, $rank=$rankTitle, $nameType='blocked']"/>
                <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 🏷️ Ship renamed to show blocked state (advancement required for level ' + $requiredTrainingLevel + ')'" chance="100"/>
                
                <!-- Notify player -->
                <do_if value="global.$GT_Config.$Notifications.$TrainingRequired">
                  <set_value name="$message" exact="'Pilot ' + $pilot.name + ' needs training to advance to skill level ' + $requiredTrainingLevel + '! Dock at a training station to unlock further progression.'"/>
                  <show_notification text="$message" timeout="8s" priority="7"/>
                  <!-- Only write logbook when debug is enabled -->
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <write_to_logbook category="upkeep" title="'Training Required: ' + $pilot.name + ' (' + $ship.knownname + ')'" text="$message" interaction="showonmap" object="$ship" highlighted="true"/>
                  </do_if>
                </do_if>
                
                <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 🔧 Management skill kept at level ' + $currentSkillLevel + ' until level ' + $requiredTrainingLevel + ' training completed'" chance="100"/>
                
                <!-- TRIGGER AUTO-TRAINING: Send training needed signal to start auto-training process -->
                <signal_objects object="player.galaxy" param="'GT_Training_Needed'" param2="table[
                  $Ship = $ship,
                  $Pilot = $pilot,
                  $RequiredLevel = $requiredTrainingLevel,
                  $CurrentLevel = $currentSkillLevel,
                  $TargetLevel = $newSkillLevel,
                  $BlockedXP = $newXP
                ]"/>
                
                <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 📡 AUTO-TRAINING: Sent training needed signal for pilot ' + $pilot.name + ' (requires level ' + $requiredTrainingLevel + ' training)'" chance="100"/>
              </do_if>
              <do_else>
                <!-- No training required for any intermediate levels - allow skill level increase -->
                <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ⭐ DIRECT: Pilot ' + $pilot.name + ' advanced from skill level ' + $currentSkillLevel + ' to ' + $newSkillLevel + ' (no training required)!'" chance="100"/>
                
                <!-- Set management skill to new level -->
                <set_skill entity="$pilot" type="skilltype.management" exact="$newSkillLevel"/>
                <set_value name="global.$GT_Pilots.{$pilot}.$Level" exact="$newSkillLevel"/>
                
                <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 🔧 Management skill set to level ' + $newSkillLevel + ' (' + $starRating + ' stars)'" chance="100"/>
                
                <!-- Update pilot skill proportionally: Management Level 15 (5 stars) → Pilot Level 9 (3 stars) -->
                <!-- Formula: pilot_level = (management_level * 9) / 15 -->
                <!-- Never reduce pilot skill, only increase if target is higher -->
                <set_value name="$currentPilotSkill" exact="0"/>
                <do_if value="$pilot.skill.piloting?">
                  <set_value name="$currentPilotSkill" exact="@$pilot.skill.piloting"/>
                </do_if>
                <!-- Calculate target pilot skill level -->
                <set_value name="$targetPilotLevel" exact="($newSkillLevel * 9) / 15"/>
                <do_if value="$targetPilotLevel lt 1">
                  <set_value name="$targetPilotLevel" exact="1"/>
                </do_if>
                <do_if value="$targetPilotLevel gt 9">
                  <set_value name="$targetPilotLevel" exact="9"/>
                </do_if>
                <!-- Only increase pilot skill if target is higher than current -->
                <do_if value="$targetPilotLevel gt $currentPilotSkill">
                  <set_skill entity="$pilot" type="skilltype.piloting" exact="$targetPilotLevel"/>
                  <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ✈️ Pilot skill increased from ' + $currentPilotSkill + ' to ' + $targetPilotLevel + ' (management: ' + $newSkillLevel + ')'" chance="100"/>
                </do_if>
                <do_else>
                  <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ✈️ Pilot skill unchanged at ' + $currentPilotSkill + ' (already higher than target ' + $targetPilotLevel + ')'" chance="100"/>
                </do_else>
                
                <!-- Notify player for level up with enhanced info -->
                <do_if value="global.$GT_Config.$Notifications.$LevelUp">
                  <set_value name="$message" exact="'Pilot ' + $pilot.name + ' reached Skill Level ' + $newSkillLevel + ' (' + $starRating + ' stars) from ' + $ware + ' trade!'"/>
                  <show_notification text="$message" timeout="6s" priority="7"/>
                  <!-- Only write logbook when debug is enabled -->
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <write_to_logbook category="news" title="'Level Up: ' + $pilot.name + ' (' + $ship.knownname + ')'" text="$message" interaction="showonmap" object="$ship"/>
                  </do_if>
                </do_if>
                
                <!-- ALWAYS update ship name to reflect current skill level -->
                <signal_cue_instantly cue="UpdateShipName" param="table[$pilot = $pilot, $ship = $ship, $skillLevel = $newSkillLevel]"/>
              </do_else>
            </do_if>
            <do_else>
              <!-- No skill level change - just update stored level and ship name -->
              <set_skill entity="$pilot" type="skilltype.management" exact="$newSkillLevel"/>
              <set_value name="global.$GT_Pilots.{$pilot}.$Level" exact="$newSkillLevel"/>
              
              <!-- Update pilot skill proportionally: Management Level 15 (5 stars) → Pilot Level 9 (3 stars) -->
              <!-- Formula: pilot_level = (management_level * 9) / 15 -->
              <!-- Never reduce pilot skill, only increase if target is higher -->
              <set_value name="$currentPilotSkill" exact="0"/>
              <do_if value="$pilot.skill.piloting?">
                <set_value name="$currentPilotSkill" exact="@$pilot.skill.piloting"/>
              </do_if>
              <!-- Calculate target pilot skill level -->
              <set_value name="$targetPilotLevel" exact="($newSkillLevel * 9) / 15"/>
              <do_if value="$targetPilotLevel lt 1">
                <set_value name="$targetPilotLevel" exact="1"/>
              </do_if>
              <do_if value="$targetPilotLevel gt 9">
                <set_value name="$targetPilotLevel" exact="9"/>
              </do_if>
              <!-- Only increase pilot skill if target is higher than current -->
              <do_if value="$targetPilotLevel gt $currentPilotSkill">
                <set_skill entity="$pilot" type="skilltype.piloting" exact="$targetPilotLevel"/>
                <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ✈️ Pilot skill increased from ' + $currentPilotSkill + ' to ' + $targetPilotLevel + ' (management: ' + $newSkillLevel + ')'" chance="100"/>
              </do_if>
              
              <!-- ALWAYS update ship name to reflect current XP (even without level change) -->
              <signal_cue_instantly cue="UpdateShipName" param="table[$pilot = $pilot, $ship = $ship, $skillLevel = $newSkillLevel]"/>
            </do_else>
          </do_else>
          
          <!-- Store the last trade data for this pilot -->
          <set_value name="global.$GT_Pilots.{$pilot}.$LastTrade" exact="$trade_data"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$LastTradeTime" exact="player.age"/>
        </do_if>
        <do_else>
          <debug_text text="'[GalaxyTrader MK3] ⚠️ DIRECT XP: Pilot ' + $pilot.name + ' not found in GT system - ignoring XP award'" chance="100"/>
        </do_else>
      </actions>
    </cue>
    
    <!-- Ship Name Update Listener (for AI script signals) -->
    <cue name="ListenForShipNameUpdate" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Update_Ship_Name'"/>
      </conditions>
      <actions>
        <!-- Forward to UpdateShipName cue -->
        <signal_cue_instantly cue="UpdateShipName" param="event.param2"/>
      </actions>
    </cue>
    
    <!-- Ship Name Update Based on Skill Level -->
    <cue name="UpdateShipName" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <!-- Check if ship renaming is enabled -->
        <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$ShipNaming? and not @global.$GT_GlobalSettings.$ShipNaming.$Enabled">
          <debug_text text="'[GT-XP] Ship renaming disabled in settings - skipping rename'" chance="100"/>
        </do_if>
        <do_else>
          <!-- Handle both old and new parameter formats -->
          <set_value name="$pilot" exact="event.param.$pilot"/>
          <set_value name="$ship" exact="event.param.$ship"/>
        
        <!-- Check which parameter format we're using -->
        <set_value name="$useNewFormat" exact="event.param.$nameType?"/>
        
        <!-- Extract parameters based on format -->
        <do_if value="$useNewFormat">
          <!-- New format parameters (with nameType) -->
          <set_value name="$xp" exact="event.param.$xp"/>
          <set_value name="$level" exact="event.param.$level"/>
          <set_value name="$rank" exact="event.param.$rank"/>
          <set_value name="$nameType" exact="event.param.$nameType"/>
        </do_if>
        <do_else>
          <!-- Old format parameter (for backward compatibility) -->
          <set_value name="$skillLevel" exact="event.param.$skillLevel"/>
        </do_else>
        
        <!-- Process parameters based on format -->
        <do_if value="$useNewFormat">
          <!-- New format - use provided parameters -->
          <set_value name="$currentXP" exact="$xp"/>
          <set_value name="$currentLevel" exact="$level"/>
          <set_value name="$rankTitle" exact="$rank"/>
        </do_if>
        <do_else>
          <!-- Old format - calculate from skillLevel -->
          <set_value name="$currentLevel" exact="$skillLevel"/>
          <set_value name="$currentXP" exact="global.$GT_Pilots.{$pilot}.$XP"/>
          <set_value name="$nameType" exact="'trader'"/>  <!-- Default to trader type -->
          
          <!-- Calculate rank title from skill level using unified mapping -->
          <set_value name="$rankIndex" exact="($currentLevel / 3)i + 1"/>
          <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
            <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
          </do_if>
          <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
        </do_else>
        
        <!-- Get ship's base name based on user setting -->
        <!-- Options: 'macro.name' (default), 'typename', 'macro.name.base' -->
        <set_value name="$nameSource" exact="'macro.name'"/>
        <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$ShipNaming? and global.$GT_GlobalSettings.$ShipNaming.$DefaultNameSource?">
          <set_value name="$nameSource" exact="global.$GT_GlobalSettings.$ShipNaming.$DefaultNameSource"/>
        </do_if>
        
        <!-- Resolve original name based on selected source -->
        <set_value name="$originalName" exact="''"/>
        <do_if value="$nameSource == 'basename'">
          <!-- Use stored GT original ship name directly (no stripping or special handling) -->
          <do_if value="global.$GT_Pilots.{$pilot}? and global.$GT_Pilots.{$pilot}.$OriginalShipName?">
            <set_value name="$originalName" exact="global.$GT_Pilots.{$pilot}.$OriginalShipName"/>
          </do_if>
          <do_else>
            <!-- Fallback: If no stored original name, use macro.name -->
            <set_value name="$originalName" exact="$ship.macro.name"/>
            <debug_text text="'[GT-XP] ⚠️ Basename mode: No stored OriginalShipName found for pilot ' + $pilot.name + ', using macro.name as fallback'" chance="100"/>
          </do_else>
        </do_if>
        <do_elseif value="$nameSource == 'macro.name'">
          <!-- Use full model name with variant (e.g., "Mercury Sentinel", "Shuyaku Vanguard") -->
          <set_value name="$originalName" exact="$ship.macro.name"/>
        </do_elseif>
        <do_elseif value="$nameSource == 'typename'">
          <!-- Use generic type name (e.g., "Transporter", "Fighter") -->
          <set_value name="$originalName" exact="$ship.typename"/>
        </do_elseif>
        <do_elseif value="$nameSource == 'macro.name.base'">
          <!-- Use base model name without variant (e.g., "Mercury", "Shuyaku") -->
          <!-- Extract base name by removing Sentinel/Vanguard variants from macro.name -->
          <run_actions ref="md.GT_Ship_Management.Extract_Base_Ship_Name" result="$originalName">
            <param name="macroName" value="$ship.macro.name"/>
          </run_actions>
        </do_elseif>
        <do_else>
          <!-- Fallback to macro.name if invalid setting -->
          <set_value name="$originalName" exact="$ship.macro.name"/>
        </do_else>
        
        <!-- Fallback: If originalName still empty (should never happen), use current name -->
        <do_if value="not $originalName? or $originalName == ''">
          <set_value name="$originalName" exact="$ship.knownname"/>
          <debug_text text="'[GT-XP] ⚠️ Using ship.knownname as fallback (name source unavailable)'" chance="100"/>
        </do_if>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-XP] Building name from ' + $nameSource + ': ' + $originalName" chance="100"/>
        </do_if>
        
        <!-- Build ship name using configurable naming system -->
        <set_value name="$nameElements" exact="[]"/>
        <set_value name="$prefixElements" exact="[]"/>
        <set_value name="$suffixElements" exact="[]"/>
        
        <!-- Check if global settings exist, fallback to default if not -->
        <set_value name="$useConfig" exact="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$ShipNaming?"/>
        
        <!-- Status (training/blocked/advance indicators) -->
        <do_if value="(not $useConfig) or global.$GT_GlobalSettings.$ShipNaming.$DisplayStatus">
          <set_value name="$statusText" exact="''"/>
          <do_if value="$nameType == 'blocked'">
            <set_value name="$statusText" exact="readtext.{77000}.{7001}"/>  <!-- Translated: ADVANCE / FORTSCHRITT / AVANCER / etc. -->
          </do_if>
          <do_elseif value="$nameType == 'training'">
            <set_value name="$statusText" exact="readtext.{77000}.{7002}"/>  <!-- Translated: [TRAINING] / [TRAINING] / [FORMATION] / etc. -->
          </do_elseif>
          
          <do_if value="$statusText != ''">
            <!-- Pattern-based duplicate detection -->
            <!-- CRITICAL: Check CURRENT ship name for prefix, not stored original! -->
            <!-- (Stored original might be from different ship if pilot switched ships) -->
            <set_value name="$statusAlreadyExists" exact="false"/>
            <set_value name="$currentShipName" exact="$ship.knownname"/>
            
            <!-- Check for bracketed prefix like [ANYTHING] in CURRENT name -->
            <do_if value="$currentShipName? and $currentShipName != '' and $currentShipName.indexof.{'['}? and $currentShipName.indexof.{'['} == 0">
              <set_value name="$statusAlreadyExists" exact="true"/>
              <debug_text text="'[GT-XP] Skipping status prefix - current name already has bracketed prefix: ' + $currentShipName" chance="100"/>
            </do_if>
            
            <!-- Check for ALL-CAPS first word (in any language) in CURRENT name -->
            <!-- CRITICAL: Must check if indexof.{' '}? exists BEFORE using it! -->
            <do_if value="$currentShipName? and $currentShipName != '' and not $statusAlreadyExists and $currentShipName.indexof.{' '}?">
              <set_value name="$firstSpace" exact="$currentShipName.indexof.{' '}"/>
              <do_if value="$firstSpace gt 2 and $firstSpace lt 20">
                <!-- Use pattern check: compare position of text after first space in current vs uppercase -->
                <set_value name="$afterFirstSpace" exact="$currentShipName.substring.{$firstSpace + 1}"/>
                <set_value name="$currentShipNameUpper" exact="$currentShipName.toupper"/>
                <do_if value="$afterFirstSpace? and $currentShipNameUpper.indexof.{$afterFirstSpace}? and $currentShipName.indexof.{$afterFirstSpace}? and $currentShipNameUpper.indexof.{$afterFirstSpace} == $currentShipName.indexof.{$afterFirstSpace}">
                  <set_value name="$statusAlreadyExists" exact="true"/>
                  <debug_text text="'[GT-XP] Skipping status prefix - current name already has ALL-CAPS prefix: ' + $currentShipName" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
            
            <do_if value="not $statusAlreadyExists">
              <do_if value="(not $useConfig) or global.$GT_GlobalSettings.$ShipNaming.$StatusPosition == 'prefix'">
                <append_to_list name="$prefixElements" exact="$statusText"/>
              </do_if>
              <do_else>
                <append_to_list name="$suffixElements" exact="$statusText"/>
              </do_else>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Operational State Prefix (REPAIR, RESUPPLY, MAINTENANCE, REROUTE, CLEARANCE) -->
        <!-- These are ADDITIONAL to status prefixes and respect user configuration -->
        <!-- Default to true if setting doesn't exist (backwards compatibility with older saves) -->
        <do_if value="(not $useConfig) or not global.$GT_GlobalSettings.$ShipNaming.$DisplayOperationalState? or @global.$GT_GlobalSettings.$ShipNaming.$DisplayOperationalState">
          <set_value name="$operationalState" exact="''"/>
          
          <!-- Check for repair/resupply state -->
          <do_if value="global.$GT_Ships? and global.$GT_Ships.{$ship}?">
            <set_value name="$shipData" exact="global.$GT_Ships.{$ship}"/>
            <set_value name="$hasRepair" exact="false"/>
            <set_value name="$hasResupply" exact="false"/>
            
            <!-- Check if ship has active repair order -->
            <do_if value="$shipData.$NeedsRepair? and $shipData.$NeedsRepair">
              <set_value name="$hasRepair" exact="true"/>
            </do_if>
            
            <!-- Check if ship has active resupply order -->
            <do_if value="global.$GT_ResupplyOrders? and global.$GT_ResupplyOrders.{$ship}?">
              <set_value name="$hasResupply" exact="true"/>
            </do_if>
            
            <!-- Determine operational state text using translation IDs -->
            <do_if value="$hasRepair and $hasResupply">
              <set_value name="$operationalState" exact="{77000,7005}"/>  <!-- [MAINTENANCE] -->
            </do_if>
            <do_elseif value="$hasRepair">
              <set_value name="$operationalState" exact="{77000,7003}"/>  <!-- [REPAIR] -->
            </do_elseif>
            <do_elseif value="$hasResupply">
              <set_value name="$operationalState" exact="{77000,7004}"/>  <!-- [RESUPPLY] -->
            </do_elseif>
            
            <!-- Check for reroute state (destination threatened/blacklisted) -->
            <do_if value="$shipData.$Rerouting? and $shipData.$Rerouting">
              <set_value name="$operationalState" exact="{77000,7006}"/>  <!-- [REROUTE] -->
            </do_if>
            
            <!-- Check for cargo safety disposal state -->
            <do_if value="$shipData.$CargoDisposal? and $shipData.$CargoDisposal">
              <set_value name="$operationalState" exact="{77000,7007}"/>  <!-- [CLEARANCE] -->
            </do_if>
          </do_if>
          
          <!-- Add operational state to appropriate list based on user config -->
          <!-- Default to prefix if setting doesn't exist (backwards compatibility) -->
          <do_if value="$operationalState != ''">
            <do_if value="(not $useConfig) or not global.$GT_GlobalSettings.$ShipNaming.$OperationalStatePosition? or @global.$GT_GlobalSettings.$ShipNaming.$OperationalStatePosition == 'prefix'">
              <append_to_list name="$prefixElements" exact="$operationalState"/>
            </do_if>
            <do_else>
              <append_to_list name="$suffixElements" exact="$operationalState"/>
            </do_else>
          </do_if>
        </do_if>
        
        <!-- Pilot Rank -->
        <do_if value="(not $useConfig) or global.$GT_GlobalSettings.$ShipNaming.$DisplayRank">
          <!-- Calculate rank index from level -->
          <set_value name="$rankIndex" exact="($currentLevel / 3)i + 1"/>
          <do_if value="$rankIndex gt 6">
            <set_value name="$rankIndex" exact="6"/>  <!-- Max 6 ranks -->
          </do_if>
          
          <!-- Get translated rank title using conditional logic (X4 doesn't support variables in readtext) -->
          <set_value name="$rankTitleText" exact="'Unknown'"/>
          <do_if value="$rankIndex == 1">
            <set_value name="$rankTitleText" exact="readtext.{77000}.{6001}"/>
          </do_if>
          <do_elseif value="$rankIndex == 2">
            <set_value name="$rankTitleText" exact="readtext.{77000}.{6002}"/>
          </do_elseif>
          <do_elseif value="$rankIndex == 3">
            <set_value name="$rankTitleText" exact="readtext.{77000}.{6003}"/>
          </do_elseif>
          <do_elseif value="$rankIndex == 4">
            <set_value name="$rankTitleText" exact="readtext.{77000}.{6004}"/>
          </do_elseif>
          <do_elseif value="$rankIndex == 5">
            <set_value name="$rankTitleText" exact="readtext.{77000}.{6005}"/>
          </do_elseif>
          <do_elseif value="$rankIndex == 6">
            <set_value name="$rankTitleText" exact="readtext.{77000}.{6006}"/>
          </do_elseif>
          
          <do_if value="(not $useConfig) or global.$GT_GlobalSettings.$ShipNaming.$RankPosition == 'prefix'">
            <append_to_list name="$prefixElements" exact="$rankTitleText"/>
          </do_if>
          <do_else>
            <append_to_list name="$suffixElements" exact="$rankTitleText"/>
          </do_else>
        </do_if>
        
        <!-- Level -->
        <do_if value="(not $useConfig) or global.$GT_GlobalSettings.$ShipNaming.$DisplayLevel">
          <set_value name="$levelText" exact="'Lv.' + $currentLevel"/>
          <do_if value="(not $useConfig) or global.$GT_GlobalSettings.$ShipNaming.$LevelPosition == 'prefix'">
            <append_to_list name="$prefixElements" exact="$levelText"/>
          </do_if>
          <do_else>
            <append_to_list name="$suffixElements" exact="$levelText"/>
          </do_else>
        </do_if>
        
        <!-- XP -->
        <do_if value="(not $useConfig) or global.$GT_GlobalSettings.$ShipNaming.$DisplayXP">
          <set_value name="$xpText" exact="'XP:' + $currentXP"/>
          <do_if value="(not $useConfig) or global.$GT_GlobalSettings.$ShipNaming.$XPPosition == 'prefix'">
            <append_to_list name="$prefixElements" exact="$xpText"/>
          </do_if>
          <do_else>
            <append_to_list name="$suffixElements" exact="$xpText"/>
          </do_else>
        </do_if>
        
        <!-- Ship Class -->
        <do_if value="(not $useConfig) or global.$GT_GlobalSettings.$ShipNaming.$DisplayShipClass">
          <!-- Detect ship class using existing library -->
          <run_actions ref="md.GT_Ship_Management.Detect_Ship_Class" result="$classInfo">
            <param name="ship" value="$ship"/>
          </run_actions>
          <set_value name="$shipClassText" exact="$classInfo.$Size"/> <!-- Returns 'S', 'M', 'L', or 'XL' -->
          <do_if value="(not $useConfig) or global.$GT_GlobalSettings.$ShipNaming.$ShipClassPosition == 'prefix'">
            <append_to_list name="$prefixElements" exact="$shipClassText"/>
          </do_if>
          <do_else>
            <append_to_list name="$suffixElements" exact="$shipClassText"/>
          </do_else>
        </do_if>
        
        <!-- Build final name -->
        <set_value name="$newShipName" exact="$originalName"/>
        
        <!-- Add prefix elements -->
        <do_if value="$prefixElements.count gt 0">
          <set_value name="$prefixString" exact="''"/>
          <do_all exact="$prefixElements.count" counter="$j">
            <do_if value="$j gt 1">
              <set_value name="$prefixString" exact="$prefixString + ' '"/>
            </do_if>
            <set_value name="$prefixString" exact="$prefixString + $prefixElements.{$j}"/>
          </do_all>
          <set_value name="$newShipName" exact="$prefixString + ' ' + $newShipName"/>
        </do_if>
        
        <!-- Add suffix elements (only if not already present in CURRENT ship name) -->
        <do_if value="$suffixElements.count gt 0">
          <!-- CRITICAL: Check CURRENT ship name for suffix, not new name being built! -->
          <!-- (After language switch, current name has suffix but new name doesn't yet) -->
          <set_value name="$alreadyHasSuffix" exact="false"/>
          <set_value name="$currentShipName" exact="$ship.knownname"/>
          <do_if value="$currentShipName? and $currentShipName != '' and $currentShipName.indexof.{' ('}?">
            <set_value name="$alreadyHasSuffix" exact="true"/>
            <debug_text text="'[GT-XP] Skipping suffix - current name already has parenthetical: ' + $currentShipName" chance="100"/>
          </do_if>
          
          <do_if value="not $alreadyHasSuffix">
            <set_value name="$suffixString" exact="''"/>
            <do_all exact="$suffixElements.count" counter="$j">
              <do_if value="$j gt 1">
                <set_value name="$suffixString" exact="$suffixString + ' '"/>
              </do_if>
              <set_value name="$suffixString" exact="$suffixString + $suffixElements.{$j}"/>
            </do_all>
            <set_value name="$newShipName" exact="$newShipName + ' (' + $suffixString + ')'"/>
          </do_if>
        </do_if>
        
        <!-- Update ship name -->
        <set_object_name object="$ship" name="$newShipName"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] 🚢 Ship renamed: ' + $newShipName + ' (skill level ' + $currentLevel + ', rank: ' + $rankTitle + ', XP: ' + $currentXP + ', type: ' + $nameType + ') (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
        </do_if>
        </do_else>
      </actions>
    </cue>

    
    <!-- Training Initiation - When pilot's ship docks -->
    <cue name="InitiateTraining" instantiate="true">
      <conditions>
        <event_object_docked object="player.entity"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        <set_value name="$station" exact="event.param"/>
        <set_value name="$pilot" exact="$ship.pilot"/>
        
        <!-- Check if pilot needs training -->
        <do_if value="$pilot and global.$GT_Pilots.{$pilot}? and global.$GT_Pilots.{$pilot}.$XPBlocked?">
          <!-- Validate station type -->
          <set_value name="$validStation" exact="false"/>
          <do_all exact="global.$GT_Config.$Training.$ValidStationTypes.count" counter="$i">
            <do_if value="$station.macro.id? and ($station.macro.id.indexof.{global.$GT_Config.$Training.$ValidStationTypes.{$i}} != -1)">
              <set_value name="$validStation" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          
          <do_if value="$validStation">
            <!-- Calculate training duration -->
            <set_value name="$duration" exact="global.$GT_Config.$Training.$BaseDuration"/>
            
            <do_if value="global.$GT_Config.$Training.$DurationMode == 'skill_based'">
              <set_value name="$skillLevel" exact="global.$GT_Pilots.{$pilot}.$Level"/>
              <set_value name="$duration" exact="$duration + ($skillLevel * global.$GT_Config.$Training.$SkillMultiplier)"/>
            </do_if>
            <do_elseif value="global.$GT_Config.$Training.$DurationMode == 'progressive'">
              <set_value name="$blockedLevel" exact="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
              <set_value name="$duration" exact="$duration + (($blockedLevel - 1) * global.$GT_Config.$Training.$ProgressiveIncrement)"/>
            </do_elseif>
            
            <!-- CRITICAL FIX: Ensure duration stays as time type after calculation -->
            <do_if value="typeof $duration == datatype.integer">
              <set_value name="$duration" exact="$duration * 1s"/>
            </do_if>
            
            <!-- Clear existing orders and start training -->
            <cancel_all_orders object="$ship"/>
            
                    <!-- Create standardized DockAndTrain order -->
        <create_order object="$ship" id="'DockAndTrain'" immediate="true">
              <param name="destination" value="$station"/>
              <param name="debugchance" value="100"/>
            </create_order>
            
            <!-- Mark training as started -->
            <set_value name="global.$GT_Pilots.{$pilot}.$TrainingStarted" exact="player.age"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$TrainingDuration" exact="$duration"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$TrainingStation" exact="$station"/>
            
            <!-- Change to training name using configurable naming system -->
            <set_value name="$currentXP" exact="global.$GT_Pilots.{$pilot}.$XP"/>
            
            <!-- Calculate current skill level for display -->
            <set_value name="$currentSkillLevel" exact="1"/>
            <do_all exact="15" counter="$skillLevelCheck">
              <do_if value="$currentXP ge global.$GT_Config.$XP.$SkillThresholds.{$skillLevelCheck}">
                <set_value name="$currentSkillLevel" exact="$skillLevelCheck"/>
              </do_if>
            </do_all>
            
            <!-- Calculate rank title for display -->
            <set_value name="$rankTitle" exact="'Lehrling'"/>
            <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
              <set_value name="$rankIndex" exact="($currentSkillLevel / 3)i + 1"/>
              <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
              </do_if>
              <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
              </do_if>
            </do_if>
            
                         <signal_cue_instantly cue="UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=$currentXP, $level=$currentSkillLevel, $rank=$rankTitle, $nameType='training']"/>
            
            <!-- Show notification -->
            <do_if value="global.$GT_Config.$Notifications.$TrainingStarted">
              <set_value name="$message" exact="'Pilot ' + $pilot.name + ' started Level ' + global.$GT_Pilots.{$pilot}.$BlockedLevel + ' training\n'"/>
              <set_value name="$message" exact="$message + 'Duration: ' + ($duration / 60) + ' minutes'"/>
              <show_notification text="$message" timeout="8s" priority="6"/>
            </do_if>
            
            <debug_text text="'[GalaxyTrader MK3] Pilot ' + $pilot.name + ' started training for level ' + global.$GT_Pilots.{$pilot}.$BlockedLevel + ' (duration: ' + $duration + ') (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
          </do_if>
          <do_else>
            <debug_text text="'[GalaxyTrader MK3] Training station validation failed for pilot ' + $pilot.name + ' at ' + $station.knownname + ' (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
          </do_else>
        </do_if>
      </actions>
    </cue>
    

    
    <!-- OLD CUES REMOVED IN PHASE 2: TrainingCompleted and TrainingInterrupted
         These have been replaced by ProcessTrainingEvents for instant event-driven processing -->
    
    <!-- PHASE 2 IMPROVEMENT: Event-Driven Training Completion Handler -->
    <!-- ✅ EVENT-DRIVEN: Listen for signal instead of polling -->
    <cue name="ProcessTrainingEvents" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_XP_Training.ProcessTrainingEvents"/>
      </conditions>
      <actions>
        
        <!-- Process all queued training events -->
        <do_if value="global.$GT_TrainingEventQueue? and global.$GT_TrainingEventQueue.count gt 0">
          <debug_text text="'[GalaxyTrader MK3] ⚡ Processing ' + global.$GT_TrainingEventQueue.count + ' training events instantly'" chance="100"/>
          
          <do_while value="global.$GT_TrainingEventQueue.count gt 0">
            <!-- Get next event -->
            <set_value name="$event" exact="global.$GT_TrainingEventQueue.{1}"/>
            <remove_from_list name="global.$GT_TrainingEventQueue" exact="$event"/>
            
            <!-- Extract event data -->
            <set_value name="$ship" exact="$event.$ship"/>
            <set_value name="$pilot" exact="$event.$pilot"/>
            <set_value name="$eventType" exact="$event.$eventType"/>
            
            <!-- Process based on event type -->
            <do_if value="$eventType == 'training_completed'">
              <set_value name="$completedLevel" exact="$event.$completedLevel"/>
              <set_value name="$trainingStation" exact="$event.$trainingStation"/>
              
              <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 🎓 Training completion event received'" chance="100"/>
              
              <do_if value="$pilot and global.$GT_Pilots.{$pilot}? and global.$GT_Pilots.{$pilot}.$XPBlocked?">
                <!-- Training completed! -->
                <set_value name="$trainedLevel" exact="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
                <append_to_list name="global.$GT_Pilots.{$pilot}.$TrainingCompleted" exact="$trainedLevel"/>
                
                <!-- Apply pending skill level increase if available -->
                <do_if value="global.$GT_Pilots.{$pilot}.$PendingSkillLevel?">
                  <set_value name="$pendingLevel" exact="global.$GT_Pilots.{$pilot}.$PendingSkillLevel"/>
                  
                  <!-- Now apply the skill level increase that was delayed -->
                  <set_skill entity="$pilot" type="skilltype.management" exact="$pendingLevel"/>
                  <set_value name="global.$GT_Pilots.{$pilot}.$Level" exact="$pendingLevel"/>
                  
                  <!-- Update pilot skill proportionally: Management Level 15 (5 stars) → Pilot Level 9 (3 stars) -->
                  <!-- Formula: pilot_level = (management_level * 9) / 15 -->
                  <!-- Never reduce pilot skill, only increase if target is higher -->
                  <set_value name="$currentPilotSkill" exact="0"/>
                  <do_if value="$pilot.skill.piloting?">
                    <set_value name="$currentPilotSkill" exact="@$pilot.skill.piloting"/>
                  </do_if>
                  <!-- Calculate target pilot skill level -->
                  <set_value name="$targetPilotLevel" exact="($pendingLevel * 9) / 15"/>
                  <do_if value="$targetPilotLevel lt 1">
                    <set_value name="$targetPilotLevel" exact="1"/>
                  </do_if>
                  <do_if value="$targetPilotLevel gt 9">
                    <set_value name="$targetPilotLevel" exact="9"/>
                  </do_if>
                  <!-- Only increase pilot skill if target is higher than current -->
                  <do_if value="$targetPilotLevel gt $currentPilotSkill">
                    <set_skill entity="$pilot" type="skilltype.piloting" exact="$targetPilotLevel"/>
                    <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ✈️ Pilot skill increased from ' + $currentPilotSkill + ' to ' + $targetPilotLevel + ' (management: ' + $pendingLevel + ')'" chance="100"/>
                  </do_if>
                  
                  <!-- Calculate star rating for notification -->
                  <set_value name="$starRating" exact="'⭐'"/>
                  <do_if value="$pendingLevel ge 13">
                    <set_value name="$starRating" exact="'⭐⭐⭐⭐⭐'"/>
                  </do_if>
                  <do_elseif value="$pendingLevel ge 10">
                    <set_value name="$starRating" exact="'⭐⭐⭐⭐'"/>
                  </do_elseif>
                  <do_elseif value="$pendingLevel ge 7">
                    <set_value name="$starRating" exact="'⭐⭐⭐'"/>
                  </do_elseif>
                  <do_elseif value="$pendingLevel ge 4">
                    <set_value name="$starRating" exact="'⭐⭐'"/>
                  </do_elseif>
                  
                  <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ⭐ Pilot ' + $pilot.name + ' skill level increased to ' + $pendingLevel + ' (' + $starRating + ') after training completion!'" chance="100"/>
                  
                  <!-- Show level up notification -->
                  <do_if value="global.$GT_Config.$Notifications.$LevelUp">
                    <set_value name="$levelUpMessage" exact="'Pilot ' + $pilot.name + ' reached Skill Level ' + $pendingLevel + ' (' + $starRating + ') after training!'"/>
                    <show_notification text="$levelUpMessage" timeout="8s" priority="8"/>
                    <run_actions ref="md.GT_Libraries_General.WriteLogbookMessage">
                      <param name="Message" value="$levelUpMessage"/>
                      <param name="Category" value="'news'"/>
                      <param name="Title" value="'Level Up: ' + $pilot.name + ' (' + $ship.knownname + ')'"/>
                      <param name="Object" value="$ship"/>
                      <param name="Interaction" value="'showonmap'"/>
                      <param name="CheckGlobalSettings" value="false"/>
                    </run_actions>
                  </do_if>
                  
                  <!-- Clean up pending skill level -->
                  <remove_value name="global.$GT_Pilots.{$pilot}.$PendingSkillLevel"/>
                  
                  <set_value name="$currentSkillLevel" exact="$pendingLevel"/>
                </do_if>
                <do_else>
                  <!-- No pending skill level - calculate current level -->
                  <set_value name="$currentSkillLevel" exact="1"/>
                  <do_all exact="15" counter="$skillLevel">
                    <do_if value="global.$GT_Pilots.{$pilot}.$XP ge global.$GT_Config.$XP.$SkillThresholds.{$skillLevel}">
                      <set_value name="$currentSkillLevel" exact="$skillLevel"/>
                    </do_if>
                  </do_all>
                </do_else>
                
                <!-- PHASE 2 IMPROVEMENT: Award any blocked XP that accumulated during training -->
                <do_if value="global.$GT_Pilots.{$pilot}.$BlockedXPPending?">
                  <set_value name="$blockedXP" exact="global.$GT_Pilots.{$pilot}.$BlockedXPPending"/>
                  <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') 💰 Awarding blocked XP: ' + $blockedXP + ' XP to pilot ' + $pilot.name + ' after training completion'" chance="100"/>
                  
                  <!-- Award the blocked XP immediately -->
                  <set_value name="$preTrainingXP" exact="global.$GT_Pilots.{$pilot}.$XP"/>
                  <set_value name="$newTotalXP" exact="$preTrainingXP + $blockedXP"/>
                  <set_value name="global.$GT_Pilots.{$pilot}.$XP" exact="$newTotalXP"/>
                  <set_value name="global.$GT_SessionStats.$XPGained" exact="global.$GT_SessionStats.$XPGained + $blockedXP"/>
                  
                  <!-- Check if blocked XP causes additional skill level increases -->
                  <set_value name="$postTrainingSkillLevel" exact="1"/>
                  <do_all exact="15" counter="$skillLevel">
                    <do_if value="$newTotalXP ge global.$GT_Config.$XP.$SkillThresholds.{$skillLevel}">
                      <set_value name="$postTrainingSkillLevel" exact="$skillLevel"/>
                    </do_if>
                  </do_all>
                  
                  <!-- Update skill level if blocked XP caused additional increases -->
                  <do_if value="$postTrainingSkillLevel gt $currentSkillLevel">
                    <set_skill entity="$pilot" type="skilltype.management" exact="$postTrainingSkillLevel"/>
                    <set_value name="global.$GT_Pilots.{$pilot}.$Level" exact="$postTrainingSkillLevel"/>
                    <set_value name="$currentSkillLevel" exact="$postTrainingSkillLevel"/>
                    
                    <!-- Update pilot skill proportionally: Management Level 15 (5 stars) → Pilot Level 9 (3 stars) -->
                    <!-- Formula: pilot_level = (management_level * 9) / 15 -->
                    <!-- Never reduce pilot skill, only increase if target is higher -->
                    <set_value name="$currentPilotSkill" exact="0"/>
                    <do_if value="$pilot.skill.piloting?">
                      <set_value name="$currentPilotSkill" exact="@$pilot.skill.piloting"/>
                    </do_if>
                    <!-- Calculate target pilot skill level -->
                    <set_value name="$targetPilotLevel" exact="($postTrainingSkillLevel * 9) / 15"/>
                    <do_if value="$targetPilotLevel lt 1">
                      <set_value name="$targetPilotLevel" exact="1"/>
                    </do_if>
                    <do_if value="$targetPilotLevel gt 9">
                      <set_value name="$targetPilotLevel" exact="9"/>
                    </do_if>
                    <!-- Only increase pilot skill if target is higher than current -->
                    <do_if value="$targetPilotLevel gt $currentPilotSkill">
                      <set_skill entity="$pilot" type="skilltype.piloting" exact="$targetPilotLevel"/>
                      <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ✈️ Pilot skill increased from ' + $currentPilotSkill + ' to ' + $targetPilotLevel + ' (management: ' + $postTrainingSkillLevel + ')'" chance="100"/>
                    </do_if>
                    
                    <!-- Calculate new star rating -->
                    <set_value name="$newStarRating" exact="($postTrainingSkillLevel / 3)i"/>
                    <do_if value="$newStarRating gt 5">
                      <set_value name="$newStarRating" exact="5"/>
                    </do_if>
                    
                    <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ⭐ Blocked XP caused additional skill increase to level ' + $postTrainingSkillLevel + ' (' + $newStarRating + ' stars)!'" chance="100"/>
                    
                    <!-- Notify player about bonus level increases -->
                    <do_if value="global.$GT_Config.$Notifications.$LevelUp">
                      <set_value name="$bonusMessage" exact="'Pilot ' + $pilot.name + ' gained additional skill levels from blocked XP!\nNow at Level ' + $postTrainingSkillLevel + ' (' + $newStarRating + ' stars)!'"/>
                      <show_notification text="$bonusMessage" timeout="8s" priority="8"/>
                      <run_actions ref="md.GT_Libraries_General.WriteLogbookMessage">
                        <param name="Message" value="$bonusMessage"/>
                        <param name="Category" value="'news'"/>
                        <param name="Title" value="'Bonus Level Up: ' + $pilot.name + ' (' + $ship.knownname + ')'"/>
                        <param name="Object" value="$ship"/>
                        <param name="Interaction" value="'showonmap'"/>
                        <param name="CheckGlobalSettings" value="false"/>
                      </run_actions>
                    </do_if>
                  </do_if>
                  
                  <!-- Clean up blocked XP -->
                  <remove_value name="global.$GT_Pilots.{$pilot}.$BlockedXPPending"/>
                  
                  <!-- Enhanced completion notification with XP info -->
                  <do_if value="global.$GT_Config.$Notifications.$TrainingCompleted">
                    <set_value name="$enhancedMessage" exact="'Pilot ' + $pilot.name + ' completed Level ' + $trainedLevel + ' training!\n'"/>
                    <set_value name="$enhancedMessage" exact="$enhancedMessage + 'Awarded ' + $blockedXP + ' blocked XP. Total XP: ' + $newTotalXP"/>
                    <show_notification text="$enhancedMessage" timeout="10s" priority="7"/>
                  </do_if>
                </do_if>
                
                <!-- Unblock XP progression -->
                <remove_value name="global.$GT_Pilots.{$pilot}.$XPBlocked"/>
                <remove_value name="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
                
                <!-- Update ship name to match current skill level (new format) -->
                <set_value name="$rankTitle" exact="'Lehrling'"/>
                <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                  <set_value name="$rankIndex" exact="($currentSkillLevel / 3)i + 1"/>
                  <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                    <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
                  </do_if>
                  <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                    <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                  </do_if>
                </do_if>
                <signal_cue_instantly cue="UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=@global.$GT_Pilots.{$pilot}.$XP, $level=$currentSkillLevel, $rank=$rankTitle, $nameType='trader']"/>
                
                <!-- Update ship modifications after training completion -->
                <signal_objects object="player.galaxy" param="'GT_Update_Ship'" param2="table[
                  $ship = $ship,
                  $pilot = $pilot,
                  $updateType = 'training_completion'
                ]"/>
                
                <!-- Clean up training data -->
                <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingStarted"/>
                <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingDuration"/>
                <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingStation"/>
                
                <!-- Show completion notification -->
                <do_if value="global.$GT_Config.$Notifications.$TrainingCompleted">
                  <set_value name="$message" exact="'Pilot ' + $pilot.name + ' completed Level ' + $trainedLevel + ' training!\n'"/>
                  <set_value name="$message" exact="$message + 'XP progression unlocked at ' + $trainingStation.knownname + '.'"/>
                  <show_notification text="$message" timeout="8s" priority="7"/>
                </do_if>
                
                <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ✅ Pilot ' + $pilot.name + ' completed Level ' + $trainedLevel + ' training - XP progression unlocked'" chance="100"/>
              </do_if>
              <do_else>
                <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ⚠️ Training completion event received but pilot not blocked or missing'" chance="100"/>
              </do_else>
              
            </do_if>
            <do_elseif value="$eventType == 'training_interrupted'">
              <set_value name="$interruptedLevel" exact="$event.$interruptedLevel"/>
              <set_value name="$trainingStation" exact="$event.$trainingStation"/>
              
              <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ⚠️ Training interruption event received'" chance="100"/>
              
              <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
                <!-- Clean up training data but keep XP block -->
                <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingStarted"/>
                <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingDuration"/>
                <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingStation"/>
                
                <!-- Restore ship name if possible -->
                <do_if value="global.$GT_Pilots.{$pilot}.$OriginalShipName?">
                  <set_value name="$currentSkillLevel" exact="1"/>
                  <do_all exact="15" counter="$skillLevel">
                    <do_if value="global.$GT_Pilots.{$pilot}.$XP ge global.$GT_Config.$XP.$SkillThresholds.{$skillLevel}">
                      <set_value name="$currentSkillLevel" exact="$skillLevel"/>
                    </do_if>
                  </do_all>
                  
                  <set_value name="$rankTitle" exact="'Lehrling'"/>
                  <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                    <set_value name="$rankIndex" exact="($currentSkillLevel / 3)i + 1"/>
                    <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                      <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
                    </do_if>
                    <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                      <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                    </do_if>
                  </do_if>
                  <signal_cue_instantly cue="UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=@global.$GT_Pilots.{$pilot}.$XP, $level=$currentSkillLevel, $rank=$rankTitle, $nameType='trader']"/>
                </do_if>
                
                <!-- Show interruption notification -->
                <do_if value="global.$GT_Config.$Notifications.$TrainingStarted">
                  <show_notification text="'Training interrupted for ' + $pilot.name + '!\nPilot still needs to complete training to unlock XP progression.'" timeout="6s" priority="5"/>
                </do_if>
                
                <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') ⚠️ Training interrupted for pilot ' + $pilot.name" chance="100"/>
              </do_if>
            </do_elseif>
          </do_while>
        </do_if>
      </actions>
    </cue>
    
    <!-- Legacy Training Completion Check - REMOVED: Pure event-driven system -->
    <!-- Training Signal Handlers -->
    
    <!-- Training Script Starting Signal Handler -->
    <cue name="HandleTrainingScriptStarting" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Training_Script_Starting'" comment="Handle training script startup"/>
      </conditions>
      <actions>
        <set_value name="$startData" exact="event.param2"/>
        <set_value name="$ship" exact="$startData.$Ship"/>
        <set_value name="$pilot" exact="$startData.$Pilot"/>
        
        <debug_text text="'[GalaxyTrader MK3] Training script starting signal received for ' + $ship.knownname" chance="100"/>
        
        <!-- Initialize training if needed -->
        <do_if value="$pilot and not global.$GT_Pilots.{$pilot}?">
          <debug_text text="'[GalaxyTrader MK3] Pilot ' + $pilot.name + ' not in registry during training start - this should not happen'" chance="100"/>
          <!-- Re-register pilot with basic data if missing -->
          <signal_objects object="player.galaxy" param="'GT_AI_Started'" param2="table[
            $Ship = $ship,
            $Config = table[
              $allowillegal = false,
              $debuglevel = 2,
              $autotraining = true
            ]
          ]"/>
        </do_if>
      </actions>
    </cue>

    <!-- Check Training Required Signal Handler -->
    <cue name="HandleCheckTrainingRequired" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Check_Training_Required'" comment="Handle training requirement check"/>
      </conditions>
      <actions>
        <set_value name="$checkData" exact="event.param2"/>
        <set_value name="$ship" exact="$checkData.$Ship"/>
        <set_value name="$pilot" exact="$checkData.$Pilot"/>
        
        <debug_text text="'[GalaxyTrader MK3] Training requirement check for ' + $pilot.name + ' on ' + $ship.knownname" chance="100"/>
        
        <!-- Check if training is required and respond -->
        <set_value name="$trainingRequired" exact="false"/>
        <do_if value="global.$GT_Pilots.{$pilot}? and global.$GT_Pilots.{$pilot}.$XPBlocked?">
          <set_value name="$trainingRequired" exact="true"/>
        </do_if>
        
        <!-- Signal back to AI script with result -->
        <signal_objects object="player.galaxy" param="'GT_Training_Check_Result'" param2="table[
          $Ship = $ship,
          $Pilot = $pilot,
          $TrainingRequired = $trainingRequired,
          $BlockedLevel = @global.$GT_Pilots.{$pilot}.$BlockedLevel
        ]"/>
      </actions>
    </cue>

    <!-- Start Training Signal Handler -->
    <cue name="HandleStartTraining" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Start_Training'" comment="Handle training start request"/>
      </conditions>
      <actions>
        <set_value name="$trainingData" exact="event.param2"/>
        <set_value name="$ship" exact="$trainingData.$Ship"/>
        <set_value name="$pilot" exact="$trainingData.$Pilot"/>
        <set_value name="$station" exact="$trainingData.$TrainingStation"/>
        <set_value name="$level" exact="$trainingData.$TrainingLevel"/>
        
        <debug_text text="'[GalaxyTrader MK3] Start training signal received for ' + $pilot.name + ' at level ' + $level" chance="100"/>
        
        <!-- Process training start -->
        <do_if value="global.$GT_Pilots.{$pilot}?">
          <!-- Calculate proper training duration from config (PRODUCTION MODE) -->
          <set_value name="$duration" exact="global.$GT_Config.$Training.$BaseDuration"/>
          
          <do_if value="global.$GT_Config.$Training.$DurationMode == 'skill_based'">
            <set_value name="$skillLevel" exact="global.$GT_Pilots.{$pilot}.$Level"/>
            <set_value name="$duration" exact="$duration + ($skillLevel * global.$GT_Config.$Training.$SkillMultiplier)"/>
          </do_if>
          <do_elseif value="global.$GT_Config.$Training.$DurationMode == 'progressive'">
            <set_value name="$duration" exact="$duration + (($level - 1) * global.$GT_Config.$Training.$ProgressiveIncrement)"/>
          </do_elseif>
          
          <!-- CRITICAL FIX: Ensure duration stays as time type after calculation -->
          <do_if value="typeof $duration == datatype.integer">
            <set_value name="$duration" exact="$duration * 1s"/>
          </do_if>
          
          <set_value name="global.$GT_Pilots.{$pilot}.$TrainingStarted" exact="player.age"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$TrainingDuration" exact="$duration"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$TrainingStation" exact="$station"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$XPBlocked" exact="true"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$BlockedLevel" exact="$level"/>
          
          <debug_text text="'[GalaxyTrader MK3] Training started for ' + $pilot.name + ' - Level ' + $level + ' training, Duration: ' + ($duration / 60) + ' minutes (PRODUCTION MODE)'" chance="100"/>
          
          <!-- Update ship name to show training status -->
                      <!-- Use configurable naming system for training -->
            <set_value name="$currentXP" exact="global.$GT_Pilots.{$pilot}.$XP"/>
            <set_value name="$rankTitle" exact="'Lehrling'"/>
            <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
              <set_value name="$rankIndex" exact="1"/>
              <do_if value="$level ge 15">
                <set_value name="$rankIndex" exact="6"/>
              </do_if>
              <do_elseif value="$level ge 13">
                <set_value name="$rankIndex" exact="5"/>
              </do_elseif>
              <do_elseif value="$level ge 10">
                <set_value name="$rankIndex" exact="4"/>
              </do_elseif>
              <do_elseif value="$level ge 7">
                <set_value name="$rankIndex" exact="3"/>
              </do_elseif>
              <do_elseif value="$level ge 4">
                <set_value name="$rankIndex" exact="2"/>
              </do_elseif>
              
              <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
              </do_if>
            </do_if>
                         <signal_cue_instantly cue="UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=$currentXP, $level=$level, $rank=$rankTitle, $nameType='training']"/>
        </do_if>
      </actions>
    </cue>

    <!-- Abort Training Signal Handler -->
    <cue name="HandleAbortTraining" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Abort_Training'" comment="Handle training abortion"/>
      </conditions>
      <actions>
        <set_value name="$abortData" exact="event.param2"/>
        <set_value name="$ship" exact="$abortData.$Ship"/>
        <set_value name="$pilot" exact="$abortData.$Pilot"/>
        <set_value name="$reason" exact="$abortData.$Reason"/>
        
        <debug_text text="'[GalaxyTrader MK3] Training abort signal received for ' + $pilot.name + ': ' + $reason" chance="100"/>
        
        <!-- Process training abortion -->
        <do_if value="global.$GT_Pilots.{$pilot}?">
          <!-- Clean up training data but keep XP block -->
          <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingStarted"/>
          <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingDuration"/>
          <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingStation"/>
          
          <!-- Restore ship name to show blocked status using new naming system -->
          <set_value name="$currentXP" exact="global.$GT_Pilots.{$pilot}.$XP"/>
          <set_value name="$blockedLevel" exact="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
          
          <!-- Calculate rank title -->
          <set_value name="$rankIndex" exact="1"/>
          <do_if value="$blockedLevel ge 15">
            <set_value name="$rankIndex" exact="6"/>
          </do_if>
          <do_elseif value="$blockedLevel ge 13">
            <set_value name="$rankIndex" exact="5"/>
          </do_elseif>
          <do_elseif value="$blockedLevel ge 10">
            <set_value name="$rankIndex" exact="4"/>
          </do_elseif>
          <do_elseif value="$blockedLevel ge 7">
            <set_value name="$rankIndex" exact="3"/>
          </do_elseif>
          <do_elseif value="$blockedLevel ge 4">
            <set_value name="$rankIndex" exact="2"/>
          </do_elseif>
          <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
          
          <signal_cue_instantly cue="UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=$currentXP, $level=$blockedLevel, $rank=$rankTitle, $nameType='blocked']"/>
          
          <debug_text text="'[GalaxyTrader MK3] Training aborted for ' + $pilot.name + ' - pilot still blocked, ship renamed to show blocked status'" chance="100"/>
        </do_if>
      </actions>
    </cue>

    <!-- Complete Training Signal Handler -->
    <cue name="HandleCompleteTraining" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Complete_Training'" comment="Handle training completion"/>
      </conditions>
      <actions>
        <set_value name="$completionData" exact="event.param2"/>
        <set_value name="$ship" exact="$completionData.$Ship"/>
        <set_value name="$pilot" exact="$completionData.$Pilot"/>
        <set_value name="$completedLevel" exact="$completionData.$Level"/>
        
        <debug_text text="'[GalaxyTrader MK3] Training completion signal received for ' + $pilot.name + ' at level ' + $completedLevel" chance="100"/>
        
        <!-- Add to training event queue for processing -->
        <!-- ✅ SIMPLIFIED: Initialization guarantees global.$GT_TrainingEventQueue exists -->
        
        <append_to_list name="global.$GT_TrainingEventQueue" exact="table[
          $ship = $ship,
          $pilot = $pilot,
          $completedLevel = $completedLevel,
          $trainingStation = @global.$GT_Pilots.{$pilot}.$TrainingStation,
          $timestamp = player.age,
          $eventType = 'training_completed'
        ]"/>
        
        <!-- ✅ EVENT-DRIVEN: Signal MD cue directly (no polling needed) -->
        <signal_cue_instantly cue="md.GT_XP_Training.ProcessTrainingEvents"/>
        
        <debug_text text="'[GalaxyTrader MK3] Training completion added to event queue for processing'" chance="100"/>
      </actions>
    </cue>

    <!-- Training Needed Signal Handler -->
    <cue name="HandleTrainingNeeded" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Training_Needed'" comment="Handle training needed notification"/>
      </conditions>
      <actions>
        <set_value name="$needData" exact="event.param2"/>
        <set_value name="$ship" exact="$needData.$Ship"/>
        <set_value name="$pilot" exact="$needData.$Pilot"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Training needed signal received for ' + $pilot.name" chance="100"/>
        </do_if>
        
        <!-- Check if we can automatically start training -->
        <do_if value="global.$GT_GlobalSettings.$XP.$AutoTraining">
          <!-- Calculate pilot skill-based jump distance limit -->
          <set_value name="$pilotSkill" exact="1"/>
          <do_if value="$ship.pilot.skill.management?">
            <set_value name="$pilotSkill" exact="$ship.pilot.skill.management"/>
          </do_if>
          
          <!-- Skill-based jump distance calculation -->
          <set_value name="$maxJumps" exact="1"/>
          <do_if value="$pilotSkill le 2">
            <set_value name="$maxJumps" exact="1"/>   <!-- Lehrling -->
          </do_if>
          <do_elseif value="$pilotSkill le 5">
            <set_value name="$maxJumps" exact="3"/>   <!-- Kurier -->
          </do_elseif>
          <do_elseif value="$pilotSkill le 8">
            <set_value name="$maxJumps" exact="5"/>   <!-- Lieferant -->
          </do_elseif>
          <do_elseif value="$pilotSkill le 11">
            <set_value name="$maxJumps" exact="10"/>  <!-- Händler -->
          </do_elseif>
          <do_elseif value="$pilotSkill le 13">
            <set_value name="$maxJumps" exact="15"/>  <!-- Kaufmann -->
          </do_elseif>
          <do_else>
            <set_value name="$maxJumps" exact="25"/>  <!-- Fernkaufmann -->
          </do_else>
          
          <!-- ✅ FIX: Find training stations - ONLY trading stations, with blacklist-aware pathfinding and docking capability checks -->
          <create_list name="$stations"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Searching for training facilities (trading stations only, max ' + $maxJumps + ' jumps, skill level ' + $pilotSkill + ')'" chance="100"/>
          </do_if>
          
          <!-- Get blacklist group for pathfinding (needed before distance checks) -->
          <run_actions ref="md.GT_Libraries_Blacklist.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
          
          <!-- Find trading stations - KNOWN to player, dockable -->
          <find_station name="$tradingPosts" space="player.galaxy" multiple="true" tradestation="true" tradesknownto="faction.player">
            <match class="[class.station]"/>
            <match owner="[faction.player]" negate="true"/>
            <match owner="[faction.xenon, faction.khaak, faction.yaki]" negate="true"/>
            <match_relation_to object="$ship" relation="dock" comparison="ge"/>
          </find_station>
          
          <do_all exact="$tradingPosts.count" counter="$i">
            <set_value name="$station" exact="$tradingPosts.{$i}"/>
            <set_value name="$isValid" exact="true"/>
            
            <!-- CHECK 1: Full reachability check (station known + basic path + blacklist-aware path) -->
            <!-- ✅ FIX: Check ALL reachability requirements BEFORE evaluating other checks -->
            <run_actions ref="md.GT_Libraries_Pathfinding.GT_IsStationReachable" result="$isReachable">
              <param name="ship" value="$ship"/>
              <param name="station" value="$station"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
              <param name="returnDetails" value="false"/>
            </run_actions>
            <do_if value="not $isReachable">
              <set_value name="$isValid" exact="false"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3] Training station ' + $station.knownname + ' filtered out - not reachable (station unknown or no path)'" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- Get distance for distance check (if reachable) -->
            <do_if value="$isValid">
              <run_actions ref="md.GT_Libraries_Pathfinding.GT_CalculatePathDistance" result="$gateDistance">
                <param name="ship" value="$ship"/>
                <param name="fromSector" value="$ship.sector"/>
                <param name="toSector" value="$station.sector"/>
                <param name="blacklistgroup" value="$blacklistgroup"/>
                <param name="useEscapeMode" value="false"/>
              </run_actions>
              <do_if value="$gateDistance gt $maxJumps">
                <set_value name="$isValid" exact="false"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GalaxyTrader MK3] Training station ' + $station.knownname + ' filtered out - distance: ' + $gateDistance + ' (max: ' + $maxJumps + ')'" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
            
            <!-- CHECK 2: Blacklist checks (station + sector) -->
            <do_if value="$isValid">
              <run_actions ref="md.GT_Libraries_Blacklist.GT_IsStationBlacklisted" result="$stationBlacklisted">
                <param name="station" value="$station"/>
                <param name="ship" value="$ship"/>
                <param name="blacklistgroup" value="$blacklistgroup"/>
              </run_actions>
              <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$sectorBlacklistDetails">
                <param name="sector" value="$station.sector"/>
                <param name="ship" value="$ship"/>
                <param name="blacklistgroup" value="$blacklistgroup"/>
                <param name="returnDetails" value="true"/>
              </run_actions>
              <set_value name="$sectorTravelBlacklisted" exact="$sectorBlacklistDetails.$TravelBlacklisted"/>
              <set_value name="$sectorActivityBlacklisted" exact="$sectorBlacklistDetails.$ActivityBlacklisted"/>
              
              <do_if value="$stationBlacklisted or $sectorTravelBlacklisted or $sectorActivityBlacklisted">
                <set_value name="$isValid" exact="false"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GalaxyTrader MK3] Training station ' + $station.knownname + ' filtered out - blacklisted (station: ' + $stationBlacklisted + ', sector travel: ' + $sectorTravelBlacklisted + ', sector activity: ' + $sectorActivityBlacklisted + ')'" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
            
            <!-- CHECK 3: CRITICAL - Technical docking capability - does station have docking bay for this ship size? -->
            <do_if value="$isValid">
              <find_dockingbay name="$testDock" object="$station" checkoperational="true" multiple="false">
                <match_dock size="$ship.docksize" storage="false"/>
              </find_dockingbay>
              <do_if value="not $testDock">
                <set_value name="$isValid" exact="false"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GalaxyTrader MK3] Training station ' + $station.knownname + ' filtered out - no docking bay for ship size ' + $ship.docksize" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
            
            <!-- CHECK 4: Docking permission -->
            <do_if value="$isValid">
              <set_value name="$checkDocking" exact="not $ship.iscapitalship or ($station.isclass.station)"/>
              <set_value name="$canDock" exact="true"/>
              <do_if value="$checkDocking">
                <set_value name="$canDock" exact="$station.dockingallowed.{$ship}"/>
              </do_if>
              <do_if value="not $canDock">
                <set_value name="$isValid" exact="false"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GalaxyTrader MK3] Training station ' + $station.knownname + ' filtered out - docking not allowed'" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
            
            <!-- Add valid station to list -->
            <do_if value="$isValid">
              <append_to_list name="$stations" exact="$station"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3] ✓ Added training station: ' + $station.knownname + ' (' + $gateDistance + ' jumps, sector: ' + $station.sector.knownname + ')'" chance="100"/>
              </do_if>
            </do_if>
          </do_all>

          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Found ' + $stations.count + ' accessible training stations (within ' + $maxJumps + ' jumps)'" chance="100"/>
          </do_if>
          
          <do_if value="$stations.count gt 0">
            <!-- ✅ FIX: Find nearest station using blacklist-aware pathfinding (same as used for filtering) -->
            <set_value name="$nearestStation" exact="$stations.{1}"/>
            <run_actions ref="md.GT_Libraries_Pathfinding.GT_CalculatePathDistance" result="$nearestDistance">
              <param name="ship" value="$ship"/>
              <param name="fromSector" value="$ship.sector"/>
              <param name="toSector" value="$nearestStation.sector"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
              <param name="useEscapeMode" value="false"/>
            </run_actions>
            
            <!-- Find closest station using blacklist-aware pathfinding -->
            <do_all exact="$stations.count" counter="$i">
              <run_actions ref="md.GT_Libraries_Pathfinding.GT_CalculatePathDistance" result="$distance">
                <param name="ship" value="$ship"/>
                <param name="fromSector" value="$ship.sector"/>
                <param name="toSector" value="$stations.{$i}.sector"/>
                <param name="blacklistgroup" value="$blacklistgroup"/>
                <param name="useEscapeMode" value="false"/>
              </run_actions>
              <do_if value="$distance lt $nearestDistance">
                <set_value name="$nearestStation" exact="$stations.{$i}"/>
                <set_value name="$nearestDistance" exact="$distance"/>
              </do_if>
            </do_all>
            
            <!-- Signal directly to ship with training station found -->
            <signal_objects object="$ship" param="'GT_Training_Station_Found'" param2="table[
              $Station = $nearestStation,
              $Level = @global.$GT_Pilots.{$pilot}.$BlockedLevel,
              $Distance = $nearestDistance
            ]"/>
          </do_if>
          <do_else>
            <!-- ✅ CRITICAL FIX: No training stations found - temporarily clear XPBlocked to allow trading -->
            <!-- Ship will continue trading and check for training stations again on next opportunity -->
            <!-- This prevents ships from being stuck when training stations are unavailable -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] ⚠️ No accessible training stations found for ' + $pilot.name + ' (ship: ' + $ship.idcode + ') - temporarily allowing trading. Will check for training stations again later.'" chance="100"/>
            </do_if>
            
            <!-- ✅ ROLE-PLAY LOGBOOK MESSAGE: Pilot reports training station search failure -->
            <set_value name="$blockedLevel" exact="@global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
            <set_value name="$logbookMessage" exact="readtext.{77000}.{3223}.[$blockedLevel]"/>
            <run_actions ref="md.GT_Libraries_General.WriteLogbookMessage">
              <param name="Message" value="$logbookMessage"/>
              <param name="Category" value="'upkeep'"/>
              <param name="Title" value="'Training Station Search Failed: ' + $pilot.name + ' (' + $ship.knownname + ')'"/>
              <param name="Object" value="$ship"/>
              <param name="Interaction" value="'showonmap'"/>
              <param name="Highlighted" value="true"/>
              <param name="CheckGlobalSettings" value="false"/>
            </run_actions>
            
            <!-- Temporarily clear XPBlocked to allow ship to trade -->
            <!-- Ship will check for training again on next main_loop iteration when not busy -->
            <remove_value name="global.$GT_Pilots.{$pilot}.$XPBlocked"/>
            <!-- Keep BlockedLevel so we know what level training is needed when stations become available -->
            <!-- Signal ship to break wait loop and continue trading -->
            <signal_objects object="$ship" param="'GT_No_Trade_Found'" param2="'no_training_stations'"/>
          </do_else>
        </do_if>
      </actions>
    </cue>



    <!-- Training Completion Monitor -->
    <cue name="MonitorTrainingCompletion" instantiate="true" checkinterval="10s">
      <conditions>
        <check_value value="global.$GT_TrainingCompletionScheduled? and player.age ge global.$GT_TrainingCompletionScheduled"/>
      </conditions>
      <actions>
        <!-- Find all pilots currently in training -->
        <do_if value="global.$GT_Pilots?">
          <set_value name="$pilotKeys" exact="global.$GT_Pilots.keys.list"/>
          <do_all exact="$pilotKeys.count" counter="$i">
            <set_value name="$pilot" exact="$pilotKeys.{$i}"/>
            <set_value name="$pilotData" exact="global.$GT_Pilots.{$pilot}"/>
            
            <!-- Check if this pilot's training is complete -->
            <do_if value="$pilotData.$TrainingStarted? and $pilotData.$TrainingDuration? and (player.age ge ($pilotData.$TrainingStarted + $pilotData.$TrainingDuration))">
              <set_value name="$ship" exact="$pilotData.$AssociatedShip"/>
              <set_value name="$completedLevel" exact="$pilotData.$TrainingLevel"/>
              
              <debug_text text="'[GalaxyTrader MK3] Training completed for ' + $pilot.name + ' at level ' + $completedLevel" chance="100"/>
              
              <!-- Complete the training -->
              <append_to_list name="global.$GT_Pilots.{$pilot}.$TrainingCompleted" exact="$completedLevel"/>
              <remove_value name="global.$GT_Pilots.{$pilot}.$XPBlocked"/>
              <remove_value name="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
              <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingStarted"/>
              <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingDuration"/>
              <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingStation"/>
              <remove_value name="global.$GT_Pilots.{$pilot}.$TrainingLevel"/>
              
              <!-- Award any pending XP -->
              <do_if value="$pilotData.$BlockedXPPending?">
                <set_value name="global.$GT_Pilots.{$pilot}.$XP" exact="global.$GT_Pilots.{$pilot}.$XP + $pilotData.$BlockedXPPending"/>
                <debug_text text="'[GalaxyTrader MK3] Awarded ' + $pilotData.$BlockedXPPending + ' pending XP to ' + $pilot.name + ' (Total: ' + global.$GT_Pilots.{$pilot}.$XP + ')'" chance="100"/>
                <remove_value name="global.$GT_Pilots.{$pilot}.$BlockedXPPending"/>
              </do_if>
              
              <!-- Update ship name (use unified mapping and new format) -->
              <set_value name="$computedLevel" exact="1"/>
              <do_all exact="15" counter="$lvl">
                <do_if value="global.$GT_Pilots.{$pilot}.$XP ge global.$GT_Config.$XP.$SkillThresholds.{$lvl}">
                  <set_value name="$computedLevel" exact="$lvl"/>
                </do_if>
              </do_all>
              <set_value name="$rankTitle" exact="'Lehrling'"/>
              <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                <set_value name="$rankIndex" exact="($computedLevel / 3)i + 1"/>
                <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                  <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
                </do_if>
                <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                  <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                </do_if>
              </do_if>
              <signal_cue_instantly cue="UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=@global.$GT_Pilots.{$pilot}.$XP, $level=$computedLevel, $rank=$rankTitle, $nameType='trader']"/>
              
              <show_notification text="'Training completed for ' + $pilot.name + '! XP progression resumed.'" timeout="5s" priority="8"/>
              <debug_text text="'[GalaxyTrader MK3] Training completion processed for ' + $pilot.name" chance="100"/>
            </do_if>
          </do_all>
        </do_if>
        
        <!-- Clear completion flag -->
        <remove_value name="global.$GT_TrainingCompletionScheduled"/>
      </actions>
    </cue>

    <!-- Update Pilot XP Signal Handler -->
    <cue name="HandleUpdatePilotXP" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Update_Pilot_XP'" comment="Handle pilot XP update"/>
      </conditions>
      <actions>
        <set_value name="$xpData" exact="event.param2"/>
        <set_value name="$ship" exact="$xpData.$Ship"/>
        <set_value name="$pilot" exact="$xpData.$Pilot"/>
        <set_value name="$xpGained" exact="@$xpData.$XPGained"/>
        
        <!-- Only process if we have valid XP data -->
        <do_if value="$xpGained? and $xpGained gt 0">
          <debug_text text="'[GalaxyTrader MK3] XP update signal received: ' + $xpGained + ' XP for ' + $pilot.name" chance="100"/>
          
          <!-- Process XP update -->
          <do_if value="global.$GT_Pilots.{$pilot}?">
            <!-- Check if pilot is blocked -->
            <!-- ✅ CRITICAL FIX: Also check BlockedLevel - prevents XP gain when training stations unavailable -->
            <!-- When no training stations found, XPBlocked is cleared to allow trading, but BlockedLevel remains -->
            <!-- This ensures XP is still blocked until training can be completed -->
            <do_if value="global.$GT_Pilots.{$pilot}.$XPBlocked? or global.$GT_Pilots.{$pilot}.$BlockedLevel?">
              <!-- Store blocked XP -->
              <do_if value="global.$GT_Pilots.{$pilot}.$BlockedXPPending?">
                <set_value name="global.$GT_Pilots.{$pilot}.$BlockedXPPending" exact="global.$GT_Pilots.{$pilot}.$BlockedXPPending + $xpGained"/>
              </do_if>
              <do_else>
                <set_value name="global.$GT_Pilots.{$pilot}.$BlockedXPPending" exact="$xpGained"/>
              </do_else>
              
              <debug_text text="'[GalaxyTrader MK3] XP blocked for ' + $pilot.name + ' - stored ' + $xpGained + ' XP for later'" chance="100"/>
            </do_if>
            <do_else>
              <!-- Award XP immediately -->
              <set_value name="global.$GT_Pilots.{$pilot}.$XP" exact="global.$GT_Pilots.{$pilot}.$XP + $xpGained"/>
              
              <!-- Check for skill level increase -->
              <signal_cue_instantly cue="CheckSkillLevelIncrease" param="table[$pilot = $pilot, $ship = $ship]"/>
              
              <debug_text text="'[GalaxyTrader MK3] Awarded ' + $xpGained + ' XP to ' + $pilot.name + ' (Total: ' + global.$GT_Pilots.{$pilot}.$XP + ')'" chance="100"/>
            </do_else>
          </do_if>
        </do_if>
        <do_else>
          <debug_text text="'[GalaxyTrader MK3] XP update signal received with no XP amount for ' + $pilot.name + ' - skipping'" chance="100"/>
        </do_else>
      </actions>
    </cue>

    <!-- Handle clearing incorrect XP blocks (e.g., Level 1 pilots) -->
    <cue name="HandleClearXPBlock" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Clear_XP_Block'" comment="Clear incorrect XP block"/>
      </conditions>
      <actions>
        <set_value name="$clearData" exact="event.param2"/>
        <set_value name="$ship" exact="$clearData.$Ship"/>
        <set_value name="$pilot" exact="$clearData.$Pilot"/>
        <set_value name="$reason" exact="@$clearData.$Reason"/>
        
        <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') Clearing XP block for pilot ' + $pilot.name + ': ' + $reason" chance="100"/>
        
        <!-- Clear XP block -->
        <do_if value="global.$GT_Pilots.{$pilot}?">
          <remove_value name="global.$GT_Pilots.{$pilot}.$XPBlocked"/>
          <remove_value name="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
          <remove_value name="global.$GT_Pilots.{$pilot}.$BlockedXPPending"/>
          
          <!-- Update ship name to remove blocked status -->
          <do_if value="global.$GT_Pilots.{$pilot}.$OriginalShipName?">
            <set_value name="$originalName" exact="global.$GT_Pilots.{$pilot}.$OriginalShipName"/>
            <set_value name="$currentLevel" exact="global.$GT_Pilots.{$pilot}.$Level"/>
            <set_value name="$currentXP" exact="global.$GT_Pilots.{$pilot}.$XP"/>
            
            <!-- Get skill title -->
            <set_value name="$skillTitle" exact="{77000,6001}"/>
            <do_if value="$currentLevel ge 2"><set_value name="$skillTitle" exact="{77000,6002}"/></do_if>
            <do_if value="$currentLevel ge 3"><set_value name="$skillTitle" exact="{77000,6003}"/></do_if>
            <do_if value="$currentLevel ge 4"><set_value name="$skillTitle" exact="{77000,6004}"/></do_if>
            <do_if value="$currentLevel ge 5"><set_value name="$skillTitle" exact="{77000,6005}"/></do_if>
            <do_if value="$currentLevel ge 6"><set_value name="$skillTitle" exact="{77000,6006}"/></do_if>
            
            <set_value name="$newName" exact="$originalName + ' (' + $skillTitle + ' Lv.' + $currentLevel + ' XP:' + $currentXP + ')'"/>
            <set_object_name object="$ship" name="$newName"/>
            
            <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') Ship name restored: ' + $newName" chance="100"/>
          </do_if>
          <do_else>
            <!-- Fallback: Use current ship name if OriginalShipName is missing -->
            <set_value name="global.$GT_Pilots.{$pilot}.$OriginalShipName" exact="$ship.knownname"/>
            <set_value name="$originalName" exact="$ship.knownname"/>
            <debug_text text="'[GT-XP] WARNING: Missing OriginalShipName for pilot ' + $pilot.name + ' in clear XP block, using current name: ' + $ship.knownname" chance="100"/>
            
            <set_value name="$currentLevel" exact="global.$GT_Pilots.{$pilot}.$Level"/>
            <set_value name="$currentXP" exact="global.$GT_Pilots.{$pilot}.$XP"/>
            
            <!-- Get skill title -->
            <set_value name="$skillTitle" exact="{77000,6001}"/>
            <do_if value="$currentLevel ge 2"><set_value name="$skillTitle" exact="{77000,6002}"/></do_if>
            <do_if value="$currentLevel ge 3"><set_value name="$skillTitle" exact="{77000,6003}"/></do_if>
            <do_if value="$currentLevel ge 4"><set_value name="$skillTitle" exact="{77000,6004}"/></do_if>
            <do_if value="$currentLevel ge 5"><set_value name="$skillTitle" exact="{77000,6005}"/></do_if>
            <do_if value="$currentLevel ge 6"><set_value name="$skillTitle" exact="{77000,6006}"/></do_if>
            
            <set_value name="$newName" exact="$originalName + ' (' + $skillTitle + ' Lv.' + $currentLevel + ' XP:' + $currentXP + ')'"/>
            <set_object_name object="$ship" name="$newName"/>
            
            <debug_text text="'[GalaxyTrader MK3] (' + $ship.idcode + ') Ship name restored: ' + $newName" chance="100"/>
          </do_else>
        </do_if>
      </actions>
    </cue>

  </cues>
</mdscript> 
