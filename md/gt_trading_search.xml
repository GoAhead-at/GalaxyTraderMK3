<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Trading_Search" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - SEARCH ENGINE
         Core trade route search and matching logic
         ======================================== -->
    
    <!-- Search for Trade Routes (MAIN SEARCH ENGINE) -->
    <cue name="SearchTradeRoutes" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <!-- âœ… PERFORMANCE FIX: Receive parameters directly from event to prevent race conditions -->
        <!-- Handle case where SearchLiveTrades_Resume signals again after batch completion -->
        <set_value name="$params" exact="event.param"/>
        <do_if value="not $params?">
          <!-- Parameters not provided - try to get from search queue or batch data -->
          <set_value name="$shipFromQueue" exact="null"/>
          <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_SearchResult exists -->
          <do_if value="global.$GT_SearchResult.$Ship?">
            <!-- Ship stored in SearchResult from live search -->
            <set_value name="$shipFromQueue" exact="global.$GT_SearchResult.$Ship"/>
          </do_if>
          
          <do_if value="$shipFromQueue?">
            <!-- Try to get params from search queue -->
            <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_SearchQueue exists -->
            <do_if value="global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$shipFromQueue}?">
              <set_value name="$params" exact="global.$GT_SearchQueue.$Params.{$shipFromQueue}"/>
            </do_if>
            <do_else>
              <!-- Reconstruct params from batch data (if still available) -->
              <set_value name="$batchData" exact="@global.$GT_BatchDataList.{$shipFromQueue}"/>
              <do_if value="$batchData?">
                <set_value name="$allowIllegalDefault" exact="false"/>
                <set_value name="$params" exact="table[
                  $Ship = $shipFromQueue,
                  $MaxDistance = @$batchData.$maxDistance,
                  $MinROI = @$batchData.$minROI,
                  $MinAbsoluteProfit = @$batchData.$minAbsoluteProfit,
                  $FactionPriority = @$batchData.$factionPriority,
                  $AllowIllegal = $allowIllegalDefault
                ]"/>
              </do_if>
            </do_else>
          </do_if>
        </do_if>
        
        <!-- âœ… CRITICAL FIX: Validate params exist and are not null -->
        <!-- Check if $params exists AND has required $Ship property (handles null case) -->
        <set_value name="$paramsValid" exact="false"/>
        <do_if value="$params?">
          <set_value name="$testShip" exact="@$params.$Ship"/>
          <do_if value="$testShip?">
            <set_value name="$paramsValid" exact="true"/>
          </do_if>
        </do_if>
        
        <do_if value="not $paramsValid">
          <!-- âœ… DEBUG MODE: Only log when debug is enabled -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Search] âš ï¸ SearchTradeRoutes called without valid parameters - cannot proceed'" chance="100"/>
          </do_if>
          <cancel_cue cue="this"/>
        </do_if>
        
        <!-- âœ… CRITICAL: Check batch status FIRST, before ANY other processing -->
        <!-- If batch is in progress FOR THIS SHIP, exit IMMEDIATELY - don't do ANY processing -->
        <!-- This prevents race conditions where SearchTradeRoutes continues executing after SearchLiveTrades starts batch processing -->
        <!-- Use library function for batch status checking -->
        <run_actions ref="md.GT_Trade_Utilities.GT_CheckBatchStatus" result="$batchStatus">
          <param name="ship" value="$params.$Ship"/>
        </run_actions>
        <set_value name="$waitingForBatch" exact="$batchStatus.$IsBatchActive"/>
        <set_value name="$batchShip" exact="$batchStatus.$BatchShip"/>
        <set_value name="$shouldProceed" exact="$batchStatus.$ShouldProceed"/>
        
        <!-- âœ… FIX: Only exit if batch is in progress FOR THIS SHIP -->
        <!-- If batch is for a different ship, proceed normally -->
        <do_if value="$waitingForBatch and $batchStatus.$IsForThisShip">
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Search] (' + $params.$Ship.idcode + ') â¸ï¸ Batch processing in progress FOR THIS SHIP - waiting for completion (will resume when batch completes)'" chance="100"/>
          </do_if>
          <!-- Exit - SearchLiveTrades_Resume will signal this cue again when results are ready -->
          <cancel_cue cue="this"/>
        </do_if>
        <do_elseif value="$waitingForBatch and not $batchStatus.$IsForThisShip">
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Search] (' + $params.$Ship.idcode + ') âš ï¸ Batch processing in progress FOR DIFFERENT SHIP (' + (if $batchShip? then $batchShip.idcode else 'UNKNOWN') + ') - proceeding normally'" chance="100"/>
          </do_if>
        </do_elseif>
        
        <do_if value="$shouldProceed">
        <set_value name="$ship" exact="$params.$Ship"/>
        <set_value name="$maxDistance" exact="$params.$MaxDistance"/>
        <set_value name="$minROI" exact="$params.$MinROI"/>
        <set_value name="$minAbsoluteProfit" exact="$params.$MinAbsoluteProfit"/>
        <set_value name="$factionPriority" exact="$params.$FactionPriority"/>
        
        <!-- âœ… DEBUG: Log profit threshold from params -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
          <debug_text text="'[GT-Search] (' + $ship.idcode + ') ðŸ’° Profit threshold from params: ' + ($minAbsoluteProfit / 100) + ' Cr'" chance="100"/>
        </do_if>
        
        <!-- âœ… CRITICAL FIX: Detect continuation EARLY (before skill multiplier) -->
        <!-- Check if we're continuing from live search completion BEFORE applying skill multiplier -->
        <!-- When SearchLiveTrades_Resume signals SearchTradeRoutes, live results are already in global.$GT_SearchResult -->
        <set_value name="$isLiveSearchContinuation" exact="false"/>
        <do_if value="global.$GT_SearchResult.$Ship? and global.$GT_SearchResult.$Ship == $ship">
          <set_value name="$savedWaitingForBatch" exact="@global.$GT_SearchResult.$WaitingForBatch"/>
          <do_if value="not $savedWaitingForBatch">
            <!-- Live search just completed for this ship - this is a continuation -->
            <set_value name="$isLiveSearchContinuation" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- âœ… CRITICAL FIX: Check if this is a fallback search continuation - if so, params already have skill multiplier applied -->
        <!-- Fallback search receives already-multiplied values, relaxes them, then SearchLiveTrades_Resume signals SearchTradeRoutes -->
        <!-- When SearchTradeRoutes runs as continuation, params already have relaxed values that shouldn't be multiplied again -->
        <set_value name="$isFallbackContinuation" exact="false"/>
        <do_if value="$isLiveSearchContinuation and $maxDistance == 2">
          <set_value name="$isFallbackContinuation" exact="true"/>
          <!-- âœ… CRITICAL FIX: For fallback continuation, params already have relaxed profit thresholds from SearchFallbackTrades -->
          <!-- These were calculated from already-multiplied values, so don't apply multiplier again -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Search] (' + $ship.idcode + ') ðŸ”„ Fallback continuation detected - skipping skill multiplier (params already relaxed)'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- âœ… FALLBACK COOLDOWN: Clear fallback flag at start of new search cycle -->
        <!-- This allows fallback to be attempted again if cache and live search both fail -->
        <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_FallbackAttempted exists -->
        <do_if value="global.$GT_FallbackAttempted.{$ship}?">
          <remove_value name="global.$GT_FallbackAttempted.{$ship}"/>
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Search] (' + $ship.idcode + ') ðŸ”„ Starting new search cycle - cleared fallback flag'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Create faction priority text for debug output -->
        <run_actions ref="md.GT_Trade_Utilities.GT_GetFactionPriorityText" result="$factionPriorityText">
          <param name="factionPriority" value="$factionPriority"/>
        </run_actions>
        
        <!-- Get distance penalty setting (0-100% converted to 0.0-2.0 multiplier) -->
        <run_actions ref="md.GT_Trade_Utilities.GT_GetDistancePenaltyMultiplier" result="$distancePenaltyMultiplier">
          <param name="ship" value="$ship"/>
        </run_actions>

        <!-- Resolve pilot skill and apply feature gates + level-based thresholds -->
        <run_actions ref="md.GT_Ship_Management.Calculate_Skill_Level" result="$skillInfo">
          <param name="ship" value="$ship"/>
        </run_actions>
        <set_value name="$skillLevel" exact="if $skillInfo? and $skillInfo.$Level? then $skillInfo.$Level else 1"/>

        <!-- Feature gates by skill level -->
        <set_value name="$gt_ThreatIntel" exact="$skillLevel ge 6"/>
        <set_value name="$gt_SatelliteIntel" exact="$skillLevel ge 9"/>
        <set_value name="$gt_FleetCoord" exact="$skillLevel ge 12"/>
        <set_value name="$gt_AdvancedAnalytics" exact="$skillLevel ge 15"/>
        
        <!-- âœ… NEW: Profit threshold is now pilot level-based (set in gt_trading_queue.xml) -->
        <!-- Level 1: 0 Cr, Level 2: 100 Cr, Level 3: 500 Cr, Level 4+: Config value with skill multiplier -->
        <!-- Params already contain the correct pilot level-based threshold, so no need to apply multiplier here -->
        <!-- ROI multiplier still applies for ROI threshold (not profit threshold) -->
        <!-- âœ… CRITICAL FIX: Only apply ROI multiplier if NOT a fallback continuation -->
        <!-- Fallback continuation params come from SearchFallbackTrades which already relaxed the already-multiplied values -->
        <do_if value="not $isFallbackContinuation">
          <run_actions ref="md.GT_Trade_Utilities.GT_GetSkillMultiplier" result="$roiMultiplier">
            <param name="skillLevel" value="$skillLevel"/>
          </run_actions>
          <set_value name="$minROI" exact="$minROI * $roiMultiplier"/>
          <!-- Note: $minAbsoluteProfit is already set correctly from params (pilot level-based) -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Search] (' + $ship.idcode + ') [OK] Profit threshold unchanged (pilot level-based): ' + ($minAbsoluteProfit / 100) + ' Cr | ROI multiplier applied: ' + $minROI + '% (multiplier: ' + $roiMultiplier + ')'" chance="100"/>
          </do_if>
        </do_if>
        <do_else>
          <!-- Fallback continuation - params already have relaxed thresholds -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Search] (' + $ship.idcode + ') âœ… Profit threshold from fallback continuation (already relaxed): ' + ($minAbsoluteProfit / 100) + ' Cr | ROI: ' + $minROI + '%'" chance="100"/>
          </do_if>
        </do_else>
        
        <!-- âœ… ENHANCED: Log search start for detailed diagnostics (debug mode only) -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
          <set_value name="$pilotInfo" exact="'No Pilot'"/>
          <do_if value="$ship.pilot">
            <set_value name="$shownSkill" exact="1"/>
            <do_if value="global.$GT_Pilots.{$ship.pilot}? and global.$GT_Pilots.{$ship.pilot}.$Level?">
              <set_value name="$shownSkill" exact="global.$GT_Pilots.{$ship.pilot}.$Level"/>
            </do_if>
            <do_elseif value="$ship.pilot.skill.management?">
              <set_value name="$shownSkill" exact="$ship.pilot.skill.management"/>
            </do_elseif>
            <do_elseif value="$ship.pilot.skill.piloting?">
              <set_value name="$shownSkill" exact="$ship.pilot.skill.piloting"/>
            </do_elseif>
            <set_value name="$pilotInfo" exact="$ship.pilot.name + ' (Skill: ' + $shownSkill + ')'"/>
          </do_if>
          <debug_text text="'[GT-Search] (' + $ship.idcode + ') === TRADE SEARCH START ===' + 
            '\nShip: ' + $ship.knownname + 
            '\nPilot: ' + $pilotInfo + 
            '\nCurrent Sector: ' + $ship.sector.knownname + 
            '\nMax Distance: ' + $maxDistance + ' jumps' + 
            '\nMin ROI: ' + $minROI + '%' + 
            '\nMin Absolute Profit: ' + ($minAbsoluteProfit / 100) + ' Cr' + 
            '\nShip Cargo: ' + ($ship.cargo.capacity.all - $ship.cargo.free.all) + '/' + $ship.cargo.capacity.all +
            '\nFaction Priority: ' + $factionPriorityText" 
            chance="100"/>
        </do_if>
        
        <set_value name="$bestTrade" exact="null"/>
        <set_value name="$bestScore" exact="0"/>
        <set_value name="$foundCachedTrade" exact="false"/>
        <set_value name="$fallbackSearchTriggered" exact="false"/>  <!-- Track if fallback search was triggered -->
        
        <!-- âœ… FALLBACK COOLDOWN: Clear fallback flag when new normal search cycle starts -->
        <!-- This allows fallback to be tried again after normal search cooldown expires -->
        <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_FallbackAttempted exists -->
        <do_if value="global.$GT_FallbackAttempted.{$ship}?">
          <remove_value name="global.$GT_FallbackAttempted.{$ship}"/>
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Search] (' + $ship.idcode + ') âœ… New search cycle started - fallback flag cleared'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- âœ… CRITICAL FIX: Extract live search results if continuation (already detected earlier) -->
        <!-- When SearchLiveTrades_Resume signals SearchTradeRoutes, live results are already in global.$GT_SearchResult -->
        <!-- We should use those results instead of running cache search again -->
        <!-- CRITICAL: Extract and preserve live results IMMEDIATELY before cache search can overwrite them -->
        <!-- Note: $isLiveSearchContinuation already set earlier (before skill multiplier) - don't reset it! -->
        <set_value name="$liveTradeList" exact="[]"/>
        <set_value name="$liveBestTrade" exact="null"/>
        <set_value name="$liveBestScore" exact="0"/>
        
        <!-- âœ… FALLBACK SEARCH: Check if we're already in a fallback search (MaxDistance == 2 from previous call) -->
        <!-- If MaxDistance is 2 and we're being signaled from SearchLiveTrades_Resume, we're in fallback search -->
        <!-- Note: $isLiveSearchContinuation already detected earlier (before skill multiplier) -->
        <set_value name="$isFallbackSearch" exact="false"/>
        <do_if value="$isLiveSearchContinuation">
          <!-- If MaxDistance is 2, this is a fallback search continuation -->
          <do_if value="$maxDistance == 2">
            <set_value name="$isFallbackSearch" exact="true"/>
            <set_value name="$fallbackSearchTriggered" exact="true"/>  <!-- Prevent triggering fallback again -->
          </do_if>
        </do_if>
        
        <!-- Save current global.$GT_SearchResult to local variables BEFORE cache search overwrites it -->
        <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_SearchResult exists -->
        <set_value name="$savedSearchResult" exact="null"/>
        <!-- Create a copy of the search result to preserve it -->
        <do_if value="true">
          <set_value name="$savedWaitingForBatch" exact="true"/>
          <do_if value="global.$GT_SearchResult.$WaitingForBatch?">
            <set_value name="$savedWaitingForBatch" exact="global.$GT_SearchResult.$WaitingForBatch"/>
          </do_if>
          <set_value name="$savedShip" exact="@global.$GT_SearchResult.$Ship"/>
          <!-- âœ… CRITICAL: Initialize to empty list first, then extract if global exists and is not null -->
          <!-- The ? operator checks existence, not null - so initialize to safe default first -->
          <set_value name="$savedTradeList" exact="[]"/>
          <set_value name="$savedTradeListTemp" exact="@global.$GT_SearchResult.$TradeList"/>
          <do_if value="$savedTradeListTemp?">
            <!-- Global value exists - check if it's actually a list (has .count property) -->
            <set_value name="$tempCount" exact="@$savedTradeListTemp.count"/>
            <do_if value="$tempCount?">
              <!-- Valid list with count - use it -->
              <set_value name="$savedTradeList" exact="$savedTradeListTemp"/>
            </do_if>
          </do_if>
          <!-- âœ… SAFETY: Ensure $savedTradeList is valid before accessing .count -->
          <set_value name="$savedTradeListCount" exact="0"/>
          <do_if value="$savedTradeList?">
            <set_value name="$savedTradeListCountTemp" exact="@$savedTradeList.count"/>
            <do_if value="$savedTradeListCountTemp?">
              <set_value name="$savedTradeListCount" exact="$savedTradeListCountTemp"/>
            </do_if>
          </do_if>
          <set_value name="$savedBestTrade" exact="@global.$GT_SearchResult.$BestTrade"/>
          <set_value name="$savedBestScore" exact="@global.$GT_SearchResult.$BestScore"/>
          
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <set_value name="$savedShipId" exact="'null'"/>
            <do_if value="$savedShip?">
              <set_value name="$savedShipIdTemp" exact="@$savedShip.idcode"/>
              <do_if value="$savedShipIdTemp?">
                <set_value name="$savedShipId" exact="$savedShipIdTemp"/>
              </do_if>
            </do_if>
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') ðŸ” Continuation check: waitingFlag=' + $savedWaitingForBatch + ', liveShip=' + $savedShipId + ', currentShip=' + $ship.idcode + ', tradeListCount=' + $savedTradeListCount" chance="100"/>
          </do_if>
          
          <!-- Check if live search just completed (WaitingForBatch = false, TradeList exists or is empty, Ship matches) -->
          <!-- âœ… FIX: Accept continuation even with 0 trades (all blacklisted) to prevent infinite loops -->
          <do_if value="not $savedWaitingForBatch and $savedShip == $ship">
            <!-- Live search just completed for this ship - use those results (even if 0 trades) -->
            <set_value name="$isLiveSearchContinuation" exact="true"/>
            <set_value name="$liveTradeList" exact="$savedTradeList"/>
            <set_value name="$liveBestTrade" exact="$savedBestTrade"/>
            <set_value name="$liveBestScore" exact="$savedBestScore"/>
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') âœ… Live search continuation detected - using live results (' + $liveTradeList.count + ' trades) instead of running cache search again'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- ===== PHASE 1: CHECK TRADE CACHE WITH AGE VALIDATION ===== -->
        <!-- Only run cache search if NOT continuing from live search AND NOT forcing live search -->
        <set_value name="$cacheChecked" exact="false"/>
        <set_value name="$cacheCount" exact="0"/>
        <set_value name="$cacheTradeList" exact="[]"/>
        <set_value name="$cacheBestTrade" exact="null"/>
        <set_value name="$cacheBestScore" exact="0"/>
        
        <!-- âœ… NEW: Check if ForceLiveSearch flag is set (AI rejected all cached trades) -->
        <set_value name="$forceLiveSearch" exact="@$params.$ForceLiveSearch"/>
        
        <do_if value="not $isLiveSearchContinuation and not $forceLiveSearch">
          <!-- Track search method for diagnostics -->
          <set_value name="$searchMethod" exact="'cache'"/>
          <set_value name="$cacheChecked" exact="true"/>
          <!-- âœ… PERFORMANCE OPTIMIZATION v5: Calculate total cache count from all home sectors -->
          <!-- Use library function for cache count calculation -->
          <run_actions ref="md.GT_Trade_Utilities.GT_CalculateTotalCacheCount" result="$cacheCount"/>
          
          <!-- âœ… ENHANCED: Log cache check start (debug mode only) -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Search] (' + $ship.idcode + ') ðŸ” Checking trade cache (cache size: ' + $cacheCount + ' entries)'" chance="100"/>
          </do_if>
          
          <signal_cue_instantly cue="md.GT_Search_Methods.SearchCachedTrades" param="table[
            $Ship = $ship,
            $MaxDistance = $maxDistance,
            $MinROI = $minROI,
            $MinAbsoluteProfit = $minAbsoluteProfit,
            $FactionPriority = $factionPriority,
            $DistancePenaltyMultiplier = $distancePenaltyMultiplier,
            $SkillLevel = $skillLevel,
            $AllowIllegal = $params.$AllowIllegal
          ]"/>
          
          <!-- Extract cache results from global return variable -->
          <set_value name="$foundCachedTrade" exact="@global.$GT_SearchResult.$Found"/>
          <set_value name="$cacheBestTrade" exact="@global.$GT_SearchResult.$BestTrade"/>
          <set_value name="$cacheBestScore" exact="@global.$GT_SearchResult.$BestScore"/>
          <set_value name="$cacheBlacklistRejections" exact="@global.$GT_SearchResult.$BlacklistRejections"/>
          <set_value name="$cacheTradeList" exact="@global.$GT_SearchResult.$TradeList"/>
          
          <!-- âœ… ENHANCED: Log cache check results (debug mode only) -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <set_value name="$cacheTradeCount" exact="0"/>
            <do_if value="$cacheTradeList?">
              <set_value name="$cacheTradeCount" exact="@$cacheTradeList.count"/>
            </do_if>
            <debug_text text="'[GT-Search] (' + $ship.idcode + ') ðŸ“‹ Cache check complete: Found=' + $foundCachedTrade + ', Trades=' + $cacheTradeCount + ', BestScore=' + $cacheBestScore" chance="100"/>
          </do_if>
        </do_if>
        <do_else>
          <!-- Live search continuation OR ForceLiveSearch - skip cache, use live results -->
          <set_value name="$searchMethod" exact="'live'"/>
          <do_if value="$forceLiveSearch">
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <debug_text text="'[GT-Search] (' + $ship.idcode + ') ðŸ”„ ForceLiveSearch flag set - skipping cache, going straight to live search'" chance="100"/>
            </do_if>
            <!-- Clear ForceLiveSearch flag after use -->
            <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_AIParameters exists -->
            <do_if value="global.$GT_AIParameters.{$ship}?">
              <remove_value name="global.$GT_AIParameters.{$ship}.$ForceLiveSearch"/>
            </do_if>
          </do_if>
        </do_else>
        
        <!-- âœ… CRITICAL FIX: Compare cache vs live results and use the best -->
        <!-- If we have both cache and live results, prefer live (they're fresher) -->
        <do_if value="$isLiveSearchContinuation">
          <!-- Using live search results -->
          <set_value name="$bestTrade" exact="$liveBestTrade"/>
          <set_value name="$bestScore" exact="$liveBestScore"/>
          <set_value name="$tradeList" exact="$liveTradeList"/>
          <set_value name="$foundCachedTrade" exact="false"/>
        </do_if>
        <do_else>
          <!-- Using cache results (or will check live search if needed) -->
          <set_value name="$bestTrade" exact="$cacheBestTrade"/>
          <set_value name="$bestScore" exact="$cacheBestScore"/>
          <set_value name="$tradeList" exact="$cacheTradeList"/>
        </do_else>
        
        <!-- âœ… FIX: Validate bestTrade IMMEDIATELY after setting from cache/live sources -->
        <!-- Use strict validation to catch invalid trades before execution validation -->
        <run_actions ref="md.GT_Trade_Utilities.GT_IsTradeValid" result="$bestTradeValidFromSource">
          <param name="trade" value="$bestTrade"/>
          <param name="minScore" value="0"/>
        </run_actions>
        <do_if value="not $bestTradeValidFromSource">
          <!-- bestTrade from source is invalid - clear it so fallback can fix it -->
          <set_value name="$bestTrade" exact="null"/>
          <set_value name="$bestScore" exact="0"/>
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') âš ï¸ bestTrade from source (cache/live) is INVALID - cleared for fallback fix'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Initialize rejection statistics (for both cached and live searches) -->
        <set_value name="$tradesRejectedDocking" exact="0"/>
        <set_value name="$tradesRejectedBlacklist" exact="0"/>
        <set_value name="$tradesRejectedProfit" exact="0"/>
        <set_value name="$tradesRejectedDistance" exact="0"/>
        <set_value name="$tradesRejectedAmount" exact="0"/>
        <set_value name="$offersFound" exact="0"/>
        <set_value name="$stationsEvaluated" exact="0"/>
        <set_value name="$bestRejectedTrade" exact="null"/>
        
        <!-- âœ… CRITICAL: If using live search continuation, retrieve rejection stats from global (includes filtering stats) -->
        <do_if value="$isLiveSearchContinuation">
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Search] (' + $ship.idcode + ') ðŸ” RETRIEVING STATS FROM CONTINUATION:' +
              '\n  TradesRejectedDocking exists: ' + (if global.$GT_SearchResult.$TradesRejectedDocking? then 'yes' else 'no') +
              '\n  TradesRejectedBlacklist exists: ' + (if global.$GT_SearchResult.$TradesRejectedBlacklist? then 'yes' else 'no') +
              '\n  TradesRejectedBlacklist value: ' + (if global.$GT_SearchResult.$TradesRejectedBlacklist? then global.$GT_SearchResult.$TradesRejectedBlacklist else 'null') +
              '\n  FilteredByBlacklist exists: ' + (if global.$GT_SearchResult.$FilteredByBlacklist? then 'yes' else 'no') +
              '\n  FilteredByBlacklist value: ' + (if global.$GT_SearchResult.$FilteredByBlacklist? then global.$GT_SearchResult.$FilteredByBlacklist else 'null') +
              '\n  FilteredByPathBlocked exists: ' + (if global.$GT_SearchResult.$FilteredByPathBlocked? then 'yes' else 'no') +
              '\n  FilteredByPathBlocked value: ' + (if global.$GT_SearchResult.$FilteredByPathBlocked? then global.$GT_SearchResult.$FilteredByPathBlocked else 'null') +
              '\n  TotalTradesEvaluated exists: ' + (if global.$GT_SearchResult.$TotalTradesEvaluated? then 'yes' else 'no') +
              '\n  TotalTradesEvaluated value: ' + (if global.$GT_SearchResult.$TotalTradesEvaluated? then global.$GT_SearchResult.$TotalTradesEvaluated else 'null')" 
              chance="100"/>
          </do_if>
          
          <do_if value="global.$GT_SearchResult.$TradesRejectedDocking?">
            <set_value name="$tradesRejectedDocking" exact="global.$GT_SearchResult.$TradesRejectedDocking"/>
          </do_if>
          <do_if value="global.$GT_SearchResult.$TradesRejectedBlacklist?">
            <set_value name="$tradesRejectedBlacklist" exact="global.$GT_SearchResult.$TradesRejectedBlacklist"/>
          </do_if>
          <do_if value="global.$GT_SearchResult.$TradesRejectedProfit?">
            <set_value name="$tradesRejectedProfit" exact="global.$GT_SearchResult.$TradesRejectedProfit"/>
          </do_if>
          <do_if value="global.$GT_SearchResult.$TradesRejectedDistance?">
            <set_value name="$tradesRejectedDistance" exact="global.$GT_SearchResult.$TradesRejectedDistance"/>
          </do_if>
          <do_if value="global.$GT_SearchResult.$TradesRejectedAmount?">
            <set_value name="$tradesRejectedAmount" exact="global.$GT_SearchResult.$TradesRejectedAmount"/>
          </do_if>
          <do_if value="global.$GT_SearchResult.$StationsEvaluated?">
            <set_value name="$stationsEvaluated" exact="global.$GT_SearchResult.$StationsEvaluated"/>
          </do_if>
          <do_if value="global.$GT_SearchResult.$OffersFound?">
            <set_value name="$offersFound" exact="global.$GT_SearchResult.$OffersFound"/>
          </do_if>
          <do_if value="global.$GT_SearchResult.$BestRejectedTrade?">
            <set_value name="$bestRejectedTrade" exact="global.$GT_SearchResult.$BestRejectedTrade"/>
          </do_if>
          
          <!-- âœ… CRITICAL: Store stats immediately when continuation detected (BEFORE trade execution) -->
          <!-- This ensures stats are available for logbook even if execution fails later -->
          <set_value name="$filteredByBlacklistFromResume" exact="0"/>
          <set_value name="$filteredByPathBlockedFromResume" exact="0"/>
          <set_value name="$totalTradesFromResume" exact="0"/>
          <do_if value="global.$GT_SearchResult.$FilteredByBlacklist?">
            <set_value name="$filteredByBlacklistFromResume" exact="global.$GT_SearchResult.$FilteredByBlacklist"/>
          </do_if>
          <do_if value="global.$GT_SearchResult.$FilteredByPathBlocked?">
            <set_value name="$filteredByPathBlockedFromResume" exact="global.$GT_SearchResult.$FilteredByPathBlocked"/>
          </do_if>
          <do_if value="global.$GT_SearchResult.$TotalTradesEvaluated?">
            <set_value name="$totalTradesFromResume" exact="global.$GT_SearchResult.$TotalTradesEvaluated"/>
          </do_if>
          
          <!-- Combine blacklist stats: $tradesRejectedBlacklist already includes combined value from resume -->
          <set_value name="$totalBlacklistFiltered" exact="$tradesRejectedBlacklist"/>
          <set_value name="$totalRejected" exact="$tradesRejectedDocking + $tradesRejectedProfit + $tradesRejectedAmount + $totalBlacklistFiltered"/>
          
          <!-- Total evaluated = use resume stats if available (more accurate) -->
          <set_value name="$totalEvaluated" exact="$totalRejected"/>
          <do_if value="$totalTradesFromResume gt 0">
            <set_value name="$totalEvaluated" exact="$totalTradesFromResume"/>
          </do_if>
          <do_elseif value="$totalRejected gt 0 or $offersFound gt 0">
            <set_value name="$totalEvaluated" exact="$totalRejected"/>
          </do_elseif>
          
          <!-- Extract sector name safely (using library function) -->
          <run_actions ref="md.GT_Utilities.GT_GetSectorNameSafe" result="$sectorNameForStorage">
            <param name="ship" value="$ship"/>
          </run_actions>
          
          <!-- Store per-ship to prevent overwrites by other ships' searches -->
          <!-- âœ… FIX: Ensure LastRejectionStats is initialized as a table (not null) -->
          <!-- First ensure global.$GT_SearchResult exists -->
          <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_SearchResult exists -->
          <!-- Then ensure LastRejectionStats is a valid table (not null) -->
          <!-- Preserve existing data if it's already a valid table -->
          <set_value name="$preservedLastRejectionStats" exact="null"/>
          <do_if value="global.$GT_SearchResult.$LastRejectionStats?">
            <!-- Try to access .keys.count - if it returns a valid number (>= 0), it's a valid table -->
            <set_value name="$tempKeysCount" exact="@global.$GT_SearchResult.$LastRejectionStats.keys.count"/>
            <do_if value="$tempKeysCount? and $tempKeysCount ge 0">
              <!-- Valid table - preserve it using safe operator to avoid crash if it's null -->
              <set_value name="$tempTable" exact="@global.$GT_SearchResult.$LastRejectionStats"/>
              <do_if value="$tempTable?">
                <set_value name="$preservedLastRejectionStats" exact="$tempTable"/>
              </do_if>
            </do_if>
          </do_if>
          <!-- Always initialize as a fresh table (will overwrite null, but preserve valid tables) -->
          <set_value name="global.$GT_SearchResult.$LastRejectionStats" exact="table[]"/>
          <!-- Restore preserved data if we had a valid table -->
          <do_if value="$preservedLastRejectionStats?">
            <set_value name="global.$GT_SearchResult.$LastRejectionStats" exact="$preservedLastRejectionStats"/>
          </do_if>
          
          <!-- âœ… FIX: Use local variables (calculated in this code path) with fallback to global -->
          <!-- Local variables are calculated from live search continuation results -->
          <!-- Fallback to global.$GT_SearchResult if local variables are 0 -->
          <set_value name="$statsDocking" exact="$tradesRejectedDocking"/>
          <set_value name="$statsProfit" exact="$tradesRejectedProfit"/>
          <set_value name="$statsAmount" exact="$tradesRejectedAmount"/>
          <set_value name="$statsBlacklist" exact="$totalBlacklistFiltered"/>
          
          <!-- Fallback to global if local is 0 and global has values -->
          <do_if value="$statsDocking == 0 and global.$GT_SearchResult.$TradesRejectedDocking?">
            <set_value name="$statsDocking" exact="global.$GT_SearchResult.$TradesRejectedDocking"/>
          </do_if>
          <do_if value="$statsProfit == 0 and global.$GT_SearchResult.$TradesRejectedProfit?">
            <set_value name="$statsProfit" exact="global.$GT_SearchResult.$TradesRejectedProfit"/>
          </do_if>
          <do_if value="$statsAmount == 0 and global.$GT_SearchResult.$TradesRejectedAmount?">
            <set_value name="$statsAmount" exact="global.$GT_SearchResult.$TradesRejectedAmount"/>
          </do_if>
          <do_if value="$statsBlacklist == 0 and global.$GT_SearchResult.$TradesRejectedBlacklist?">
            <set_value name="$statsBlacklist" exact="global.$GT_SearchResult.$TradesRejectedBlacklist"/>
          </do_if>
          
          <!-- âœ… CRITICAL FIX: Only store LastRejectionStats if we have meaningful stats -->
          <!-- Prevents overwriting real stats with zeros from cache-only searches with no offers -->
          <!-- Check if we have existing stats that are non-zero, or if new stats are non-zero -->
          <set_value name="$hasExistingStats" exact="false"/>
          <set_value name="$existingStats" exact="@global.$GT_SearchResult.$LastRejectionStats.{$ship}"/>
          <do_if value="$existingStats?">
            <!-- Check if existing stats have meaningful data - check multiple fields to be safe -->
            <set_value name="$existingTotal" exact="@$existingStats.$Total"/>
            <set_value name="$existingDocking" exact="@$existingStats.$Docking"/>
            <set_value name="$existingProfit" exact="@$existingStats.$Profit"/>
            <!-- If any field exists and is > 0, we have meaningful stats -->
            <do_if value="($existingTotal? and $existingTotal gt 0) or ($existingDocking? and $existingDocking gt 0) or ($existingProfit? and $existingProfit gt 0)">
              <set_value name="$hasExistingStats" exact="true"/>
            </do_if>
          </do_if>
          
          <!-- Only store if: new stats are meaningful (TotalEvaluated > 0) OR no existing meaningful stats -->
          <!-- This prevents overwriting real stats with zeros, but allows storing zeros if no stats exist yet -->
          <do_if value="$totalEvaluated gt 0 or not $hasExistingStats">
            <!-- âœ… SIMPLIFIED: Extract, build new structure atomically, set back (initialization guarantees base structure) -->
            <!-- Extract existing data (preserve other properties and other ships' stats) -->
            <set_value name="$existingSearchResult" exact="@global.$GT_SearchResult"/>
            <set_value name="$existingLastRejectionStats" exact="@$existingSearchResult.$LastRejectionStats"/>
            <!-- Build new per-ship stats -->
            <set_value name="$newShipStats" exact="table[
              $Total = $totalEvaluated,
              $Docking = $statsDocking,
              $Profit = $statsProfit,
              $Amount = $statsAmount,
              $Blacklist = $statsBlacklist,
              $SectorName = $sectorNameForStorage,
              $MaxDistance = $maxDistance,
              $MinAbsoluteProfit = $minAbsoluteProfit
            ]"/>
            <!-- Use library function to update rejection stats -->
            <run_actions ref="md.GT_Trade_Utilities.GT_UpdateRejectionStats">
              <param name="ship" value="$ship"/>
              <param name="stats" value="$newShipStats"/>
            </run_actions>
          </do_if>
          
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Search] (' + $ship.idcode + ') ðŸ“ STORED STATS ON CONTINUATION (available for logbook if execution fails):' +
              '\n  TotalEvaluated: ' + $totalEvaluated +
              '\n  TotalBlacklistFiltered: ' + $statsBlacklist +
              '\n  RejectedDocking: ' + $statsDocking +
              '\n  RejectedProfit: ' + $statsProfit +
              '\n  RejectedAmount: ' + $statsAmount" 
              chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Check cache diversity: Count unique wares in trade list -->
        <set_value name="$cacheWareCount" exact="0"/>
        <set_value name="$cacheWares" exact="table[]"/>
        <do_if value="$tradeList.count gt 0">
          <do_all exact="$tradeList.count" counter="$i">
            <set_value name="$trade" exact="$tradeList.{$i}"/>
            <set_value name="$ware" exact="@$trade.$BuyOffer.ware"/>
            <do_if value="$ware? and not $cacheWares.{$ware}?">
              <set_value name="$cacheWares.{$ware}" exact="true"/>
              <set_value name="$cacheWareCount" exact="$cacheWareCount + 1"/>
            </do_if>
          </do_all>
        </do_if>
        
        <!-- ===== PHASE 2: LIVE TRADE SEARCH (only if no cached trades found) ===== -->
        <!-- Skip live search entirely if we're already using live search results from continuation -->
        <!-- âœ… REMOVED: Low diversity check - use cached trades even if diversity is low -->
        <!-- Trigger live search if: 
             1. NOT continuing from live search, AND
             2. No cached trades found, AND
             3. Previous live search did NOT return 0 trades (to prevent infinite loops when all trades are blacklisted) -->
        <set_value name="$shouldDoLiveSearch" exact="false"/>
        <set_value name="$previousLiveSearchReturnedZeroTrades" exact="false"/>
        <do_if value="$isLiveSearchContinuation and $liveTradeList.count == 0">
          <!-- Previous live search returned 0 trades -->
          <!-- âœ… CRITICAL FIX: Apply cooldown to prevent infinite loop when ship is stuck -->
          <!-- If ship is in blacklisted sector and all trades filtered, cooldown prevents immediate re-search -->
          <!-- âœ… ESCAPE EXCEPTION: Don't apply cooldown if ship needs to escape -->
          
          <!-- Check if ship is in blacklisted sector (needs escape) - using library function -->
          <run_actions ref="md.GT_Blacklist_Utilities.GT_CheckNeedsEscape" result="$needsEscape">
            <param name="ship" value="$ship"/>
          </run_actions>
          
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') âš ï¸ Previous live search returned 0 trades - ' + if $needsEscape then 'ESCAPE NEEDED, skipping cooldown' else 'applying cooldown to prevent loop (ship may be stuck in blacklisted sector)'" chance="100"/>
          </do_if>
          
          <!-- Clear continuation state -->
          <set_value name="$isLiveSearchContinuation" exact="false"/>
          <set_value name="$liveTradeList" exact="[]"/>
          <set_value name="$liveBestTrade" exact="null"/>
          <set_value name="$liveBestScore" exact="0"/>
          
          <!-- âœ… CRITICAL: Initialize tradeList to empty list to prevent null errors -->
          <set_value name="$tradeList" exact="[]"/>
          <set_value name="$bestTrade" exact="null"/>
          <set_value name="$bestScore" exact="0"/>
          
          <!-- Clear old search result state to prevent re-use -->
          <!-- ✅ FIX: Remove $Ship to prevent future requests from being treated as continuations -->
          <remove_value name="global.$GT_SearchResult.$WaitingForBatch"/>
          <remove_value name="global.$GT_SearchResult.$Ship"/>
          <remove_value name="global.$GT_SearchResult.$TradeList"/>
          <remove_value name="global.$GT_SearchResult.$BestTrade"/>
          <remove_value name="global.$GT_SearchResult.$BestScore"/>
          <remove_value name="global.$GT_SearchResult.$FilteredByBlacklist"/>
          <remove_value name="global.$GT_SearchResult.$FilteredByPathBlocked"/>
          <remove_value name="global.$GT_SearchResult.$TotalTradesEvaluated"/>
          
          <!-- âœ… CRITICAL: Apply cooldown for zero-trade live searches (prevents infinite loop) -->
          <!-- âœ… ESCAPE EXCEPTION: Only apply cooldown if ship doesn't need to escape -->
          <do_if value="not $needsEscape">
            <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_CacheMissCooldowns exists -->
            <!-- Use same cooldown system as cache misses, but mark it as zero-trade cooldown -->
            <set_value name="global.$GT_CacheMissCooldowns.{$ship}" exact="table[
              $LastLiveSearch = player.age,
              $CooldownDuration = 60s
            ]"/>
            
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') â¸ï¸ Applied 60s cooldown after zero-trade live search - ship may be stuck, will retry later'" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <!-- Ship needs to escape - clear any existing cooldown so it can search again immediately -->
            <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_CacheMissCooldowns exists -->
            <do_if value="global.$GT_CacheMissCooldowns.{$ship}?">
              <remove_value name="global.$GT_CacheMissCooldowns.{$ship}"/>
            </do_if>
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') ðŸš¨ ESCAPE NEEDED: Zero trades found but ship in blacklisted sector - clearing cooldown to allow immediate escape search'" chance="100"/>
            </do_if>
          </do_else>
        </do_if>
        
        <do_if value="not $isLiveSearchContinuation">
          <!-- âœ… REMOVED: Low diversity check - only trigger live search on cache miss -->
          <set_value name="$shouldDoLiveSearch" exact="not $foundCachedTrade"/>
        </do_if>
        <do_else>
          <!-- Using continuation results - don't trigger new live search -->
          <set_value name="$shouldDoLiveSearch" exact="false"/>
        </do_else>
        
        <do_if value="$shouldDoLiveSearch">
          <!-- âœ… COOLDOWN MECHANISM: Prevent cache miss â†’ live search loops -->
          <!-- If cache miss triggered live search recently, enforce cooldown before allowing another -->
          <!-- âœ… ESCAPE EXCEPTION: Bypass cooldown if ship is in blacklisted sector and needs to escape -->
          <set_value name="$canDoLiveSearch" exact="true"/>
          <set_value name="$cooldownRemaining" exact="0"/>
          
          <!-- âœ… ESCAPE LOGIC: Check if ship is in blacklisted sector (needs escape, bypass cooldown) -->
          <set_value name="$needsEscape" exact="false"/>
          <set_value name="$currentSector" exact="$ship.sector"/>
          <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
          <do_if value="$blacklistgroup? and $currentSector?">
            <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$needsEscape">
              <param name="sector" value="$currentSector"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
          </do_if>
          
          <!-- Check cooldown for cache miss triggers (only if not escaping) -->
          <set_value name="$hasCooldown" exact="false"/>
          <do_if value="not $needsEscape">
            <!-- Only check cooldown if ship doesn't need to escape -->
            <!-- âœ… FIX: Defensive check for race condition (initialization might not have completed yet) -->
            <do_if value="not global.$GT_CacheMissCooldowns?">
              <set_value name="global.$GT_CacheMissCooldowns" exact="table[]"/>
            </do_if>
            
            <do_if value="global.$GT_CacheMissCooldowns.{$ship}?">
              <set_value name="$hasCooldown" exact="true"/>
              <set_value name="$cooldownData" exact="global.$GT_CacheMissCooldowns.{$ship}"/>
              <set_value name="$timeSinceLastSearch" exact="player.age - $cooldownData.$LastLiveSearch"/>
              <set_value name="$cooldownRemaining" exact="$cooldownData.$CooldownDuration - $timeSinceLastSearch"/>
              <do_if value="$cooldownRemaining gt 0">
                <!-- Still in cooldown - skip live search -->
                <set_value name="$canDoLiveSearch" exact="false"/>
                <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                  <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Cache miss â†’ live search cooldown active (' + ($cooldownRemaining / 1) + 's remaining of ' + ($cooldownData.$CooldownDuration / 1) + 's) - skipping live search to prevent loop'" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
          </do_if>
          <do_else>
            <!-- Ship needs to escape - bypass cooldown and clear it -->
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') ðŸš¨ ESCAPE NEEDED: Ship in blacklisted sector - bypassing cooldown to search for escape route'" chance="100"/>
            </do_if>
            <!-- Clear cooldown so ship can search immediately for escape -->
            <!-- âœ… FIX: Defensive check for race condition (initialization might not have completed yet) -->
            <do_if value="not global.$GT_CacheMissCooldowns?">
              <set_value name="global.$GT_CacheMissCooldowns" exact="table[]"/>
            </do_if>
            <do_if value="global.$GT_CacheMissCooldowns.{$ship}?">
              <remove_value name="global.$GT_CacheMissCooldowns.{$ship}"/>
            </do_if>
          </do_else>
          
          <do_if value="$canDoLiveSearch">
            <!-- âœ… ENHANCED: Log when live search starts (debug mode only) -->
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <set_value name="$cacheTradeCountForLog" exact="0"/>
              <do_if value="$cacheTradeList?">
                <set_value name="$cacheTradeCountForLog" exact="@$cacheTradeList.count"/>
              </do_if>
              <debug_text text="'[GT-Search] (' + $ship.idcode + ') ðŸ”„ Starting LIVE market search (cache had ' + $cacheTradeCountForLog + ' trades, none suitable)'" chance="100"/>
            </do_if>
            
            <!-- Initialize cooldown tracking if not exists -->
            <!-- âœ… FIX: Defensive check for race condition (initialization might not have completed yet) -->
            <do_if value="not global.$GT_CacheMissCooldowns?">
              <set_value name="global.$GT_CacheMissCooldowns" exact="table[]"/>
            </do_if>
            
            <!-- âœ… FIX: Update cooldown for cache miss triggers -->
            <do_if value="not $hasCooldown">
              <!-- First live search trigger for this ship - start at 10 seconds -->
              <set_value name="global.$GT_CacheMissCooldowns.{$ship}" exact="table[
                $LastLiveSearch = player.age,
                $CooldownDuration = 10s
              ]"/>
            </do_if>
            <do_else>
              <!-- Increase cooldown (double, max 60s) - cooldownData exists since hasCooldown is true -->
              <set_value name="$newCooldown" exact="$cooldownData.$CooldownDuration * 2"/>
              <do_if value="$newCooldown gt 60s">
                <set_value name="$newCooldown" exact="60s"/>
              </do_if>
              <set_value name="global.$GT_CacheMissCooldowns.{$ship}" exact="table[
                $LastLiveSearch = player.age,
                $CooldownDuration = $newCooldown
              ]"/>
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Cache miss â†’ live search cooldown increased to ' + ($newCooldown / 1) + 's'" chance="100"/>
              </do_if>
            </do_else>
            
            <!-- Perform live search -->
            <signal_cue_instantly cue="md.GT_Search_Methods.SearchLiveTrades" param="table[
            $Ship = $ship,
            $MaxDistance = $maxDistance,
            $MinROI = $minROI,
            $MinAbsoluteProfit = $minAbsoluteProfit,
            $FactionPriority = $factionPriority,
            $FactionPriorityText = $factionPriorityText,
            $DistancePenaltyMultiplier = $distancePenaltyMultiplier,
            $SkillLevel = $skillLevel,
            $ThreatIntel = $gt_ThreatIntel,
            $FleetCoord = $gt_FleetCoord,
            $AdvancedAnalytics = $gt_AdvancedAnalytics
            ]"/>
            
            <!-- âœ… CRITICAL FIX: Check if batch processing started after signaling SearchLiveTrades -->
            <!-- SearchLiveTrades sets $WaitingForBatch = true when it prepares batch data -->
            <!-- If batch started, exit immediately - SearchLiveTrades_Resume will signal us again when complete -->
            <set_value name="$batchStarted" exact="false"/>
            <do_if value="global.$GT_SearchResult.$WaitingForBatch?">
              <set_value name="$batchStarted" exact="global.$GT_SearchResult.$WaitingForBatch"/>
            </do_if>
            
            <do_if value="$batchStarted">
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                <debug_text text="'[GT-Search] (' + $ship.idcode + ') â¸ï¸ Batch processing started - exiting (SearchLiveTrades_Resume will signal when complete)'" chance="100"/>
              </do_if>
              <!-- Exit - SearchLiveTrades_Resume will signal this cue again when batch completes -->
              <cancel_cue cue="this"/>
            </do_if>
            
            <!-- Track that live search was performed -->
            <set_value name="$searchMethod" exact="'live'"/>
          </do_if>
          <do_else>
            <!-- Cooldown active - skip live search -->
            <!-- CRITICAL: Don't clear results if we're using live search continuation (results already set above) -->
            <!-- CRITICAL: Preserve cache tradeList even if bestTrade was invalid (fallback can find valid trade from list) -->
            <do_if value="not $isLiveSearchContinuation">
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Skipping live search due to cooldown - preserving cache results (bestTrade may be null, tradeList.count=' + (if $tradeList? and $tradeList.count? then $tradeList.count else 0) + ')'" chance="100"/>
              </do_if>
              <set_value name="$searchMethod" exact="'cache'"/>
              <!-- Only clear bestTrade if it was invalid (already cleared above), but preserve tradeList from cache -->
              <!-- bestTrade will be selected from tradeList by fallback logic if needed -->
              <do_if value="not $bestTrade? or not $bestTrade.$BuyOffer?">
                <set_value name="$bestTrade" exact="null"/>
                <set_value name="$bestScore" exact="0"/>
              </do_if>
              <!-- Preserve tradeList from cache - don't overwrite with empty list! -->
              <!-- Fallback logic will try to find valid trade from tradeList -->
            </do_if>
          </do_else>
          
          <!-- âœ… CRITICAL FIX: Check batch status BEFORE extracting results -->
          <!-- If batch is in progress, exit immediately - don't extract stale results -->
          <!-- SearchLiveTrades_Resume will signal this cue again when batch completes -->
          <set_value name="$batchInProgress" exact="false"/>
          <do_if value="global.$GT_SearchResult.$WaitingForBatch?">
            <set_value name="$batchInProgress" exact="global.$GT_SearchResult.$WaitingForBatch"/>
          </do_if>
          
          <do_if value="$batchInProgress">
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <debug_text text="'[GT-Search] (' + $ship.idcode + ') â¸ï¸ Batch processing in progress - skipping result extraction (SearchLiveTrades_Resume will signal when complete)'" chance="100"/>
            </do_if>
            <!-- Exit - SearchLiveTrades_Resume will signal this cue again when batch completes -->
            <cancel_cue cue="this"/>
          </do_if>
          
          <!-- âœ… REMOVED: Redundant batch check - already handled at the beginning of the cue -->
          <!-- Extract live search results from global return variable (batch processing completed) -->
          <!-- Note: If $isLiveSearchContinuation is true, live results were already extracted above -->
          <do_if value="not $isLiveSearchContinuation">
            <set_value name="$bestTrade" exact="@global.$GT_SearchResult.$BestTrade"/>
            <set_value name="$bestScore" exact="@global.$GT_SearchResult.$BestScore"/>
            
            <!-- âœ… FIX: Validate bestTrade IMMEDIATELY after extracting from global -->
            <run_actions ref="md.GT_Trade_Utilities.GT_IsTradeValid" result="$bestTradeValidFromGlobal">
              <param name="trade" value="$bestTrade"/>
              <param name="minScore" value="0"/>
            </run_actions>
            <do_if value="not $bestTradeValidFromGlobal">
              <!-- bestTrade from global is invalid - clear it so fallback can fix it -->
              <set_value name="$bestTrade" exact="null"/>
              <set_value name="$bestScore" exact="0"/>
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') âš ï¸ bestTrade from global.$GT_SearchResult is INVALID - cleared for fallback fix'" chance="100"/>
              </do_if>
            </do_if>
            
            <do_if value="global.$GT_SearchResult.$StationsEvaluated?">
              <set_value name="$stationsEvaluated" exact="global.$GT_SearchResult.$StationsEvaluated"/>
            </do_if>
            <do_if value="global.$GT_SearchResult.$OffersFound?">
              <set_value name="$offersFound" exact="global.$GT_SearchResult.$OffersFound"/>
            </do_if>
            <!-- âœ… CRITICAL: Initialize to empty list first, then extract from global if it exists -->
            <set_value name="$tradeList" exact="[]"/>
            <do_if value="global.$GT_SearchResult.$TradeList?">
              <set_value name="$tradeList" exact="global.$GT_SearchResult.$TradeList"/>
            </do_if>
            <!-- Update rejection statistics from live search (if available) -->
            <do_if value="global.$GT_SearchResult.$TradesRejectedDocking?">
              <set_value name="$tradesRejectedDocking" exact="global.$GT_SearchResult.$TradesRejectedDocking"/>
            </do_if>
            <do_if value="global.$GT_SearchResult.$TradesRejectedBlacklist?">
              <set_value name="$tradesRejectedBlacklist" exact="global.$GT_SearchResult.$TradesRejectedBlacklist"/>
            </do_if>
            <do_if value="global.$GT_SearchResult.$TradesRejectedProfit?">
              <set_value name="$tradesRejectedProfit" exact="global.$GT_SearchResult.$TradesRejectedProfit"/>
            </do_if>
            <do_if value="global.$GT_SearchResult.$TradesRejectedDistance?">
              <set_value name="$tradesRejectedDistance" exact="global.$GT_SearchResult.$TradesRejectedDistance"/>
            </do_if>
            <do_if value="global.$GT_SearchResult.$TradesRejectedAmount?">
              <set_value name="$tradesRejectedAmount" exact="global.$GT_SearchResult.$TradesRejectedAmount"/>
            </do_if>
            <do_if value="global.$GT_SearchResult.$BestRejectedTrade?">
              <set_value name="$bestRejectedTrade" exact="global.$GT_SearchResult.$BestRejectedTrade"/>
            </do_if>
            
            <!-- Failed sector filtering now happens during best trade tracking (inside evaluation loop) -->
            <!-- This ensures: 1) All trades are cached for other ships, 2) Best selection excludes failed sectors -->
          </do_if>  <!-- End of extracting live results if not continuation -->
        </do_if>  <!-- End of live trade search -->
        
        <!-- âœ… SORT TRADE LIST BY SCORE (highest first) before sending to AI validation -->
        <!-- This ensures AI validates the best trades first -->
        <run_actions ref="md.GT_Trade_Utilities.GT_SortTradesByScore" result="$tradeList">
          <param name="tradeList" value="$tradeList"/>
        </run_actions>
        
        <!-- âœ… CRITICAL FIX: If tradeList exists but bestTrade is null, select best from list -->
        <!-- This can happen during continuation if BestTrade wasn't stored in global -->
        <!-- âœ… FIX: Use strict validation (library function) instead of weak Score-only check -->
        <set_value name="$bestTradeIsValid" exact="false"/>
        <run_actions ref="md.GT_Trade_Utilities.GT_IsTradeValid" result="$bestTradeIsValid">
          <param name="trade" value="$bestTrade"/>
          <param name="minScore" value="0"/>
        </run_actions>
        
        <do_if value="not $bestTradeIsValid">
          <!-- âœ… FIX: Use library function for consistent validation -->
          <do_if value="$tradeList? and $tradeList.count? and $tradeList.count gt 0">
            <do_all exact="$tradeList.count" counter="$i">
              <set_value name="$firstTrade" exact="@$tradeList.{$i}"/>
              <run_actions ref="md.GT_Trade_Utilities.GT_IsTradeValid" result="$firstTradeValid">
                <param name="trade" value="$firstTrade"/>
                <param name="minScore" value="0"/>
              </run_actions>
              <do_if value="$firstTradeValid">
                <set_value name="$testScore" exact="@$firstTrade.$Score"/>
                <set_value name="$bestTrade" exact="$firstTrade"/>
                <set_value name="$bestScore" exact="$testScore"/>
                <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                  <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') âš ï¸ bestTrade was null but tradeList has ' + $tradeList.count + ' trades - selected valid trade[' + $i + '] as bestTrade'" chance="100"/>
                </do_if>
                <break/>
              </do_if>
            </do_all>
          </do_if>
        </do_if>
        
        <!-- Execute best trade if found -->
        <!-- DEBUG: Log bestTrade status for continuation debugging -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
          <set_value name="$bestTradeExists" exact="$bestTrade?"/>
          <set_value name="$tradeListCount" exact="0"/>
          <do_if value="$tradeList?">
            <set_value name="$tradeListCount" exact="$tradeList.count"/>
          </do_if>
          <set_value name="$bestTradeCheck" exact="'null'"/>
          <do_if value="$bestTrade?">
            <set_value name="$bestTradeCheck" exact="'exists'"/>
            <do_if value="$bestTrade.$BuyOffer?">
              <set_value name="$bestTradeCheck" exact="'valid'"/>
            </do_if>
          </do_if>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Trade execution check: bestTrade=' + $bestTradeCheck + ', tradeList.count=' + $tradeListCount + ', isContinuation=' + $isLiveSearchContinuation" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- âœ… DEBUG: Validate bestTrade before execution -->
        <!-- âœ… FIX: More robust validation - check that properties actually exist and are not null -->
        <set_value name="$bestTradeIsValidForExecution" exact="false"/>
        <do_if value="$bestTrade?">
          <set_value name="$testBuyOffer" exact="@$bestTrade.$BuyOffer"/>
          <set_value name="$testSellOffer" exact="@$bestTrade.$SellOffer"/>
          <set_value name="$testScore" exact="@$bestTrade.$Score"/>
          <!-- âœ… CRITICAL FIX: Check if BuyOffer/SellOffer exist AND are not null, AND Score exists AND is > 0 -->
          <!-- In MD, null? returns true (variable exists), so we need to check Score > 0 to ensure it's a real trade -->
          <do_if value="$testBuyOffer? and $testSellOffer? and $testScore? and $testScore gt 0">
            <!-- Double-check: Try accessing a property from BuyOffer to ensure it's not null -->
            <set_value name="$testWare" exact="@$testBuyOffer.ware"/>
            <do_if value="$testWare?">
              <set_value name="$bestTradeIsValidForExecution" exact="true"/>
            </do_if>
          </do_if>
        </do_if>
        
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <do_if value="$bestTradeIsValidForExecution">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') âœ… bestTrade is VALID - proceeding with execution'" chance="100"/>
          </do_if>
          <do_else>  <!-- âœ… FIX: do_else for do_if at line 987 -->
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') âŒ bestTrade is INVALID (null or missing properties) - cannot execute'" chance="100"/>
            <!-- âœ… FIX: If bestTrade is invalid but tradeList has trades, select first valid trade from list -->
            <do_if value="$tradeList? and $tradeList.count? and $tradeList.count gt 0">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') âš ï¸ Attempting to select valid trade from tradeList (' + $tradeList.count + ' trades available)'" chance="100"/>
              <do_all exact="$tradeList.count" counter="$i">
                <set_value name="$candidateTrade" exact="$tradeList.{$i}"/>
                <run_actions ref="md.GT_Trade_Utilities.GT_IsTradeValid" result="$candidateValid">
                  <param name="trade" value="$candidateTrade"/>
                  <param name="minScore" value="0"/>
                </run_actions>
                <do_if value="$candidateValid">
                  <set_value name="$candidateScore" exact="@$candidateTrade.$Score"/>
                  <set_value name="$bestTrade" exact="$candidateTrade"/>
                  <set_value name="$bestScore" exact="$candidateScore"/>
                  <set_value name="$bestTradeIsValidForExecution" exact="true"/>
                  <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') âœ… Selected valid trade from tradeList[' + $i + '] (Score: ' + $candidateScore + ')'" chance="100"/>
                  <break/>
                </do_if>
              </do_all>
            </do_if>
            <!-- âœ… FIX: If still invalid after all fallbacks, check for fallback search before signaling no trade found -->
            <!-- âœ… REMOVED: Redundant batch check - already handled at the beginning of the cue -->
            <do_if value="not $bestTradeIsValidForExecution">
              <!-- Batch processing is complete (checked at start) - safe to proceed with "no trade found" logic -->
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') âŒ No valid trades found in tradeList (' + (if $tradeList? and $tradeList.count? then $tradeList.count else 0) + ' entries) - all trades invalid'" chance="100"/>
              
              <!-- âœ… FALLBACK SEARCH: Check if we should trigger fallback search before signaling no trade found -->
              <do_if value="not $fallbackSearchTriggered and not $foundCachedTrade">
                <!-- âœ… FALLBACK COOLDOWN: Check if fallback was already attempted in this search cycle -->
                <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_FallbackAttempted exists -->
                <set_value name="$fallbackAlreadyAttempted" exact="false"/>
                <do_if value="global.$GT_FallbackAttempted.{$ship}?">
                  <set_value name="$fallbackAlreadyAttempted" exact="true"/>
                  <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                    <debug_text text="'[GT-Search] (' + $ship.idcode + ') â¸ï¸ Fallback search already attempted in this cycle - skipping (will retry after normal search cooldown)'" chance="100"/>
                  </do_if>
                </do_if>
                
                <!-- Cache search failed, live search failed - check if ship is isolated -->
                <set_value name="$shipIsIsolated" exact="false"/>
                <run_actions ref="md.GT_Blacklist_Utilities.GT_CheckAndHandleIsolation" result="$isolationResult">
                  <param name="ship" value="$ship"/>
                  <param name="state" value="table[]"/>
                </run_actions>
                <set_value name="$shipIsIsolated" exact="$isolationResult.$IsIsolated"/>
                
                <!-- Only trigger fallback search if ship is NOT isolated AND fallback not already attempted -->
                <do_if value="not $shipIsIsolated and not $fallbackAlreadyAttempted">
                  <!-- Write logbook message BEFORE triggering fallback search -->
                  <set_value name="$currentSectorName" exact="@$ship.sector.knownname"/>
                  <do_if value="not $currentSectorName?">
                    <set_value name="$currentSectorName" exact="'Unknown Sector'"/>
                  </do_if>
                  
                  <!-- Construct logbook message using TextDB syntax -->
                  <set_value name="$logbookMessage" exact="{77000,3221}.[$ship.knownname, $currentSectorName, $maxDistance, 2]"/>
                  
                  <!-- Write logbook entry using centralized library -->
                  <run_actions ref="md.GT_Logbook_Utilities.WriteLogbookMessage">
                    <param name="Message" value="$logbookMessage"/>
                    <param name="Category" value="'alerts'"/>
                    <param name="Title" value="'Fallback Search: ' + $ship.knownname"/>
                    <param name="Object" value="$ship"/>
                    <param name="Interaction" value="'showonmap'"/>
                    <param name="CheckGlobalSettings" value="true"/>
                  </run_actions>
                  
                  <!-- Mark that fallback search was triggered -->
                  <set_value name="$fallbackSearchTriggered" exact="true"/>
                  
                  <!-- âœ… RACE CONDITION FIX: Ensure table exists before accessing (handles race condition) -->
                  <do_if value="not global.$GT_FallbackAttempted?">
                    <set_value name="global.$GT_FallbackAttempted" exact="table[]"/>
                  </do_if>
                  <!-- âœ… FALLBACK COOLDOWN: Mark fallback as attempted globally (persists across cue instances) -->
                  <set_value name="global.$GT_FallbackAttempted.{$ship}" exact="true"/>
                  
                  <!-- Trigger fallback search -->
                  <!-- âœ… DESIGN: Fallback uses lower profit thresholds, so we compensate by restricting travel distance -->
                  <!-- Use maxJumps / 3 to balance: closer trades (less travel time) but still within reasonable range -->
                  <!-- Minimum: 2 jumps, Maximum: pilot's maxDistance / 3 -->
                  <!-- OriginalMaxDistance used for filtering stations from home sector -->
                  <!-- Use library function for fallback distance calculation -->
                  <run_actions ref="md.GT_Trade_Utilities.GT_CalculateFallbackDistance" result="$fallbackMaxDistance">
                    <param name="maxDistance" value="$maxDistance"/>
                  </run_actions>
                  <set_value name="$fallbackParams" exact="table[
                    $Ship = $ship,
                    $MaxDistance = $fallbackMaxDistance,
                    $OriginalMaxDistance = $maxDistance,
                    $MinROI = $minROI,
                    $MinAbsoluteProfit = $minAbsoluteProfit,
                    $FactionPriority = $factionPriority,
                    $FactionPriorityText = $factionPriorityText,
                    $DistancePenaltyMultiplier = $distancePenaltyMultiplier,
                    $SkillLevel = $skillLevel,
                    $ThreatIntel = $gt_ThreatIntel,
                    $FleetCoord = $gt_FleetCoord,
                    $AdvancedAnalytics = $gt_AdvancedAnalytics
                  ]"/>
                  <signal_cue_instantly cue="md.GT_Search_Methods.SearchFallbackTrades" param="$fallbackParams"/>
                  
                  <!-- Exit - SearchFallbackTrades will signal SearchTradeRoutes again when complete -->
                  <cancel_cue cue="this"/>
                </do_if>
                <do_else>
                  <!-- Ship is isolated OR fallback already attempted - signal no trade found -->
                  <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                    <debug_text text="'[GT-Search] (' + $ship.idcode + ') âš ï¸ Ship is isolated or fallback already attempted - signaling no trade found'" chance="100"/>
                  </do_if>
                  <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
                </do_else>
              </do_if>  <!-- âœ… FIX: Close do_if from line 1017 -->
              <do_else>
                <!-- Fallback search already triggered or cache search succeeded - signal no trade found -->
                <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                  <debug_text text="'[GT-Search] (' + $ship.idcode + ') âœ… Search complete - signaling no trade found (fallback already triggered or cache succeeded)'" chance="100"/>
                </do_if>
                <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
              </do_else>  <!-- âœ… FIX: Close do_else (else for do_if line 1017) -->
            </do_if>  <!-- âœ… FIX: Close do_if from line 1013 -->
          </do_else>  <!-- âœ… FIX: Close do_else from line 990 (else for do_if line 987) -->
          </do_if>  <!-- âœ… FIX: Close do_if from line 986 -->
        
        <!-- âœ… REMOVED: Redundant batch check - already handled at the beginning of the cue -->
        <do_if value="$bestTradeIsValidForExecution">
          <!-- âœ… DEBUG: Log that we're entering the bestTrade execution block -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') âœ… ENTERING bestTrade execution block'" chance="100"/>
            <!-- âœ… FALLBACK SEARCH: Log if this trade came from fallback search -->
            <do_if value="$isFallbackSearch">
              <debug_text text="'[GT-Search] (' + $ship.idcode + ') âœ… Fallback search complete: Found ' + (if $tradeList? and $tradeList.count? then $tradeList.count else 0) + ' trades (MaxDistance=2)'" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- DEBUG: Trade execution with full details -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <set_value name="$wareName" exact="@$bestTrade.$BuyOffer.ware.name"/>
            <set_value name="$buyStationName" exact="@$bestTrade.$BuyOffer.owner.knownname"/>
            <set_value name="$sellStationName" exact="@$bestTrade.$SellOffer.owner.knownname"/>
            <set_value name="$amount" exact="@$bestTrade.$Amount"/>
            <set_value name="$buyPrice" exact="@$bestTrade.$BuyPrice"/>
            <set_value name="$sellPrice" exact="@$bestTrade.$SellPrice"/>
            <set_value name="$distance" exact="@$bestTrade.$Distance"/>
            <set_value name="$profit" exact="@$bestTrade.$Profit"/>
            <set_value name="$roi" exact="@$bestTrade.$ROI"/>
            <set_value name="$score" exact="@$bestTrade.$Score"/>
            <set_value name="$risk" exact="@$bestTrade.$Risk"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') ðŸ“Š BEST TRADE SELECTED:' + '\n  ðŸ“¦ Ware: ' + $wareName + ' (x' + $amount + ')' + '\n  ðŸ“ BUY from: ' + $buyStationName + ' @ ' + ($buyPrice / 100) + ' Cr' + '\n  ðŸ“ SELL to: ' + $sellStationName + ' @ ' + ($sellPrice / 100) + ' Cr' + '\n  ðŸš€ Distance: ' + $distance + ' jumps' + '\n  ðŸ’° Profit: ' + ($profit / 100) + ' Cr' + '\n  ðŸ“ˆ ROI: ' + $roi + '%' + '\n  ðŸ“Š Score: ' + $score + '\n  âš  Risk: ' + $risk" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- âœ… OPTIMIZED: Reserve trade route for fleet coordination (inline conflict resolution done during search) -->
          <do_if value="global.$GT_GlobalSettings.$Fleet.$EnableFleetCoordination">
            <!-- âœ… FIX: Initialize global.$GT_ActiveTradeReservations if it doesn't exist -->
            <do_if value="not global.$GT_ActiveTradeReservations?">
              <set_value name="global.$GT_ActiveTradeReservations" exact="table[]"/>
            </do_if>
            
            <!-- âœ… FIX: Use safe operators to access bestTrade properties -->
            <set_value name="$fleetBuyStation" exact="@$bestTrade.$BuyOffer.owner"/>
            <set_value name="$fleetSellStation" exact="@$bestTrade.$SellOffer.owner"/>
            <set_value name="$fleetWare" exact="@$bestTrade.$BuyOffer.ware"/>
            <do_if value="$fleetBuyStation? and $fleetSellStation? and $fleetWare?">
              <set_value name="global.$GT_ActiveTradeReservations.{$ship}" exact="table[
                $BuyStation = $fleetBuyStation,
                $SellStation = $fleetSellStation,
                $Ware = $fleetWare,
                $Timestamp = player.age
              ]"/>
            </do_if>
          </do_if>
          
          <!-- Execute trade -->
          <do_if value="true">
            <!-- DEBUG: Log exact trade list being sent to trading AI -->
            <!-- COMMENTED OUT: Reduces log spam - uncomment if needed for debugging -->
            <!-- <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <set_value name="$logTradeList" exact="'[GT-Search] ðŸ“¤ SENDING TRADE LIST TO AI: ' + $ship.idcode + ' (' + $tradeList.count + ' trades)'"/>
              <do_all exact="$tradeList.count" counter="$i">
                <set_value name="$listTrade" exact="$tradeList.{$i}"/>
                <set_value name="$logTradeList" exact="$logTradeList + 
                  '\n  [' + $i + '] ' + @$listTrade.$BuyOffer.ware.name + 
                  ' | Buy: ' + @$listTrade.$BuyStation.knownname + ' @ ' + (@$listTrade.$BuyPrice / 100) + ' Cr' +
                  ' | Sell: ' + @$listTrade.$SellStation.knownname + ' @ ' + (@$listTrade.$SellPrice / 100) + ' Cr' +
                  ' | Score: ' + $listTrade.$Score + ' | Profit: ' + (@$listTrade.$Profit / 100) + ' Cr | ROI: ' + @$listTrade.$ROI + '% | Dist: ' + $listTrade.$Distance + ' jumps'"/>
              </do_all>
              <debug_text text="$logTradeList" chance="100"/>
            </do_if> -->
            
            <!-- Signal execution module (which will signal AI after storing trade LIST) -->
            <!-- âœ… NEW: Pass searchMethod so AI knows if trades came from cache or live search -->
            <signal_cue_instantly cue="md.GT_Trading_Execution.ExecuteTrade" param="table[
              $Ship = $ship,
              $Trade = $bestTrade,
              $TradeList = $tradeList,
              $SearchMethod = $searchMethod
            ]"/>
            
            <!-- GT_Trade_Found signal now sent FROM ExecuteTrade cue after storing pending trade -->
          </do_if>
        </do_if>
        
        <do_else>
          <!-- No valid trades found -->
          
          <!-- âœ… CRITICAL FIX: Check batch status BEFORE executing "no trade found" logic -->
          <!-- If batch is in progress, exit immediately - don't process stale data or signal failure -->
          <!-- SearchLiveTrades_Resume will signal this cue again when batch completes -->
          <set_value name="$batchStillInProgress" exact="false"/>
          <do_if value="global.$GT_SearchResult.$WaitingForBatch?">
            <set_value name="$batchStillInProgress" exact="global.$GT_SearchResult.$WaitingForBatch"/>
          </do_if>
          
          <do_if value="$batchStillInProgress">
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <debug_text text="'[GT-Search] (' + $ship.idcode + ') â¸ï¸ Batch processing still in progress - skipping no-trade-found logic (SearchLiveTrades_Resume will signal when complete)'" chance="100"/>
            </do_if>
            <!-- Exit - SearchLiveTrades_Resume will signal this cue again when batch completes -->
            <cancel_cue cue="this"/>
          </do_if>
          <do_else>
            <!-- Batch processing is complete - safe to proceed with "no trade found" logic -->
            
            <!-- DEBUG: No trades found (only if not waiting for batch) -->
            <do_if value="not $waitingForBatch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <set_value name="$totalRejected" exact="$tradesRejectedDocking + $tradesRejectedProfit + $tradesRejectedDistance + $tradesRejectedAmount"/>
            <!-- Get valid entries count from cache search (if available) -->
            <set_value name="$validEntries" exact="0"/>
            <set_value name="$diverseListCount" exact="0"/>
            <do_if value="global.$GT_SearchResult.$ValidEntries?">
              <set_value name="$validEntries" exact="global.$GT_SearchResult.$ValidEntries"/>
            </do_if>
            <do_if value="global.$GT_SearchResult.$DiverseListCount?">
              <set_value name="$diverseListCount" exact="global.$GT_SearchResult.$DiverseListCount"/>
            </do_if>
            
            <set_value name="$diagnosticInfo" exact="'\n\nðŸ” SEARCH CONTEXT:' +
              '\n  Search method: ' + $searchMethod +
              (if $cacheChecked then '\n  Cache checked: Yes (' + $cacheCount + ' entries)' else '\n  Cache checked: No') +
              (if $searchMethod == 'live' and $stationsEvaluated? then '\n  Stations evaluated: ' + $stationsEvaluated else '') +
              (if $searchMethod == 'live' and $offersFound? then '\n  Offers found: ' + $offersFound else '') +
              (if $searchMethod == 'cache' and $validEntries gt 0 then '\n  Valid cached trades found: ' + $validEntries + ' (diverse list: ' + $diverseListCount + ')' else '') +
              (if $totalRejected == 0 and $validEntries == 0 and ($offersFound == 0 or not $offersFound?) then '\n  âš ï¸ No trades were evaluated (cache empty or no offers found)' else '') +
              (if $validEntries gt 0 and $diverseListCount == 0 then '\n  âš ï¸ All valid trades filtered out during diverse list building (need unique station pairs)' else '')"/>
            
            <!-- Build best rejected trade info safely (extract properties first, then check) -->
            <set_value name="$bestRejectedInfo" exact="''"/>
            <do_if value="$bestRejectedTrade?">
              <!-- Extract properties safely -->
              <set_value name="$rejectedWare" exact="@$bestRejectedTrade.$ware"/>
              <set_value name="$rejectedBuyFrom" exact="@$bestRejectedTrade.$buyFrom"/>
              <set_value name="$rejectedSellTo" exact="@$bestRejectedTrade.$sellTo"/>
              <set_value name="$rejectedBuyPrice" exact="@$bestRejectedTrade.$buyPrice"/>
              <set_value name="$rejectedSellPrice" exact="@$bestRejectedTrade.$sellPrice"/>
              <set_value name="$rejectedProfit" exact="@$bestRejectedTrade.$profit"/>
              <set_value name="$rejectedROI" exact="@$bestRejectedTrade.$roi"/>
              
              <!-- Build info string with safe checks (use @ operator for property access) -->
              <set_value name="$bestRejectedInfo" exact="'\n\nðŸ† BEST REJECTED TRADE (still unprofitable):' +
                '\n  Ware: ' + (if $rejectedWare? then @$rejectedWare.name else 'Unknown') +
                '\n  Buy from: ' + (if $rejectedBuyFrom? then @$rejectedBuyFrom.knownname else 'Unknown') + ' @ ' + (if $rejectedBuyPrice? then ($rejectedBuyPrice / 100) else '0') + ' Cr/unit' +
                '\n  Sell to: ' + (if $rejectedSellTo? then @$rejectedSellTo.knownname else 'Unknown') + ' @ ' + (if $rejectedSellPrice? then ($rejectedSellPrice / 100) else '0') + ' Cr/unit' +
                '\n  Best profit found: ' + (if $rejectedProfit? then ($rejectedProfit / 100) else '0') + ' Cr (needed: ' + ($minAbsoluteProfit / 100) + ' Cr)' +
                '\n  Best ROI found: ' + (if $rejectedROI? then $rejectedROI else '0') + '% (needed: ' + $minROI + '%)'"/>
            </do_if>
            
            <!-- âœ… ENHANCED: Show detailed analysis when no trades found (debug mode only) -->
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <debug_text text="'[GT-Search] (' + $ship.idcode + ') === NO TRADES FOUND ANALYSIS ===' + 
                '\nShip: ' + $ship.knownname + 
                '\nSector: ' + $ship.sector.knownname + 
                '\nSearch Method: ' + $searchMethod +
                '\nSearch params: Dist=' + $maxDistance + ', MinROI=' + $minROI + '%, MinAbsoluteProfit=' + ($minAbsoluteProfit / 100) + ' Cr' +
                $diagnosticInfo +
                '\n\nðŸ“Š REJECTION STATISTICS:' +
                '\n  â›” Docking not allowed: ' + $tradesRejectedDocking +
                '\n  ðŸ’° Insufficient profit: ' + $tradesRejectedProfit +
                '\n  ðŸ“ Distance too far: ' + $tradesRejectedDistance +
                '\n  ðŸ“¦ Amount zero/negative: ' + $tradesRejectedAmount +
                '\n  ðŸš« Blacklisted/Path blocked: ' + $totalBlacklistFiltered +
                '\n  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”' +
                '\n  TOTAL REJECTED: ' + $totalRejected +
                '\n  TOTAL EVALUATED: ' + $totalEvaluated +
                '\n  OFFERS FOUND: ' + $offersFound +
                $bestRejectedInfo" 
                chance="100"/>
            </do_if>
          </do_if>
          
          <!-- Commented out to reduce log spam -->
          <!-- <debug_text text="'[GalaxyTrader MK3] No profitable trades found for ' + $ship.knownname" chance="100"/> -->
          
          <!-- Store rejection statistics for AI script to use after 60s wait -->
          <!-- Logbook entry will be written by AI script only after max wait time (60s) -->
          <!-- Note: Get filtered counts from live search resume if available (tracks blacklist/path filtering) -->
          <set_value name="$filteredByBlacklistFromResume" exact="0"/>
          <set_value name="$filteredByPathBlockedFromResume" exact="0"/>
          <set_value name="$totalTradesFromResume" exact="0"/>
          <do_if value="global.$GT_SearchResult.$FilteredByBlacklist?">
            <set_value name="$filteredByBlacklistFromResume" exact="global.$GT_SearchResult.$FilteredByBlacklist"/>
          </do_if>
          <do_if value="global.$GT_SearchResult.$FilteredByPathBlocked?">
            <set_value name="$filteredByPathBlockedFromResume" exact="global.$GT_SearchResult.$FilteredByPathBlocked"/>
          </do_if>
          <do_if value="global.$GT_SearchResult.$TotalTradesEvaluated?">
            <set_value name="$totalTradesFromResume" exact="global.$GT_SearchResult.$TotalTradesEvaluated"/>
          </do_if>
          
          <!-- Combine blacklist stats: If using continuation, $tradesRejectedBlacklist already includes combined value -->
          <!-- Otherwise, combine evaluation-phase rejections + pre-filtering rejections -->
          <set_value name="$totalBlacklistFiltered" exact="$tradesRejectedBlacklist"/>
          <do_if value="not $isLiveSearchContinuation">
            <!-- Not a continuation: combine evaluation-phase + pre-filtering rejections -->
            <set_value name="$totalBlacklistFiltered" exact="$tradesRejectedBlacklist + $filteredByBlacklistFromResume + $filteredByPathBlockedFromResume"/>
          </do_if>
          <set_value name="$totalRejected" exact="$tradesRejectedDocking + $tradesRejectedProfit + $tradesRejectedAmount + $totalBlacklistFiltered"/>
          
          <!-- Total evaluated = evaluation-phase rejections + valid trades found + pre-filtered trades -->
          <set_value name="$totalEvaluated" exact="$totalRejected"/>
          <do_if value="$totalTradesFromResume gt 0">
            <!-- If we have resume stats, use those (more accurate) -->
            <set_value name="$totalEvaluated" exact="$totalTradesFromResume"/>
          </do_if>
          <do_elseif value="$totalRejected gt 0 or $offersFound gt 0">
            <!-- Fallback: Use rejection count if we have rejections, or offers found count -->
            <set_value name="$totalEvaluated" exact="$totalRejected"/>
          </do_elseif>
          <do_else>
            <!-- No stats available - default to 0 (no trades found at all) -->
            <set_value name="$totalEvaluated" exact="0"/>
          </do_else>
          
          <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_SearchResult exists -->
          
          <!-- âœ… DEBUG: Log rejection stats before storing (only if debug logging enabled) -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$currentSectorName" exact="@$ship.sector.knownname"/>
            <debug_text text="'[GT-Search] (' + $ship.idcode + ') ðŸ“ STORING REJECTION STATS FOR LOGBOOK:' +
              '\n  SectorName: ' + (if $currentSectorName? then $currentSectorName else 'null') +
              '\n  MaxDistance: ' + $maxDistance +
              '\n  MinAbsoluteProfit: ' + ($minAbsoluteProfit/100) + ' Cr' +
              '\n  TotalEvaluated: ' + $totalEvaluated +
              '\n  TotalRejected: ' + $totalRejected +
              '\n  RejectedDocking: ' + $tradesRejectedDocking +
              '\n  RejectedProfit: ' + $tradesRejectedProfit +
              '\n  RejectedAmount: ' + $tradesRejectedAmount +
              '\n  RejectedBlacklist (eval phase): ' + $tradesRejectedBlacklist +
              '\n  FilteredBlacklist (pre-filter): ' + $filteredByBlacklistFromResume +
              '\n  FilteredPathBlocked (pre-filter): ' + $filteredByPathBlockedFromResume +
              '\n  TotalBlacklistFiltered: ' + $totalBlacklistFiltered +
              '\n  OffersFound: ' + $offersFound +
              '\n  TotalTradesFromResume: ' + $totalTradesFromResume" 
              chance="100"/>
          </do_if>
          
          <!-- Extract sector name safely (using library function) -->
          <run_actions ref="md.GT_Utilities.GT_GetSectorNameSafe" result="$sectorNameForStorage">
            <param name="ship" value="$ship"/>
          </run_actions>
          
          <!-- Store per-ship to prevent overwrites by other ships' searches -->
          <!-- âœ… FIX: Ensure LastRejectionStats is initialized as a table (not null) -->
          <!-- First ensure global.$GT_SearchResult exists -->
          <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_SearchResult exists -->
          <!-- Then ensure LastRejectionStats is a valid table (not null) -->
          <!-- Preserve existing data if it's already a valid table -->
          <set_value name="$preservedLastRejectionStats" exact="null"/>
          <do_if value="global.$GT_SearchResult.$LastRejectionStats?">
            <!-- Try to access .keys.count - if it returns a valid number (>= 0), it's a valid table -->
            <set_value name="$tempKeysCount" exact="@global.$GT_SearchResult.$LastRejectionStats.keys.count"/>
            <do_if value="$tempKeysCount? and $tempKeysCount ge 0">
              <!-- Valid table - preserve it using safe operator to avoid crash if it's null -->
              <set_value name="$tempTable" exact="@global.$GT_SearchResult.$LastRejectionStats"/>
              <do_if value="$tempTable?">
                <set_value name="$preservedLastRejectionStats" exact="$tempTable"/>
              </do_if>
            </do_if>
          </do_if>
          <!-- Always initialize as a fresh table (will overwrite null, but preserve valid tables) -->
          <set_value name="global.$GT_SearchResult.$LastRejectionStats" exact="table[]"/>
          <!-- Restore preserved data if we had a valid table -->
          <do_if value="$preservedLastRejectionStats?">
            <set_value name="global.$GT_SearchResult.$LastRejectionStats" exact="$preservedLastRejectionStats"/>
          </do_if>
          
          <!-- âœ… FIX: Use local variables (calculated in this code path) with fallback to global -->
          <!-- Local variables are calculated from batch processor results or live search continuation -->
          <!-- Fallback to global.$GT_SearchResult if local variables are 0 (stats might be in global from FilterTradeList_Resume) -->
          <set_value name="$statsDocking" exact="$tradesRejectedDocking"/>
          <set_value name="$statsProfit" exact="$tradesRejectedProfit"/>
          <set_value name="$statsAmount" exact="$tradesRejectedAmount"/>
          <set_value name="$statsBlacklist" exact="$totalBlacklistFiltered"/>
          
          <!-- Fallback to global if local is 0 and global has values -->
          <do_if value="$statsDocking == 0 and global.$GT_SearchResult.$TradesRejectedDocking?">
            <set_value name="$statsDocking" exact="global.$GT_SearchResult.$TradesRejectedDocking"/>
          </do_if>
          <do_if value="$statsProfit == 0 and global.$GT_SearchResult.$TradesRejectedProfit?">
            <set_value name="$statsProfit" exact="global.$GT_SearchResult.$TradesRejectedProfit"/>
          </do_if>
          <do_if value="$statsAmount == 0 and global.$GT_SearchResult.$TradesRejectedAmount?">
            <set_value name="$statsAmount" exact="global.$GT_SearchResult.$TradesRejectedAmount"/>
          </do_if>
          <do_if value="$statsBlacklist == 0 and global.$GT_SearchResult.$TradesRejectedBlacklist?">
            <set_value name="$statsBlacklist" exact="global.$GT_SearchResult.$TradesRejectedBlacklist"/>
          </do_if>
          
          <!-- âœ… CRITICAL FIX: Only store LastRejectionStats if we have meaningful stats -->
          <!-- Prevents overwriting real stats with zeros from cache-only searches with no offers -->
          <!-- Check if we have existing stats that are non-zero, or if new stats are non-zero -->
          <set_value name="$hasExistingStats" exact="false"/>
          <set_value name="$existingStats" exact="@global.$GT_SearchResult.$LastRejectionStats.{$ship}"/>
          <do_if value="$existingStats?">
            <!-- Check if existing stats have meaningful data - check multiple fields to be safe -->
            <set_value name="$existingTotal" exact="@$existingStats.$Total"/>
            <set_value name="$existingDocking" exact="@$existingStats.$Docking"/>
            <set_value name="$existingProfit" exact="@$existingStats.$Profit"/>
            <!-- If any field exists and is > 0, we have meaningful stats -->
            <do_if value="($existingTotal? and $existingTotal gt 0) or ($existingDocking? and $existingDocking gt 0) or ($existingProfit? and $existingProfit gt 0)">
              <set_value name="$hasExistingStats" exact="true"/>
            </do_if>
          </do_if>
          
          <!-- âœ… DEBUG: Log storage decision (only if debug logging enabled) -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Search] (' + $ship.idcode + ') ðŸ“ LastRejectionStats STORAGE DECISION:' +
              '\n  TotalEvaluated: ' + $totalEvaluated +
              '\n  ExistingStats exists: ' + (if $existingStats? then 'yes' else 'no') +
              '\n  ExistingTotal: ' + (if $existingStats? and $existingStats.$Total? then $existingStats.$Total else 'null') +
              '\n  ExistingDocking: ' + (if $existingStats? and $existingStats.$Docking? then $existingStats.$Docking else 'null') +
              '\n  ExistingProfit: ' + (if $existingStats? and $existingStats.$Profit? then $existingStats.$Profit else 'null') +
              '\n  HasExistingStats: ' + $hasExistingStats +
              '\n  Will store: ' + (if ($totalEvaluated gt 0 or not $hasExistingStats) then 'yes' else 'no')" 
              chance="100"/>
          </do_if>
          
          <!-- Only store if: new stats are meaningful (TotalEvaluated > 0) OR no existing meaningful stats -->
          <!-- This prevents overwriting real stats with zeros, but allows storing zeros if no stats exist yet -->
          <do_if value="$totalEvaluated gt 0 or not $hasExistingStats">
            <!-- âœ… SIMPLIFIED: Extract, build new structure atomically, set back (initialization guarantees base structure) -->
            <!-- Extract existing data (preserve other properties and other ships' stats) -->
            <set_value name="$existingSearchResult" exact="@global.$GT_SearchResult"/>
            <set_value name="$existingLastRejectionStats" exact="@$existingSearchResult.$LastRejectionStats"/>
            <!-- Build new per-ship stats -->
            <set_value name="$newShipStats" exact="table[
              $Total = $totalEvaluated,
              $Docking = $statsDocking,
              $Profit = $statsProfit,
              $Amount = $statsAmount,
              $Blacklist = $statsBlacklist,
              $SectorName = $sectorNameForStorage,
              $MaxDistance = $maxDistance,
              $MinAbsoluteProfit = $minAbsoluteProfit
            ]"/>
            <!-- Use library function to update rejection stats -->
            <run_actions ref="md.GT_Trade_Utilities.GT_UpdateRejectionStats">
              <param name="ship" value="$ship"/>
              <param name="stats" value="$newShipStats"/>
            </run_actions>
            
            <!-- âœ… DEBUG: Verify storage succeeded (only if debug logging enabled) -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <set_value name="$verifyStats" exact="@global.$GT_SearchResult.$LastRejectionStats.{$ship}"/>
              <set_value name="$verifyTotal" exact="@$verifyStats.$Total"/>
              <debug_text text="'[GT-Search] (' + $ship.idcode + ') âœ… STORED LastRejectionStats - Verification:' +
                '\n  Stored Total: ' + (if $verifyTotal? then $verifyTotal else 'null') +
                '\n  Stored Docking: ' + (if $verifyStats.$Docking? then $verifyStats.$Docking else 'null') +
                '\n  Stored Profit: ' + (if $verifyStats.$Profit? then $verifyStats.$Profit else 'null') +
                '\n  Stored Amount: ' + (if $verifyStats.$Amount? then $verifyStats.$Amount else 'null') +
                '\n  Stored Blacklist: ' + (if $verifyStats.$Blacklist? then $verifyStats.$Blacklist else 'null')" 
                chance="100"/>
            </do_if>
          </do_if>
          
          <!-- âœ… FALLBACK SEARCH: Check if we should trigger fallback search before signaling no trade found -->
          <!-- This is the "no trades found" path after live search continuation completes -->
          <do_if value="not $fallbackSearchTriggered and not $foundCachedTrade">
            <!-- âœ… FALLBACK COOLDOWN: Check if fallback was already attempted in this search cycle -->
            <set_value name="$fallbackAlreadyAttempted" exact="false"/>
            <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_FallbackAttempted exists -->
            <do_if value="global.$GT_FallbackAttempted.{$ship}?">
              <set_value name="$fallbackAlreadyAttempted" exact="true"/>
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                <debug_text text="'[GT-Search] (' + $ship.idcode + ') â¸ï¸ Fallback search already attempted in this cycle - skipping (will retry after normal search cooldown)'" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- Cache search failed, live search failed - check if ship is isolated -->
            <set_value name="$shipIsIsolated" exact="false"/>
            <run_actions ref="md.GT_Blacklist_Utilities.GT_CheckAndHandleIsolation" result="$isolationResult">
              <param name="ship" value="$ship"/>
              <param name="state" value="table[]"/>
            </run_actions>
            <set_value name="$shipIsIsolated" exact="$isolationResult.$IsIsolated"/>
            
            <!-- Only trigger fallback search if ship is NOT isolated AND fallback not already attempted -->
            <do_if value="not $shipIsIsolated and not $fallbackAlreadyAttempted">
              <!-- Write logbook message BEFORE triggering fallback search -->
              <set_value name="$currentSectorName" exact="@$ship.sector.knownname"/>
              <do_if value="not $currentSectorName?">
                <set_value name="$currentSectorName" exact="'Unknown Sector'"/>
              </do_if>
              
              <!-- Construct logbook message using TextDB syntax -->
              <set_value name="$logbookMessage" exact="{77000,3221}.[$ship.knownname, $currentSectorName, $maxDistance, 2]"/>
              
              <!-- Write logbook entry using centralized library -->
              <run_actions ref="md.GT_Logbook_Utilities.WriteLogbookMessage">
                <param name="Message" value="$logbookMessage"/>
                <param name="Category" value="'alerts'"/>
                <param name="Title" value="'Fallback Search: ' + $ship.knownname"/>
                <param name="Object" value="$ship"/>
                <param name="Interaction" value="'showonmap'"/>
                <param name="CheckGlobalSettings" value="true"/>
              </run_actions>
              
              <!-- Mark that fallback search was triggered -->
              <set_value name="$fallbackSearchTriggered" exact="true"/>
              
              <!-- âœ… FALLBACK COOLDOWN: Mark fallback as attempted globally (persists across cue instances) -->
              <do_if value="not global.$GT_FallbackAttempted?">
                <set_value name="global.$GT_FallbackAttempted" exact="table[]"/>
              </do_if>
              <set_value name="global.$GT_FallbackAttempted.{$ship}" exact="true"/>
              
              <!-- Trigger fallback search -->
              <!-- âœ… DESIGN: Fallback uses lower profit thresholds, so we compensate by restricting travel distance -->
              <!-- Use maxJumps / 3 to balance: closer trades (less travel time) but still within reasonable range -->
              <!-- Minimum: 2 jumps, Maximum: pilot's maxDistance / 3 -->
              <!-- OriginalMaxDistance used for filtering stations from home sector -->
              <!-- Use library function for fallback distance calculation -->
              <run_actions ref="md.GT_Trade_Utilities.GT_CalculateFallbackDistance" result="$fallbackMaxDistance">
                <param name="maxDistance" value="$maxDistance"/>
              </run_actions>
              <set_value name="$fallbackParams" exact="table[
                $Ship = $ship,
                $MaxDistance = $fallbackMaxDistance,
                $OriginalMaxDistance = $maxDistance,
                $MinROI = $minROI,
                $MinAbsoluteProfit = $minAbsoluteProfit,
                $FactionPriority = $factionPriority,
                $FactionPriorityText = $factionPriorityText,
                $DistancePenaltyMultiplier = $distancePenaltyMultiplier,
                $SkillLevel = $skillLevel,
                $ThreatIntel = $gt_ThreatIntel,
                $FleetCoord = $gt_FleetCoord,
                $AdvancedAnalytics = $gt_AdvancedAnalytics
              ]"/>
              <signal_cue_instantly cue="SearchFallbackTrades" param="$fallbackParams"/>
              
              <!-- Exit - SearchFallbackTrades will signal SearchTradeRoutes again when complete -->
              <cancel_cue cue="this"/>
            </do_if>
            <do_else>
              <!-- Ship is isolated - signal no trade found (normal behavior for isolated ships) -->
              <signal_objects object="$ship" param="'GT_No_Trade_Found'" param2="'blacklist'"/>
            </do_else>
          </do_if>
          <do_else>
            <!-- Fallback search already triggered or cache search succeeded - signal no trade found -->
            <!-- âœ… FALLBACK SEARCH: Log if fallback search completed with no trades -->
            <do_if value="$isFallbackSearch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <debug_text text="'[GT-Search] (' + $ship.idcode + ') âŒ Fallback search complete: No trades found (MaxDistance=2)'" chance="100"/>
            </do_if>
            <!-- âœ… ENHANCED: Log before signaling no trade found (debug mode only) -->
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <debug_text text="'[GT-Search] (' + $ship.idcode + ') âœ… Search complete - signaling GT_No_Trade_Found (TotalRejected=' + $totalRejected + ', TotalEvaluated=' + $totalEvaluated + ', OffersFound=' + $offersFound + ')'" chance="100"/>
            </do_if>
            <!-- Signal back to AI script: No Trade Found -->
            <!-- CRITICAL: Always send 'blacklist' param to prevent idle timeout escalation -->
            <!-- Reason: With blacklist-aware pre-filtering, we can't distinguish "filtered" from "genuinely empty" -->
            <!-- Better UX: Don't escalate to 60s timeout when ship might just need blacklist adjustment -->
            <signal_objects object="$ship" param="'GT_No_Trade_Found'" param2="'blacklist'"/>
          </do_else>
          </do_else>  <!-- âœ… FIX: Close do_else for batch check (batch NOT in progress) -->
        </do_else>  <!-- âœ… FIX: Close do_else for bestTradeIsValidForExecution -->
        </do_if>  <!-- âœ… FIX: Close do_if for $shouldProceed -->
        
        <!-- CRITICAL: Release search lock ONLY if NOT waiting for batch processing FOR THIS SHIP -->
        <!-- If waiting for batch, SearchLiveTrades_Resume will signal SearchTradeRoutes again -->
        <!-- and we'll release the lock after processing live search results -->
        <!-- If we're continuing from live search, this IS the final completion, so release the lock -->
        <!-- âœ… FIX: Use $params.$Ship instead of $ship (available even if $shouldProceed was false) -->
        <set_value name="$shipForCleanup" exact="$params.$Ship"/>
        <do_if value="$shouldProceed and $ship?">
          <!-- If we proceeded, use the processed $ship (might have been modified) -->
          <set_value name="$shipForCleanup" exact="$ship"/>
        </do_if>
        
        <set_value name="$isWaitingForThisShipBatch" exact="false"/>
        <do_if value="$waitingForBatch and $batchShip == $params.$Ship">
          <set_value name="$isWaitingForThisShipBatch" exact="true"/>
        </do_if>
        
        <do_if value="not $isWaitingForThisShipBatch or $isLiveSearchContinuation">
          <do_if value="global.$GT_SearchLocks.{$shipForCleanup}?">
            <remove_value name="global.$GT_SearchLocks.{$shipForCleanup}"/>
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <set_value name="$lockReason" exact="if $isLiveSearchContinuation then 'live search continuation complete' else 'search complete'"/>
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $shipForCleanup.idcode + ') Search lock released (' + $lockReason + ')'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
        <do_else>
          <!-- Batch processing in progress FOR THIS SHIP - keep lock until live search completes -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $shipForCleanup.idcode + ') Search lock retained (waiting for live search batch to complete)'" chance="100"/>
          </do_if>
        </do_else>
        
        <!-- CRITICAL: Clean up AI parameters ONLY if NOT waiting for batch processing FOR THIS SHIP -->
        <!-- If waiting for batch, we'll need these parameters when processing live search results -->
        <!-- If we're continuing from live search, this IS the final completion, so clean up parameters -->
        <do_if value="not $isWaitingForThisShipBatch or $isLiveSearchContinuation">
          <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_AIParameters exists -->
          <do_if value="global.$GT_AIParameters.{$shipForCleanup}?">
            <remove_value name="global.$GT_AIParameters.{$shipForCleanup}"/>
          </do_if>
        </do_if>
        
        <!-- âœ… PERFORMANCE FIX: Mark search complete and process next ship in queue -->
        <!-- âœ… FIX: Use $shipForCleanup instead of $ship (available even if $shouldProceed was false) -->
        <set_value name="$shipForQueue" exact="$shipForCleanup"/>
        
        <do_if value="global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$shipForQueue}?">
          <remove_value name="global.$GT_SearchQueue.$Params.{$shipForQueue}"/>
        </do_if>
        
        <!-- Decrement active search counter -->
        <set_value name="global.$GT_SearchQueue.$ActiveSearches" operation="subtract"/>
        
        <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $shipForQueue.idcode + ') ðŸ” SEARCH COMPLETE (active: ' + global.$GT_SearchQueue.$ActiveSearches + '/' + global.$GT_SearchQueue.$MaxConcurrent + ', queued: ' + global.$GT_SearchQueue.$Ships.count + ')'" chance="100"/>
        </do_if>
        
        <!-- Continue processing search queue if there are ships waiting -->
        <do_if value="global.$GT_SearchQueue.$Ships.count gt 0">
          <signal_cue_instantly cue="md.GT_Trading_Queue.ProcessSearchQueue"/>
        </do_if>
      </actions>
    </cue>
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- SearchLiveTrades_Resume: Process batch processor results with ship-specific filtering -->
    <!-- This cue receives completed batch processing results and applies ship-specific filters -->
    <!-- (ware basket, illegal wares, blacklists, path availability) before returning results -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <cue name="SearchLiveTrades_Resume" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <!-- 1. Retrieve ship object from signal (used as table key) -->
        <set_value name="$ship" exact="event.param"/>
        
        <!-- 2. Retrieve results from batch processor using ship object as key -->
        <set_value name="$results" exact="@global.$GT_BatchResultsList.{$ship}"/>
        
          <!-- Validate results exist -->
          <do_if value="not $results?">
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <debug_text text="'[GT-Resume] âš ï¸ Batch results not found for ship ' + $ship.idcode" chance="100"/>
            </do_if>
            
            <!-- âœ… CRITICAL FIX: Preserve LastRejectionStats when updating global.$GT_SearchResult -->
            <set_value name="$preservedLastRejectionStats" exact="null"/>
            <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_SearchResult exists -->
          <do_if value="global.$GT_SearchResult.$LastRejectionStats?">
              <set_value name="$preservedLastRejectionStats" exact="global.$GT_SearchResult.$LastRejectionStats"/>
            </do_if>
            
            <set_value name="global.$GT_SearchResult" exact="table[
              $Found = false,
              $BestTrade = null,
              $BestScore = 0,
              $TradeList = []
            ]"/>
            
            <!-- âœ… CRITICAL FIX: Restore LastRejectionStats after updating global.$GT_SearchResult -->
            <do_if value="$preservedLastRejectionStats?">
              <set_value name="global.$GT_SearchResult.$LastRejectionStats" exact="$preservedLastRejectionStats"/>
            </do_if>
            
            <cancel_cue cue="this"/>
          </do_if>
        
        <!-- Extract results -->
        <set_value name="$ship" exact="$results.$ship"/>
        <set_value name="$tradeList" exact="$results.$tradeList"/>
        <set_value name="$crossStationBestTrade" exact="$results.$crossStationBestTrade"/>
        <set_value name="$crossStationBestScore" exact="$results.$crossStationBestScore"/>
        <set_value name="$nonConflictedBestTrade" exact="$results.$nonConflictedBestTrade"/>
        <set_value name="$nonConflictedBestScore" exact="$results.$nonConflictedBestScore"/>
        <!-- Extract rejection statistics from batch processor -->
        <set_value name="$tradesRejectedProfit" exact="0"/>
        <set_value name="$tradesRejectedDocking" exact="0"/>
        <set_value name="$tradesRejectedAmount" exact="0"/>
        <set_value name="$tradesRejectedDistance" exact="0"/>
        <do_if value="$results.$tradesRejectedProfit?">
          <set_value name="$tradesRejectedProfit" exact="$results.$tradesRejectedProfit"/>
        </do_if>
        <do_if value="$results.$tradesRejectedDocking?">
          <set_value name="$tradesRejectedDocking" exact="$results.$tradesRejectedDocking"/>
        </do_if>
        <do_if value="$results.$tradesRejectedAmount?">
          <set_value name="$tradesRejectedAmount" exact="$results.$tradesRejectedAmount"/>
        </do_if>
        <do_if value="$results.$tradesRejectedDistance?">
          <set_value name="$tradesRejectedDistance" exact="$results.$tradesRejectedDistance"/>
        </do_if>
        <set_value name="$bestRejectedTrade" exact="null"/>
        <do_if value="$results.$bestRejectedTrade?">
          <set_value name="$bestRejectedTrade" exact="$results.$bestRejectedTrade"/>
        </do_if>
        
        <!-- Get maxDistance and originalMaxDistance from batch data (still stored for reference) -->
        <set_value name="$maxDistance" exact="null"/>
        <set_value name="$originalMaxDistance" exact="null"/>
        <set_value name="$batchData" exact="@global.$GT_BatchDataList.{$ship}"/>
        <do_if value="$batchData?">
          <do_if value="$batchData.$maxDistance?">
            <set_value name="$maxDistance" exact="$batchData.$maxDistance"/>
          </do_if>
          <do_if value="$batchData.$originalMaxDistance?">
            <set_value name="$originalMaxDistance" exact="$batchData.$originalMaxDistance"/>
          </do_if>
        </do_if>
        
        <!-- âœ… FALLBACK SEARCH: Detect if this is a fallback search (MaxDistance == 2) -->
        <set_value name="$isFallbackSearch" exact="false"/>
        <do_if value="$maxDistance == 2">
          <set_value name="$isFallbackSearch" exact="true"/>
        </do_if>
        
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
          <debug_text text="'[GT-Resume] (' + $ship.idcode + ') Processing ' + $tradeList.count + ' trades from batch processor (maxDistance: ' + $maxDistance + ')'" chance="100"/>
        </do_if>
        
        <!-- 3. Apply ship-specific filtering -->
        <!-- 3a. Get ship settings -->
        <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
          <param name="ship" value="$ship"/>
        </run_actions>
        <set_value name="$allowIllegal" exact="@global.$GT_AIParameters.{$ship}.$AllowIllegal"/>
        <!-- âœ… CRITICAL: Get ware basket safely (using library function with null-checking pattern) -->
        <run_actions ref="md.GT_Utilities.GT_GetWareBasketSafe" result="$wareBasket">
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <!-- 3b. Filter tradeList -->
        <set_value name="$filteredTradeList" exact="[]"/>
        <!-- âœ… Track filtering statistics -->
        <set_value name="$filteredByWareBasket" exact="0"/>
        <set_value name="$filteredByIllegal" exact="0"/>
        <set_value name="$filteredByBlacklist" exact="0"/>
        <set_value name="$filteredByPathBlocked" exact="0"/>
        <set_value name="$tradesByWareStats" exact="table[]"/>
        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- âœ… OPTIMIZATION #4: Initialize gatedistance cache for blacklist-aware pathfinding -->
        <!-- Reduces pathfinding calls from 200 (for 100 trades) to ~20-40 unique sector pairs -->
        <!-- (80-90% reduction in expensive gatedistance calculations) -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <set_value name="$gatedistanceCache" exact="table[]"/>
        <set_value name="$currentSector" exact="$ship.sector"/>
        
        <!-- âœ… Track intra-sector trade statistics -->
        <set_value name="$intraSectorTradesTotal" exact="0"/>
        <set_value name="$intraSectorTradesFiltered" exact="0"/>
        <set_value name="$intraSectorTradesValid" exact="0"/>
        
        <!-- âœ… OPTIMIZATION #11: Parallel Filtering with Cooperative Multitasking -->
        <!-- Process trades in batches to prevent blocking the game engine -->
        <!-- This prevents frame stutter when filtering large trade lists (100+ trades) -->
        <!-- Store filtering state in global table (persists across cue instances) -->
        
        <!-- âœ… FIX: Defensive check for race condition (initialization might not have completed yet) -->
        <do_if value="not global.$GT_FilterState?">
          <set_value name="global.$GT_FilterState" exact="table[]"/>
        </do_if>
        
        <!-- Initialize filter state for this ship -->
        <!-- Include batch processor results variables (from SearchLiveTrades_Resume) -->
        <set_value name="$filterState" exact="table[
          $ship = $ship,
          $tradeList = $tradeList,
          $wareBasket = $wareBasket,
          $allowIllegal = $allowIllegal,
          $blacklistgroup = $blacklistgroup,
          $currentSector = $currentSector,
          $gatedistanceCache = $gatedistanceCache,
          $filteredTradeList = $filteredTradeList,
          $filteredByWareBasket = $filteredByWareBasket,
          $filteredByIllegal = $filteredByIllegal,
          $filteredByBlacklist = $filteredByBlacklist,
          $filteredByPathBlocked = $filteredByPathBlocked,
          $tradesByWareStats = $tradesByWareStats,
          $intraSectorTradesTotal = $intraSectorTradesTotal,
          $intraSectorTradesFiltered = $intraSectorTradesFiltered,
          $intraSectorTradesValid = $intraSectorTradesValid,
          $filterIndex = 0,
          $filterBatchSize = 15,
          $maxDistance = $maxDistance,
          $crossStationBestTrade = $crossStationBestTrade,
          $crossStationBestScore = $crossStationBestScore,
          $nonConflictedBestTrade = $nonConflictedBestTrade,
          $nonConflictedBestScore = $nonConflictedBestScore,
          $tradesRejectedProfit = $tradesRejectedProfit,
          $tradesRejectedDocking = $tradesRejectedDocking,
          $tradesRejectedAmount = $tradesRejectedAmount,
          $tradesRejectedDistance = $tradesRejectedDistance,
          $bestRejectedTrade = $bestRejectedTrade
        ]"/>
        <set_value name="global.$GT_FilterState.{$ship}" exact="$filterState"/>
        
        <!-- Signal batch filtering cue to start processing -->
        <signal_cue_instantly cue="md.GT_Trading_Search.FilterTradeList_Batch" param="$ship"/>
        
        <!-- Wait for batch filtering to complete (resume cue will signal back) -->
        <!-- Note: We'll resume in FilterTradeList_Resume cue -->
        <!-- Cancel this cue - resume cue will continue processing -->
        <cancel_cue cue="this"/>
      </actions>
    </cue>
    
    <!-- âœ… OPTIMIZATION #11: Batch Trade Filtering with Cooperative Multitasking -->
    <cue name="FilterTradeList_Batch" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <!-- Calculate delay from global Performance settings -->
        <set_value name="$batchDelay" exact="50"/>
        <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$BatchProcessingDelay?">
          <set_value name="$batchDelay" exact="@global.$GT_GlobalSettings.$Performance.$BatchProcessingDelay"/>
        </do_if>
        <!-- Convert to time value (milliseconds) -->
        <set_value name="this.$batchDelayTime" exact="$batchDelay * 1ms"/>
      </actions>
      <delay exact="this.$batchDelayTime"/>
      <actions>
        <set_value name="$ship" exact="event.param"/>
        
        <!-- âœ… FIX: Defensive check for race condition (initialization might not have completed yet) -->
        <do_if value="not global.$GT_FilterState?">
          <set_value name="global.$GT_FilterState" exact="table[]"/>
        </do_if>
        
        <!-- Retrieve state from global table -->
        <set_value name="$filterState" exact="@global.$GT_FilterState.{$ship}"/>
        <!-- âœ… FIX: Proper null check - extract property first, then check if result exists and is valid -->
        <set_value name="$filterStateValid" exact="false"/>
        <do_if value="$filterState?">
          <set_value name="$filterStateKeysCount" exact="@$filterState.keys.count"/>
          <do_if value="$filterStateKeysCount? and $filterStateKeysCount ge 0">
            <set_value name="$filterStateValid" exact="true"/>
          </do_if>
        </do_if>
        <do_if value="not $filterStateValid">
          <cancel_cue cue="this"/>
        </do_if>
        
        <!-- Extract state variables -->
        <set_value name="$tradeList" exact="@$filterState.$tradeList"/>
        <set_value name="$wareBasket" exact="@$filterState.$wareBasket"/>
        <set_value name="$allowIllegal" exact="@$filterState.$allowIllegal"/>
        <set_value name="$blacklistgroup" exact="@$filterState.$blacklistgroup"/>
        <set_value name="$currentSector" exact="@$filterState.$currentSector"/>
        <set_value name="$gatedistanceCache" exact="@$filterState.$gatedistanceCache"/>
        <set_value name="$filterIndex" exact="@$filterState.$filterIndex"/>
        <set_value name="$filterBatchSize" exact="@$filterState.$filterBatchSize"/>
        
        <!-- Get mutable lists/stats from state (or initialize if first batch) -->
        <set_value name="$filteredTradeList" exact="@$filterState.$filteredTradeList"/>
        <do_if value="not $filteredTradeList?">
          <set_value name="$filteredTradeList" exact="[]"/>
        </do_if>
        <set_value name="$filteredByWareBasket" exact="@$filterState.$filteredByWareBasket"/>
        <set_value name="$filteredByIllegal" exact="@$filterState.$filteredByIllegal"/>
        <set_value name="$filteredByBlacklist" exact="@$filterState.$filteredByBlacklist"/>
        <set_value name="$filteredByPathBlocked" exact="@$filterState.$filteredByPathBlocked"/>
        <set_value name="$tradesByWareStats" exact="@$filterState.$tradesByWareStats"/>
        <do_if value="not $tradesByWareStats?">
          <set_value name="$tradesByWareStats" exact="table[]"/>
        </do_if>
        <set_value name="$intraSectorTradesTotal" exact="@$filterState.$intraSectorTradesTotal"/>
        <set_value name="$intraSectorTradesFiltered" exact="@$filterState.$intraSectorTradesFiltered"/>
        <set_value name="$intraSectorTradesValid" exact="@$filterState.$intraSectorTradesValid"/>
        
        <!-- Process one batch of trades -->
        <set_value name="$filterTotalTrades" exact="$tradeList.count"/>
        <set_value name="$batchEnd" exact="[$filterIndex + $filterBatchSize, $filterTotalTrades].min"/>
        <do_all exact="$batchEnd - $filterIndex" counter="$batchOffset">
          <set_value name="$i" exact="$filterIndex + $batchOffset"/>
          <set_value name="$trade" exact="$tradeList.{$i}"/>
          <set_value name="$ware" exact="$trade.$BuyOffer.ware"/>
          
          <!-- Initialize ware stats if needed -->
          <do_if value="not $tradesByWareStats.{$ware}?">
            <set_value name="$tradesByWareStats.{$ware}" exact="table[$total=0, $filteredByWareBasket=0, $filteredByIllegal=0, $filteredByBlacklist=0, $filteredByPathBlocked=0, $valid=0]"/>
          </do_if>
          <set_value name="$wareStats" exact="$tradesByWareStats.{$ware}"/>
          <set_value name="$wareStats.$total" exact="$wareStats.$total + 1"/>
          
          <!-- Extract sectors early for intra-sector trade detection -->
          <set_value name="$buySector" exact="@$trade.$BuyStation.sector"/>
          <set_value name="$sellSector" exact="@$trade.$SellStation.sector"/>
          
          <!-- Track if this is a TRUE intra-sector trade -->
          <run_actions ref="md.GT_Trade_Utilities.GT_IsIntraSectorTrade" result="$isIntraSectorTrade">
            <param name="buySector" value="$buySector"/>
            <param name="sellSector" value="$sellSector"/>
            <param name="currentSector" value="$currentSector"/>
          </run_actions>
          <do_if value="$isIntraSectorTrade">
            <set_value name="$intraSectorTradesTotal" exact="$intraSectorTradesTotal + 1"/>
          </do_if>
          
          <!-- Filter trade for ship -->
          <run_actions ref="md.GT_Trade_Utilities.GT_FilterTradeForShip" result="$filterResult">
            <param name="trade" value="$trade"/>
            <param name="ship" value="$ship"/>
            <param name="ware" value="$ware"/>
            <param name="wareBasket" value="$wareBasket"/>
            <param name="allowIllegal" value="$allowIllegal"/>
            <param name="blacklistgroup" value="$blacklistgroup"/>
            <param name="currentSector" value="$currentSector"/>
            <param name="buySector" value="$buySector"/>
            <param name="sellSector" value="$sellSector"/>
            <param name="filterStats" value="$wareStats"/>
            <param name="isIntraSectorTrade" value="$isIntraSectorTrade"/>
          </run_actions>
          
          <!-- Update filter statistics -->
          <set_value name="$isAllowed" exact="$filterResult.$IsAllowed"/>
          <set_value name="$filterReason" exact="$filterResult.$FilterReason"/>
          <do_if value="not $isAllowed">
            <do_if value="$filterReason == 'ware_basket'">
              <set_value name="$filteredByWareBasket" exact="$filteredByWareBasket + 1"/>
            </do_if>
            <do_elseif value="$filterReason == 'illegal'">
              <set_value name="$filteredByIllegal" exact="$filteredByIllegal + 1"/>
            </do_elseif>
            <do_elseif value="$filterReason == 'blacklist_intra' or $filterReason == 'blacklist_buy_station' or $filterReason == 'blacklist_sell_station' or $filterReason == 'blacklist_buy_sector' or $filterReason == 'blacklist_sell_sector'">
              <set_value name="$filteredByBlacklist" exact="$filteredByBlacklist + 1"/>
            </do_elseif>
            <do_elseif value="$filterReason == 'path_blocked'">
              <set_value name="$filteredByPathBlocked" exact="$filteredByPathBlocked + 1"/>
            </do_elseif>
            <do_if value="$isIntraSectorTrade">
              <set_value name="$intraSectorTradesFiltered" exact="$intraSectorTradesFiltered + 1"/>
            </do_if>
          </do_if>
          
          <!-- Add to filtered list if valid -->
          <do_if value="$isAllowed">
            <append_to_list name="$filteredTradeList" exact="$trade"/>
            <set_value name="$wareStats.$valid" exact="$wareStats.$valid + 1"/>
            <do_if value="$isIntraSectorTrade">
              <set_value name="$intraSectorTradesValid" exact="$intraSectorTradesValid + 1"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="$isIntraSectorTrade">
              <set_value name="$intraSectorTradesFiltered" exact="$intraSectorTradesFiltered + 1"/>
            </do_if>
          </do_else>
          
          <!-- Update ware stats -->
          <set_value name="$tradesByWareStats.{$ware}" exact="$wareStats"/>
        </do_all>
        
        <!-- Update state for next batch or completion -->
        <set_value name="$filterIndex" exact="$batchEnd"/>
        <set_value name="$filterState.$filterIndex" exact="$filterIndex"/>
        <set_value name="$filterState.$filteredTradeList" exact="$filteredTradeList"/>
        <set_value name="$filterState.$filteredByWareBasket" exact="$filteredByWareBasket"/>
        <set_value name="$filterState.$filteredByIllegal" exact="$filteredByIllegal"/>
        <set_value name="$filterState.$filteredByBlacklist" exact="$filteredByBlacklist"/>
        <set_value name="$filterState.$filteredByPathBlocked" exact="$filteredByPathBlocked"/>
        <set_value name="$filterState.$tradesByWareStats" exact="$tradesByWareStats"/>
        <set_value name="$filterState.$intraSectorTradesTotal" exact="$intraSectorTradesTotal"/>
        <set_value name="$filterState.$intraSectorTradesFiltered" exact="$intraSectorTradesFiltered"/>
        <set_value name="$filterState.$intraSectorTradesValid" exact="$intraSectorTradesValid"/>
        <set_value name="global.$GT_FilterState.{$ship}" exact="$filterState"/>
        
        <!-- Check if more batches needed -->
        <do_if value="$filterIndex lt $filterTotalTrades">
          <!-- Signal next batch -->
          <signal_cue_instantly cue="md.GT_Trading_Search.FilterTradeList_Batch" param="$ship"/>
        </do_if>
        <do_else>
          <!-- All batches complete - signal resume cue to continue processing -->
          <signal_cue_instantly cue="md.GT_Trading_Search.FilterTradeList_Resume" param="$ship"/>
        </do_else>
      </actions>
    </cue>
    
    <!-- Resume cue: Continue processing after batch filtering completes -->
    <cue name="FilterTradeList_Resume" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.param"/>
        
        <!-- âœ… FIX: Defensive check for race condition (initialization might not have completed yet) -->
        <do_if value="not global.$GT_FilterState?">
          <set_value name="global.$GT_FilterState" exact="table[]"/>
        </do_if>
        
        <!-- Retrieve filtered results from global state -->
        <set_value name="$filterState" exact="@global.$GT_FilterState.{$ship}"/>
        <!-- âœ… FIX: Proper null check - extract property first, then check if result exists and is valid -->
        <set_value name="$filterStateValid" exact="false"/>
        <do_if value="$filterState?">
          <set_value name="$filterStateKeysCount" exact="@$filterState.keys.count"/>
          <do_if value="$filterStateKeysCount? and $filterStateKeysCount ge 0">
            <set_value name="$filterStateValid" exact="true"/>
          </do_if>
        </do_if>
        <do_if value="not $filterStateValid">
          <cancel_cue cue="this"/>
        </do_if>
        
        <!-- Extract all filtered results and statistics -->
        <set_value name="$filteredTradeList" exact="@$filterState.$filteredTradeList"/>
        <set_value name="$filteredByWareBasket" exact="@$filterState.$filteredByWareBasket"/>
        <set_value name="$filteredByIllegal" exact="@$filterState.$filteredByIllegal"/>
        <set_value name="$filteredByBlacklist" exact="@$filterState.$filteredByBlacklist"/>
        <set_value name="$filteredByPathBlocked" exact="@$filterState.$filteredByPathBlocked"/>
        <set_value name="$tradesByWareStats" exact="@$filterState.$tradesByWareStats"/>
        <set_value name="$intraSectorTradesTotal" exact="@$filterState.$intraSectorTradesTotal"/>
        <set_value name="$intraSectorTradesFiltered" exact="@$filterState.$intraSectorTradesFiltered"/>
        <set_value name="$intraSectorTradesValid" exact="@$filterState.$intraSectorTradesValid"/>
        <set_value name="$tradeList" exact="@$filterState.$tradeList"/>
        <set_value name="$maxDistance" exact="@$filterState.$maxDistance"/>
        
        <!-- âœ… FALLBACK SEARCH: Get originalMaxDistance from batch data (if available) -->
        <set_value name="$originalMaxDistance" exact="$maxDistance"/>  <!-- Default: same as maxDistance -->
        <set_value name="$batchData" exact="@global.$GT_BatchDataList.{$ship}"/>
        <do_if value="$batchData? and $batchData.$originalMaxDistance?">
          <set_value name="$originalMaxDistance" exact="$batchData.$originalMaxDistance"/>
        </do_if>
        
        <!-- âœ… FALLBACK SEARCH: Detect if this is a fallback search (MaxDistance == 2) -->
        <set_value name="$isFallbackSearch" exact="false"/>
        <do_if value="$maxDistance == 2">
          <set_value name="$isFallbackSearch" exact="true"/>
        </do_if>
        
        <!-- Extract batch processor result variables -->
        <set_value name="$crossStationBestTrade" exact="@$filterState.$crossStationBestTrade"/>
        <set_value name="$crossStationBestScore" exact="@$filterState.$crossStationBestScore"/>
        <set_value name="$nonConflictedBestTrade" exact="@$filterState.$nonConflictedBestTrade"/>
        <set_value name="$nonConflictedBestScore" exact="@$filterState.$nonConflictedBestScore"/>
        <set_value name="$tradesRejectedProfit" exact="@$filterState.$tradesRejectedProfit"/>
        <set_value name="$tradesRejectedDocking" exact="@$filterState.$tradesRejectedDocking"/>
        <set_value name="$tradesRejectedAmount" exact="@$filterState.$tradesRejectedAmount"/>
        <set_value name="$tradesRejectedDistance" exact="@$filterState.$tradesRejectedDistance"/>
        <set_value name="$bestRejectedTrade" exact="@$filterState.$bestRejectedTrade"/>
        
        <!-- Initialize to safe defaults if not set -->
        <do_if value="not $tradesRejectedProfit?">
          <set_value name="$tradesRejectedProfit" exact="0"/>
        </do_if>
        <do_if value="not $tradesRejectedDocking?">
          <set_value name="$tradesRejectedDocking" exact="0"/>
        </do_if>
        <do_if value="not $tradesRejectedAmount?">
          <set_value name="$tradesRejectedAmount" exact="0"/>
        </do_if>
        <do_if value="not $tradesRejectedDistance?">
          <set_value name="$tradesRejectedDistance" exact="0"/>
        </do_if>
        <do_if value="not $crossStationBestScore?">
          <set_value name="$crossStationBestScore" exact="0"/>
        </do_if>
        <do_if value="not $nonConflictedBestScore?">
          <set_value name="$nonConflictedBestScore" exact="0"/>
        </do_if>
        
        <!-- Clean up filter state -->
        <remove_value name="global.$GT_FilterState.{$ship}"/>
        
        <!-- DEBUG: Log filtering statistics -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <set_value name="$filteringStats" exact="'[GT-Resume] (' + $ship.idcode + ') Filtering statistics:' +
            '\n  Total trades: ' + $tradeList.count +
            '\n  ðŸ  TRUE intra-sector trades: ' + $intraSectorTradesTotal + ' (filtered: ' + $intraSectorTradesFiltered + ', valid: ' + $intraSectorTradesValid + ')' +
            '\n  Filtered by ware basket: ' + $filteredByWareBasket +
            '\n  Filtered by illegal: ' + $filteredByIllegal +
            '\n  Filtered by blacklist: ' + $filteredByBlacklist +
            '\n  Filtered by path blocked: ' + $filteredByPathBlocked +
            '\n  Valid trades: ' + $filteredTradeList.count"/>
          <debug_text text="$filteringStats" chance="100"/>
          
          <!-- Log per-ware statistics -->
          <do_if value="$tradesByWareStats.keys.count gt 0">
            <set_value name="$wareStatsLog" exact="'[GT-Resume] (' + $ship.idcode + ') Per-ware filtering:'"/>
            <do_all exact="$tradesByWareStats.keys.count" counter="$wareIdx">
              <set_value name="$ware" exact="$tradesByWareStats.keys.{$wareIdx}"/>
              <set_value name="$stats" exact="$tradesByWareStats.{$ware}"/>
              <set_value name="$wareStatsLog" exact="$wareStatsLog + 
                '\n  - ' + @$ware.name + ': ' + $stats.$total + ' checked, ' +
                $stats.$filteredByWareBasket + ' basket, ' +
                $stats.$filteredByIllegal + ' illegal, ' +
                $stats.$filteredByBlacklist + ' blacklist, ' +
                $stats.$filteredByPathBlocked + ' path, ' +
                $stats.$valid + ' valid'"/>
            </do_all>
            <debug_text text="$wareStatsLog" chance="100"/>
          </do_if>
        </do_if>
        
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
          <debug_text text="'[GT-Resume] (' + $ship.idcode + ') After ship-specific filtering: ' + $filteredTradeList.count + ' trades (from ' + $tradeList.count + ')'" chance="100"/>
        </do_if>
        
        <!-- 4. Build diverse list: Top 5 per ware (minimum-maximum) with early exit -->
        <!-- DEBUG: Log trades before diverse list building -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
          <debug_text text="'[GT-Resume] (' + $ship.idcode + ') Building diverse list from ' + $filteredTradeList.count + ' filtered trades'" chance="100"/>
        </do_if>
        
        <set_value name="$tradesByWare" exact="table[]"/>
        <do_all exact="$filteredTradeList.count" counter="$i">
          <set_value name="$trade" exact="$filteredTradeList.{$i}"/>
          <set_value name="$ware" exact="$trade.$BuyOffer.ware"/>
          <do_if value="not $tradesByWare.{$ware}?">
            <set_value name="$tradesByWare.{$ware}" exact="[]"/>
          </do_if>
          <append_to_list name="$tradesByWare.{$ware}" exact="$trade"/>
        </do_all>
        
        <!-- DEBUG: Log wares found -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
          <set_value name="$wareDebug" exact="'[GT-Resume] (' + $ship.idcode + ') Found ' + $tradesByWare.keys.count + ' wares with trades:'"/>
          <do_all exact="$tradesByWare.keys.count" counter="$wareIdx">
            <set_value name="$ware" exact="$tradesByWare.keys.{$wareIdx}"/>
            <set_value name="$wareCount" exact="$tradesByWare.{$ware}.count"/>
            <set_value name="$wareDebug" exact="$wareDebug + '\n  - ' + @$ware.name + ': ' + $wareCount + ' trades'"/>
          </do_all>
          <debug_text text="$wareDebug" chance="100"/>
        </do_if>
        
        <!-- âœ… FIX: Determine home sector FIRST (same logic as SearchLiveTrades) -->
        <!-- âœ… CRITICAL: Subordinates ALWAYS use commander's home sector (not a fallback!) -->
        <!-- Ships must only trade with stations within maxDistance from HOME SECTOR, not ship position -->
        <set_value name="$homeBase" exact="null"/>
        <do_if value="$ship.commander? and $ship.commander.exists and $ship.commander != $ship">
          <!-- Ship is a subordinate - ALWAYS use commander's home sector -->
          <do_if value="$ship.commander.defaultorder?">
            <set_value name="$commanderHome" exact="@$ship.commander.defaultorder.$home"/>
            <do_if value="$commanderHome? and $commanderHome.exists">
              <set_value name="$homeBase" exact="$commanderHome"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- âœ… For non-subordinates: Always use defaultorder.$home as PRIMARY source (fixed value in order) -->
        <!-- Home sector is a fixed value in the order settings and should NEVER drift -->
        <do_if value="not $homeBase? or not $homeBase.exists">
          <set_value name="$homeBase" exact="@$ship.defaultorder.$home"/>
        </do_if>
        
        <!-- Fallback: Only if defaultorder.$home is not available, check GT_AIParameters -->
        <do_if value="not $homeBase? or not $homeBase.exists">
          <do_if value="global.$GT_AIParameters? and global.$GT_AIParameters.{$ship}? and global.$GT_AIParameters.{$ship}.$HomeBase?">
            <set_value name="$homeBase" exact="global.$GT_AIParameters.{$ship}.$HomeBase"/>
          </do_if>
          <do_else>
            <!-- âŒ REMOVED: Never fall back to $ship.sector (causes cascading drift) -->
            <debug_text text="'[GT-ERROR] Home sector not found for ' + $ship.idcode + ' - defaultorder.$home is null! This should never happen.'" chance="100"/>
            <!-- Emergency fallback only - this should never happen -->
            <set_value name="$homeBase" exact="$ship.sector"/>
          </do_else>
        </do_if>
        
        <!-- Extract sector -->
        <set_value name="$homeSector" exact="null"/>
        <do_if value="$homeBase? and $homeBase.exists">
          <do_if value="$homeBase.isclass.station">
            <set_value name="$homeSector" exact="$homeBase.sector"/>
          </do_if>
          <do_elseif value="$homeBase.isclass.sector">
            <set_value name="$homeSector" exact="$homeBase"/>
          </do_elseif>
        </do_if>
        
        <!-- Validate -->
        <do_if value="not $homeSector? or not $homeSector.exists">
          <debug_text text="'[GT-ERROR] Failed to extract home sector from homeBase for ' + $ship.idcode + ' - using ship.sector as emergency fallback (THIS WILL CAUSE DRIFT!)'" chance="100"/>
          <!-- Emergency fallback only - this should never happen -->
          <set_value name="$homeSector" exact="$ship.sector"/>
        </do_if>
        
        <!-- âœ… FALLBACK SEARCH: Log start of fallback search processing -->
        <do_if value="$isFallbackSearch? and $isFallbackSearch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <set_value name="$currentSectorName" exact="if $ship.sector? then @$ship.sector.knownname else 'Unknown'"/>
          <set_value name="$homeSectorName" exact="if $homeSector? then @$homeSector.knownname else 'Unknown'"/>
          <set_value name="$filterMaxDistance" exact="$maxDistance"/>
          <do_if value="$originalMaxDistance?">
            <set_value name="$filterMaxDistance" exact="$originalMaxDistance"/>
          </do_if>
          <debug_text text="'[GT-Fallback] (' + $ship.idcode + ') ðŸ” Fallback search processing started | Current sector: ' + $currentSectorName + ' | Home sector: ' + $homeSectorName + ' | Max distance from current: 2 | Max distance from home: ' + $filterMaxDistance + ' | Trades to evaluate: ' + $filteredTradeList.count" chance="100"/>
        </do_if>
        
        <!-- âœ… EARLY EXIT: Sort trades by distance from HOME SECTOR (shortest first) per ware, break when exceeding maxDistance -->
        <!-- This matches the requirement: stations must not be farther from home sector than maxDistance -->
        <set_value name="$diverseList" exact="[]"/>
        <do_all exact="$tradesByWare.keys.count" counter="$wareIdx">
          <set_value name="$ware" exact="$tradesByWare.keys.{$wareIdx}"/>
          <set_value name="$wareTrades" exact="$tradesByWare.{$ware}"/>
          
          <!-- âœ… FALLBACK SEARCH: Log start of evaluation for this ware -->
          <do_if value="$isFallbackSearch? and $isFallbackSearch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$wareName" exact="if $ware? then @$ware.name else 'Unknown'"/>
            <set_value name="$currentSectorName" exact="if $ship.sector? then @$ship.sector.knownname else 'Unknown'"/>
            <set_value name="$homeSectorName" exact="if $homeSector? then @$homeSector.knownname else 'Unknown'"/>
            <set_value name="$filterMaxDistance" exact="$maxDistance"/>
            <do_if value="$originalMaxDistance?">
              <set_value name="$filterMaxDistance" exact="$originalMaxDistance"/>
            </do_if>
            <debug_text text="'[GT-Fallback] (' + $ship.idcode + ') ðŸ” Evaluating ' + $wareTrades.count + ' trades for ' + $wareName + ' | Current sector: ' + $currentSectorName + ' | Home sector: ' + $homeSectorName + ' | Max distance from current: 2 | Max distance from home: ' + $filterMaxDistance" chance="100"/>
          </do_if>
          
          <!-- âœ… STEP 1: For fallback search, filter by HOME SECTOR distance first, then use current distance for sorting -->
          <!-- âœ… FIX: Distance penalties should only affect SCORING, not FILTERING -->
          <!-- Use library function for fallback trade distance calculation -->
          <set_value name="$currentSector" exact="$ship.sector"/>
          <set_value name="$filterMaxDistance" exact="$maxDistance"/>  <!-- Default: use maxDistance -->
          <do_if value="$isFallbackSearch? and $isFallbackSearch and $originalMaxDistance?">
            <set_value name="$filterMaxDistance" exact="$originalMaxDistance"/>  <!-- Fallback: use original pilot maxDistance -->
          </do_if>
          
          <!-- Use library function to calculate distances and filter trades -->
          <run_actions ref="md.GT_Trade_Utilities.GT_CalculateFallbackTradeDistances" result="$distanceResult">
            <param name="wareTrades" value="$wareTrades"/>
            <param name="ship" value="$ship"/>
            <param name="homeSector" value="$homeSector"/>
            <param name="currentSector" value="$currentSector"/>
            <param name="maxDistance" value="$maxDistance"/>
            <param name="originalMaxDistance" value="$originalMaxDistance"/>
            <param name="isFallbackSearch" value="$isFallbackSearch"/>
          </run_actions>
          <set_value name="$tradesWithDistance" exact="$distanceResult.$TradesWithDistance"/>
          <set_value name="$rejectedByUnreachable" exact="$distanceResult.$RejectedByUnreachable"/>
          <set_value name="$rejectedByHomeDistance" exact="$distanceResult.$RejectedByHomeDistance"/>
          <set_value name="$evaluatedCount" exact="$distanceResult.$EvaluatedCount"/>
          
          <!-- âœ… FALLBACK SEARCH: Log summary statistics -->
          <!-- NOTE: "Evaluated" counts trades that passed the home distance filter (within maxDistance from home) -->
          <!-- Distance from current position is used only for sorting/prioritization, not filtering -->
          <do_if value="$isFallbackSearch? and $isFallbackSearch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$wareName" exact="if $ware? then @$ware.name else 'Unknown'"/>
            <set_value name="$totalTrades" exact="$wareTrades.count"/>
            <set_value name="$skippedByDistance" exact="$rejectedByUnreachable + $rejectedByHomeDistance"/>
            <set_value name="$summaryLog" exact="'[GT-Fallback] (' + $ship.idcode + ') ðŸ“Š Ware: ' + $wareName + ' | Total trades: ' + $totalTrades + ' | Evaluated (within home distance): ' + $evaluatedCount + ' | Accepted: ' + $tradesWithDistance.count + ' | Rejected: ' + ($evaluatedCount - $tradesWithDistance.count) + ' | Skipped (unreachable/home dist): ' + $skippedByDistance + ' (unreachable: ' + $rejectedByUnreachable + ', home dist: ' + $rejectedByHomeDistance + ')'"/>
            <debug_text text="$summaryLog" chance="100"/>
          </do_if>
          
          <!-- âœ… STEP 2: Sort by distance (shortest first) -->
          <!-- Use library function for distance-based sorting -->
          <run_actions ref="md.GT_Trade_Utilities.GT_SortTradesByDistance" result="$sortedTrades">
            <param name="tradesWithDistance" value="$tradesWithDistance"/>
          </run_actions>
          
          <!-- âœ… STEP 3: Select top 5 by Score, with early exit when distance exceeds limit -->
          <!-- âœ… FIX: For fallback search, distance from current position is used ONLY for sorting, not filtering -->
          <!-- All trades have already passed the home distance filter, so we don't need an early exit based on current distance -->
          <!-- For normal search: early exit when distance from home > maxDistance -->
          <!-- Use library function for best trade selection with diversity -->
          <run_actions ref="md.GT_Trade_Utilities.GT_SelectBestTradesWithDiversity" result="$bestTradesResult">
            <param name="sortedTrades" value="$sortedTrades"/>
            <param name="maxDistance" value="$maxDistance"/>
            <param name="filterMaxDistance" value="$filterMaxDistance"/>
            <param name="isFallbackSearch" value="$isFallbackSearch"/>
            <param name="ware" value="$ware"/>
            <param name="ship" value="$ship"/>
          </run_actions>
          <set_value name="$top3" exact="$bestTradesResult.$TopTrades"/>
          <set_value name="$skippedDueToDistance" exact="$bestTradesResult.$SkippedDueToDistance"/>
          
          <!-- Add up to 5 trades per ware (if less than 5, still include what we have) -->
          <do_if value="$top3.count gt 0">
            <do_all exact="$top3.count" counter="$i">
              <append_to_list name="$diverseList" exact="$top3.{$i}"/>
            </do_all>
          </do_if>
        </do_all>
        
        <!-- âœ… FALLBACK SEARCH: Log if no trades were found to evaluate -->
        <do_if value="$isFallbackSearch? and $isFallbackSearch and $tradesByWare.keys.count == 0 and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <set_value name="$currentSectorName" exact="if $ship.sector? then @$ship.sector.knownname else 'Unknown'"/>
          <set_value name="$homeSectorName" exact="if $homeSector? then @$homeSector.knownname else 'Unknown'"/>
          <debug_text text="'[GT-Fallback] (' + $ship.idcode + ') âš ï¸ No trades found to evaluate | Current sector: ' + $currentSectorName + ' | Home sector: ' + $homeSectorName + ' | Filtered trade list count: ' + $filteredTradeList.count" chance="100"/>
        </do_if>
        
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
          <debug_text text="'[GT-Resume] (' + $ship.idcode + ') Diverse list: ' + $diverseList.count + ' trades (top 5 per ware)'" chance="100"/>
        </do_if>
        
        <!-- âœ… SORT DIVERSE LIST BY SCORE (highest first) before storing for AI validation -->
        <!-- This ensures AI validates the best trades first -->
        <!-- Use library function for sorting -->
        <run_actions ref="md.GT_Trade_Utilities.GT_SortTradesByScore" result="$diverseList">
          <param name="tradeList" value="$diverseList"/>
        </run_actions>
        
        <!-- 5. Cache maintenance: Delete old entries (if cache was refreshed) -->
        <!-- TODO: Track if new trades were added to cache during this search -->
        <!-- For now, assume cache was refreshed if batch processor ran -->
        <set_value name="$cacheRefreshed" exact="true"/>
        <!-- âœ… PERFORMANCE OPTIMIZATION v5: Cleanup per-home-sector cache -->
        <!-- Iterate through all home sectors in cache -->
        <do_if value="$cacheRefreshed">
          <set_value name="$cacheMaxAge" exact="15min"/>
          <set_value name="$deletedCount" exact="0"/>
          <do_if value="global.$GT_TradeCache?">
            <do_all exact="global.$GT_TradeCache.keys.count" counter="$sectorIdx">
              <set_value name="$cacheHomeSector" exact="global.$GT_TradeCache.keys.{$sectorIdx}"/>
              <set_value name="$sectorCache" exact="global.$GT_TradeCache.{$cacheHomeSector}"/>
              <do_if value="$sectorCache? and $sectorCache.count gt 0">
                <!-- Iterate backwards through this home sector's cache -->
                <set_value name="$sectorCacheCount" exact="$sectorCache.count"/>
                <do_all exact="$sectorCacheCount" counter="$i" reverse="true">
                  <set_value name="$entry" exact="$sectorCache.{$i}"/>
                  <do_if value="$entry? and $entry.$Timestamp?">
                    <set_value name="$entryAge" exact="player.age - $entry.$Timestamp"/>
                    <do_if value="$entryAge gt $cacheMaxAge">
                      <remove_value name="global.$GT_TradeCache.{$cacheHomeSector}.{$i}"/>
                      <set_value name="$deletedCount" operation="add"/>
                    </do_if>
                  </do_if>
                </do_all>
              </do_if>
            </do_all>
          </do_if>
          <do_if value="$deletedCount gt 0 and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Resume] (' + $ship.idcode + ') Cache cleanup: Deleted ' + $deletedCount + ' entries older than 15 minutes'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- 6. Select best trade (for backward compatibility) -->
        <!-- âœ… CRITICAL FIX: Re-validate distance from home sector AND verify trade exists in final diverseList -->
        <!-- Prevents using stale trades that were filtered out by blacklist/path checks -->
        <set_value name="$bestTrade" exact="null"/>
        <set_value name="$bestScore" exact="0"/>
        
        <!-- Validate nonConflictedBestTrade: Both stations must be within maxDistance from home sector AND exist in diverseList -->
        <set_value name="$validatedNonConflictedTrade" exact="null"/>
        <do_if value="$nonConflictedBestTrade? and $nonConflictedBestScore gt 0">
          <set_value name="$tradeBuySector" exact="@$nonConflictedBestTrade.$BuyStation.sector"/>
          <set_value name="$tradeSellSector" exact="@$nonConflictedBestTrade.$SellStation.sector"/>
          <set_value name="$tradeBuyDistance" exact="-1"/>
          <set_value name="$tradeSellDistance" exact="-1"/>
          
          <do_if value="$tradeBuySector == $homeSector">
            <set_value name="$tradeBuyDistance" exact="0"/>
          </do_if>
          <do_else>
            <set_value name="$tradeBuyDistance" exact="$homeSector.gatedistance.{$tradeBuySector}"/>
          </do_else>
          
          <do_if value="$tradeSellSector == $homeSector">
            <set_value name="$tradeSellDistance" exact="0"/>
          </do_if>
          <do_else>
            <set_value name="$tradeSellDistance" exact="$homeSector.gatedistance.{$tradeSellSector}"/>
          </do_else>
          
          <!-- âœ… CRITICAL: Check if trade exists in final diverseList (wasn't filtered out) -->
          <set_value name="$tradeExistsInDiverseList" exact="false"/>
          <do_if value="$tradeBuyDistance ge 0 and $tradeSellDistance ge 0 and $tradeBuyDistance le $maxDistance and $tradeSellDistance le $maxDistance">
            <!-- Verify trade wasn't filtered out - check if it exists in diverseList by comparing stations and ware -->
            <do_all exact="$diverseList.count" counter="$i">
              <set_value name="$diverseTrade" exact="$diverseList.{$i}"/>
              <do_if value="$diverseTrade.$BuyStation == $nonConflictedBestTrade.$BuyStation and 
                             $diverseTrade.$SellStation == $nonConflictedBestTrade.$SellStation and
                             $diverseTrade.$BuyOffer.ware == $nonConflictedBestTrade.$BuyOffer.ware">
                <set_value name="$tradeExistsInDiverseList" exact="true"/>
                <break/>
              </do_if>
            </do_all>
            
            <!-- Only use if both distance valid AND trade exists in final filtered list -->
            <do_if value="$tradeExistsInDiverseList">
              <set_value name="$validatedNonConflictedTrade" exact="$nonConflictedBestTrade"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Validate crossStationBestTrade: Both stations must be within maxDistance from home sector AND exist in diverseList -->
        <set_value name="$validatedCrossStationTrade" exact="null"/>
        <do_if value="$crossStationBestTrade? and $crossStationBestScore gt 0">
          <set_value name="$tradeBuySector" exact="@$crossStationBestTrade.$BuyStation.sector"/>
          <set_value name="$tradeSellSector" exact="@$crossStationBestTrade.$SellStation.sector"/>
          <set_value name="$tradeBuyDistance" exact="-1"/>
          <set_value name="$tradeSellDistance" exact="-1"/>
          
          <do_if value="$tradeBuySector == $homeSector">
            <set_value name="$tradeBuyDistance" exact="0"/>
          </do_if>
          <do_else>
            <set_value name="$tradeBuyDistance" exact="$homeSector.gatedistance.{$tradeBuySector}"/>
          </do_else>
          
          <do_if value="$tradeSellSector == $homeSector">
            <set_value name="$tradeSellDistance" exact="0"/>
          </do_if>
          <do_else>
            <set_value name="$tradeSellDistance" exact="$homeSector.gatedistance.{$tradeSellSector}"/>
          </do_else>
          
          <!-- âœ… CRITICAL: Check if trade exists in final diverseList (wasn't filtered out) -->
          <set_value name="$tradeExistsInDiverseList" exact="false"/>
          <do_if value="$tradeBuyDistance ge 0 and $tradeSellDistance ge 0 and $tradeBuyDistance le $maxDistance and $tradeSellDistance le $maxDistance">
            <!-- Verify trade wasn't filtered out - check if it exists in diverseList by comparing stations and ware -->
            <do_all exact="$diverseList.count" counter="$i">
              <set_value name="$diverseTrade" exact="$diverseList.{$i}"/>
              <do_if value="$diverseTrade.$BuyStation == $crossStationBestTrade.$BuyStation and 
                             $diverseTrade.$SellStation == $crossStationBestTrade.$SellStation and
                             $diverseTrade.$BuyOffer.ware == $crossStationBestTrade.$BuyOffer.ware">
                <set_value name="$tradeExistsInDiverseList" exact="true"/>
                <break/>
              </do_if>
            </do_all>
            
            <!-- Only use if both distance valid AND trade exists in final filtered list -->
            <do_if value="$tradeExistsInDiverseList">
              <set_value name="$validatedCrossStationTrade" exact="$crossStationBestTrade"/>
            </do_if>
          </do_if>
        </do_if>
        
        <do_if value="$validatedNonConflictedTrade? and $nonConflictedBestScore gt 0">
          <!-- Prefer non-conflicted from filtered list (only if Score > 0, validated, AND exists in diverseList) -->
          <set_value name="$bestTrade" exact="$validatedNonConflictedTrade"/>
          <set_value name="$bestScore" exact="$nonConflictedBestScore"/>
        </do_if>
        <do_elseif value="$validatedCrossStationTrade? and $crossStationBestScore gt 0">
          <!-- Use cross-station trade (only if Score > 0, validated, AND exists in diverseList) -->
          <set_value name="$bestTrade" exact="$validatedCrossStationTrade"/>
          <set_value name="$bestScore" exact="$crossStationBestScore"/>
        </do_elseif>
        <do_else>
          <!-- Fallback: Find best from diverse list -->
          <!-- âœ… FIX: Use library function for consistent validation -->
          <do_all exact="$diverseList.count" counter="$i">
            <set_value name="$trade" exact="$diverseList.{$i}"/>
            <run_actions ref="md.GT_Trade_Utilities.GT_IsTradeValid" result="$isValid">
              <param name="trade" value="$trade"/>
              <param name="minScore" value="$bestScore"/>
            </run_actions>
            <do_if value="$isValid">
              <set_value name="$testScore" exact="@$trade.$Score"/>
              <set_value name="$bestScore" exact="$testScore"/>
              <set_value name="$bestTrade" exact="$trade"/>
            </do_if>
          </do_all>
          <!-- CRITICAL: If bestScore is still 0, all trades have Score = 0 (don't meet profit thresholds) -->
          <!-- Set bestTrade to null so "no trade found" path executes -->
          <do_if value="$bestScore le 0">
            <set_value name="$bestTrade" exact="null"/>
          </do_if>
        </do_else>
        
        <!-- 7. Extract original parameters BEFORE cleanup (so they're available when signaling) -->
        <!-- âœ… CRITICAL FIX: For fallback searches (maxDistance == 2), ALWAYS use batch data (has relaxed values) -->
        <!-- For normal searches, use queue params if available, otherwise fall back to batch data -->
        <set_value name="$originalParams" exact="null"/>
        <set_value name="$batchData" exact="@global.$GT_BatchDataList.{$ship}"/>
        <set_value name="$isFallbackFromBatch" exact="false"/>
        <do_if value="$batchData? and $batchData.$maxDistance == 2">
          <!-- This is a fallback search - batch data has relaxed profit thresholds, use those instead of queue -->
          <set_value name="$isFallbackFromBatch" exact="true"/>
          <set_value name="$allowIllegalDefault" exact="false"/>
          <set_value name="$originalParams" exact="table[
            $Ship = $ship,
            $MaxDistance = @$batchData.$maxDistance,
            $MinROI = @$batchData.$minROI,
            $MinAbsoluteProfit = @$batchData.$minAbsoluteProfit,
            $FactionPriority = @$batchData.$factionPriority,
            $AllowIllegal = $allowIllegalDefault
          ]"/>
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Resume] (' + $ship.idcode + ') âœ… Using batch data params for fallback search (relaxed profit: ' + (@$batchData.$minAbsoluteProfit / 100) + ' Cr)'" chance="100"/>
          </do_if>
        </do_if>
        <do_else>
          <!-- Normal search - try queue first, then batch data -->
          <do_if value="global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}?">
            <!-- Parameters are stored in search queue when search was initiated -->
            <set_value name="$originalParams" exact="global.$GT_SearchQueue.$Params.{$ship}"/>
          </do_if>
          <do_else>
            <!-- Fallback: Reconstruct parameters from batch data (before cleanup) -->
            <do_if value="$batchData?">
              <set_value name="$allowIllegalDefault" exact="false"/>
              <set_value name="$originalParams" exact="table[
                $Ship = $ship,
                $MaxDistance = @$batchData.$maxDistance,
                $MinROI = @$batchData.$minROI,
                $MinAbsoluteProfit = @$batchData.$minAbsoluteProfit,
                $FactionPriority = @$batchData.$factionPriority,
                $AllowIllegal = $allowIllegalDefault
              ]"/>
            </do_if>
          </do_else>
        </do_else>
        
        <!-- 8. Return results (including rejection statistics for diagnostics) -->
        <!-- Store trade count before storing in global (for accurate logging) -->
        <set_value name="$finalTradeCount" exact="$diverseList.count"/>
        <set_value name="$waitingFlag" exact="false"/>
        <!-- Combine blacklist and path blocked (both are safety restrictions) -->
        <set_value name="$totalBlacklistAndPath" exact="$filteredByBlacklist + $filteredByPathBlocked"/>
        <!-- Calculate total trades evaluated (valid + filtered) for accurate reporting -->
        <set_value name="$totalTradesEvaluated" exact="$finalTradeCount + $totalBlacklistAndPath + $filteredByIllegal + $filteredByWareBasket"/>
        
        <!-- âœ… CRITICAL FIX: Preserve LastRejectionStats when updating global.$GT_SearchResult -->
        <!-- FilterTradeList_Resume overwrites global.$GT_SearchResult, which would lose LastRejectionStats -->
        <set_value name="$preservedLastRejectionStats" exact="null"/>
        <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_SearchResult exists -->
        <do_if value="global.$GT_SearchResult.$LastRejectionStats?">
          <set_value name="$preservedLastRejectionStats" exact="global.$GT_SearchResult.$LastRejectionStats"/>
        </do_if>
        
        <set_value name="global.$GT_SearchResult" exact="table[
          $Found = ($finalTradeCount gt 0),
          $BestTrade = $bestTrade,
          $BestScore = $bestScore,
          $TradeList = $diverseList,
          $TradesRejectedProfit = $tradesRejectedProfit,
          $TradesRejectedDocking = $tradesRejectedDocking,
          $TradesRejectedAmount = $tradesRejectedAmount,
          $TradesRejectedDistance = $tradesRejectedDistance,
          $TradesRejectedBlacklist = $totalBlacklistAndPath,
          $BestRejectedTrade = $bestRejectedTrade,
          $WaitingForBatch = $waitingFlag,
          $Ship = $ship,
          $FilteredByBlacklist = $filteredByBlacklist,
          $FilteredByPathBlocked = $filteredByPathBlocked,
          $TotalTradesEvaluated = $totalTradesEvaluated
        ]"/>
        
        <!-- âœ… CRITICAL FIX: Restore LastRejectionStats after updating global.$GT_SearchResult -->
        <do_if value="$preservedLastRejectionStats?">
          <set_value name="global.$GT_SearchResult.$LastRejectionStats" exact="$preservedLastRejectionStats"/>
        </do_if>
        
        <!-- 9. Cleanup batch data (using ship object as key) -->
        <remove_value name="global.$GT_BatchDataList.{$ship}"/>
        <remove_value name="global.$GT_BatchResultsList.{$ship}"/>
        
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
          <debug_text text="'[GT-Resume] (' + $ship.idcode + ') Complete. Returning ' + $diverseList.count + ' diverse trades. Best score: ' + $bestScore" chance="100"/>
        </do_if>
        
        <!-- 10. Signal SearchTradeRoutes again with original parameters so it can read the live search results -->
        <do_if value="$originalParams?">
          <signal_cue_instantly cue="md.GT_Trading_Search.SearchTradeRoutes" param="$originalParams"/>
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Resume] (' + $ship.idcode + ') Signaled SearchTradeRoutes to continue with live search results (' + $finalTradeCount + ' trades)'" chance="100"/>
          </do_if>
        </do_if>
        <do_else>
          <!-- Fallback: Could not find original parameters, but results are already in global.$GT_SearchResult -->
          <!-- SearchTradeRoutes will be signaled by another mechanism or will read results on next check -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Resume] (' + $ship.idcode + ') âš ï¸ Could not find original parameters to signal SearchTradeRoutes - results stored in global.$GT_SearchResult'" chance="100"/>
          </do_if>
        </do_else>
      </actions>
    </cue>
    
    <!-- Search for Sell Opportunities -->
    <cue name="SearchSellOpportunities" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <!-- Receive parameters directly -->
        <set_value name="$params" exact="event.param"/>
        <set_value name="$ship" exact="$params.$Ship"/>
        <set_value name="$maxDistance" exact="$params.$MaxDistance"/>
        <set_value name="$minProfit" exact="$params.$MinProfit"/>
        
        <!-- DEBUG: Sell search start -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') === SELL SEARCH START ===' + '\nShip: ' + $ship.knownname + '\nCurrent Sector: ' + $ship.sector.knownname + '\nMax Distance: ' + $maxDistance + ' jumps' + '\nMin Profit: ' + $minProfit + ' Cr'" chance="100"/>
        </do_if>
        
        <!-- Find best sell location for current cargo -->
        <set_value name="$bestOffer" exact="null"/>
        <set_value name="$bestPrice" exact="0"/>
        <set_value name="$bestAmount" exact="0"/>
        
        <!-- Get ship's current cargo -->
        <set_value name="$currentCargo" exact="$ship.cargo.list"/>
        
        <do_if value="$currentCargo.count gt 0">
          <!-- ✅ FIX: Rotate through cargo entries to avoid getting stuck on unsellable wares -->
          <!-- Track last attempted ware index to rotate through cargo list -->
          <!-- If one ware can't be sold (banned, blacklisted, mission-tied), next request tries next ware -->
          <set_value name="$selectedIndex" exact="1"/>
          <do_if value="global.$GT_ForcedSellLastWare? and global.$GT_ForcedSellLastWare.{$ship}?">
            <!-- Get last attempted ware index -->
            <set_value name="$lastWareIndex" exact="global.$GT_ForcedSellLastWare.{$ship}"/>
            <!-- Rotate to next ware (wrap around if needed) -->
            <!-- Use % operator for modulo (X4 MD syntax) -->
            <set_value name="$selectedIndex" exact="(($lastWareIndex % $currentCargo.count) + 1)"/>
          </do_if>
          
          <!-- Select ware at rotated index -->
          <set_value name="$selectedWare" exact="$currentCargo.{$selectedIndex}"/>
          <set_value name="$selectedAmount" exact="$ship.cargo.{$selectedWare}.count"/>
          
          <!-- Store attempted ware index for next rotation -->
          <do_if value="not global.$GT_ForcedSellLastWare?">
            <set_value name="global.$GT_ForcedSellLastWare" exact="table[]"/>
          </do_if>
          <set_value name="global.$GT_ForcedSellLastWare.{$ship}" exact="$selectedIndex"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Sell] ' + $ship.idcode + ': Cargo contains ' + $currentCargo.count + ' ware types, attempting to sell ware ' + $selectedIndex + '/' + $currentCargo.count + ': ' + @$selectedWare.name + ' x' + $selectedAmount + ' (rotating through cargo to avoid stuck on unsellable wares)'" chance="100"/>
          </do_if>
          
          <!-- Find buy offers for the selected ware -->
          <!-- âœ… CRITICAL: tradepartner="$ship" ensures only executable offers (relations, permissions, F6 limitations) -->
          <find_buy_offer tradepartner="$ship" space="player.galaxy" result="$buyOffers" multiple="true" wares="$selectedWare">
            <match_buyer tradesknownto="$ship.owner">
              <match_gate_distance object="$ship" max="$maxDistance"/>
            </match_buyer>
          </find_buy_offer>
          
          <!-- âœ… FIX: Determine blacklistgroup (same logic as SearchLiveTrades_Resume) -->
          <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
          
          <!-- Find best price -->
          <do_all exact="$buyOffers.count" counter="$j">
            <set_value name="$offer" exact="$buyOffers.{$j}"/>
            <set_value name="$station" exact="$offer.owner"/>
            <set_value name="$currentSector" exact="$ship.sector"/>
            <set_value name="$stationSector" exact="$station.sector"/>
            
            <!-- âœ… NOTE: tradepartner="$ship" in find_buy_offer already filters by faction relations -->
            <!-- No explicit check needed - C++ engine handles it -->
            
            <!-- âœ… VALIDATION: Check blacklists before considering offer -->
            <set_value name="$isBlacklisted" exact="false"/>
            
            <!-- âœ… FIX: Block intra-sector sales in blacklisted sectors (force escape) -->
            <!-- If ship is in blacklisted sector and trying to sell to station in same sector, block -->
            <do_if value="@$currentSector.isblacklisted.{blacklisttype.sectortravel}.{$blacklistgroup}.{$ship}">
              <do_if value="$stationSector == $currentSector">
                <!-- Intra-sector sale in blacklisted sector - BLOCK to force escape -->
                <set_value name="$isBlacklisted" exact="true"/>
                <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Sell] ' + $ship.idcode + ': Rejected ' + @$station.knownname + ' (intra-sector sale in blacklisted sector - must escape)'" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
            
            <!-- Check station blacklist (object activity) -->
            <do_if value="not $isBlacklisted and @$station.isblacklisted.{blacklisttype.objectactivity}.{$blacklistgroup}.{$ship}">
              <set_value name="$isBlacklisted" exact="true"/>
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Sell] ' + $ship.idcode + ': Rejected ' + @$station.knownname + ' (station blacklisted)'" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- Check sector blacklist (sector activity) - only if station is in different sector -->
            <do_if value="not $isBlacklisted and $stationSector != $currentSector">
              <do_if value="@$stationSector.isblacklisted.{blacklisttype.sectoractivity}.{$blacklistgroup}.{$ship}">
                <set_value name="$isBlacklisted" exact="true"/>
                <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Sell] ' + $ship.idcode + ': Rejected ' + @$station.knownname + ' (sector activity blacklisted)'" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
            
            <!-- Check sector blacklist (travel) - only if station is in different sector -->
            <do_if value="not $isBlacklisted and $stationSector != $currentSector">
              <do_if value="@$stationSector.isblacklisted.{blacklisttype.sectortravel}.{$blacklistgroup}.{$ship}">
                <set_value name="$isBlacklisted" exact="true"/>
                <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Sell] ' + $ship.idcode + ': Rejected ' + @$station.knownname + ' (sector travel blacklisted)'" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
            
            <!-- âœ… VALIDATION: Check if path to station goes through blacklisted sectors -->
            <!-- Uses blacklist-aware gatedistance - returns -1 if path blocked by blacklisted sector -->
            <!-- Vanilla pattern: order.dock.xml:503 -->
            <do_if value="not $isBlacklisted">
              <set_value name="$pathDistance" exact="$ship.gatedistance.{$stationSector}.{$blacklistgroup}.{$ship}"/>
              
              <do_if value="$pathDistance lt 0">
                <!-- Path goes through blacklisted sector or no path exists -->
                <set_value name="$isBlacklisted" exact="true"/>
                <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                  <!-- <debug_text text="'[GT-Sell] ' + $ship.idcode + ': Rejected ' + @$station.knownname + ' (path goes through blacklisted sector)'" chance="100"/> -->
                </do_if>
              </do_if>
            </do_if>
            
            <!-- âœ… VALIDATION: Check operational status -->
            <set_value name="$isOperational" exact="$station.isoperational and not @$station.isclosingdown"/>
            <do_if value="not $isBlacklisted and not $isOperational">
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                <debug_text text="'[GT-Sell] ' + $ship.idcode + ': Rejected ' + @$station.knownname + ' (not operational)'" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- âœ… VALIDATION: Check technical docking capability - does station have docking bay for this ship size? -->
            <set_value name="$canDock" exact="false"/>
            <do_if value="not $isBlacklisted and $isOperational">
              <find_dockingbay name="$testDock" object="$station" checkoperational="true" multiple="false">
                <match_dock size="$ship.docksize" storage="false"/>
              </find_dockingbay>
              <do_if value="$testDock">
                <!-- Station has docking bay for this ship size - check docking permission -->
                <set_value name="$canDock" exact="$station.dockingallowed.{$ship}"/>
              </do_if>
              <do_else>
                <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Sell] ' + $ship.idcode + ': Rejected ' + @$station.knownname + ' (no docking bay for ship size ' + $ship.docksize + ')'" chance="100"/>
                </do_if>
              </do_else>
            </do_if>
            
            <!-- âœ… VALIDATION: Check docking permission -->
            <do_if value="not $isBlacklisted and $isOperational and not $canDock">
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Sell] ' + $ship.idcode + ': Rejected ' + @$station.knownname + ' (docking not allowed)'" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- Only consider valid, non-blacklisted, operational, dockable offers -->
            <do_if value="not $isBlacklisted and $isOperational and $canDock and $offer.available">
              <set_value name="$tradeAmount" exact="[$selectedAmount, $offer.amount].min"/>
              <set_value name="$profit" exact="$offer.unitprice * $tradeAmount"/>
              
              <do_if value="$profit gt $bestPrice">
                <set_value name="$bestOffer" exact="$offer"/>
                <set_value name="$bestPrice" exact="$profit"/>
                <set_value name="$bestAmount" exact="$tradeAmount"/>
                
                <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Sell] ' + $ship.idcode + ': Best offer now: ' + @$station.knownname + ' - ' + $offer.ware.name + ' x' + $tradeAmount + ' @ ' + $offer.unitprice + ' Cr/unit (profit: ' + $profit + ' Cr)'" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
          </do_all>
          
          <!-- ✅ FIX: Execute best sell if found - use normal pipeline (store in GT_PendingTrades, let AI create orders) -->
          <do_if value="$bestOffer and $bestPrice gt $minProfit">
            <!-- ✅ CRITICAL: Validate offer is STILL valid before proceeding -->
            <!-- Offers can become invalid between search and order creation -->
            <set_value name="$offerStillValid" exact="$bestOffer.available and $bestOffer.amount gt 0"/>
            
            <do_if value="$offerStillValid">
              <debug_text text="'[GalaxyTrader MK3] ' + $ship.knownname + ' found sell opportunity'" chance="100"/>
              
              <!-- ✅ FIX: Create trade structure compatible with normal pipeline -->
              <!-- For forced sell: ship already has cargo, so we create a sell-only trade structure -->
              <!-- BuyStation = ship's docked station (if docked) or ship itself (if in space) -->
              <!-- This ensures failure handler can access .sector and .knownname properties -->
              <!-- SellStation = target station buying the cargo -->
              <set_value name="$buyStation" exact="$ship"/>
              <do_if value="$ship.dock? and $ship.dock.container?">
                <!-- Ship is docked - use docked station for better tracking -->
                <set_value name="$buyStation" exact="$ship.dock.container"/>
              </do_if>
              <do_elseif value="$ship.parkedat?">
                <!-- Ship is parked at station -->
                <set_value name="$buyStation" exact="$ship.parkedat"/>
              </do_elseif>
              <!-- If not docked, use ship object itself (has .sector and .knownname) -->
              <set_value name="$sellStation" exact="$bestOffer.owner"/>
              
              <!-- ✅ FIX: Create trade structure matching normal pipeline format -->
              <!-- For sell-only trades, BuyOffer is null (ship already has cargo) -->
              <!-- ExecuteTrade will handle this via $IsSellOnly flag -->
              <set_value name="$sellTrade" exact="table[
                $BuyStation = $buyStation,
                $SellStation = $sellStation,
                $Ware = $selectedWare,
                $BuyOffer = null,
                $SellOffer = $bestOffer,
                $Amount = $bestAmount,
                $BuyPrice = 0,
                $SellPrice = $bestOffer.unitprice,
                $Profit = $bestPrice,
                $ROI = 0,
                $Score = $bestPrice,
                $Distance = 0,
                $IsSellOnly = true
              ]"/>
              
              <!-- ✅ FIX: Store in GT_PendingTrades and send to execution pipeline -->
              <!-- This ensures failure tracking, telemetry, and proper order creation by AI -->
              <signal_cue_instantly cue="md.GT_Trading_Execution.ExecuteTrade" param="table[
                $Ship = $ship,
                $Trade = $sellTrade,
                $TradeList = [$sellTrade],
                $SearchMethod = 'forced_sell'
              ]"/>
              
              <!-- Note: GT_Trade_Found signal now sent FROM ExecuteTrade after storing pending trade -->
            </do_if>
            <do_else>
              <!-- Offer became invalid - don't create order -->
              <debug_text text="'[GT-Sell] ' + $ship.idcode + ': Best offer became invalid before order creation - retrying'" chance="100"/>
              
              <!-- Signal back to AI script: No Trade Found (will retry) -->
              <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
            </do_else>
          </do_if>
          <do_else>
            <!-- Signal back to AI script: No Trade Found -->
            <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
          </do_else>
        </do_if>
        <do_else>
          <!-- Signal back to AI script: No Trade Found (no cargo) -->
          <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
        </do_else>
        
        <!-- CRITICAL: Clean up AI parameters -->
        <!-- âœ… SIMPLIFIED: Initialization guarantees global.$GT_AIParameters exists -->
        <do_if value="global.$GT_AIParameters.{$ship}?">
          <remove_value name="global.$GT_AIParameters.{$ship}"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- SearchFallbackTrades: Fallback search with MaxDistance=2 for nearby trades -->
    <!-- Only triggers when cache + normal live search both fail AND ship is not isolated -->
  </cues>
</mdscript>
