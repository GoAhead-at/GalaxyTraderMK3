<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Libraries_Distribution" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <library name="GT_CalculateStorageRatio" purpose="run_actions">
      <params>
        <param name="station"/>
        <param name="ware"/>
      </params>
      <actions>
        <set_value name="$target" exact="$station.cargo.{$ware}.target"/>
        <do_if value="$target le 0">
          <return value="0"/>
        </do_if>
        <return value="($station.cargo.{$ware}.count * 100.0) / $target"/>
      </actions>
    </library>

    <library name="GT_EvaluateDistributionNeed" purpose="run_actions">
      <params>
        <param name="sourceRatio"/>
        <param name="targetRatio"/>
        <param name="minStorage"/>
        <param name="staticStorage"/>
        <param name="maxStorage"/>
      </params>
      <actions>
        <set_value name="$result" exact="table[$ShouldDistribute = false, $Priority = 0]"/>
        <do_if value="$sourceRatio le $staticStorage">
          <return value="$result"/>
        </do_if>
        <do_if value="$targetRatio lt $minStorage">
          <set_value name="$result.$ShouldDistribute" exact="true"/>
          <set_value name="$result.$Priority" exact="2"/>
          <return value="$result"/>
        </do_if>
        <do_if value="$sourceRatio gt $maxStorage and $sourceRatio gt ($targetRatio + 10)">
          <set_value name="$result.$ShouldDistribute" exact="true"/>
          <set_value name="$result.$Priority" exact="1"/>
        </do_if>
        <return value="$result"/>
      </actions>
    </library>

    <library name="GT_ScoreDistributionTrade" purpose="run_actions">
      <params>
        <param name="sourceRatio"/>
        <param name="priority"/>
        <param name="tradeAmount"/>
        <param name="cargoCapacity"/>
        <param name="staticStorage"/>
      </params>
      <actions>
        <set_value name="$urgencyMultiplier" exact="if $priority == 2 then 2.0 else 1.0"/>
        <set_value name="$excessFactor" exact="($sourceRatio - $staticStorage) / 100.0"/>
        <set_value name="$fillFactor" exact="$tradeAmount / [$cargoCapacity, 1].max"/>
        <return value="$excessFactor * $urgencyMultiplier * $fillFactor * 1000"/>
      </actions>
    </library>

    <library name="GT_BuildWareBasket" purpose="run_actions">
      <params>
        <param name="sourceStation"/>
        <param name="warebasket"/>
      </params>
      <actions>
        <create_list name="$effectiveWares"/>
        <do_if value="$warebasket? and $warebasket.count gt 0">
          <do_all exact="$warebasket.count" counter="$i">
            <append_to_list name="$effectiveWares" exact="$warebasket.{$i}"/>
          </do_all>
          <return value="$effectiveWares"/>
        </do_if>

        <set_value name="$products" exact="$sourceStation.products.list"/>
        <set_value name="$tradewares" exact="$sourceStation.tradewares.list"/>

        <do_all exact="$products.count" counter="$i">
          <append_to_list name="$effectiveWares" exact="$products.{$i}"/>
        </do_all>
        <do_all exact="$tradewares.count" counter="$i">
          <set_value name="$ware" exact="$tradewares.{$i}"/>
          <set_value name="$exists" exact="false"/>
          <do_all exact="$effectiveWares.count" counter="$j">
            <do_if value="$effectiveWares.{$j} == $ware">
              <set_value name="$exists" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          <do_if value="not $exists">
            <append_to_list name="$effectiveWares" exact="$ware"/>
          </do_if>
        </do_all>
        <return value="$effectiveWares"/>
      </actions>
    </library>

    <!-- Trade finder is implemented in AI script for execution ordering; keep a no-op placeholder for API stability. -->
    <library name="GT_FindBestDistributionTrade" purpose="run_actions">
      <params>
        <param name="ship"/>
        <param name="sourceStation"/>
        <param name="destList"/>
        <param name="warebasket"/>
        <param name="minStorage"/>
        <param name="staticStorage"/>
        <param name="maxStorage"/>
        <param name="allowillegal"/>
        <param name="fleetcoordination"/>
      </params>
      <actions>
        <return value="table[$BestTrade = null, $SourceOffer = null, $DestOffer = null]"/>
      </actions>
    </library>
  </cues>
</mdscript>
