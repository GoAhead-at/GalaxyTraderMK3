<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Trading_Batch_Processor" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
    <!-- BATCHED TRADE MATCHING PROCESSOR -->
    <!-- Pattern inspired by TaterTrader's tick-based cooperative multitasking -->
    <!-- Adapted for MD scripts: processes trades in batches with delays between -->
    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
    
    <cue name="ProcessTradeMatchingBatch" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <!-- Calculate delay from global Performance settings -->
        <set_value name="$batchDelay" exact="50"/>
        <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$BatchProcessingDelay?">
          <set_value name="$batchDelay" exact="@global.$GT_GlobalSettings.$Performance.$BatchProcessingDelay"/>
        </do_if>
        <!-- Convert to time value (milliseconds) -->
        <set_value name="this.$batchDelayTime" exact="$batchDelay * 1ms"/>
      </actions>
      <delay exact="this.$batchDelayTime"/>
      <actions>
        <!-- Retrieve ship object from signal (used as table key) -->
        <set_value name="$ship" exact="event.param"/>
        
        <!-- Initialize batch processor queue if needed -->
        <do_if value="not global.$GT_BatchProcessorQueue?">
          <set_value name="global.$GT_BatchProcessorQueue" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_BatchProcessorQueue.$ActiveProcessors?">
          <set_value name="global.$GT_BatchProcessorQueue.$ActiveProcessors" exact="0"/>
        </do_if>
        <do_if value="not global.$GT_BatchProcessorQueue.$MaxConcurrent?">
          <set_value name="global.$GT_BatchProcessorQueue.$MaxConcurrent" exact="1"/>
        </do_if>
        
        <!-- Check if this is a continuation batch (same ship) - allow continuation batches -->
        <set_value name="$isContinuation" exact="false"/>
        <do_if value="global.$GT_BatchProcessorQueue.$ActiveProcessors? and global.$GT_BatchProcessorQueue.$ActiveProcessors gt 0">
          <!-- Check if this ship already has an active processor -->
          <set_value name="$hasActiveProcessor" exact="false"/>
          <do_if value="global.$GT_BatchProcessorQueue.$ActiveShips?">
            <do_all exact="global.$GT_BatchProcessorQueue.$ActiveShips.count" counter="$i">
              <do_if value="global.$GT_BatchProcessorQueue.$ActiveShips.{$i} == $ship">
                <set_value name="$hasActiveProcessor" exact="true"/>
                <set_value name="$isContinuation" exact="true"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>
        </do_if>
        
        <!-- If not continuation and at max concurrent, cancel this instance -->
        <do_if value="not $isContinuation and global.$GT_BatchProcessorQueue.$ActiveProcessors ge global.$GT_BatchProcessorQueue.$MaxConcurrent">
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Max concurrent processors reached (' + global.$GT_BatchProcessorQueue.$ActiveProcessors + '/' + global.$GT_BatchProcessorQueue.$MaxConcurrent + ') - queuing request'" chance="100"/>
          </do_if>
          <!-- Queue this request instead -->
          <do_if value="not global.$GT_BatchProcessorQueue.$Ships?">
            <set_value name="global.$GT_BatchProcessorQueue.$Ships" exact="[]"/>
          </do_if>
          <set_value name="$alreadyInQueue" exact="false"/>
          <do_if value="global.$GT_BatchProcessorQueue.$Ships?">
            <do_all exact="global.$GT_BatchProcessorQueue.$Ships.count" counter="$i">
              <do_if value="global.$GT_BatchProcessorQueue.$Ships.{$i} == $ship">
                <set_value name="$alreadyInQueue" exact="true"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>
          <do_if value="not $alreadyInQueue">
            <append_to_list name="global.$GT_BatchProcessorQueue.$Ships" exact="$ship"/>
            <signal_cue_instantly cue="md.GT_Trading_Batch_Processor.ProcessBatchProcessorQueue"/>
          </do_if>
          <cancel_cue cue="this"/>
        </do_if>
        
        <!-- Increment active processors counter and track active ship -->
        <do_if value="not $isContinuation">
          <set_value name="global.$GT_BatchProcessorQueue.$ActiveProcessors" operation="add"/>
          <do_if value="not global.$GT_BatchProcessorQueue.$ActiveShips?">
            <set_value name="global.$GT_BatchProcessorQueue.$ActiveShips" exact="[]"/>
          </do_if>
          <append_to_list name="global.$GT_BatchProcessorQueue.$ActiveShips" exact="$ship"/>
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Batch] (' + $ship.idcode + ') BATCH PROCESSOR STARTING (active: ' + global.$GT_BatchProcessorQueue.$ActiveProcessors + '/' + global.$GT_BatchProcessorQueue.$MaxConcurrent + ', queued: ' + (if global.$GT_BatchProcessorQueue.$Ships? then global.$GT_BatchProcessorQueue.$Ships.count else 0) + ')'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Retrieve state from GLOBAL TABLE using ship object as key (persists after SearchLiveTrades ends) -->
        <set_value name="$state" exact="@global.$GT_BatchDataList.{$ship}"/>
        
        <!-- Check if state exists AND is not null (X4 ? operator only checks existence, not null) -->
        <!-- If state doesn't exist or is null, entry was cleaned up or never created (initialization handles old saves) -->
        <!-- Check if $state is a valid table by trying to access .keys property -->
        <set_value name="$stateValid" exact="false"/>
        <do_if value="$state?">
          <!-- State variable exists - verify it's actually a valid table (not null) -->
          <!-- Try accessing .keys property - if state is null, @ operator returns null safely -->
          <set_value name="$stateKeysTest" exact="@$state.keys"/>
          <!-- If state is null, $stateKeysTest will be null -->
          <!-- Check if we got a valid list back (not null) by trying to access .count -->
          <set_value name="$stateKeysCountTest" exact="@$stateKeysTest.count"/>
          <!-- Check if count is actually a number (not null) -->
          <!-- If $stateKeysCountTest is null, we can't compare it, so check if it exists AND is >= 0 -->
          <do_if value="$stateKeysCountTest?">
            <!-- Count variable exists - verify it's actually a number by checking it's >= 0 -->
            <!-- If count is null, the comparison will fail or be false -->
            <do_if value="$stateKeysCountTest ge 0">
              <!-- Comparison succeeded - count is >= 0, so it's a valid number and state is valid table -->
              <!-- Also verify state has expected property ($batchId) to confirm it's batch state, not just any table -->
              <set_value name="$stateBatchIdTest" exact="@$state.$batchId"/>
              <do_if value="$stateBatchIdTest?">
                <!-- State has $batchId - it's valid batch state -->
                <set_value name="$stateValid" exact="true"/>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
        <do_if value="not $stateValid">
          <!-- Decrement active processors if we're cancelling (cleanup) -->
          <do_if value="global.$GT_BatchProcessorQueue? and global.$GT_BatchProcessorQueue.$ActiveProcessors? and global.$GT_BatchProcessorQueue.$ActiveProcessors gt 0">
            <set_value name="global.$GT_BatchProcessorQueue.$ActiveProcessors" operation="subtract"/>
          </do_if>
          <!-- Remove ship from active ships list -->
          <do_if value="global.$GT_BatchProcessorQueue? and global.$GT_BatchProcessorQueue.$ActiveShips?">
            <set_value name="$shipIndex" exact="-1"/>
            <do_all exact="global.$GT_BatchProcessorQueue.$ActiveShips.count" counter="$i">
              <do_if value="global.$GT_BatchProcessorQueue.$ActiveShips.{$i} == $ship">
                <set_value name="$shipIndex" exact="$i"/>
                <break/>
              </do_if>
            </do_all>
            <do_if value="$shipIndex ge 0">
              <remove_from_list name="global.$GT_BatchProcessorQueue.$ActiveShips" index="$shipIndex"/>
            </do_if>
          </do_if>
          <!-- Process next queued batch processor if any -->
          <do_if value="global.$GT_BatchProcessorQueue? and global.$GT_BatchProcessorQueue.$Ships? and global.$GT_BatchProcessorQueue.$Ships.count gt 0">
            <signal_cue_instantly cue="md.GT_Trading_Batch_Processor.ProcessBatchProcessorQueue"/>
          </do_if>
          
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Batch] Batch state not found or null for ship ' + $ship.idcode + ' - cancelling (stateKeysCountTest: ' + $stateKeysCountTest + ')'" chance="100"/>
          </do_if>
          <cancel_cue cue="this"/>
        </do_if>
        
        <!-- Extract all state variables (use safe operator @ for all extractions) -->
        <set_value name="$batchId" exact="@$state.$batchId"/>
        <set_value name="$waitingCue" exact="@$state.$waitingCue"/>
        <!-- Note: $ship already set from event.param above -->
        <!-- No blacklistgroup - blacklist filtering happens at retrieval -->
        <set_value name="$wareKeysList" exact="@$state.$wareKeysList"/>
        <set_value name="$sellOffersList" exact="@$state.$sellOffersList"/>
        <set_value name="$buyOffersList" exact="@$state.$buyOffersList"/>
        
        <!-- DEBUG: Verify lists were received correctly -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
          <set_value name="$keysCount" exact="0"/>
          <set_value name="$sellCount" exact="0"/>
          <set_value name="$buyCount" exact="0"/>
          <do_if value="$wareKeysList?">
            <set_value name="$keysCountTemp" exact="@$wareKeysList.count"/>
            <do_if value="$keysCountTemp?">
              <set_value name="$keysCount" exact="$keysCountTemp"/>
            </do_if>
          </do_if>
          <do_if value="$sellOffersList?">
            <set_value name="$sellCountTemp" exact="@$sellOffersList.count"/>
            <do_if value="$sellCountTemp?">
              <set_value name="$sellCount" exact="$sellCountTemp"/>
            </do_if>
          </do_if>
          <do_if value="$buyOffersList?">
            <set_value name="$buyCountTemp" exact="@$buyOffersList.count"/>
            <do_if value="$buyCountTemp?">
              <set_value name="$buyCount" exact="$buyCountTemp"/>
            </do_if>
          </do_if>
          <!-- Commented out to reduce log spam -->
          <!-- <debug_text text="'[GT-Batch-DEBUG] (' + $ship.idcode + ') Received state: keys=' + $keysCount + ', sellEntries=' + $sellCount + ', buyEntries=' + $buyCount" chance="100"/> -->
          <do_if value="not $wareKeysList?">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Batch-DEBUG] (' + $ship.idcode + ') WARNING wareKeysList is NULL!'" chance="100"/>
            </do_if>
          </do_if>
          <do_if value="$wareKeysList?">
            <set_value name="$wareKeysListCountTemp" exact="@$wareKeysList.count"/>
            <do_if value="$wareKeysListCountTemp? and $wareKeysListCountTemp == 0">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Batch-DEBUG] (' + $ship.idcode + ') WARNING wareKeysList is EMPTY count=0!'" chance="100"/>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Use safe operator @ for all property access to prevent null errors -->
        <set_value name="$stationDistanceCache" exact="@$state.$stationDistanceCache"/>
        <set_value name="$tradeList" exact="@$state.$tradeList"/>
        <set_value name="$crossStationBestScore" exact="@$state.$crossStationBestScore"/>
        <set_value name="$crossStationBestTrade" exact="@$state.$crossStationBestTrade"/>
        <set_value name="$nonConflictedBestScore" exact="@$state.$nonConflictedBestScore"/>
        <set_value name="$nonConflictedBestTrade" exact="@$state.$nonConflictedBestTrade"/>
        <set_value name="$reservedRoutes" exact="@$state.$reservedRoutes"/>
        <set_value name="$failedTrades" exact="@$state.$failedTrades"/>
        <!-- No escape sectors or current sector blacklist - removed for universal processing -->
        <set_value name="$currentWareIndex" exact="@$state.$currentWareIndex"/>
        <!-- Extract home sector for cache indexing -->
        <set_value name="$homeSector" exact="@$state.$homeSector"/>
        <!-- Use library function to validate table safely -->
        <set_value name="$existingTradesPerWare" exact="@$state.$tradesPerWare"/>
        <run_actions ref="md.GT_Libraries_General.GT_ValidateTableSafe" result="$tradesPerWare">
          <param name="table" value="$existingTradesPerWare"/>
        </run_actions>
        <!-- Use safe operator @ for all property access to prevent null errors -->
        <set_value name="$maxTradesPerWare" exact="@$state.$maxTradesPerWare"/>
        <set_value name="$batchSize" exact="@$state.$batchSize"/>
        <set_value name="$earlyExitThreshold" exact="@$state.$earlyExitThreshold"/>
        <set_value name="$maxDistance" exact="@$state.$maxDistance"/>
        <set_value name="$distancePenaltyMultiplier" exact="@$state.$distancePenaltyMultiplier"/>
        <set_value name="$factionPriority" exact="@$state.$factionPriority"/>
        <set_value name="$minROI" exact="@$state.$minROI"/>
        <set_value name="$minAbsoluteProfit" exact="@$state.$minAbsoluteProfit"/>
        <set_value name="$gt_AdvancedAnalytics" exact="@$state.$gt_AdvancedAnalytics"/>
        
        <!-- Log thresholds being used for this batch -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Batch thresholds: MinROI=' + $minROI + '%, MinAbsoluteProfit=' + ($minAbsoluteProfit/100) + ' Cr, MaxDistance=' + $maxDistance" chance="100"/>
          <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Profit threshold breakdown: Base=' + ($minAbsoluteProfit / 100) + ' Cr (raw: ' + $minAbsoluteProfit + ') | Intra-sector (50%): ' + (($minAbsoluteProfit / 2) / 100) + ' Cr | Isolated intra-sector (25%): ' + (($minAbsoluteProfit * 25 / 100) / 100) + ' Cr'" chance="100"/>
        </do_if>
        <!-- Use safe operator @ for all property access to prevent null errors -->
        <set_value name="$availableMoney" exact="@$state.$availableMoney"/>
        <set_value name="$tradesRejectedProfit" exact="@$state.$tradesRejectedProfit"/>
        <set_value name="$tradesRejectedDocking" exact="@$state.$tradesRejectedDocking"/>
        <set_value name="$tradesRejectedAmount" exact="@$state.$tradesRejectedAmount"/>
        <set_value name="$tradesRejectedDistance" exact="@$state.$tradesRejectedDistance"/>
        <!-- No tradesRejectedBlacklist - blacklist filtering happens at retrieval -->
        <set_value name="$bestRejectedProfit" exact="@$state.$bestRejectedProfit"/>
        <set_value name="$bestRejectedTrade" exact="@$state.$bestRejectedTrade"/>
        
        <!-- No sector blacklist cache building - removed for universal processing -->
        <!-- Blacklist filtering happens per-ship during cache retrieval, not during cache building -->
        
        <!-- Check ONCE per ship BEFORE processing any wares -->
        <!-- This ensures Phase 2 (cross-sector trades) is skipped immediately if isolated -->
        <!-- Uses GT_CheckAndHandleIsolation library for maintainability -->
        <run_actions ref="md.GT_Libraries_Blacklist.GT_CheckAndHandleIsolation" result="$isolationResult">
          <param name="ship" value="$ship"/>
          <param name="state" value="$state"/>
        </run_actions>
        <set_value name="$shipIsIsolated" exact="$isolationResult.$IsIsolated"/>
        <!-- Validate returned UpdatedState before overwriting $state -->
        <!-- If isolation function returns null UpdatedState, keep original $state -->
        <set_value name="$returnedState" exact="@$isolationResult.$UpdatedState"/>
        <set_value name="$returnedStateValid" exact="false"/>
        <do_if value="$returnedState?">
          <set_value name="$returnedStateKeysTest" exact="@$returnedState.keys"/>
          <do_if value="$returnedStateKeysTest?">
            <set_value name="$returnedStateCountTest" exact="@$returnedStateKeysTest.count"/>
            <do_if value="$returnedStateCountTest? and $returnedStateCountTest ge 0">
              <set_value name="$returnedStateValid" exact="true"/>
            </do_if>
          </do_if>
        </do_if>
        <do_if value="$returnedStateValid">
          <!-- Returned state is valid - use it -->
          <set_value name="$state" exact="$returnedState"/>
        </do_if>
        <do_else>
          <!-- Returned state is null or invalid - keep original $state (already validated above) -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Batch] Isolation function returned null/invalid UpdatedState for ship ' + $ship.idcode + ' - keeping original state'" chance="100"/>
          </do_if>
        </do_else>
        <set_value name="global.$GT_BatchDataList.{$ship}" exact="$state"/>
        
        <!-- Use global setting for max offers per ware for matching -->
        <set_value name="$maxOffersPerWareForMatching" exact="20"/> <!-- Default fallback -->
        <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$MaxOffersPerWareForMatching?">
          <set_value name="$maxOffersPerWareForMatching" exact="global.$GT_GlobalSettings.$Performance.$MaxOffersPerWareForMatching"/>
        </do_if>
        
        <!-- Calculate batch boundaries using wareKeysList (list, not table) -->
        <set_value name="$wareCount" exact="0"/>
        <do_if value="$wareKeysList?">
          <set_value name="$wareCountTemp" exact="@$wareKeysList.count"/>
          <do_if value="$wareCountTemp?">
            <set_value name="$wareCount" exact="$wareCountTemp"/>
          </do_if>
        </do_if>
        
        <!-- CRITICAL: Lists are 1-based, so batchStart should be 1-based too -->
        <!-- $currentWareIndex is 0-based (starts at 0), convert to 1-based for list access -->
        <set_value name="$batchStart1Based" exact="$currentWareIndex + 1"/>
        <set_value name="$batchEnd1Based" exact="[$currentWareIndex + $batchSize + 1, $wareCount + 1].min"/>
        
        <!-- Commented out to reduce log spam -->
        <!-- <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
          <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Processing batch: list indices ' + $batchStart1Based + '-' + ($batchEnd1Based - 1) + ' of ' + $wareCount" chance="100"/>
        </do_if> -->
        
        <!-- Process this batch of wares -->
        <!-- NOTE: Lists in X4 are 1-based! $batchOffset starts at 1 -->
        <!-- batchStart1Based is already 1-based, so we just add offset-1 -->
        <do_if value="$batchStart1Based le $wareCount">
          <do_all exact="$batchEnd1Based - $batchStart1Based" counter="$batchOffset">
            <!-- $batchOffset starts at 1, batchStart1Based is 1-based -->
            <!-- For first item: batchStart1Based=1, batchOffset=1 wareIdx=1+1-1=1 ✓ -->
            <set_value name="$wareIdx" exact="$batchStart1Based + $batchOffset - 1"/>
            
            <!-- Early exit if we have enough trades -->
            <do_if value="$tradeList.count ge $earlyExitThreshold">
              <break/>
            </do_if>
            
            <!-- Get ware from list -->
            <set_value name="$ware" exact="$wareKeysList.{$wareIdx}"/>
            
            <!-- ═══════════════════════════════════════════════════════════════════════════ -->
            <!-- WARE QUOTA CHECK: Skip this ware if we've already collected enough trades for it -->
            <!-- This ensures diversity by preventing one ware from monopolizing all trade slots -->
            <!-- ═══════════════════════════════════════════════════════════════════════════ -->
            <set_value name="$tradesForThisWare" exact="0"/>
            <!-- CRITICAL: Check if table is valid before accessing (prevents null errors) -->
            <set_value name="$tradesPerWareKeys" exact="@$tradesPerWare.keys"/>
            <do_if value="$tradesPerWareKeys? and $tradesPerWare.{$ware}?">
              <set_value name="$tradesForThisWare" exact="$tradesPerWare.{$ware}"/>
            </do_if>
            
            <!-- Skip to next ware if quota reached -->
            <do_if value="$tradesForThisWare ge $maxTradesPerWare">
              <continue/>
            </do_if>
            
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging and $wareIdx lt 2">
              <debug_text text="'[GT-Batch-DEBUG] (' + $ship.idcode + ') Processing ware #' + $wareIdx + ': ' + (if $ware? then @$ware.name else 'NULL') + ' (quota: ' + $tradesForThisWare + '/' + $maxTradesPerWare + ')'" chance="100"/>
            </do_if>
            
            <!-- Find sell offers for this ware in list -->
            <set_value name="$sellOffersForWare" exact="[]"/>
            <do_if value="$sellOffersList?">
              <set_value name="$sellOffersListCount" exact="@$sellOffersList.count"/>
              <do_if value="$sellOffersListCount? and $sellOffersListCount gt 0">
                <do_all exact="$sellOffersListCount" counter="$i">
                  <set_value name="$entry" exact="$sellOffersList.{$i}"/>
                  <do_if value="$entry.$ware == $ware">
                    <set_value name="$sellOffersForWare" exact="$entry.$offers"/>
                    <break/>
                  </do_if>
                </do_all>
              </do_if>
            </do_if>
            
            <!-- Find buy offers for this ware in list -->
            <set_value name="$buyOffersForWare" exact="[]"/>
            <do_if value="$buyOffersList?">
              <set_value name="$buyOffersListCount" exact="@$buyOffersList.count"/>
              <do_if value="$buyOffersListCount? and $buyOffersListCount gt 0">
                <do_all exact="$buyOffersListCount" counter="$i">
                  <set_value name="$entry" exact="$buyOffersList.{$i}"/>
                  <do_if value="$entry.$ware == $ware">
                    <set_value name="$buyOffersForWare" exact="$entry.$offers"/>
                    <break/>
                  </do_if>
                </do_all>
              </do_if>
            </do_if>
            
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging and $wareIdx lt 2">
              <debug_text text="'[GT-Batch-DEBUG] (' + $ship.idcode + ') Found: ' + $sellOffersForWare.count + ' sell, ' + $buyOffersForWare.count + ' buy offers for ' + (if $ware? then @$ware.name else 'NULL')" chance="100"/>
            </do_if>
            
            <!-- Process this ware if both sell and buy offers exist -->
            <!-- LINE 194: Opens do_if - must be closed at line 998 -->
            <do_if value="$sellOffersForWare.count gt 0 and $buyOffersForWare.count gt 0">
              
              <!-- ═══════════════════════════════════════════════════════════════════════════ -->
              <!-- Limit offers BEFORE nested loops to reduce iterations -->
              <!-- Reduces from 50×100 = 5,000 to 20×20 = 400 iterations per ware (92% reduction) -->
              <!-- Use global setting for max offers per ware for matching -->
              <!-- ═══════════════════════════════════════════════════════════════════════════ -->
              <!-- Note: $maxOffersPerWareForMatching is set at the start of ProcessTradeMatchingBatch cue -->
              
              <!-- Store original offer lists BEFORE limiting (needed for intra-sector inclusion) -->
              <set_value name="$originalSellOffers" exact="$sellOffersForWare"/>
              <set_value name="$originalBuyOffers" exact="$buyOffersForWare"/>
              
              <!-- For isolated ships, filter offers to current sector ONLY -->
              <!-- Isolated ships can't reach other sectors, so only look at offers in current sector -->
              <set_value name="$currentSector" exact="$ship.sector"/>
              <do_if value="$shipIsIsolated and $currentSector?">
                <!-- Filter sell offers to current sector only -->
                <set_value name="$filteredSellOffers" exact="[]"/>
                <set_value name="$currentSectorName" exact="@$currentSector.knownname"/>
                <do_all exact="$sellOffersForWare.count" counter="$idx">
                  <set_value name="$offer" exact="$sellOffersForWare.{$idx}"/>
                  <set_value name="$offerSector" exact="@$offer.owner.sector"/>
                  <do_if value="$offerSector?">
                    <set_value name="$offerSectorName" exact="@$offerSector.knownname"/>
                    <do_if value="$offerSector == $currentSector">
                      <append_to_list name="$filteredSellOffers" exact="$offer"/>
                    </do_if>
                    <do_elseif value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging and $idx le 3">
                      <!-- Debug first 3 offers to verify sector comparison -->
                      <debug_text text="'[GT-Batch] (' + $ship.idcode + ') SELL OFFER #' + $idx + ': Offer sector=' + (if $offerSectorName? then $offerSectorName else 'NULL') + ', Current sector=' + (if $currentSectorName? then $currentSectorName else 'NULL') + ', Match=' + ($offerSector == $currentSector)" chance="100"/>
                    </do_elseif>
                  </do_if>
                </do_all>
                <set_value name="$sellOffersForWare" exact="$filteredSellOffers"/>
                
                <!-- Filter buy offers to current sector only -->
                <set_value name="$filteredBuyOffers" exact="[]"/>
                <do_all exact="$buyOffersForWare.count" counter="$idx">
                  <set_value name="$offer" exact="$buyOffersForWare.{$idx}"/>
                  <set_value name="$offerSector" exact="@$offer.owner.sector"/>
                  <do_if value="$offerSector?">
                    <set_value name="$offerSectorName" exact="@$offerSector.knownname"/>
                    <do_if value="$offerSector == $currentSector">
                      <append_to_list name="$filteredBuyOffers" exact="$offer"/>
                    </do_if>
                    <do_elseif value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging and $idx le 3">
                      <!-- Debug first 3 offers to verify sector comparison -->
                      <debug_text text="'[GT-Batch] (' + $ship.idcode + ') BUY OFFER #' + $idx + ': Offer sector=' + (if $offerSectorName? then $offerSectorName else 'NULL') + ', Current sector=' + (if $currentSectorName? then $currentSectorName else 'NULL') + ', Match=' + ($offerSector == $currentSector)" chance="100"/>
                    </do_elseif>
                  </do_if>
                </do_all>
                <set_value name="$buyOffersForWare" exact="$filteredBuyOffers"/>
                
                <!-- Debug log filtered counts -->
                <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <set_value name="$wareName" exact="if $ware? then @$ware.name else 'NULL'"/>
                  <debug_text text="'[GT-Batch] (' + $ship.idcode + ') ISOLATED FILTER: ' + $wareName + ' in ' + (if $currentSectorName? then $currentSectorName else 'NULL') + ' - Filtered to ' + $sellOffersForWare.count + ' sell, ' + $buyOffersForWare.count + ' buy (current sector only)'" chance="100"/>
                </do_if>
              </do_if>
              
              <!-- Limit sell offers BEFORE nested loop (take first N = cheapest = best buyers) -->
              <do_if value="$sellOffersForWare.count gt $maxOffersPerWareForMatching">
                <!-- Simple approach: Take first N offers (they're already ordered by relativeprice from batch) -->
                <set_value name="$limitedSellOffers" exact="[]"/>
                <do_all exact="$maxOffersPerWareForMatching" counter="$idx">
                  <append_to_list name="$limitedSellOffers" exact="$sellOffersForWare.{$idx}"/>
                </do_all>
                <set_value name="$sellOffersForWare" exact="$limitedSellOffers"/>
              </do_if>
              
              <!-- Limit buy offers BEFORE nested loop (take last N = highest payers = best profit) -->
              <do_if value="$buyOffersForWare.count gt $maxOffersPerWareForMatching">
                <!-- Take last N offers (highest payers = best profit) -->
                <set_value name="$limitedBuyOffers" exact="[]"/>
                <set_value name="$startIndex" exact="$buyOffersForWare.count - $maxOffersPerWareForMatching"/>
                <do_all exact="$maxOffersPerWareForMatching" counter="$idx">
                  <set_value name="$actualIndex" exact="$startIndex + $idx"/>
                  <append_to_list name="$limitedBuyOffers" exact="$buyOffersForWare.{$actualIndex}"/>
                </do_all>
                <set_value name="$buyOffersForWare" exact="$limitedBuyOffers"/>
              </do_if>
              
              <!-- Always include intra-sector offers for matching (even if not top-priced) -->
              <!-- Scenario: Ship in non-blacklisted sector, but all routes to other sectors blocked by blacklist -->
              <!-- Solution: Ensure intra-sector trades are always considered for matching -->
              <!-- Do NOT include intra-sector offers if ship is in blacklisted sector (escape priority) -->
              <!-- Note: $currentSector already set above for isolated filter -->
              <do_if value="not $currentSector?">
                <set_value name="$currentSector" exact="$ship.sector"/>
              </do_if>
              <set_value name="$currentSectorIsBlacklisted" exact="false"/>
              <do_if value="$currentSector?">
                <!-- Check if current sector is blacklisted (if yes, skip intra-sector offers to force escape) -->
                <run_actions ref="md.GT_Libraries_Blacklist.GT_GetBlacklistGroup" result="$blacklistgroup">
                  <param name="ship" value="$ship"/>
                </run_actions>
                <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$currentSectorIsBlacklisted">
                  <param name="sector" value="$currentSector"/>
                  <param name="ship" value="$ship"/>
                  <param name="blacklistgroup" value="$blacklistgroup"/>
                </run_actions>
              </do_if>
              <!-- Use library function to add intra-sector offers -->
              <run_actions ref="md.GT_Libraries_General.GT_AddIntraSectorOffers" result="$intraSectorResult">
                <param name="originalSellOffers" value="$originalSellOffers"/>
                <param name="originalBuyOffers" value="$originalBuyOffers"/>
                <param name="limitedSellOffers" value="$sellOffersForWare"/>
                <param name="limitedBuyOffers" value="$buyOffersForWare"/>
                <param name="currentSector" value="$currentSector"/>
                <param name="currentSectorIsBlacklisted" value="$currentSectorIsBlacklisted"/>
              </run_actions>
              <set_value name="$sellOffersForWare" exact="$intraSectorResult.$UpdatedSellOffers"/>
              <set_value name="$buyOffersForWare" exact="$intraSectorResult.$UpdatedBuyOffers"/>
              
              <!-- DEBUG: Log if intra-sector offers were added -->
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging and ($intraSectorResult.$AddedSellCount gt 0 or $intraSectorResult.$AddedBuyCount gt 0)">
                <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Added intra-sector offers for ' + (if $ware? then @$ware.name else 'NULL') + ' in ' + @$currentSector.knownname + ': ' + $intraSectorResult.$AddedSellCount + ' sell, ' + $intraSectorResult.$AddedBuyCount + ' buy (beyond top ' + $maxOffersPerWareForMatching + ')'" chance="100"/>
              </do_if>
              
              <!-- ═══════════════════════════════════════════════════════════════════════════ -->
              <!-- Pre-cache docking permissions BEFORE nested loops -->
              <!-- Reduces property lookups from 400,000+ to ~40-100 (99.98% reduction) -->
              <!-- ═══════════════════════════════════════════════════════════════════════════ -->
              <run_actions ref="md.GT_Libraries_General.GT_BuildDockingCache" result="$dockingCache">
                <param name="sellOffers" value="$sellOffersForWare"/>
                <param name="buyOffers" value="$buyOffersForWare"/>
                <param name="ship" value="$ship"/>
              </run_actions>
              
              <!-- Separate intra-sector offers for prioritized matching -->
              <!-- This ensures intra-sector offers match with each other to create true intra-sector trades -->
              <run_actions ref="md.GT_Libraries_General.GT_SeparateOffersBySector" result="$separatedOffers">
                <param name="sellOffers" value="$sellOffersForWare"/>
                <param name="buyOffers" value="$buyOffersForWare"/>
                <param name="currentSector" value="$currentSector"/>
              </run_actions>
              <set_value name="$intraSectorSellOffers" exact="$separatedOffers.$IntraSectorSell"/>
              <set_value name="$intraSectorBuyOffers" exact="$separatedOffers.$IntraSectorBuy"/>
              <set_value name="$crossSectorSellOffers" exact="$separatedOffers.$CrossSectorSell"/>
              <set_value name="$crossSectorBuyOffers" exact="$separatedOffers.$CrossSectorBuy"/>
              
              <!-- Log separation results for isolated ships -->
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging and $shipIsIsolated">
                <set_value name="$wareName" exact="if $ware? then @$ware.name else 'NULL'"/>
                <set_value name="$sectorName" exact="if $currentSector? then @$currentSector.knownname else 'NULL'"/>
                <debug_text text="'[GT-Batch-DEBUG] (' + $ship.idcode + ') SEPARATION for ' + $wareName + ' in ' + $sectorName + ': Total=' + $sellOffersForWare.count + ' sell, ' + $buyOffersForWare.count + ' buy | Intra=' + $intraSectorSellOffers.count + ' sell, ' + $intraSectorBuyOffers.count + ' buy | Cross=' + $crossSectorSellOffers.count + ' sell, ' + $crossSectorBuyOffers.count + ' buy'" chance="100"/>
              </do_if>
              
              <!-- NOW run nested loops: PRIORITIZE intra-sector matches first -->
              <!-- Phase 1: Match intra-sector sell offers with intra-sector buy offers (TRUE intra-sector trades) -->
              <!-- Log Phase 1 availability -->
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <set_value name="$wareName" exact="if $ware? then @$ware.name else 'NULL'"/>
                <set_value name="$sectorName" exact="if $currentSector? then @$currentSector.knownname else 'NULL'"/>
                <set_value name="$isolationLabel" exact="if $shipIsIsolated then ' [ISOLATED]' else ''"/>
                <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Phase 1 (INTRA-SECTOR)' + $isolationLabel + ' for ' + $wareName + ' in ' + $sectorName + ': ' + $intraSectorSellOffers.count + ' sell, ' + $intraSectorBuyOffers.count + ' buy offers' + (if ($intraSectorSellOffers.count == 0 or $intraSectorBuyOffers.count == 0) then '  MISSING ONE TYPE!' else '')" chance="100"/>
              </do_if>
              <do_if value="$intraSectorSellOffers.count gt 0 and $intraSectorBuyOffers.count gt 0">
                <do_all exact="$intraSectorSellOffers.count" counter="$i">
                  <set_value name="$sellOffer" exact="$intraSectorSellOffers.{$i}"/>
                
                <do_all exact="$intraSectorBuyOffers.count" counter="$j">
                  <set_value name="$buyOffer" exact="$intraSectorBuyOffers.{$j}"/>
                  
                  <!-- OPTIMIZATION: Use library function to validate offer pair -->
                  <run_actions ref="md.GT_Libraries_General.GT_ValidateTradeOfferPair" result="$isValidPair">
                    <param name="sellOffer" value="$sellOffer"/>
                    <param name="buyOffer" value="$buyOffer"/>
                  </run_actions>
                  <do_if value="not $isValidPair">
                    <continue/>
                  </do_if>
                  
                  <!-- Extract offer properties after validation -->
                  <set_value name="$sellOfferOwner" exact="@$sellOffer.owner"/>
                  <set_value name="$sellOfferPrice" exact="@$sellOffer.unitprice"/>
                  <set_value name="$buyOfferOwner" exact="@$buyOffer.owner"/>
                  <set_value name="$buyOfferPrice" exact="@$buyOffer.unitprice"/>
                  
                  <!-- Full trade creation logic for true intra-sector matches -->
                    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
                    <!-- OPTIMIZATION 3: Early profit rejection (skip impossible trades instantly) -->
                    <set_value name="$buyPrice" exact="$sellOfferPrice"/>
                    <set_value name="$sellPrice" exact="$buyOfferPrice"/>
                    
                    <do_if value="$sellPrice le $buyPrice">
                      <set_value name="$tradesRejectedProfit" operation="add"/>
                      <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                        <set_value name="$wareName" exact="if $ware? then @$ware.name else 'NULL'"/>
                        <set_value name="$buyStationName" exact="if $sellOfferOwner? then @$sellOfferOwner.knownname else 'NULL'"/>
                        <set_value name="$sellStationName" exact="if $buyOfferOwner? then @$buyOfferOwner.knownname else 'NULL'"/>
                        <debug_text text="'[GT-Batch] (' + $ship.idcode + ') INTRA-SECTOR REJECTED (no profit): ' + $wareName + ' (Buy: ' + $buyStationName + ' @ ' + ($buyPrice/100) + ' Cr, Sell: ' + $sellStationName + ' @ ' + ($sellPrice/100) + ' Cr - sellPrice le buyPrice)'" chance="100"/>
                      </do_if>
                      <continue/>
                    </do_if>
                    
                    <!-- OPTIMIZATION #2: Use CACHED docking permissions (pre-cached before loop) -->
                    <set_value name="$canDockAtBuyStation" exact="@$dockingCache.{$sellOfferOwner}"/>
                    <set_value name="$canDockAtSellStation" exact="@$dockingCache.{$buyOfferOwner}"/>
                    
                    <do_if value="not $canDockAtBuyStation or not $canDockAtSellStation">
                      <set_value name="$tradesRejectedDocking" operation="add"/>
                      <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                        <set_value name="$wareName" exact="if $ware? then @$ware.name else 'NULL'"/>
                        <set_value name="$buyStationName" exact="if $sellOfferOwner? then @$sellOfferOwner.knownname else 'NULL'"/>
                        <set_value name="$sellStationName" exact="if $buyOfferOwner? then @$buyOfferOwner.knownname else 'NULL'"/>
                        <set_value name="$dockBuy" exact="if $canDockAtBuyStation then 'YES' else 'NO'"/>
                        <set_value name="$dockSell" exact="if $canDockAtSellStation then 'YES' else 'NO'"/>
                        <debug_text text="'[GT-Batch] (' + $ship.idcode + ') INTRA-SECTOR REJECTED (docking): ' + $wareName + ' (Buy: ' + $buyStationName + ' dock=' + $dockBuy + ', Sell: ' + $sellStationName + ' dock=' + $dockSell + ')'" chance="100"/>
                      </do_if>
                      <continue/>
                    </do_if>
                    
                    <!-- OPTIMIZATION: Use library function to calculate max tradeable amount -->
                    <set_value name="$sellOfferWare" exact="@$sellOffer.ware"/>
                    <set_value name="$sellOfferAmount" exact="@$sellOffer.amount"/>
                    <set_value name="$buyOfferAmount" exact="@$buyOffer.amount"/>
                    <do_if value="not $sellOfferWare? or not $sellOfferAmount? or not $buyOfferAmount?">
                      <continue/>
                    </do_if>
                    <run_actions ref="md.GT_Libraries_General.GT_CalculateMaxTradeableAmount" result="$maxAmount">
                      <param name="ship" value="$ship"/>
                      <param name="ware" value="$sellOfferWare"/>
                      <param name="buyOfferAmount" value="$buyOfferAmount"/>
                      <param name="sellOfferAmount" value="$sellOfferAmount"/>
                      <param name="availableMoney" value="$availableMoney"/>
                      <param name="buyPrice" value="$buyPrice"/>
                    </run_actions>
                    
                    <do_if value="$maxAmount le 0">
                      <set_value name="$tradesRejectedAmount" operation="add"/>
                      <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                        <set_value name="$wareName" exact="if $ware? then @$ware.name else 'NULL'"/>
                        <set_value name="$buyStationName" exact="if $sellOfferOwner? then @$sellOfferOwner.knownname else 'NULL'"/>
                        <set_value name="$sellStationName" exact="if $buyOfferOwner? then @$buyOfferOwner.knownname else 'NULL'"/>
                        <set_value name="$offerAmount" exact="if $sellOfferAmount? then $sellOfferAmount else 0"/>
                        <set_value name="$buyAmount" exact="if $buyOfferAmount? then $buyOfferAmount else 0"/>
                        <set_value name="$cargoCap" exact="if $maxCargoCapacity? then $maxCargoCapacity else 0"/>
                        <set_value name="$affordable" exact="if $maxAffordable? then $maxAffordable else 0"/>
                        <debug_text text="'[GT-Batch] (' + $ship.idcode + ') INTRA-SECTOR REJECTED (zero amount): ' + $wareName + ' (maxAmount=' + $maxAmount + ', offer=' + $offerAmount + ', buy=' + $buyAmount + ', cargo=' + $cargoCap + ', money=' + $affordable + ')'" chance="100"/>
                      </do_if>
                      <continue/>
                    </do_if>
                    
                    <!-- OPTIMIZATION: Use library functions to calculate profit, ROI, and thresholds -->
                    <run_actions ref="md.GT_Libraries_General.GT_CalculateProfit" result="$profit">
                      <param name="buyPrice" value="$buyPrice"/>
                      <param name="sellPrice" value="$sellPrice"/>
                      <param name="amount" value="$maxAmount"/>
                    </run_actions>
                    <run_actions ref="md.GT_Libraries_General.GT_CalculateROI" result="$roi">
                      <param name="investment" value="$buyPrice * $maxAmount"/>
                      <param name="profit" value="$profit"/>
                    </run_actions>
                    
                    <!-- OPTIMIZATION: Use library function to calculate trade thresholds -->
                    <run_actions ref="md.GT_Libraries_General.GT_CalculateTradeThresholds" result="$thresholds">
                      <param name="minROI" value="$minROI"/>
                      <param name="minAbsoluteProfit" value="$minAbsoluteProfit"/>
                      <param name="useAdvancedAnalytics" value="$gt_AdvancedAnalytics"/>
                      <param name="isIntraSector" value="true"/>
                      <param name="isIsolated" value="$shipIsIsolated"/>
                    </run_actions>
                    <set_value name="$roiThreshold" exact="$thresholds.$ROIThreshold"/>
                    <set_value name="$profitThreshold" exact="$thresholds.$ProfitThreshold"/>
                    
                    <do_if value="$roi lt $roiThreshold or $profit lt $profitThreshold">
                      <set_value name="$tradesRejectedProfit" operation="add"/>
                      <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                        <set_value name="$wareName" exact="if $ware? then @$ware.name else 'NULL'"/>
                        <set_value name="$buyStationName" exact="if $sellOfferOwner? then @$sellOfferOwner.knownname else 'NULL'"/>
                        <set_value name="$sellStationName" exact="if $buyOfferOwner? then @$buyOfferOwner.knownname else 'NULL'"/>
                        <set_value name="$thresholdLabel" exact="if $shipIsIsolated then ' (25% threshold for ISOLATED)' else ' (50% threshold for intra-sector)'"/>
                        <debug_text text="'[GT-Batch] (' + $ship.idcode + ') INTRA-SECTOR REJECTED (profit/ROI too low)' + $thresholdLabel + ': ' + $wareName + ' (Profit: ' + ($profit/100) + ' Cr lt ' + ($profitThreshold/100) + ' Cr, ROI: ' + ($roi/1) + '% lt ' + ($roiThreshold/1) + '%, BaseMinProfit: ' + ($minAbsoluteProfit/100) + ' Cr)'" chance="100"/>
                      </do_if>
                      <continue/>
                    </do_if>
                    
                    <!-- INTRA-SECTOR: Distance is always 0 (both in same sector) -->
                    <set_value name="$buyDistance" exact="0"/>
                    <set_value name="$sellDistance" exact="0"/>
                    <set_value name="$routeDistance" exact="0"/>
                    
                    <!-- OPTIMIZATION: Use library function to calculate trade efficiency -->
                    <set_value name="$sellOfferOwnerOwner" exact="@$sellOfferOwner.owner"/>
                    <set_value name="$buyOfferOwnerOwner" exact="@$buyOfferOwner.owner"/>
                    <run_actions ref="md.GT_Libraries_General.GT_CalculateTradeEfficiency" result="$efficiency">
                      <param name="profit" value="$profit"/>
                      <param name="distance" value="0"/>
                      <param name="distancePenaltyMultiplier" value="1.0"/>
                      <param name="factionPriority" value="$factionPriority"/>
                      <param name="buyStationOwner" value="$sellOfferOwnerOwner"/>
                      <param name="sellStationOwner" value="$buyOfferOwnerOwner"/>
                    </run_actions>
                    
                    <!-- Extract sectors (both are current sector for intra-sector trades) -->
                    <set_value name="$buySector" exact="@$sellOfferOwner.sector"/>
                    <set_value name="$sellSector" exact="@$buyOfferOwner.sector"/>
                    
                    <!-- OPTIMIZATION: Use library function to check failed sector pair -->
                    <run_actions ref="md.GT_Libraries_General.GT_CheckFailedSectorPair" result="$isFailedSectorPair">
                      <param name="buySector" value="$buySector"/>
                      <param name="sellSector" value="$sellSector"/>
                      <param name="failedTrades" value="$failedTrades"/>
                    </run_actions>
                    
                    <!-- INTRA-SECTOR: Create trade (respect ware quota) -->
                    <do_if value="not $isFailedSectorPair and $tradesForThisWare lt $maxTradesPerWare">
                      <!-- DEBUG: Log price verification before storing -->
                      <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                        <debug_text text="'[GT-Batch] (' + $ship.idcode + ') PRICE VERIFICATION for intra-sector trade:' + 
                          '\n  sellOfferPrice (RAW): ' + $sellOfferPrice + ' = ' + ($sellOfferPrice/100) + ' Cr' +
                          '\n  buyOfferPrice (RAW): ' + $buyOfferPrice + ' = ' + ($buyOfferPrice/100) + ' Cr' +
                          '\n  $buyPrice (stored, RAW): ' + $buyPrice + ' = ' + ($buyPrice/100) + ' Cr' +
                          '\n  $sellPrice (stored, RAW): ' + $sellPrice + ' = ' + ($sellPrice/100) + ' Cr' +
                          '\n  Profit (RAW): ' + $profit + ' = ' + ($profit/100) + ' Cr' +
                          '\n  Calculated profit check: (' + ($sellPrice/100) + ' - ' + ($buyPrice/100) + ') * ' + $maxAmount + ' = ' + (($sellPrice - $buyPrice) * $maxAmount / 100) + ' Cr'" chance="100"/>
                      </do_if>
                      <!-- OPTIMIZATION: Use library function to create trade object -->
                      <run_actions ref="md.GT_Libraries_General.GT_CreateTradeObject" result="$trade">
                        <param name="sellOffer" value="$sellOffer"/>
                        <param name="buyOffer" value="$buyOffer"/>
                        <param name="sellStation" value="$sellOfferOwner"/>
                        <param name="buyStation" value="$buyOfferOwner"/>
                        <param name="amount" value="$maxAmount"/>
                        <param name="profit" value="$profit"/>
                        <param name="roi" value="$roi"/>
                        <param name="efficiency" value="$efficiency"/>
                        <param name="buyPrice" value="$buyPrice"/>
                        <param name="sellPrice" value="$sellPrice"/>
                        <param name="distance" value="$routeDistance"/>
                        <param name="risk" value="0"/>
                      </run_actions>
                      
                      <append_to_list name="$tradeList" exact="$trade"/>
                      
                      <!-- OPTIMIZATION: Use library function to update trade quota -->
                      <run_actions ref="md.GT_Libraries_General.GT_UpdateTradeQuota" result="$quotaResult">
                        <param name="tradesPerWare" value="$tradesPerWare"/>
                        <param name="ware" value="$ware"/>
                        <param name="increment" value="1"/>
                      </run_actions>
                      <set_value name="$tradesPerWare" exact="$quotaResult.$UpdatedTable"/>
                      <set_value name="$tradesForThisWare" exact="$quotaResult.$NewCount"/>
                      
                      <do_if value="$tradesForThisWare ge $maxTradesPerWare">
                        <break/>
                      </do_if>
                      
                      <do_if value="$efficiency gt $crossStationBestScore">
                        <set_value name="$crossStationBestScore" exact="$efficiency"/>
                        <set_value name="$crossStationBestTrade" exact="$trade"/>
                      </do_if>
                      
                      <!-- OPTIMIZATION: Use library function to check route conflict -->
                      <run_actions ref="md.GT_Libraries_General.GT_CheckRouteConflict" result="$routeConflicted">
                        <param name="sellStation" value="$sellOfferOwner"/>
                        <param name="buyStation" value="$buyOfferOwner"/>
                        <param name="ware" value="$sellOfferWare"/>
                        <param name="reservedRoutes" value="$reservedRoutes"/>
                      </run_actions>
                      
                      <do_if value="not $routeConflicted and not $isFailedSectorPair and $efficiency gt $nonConflictedBestScore">
                        <set_value name="$nonConflictedBestScore" exact="$efficiency"/>
                        <set_value name="$nonConflictedBestTrade" exact="$trade"/>
                      </do_if>
                      
                      <!-- DEBUG: Log intra-sector trade creation -->
                      <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                        <set_value name="$isolationLabel" exact="if $shipIsIsolated then ' [ISOLATED - routes blocked]' else ''"/>
                        <debug_text text="'[GT-Batch] (' + $ship.idcode + ') INTRA-SECTOR trade created' + $isolationLabel + ': ' + (if $sellOfferWare? then @$sellOfferWare.name else 'NULL') + ' in ' + @$currentSector.knownname + ' (Profit: ' + ($profit/100) + ' Cr, ROI: ' + ($roi/1) + '%, Score: ' + ($efficiency/1) + ')'" chance="100"/>
                      </do_if>
                    </do_if>
                </do_all>
                
                <do_if value="$tradesForThisWare ge $maxTradesPerWare">
                  <break/>
                </do_if>
              </do_all>
            </do_if>
            <do_else>
              <!-- DEBUG: Log when Phase 1 can't run -->
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging and $shipIsIsolated">
                <set_value name="$wareName" exact="if $ware? then @$ware.name else 'NULL'"/>
                <set_value name="$sectorName" exact="if $currentSector? then @$currentSector.knownname else 'NULL'"/>
                <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Phase 1 (INTRA-SECTOR) SKIPPED [ISOLATED]: ' + $wareName + ' in ' + $sectorName + ' - ' + $intraSectorSellOffers.count + ' sell, ' + $intraSectorBuyOffers.count + ' buy (need BOTH > 0)'" chance="100"/>
              </do_if>
            </do_else>
            
            <!-- Phase 2: Match all remaining offers (cross-sector with cross-sector, or mixed) -->
            <!-- SKIP if ship is isolated - isolated ships can only trade intra-sector -->
            <do_if value="not $shipIsIsolated">
              <!-- NOW run nested loops on LIMITED offers with CACHED docking -->
              <do_all exact="$sellOffersForWare.count" counter="$i">
                <set_value name="$sellOffer" exact="$sellOffersForWare.{$i}"/>
                
                <do_all exact="$buyOffersForWare.count" counter="$j">
                  <set_value name="$buyOffer" exact="$buyOffersForWare.{$j}"/>
                  
                  <!-- OPTIMIZATION: Use library function to validate offer pair -->
                  <run_actions ref="md.GT_Libraries_General.GT_ValidateTradeOfferPair" result="$isValidPair">
                    <param name="sellOffer" value="$sellOffer"/>
                    <param name="buyOffer" value="$buyOffer"/>
                  </run_actions>
                  <do_if value="not $isValidPair">
                    <continue/>
                  </do_if>
                  
                  <!-- Extract offer properties after validation -->
                  <set_value name="$sellOfferOwner" exact="@$sellOffer.owner"/>
                  <set_value name="$sellOfferPrice" exact="@$sellOffer.unitprice"/>
                  <set_value name="$buyOfferOwner" exact="@$buyOffer.owner"/>
                  <set_value name="$buyOfferPrice" exact="@$buyOffer.unitprice"/>
                  
                  <!-- Skip if this is already an intra-sector match (we processed those separately) -->
                    <set_value name="$sellOfferSector" exact="@$sellOfferOwner.sector"/>
                    <set_value name="$buyOfferSector" exact="@$buyOfferOwner.sector"/>
                    <do_if value="$sellOfferSector? and $buyOfferSector? and $currentSector?">
                      <do_if value="$sellOfferSector == $currentSector and $buyOfferSector == $currentSector">
                        <!-- This is an intra-sector match - skip since we already processed these -->
                        <continue/>
                      </do_if>
                    </do_if>
                    
                    <!-- Process cross-sector or mixed trade -->
                    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
                    <!-- OPTIMIZATION 3: Early profit rejection (skip impossible trades instantly) -->
                    <!-- Use already-extracted safe values -->
                    <set_value name="$buyPrice" exact="$sellOfferPrice"/>
                    <set_value name="$sellPrice" exact="$buyOfferPrice"/>
                    
                    <!-- OPTIMIZATION: Use library function to calculate max tradeable amount -->
                    <!-- Use @ operator for safe property access -->
                    <set_value name="$sellOfferWare" exact="@$sellOffer.ware"/>
                    <set_value name="$sellOfferAmount" exact="@$sellOffer.amount"/>
                    <set_value name="$buyOfferAmount" exact="@$buyOffer.amount"/>
                    <do_if value="not $sellOfferWare? or not $sellOfferAmount? or not $buyOfferAmount?">
                      <continue/>
                    </do_if>
                    <run_actions ref="md.GT_Libraries_General.GT_CalculateMaxTradeableAmount" result="$maxAmount">
                      <param name="ship" value="$ship"/>
                      <param name="ware" value="$sellOfferWare"/>
                      <param name="buyOfferAmount" value="$buyOfferAmount"/>
                      <param name="sellOfferAmount" value="$sellOfferAmount"/>
                      <param name="availableMoney" value="$availableMoney"/>
                      <param name="buyPrice" value="$buyPrice"/>
                    </run_actions>
                    
                    <do_if value="$maxAmount le 0">
                      <set_value name="$tradesRejectedAmount" operation="add"/>
                      <continue/>
                    </do_if>
                    
                    <!-- OPTIMIZATION: Use library functions to calculate profit and ROI -->
                    <run_actions ref="md.GT_Libraries_General.GT_CalculateProfit" result="$profit">
                      <param name="buyPrice" value="$buyPrice"/>
                      <param name="sellPrice" value="$sellPrice"/>
                      <param name="amount" value="$maxAmount"/>
                    </run_actions>
                    <run_actions ref="md.GT_Libraries_General.GT_CalculateROI" result="$roi">
                      <param name="investment" value="$buyPrice * $maxAmount"/>
                      <param name="profit" value="$profit"/>
                    </run_actions>
                    
                    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
                    <!-- CACHE FIRST: Cache ALL profitable trades BEFORE any filtering -->
                    <!-- This ensures cache contains all trades that ANY ship might accept -->
                    <!-- Blacklist filtering happens when READING from cache (SearchCachedTrades) -->
                    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
                    <!-- Cache trade if enabled and meets global cache threshold -->
                    <!-- CRITICAL: Cache respects global CacheProfitThreshold setting -->
                    <!-- Universal cache: no ship-specific filters, but must meet global minimum -->
                    <do_if value="global.$GT_GlobalSettings.$Fleet.$EnableTradeCache">
                      <!-- Get cache threshold from global settings (default 20%) -->
                      <set_value name="$cacheThreshold" exact="20"/>
                      <do_if value="global.$GT_GlobalSettings.$Fleet.$CacheProfitThreshold?">
                        <set_value name="$cacheThreshold" exact="global.$GT_GlobalSettings.$Fleet.$CacheProfitThreshold"/>
                      </do_if>
                      
                      <!-- DIAGNOSTIC: Log why trades aren't being cached (only if cache is empty) -->
                      <!-- PERFORMANCE OPTIMIZATION v5: Calculate total cache count from all home sectors -->
                      <!-- Use library function for cache count calculation -->
                      <run_actions ref="md.GT_Libraries_General.GT_CalculateTotalCacheCount" result="$currentCacheCount"/>
                      <do_if value="$currentCacheCount == 0 and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                        <!-- Cache is empty - log why trades aren't meeting cache requirements -->
                        <do_if value="$profit le 0">
                          <debug_text text="'[GT-Cache-DIAG] Trade NOT cached: Profit le 0 (Profit=' + ($profit/100) + ' Cr, ROI=' + ($roi/1) + '%)'" chance="10"/>
                        </do_if>
                        <do_elseif value="$roi lt $cacheThreshold">
                          <debug_text text="'[GT-Cache-DIAG] Trade NOT cached: ROI below threshold (ROI=' + ($roi/1) + '% lt Threshold=' + ($cacheThreshold/1) + '%, Profit=' + ($profit/100) + ' Cr)'" chance="10"/>
                        </do_elseif>
                      </do_if>
                      
                      <!-- Only cache trades that meet global cache profit threshold -->
                      <do_if value="$profit gt 0 and $roi ge $cacheThreshold">
                        <!-- Validate required data exists before caching -->
                        <!-- Debug: Log why trades aren't cached -->
                        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging and not ($sellOfferWare? and $sellOfferOwner? and $buyOfferOwner?)">
                          <debug_text text="'[GT-Cache-DEBUG] ⚠ Trade NOT cached (validation failed): ROI=' + ($roi/1) + '%, Profit=' + ($profit/100) + ' Cr, sellOfferWare=' + ($sellOfferWare? and 'OK' or 'NULL') + ', sellOfferOwner=' + ($sellOfferOwner? and 'OK' or 'NULL') + ', buyOfferOwner=' + ($buyOfferOwner? and 'OK' or 'NULL')" chance="20"/>
                        </do_if>
                        <do_if value="$sellOfferWare? and $sellOfferOwner? and $buyOfferOwner?">
                          <!-- SIMPLIFIED: Initialization guarantees global.$GT_TradeCache exists -->
                          <!-- Extract sectors for route distance (needed for cache entry) -->
                          <set_value name="$buySector" exact="@$sellOfferOwner.sector"/>
                          <set_value name="$sellSector" exact="@$buyOfferOwner.sector"/>
                          <set_value name="$routeDistance" exact="0"/>
                          <do_if value="$buySector? and $sellSector?">
                            <do_if value="$buySector == $sellSector">
                              <set_value name="$routeDistance" exact="0"/>
                            </do_if>
                            <do_else>
                              <!-- UNIVERSAL CACHE: Use range-only distance (NO blacklist params) -->
                              <set_value name="$routeDistance" exact="$buySector.gatedistance.{$sellSector}"/>
                              <do_if value="$routeDistance lt 0">
                                <!-- No path available - distance invalid -->
                                <set_value name="$routeDistance" exact="-1"/>
                              </do_if>
                            </do_else>
                          </do_if>
                          
                          <!-- PERFORMANCE OPTIMIZATION v5: Per-home-sector cache with pre-computed distances -->
                          <!-- Only cache if home sector is valid -->
                          <do_if value="@$homeSector.exists">
                            <!-- Initialize home sector cache if needed -->
                            <do_if value="not global.$GT_TradeCache.{$homeSector}?">
                              <set_value name="global.$GT_TradeCache.{$homeSector}" exact="[]"/>
                            </do_if>
                            
                            <!-- CACHE DIVERSITY: Per-ware limit of 50 entries (per home sector) -->
                            <!-- Count existing entries for this ware in THIS home sector's cache -->
                            <set_value name="$wareEntryCount" exact="0"/>
                            <set_value name="$oldestWareEntryIdx" exact="-1"/>
                            <set_value name="$oldestWareEntryTimestamp" exact="player.age"/>
                            <set_value name="$homeSectorCache" exact="global.$GT_TradeCache.{$homeSector}"/>
                            <do_all exact="$homeSectorCache.count" counter="$cacheIdx">
                              <set_value name="$cachedEntry" exact="$homeSectorCache.{$cacheIdx}"/>
                              <do_if value="$cachedEntry? and $cachedEntry.$WareId == $sellOfferWare.id">
                                <set_value name="$wareEntryCount" exact="$wareEntryCount + 1"/>
                                <!-- Track oldest entry for this ware (for replacement if at limit) -->
                                <do_if value="$cachedEntry.$Timestamp? and $cachedEntry.$Timestamp lt $oldestWareEntryTimestamp">
                                  <set_value name="$oldestWareEntryTimestamp" exact="$cachedEntry.$Timestamp"/>
                                  <set_value name="$oldestWareEntryIdx" exact="$cacheIdx"/>
                                </do_if>
                              </do_if>
                            </do_all>
                            
                            <!-- If this ware already has 50 entries in this home sector, replace the oldest one -->
                            <do_if value="$wareEntryCount ge 50">
                              <do_if value="$oldestWareEntryIdx ge 0">
                                <!-- Remove oldest entry for this ware from this home sector's cache -->
                                <remove_value name="global.$GT_TradeCache.{$homeSector}.{$oldestWareEntryIdx}"/>
                              </do_if>
                            </do_if>
                            
                            <!-- Calculate total volume for cache entry (amount × ware.volume) -->
                            <set_value name="$totalVolume" exact="$maxAmount * $sellOfferWare.volume"/>
                            
                            <!-- PERFORMANCE OPTIMIZATION: Pre-compute distances from home sector ONCE during caching -->
                            <!-- These distances are the same for all ships with this home sector -->
                            <set_value name="$homeToBuyDistance" exact="-1"/>
                            <set_value name="$homeToSellDistance" exact="-1"/>
                            <do_if value="$buySector? and $sellSector?">
                              <set_value name="$homeToBuyDistance" exact="$homeSector.gatedistance.{$buySector}"/>
                              <set_value name="$homeToSellDistance" exact="$homeSector.gatedistance.{$sellSector}"/>
                              <!-- Handle invalid distances -->
                              <do_if value="$homeToBuyDistance lt 0">
                                <set_value name="$homeToBuyDistance" exact="-1"/>
                              </do_if>
                              <do_if value="$homeToSellDistance lt 0">
                                <set_value name="$homeToSellDistance" exact="-1"/>
                              </do_if>
                            </do_if>
                            
                            <!-- Cache target types (for cache-side filtering) -->
                            <!-- Buy target = owner of $BuyOffer (= $sellOfferOwner) -->
                            <!-- Sell target = owner of $SellOffer (= $buyOfferOwner) -->
                            <set_value name="$buyTargetType" exact="'Station'"/>
                            <do_if value="$sellOfferOwner.isclass.buildstorage">
                              <set_value name="$buyTargetType" exact="'Buildstorage'"/>
                            </do_if>
                            <do_elseif value="$sellOfferOwner.isclass.station">
                              <set_value name="$buyPrimaryPurpose" exact="@$sellOfferOwner.primarypurpose"/>
                              <do_if value="$buyPrimaryPurpose == purpose.auxiliary">
                                <set_value name="$buyTargetType" exact="'Aux'"/>
                              </do_if>
                              <do_elseif value="$buyPrimaryPurpose == purpose.fight">
                                <set_value name="$buyTargetType" exact="'Carrier'"/>
                              </do_elseif>
                            </do_elseif>
                            
                            <set_value name="$sellTargetType" exact="'Station'"/>
                            <do_if value="$buyOfferOwner.isclass.buildstorage">
                              <set_value name="$sellTargetType" exact="'Buildstorage'"/>
                            </do_if>
                            <do_elseif value="$buyOfferOwner.isclass.station">
                              <set_value name="$sellPrimaryPurpose" exact="@$buyOfferOwner.primarypurpose"/>
                              <do_if value="$sellPrimaryPurpose == purpose.auxiliary">
                                <set_value name="$sellTargetType" exact="'Aux'"/>
                              </do_if>
                              <do_elseif value="$sellPrimaryPurpose == purpose.fight">
                                <set_value name="$sellTargetType" exact="'Carrier'"/>
                              </do_elseif>
                            </do_elseif>
                            
                            <!-- Cache docking capability profile (physical docks by size) -->
                            <!-- Used by cache search to skip trades that cannot physically dock for a ship's docksize -->
                            <!-- NOTE: This is physical capability only (no relation/permission). -->
                            <do_if value="not global.$GT_DockCapsCache?">
                              <set_value name="global.$GT_DockCapsCache" exact="table[]"/>
                            </do_if>
                            
                            <!-- Buy station (= seller of BuyOffer / $sellOfferOwner) -->
                            <set_value name="$buyDockCaps" exact="null"/>
                            <do_if value="global.$GT_DockCapsCache.{$sellOfferOwner}?">
                              <set_value name="$buyDockCaps" exact="global.$GT_DockCapsCache.{$sellOfferOwner}"/>
                            </do_if>
                            <do_else>
                              <set_value name="$buyDockCaps" exact="table[$S=false, $M=false, $L=false, $XL=false]"/>
                              
                              <find_dockingbay name="$buyDockS" object="$sellOfferOwner" checkoperational="true" multiple="false">
                                <match_dock size="tag.dock_s" storage="false"/>
                              </find_dockingbay>
                              <do_if value="$buyDockS">
                                <set_value name="$buyDockCaps.$S" exact="true"/>
                              </do_if>
                              
                              <find_dockingbay name="$buyDockM" object="$sellOfferOwner" checkoperational="true" multiple="false">
                                <match_dock size="tag.dock_m" storage="false"/>
                              </find_dockingbay>
                              <do_if value="$buyDockM">
                                <set_value name="$buyDockCaps.$M" exact="true"/>
                              </do_if>
                              
                              <find_dockingbay name="$buyDockL" object="$sellOfferOwner" checkoperational="true" multiple="false">
                                <match_dock size="tag.dock_l" storage="false"/>
                              </find_dockingbay>
                              <do_if value="$buyDockL">
                                <set_value name="$buyDockCaps.$L" exact="true"/>
                              </do_if>
                              
                              <find_dockingbay name="$buyDockXL" object="$sellOfferOwner" checkoperational="true" multiple="false">
                                <match_dock size="tag.dock_xl" storage="false"/>
                              </find_dockingbay>
                              <do_if value="$buyDockXL">
                                <set_value name="$buyDockCaps.$XL" exact="true"/>
                              </do_if>
                              
                              <set_value name="global.$GT_DockCapsCache.{$sellOfferOwner}" exact="$buyDockCaps"/>
                            </do_else>
                            
                            <!-- Sell station (= buyer of SellOffer / $buyOfferOwner) -->
                            <set_value name="$sellDockCaps" exact="null"/>
                            <do_if value="global.$GT_DockCapsCache.{$buyOfferOwner}?">
                              <set_value name="$sellDockCaps" exact="global.$GT_DockCapsCache.{$buyOfferOwner}"/>
                            </do_if>
                            <do_else>
                              <set_value name="$sellDockCaps" exact="table[$S=false, $M=false, $L=false, $XL=false]"/>
                              
                              <find_dockingbay name="$sellDockS" object="$buyOfferOwner" checkoperational="true" multiple="false">
                                <match_dock size="tag.dock_s" storage="false"/>
                              </find_dockingbay>
                              <do_if value="$sellDockS">
                                <set_value name="$sellDockCaps.$S" exact="true"/>
                              </do_if>
                              
                              <find_dockingbay name="$sellDockM" object="$buyOfferOwner" checkoperational="true" multiple="false">
                                <match_dock size="tag.dock_m" storage="false"/>
                              </find_dockingbay>
                              <do_if value="$sellDockM">
                                <set_value name="$sellDockCaps.$M" exact="true"/>
                              </do_if>
                              
                              <find_dockingbay name="$sellDockL" object="$buyOfferOwner" checkoperational="true" multiple="false">
                                <match_dock size="tag.dock_l" storage="false"/>
                              </find_dockingbay>
                              <do_if value="$sellDockL">
                                <set_value name="$sellDockCaps.$L" exact="true"/>
                              </do_if>
                              
                              <find_dockingbay name="$sellDockXL" object="$buyOfferOwner" checkoperational="true" multiple="false">
                                <match_dock size="tag.dock_xl" storage="false"/>
                              </find_dockingbay>
                              <do_if value="$sellDockXL">
                                <set_value name="$sellDockCaps.$XL" exact="true"/>
                              </do_if>
                              
                              <set_value name="global.$GT_DockCapsCache.{$buyOfferOwner}" exact="$sellDockCaps"/>
                            </do_else>
                            
                            <!-- Append trade entry to THIS home sector's cache list -->
                            <!-- CRITICAL: Store route distance (buy station sell station) for position-independent validation -->
                            <!-- PERFORMANCE OPTIMIZATION: Pre-computed distances from home sector -->
                            <append_to_list name="global.$GT_TradeCache.{$homeSector}" exact="table[
                              $WareId = $sellOfferWare.id,
                              $WareName = $sellOfferWare.name,
                              $SellStationId = $buyOfferOwner.idcode,
                              $BuyStationId = $sellOfferOwner.idcode,
                              $BuyOffer = $sellOffer,
                              $SellOffer = $buyOffer,
                              $BuyTargetType = $buyTargetType,
                              $SellTargetType = $sellTargetType,
                              $BuyDockCaps = $buyDockCaps,
                              $SellDockCaps = $sellDockCaps,
                              $Amount = $maxAmount,
                              $TotalVolume = $totalVolume,
                              $Profit = $profit,
                              $ROI = $roi,
                              $BuyPrice = $buyPrice,
                              $SellPrice = $sellPrice,
                              $Distance = $routeDistance,
                              $Timestamp = player.age,
                              $HomeSector = $homeSector,
                              $HomeToBuyDistance = $homeToBuyDistance,
                              $HomeToSellDistance = $homeToSellDistance
                            ]"/>
                          </do_if>
                          
                          <!-- Debug logging for cache population -->
                          <!-- DIAGNOSTIC: Always log first few cache entries (helps diagnose empty cache issues) -->
                          <set_value name="$homeSectorCache" exact="global.$GT_TradeCache.{$homeSector}"/>
                          <set_value name="$cacheCount" exact="$homeSectorCache.count"/>
                          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                            <!-- Log first 5 entries and every 10th entry after that (calculate remainder using division) -->
                            <set_value name="$shouldLog" exact="false"/>
                            <do_if value="$cacheCount le 5">
                              <set_value name="$shouldLog" exact="true"/>
                            </do_if>
                            <do_else>
                              <!-- Calculate remainder: cacheCount - (cacheCount / 10) * 10 -->
                              <set_value name="$remainder" exact="$cacheCount - (($cacheCount / 10) * 10)"/>
                              <do_if value="$remainder == 0">
                                <set_value name="$shouldLog" exact="true"/>
                              </do_if>
                            </do_else>
                            <do_if value="$shouldLog">
                              <debug_text text="'[GT-Cache] Trade cached: ' + $sellOfferWare.name + ', ROI=' + ($roi/1) + '%, Profit=' + ($profit/100) + ' Cr, Distance=' + $routeDistance + ' jumps (cache now: ' + $cacheCount + ' entries)'" chance="100"/>
                            </do_if>
                          </do_if>
                        </do_if>
                      </do_if>
                    </do_if>
                    
                    <!-- OPTIMIZATION: Use library function to calculate trade thresholds -->
                    <run_actions ref="md.GT_Libraries_General.GT_CalculateTradeThresholds" result="$thresholds">
                      <param name="minROI" value="$minROI"/>
                      <param name="minAbsoluteProfit" value="$minAbsoluteProfit"/>
                      <param name="useAdvancedAnalytics" value="$gt_AdvancedAnalytics"/>
                      <param name="isIntraSector" value="false"/>
                      <param name="isIsolated" value="false"/>
                    </run_actions>
                    <set_value name="$roiThreshold" exact="$thresholds.$ROIThreshold"/>
                    <set_value name="$profitThreshold" exact="$thresholds.$ProfitThreshold"/>
                    
                    <do_if value="$roi lt $roiThreshold or $profit lt $profitThreshold">
                      <set_value name="$tradesRejectedProfit" operation="add"/>
                      
                      <!-- Track best rejected trade -->
                      <do_if value="not $bestRejectedProfit? or $profit gt $bestRejectedProfit">
                        <set_value name="$bestRejectedProfit" exact="$profit"/>
                        <set_value name="$bestRejectedTrade" exact="table[
                          $ware = $sellOfferWare,
                          $buyFrom = $sellOfferOwner,
                          $sellTo = $buyOfferOwner,
                          $buyPrice = $buyPrice,
                          $sellPrice = $sellPrice,
                          $profit = $profit,
                          $roi = $roi
                        ]"/>
                      </do_if>
                      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                        <set_value name="$wareName" exact="if $sellOfferWare? then @$sellOfferWare.name else 'NULL'"/>
                        <set_value name="$buyStationName" exact="if $sellOfferOwner? then @$sellOfferOwner.knownname else 'NULL'"/>
                        <set_value name="$sellStationName" exact="if $buyOfferOwner? then @$buyOfferOwner.knownname else 'NULL'"/>
                        <debug_text text="'[GT-Batch] (' + $ship.idcode + ') CROSS-SECTOR REJECTED (profit/ROI too low): ' + $wareName + ' (Profit: ' + ($profit/100) + ' Cr lt ' + ($profitThreshold/100) + ' Cr, ROI: ' + ($roi/1) + '% lt ' + ($roiThreshold/1) + '%, BaseMinProfit: ' + ($minAbsoluteProfit/100) + ' Cr)'" chance="100"/>
                      </do_if>
                      <continue/>
                    </do_if>
                    
                    <!-- Use cached distances -->
                    <set_value name="$buyDistance" exact="@$stationDistanceCache.{$sellOfferOwner}"/>
                    <do_if value="not $buyDistance? or typeof $buyDistance != datatype.integer">
                      <set_value name="$buyDistance" exact="-1"/>
                    </do_if>
                    
                    <set_value name="$sellDistance" exact="@$stationDistanceCache.{$buyOfferOwner}"/>
                    <do_if value="not $sellDistance? or typeof $sellDistance != datatype.integer">
                      <set_value name="$sellDistance" exact="-1"/>
                    </do_if>
                    
                    <!-- Filter unreachable trades -->
                    <do_if value="$buyDistance lt 0 or $sellDistance lt 0">
                      <set_value name="$tradesRejectedDistance" operation="add"/>
                      <continue/>
                    </do_if>
                    
                    <!-- Check distance constraints -->
                    <do_if value="$buyDistance gt $maxDistance or $sellDistance gt $maxDistance">
                      <set_value name="$tradesRejectedDistance" operation="add"/>
                      <continue/>
                    </do_if>
                    
                    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
                    <!-- OPTIMIZATION: Use cached sector blacklist status (fast table lookup) -->
                    <!-- Extract sectors for distance calculation and caching -->
                    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
                    <!-- Use safe extracted station values -->
                    <set_value name="$buySector" exact="@$sellOfferOwner.sector"/>
                    <set_value name="$sellSector" exact="@$buyOfferOwner.sector"/>
                    <do_if value="not $buySector? or not $sellSector?">
                      <continue/>
                    </do_if>
                    
                    <!-- Calculate route distance (buy station sell station) for cache validation -->
                    <!-- This is position-independent and will detect if blacklists block the route -->
                    <set_value name="$routeDistance" exact="0"/>
                    <do_if value="$buySector == $sellSector">
                      <!-- Same sector: route distance is 0 -->
                      <set_value name="$routeDistance" exact="0"/>
                    </do_if>
                    <do_else>
                      <!-- UNIVERSAL CACHE: Use range-only distance (NO blacklist params) -->
                      <set_value name="$buyStationSector" exact="$buySector"/>
                      <set_value name="$sellStationSector" exact="$sellSector"/>
                      <set_value name="$routeDistance" exact="$buyStationSector.gatedistance.{$sellStationSector}"/>
                    </do_else>
                    
                    <!-- OPTIMIZATION: Use library function to calculate trade efficiency -->
                    <set_value name="$totalDistance" exact="$buyDistance + $sellDistance"/>
                    <set_value name="$sellOfferOwnerOwner" exact="@$sellOfferOwner.owner"/>
                    <set_value name="$buyOfferOwnerOwner" exact="@$buyOfferOwner.owner"/>
                    <run_actions ref="md.GT_Libraries_General.GT_CalculateTradeEfficiency" result="$efficiency">
                      <param name="profit" value="$profit"/>
                      <param name="distance" value="$totalDistance"/>
                      <param name="distancePenaltyMultiplier" value="$distancePenaltyMultiplier"/>
                      <param name="factionPriority" value="$factionPriority"/>
                      <param name="buyStationOwner" value="$sellOfferOwnerOwner"/>
                      <param name="sellStationOwner" value="$buyOfferOwnerOwner"/>
                    </run_actions>
                    
                    <!-- UNIVERSAL CACHE: No blacklist filtering - removed for universal processing -->
                    <!-- Blacklist filtering happens per-ship during cache retrieval -->
                    
                    <!-- OPTIMIZATION: Use library function to check failed sector pair -->
                    <run_actions ref="md.GT_Libraries_General.GT_CheckFailedSectorPair" result="$isFailedSectorPair">
                      <param name="buySector" value="$buySector"/>
                      <param name="sellSector" value="$sellSector"/>
                      <param name="failedTrades" value="$failedTrades"/>
                    </run_actions>
                    
                    <!-- UNIVERSAL CACHE: Collect ALL valid trades (no blacklist filtering) -->
                    <!-- Respect ware quota to ensure diversity -->
                    <do_if value="not $isFailedSectorPair and $tradesForThisWare lt $maxTradesPerWare">
                      <!-- OPTIMIZATION: Use library function to create trade object -->
                      <run_actions ref="md.GT_Libraries_General.GT_CreateTradeObject" result="$trade">
                        <param name="sellOffer" value="$sellOffer"/>
                        <param name="buyOffer" value="$buyOffer"/>
                        <param name="sellStation" value="$sellOfferOwner"/>
                        <param name="buyStation" value="$buyOfferOwner"/>
                        <param name="amount" value="$maxAmount"/>
                        <param name="profit" value="$profit"/>
                        <param name="roi" value="$roi"/>
                        <param name="efficiency" value="$efficiency"/>
                        <param name="buyPrice" value="$buyPrice"/>
                        <param name="sellPrice" value="$sellPrice"/>
                        <param name="distance" value="$routeDistance"/>
                        <param name="risk" value="0"/>
                      </run_actions>
                      
                      <append_to_list name="$tradeList" exact="$trade"/>
                      
                      <!-- OPTIMIZATION: Use library function to update trade quota -->
                      <run_actions ref="md.GT_Libraries_General.GT_UpdateTradeQuota" result="$quotaResult">
                        <param name="tradesPerWare" value="$tradesPerWare"/>
                        <param name="ware" value="$ware"/>
                        <param name="increment" value="1"/>
                      </run_actions>
                      <set_value name="$tradesPerWare" exact="$quotaResult.$UpdatedTable"/>
                      <set_value name="$tradesForThisWare" exact="$quotaResult.$NewCount"/>
                      
                      <!-- OPTIMIZATION #3: Early exit when quota reached -->
                      <!-- Break from inner loop (buy offers) when we have enough trades for this ware -->
                      <do_if value="$tradesForThisWare ge $maxTradesPerWare">
                        <break/>  <!-- Exit buy offers loop -->
                      </do_if>
                      
                      <!-- Track overall best -->
                      <do_if value="$efficiency gt $crossStationBestScore">
                        <set_value name="$crossStationBestScore" exact="$efficiency"/>
                        <set_value name="$crossStationBestTrade" exact="$trade"/>
                      </do_if>
                      
                      <!-- OPTIMIZATION: Use library function to check route conflict -->
                      <run_actions ref="md.GT_Libraries_General.GT_CheckRouteConflict" result="$routeConflicted">
                        <param name="sellStation" value="$sellOfferOwner"/>
                        <param name="buyStation" value="$buyOfferOwner"/>
                        <param name="ware" value="$sellOfferWare"/>
                        <param name="reservedRoutes" value="$reservedRoutes"/>
                      </run_actions>
                      
                      <!-- Track best non-conflicted -->
                      <do_if value="not $routeConflicted and not $isFailedSectorPair and $efficiency gt $nonConflictedBestScore">
                        <set_value name="$nonConflictedBestScore" exact="$efficiency"/>
                        <set_value name="$nonConflictedBestTrade" exact="$trade"/>
                      </do_if>
                    </do_if>
                </do_all>
                
                <!-- OPTIMIZATION #3: Early exit from outer loop if quota reached -->
                <do_if value="$tradesForThisWare ge $maxTradesPerWare">
                  <break/>  <!-- Exit sell offers loop -->
                  </do_if>
              </do_all>
            </do_if>
            <!-- LINE 998: Closes do_if from line 194 -->
            </do_if>
          </do_all>
          
          <!-- Update state with new progress -->
          <!-- Convert 1-based batchEnd back to 0-based for storage -->
          <set_value name="$state.$currentWareIndex" exact="$batchEnd1Based - 1"/>
          <set_value name="$state.$tradeList" exact="$tradeList"/>
          <set_value name="$state.$crossStationBestScore" exact="$crossStationBestScore"/>
          <set_value name="$state.$crossStationBestTrade" exact="$crossStationBestTrade"/>
          <set_value name="$state.$nonConflictedBestScore" exact="$nonConflictedBestScore"/>
          <set_value name="$state.$nonConflictedBestTrade" exact="$nonConflictedBestTrade"/>
          <set_value name="$state.$tradesRejectedProfit" exact="$tradesRejectedProfit"/>
          <set_value name="$state.$tradesRejectedDocking" exact="$tradesRejectedDocking"/>
          <set_value name="$state.$tradesRejectedAmount" exact="$tradesRejectedAmount"/>
          <set_value name="$state.$tradesRejectedDistance" exact="$tradesRejectedDistance"/>
          <!-- UNIVERSAL CACHE: No tradesRejectedBlacklist or sectorBlacklistCache - removed for universal processing -->
          <!-- OPTIMIZATION: Use library function to validate table before saving -->
          <run_actions ref="md.GT_Libraries_General.GT_ValidateTableSafe" result="$validTradesPerWare">
            <param name="table" value="$tradesPerWare"/>
          </run_actions>
          <set_value name="$state.$tradesPerWare" exact="$validTradesPerWare"/>
          <set_value name="$state.$bestRejectedProfit" exact="$bestRejectedProfit"/>
          <set_value name="$state.$bestRejectedTrade" exact="$bestRejectedTrade"/>
          
          <!-- Update global state using ship object as key -->
          <set_value name="global.$GT_BatchDataList.{$ship}" exact="$state"/>
          
          <!-- Check if more batches needed -->
          <!-- batchEnd1Based is 1-based, wareCount is count (max valid index) -->
          <do_if value="$batchEnd1Based le $wareCount and $tradeList.count lt $earlyExitThreshold">
            <!-- Signal next batch with same ship - continuation batches are allowed (same ship) -->
            <signal_cue_instantly cue="md.GT_Trading_Batch_Processor.ProcessTradeMatchingBatch" param="$ship"/>
          </do_if>
          <do_else>
            <!-- All batches complete - decrement active processors counter -->
            <do_if value="global.$GT_BatchProcessorQueue? and global.$GT_BatchProcessorQueue.$ActiveProcessors? and global.$GT_BatchProcessorQueue.$ActiveProcessors gt 0">
              <set_value name="global.$GT_BatchProcessorQueue.$ActiveProcessors" operation="subtract"/>
            </do_if>
            <!-- Remove ship from active ships list -->
            <do_if value="global.$GT_BatchProcessorQueue? and global.$GT_BatchProcessorQueue.$ActiveShips?">
              <set_value name="$shipIndex" exact="-1"/>
              <do_all exact="global.$GT_BatchProcessorQueue.$ActiveShips.count" counter="$i">
                <do_if value="global.$GT_BatchProcessorQueue.$ActiveShips.{$i} == $ship">
                  <set_value name="$shipIndex" exact="$i"/>
                  <break/>
                </do_if>
              </do_all>
              <do_if value="$shipIndex ge 0">
                <remove_from_list name="global.$GT_BatchProcessorQueue.$ActiveShips" index="$shipIndex"/>
              </do_if>
            </do_if>
            <!-- Process next queued batch processor if any -->
            <do_if value="global.$GT_BatchProcessorQueue? and global.$GT_BatchProcessorQueue.$Ships? and global.$GT_BatchProcessorQueue.$Ships.count gt 0">
              <signal_cue_instantly cue="md.GT_Trading_Batch_Processor.ProcessBatchProcessorQueue"/>
            </do_if>
            
            <!-- All batches complete - signal completion -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Complete. Total: ' + $tradeList.count + ' trades (active: ' + (if global.$GT_BatchProcessorQueue? and global.$GT_BatchProcessorQueue.$ActiveProcessors? then global.$GT_BatchProcessorQueue.$ActiveProcessors else 0) + '/' + (if global.$GT_BatchProcessorQueue? and global.$GT_BatchProcessorQueue.$MaxConcurrent? then global.$GT_BatchProcessorQueue.$MaxConcurrent else 1) + ')'" chance="100"/>
            </do_if>
            
            <!-- Pack results -->
            <set_value name="$results" exact="table[
              $ship = $ship,
              $tradeList = $tradeList,
              $crossStationBestTrade = $crossStationBestTrade,
              $crossStationBestScore = $crossStationBestScore,
              $nonConflictedBestTrade = $nonConflictedBestTrade,
              $nonConflictedBestScore = $nonConflictedBestScore,
              $tradesRejectedProfit = $tradesRejectedProfit,
              $tradesRejectedDocking = $tradesRejectedDocking,
              $tradesRejectedAmount = $tradesRejectedAmount,
              $tradesRejectedDistance = $tradesRejectedDistance,
              $bestRejectedProfit = $bestRejectedProfit,
              $bestRejectedTrade = $bestRejectedTrade
            ]"/>
            
            <!-- Store results in global TABLE for SearchLiveTrades_Resume to retrieve -->
            <!-- SIMPLIFIED: Initialization guarantees global.$GT_BatchResultsList exists -->
            <set_value name="global.$GT_BatchResultsList.{$ship}" exact="$results"/>
            
            <!-- NOTE: Don't clean up batch data yet - resume cue needs ship reference -->
            <!-- Cleanup happens in resume cue after extracting ship -->
            
            <!-- Signal SearchLiveTrades_Resume cue to continue processing (pass ship object) -->
            <signal_cue_instantly cue="md.GT_Trading_Search.SearchLiveTrades_Resume" param="$ship"/>
            
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Signalled waiting cue to resume'" chance="100"/>
            </do_if>
          </do_else>
        </do_if>
      </actions>
    </cue>
    
    <!-- PERFORMANCE FIX: Process Batch Processor Queue - Use ActiveProcessors as atomic lock -->
    <cue name="ProcessBatchProcessorQueue" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <!-- CRITICAL FIX: Ensure global.$GT_BatchProcessorQueue exists and initialize required properties -->
        <do_if value="not global.$GT_BatchProcessorQueue?">
          <set_value name="global.$GT_BatchProcessorQueue" exact="table[]"/>
        </do_if>
        
        <do_if value="not global.$GT_BatchProcessorQueue.$Ships?">
          <set_value name="global.$GT_BatchProcessorQueue.$Ships" exact="[]"/>
        </do_if>
        
        <do_if value="not global.$GT_BatchProcessorQueue.$ActiveProcessors?">
          <set_value name="global.$GT_BatchProcessorQueue.$ActiveProcessors" exact="0"/>
        </do_if>
        <!-- Fix corrupted state from older versions (negative counter breaks concurrency gating) -->
        <do_if value="global.$GT_BatchProcessorQueue.$ActiveProcessors lt 0">
          <set_value name="global.$GT_BatchProcessorQueue.$ActiveProcessors" exact="0"/>
        </do_if>
        
        <do_if value="not global.$GT_BatchProcessorQueue.$MaxConcurrent?">
          <set_value name="global.$GT_BatchProcessorQueue.$MaxConcurrent" exact="1"/>
        </do_if>
        
        <do_if value="not global.$GT_BatchProcessorQueue.$ActiveShips?">
          <set_value name="global.$GT_BatchProcessorQueue.$ActiveShips" exact="[]"/>
        </do_if>
        
        <!-- ATOMIC LOCK: Process if below max concurrent processors (prevents race conditions) -->
        <do_if value="global.$GT_BatchProcessorQueue.$ActiveProcessors lt global.$GT_BatchProcessorQueue.$MaxConcurrent and global.$GT_BatchProcessorQueue.$Ships.count gt 0">
          
          <!-- Get first ship from queue -->
          <set_value name="$ship" exact="global.$GT_BatchProcessorQueue.$Ships.{1}"/>
          <remove_from_list name="global.$GT_BatchProcessorQueue.$Ships" exact="$ship"/>
          
          <!-- Don't increment here - ProcessTradeMatchingBatch will handle it -->
          <!-- This prevents double-increment and ensures proper continuation batch detection -->
          
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Batch] (' + $ship.idcode + ') BATCH PROCESSOR QUEUED - starting (active: ' + global.$GT_BatchProcessorQueue.$ActiveProcessors + '/' + global.$GT_BatchProcessorQueue.$MaxConcurrent + ', queued: ' + global.$GT_BatchProcessorQueue.$Ships.count + ')'" chance="100"/>
          </do_if>
          
          <!-- Start the batch processor (it will increment ActiveProcessors) -->
          <signal_cue_instantly cue="md.GT_Trading_Batch_Processor.ProcessTradeMatchingBatch" param="$ship"/>
        </do_if>
        <do_else>
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging and global.$GT_BatchProcessorQueue.$ActiveProcessors gt 0 and global.$GT_BatchProcessorQueue.$Ships.count gt 0">
            <debug_text text="'[GT-Batch] Batch processor in progress, skipping (active: ' + global.$GT_BatchProcessorQueue.$ActiveProcessors + ', queued: ' + global.$GT_BatchProcessorQueue.$Ships.count + ')'" chance="100"/>
          </do_if>
        </do_else>
      </actions>
    </cue>
    
  </cues>
</mdscript>