<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_TerritoryManagement" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- Territory Management System Initialization -->
    <cue name="SystemInit" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_CoreSystem.SystemInit"/>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Territory Management system initializing...'" chance="100"/>
        </do_if>
        
        <!-- Initialize territory structures -->
        <set_value name="global.$GT_Territories" exact="table[]"/>
        <set_value name="global.$GT_SectorExpertise" exact="table[]"/>
        <set_value name="global.$GT_TerritoryBonuses" exact="table[]"/>
        <set_value name="global.$GT_SectorAnalysis" exact="table[]"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Territory Management system initialized'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- PHASE 4 IMPROVEMENT: Event-Driven Territory Management -->
    <!-- Initialize territory event system -->
    <cue name="InitTerritoryEvents" instantiate="true">
      <conditions>
        <event_cue_signalled cue="SystemInit"/>
      </conditions>
      <actions>
        <!-- Initialize territory event queue -->
        <set_value name="global.$GT_TerritoryEventQueue" exact="[]"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] ⚡ Territory event system initialized (event-driven)'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Process Territory Events -->
    <!-- Listen for signal instead of polling -->
    <cue name="ProcessTerritoryEvents" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_TerritoryManagement.ProcessTerritoryEvents"/>
      </conditions>
      <actions>
        
        <do_if value="global.$GT_TerritoryEventQueue? and global.$GT_TerritoryEventQueue.count gt 0">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] ⚡ Processing ' + global.$GT_TerritoryEventQueue.count + ' territory events instantly'" chance="100"/>
          </do_if>
          
          <!-- Process all events in batch -->
          <do_all exact="global.$GT_TerritoryEventQueue.count" counter="$i">
            <set_value name="$event" exact="global.$GT_TerritoryEventQueue.{$i}"/>
            <set_value name="$type" exact="$event.$type"/>
            
            <!-- Route to appropriate handler -->
            <!-- PERFORMANCE: Removed 'sector_change' and 'ship_assignment' handlers - never triggered -->
            <do_if value="$type == 'trade_completion'">
              <signal_cue_instantly cue="HandleTradeCompletionEvent" param="$event"/>
            </do_if>
            <do_elseif value="$type == 'conflict_detection'">
              <signal_cue_instantly cue="HandleConflictEvent" param="$event"/>
            </do_elseif>
          </do_all>
          
          <!-- Clear processed events -->
          <set_value name="global.$GT_TerritoryEventQueue" exact="[]"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- PERFORMANCE: HandleSectorChangeEvent removed - never triggered (no code creates 'sector_change' events) -->
    <!-- UpdateExpertise is still called directly from trade completion events -->
    
    <!-- Handle Trade Completion Events -->
    <cue name="HandleTradeCompletionEvent" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$event" exact="event.param"/>
        <set_value name="$ship" exact="$event.$ship"/>
        <set_value name="$sector" exact="$event.$sector"/>
        <set_value name="$success" exact="$event.$success"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Territory event: ' + $ship.idcode + ' completed trade in ' + $sector.knownname + ' (success: ' + $success + ')'" chance="100"/>
        </do_if>
        
        <!-- Update expertise based on trade success -->
        <set_value name="$expertiseEvent" exact="table[]"/>
        <set_value name="$expertiseEvent.$ship" exact="$ship"/>
        <set_value name="$expertiseEvent.$sector" exact="$sector"/>
        <set_value name="$expertiseEvent.$success" exact="$success"/>
        <signal_cue_instantly cue="UpdateExpertise" param="$expertiseEvent"/>
        
        <!-- Trigger conflict detection if needed -->
        <set_value name="$conflictEvent" exact="table[]"/>
        <set_value name="$conflictEvent.$type" exact="'conflict_detection'"/>
        <set_value name="$conflictEvent.$sector" exact="$sector"/>
        <set_value name="$conflictEvent.$trigger" exact="'trade_completion'"/>
        <append_to_list name="global.$GT_TerritoryEventQueue" exact="$conflictEvent"/>
        
        <!-- Signal MD cue directly (no polling needed) -->
        <signal_cue_instantly cue="md.GT_TerritoryManagement.ProcessTerritoryEvents"/>
      </actions>
    </cue>
    
    <!-- PERFORMANCE: HandleShipAssignmentEvent removed - never triggered (no code creates 'ship_assignment' events) -->
    
    <!-- Handle Conflict Events -->
    <cue name="HandleConflictEvent" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$event" exact="event.param"/>
        <set_value name="$trigger" exact="$event.$trigger"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Territory event: Conflict check triggered by ' + $trigger" chance="100"/>
        </do_if>
        
        <!-- PERFORMANCE: ResolveConflicts removed - territories not used in trade search -->
      </actions>
    </cue>
    
    <!-- PERFORMANCE: AnalyzeSectors, CalculateSectorMetrics, and OptimizeTerritories removed -->
    <!-- These cues performed expensive analysis (find_sector, find_station, find_offers) every 10 minutes -->
    <!-- but the results were never used in trade search - territories are assigned but not checked during trade selection -->
    <!-- OptimizeTerritories was never called (handlers HandleSectorChangeEvent and HandleShipAssignmentEvent were never triggered) -->
    <!-- Even if called, OptimizeTerritories would do nothing without sector analysis data -->
    <!-- Territory assignments still exist but don't affect trade search logic -->
    
    <!-- Update Ship Expertise -->
    <cue name="UpdateExpertise" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.param.ship"/>
        <set_value name="$sector" exact="event.param.sector"/>
        <set_value name="$tradeSuccess" exact="event.param.success"/>
        
        <!-- Initialize expertise tracking if needed -->
        <do_if value="not global.$GT_SectorExpertise.{$ship}?">
          <set_value name="global.$GT_SectorExpertise.{$ship}" exact="table[]"/>
        </do_if>
        
        <do_if value="not global.$GT_SectorExpertise.{$ship}.{$sector}?">
          <set_value name="global.$GT_SectorExpertise.{$ship}.{$sector}" exact="table[]"/>
          <set_value name="global.$GT_SectorExpertise.{$ship}.{$sector}.$Level" exact="0"/>
          <set_value name="global.$GT_SectorExpertise.{$ship}.{$sector}.$Experience" exact="0"/>
          <set_value name="global.$GT_SectorExpertise.{$ship}.{$sector}.$TradeCount" exact="0"/>
        </do_if>
        
        <!-- Award experience -->
        <set_value name="$expGain" exact="10"/>
        <do_if value="$tradeSuccess">
          <set_value name="$expGain" exact="25"/>
        </do_if>
        
        <!-- Bonus for trading in assigned territory -->
        <do_if value="global.$GT_Territories.{$ship}? and global.$GT_Territories.{$ship}.$Primary == $sector">
          <set_value name="$expGain" exact="$expGain * 1.5"/>
        </do_if>
        
        <!-- Update expertise -->
        <set_value name="global.$GT_SectorExpertise.{$ship}.{$sector}.$Experience" exact="global.$GT_SectorExpertise.{$ship}.{$sector}.$Experience + $expGain"/>
        <set_value name="global.$GT_SectorExpertise.{$ship}.{$sector}.$TradeCount" exact="global.$GT_SectorExpertise.{$ship}.{$sector}.$TradeCount + 1"/>
        
        <!-- Check for level up -->
        <set_value name="$currentExp" exact="global.$GT_SectorExpertise.{$ship}.{$sector}.$Experience"/>
        <set_value name="$currentLevel" exact="global.$GT_SectorExpertise.{$ship}.{$sector}.$Level"/>
        <set_value name="$requiredExp" exact="($currentLevel + 1) * 500"/>
        
        <do_if value="$currentExp ge $requiredExp and $currentLevel lt 10">
          <set_value name="global.$GT_SectorExpertise.{$ship}.{$sector}.$Level" exact="$currentLevel + 1"/>
          
          <!-- Calculate and apply bonuses -->
          <set_value name="global.$GT_CalculateBonusShip" exact="$ship"/>
          <set_value name="global.$GT_CalculateBonusSector" exact="$sector"/>
          <signal_cue cue="CalculateTerritoryBonus"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] ' + $ship.knownname + ' reached expertise level ' + ($currentLevel + 1) + ' in ' + $sector.knownname" chance="100"/>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Calculate Territory Bonuses -->
    <cue name="CalculateTerritoryBonus" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="global.$GT_CalculateBonusShip"/>
        <set_value name="$sector" exact="global.$GT_CalculateBonusSector"/>
        
        <!-- Get expertise level -->
        <set_value name="$level" exact="0"/>
        <do_if value="global.$GT_SectorExpertise.{$ship}? and global.$GT_SectorExpertise.{$ship}.{$sector}?">
          <set_value name="$level" exact="global.$GT_SectorExpertise.{$ship}.{$sector}.$Level"/>
        </do_if>
        
        <!-- Calculate bonuses based on expertise level -->
        <set_value name="$profitBonus" exact="1.0 + ($level * 0.02)"/> <!-- 2% per level -->
        <set_value name="$negotiationBonus" exact="1.0 + ($level * 0.01)"/> <!-- 1% per level -->
        <set_value name="$speedBonus" exact="1.0 + ($level * 0.005)"/> <!-- 0.5% per level -->
        
        <!-- Store bonuses -->
        <do_if value="not global.$GT_TerritoryBonuses.{$ship}?">
          <set_value name="global.$GT_TerritoryBonuses.{$ship}" exact="table[]"/>
        </do_if>
        
        <do_if value="not global.$GT_TerritoryBonuses.{$ship}.{$sector}?">
          <set_value name="global.$GT_TerritoryBonuses.{$ship}.{$sector}" exact="table[]"/>
        </do_if>
        
        <set_value name="global.$GT_TerritoryBonuses.{$ship}.{$sector}.$ProfitMultiplier" exact="$profitBonus"/>
        <set_value name="global.$GT_TerritoryBonuses.{$ship}.{$sector}.$NegotiationMultiplier" exact="$negotiationBonus"/>
        <set_value name="global.$GT_TerritoryBonuses.{$ship}.{$sector}.$SpeedMultiplier" exact="$speedBonus"/>
        <set_value name="global.$GT_TerritoryBonuses.{$ship}.{$sector}.$LastCalculated" exact="player.age"/>
      </actions>
    </cue>
    
    <!-- Apply Territory Bonuses to Trade -->
    <cue name="ApplyTerritoryBonus" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.param.ship"/>
        <set_value name="$sector" exact="event.param.sector"/>
        <set_value name="$baseProfit" exact="event.param.profit"/>
        
        <!-- Check for applicable bonuses -->
        <set_value name="$finalProfit" exact="$baseProfit"/>
        
        <do_if value="global.$GT_TerritoryBonuses.{$ship}? and global.$GT_TerritoryBonuses.{$ship}.{$sector}?">
          <set_value name="$profitMultiplier" exact="global.$GT_TerritoryBonuses.{$ship}.{$sector}.$ProfitMultiplier"/>
          <set_value name="$finalProfit" exact="$baseProfit * $profitMultiplier"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Territory bonus applied: ' + $baseProfit + ' -> ' + $finalProfit + ' (x' + $profitMultiplier + ')'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Return modified profit -->
        <set_value name="global.$GT_TerritoryBonusResult" exact="$finalProfit"/>
      </actions>
    </cue>
    
    <!-- PERFORMANCE: ResolveConflicts removed -->
    <!-- Territories are not used in trade search, so conflict resolution is unnecessary -->
    <!-- This cue iterated through all ships every 15 minutes for no functional benefit -->
    
    <!-- Territory Performance Report -->
    <cue name="GenerateTerritoryReport" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$report" exact="'Territory Management Report\n\n'"/>
        
        <!-- Territory assignments -->
        <set_value name="$report" exact="$report + 'TERRITORY ASSIGNMENTS:\n'"/>
        
        <do_all exact="global.$GT_Ships.keys.count" counter="$i">
          <set_value name="$ship" exact="global.$GT_Ships.keys.list.{$i}"/>
          
          <do_if value="$ship.exists and global.$GT_Territories.{$ship}? and global.$GT_Territories.{$ship}.$Primary?">
            <set_value name="$primary" exact="global.$GT_Territories.{$ship}.$Primary"/>
            <set_value name="$expertise" exact="0"/>
            <set_value name="$level" exact="0"/>
            
            <do_if value="global.$GT_SectorExpertise.{$ship}? and global.$GT_SectorExpertise.{$ship}.{$primary}?">
              <set_value name="$expertise" exact="global.$GT_SectorExpertise.{$ship}.{$primary}.$Experience"/>
              <set_value name="$level" exact="global.$GT_SectorExpertise.{$ship}.{$primary}.$Level"/>
            </do_if>
            
            <set_value name="$report" exact="$report + '• ' + $ship.knownname + ': ' + $primary.knownname + ' (Level ' + $level + ', ' + $expertise + ' XP)\n'"/>
          </do_if>
        </do_all>
        
        <!-- Top sectors by score -->
        <set_value name="$report" exact="$report + '\nTOP SECTORS BY VALUE:\n'"/>
        <set_value name="$topCount" exact="[global.$GT_SectorAnalysis.keys.count, 5].min"/>
        
        <do_all exact="$topCount" counter="$i">
          <do_if value="global.$GT_SectorAnalysis.keys.count ge $i">
            <set_value name="$sector" exact="global.$GT_SectorAnalysis.keys.list.{$i}"/>
            <set_value name="$score" exact="global.$GT_SectorAnalysis.{$sector}.$Score"/>
            <set_value name="$report" exact="$report + ($i) + '. ' + $sector.knownname + ' (Score: ' + $score + ')\n'"/>
          </do_if>
        </do_all>
        
        <!-- Return report -->
        <set_value name="global.$GT_TerritoryReport" exact="$report"/>
      </actions>
    </cue>
  </cues>
</mdscript> 
