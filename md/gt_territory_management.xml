<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_TerritoryManagement" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- Territory Management System Initialization -->
    <cue name="SystemInit" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_CoreSystem.SystemInit"/>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Territory Management system initializing...'" chance="100"/>
        </do_if>
        
        <!-- Initialize territory structures -->
        <set_value name="global.$GT_Territories" exact="table[]"/>
        <set_value name="global.$GT_SectorExpertise" exact="table[]"/>
        <set_value name="global.$GT_TerritoryBonuses" exact="table[]"/>
        <set_value name="global.$GT_SectorAnalysis" exact="table[]"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Territory Management system initialized'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- PHASE 4 IMPROVEMENT: Event-Driven Territory Management -->
    <!-- Initialize territory event system -->
    <cue name="InitTerritoryEvents" instantiate="true">
      <conditions>
        <event_cue_signalled cue="SystemInit"/>
      </conditions>
      <actions>
        <!-- Initialize territory event queue -->
        <set_value name="global.$GT_TerritoryEventQueue" exact="[]"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] ⚡ Territory event system initialized (event-driven)'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Process Territory Events -->
    <!-- Listen for signal instead of polling -->
    <cue name="ProcessTerritoryEvents" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_TerritoryManagement.ProcessTerritoryEvents"/>
      </conditions>
      <actions>
        
        <do_if value="global.$GT_TerritoryEventQueue? and global.$GT_TerritoryEventQueue.count gt 0">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] ⚡ Processing ' + global.$GT_TerritoryEventQueue.count + ' territory events instantly'" chance="100"/>
          </do_if>
          
          <!-- Process all events in batch -->
          <do_all exact="global.$GT_TerritoryEventQueue.count" counter="$i">
            <set_value name="$event" exact="global.$GT_TerritoryEventQueue.{$i}"/>
            <set_value name="$type" exact="$event.$type"/>
            
            <!-- Route to appropriate handler -->
            <do_if value="$type == 'sector_change'">
              <signal_cue_instantly cue="HandleSectorChangeEvent" param="$event"/>
            </do_if>
            <do_elseif value="$type == 'trade_completion'">
              <signal_cue_instantly cue="HandleTradeCompletionEvent" param="$event"/>
            </do_elseif>
            <do_elseif value="$type == 'ship_assignment'">
              <signal_cue_instantly cue="HandleShipAssignmentEvent" param="$event"/>
            </do_elseif>
            <do_elseif value="$type == 'conflict_detection'">
              <signal_cue_instantly cue="HandleConflictEvent" param="$event"/>
            </do_elseif>
          </do_all>
          
          <!-- Clear processed events -->
          <set_value name="global.$GT_TerritoryEventQueue" exact="[]"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Handle Sector Change Events -->
    <cue name="HandleSectorChangeEvent" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$event" exact="event.param"/>
        <set_value name="$ship" exact="$event.$ship"/>
        <set_value name="$newSector" exact="$event.$sector"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Territory event: ' + $ship.idcode + ' entered ' + $newSector.knownname + ' - checking assignment'" chance="100"/>
        </do_if>
        
        <!-- Check if ship needs territory reassignment -->
        <signal_cue_instantly cue="OptimizeTerritories"/>
        
        <!-- Update sector expertise -->
        <set_value name="$expertiseEvent" exact="table[]"/>
        <set_value name="$expertiseEvent.$ship" exact="$ship"/>
        <set_value name="$expertiseEvent.$sector" exact="$newSector"/>
        <set_value name="$expertiseEvent.$success" exact="true"/>
        <signal_cue_instantly cue="UpdateExpertise" param="$expertiseEvent"/>
      </actions>
    </cue>
    
    <!-- Handle Trade Completion Events -->
    <cue name="HandleTradeCompletionEvent" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$event" exact="event.param"/>
        <set_value name="$ship" exact="$event.$ship"/>
        <set_value name="$sector" exact="$event.$sector"/>
        <set_value name="$success" exact="$event.$success"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Territory event: ' + $ship.idcode + ' completed trade in ' + $sector.knownname + ' (success: ' + $success + ')'" chance="100"/>
        </do_if>
        
        <!-- Update expertise based on trade success -->
        <set_value name="$expertiseEvent" exact="table[]"/>
        <set_value name="$expertiseEvent.$ship" exact="$ship"/>
        <set_value name="$expertiseEvent.$sector" exact="$sector"/>
        <set_value name="$expertiseEvent.$success" exact="$success"/>
        <signal_cue_instantly cue="UpdateExpertise" param="$expertiseEvent"/>
        
        <!-- Trigger conflict detection if needed -->
        <set_value name="$conflictEvent" exact="table[]"/>
        <set_value name="$conflictEvent.$type" exact="'conflict_detection'"/>
        <set_value name="$conflictEvent.$sector" exact="$sector"/>
        <set_value name="$conflictEvent.$trigger" exact="'trade_completion'"/>
        <append_to_list name="global.$GT_TerritoryEventQueue" exact="$conflictEvent"/>
        
        <!-- Signal MD cue directly (no polling needed) -->
        <signal_cue_instantly cue="md.GT_TerritoryManagement.ProcessTerritoryEvents"/>
      </actions>
    </cue>
    
    <!-- Handle Ship Assignment Events -->
    <cue name="HandleShipAssignmentEvent" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$event" exact="event.param"/>
        <set_value name="$ship" exact="$event.$ship"/>
        <set_value name="$requestedSector" exact="$event.$sector"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Territory event: Assignment request for ' + $ship.idcode + ' to ' + $requestedSector.knownname" chance="100"/>
        </do_if>
        
        <!-- Process assignment request -->
        <signal_cue_instantly cue="OptimizeTerritories"/>
      </actions>
    </cue>
    
    <!-- Handle Conflict Events -->
    <cue name="HandleConflictEvent" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$event" exact="event.param"/>
        <set_value name="$trigger" exact="$event.$trigger"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Territory event: Conflict check triggered by ' + $trigger" chance="100"/>
        </do_if>
        
        <!-- Perform instant conflict resolution -->
        <signal_cue_instantly cue="ResolveConflicts"/>
      </actions>
    </cue>
    
    <!-- Sector Analysis Engine - Safety mechanism for territory optimization (10 minute interval) -->
    <cue name="AnalyzeSectors" instantiate="true" checkinterval="600s">
      <conditions>
        <check_value value="global.$GT_Config.$Fleet.$TerritoryManagement? and global.$GT_Ships.keys.count gt 0 and global.$GT_SectorAnalysis?"/>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Analyzing sectors for territory optimization...'" chance="100"/>
        </do_if>
        
        
        <!-- Find all relevant sectors -->
        <find_sector name="$sectors" space="player.galaxy" multiple="true">
          <match_distance object="player.galaxy" max="500km"/>
        </find_sector>
        
        <!-- Analyze each sector -->
        <do_all exact="$sectors.count" counter="$i">
          <set_value name="$sector" exact="$sectors.{$i}"/>
          
          <!-- Initialize sector analysis if needed -->
          <do_if value="not global.$GT_SectorAnalysis.{$sector}?">
            <set_value name="global.$GT_SectorAnalysis.{$sector}" exact="table[]"/>
            <set_value name="global.$GT_SectorAnalysis.{$sector}.$FirstAnalyzed" exact="player.age"/>
          </do_if>
          
          <!-- Calculate sector metrics -->
          <set_value name="global.$GT_AnalyzeSector" exact="$sector"/>
          <signal_cue cue="CalculateSectorMetrics"/>
        </do_all>
        
        <!-- Update territory assignments based on analysis -->
        <signal_cue cue="OptimizeTerritories"/>
      </actions>
    </cue>
    
    <!-- Calculate Sector Metrics -->
    <cue name="CalculateSectorMetrics" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$sector" exact="global.$GT_AnalyzeSector"/>
        
        <!-- Station count and types -->
        <find_station name="$stations" space="$sector" multiple="true">
          <match canbuildships="false"/>
        </find_station>
        <set_value name="$stationCount" exact="$stations.count"/>
        
        <!-- Trade volume estimation -->
        <set_value name="$tradeVolume" exact="0"/>
        <do_all exact="$stations.count" counter="$i">
          <set_value name="$station" exact="$stations.{$i}"/>
                      <find_buy_offer buyer="$station" result="$buyOffers" multiple="true">
                        <match_buyer tradesknownto="faction.player"/>
        </find_buy_offer>
        <find_sell_offer seller="$station" result="$sellOffers" multiple="true">
          <match_seller tradesknownto="faction.player"/>
            </find_sell_offer>
          <set_value name="$tradeVolume" exact="$tradeVolume + $buyOffers.count + $sellOffers.count"/>
        </do_all>
        
        <!-- Security assessment based on faction relations -->
        <set_value name="$security" exact="0.5"/>
        
        <do_if value="$sector? and $sector.owner?">
                      <set_value name="$relation" exact="faction.player.relationto.{$sector.owner}"/>
          <do_if value="$relation ge 0.1">
            <set_value name="$security" exact="1.0"/>  <!-- Friendly = very safe -->
          </do_if>
          <do_elseif value="$relation ge -0.1">
            <set_value name="$security" exact="0.75"/> <!-- Neutral = safe -->
          </do_elseif>
          <do_elseif value="$relation ge -0.5">
            <set_value name="$security" exact="0.5"/>  <!-- Hostile = moderate -->
          </do_elseif>
          <do_else>
            <set_value name="$security" exact="0.25"/> <!-- Very hostile = dangerous -->
          </do_else>
          
          <!-- Extra danger for Xenon/Kha'ak sectors -->
          <do_if value="$sector.owner.id == 'xenon' or $sector.owner.id == 'khaak'">
            <set_value name="$security" exact="0.1"/>
          </do_if>
        </do_if>
        
        <!-- Competition level -->
        <find_ship name="$competitors" space="$sector" multiple="true">
          <match primarypurpose="purpose.trade"/>
          <match owner="faction.player" negate="true"/>
        </find_ship>
        <set_value name="$competition" exact="$competitors.count"/>
        
        <!-- Calculate sector score -->
        <set_value name="$score" exact="100"/>
        <set_value name="$score" exact="$score + ($stationCount * 10)"/>
        <set_value name="$score" exact="$score + ($tradeVolume * 2)"/>
        <set_value name="$score" exact="$score + ($security * 50)"/>
        <set_value name="$score" exact="$score - ($competition * 5)"/>
        
        <!-- Store analysis results -->
        <set_value name="global.$GT_SectorAnalysis.{$sector}.$Score" exact="$score"/>
        <set_value name="global.$GT_SectorAnalysis.{$sector}.$StationCount" exact="$stationCount"/>
        <set_value name="global.$GT_SectorAnalysis.{$sector}.$TradeVolume" exact="$tradeVolume"/>
        <set_value name="global.$GT_SectorAnalysis.{$sector}.$Security" exact="$security"/>
        <set_value name="global.$GT_SectorAnalysis.{$sector}.$Competition" exact="$competition"/>
        <set_value name="global.$GT_SectorAnalysis.{$sector}.$LastAnalyzed" exact="player.age"/>
      </actions>
    </cue>
    
    <!-- Optimize Territory Assignments -->
    <cue name="OptimizeTerritories" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Optimizing territory assignments...'" chance="100"/>
        </do_if>
        
        
        <!-- Get max sectors per ship from config -->
        <set_value name="$maxSectorsPerShip" exact="3"/>
        <do_if value="global.$GT_Config? and global.$GT_Config.$Fleet? and global.$GT_Config.$Fleet.$MaxSectorsPerShip?">
          <set_value name="$maxSectorsPerShip" exact="global.$GT_Config.$Fleet.$MaxSectorsPerShip"/>
        </do_if>
        
        <!-- Sort sectors by score -->
        <set_value name="$sectorList" exact="[]"/>
                <do_if value="global.$GT_SectorAnalysis.keys? and global.$GT_SectorAnalysis.keys.count gt 0">
          <do_all exact="global.$GT_SectorAnalysis.keys.count" counter="$i">
            <set_value name="$sector" exact="global.$GT_SectorAnalysis.keys.list.{$i}"/>
            <set_value name="$sectorData" exact="table[]"/>
            <set_value name="$sectorData.$Sector" exact="$sector"/>
            <set_value name="$sectorData.$Score" exact="global.$GT_SectorAnalysis.{$sector}.$Score"/>
            <append_to_list name="$sectorList" exact="$sectorData"/>
          </do_all>
        </do_if>
        
        <do_if value="$sectorList.count gt 1">
          <sort_list list="$sectorList" sortbyvalue="loop.element.$Score" sortdescending="true"/>
        </do_if>
        
        <!-- Assign territories to ships -->
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.list? and global.$GT_Ships.keys.count gt 0">
          <do_all exact="global.$GT_Ships.keys.count" counter="$i">
            <set_value name="$ship" exact="global.$GT_Ships.keys.list.{$i}"/>
          
          <do_if value="$ship.exists and $ship.isoperational">
            <!-- Clear existing territories -->
            <do_if value="not global.$GT_Territories.{$ship}?">
              <set_value name="global.$GT_Territories.{$ship}" exact="table[]"/>
              <set_value name="global.$GT_Territories.{$ship}.$Primary" exact="null"/>
              <set_value name="global.$GT_Territories.{$ship}.$Secondary" exact="[]"/>
            </do_if>
            
            <!-- Assign primary territory -->
            <do_if value="$sectorList.count gt $i">
              <set_value name="$primarySector" exact="$sectorList.{$i + 1}.$Sector"/>
              <set_value name="global.$GT_Territories.{$ship}.$Primary" exact="$primarySector"/>
              
              <!-- Initialize expertise if needed -->
              <do_if value="not global.$GT_SectorExpertise.{$ship}?">
                <set_value name="global.$GT_SectorExpertise.{$ship}" exact="table[]"/>
              </do_if>
              
              <do_if value="not global.$GT_SectorExpertise.{$ship}.{$primarySector}?">
                <set_value name="global.$GT_SectorExpertise.{$ship}.{$primarySector}" exact="table[]"/>
                <set_value name="global.$GT_SectorExpertise.{$ship}.{$primarySector}.$Level" exact="0"/>
                <set_value name="global.$GT_SectorExpertise.{$ship}.{$primarySector}.$Experience" exact="0"/>
                <set_value name="global.$GT_SectorExpertise.{$ship}.{$primarySector}.$TradeCount" exact="0"/>
              </do_if>
              
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3] ' + $ship.knownname + ' assigned primary territory: ' + $primarySector.knownname" chance="100"/>
              </do_if>
            </do_if>
          </do_if>
          </do_all>
        </do_if>
      </actions>
    </cue>
    
    <!-- Update Ship Expertise -->
    <cue name="UpdateExpertise" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.param.ship"/>
        <set_value name="$sector" exact="event.param.sector"/>
        <set_value name="$tradeSuccess" exact="event.param.success"/>
        
        <!-- Initialize expertise tracking if needed -->
        <do_if value="not global.$GT_SectorExpertise.{$ship}?">
          <set_value name="global.$GT_SectorExpertise.{$ship}" exact="table[]"/>
        </do_if>
        
        <do_if value="not global.$GT_SectorExpertise.{$ship}.{$sector}?">
          <set_value name="global.$GT_SectorExpertise.{$ship}.{$sector}" exact="table[]"/>
          <set_value name="global.$GT_SectorExpertise.{$ship}.{$sector}.$Level" exact="0"/>
          <set_value name="global.$GT_SectorExpertise.{$ship}.{$sector}.$Experience" exact="0"/>
          <set_value name="global.$GT_SectorExpertise.{$ship}.{$sector}.$TradeCount" exact="0"/>
        </do_if>
        
        <!-- Award experience -->
        <set_value name="$expGain" exact="10"/>
        <do_if value="$tradeSuccess">
          <set_value name="$expGain" exact="25"/>
        </do_if>
        
        <!-- Bonus for trading in assigned territory -->
        <do_if value="global.$GT_Territories.{$ship}? and global.$GT_Territories.{$ship}.$Primary == $sector">
          <set_value name="$expGain" exact="$expGain * 1.5"/>
        </do_if>
        
        <!-- Update expertise -->
        <set_value name="global.$GT_SectorExpertise.{$ship}.{$sector}.$Experience" exact="global.$GT_SectorExpertise.{$ship}.{$sector}.$Experience + $expGain"/>
        <set_value name="global.$GT_SectorExpertise.{$ship}.{$sector}.$TradeCount" exact="global.$GT_SectorExpertise.{$ship}.{$sector}.$TradeCount + 1"/>
        
        <!-- Check for level up -->
        <set_value name="$currentExp" exact="global.$GT_SectorExpertise.{$ship}.{$sector}.$Experience"/>
        <set_value name="$currentLevel" exact="global.$GT_SectorExpertise.{$ship}.{$sector}.$Level"/>
        <set_value name="$requiredExp" exact="($currentLevel + 1) * 500"/>
        
        <do_if value="$currentExp ge $requiredExp and $currentLevel lt 10">
          <set_value name="global.$GT_SectorExpertise.{$ship}.{$sector}.$Level" exact="$currentLevel + 1"/>
          
          <!-- Calculate and apply bonuses -->
          <set_value name="global.$GT_CalculateBonusShip" exact="$ship"/>
          <set_value name="global.$GT_CalculateBonusSector" exact="$sector"/>
          <signal_cue cue="CalculateTerritoryBonus"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] ' + $ship.knownname + ' reached expertise level ' + ($currentLevel + 1) + ' in ' + $sector.knownname" chance="100"/>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Calculate Territory Bonuses -->
    <cue name="CalculateTerritoryBonus" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="global.$GT_CalculateBonusShip"/>
        <set_value name="$sector" exact="global.$GT_CalculateBonusSector"/>
        
        <!-- Get expertise level -->
        <set_value name="$level" exact="0"/>
        <do_if value="global.$GT_SectorExpertise.{$ship}? and global.$GT_SectorExpertise.{$ship}.{$sector}?">
          <set_value name="$level" exact="global.$GT_SectorExpertise.{$ship}.{$sector}.$Level"/>
        </do_if>
        
        <!-- Calculate bonuses based on expertise level -->
        <set_value name="$profitBonus" exact="1.0 + ($level * 0.02)"/> <!-- 2% per level -->
        <set_value name="$negotiationBonus" exact="1.0 + ($level * 0.01)"/> <!-- 1% per level -->
        <set_value name="$speedBonus" exact="1.0 + ($level * 0.005)"/> <!-- 0.5% per level -->
        
        <!-- Store bonuses -->
        <do_if value="not global.$GT_TerritoryBonuses.{$ship}?">
          <set_value name="global.$GT_TerritoryBonuses.{$ship}" exact="table[]"/>
        </do_if>
        
        <do_if value="not global.$GT_TerritoryBonuses.{$ship}.{$sector}?">
          <set_value name="global.$GT_TerritoryBonuses.{$ship}.{$sector}" exact="table[]"/>
        </do_if>
        
        <set_value name="global.$GT_TerritoryBonuses.{$ship}.{$sector}.$ProfitMultiplier" exact="$profitBonus"/>
        <set_value name="global.$GT_TerritoryBonuses.{$ship}.{$sector}.$NegotiationMultiplier" exact="$negotiationBonus"/>
        <set_value name="global.$GT_TerritoryBonuses.{$ship}.{$sector}.$SpeedMultiplier" exact="$speedBonus"/>
        <set_value name="global.$GT_TerritoryBonuses.{$ship}.{$sector}.$LastCalculated" exact="player.age"/>
      </actions>
    </cue>
    
    <!-- Apply Territory Bonuses to Trade -->
    <cue name="ApplyTerritoryBonus" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.param.ship"/>
        <set_value name="$sector" exact="event.param.sector"/>
        <set_value name="$baseProfit" exact="event.param.profit"/>
        
        <!-- Check for applicable bonuses -->
        <set_value name="$finalProfit" exact="$baseProfit"/>
        
        <do_if value="global.$GT_TerritoryBonuses.{$ship}? and global.$GT_TerritoryBonuses.{$ship}.{$sector}?">
          <set_value name="$profitMultiplier" exact="global.$GT_TerritoryBonuses.{$ship}.{$sector}.$ProfitMultiplier"/>
          <set_value name="$finalProfit" exact="$baseProfit * $profitMultiplier"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Territory bonus applied: ' + $baseProfit + ' -> ' + $finalProfit + ' (x' + $profitMultiplier + ')'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Return modified profit -->
        <set_value name="global.$GT_TerritoryBonusResult" exact="$finalProfit"/>
      </actions>
    </cue>
    
    <!-- Territory Conflict Resolution - Safety mechanism for conflict management (15 minute interval) -->
    <cue name="ResolveConflicts" instantiate="true" checkinterval="900s">
      <conditions>
        <check_value value="global.$GT_Config.$Territory.$EnableConflictResolution?"/>  <!-- RE-ENABLED: Now safe with event-driven system -->
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Checking for territory conflicts...'" chance="100"/>
        </do_if>
        
        <!-- Build territory assignment map -->
        <set_value name="$sectorAssignments" exact="table[]"/>
        
        <do_all exact="global.$GT_Ships.keys.count" counter="$i">
          <set_value name="$ship" exact="global.$GT_Ships.keys.list.{$i}"/>
          
          <do_if value="global.$GT_Territories.{$ship}? and global.$GT_Territories.{$ship}.$Primary?">
            <set_value name="$sector" exact="global.$GT_Territories.{$ship}.$Primary"/>
            
            <!-- Validate sector is not null before using as table key -->
            <do_if value="$sector != null">
              <do_if value="not $sectorAssignments.{$sector}?">
                <set_value name="$sectorAssignments.{$sector}" exact="[]"/>
              </do_if>
              
              <append_to_list name="$sectorAssignments.{$sector}" exact="$ship"/>
            </do_if>
            <do_else>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3] WARNING: Ship ' + $ship.knownname + ' has null primary territory - skipping conflict resolution'" chance="100"/>
              </do_if>
            </do_else>
          </do_if>
        </do_all>
        
        <!-- Check for conflicts -->
        <set_value name="$conflictsFound" exact="0"/>
        
        <do_all exact="$sectorAssignments.keys.count" counter="$i">
          <set_value name="$sector" exact="$sectorAssignments.keys.list.{$i}"/>
          <set_value name="$shipsInSector" exact="$sectorAssignments.{$sector}"/>
          
          <!-- If multiple ships in same primary territory -->
          <do_if value="$shipsInSector.count gt 2">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] Territory conflict in ' + $sector.knownname + ' (' + $shipsInSector.count + ' ships)'" chance="100"/>
            </do_if>
            
            <!-- Sort ships by expertise in this sector -->
            <set_value name="$shipExpertiseList" exact="[]"/>
            
            <do_all exact="$shipsInSector.count" counter="$j">
              <set_value name="$ship" exact="$shipsInSector.{$j}"/>
              <set_value name="$expertise" exact="0"/>
              
              <do_if value="global.$GT_SectorExpertise.{$ship}? and global.$GT_SectorExpertise.{$ship}.{$sector}?">
                <set_value name="$expertise" exact="global.$GT_SectorExpertise.{$ship}.{$sector}.$Experience"/>
              </do_if>
              
              <set_value name="$shipData" exact="table[]"/>
              <set_value name="$shipData.$Ship" exact="$ship"/>
              <set_value name="$shipData.$Expertise" exact="$expertise"/>
              
              <append_to_list name="$shipExpertiseList" exact="$shipData"/>
            </do_all>
            
            <!-- Sort by expertise -->
            <sort_list list="$shipExpertiseList" sortbyvalue="loop.element.$Expertise" sortdescending="true"/>
            
            <!-- Keep top 2, reassign others -->
            <do_all exact="$shipExpertiseList.count" counter="$j">
              <do_if value="$j gt 2">
                <set_value name="$ship" exact="$shipExpertiseList.{$j}.$Ship"/>
                
                <!-- Find alternative sector -->
                <do_all exact="global.$GT_SectorAnalysis.keys.count" counter="$k">
                  <set_value name="$altSector" exact="global.$GT_SectorAnalysis.keys.list.{$k}"/>
                  
                  <do_if value="$altSector != $sector">
                    <set_value name="$altShipCount" exact="0"/>
                    
                    <do_if value="$sectorAssignments.{$altSector}?">
                      <set_value name="$altShipCount" exact="$sectorAssignments.{$altSector}.count"/>
                    </do_if>
                    
                    <do_if value="$altShipCount lt 2">
                      <!-- Reassign to this sector -->
                      <set_value name="global.$GT_Territories.{$ship}.$Primary" exact="$altSector"/>
                      <set_value name="$conflictsFound" exact="$conflictsFound + 1"/>
                      
                      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                        <debug_text text="'[GalaxyTrader MK3] Reassigned ' + $ship.knownname + ' from ' + $sector.knownname + ' to ' + $altSector.knownname" chance="100"/>
                      </do_if>
                      <break/>
                    </do_if>
                  </do_if>
                </do_all>
              </do_if>
            </do_all>
          </do_if>
        </do_all>
        
        <do_if value="$conflictsFound gt 0">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Resolved ' + $conflictsFound + ' territory conflicts'" chance="100"/>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Territory Performance Report -->
    <cue name="GenerateTerritoryReport" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$report" exact="'Territory Management Report\n\n'"/>
        
        <!-- Territory assignments -->
        <set_value name="$report" exact="$report + 'TERRITORY ASSIGNMENTS:\n'"/>
        
        <do_all exact="global.$GT_Ships.keys.count" counter="$i">
          <set_value name="$ship" exact="global.$GT_Ships.keys.list.{$i}"/>
          
          <do_if value="$ship.exists and global.$GT_Territories.{$ship}? and global.$GT_Territories.{$ship}.$Primary?">
            <set_value name="$primary" exact="global.$GT_Territories.{$ship}.$Primary"/>
            <set_value name="$expertise" exact="0"/>
            <set_value name="$level" exact="0"/>
            
            <do_if value="global.$GT_SectorExpertise.{$ship}? and global.$GT_SectorExpertise.{$ship}.{$primary}?">
              <set_value name="$expertise" exact="global.$GT_SectorExpertise.{$ship}.{$primary}.$Experience"/>
              <set_value name="$level" exact="global.$GT_SectorExpertise.{$ship}.{$primary}.$Level"/>
            </do_if>
            
            <set_value name="$report" exact="$report + '• ' + $ship.knownname + ': ' + $primary.knownname + ' (Level ' + $level + ', ' + $expertise + ' XP)\n'"/>
          </do_if>
        </do_all>
        
        <!-- Top sectors by score -->
        <set_value name="$report" exact="$report + '\nTOP SECTORS BY VALUE:\n'"/>
        <set_value name="$topCount" exact="[global.$GT_SectorAnalysis.keys.count, 5].min"/>
        
        <do_all exact="$topCount" counter="$i">
          <do_if value="global.$GT_SectorAnalysis.keys.count ge $i">
            <set_value name="$sector" exact="global.$GT_SectorAnalysis.keys.list.{$i}"/>
            <set_value name="$score" exact="global.$GT_SectorAnalysis.{$sector}.$Score"/>
            <set_value name="$report" exact="$report + ($i) + '. ' + $sector.knownname + ' (Score: ' + $score + ')\n'"/>
          </do_if>
        </do_all>
        
        <!-- Return report -->
        <set_value name="global.$GT_TerritoryReport" exact="$report"/>
      </actions>
    </cue>
  </cues>
</mdscript> 
