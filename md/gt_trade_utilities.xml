<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Trade_Utilities" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================= -->
    <!-- TRADE UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Is Intra-Sector Trade -->
    <library name="GT_IsIntraSectorTrade" purpose="run_actions">
      <params>
        <param name="buySector" comment="Buy station sector"/>
        <param name="sellSector" comment="Sell station sector"/>
        <param name="currentSector" comment="Ship's current sector"/>
      </params>
      <actions>
        <do_if value="$buySector? and $sellSector? and $currentSector?">
          <do_if value="$buySector == $currentSector and $sellSector == $currentSector">
            <return value="true"/>
          </do_if>
        </do_if>
        <return value="false"/>
      </actions>
    </library>
    
    <!-- Calculate Trade Efficiency -->
    <library name="GT_CalculateTradeEfficiency" purpose="run_actions">
      <params>
        <param name="profit" comment="Trade profit"/>
        <param name="distance" default="0" comment="Trade distance (jumps) - legacy parameter, used as fallback"/>
        <param name="distancePenaltyMultiplier" default="1.0" comment="Distance penalty multiplier (0.0-2.0)"/>
        <param name="factionPriority" default="2" comment="Faction priority (0=Player, 1=Foreign, 2=Equal)"/>
        <param name="buyStationOwner" default="null" comment="Buy station owner faction"/>
        <param name="sellStationOwner" default="null" comment="Sell station owner faction"/>
        <param name="homeSector" default="null" comment="Home sector for path efficiency calculation"/>
        <param name="shipSector" default="null" comment="Ship's current sector"/>
        <param name="buySector" default="null" comment="Buy station sector"/>
        <param name="sellSector" default="null" comment="Sell station sector"/>
        <param name="shipToBuyDistance" default="-1" comment="Distance from ship to buy station (for path efficiency)"/>
        <param name="buyToSellDistance" default="-1" comment="Distance from buy station to sell station"/>
        <param name="homeToBuyDistance" default="-1" comment="Distance from home sector to buy station"/>
        <param name="homeToSellDistance" default="-1" comment="Distance from home sector to sell station"/>
      </params>
      <actions>
        <!-- ✅ NEW MULTI-FACTOR DISTANCE PENALTY SYSTEM -->
        <!-- Improved scoring that separately penalizes:
             1. Ship→Buy distance (HEAVY weight - ship must travel first)
             2. Buy→Sell distance (MODERATE weight - trade route length)
             3. Home distance (LIGHT weight - territorial control)
        -->
        <set_value name="$adjustedDistance" exact="0.0"/>
        
        <!-- Check if we have all required parameters for new multi-factor system -->
        <set_value name="$useMultiFactor" exact="false"/>
        <do_if value="$shipToBuyDistance ge 0 and $buyToSellDistance ge 0 and $homeToBuyDistance ge 0 and $homeToSellDistance ge 0 and $buySector? and $sellSector?">
          <set_value name="$useMultiFactor" exact="true"/>
        </do_if>
        
        <!-- ✅ DEBUG: Log which system is being used -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Efficiency] Multi-factor=' + $useMultiFactor + ', Ship→Buy=' + $shipToBuyDistance + ', Buy→Sell=' + $buyToSellDistance + ', Home→Buy=' + $homeToBuyDistance + ', Home→Sell=' + $homeToSellDistance" chance="100"/>
        </do_if>
        
        <do_if value="$useMultiFactor">
          <!-- ✅ FACTOR 1: Ship→Buy Distance Penalty (HEAVY WEIGHT - ship must travel first) -->
          <!-- This is the most important - ship has to get to buy station first -->
          <!-- Weight: 4.0 (increased from 3.0), Quadratic base: 3.5 (steeper penalty for longer distances) -->
          <!-- Example: 7 jumps = 7 * 4 * (1 + 4) = 140 penalty units (with multiplier=2: 280 units) -->
          <!-- ✅ CRITICAL: Apply user's distance penalty multiplier setting -->
          <set_value name="$shipToBuyBase" exact="3.5"/>
          <set_value name="$shipToBuyRatio" exact="$shipToBuyDistance / $shipToBuyBase"/>
          <set_value name="$shipToBuyNonLinear" exact="1.0 + ($shipToBuyRatio * $shipToBuyRatio)"/>
          <set_value name="$shipToBuyPenalty" exact="$shipToBuyDistance * 4.0 * $shipToBuyNonLinear * $distancePenaltyMultiplier"/>
          
          <!-- ✅ FACTOR 2: Buy→Sell Distance Penalty (MODERATE WEIGHT - trade route length) -->
          <!-- Encourages shorter trade routes between stations -->
          <!-- Weight: 1.5, Quadratic base: 8.0 (moderate penalty) -->
          <!-- ✅ CRITICAL: Apply user's distance penalty multiplier setting -->
          <set_value name="$buyToSellBase" exact="8.0"/>
          <set_value name="$buyToSellRatio" exact="$buyToSellDistance / $buyToSellBase"/>
          <set_value name="$buyToSellNonLinear" exact="1.0 + ($buyToSellRatio * $buyToSellRatio)"/>
          <set_value name="$buyToSellPenalty" exact="$buyToSellDistance * 1.5 * $buyToSellNonLinear * $distancePenaltyMultiplier"/>
          
          <!-- ✅ FACTOR 3: Home Distance Penalty (LIGHT WEIGHT - territorial control) -->
          <!-- Penalize trades far from home (both stations) - encourages staying near home base -->
          <!-- Weight: 0.5, Quadratic base: 10.0 (light penalty) -->
          <!-- ✅ CRITICAL: Apply user's distance penalty multiplier setting -->
          <set_value name="$maxHomeDistance" exact="[$homeToBuyDistance, $homeToSellDistance].max"/>
          <set_value name="$homeDistanceBase" exact="10.0"/>
          <set_value name="$homeDistanceRatio" exact="$maxHomeDistance / $homeDistanceBase"/>
          <set_value name="$homeDistanceNonLinear" exact="1.0 + ($homeDistanceRatio * $homeDistanceRatio)"/>
          <set_value name="$homeDistancePenalty" exact="$maxHomeDistance * 0.5 * $homeDistanceNonLinear * $distancePenaltyMultiplier"/>
          
          <!-- Combined Adjusted Distance -->
          <set_value name="$adjustedDistance" exact="$shipToBuyPenalty + $buyToSellPenalty + $homeDistancePenalty"/>
          
          <!-- ✅ DEBUG: Log penalty breakdown -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Efficiency] Multi-factor penalties (multiplier=' + $distancePenaltyMultiplier + '): Ship→Buy=' + $shipToBuyPenalty + ', Buy→Sell=' + $buyToSellPenalty + ', Home=' + $homeDistancePenalty + ', Total=' + $adjustedDistance" chance="100"/>
          </do_if>
        </do_if>
        <do_else>
          <!-- ✅ FALLBACK: Legacy single-factor distance penalty (for batch processor, etc.) -->
          <!-- Formula: adjustedDistance = distance * multiplier * (1 + (distance / 10)^2) -->
          <!-- This creates quadratic penalty: longer distances get exponentially more penalized -->
          <!-- Examples with multiplier=2.0:
               - Distance 1:  1 * 2 * (1 + 0.01) = 2.02   (minimal penalty)
               - Distance 5:  5 * 2 * (1 + 0.25) = 12.5   (25% extra)
               - Distance 10: 10 * 2 * (1 + 1)   = 40     (100% extra = 2x)
               - Distance 20: 20 * 2 * (1 + 4)   = 200    (400% extra = 5x)
          -->
          <set_value name="$distanceBase" exact="10.0"/>
          <set_value name="$distanceRatio" exact="$distance / $distanceBase"/>
          <set_value name="$nonLinearFactor" exact="1.0 + ($distanceRatio * $distanceRatio)"/>
          <set_value name="$adjustedDistance" exact="$distance * $distancePenaltyMultiplier * $nonLinearFactor"/>
        </do_else>
        
        <!-- ✅ FIX: Convert money to number before division to avoid "Loss of data while converting floating point" error -->
        <!-- Convert profit (money in cents) to numeric value using f suffix to force float conversion -->
        <!-- Pattern from order.trade.perform.xml:243: (money / 1Cr)f forces float conversion -->
        <!-- ✅ NEW: Apply non-linear profit scaling to reduce profit dominance in scoring -->
        <!-- Formula: profitNum_scaled = profitNum / (1.0 + profitNum / profitBase) -->
        <!-- This creates diminishing returns: higher profits get scaled down more -->
        <!-- Examples:
             - Profit 10,000 Cr → profitNum = 1,000,000 → scaled = 1,000,000 / (1 + 1) = 500,000 (50% reduction)
             - Profit 20,000 Cr → profitNum = 2,000,000 → scaled = 2,000,000 / (1 + 2) = 666,667 (67% reduction)
             - Profit 260,090 Cr → profitNum = 26,009,000 → scaled = 26,009,000 / (1 + 26) = 962,556 (96% reduction)
        -->
        <!-- This means: 2x profit → ~1.33x score (instead of 2x), significantly reducing profit's overwhelming influence -->
        <set_value name="$efficiency" exact="0.0"/>
        <do_if value="$adjustedDistance gt 0">
          <!-- Convert profit from money (cents) to number by dividing by 1ct, then scale by 100 -->
          <!-- Use f suffix to force float conversion (pattern from order.trade.perform.xml:243) -->
          <set_value name="$profitNum" exact="(($profit / 1ct) * 100)f"/>
          
          <!-- ✅ NON-LINEAR PROFIT SCALING: Apply diminishing returns to reduce profit dominance -->
          <!-- profitBase controls where scaling kicks in - lower = more aggressive scaling -->
          <!-- Formula: profitNum_scaled = profitNum / (1.0 + profitNum / profitBase) -->
          <set_value name="$profitBase" exact="1000000.0"/>
          <set_value name="$profitRatio" exact="$profitNum / $profitBase"/>
          <set_value name="$profitScalingFactor" exact="1.0 + $profitRatio"/>
          <set_value name="$profitNumScaled" exact="$profitNum / $profitScalingFactor"/>
          
          <!-- Scale adjustedDistance by 10000 for precision -->
          <set_value name="$scaledDistance" exact="$adjustedDistance * 10000.0"/>
          <!-- Division: number / number = number (efficiency scaled by 10000) -->
          <!-- Note: Efficiency is now scaled by 10000, but all comparisons/scoring work correctly with scaled values -->
          <set_value name="$efficiency" exact="$profitNumScaled / $scaledDistance"/>
        </do_if>
        <do_else>
          <!-- If distance is 0, efficiency equals profit (converted to number) with same scaling -->
          <set_value name="$profitNum" exact="(($profit / 1ct) * 100)f"/>
          <set_value name="$profitBase" exact="1000000.0"/>
          <set_value name="$profitRatio" exact="$profitNum / $profitBase"/>
          <set_value name="$profitScalingFactor" exact="1.0 + $profitRatio"/>
          <set_value name="$profitNumScaled" exact="$profitNum / $profitScalingFactor"/>
          <set_value name="$efficiency" exact="$profitNumScaled"/>
        </do_else>
        
        <!-- Apply faction priority boost -->
        <do_if value="$factionPriority == 0 and ($buyStationOwner == faction.player or $sellStationOwner == faction.player)">
          <set_value name="$boost" exact="$efficiency / 5"/>
          <set_value name="$efficiency" exact="$efficiency + $boost"/>
        </do_if>
        <do_elseif value="$factionPriority == 1 and $buyStationOwner != faction.player and $sellStationOwner != faction.player">
          <set_value name="$boost" exact="$efficiency / 5"/>
          <set_value name="$efficiency" exact="$efficiency + $boost"/>
        </do_elseif>
        
        <!-- ✅ NEW: Apply "same path" bonus for efficient routing -->
        <!-- Favors trades where stations are "in order" relative to home and ship position -->
        <!-- Example: Home=E, Ship=B, Buy=C, Sell=E → Efficient (moves toward home) -->
        <!-- Example: Home=E, Ship=B, Buy=E, Sell=C → Less efficient (backtracks) -->
        <set_value name="$pathBonus" exact="1.0"/>
        <do_if value="$homeSector? and $shipSector? and $buySector? and $sellSector? and $shipToBuyDistance ge 0">
          <!-- ✅ OPTIMIZATION: Use passed distance parameters if available, otherwise calculate -->
          <set_value name="$homeToBuy" exact="-1"/>
          <set_value name="$homeToSell" exact="-1"/>
          <do_if value="$homeToBuyDistance ge 0 and $homeToSellDistance ge 0">
            <!-- Use passed parameters (from new multi-factor system) -->
            <set_value name="$homeToBuy" exact="$homeToBuyDistance"/>
            <set_value name="$homeToSell" exact="$homeToSellDistance"/>
          </do_if>
          <do_else>
            <!-- Fallback: Calculate distances (for backward compatibility) -->
            <set_value name="$homeToBuy" exact="$homeSector.gatedistance.{$buySector}"/>
            <set_value name="$homeToSell" exact="$homeSector.gatedistance.{$sellSector}"/>
          </do_else>
          
          <!-- Calculate ship→sell distance directly (path might differ from ship→buy + buy→sell) -->
          <set_value name="$shipToSell" exact="$shipSector.gatedistance.{$sellSector}"/>
          
          <!-- Only apply bonus if all distances are valid (non-negative, paths exist) -->
          <do_if value="$homeToBuy ge 0 and $homeToSell ge 0 and $shipToSell ge 0">
            <!-- Case 1: Buy station is further from home than sell station -->
            <!-- Efficient route: Ship → Buy (further) → Sell (closer) → Home -->
            <!-- This is efficient if ship is closer to buy than sell (ship between buy and sell, or beyond buy) -->
            <do_if value="$homeToBuy gt $homeToSell">
              <!-- Efficient if ship is closer to buy station than sell station -->
              <!-- This means ship can move forward (toward sell/home) without backtracking -->
              <do_if value="$shipToBuyDistance le $shipToSell">
                <!-- Same path bonus: 10% efficiency boost -->
                <set_value name="$pathBonus" exact="1.1"/>
              </do_if>
            </do_if>
            <!-- Case 2: Sell station is further from home than buy station -->
            <!-- Efficient route: Ship → Sell (further) → Buy (closer) → Home -->
            <!-- This is efficient if ship is closer to sell than buy -->
            <do_elseif value="$homeToSell gt $homeToBuy">
              <!-- Efficient if ship is closer to sell station than buy station -->
              <do_if value="$shipToSell le $shipToBuyDistance">
                <!-- Same path bonus: 10% efficiency boost -->
                <set_value name="$pathBonus" exact="1.1"/>
              </do_if>
            </do_elseif>
            <!-- Case 3: Both stations same distance from home (same sector or equidistant) -->
            <!-- Already efficient - smaller bonus -->
            <do_elseif value="$homeToBuy == $homeToSell">
              <set_value name="$pathBonus" exact="1.05"/>
            </do_elseif>
          </do_if>
        </do_if>
        
        <!-- Apply path bonus to efficiency -->
        <set_value name="$efficiency" exact="$efficiency * $pathBonus"/>
        
        <return value="$efficiency"/>
      </actions>
    </library>
    
    <!-- Get Distance Penalty Multiplier -->
    <library name="GT_GetDistancePenaltyMultiplier" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to get distance penalty for"/>
        <param name="defaultMultiplier" default="1.0" comment="Default multiplier (for 50% distance penalty)"/>
      </params>
      <actions>
        <set_value name="$distancePenalty" exact="@global.$GT_AIParameters.{$ship}.$DistancePenalty"/>
        <do_if value="$distancePenalty?">
          <!-- Convert 0-100% to 0.0-2.0: 0%=0.0, 50%=1.0, 100%=2.0 -->
          <return value="$distancePenalty / 50.0"/>
        </do_if>
        <return value="$defaultMultiplier"/>
      </actions>
    </library>
    
    <!-- Get Faction Priority Text -->
    <library name="GT_GetFactionPriorityText" purpose="run_actions">
      <params>
        <param name="factionPriority" comment="Faction priority value (0, 1, or 2)"/>
      </params>
      <actions>
        <return value="if $factionPriority == 0 then 'Player Only' else if $factionPriority == 1 then 'Foreign First' else 'Equal Priority'"/>
      </actions>
    </library>
    
    <!-- Calculate ROI from Prices -->
    <library name="GT_CalculateROIFromPrices" purpose="run_actions">
      <params>
        <param name="buyPrice" comment="Price per unit to buy"/>
        <param name="sellPrice" comment="Price per unit to sell"/>
      </params>
      <actions>
        <!-- Calculate ROI as percentage: ((sellPrice - buyPrice) / buyPrice) * 100 -->
        <do_if value="$buyPrice gt 0">
          <return value="(($sellPrice - $buyPrice) * 100) / $buyPrice"/>
        </do_if>
        <return value="0"/>
      </actions>
    </library>
    
    <!-- Get Skill-Based Multiplier -->
    <library name="GT_GetSkillMultiplier" purpose="run_actions">
      <params>
        <param name="skillLevel" comment="Pilot skill level (1-15+)"/>
      </params>
      <actions>
        <!-- Returns multiplier: 0.5 at Lv1 → 2.0 at Lv15 -->
        <!-- Formula: 0.5 + ((skillLevel - 1) * (1.5 / 14)) -->
        <return value="0.5 + (($skillLevel - 1) * (1.5 / 14))"/>
      </actions>
    </library>
    
    <!-- Get Pilot Level-Based Profit Threshold -->
    <library name="GT_GetPilotLevelProfitThreshold" purpose="run_actions">
      <params>
        <param name="skillLevel" comment="Pilot skill level (1-15+)"/>
        <param name="configBaseProfit" default="10000" comment="Base profit from config (deprecated - kept for compatibility but not used)"/>
      </params>
      <actions>
        <!-- Returns profit threshold in raw format (centicredits) based on pilot level:
             Non-linear (quadratic) progression from Level 1 (0 Cr) to Level 15 (10000 Cr)
             Formula: 1000000 * ((skillLevel - 1) / 14)^2
             This creates a quadratic curve that starts at 0 Cr and accelerates to 10000 Cr:
             Level 1: 0 Cr (0 raw)
             Level 2: ~51 Cr (5,102 raw)
             Level 3: ~204 Cr (20,408 raw)
             Level 4: ~459 Cr (45,918 raw)
             Level 5: ~816 Cr (81,633 raw)
             Level 10: ~3,673 Cr (367,347 raw)
             Level 15: 10,000 Cr (1,000,000 raw)
        -->
        <!-- Level 1-15+: Non-linear (quadratic) progression from 0 Cr to 10000 Cr -->
        <!-- ✅ FIX: Avoid integer division by rearranging formula -->
        <!-- Original: 1000000 * ((skillLevel - 1) / 14)^2 -->
        <!-- Rearranged: ((skillLevel - 1)^2 * 1000000) / 196 -->
        <!-- This avoids floating-point division issues in MD by doing integer math -->
        <!-- This creates an accelerating curve - lower levels have lower thresholds, -->
        <!-- higher levels require much more profit (more selective traders) -->
        <set_value name="$numerator" exact="($skillLevel - 1) * ($skillLevel - 1) * 1000000"/>
        <set_value name="$result" exact="$numerator / 196"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Validate Trade -->
    <library name="GT_IsTradeValid" purpose="run_actions">
      <params>
        <param name="trade" comment="Trade object to validate"/>
        <param name="minScore" default="0" comment="Minimum score required (default: 0 = any positive score)"/>
      </params>
      <actions>
        <!-- ✅ CRITICAL: Validate trade has all required properties -->
        <set_value name="$testBuyOffer" exact="@$trade.$BuyOffer"/>
        <set_value name="$testSellOffer" exact="@$trade.$SellOffer"/>
        <set_value name="$testScore" exact="@$trade.$Score"/>
        <do_if value="$testBuyOffer? and $testSellOffer? and $testScore? and $testScore gt $minScore">
          <set_value name="$testWare" exact="@$testBuyOffer.ware"/>
          <do_if value="$testWare?">
            <return value="true"/>
          </do_if>
        </do_if>
        <return value="false"/>
      </actions>
    </library>
    
    <!-- Calculate Max Tradeable Amount -->
    <library name="GT_CalculateMaxTradeableAmount" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship for cargo capacity calculation"/>
        <param name="ware" comment="Ware to calculate capacity for"/>
        <param name="buyOfferAmount" comment="Buy offer amount"/>
        <param name="sellOfferAmount" comment="Sell offer amount"/>
        <param name="availableMoney" default="999999Cr" comment="Available money"/>
        <param name="buyPrice" default="0" comment="Buy price per unit"/>
      </params>
      <actions>
        <!-- Calculate max cargo capacity for this ware -->
        <set_value name="$maxCargoCapacity" exact="($ship.cargo.free.all / $ware.volume)i"/>
        <!-- Calculate max affordable based on available money -->
        <set_value name="$maxAffordable" exact="99999"/>
        <do_if value="$buyPrice gt 0">
          <set_value name="$maxAffordable" exact="($availableMoney / $buyPrice)i"/>
        </do_if>
        <!-- Return minimum of offer amounts, cargo capacity, and money limit -->
        <return value="[$buyOfferAmount, $sellOfferAmount, $maxCargoCapacity, $maxAffordable].min"/>
      </actions>
    </library>
    
    <!-- Index Offers By Ware -->
    <library name="GT_IndexOffersByWare" purpose="run_actions">
      <params>
        <param name="offersList" comment="List of trade offers to index"/>
      </params>
      <actions>
        <set_value name="$offersByWare" exact="table[]"/>
        <do_all exact="$offersList.count" counter="$i">
          <set_value name="$offer" exact="$offersList.{$i}"/>
          <do_if value="not $offersByWare.{$offer.ware}?">
            <set_value name="$offersByWare.{$offer.ware}" exact="[]"/>
          </do_if>
          <append_to_list name="$offersByWare.{$offer.ware}" exact="$offer"/>
        </do_all>
        <return value="$offersByWare"/>
      </actions>
    </library>
    
    <!-- Filter Offers By Distance -->
    <library name="GT_FilterOffersByDistance" purpose="run_actions">
      <params>
        <param name="offersList" comment="List of offers to filter"/>
        <param name="homeSector" comment="Home/base sector for distance calculation"/>
        <param name="maxDistance" comment="Maximum distance (jumps)"/>
      </params>
      <actions>
        <set_value name="$filteredOffers" exact="[]"/>
        <set_value name="$filteredCount" exact="0"/>
        <do_all exact="$offersList.count" counter="$i">
          <set_value name="$offer" exact="$offersList.{$i}"/>
          <set_value name="$targetSector" exact="$offer.owner.sector"/>
          
          <!-- Calculate range-only distance (using library function) -->
          <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculateRangeOnlyDistance" result="$distance">
            <param name="fromSector" value="$homeSector"/>
            <param name="toSector" value="$targetSector"/>
          </run_actions>
          
          <!-- Keep offer if within max distance and path exists (distance >= 0) -->
          <do_if value="$distance ge 0 and $distance le $maxDistance">
            <append_to_list name="$filteredOffers" exact="$offer"/>
          </do_if>
          <do_else>
            <set_value name="$filteredCount" exact="$filteredCount + 1"/>
          </do_else>
        </do_all>
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$FilteredOffers" exact="$filteredOffers"/>
        <set_value name="$result.$FilteredCount" exact="$filteredCount"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Sort and Limit Offers -->
    <library name="GT_SortAndLimitOffers" purpose="run_actions">
      <params>
        <param name="offersList" comment="List of offers to sort and limit"/>
        <param name="maxCount" comment="Maximum number of offers to return"/>
        <param name="sortAscending" default="true" comment="If true, sort ascending (take first N), if false sort descending (take last N)"/>
      </params>
      <actions>
        <set_value name="$offers" exact="$offersList"/>
        <!-- Sort by relativeprice -->
        <sort_trades name="$offers" tradelist="$offers" sorter="relativeprice"/>
        
        <set_value name="$limitedOffers" exact="[]"/>
        <do_if value="$sortAscending">
          <!-- Take first N offers (lowest price for buy offers) -->
          <set_value name="$limitCount" exact="[$offers.count, $maxCount].min"/>
          <do_all exact="$limitCount" counter="$idx">
            <append_to_list name="$limitedOffers" exact="$offers.{$idx}"/>
          </do_all>
        </do_if>
        <do_else>
          <!-- Take last N offers (highest price for sell offers) -->
          <do_if value="$offers.count gt $maxCount">
            <set_value name="$startIndex" exact="$offers.count - $maxCount + 1"/>
            <do_all exact="$maxCount" counter="$idx">
              <set_value name="$actualIndex" exact="$startIndex + $idx - 1"/>
              <append_to_list name="$limitedOffers" exact="$offers.{$actualIndex}"/>
            </do_all>
          </do_if>
          <do_else>
            <!-- Less than limit, take all -->
            <do_all exact="$offers.count" counter="$idx">
              <append_to_list name="$limitedOffers" exact="$offers.{$idx}"/>
            </do_all>
          </do_else>
        </do_else>
        <return value="$limitedOffers"/>
      </actions>
    </library>
    
    <!-- Sort Trades By Score (highest first) -->
    <library name="GT_SortTradesByScore" purpose="run_actions">
      <params>
        <param name="tradeList" comment="List of trades to sort"/>
      </params>
      <actions>
        <!-- ✅ OPTIMIZATION #5: Optimize sort for small lists (≤10 items: O(n) vs O(n²)) -->
        <do_if value="$tradeList? and $tradeList.count gt 1">
          <do_if value="$tradeList.count gt 10">
            <!-- Large list: Full selection sort (necessary for proper ordering) -->
            <set_value name="$sortedTradeList" exact="[]"/>
            <set_value name="$remainingTrades" exact="$tradeList"/>
            <do_all exact="$tradeList.count" counter="$sortIdx">
              <set_value name="$maxScore" exact="-999999999"/>
              <set_value name="$maxIdx" exact="-1"/>
              <do_all exact="$remainingTrades.count" counter="$i">
                <set_value name="$trade" exact="$remainingTrades.{$i}"/>
                <set_value name="$tradeScore" exact="$trade.$Score"/>
                <do_if value="$tradeScore gt $maxScore">
                  <set_value name="$maxScore" exact="$tradeScore"/>
                  <set_value name="$maxIdx" exact="$i"/>
                </do_if>
              </do_all>
              <do_if value="$maxIdx ge 0">
                <append_to_list name="$sortedTradeList" exact="$remainingTrades.{$maxIdx}"/>
                <remove_value name="$remainingTrades.{$maxIdx}"/>
              </do_if>
            </do_all>
            <set_value name="$tradeList" exact="$sortedTradeList"/>
          </do_if>
          <do_elseif value="$tradeList.count gt 1">
            <!-- Small list (2-10): Single pass bubble-like sort (O(n²) but n is small) -->
            <set_value name="$sortedTradeList" exact="$tradeList"/>
            <!-- Single pass: swap adjacent elements if wrong order (n-1 comparisons) -->
            <do_all exact="$tradeList.count - 1" counter="$pass">
              <set_value name="$swapped" exact="false"/>
              <do_all exact="$tradeList.count - 1 - $pass" counter="$i">
                <set_value name="$currentScore" exact="$sortedTradeList.{$i}.$Score"/>
                <set_value name="$nextScore" exact="$sortedTradeList.{$i + 1}.$Score"/>
                <do_if value="$currentScore lt $nextScore">
                  <!-- Swap -->
                  <set_value name="$temp" exact="$sortedTradeList.{$i}"/>
                  <set_value name="$sortedTradeList.{$i}" exact="$sortedTradeList.{$i + 1}"/>
                  <set_value name="$sortedTradeList.{$i + 1}" exact="$temp"/>
                  <set_value name="$swapped" exact="true"/>
                </do_if>
              </do_all>
              <!-- Early exit if no swaps (already sorted) -->
              <do_if value="not $swapped">
                <break/>
              </do_if>
            </do_all>
            <set_value name="$tradeList" exact="$sortedTradeList"/>
          </do_elseif>
          <!-- Single item or empty: no sort needed -->
        </do_if>
        <return value="$tradeList"/>
      </actions>
    </library>
    
    <!-- Filter Trade For Ship (ware basket, illegal, blacklist, path availability) -->
    <library name="GT_FilterTradeForShip" purpose="run_actions">
      <params>
        <param name="trade" comment="Trade to filter"/>
        <param name="ship" comment="Ship that would execute the trade"/>
        <param name="ware" comment="Ware being traded"/>
        <param name="wareBasket" comment="Allowed ware basket (empty = all wares allowed)"/>
        <param name="allowIllegal" default="false" comment="Whether to allow illegal wares"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group"/>
        <param name="currentSector" comment="Ship's current sector"/>
        <param name="buySector" comment="Buy station sector"/>
        <param name="sellSector" comment="Sell station sector"/>
        <param name="filterStats" default="null" comment="Optional filter statistics table to update"/>
        <param name="isIntraSectorTrade" default="false" comment="Whether this is an intra-sector trade"/>
      </params>
      <actions>
        <!-- Initialize result -->
        <set_value name="$isAllowed" exact="true"/>
        <set_value name="$filterReason" exact="''"/>
        
        <!-- ✅ CARGO TYPE COMPATIBILITY CHECK: Skip wares ship cannot carry -->
        <!-- Some wares (like Methane/gas, Feststoffe/solids) require special cargo bays -->
        <set_value name="$canCarryWareType" exact="false"/>
        <do_if value="$ware? and $ware != null">
          <!-- Check if ship has cargo bay capacity for this specific ware type -->
          <set_value name="$canCarryWareType" exact="$ship.cargo.{$ware}.max gt 0"/>
        </do_if>
        <do_if value="not $canCarryWareType">
          <set_value name="$isAllowed" exact="false"/>
          <set_value name="$filterReason" exact="'incompatible_cargo'"/>
          <do_if value="$filterStats?">
            <!-- Track in filter stats if provided -->
            <do_if value="not $filterStats.$filteredByIncompatibleCargo?">
              <set_value name="$filterStats.$filteredByIncompatibleCargo" exact="0"/>
            </do_if>
            <set_value name="$filterStats.$filteredByIncompatibleCargo" exact="$filterStats.$filteredByIncompatibleCargo + 1"/>
          </do_if>
          <!-- Return early - ship cannot carry this ware type -->
          <set_value name="$result" exact="table[]"/>
          <set_value name="$result.$IsAllowed" exact="$isAllowed"/>
          <set_value name="$result.$FilterReason" exact="$filterReason"/>
          <return value="$result"/>
        </do_if>
        
        <!-- ✅ PERFORMANCE OPTIMIZATION: Cheap checks first (ware basket, illegal) -->
        <!-- Ware basket check -->
        <set_value name="$wareAllowed" exact="true"/>
        <do_if value="$wareBasket? and $wareBasket != null and $wareBasket.count gt 0">
          <run_actions ref="md.GT_Utilities.GT_IsWareInBasket" result="$wareAllowed">
            <param name="ware" value="$ware"/>
            <param name="basket" value="$wareBasket"/>
          </run_actions>
          <do_if value="not $wareAllowed">
            <set_value name="$isAllowed" exact="false"/>
            <set_value name="$filterReason" exact="'ware_basket'"/>
            <do_if value="$filterStats?">
              <set_value name="$filterStats.$filteredByWareBasket" exact="$filterStats.$filteredByWareBasket + 1"/>
            </do_if>
            <!-- ✅ PERFORMANCE OPTIMIZATION: Early return - skip expensive checks (blacklist, pathfinding) -->
            <set_value name="$result" exact="table[]"/>
            <set_value name="$result.$IsAllowed" exact="$isAllowed"/>
            <set_value name="$result.$FilterReason" exact="$filterReason"/>
            <return value="$result"/>
          </do_if>
        </do_if>
        
        <!-- Illegal ware check -->
        <do_if value="$wareAllowed and not $allowIllegal and @$ware.illegal">
          <set_value name="$wareAllowed" exact="false"/>
          <set_value name="$isAllowed" exact="false"/>
          <set_value name="$filterReason" exact="'illegal'"/>
          <do_if value="$filterStats?">
            <set_value name="$filterStats.$filteredByIllegal" exact="$filterStats.$filteredByIllegal + 1"/>
          </do_if>
          <!-- ✅ PERFORMANCE OPTIMIZATION: Early return - skip expensive checks (blacklist, pathfinding) -->
          <set_value name="$result" exact="table[]"/>
          <set_value name="$result.$IsAllowed" exact="$isAllowed"/>
          <set_value name="$result.$FilterReason" exact="$filterReason"/>
          <return value="$result"/>
        </do_if>
        
        <!-- ✅ PERFORMANCE OPTIMIZATION: Expensive checks only if cheap checks pass -->
        <!-- Blacklist check -->
        <set_value name="$isBlacklisted" exact="false"/>
        <do_if value="$wareAllowed">
          <!-- ✅ FIX: Block intra-sector trades in blacklisted sectors (force escape) -->
          <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$currentSectorIsBlacklisted">
            <param name="sector" value="$currentSector"/>
            <param name="ship" value="$ship"/>
            <param name="blacklistgroup" value="$blacklistgroup"/>
          </run_actions>
          <do_if value="$currentSectorIsBlacklisted">
            <do_if value="$buySector == $currentSector and $sellSector == $currentSector">
              <!-- Intra-sector trade in blacklisted sector - BLOCK to force escape -->
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_intra'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check buy station blacklist -->
          <do_if value="not $isBlacklisted">
            <set_value name="$buyStation" exact="@$trade.$BuyStation"/>
            <run_actions ref="md.GT_Blacklist_Utilities.GT_IsStationBlacklisted" result="$buyStationBlacklisted">
              <param name="station" value="$buyStation"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$buyStationBlacklisted">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_buy_station'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check sell station blacklist -->
          <do_if value="not $isBlacklisted">
            <set_value name="$sellStation" exact="@$trade.$SellStation"/>
            <run_actions ref="md.GT_Blacklist_Utilities.GT_IsStationBlacklisted" result="$sellStationBlacklisted">
              <param name="station" value="$sellStation"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$sellStationBlacklisted">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_sell_station'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check buy sector blacklist -->
          <do_if value="not $isBlacklisted">
            <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$buySectorBlacklisted">
              <param name="sector" value="$buySector"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$buySectorBlacklisted">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_buy_sector'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check sell sector blacklist -->
          <do_if value="not $isBlacklisted">
            <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$sellSectorBlacklisted">
              <param name="sector" value="$sellSector"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$sellSectorBlacklisted">
              <do_if value="$sellSector != $currentSector">
                <!-- Ship needs to travel TO a blacklisted sector - BLOCK -->
                <set_value name="$isBlacklisted" exact="true"/>
                <set_value name="$isAllowed" exact="false"/>
                <set_value name="$filterReason" exact="'blacklist_sell_sector'"/>
                <do_if value="$filterStats?">
                  <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
                </do_if>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Path availability check -->
          <do_if value="not $isBlacklisted">
            <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculateTradePathDistances" result="$pathResult">
              <param name="ship" value="$ship"/>
              <param name="currentSector" value="$currentSector"/>
              <param name="buySector" value="$buySector"/>
              <param name="sellSector" value="$sellSector"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            
            <!-- Debug logging (if enabled) -->
            <!-- ✅ FIX: Only log intra-sector trades for isolated ships (they're common for non-isolated ships) -->
            <!-- Always log unreachable paths as they indicate problems -->
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <set_value name="$shouldLogIntraSector" exact="false"/>
              <do_if value="$pathResult.$IsIntraSectorTrade">
                <!-- Check if ship is isolated - only log intra-sector trades for isolated ships -->
                <do_if value="$currentSector?">
                  <run_actions ref="md.GT_Blacklist_Utilities.GT_CheckConnectedSectorsBlacklisted" result="$isolationCheck">
                    <param name="sector" value="$currentSector"/>
                    <param name="ship" value="$ship"/>
                    <param name="returnDetails" value="false"/>
                  </run_actions>
                  <set_value name="$isolatedValue" exact="@$isolationCheck.$IsIsolated"/>
                  <set_value name="$shouldLogIntraSector" exact="if $isolatedValue? and ($isolatedValue == true or $isolatedValue == 1) then true else false"/>
                </do_if>
              </do_if>
              <do_if value="$shouldLogIntraSector or not $pathResult.$IsReachable">
                <set_value name="$buySectorName" exact="@$buySector.knownname"/>
                <set_value name="$sellSectorName" exact="@$sellSector.knownname"/>
                <set_value name="$currentSectorName" exact="@$currentSector.knownname"/>
                <set_value name="$wareName" exact="@$ware.name"/>
                <set_value name="$tradeType" exact="if $pathResult.$IsIntraSectorTrade then 'INTRA-SECTOR' else 'CROSS-SECTOR'"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Resume] ' + $ship.idcode + ': ' + $tradeType + ' trade (' + $wareName + '):' +
                    '\n  Current sector: ' + $currentSectorName + ' (blacklisted: ' + $pathResult.$CurrentSectorIsBlacklisted + ')' +
                    '\n  Buy sector: ' + $buySectorName + ' (distance: ' + $pathResult.$BuyPathDistance + ', same as current: ' + ($buySector == $currentSector) + ')' +
                    '\n  Sell sector: ' + $sellSectorName + ' (distance: ' + $pathResult.$SellPathDistance + ', same as buy: ' + ($sellSector == $buySector) + ', same as current: ' + ($sellSector == $currentSector) + ')' +
                    (if not $pathResult.$IsReachable then ' [PATH BLOCKED]' else '')"
                    chance="100"/>
                </do_if>
              </do_if>
            </do_if>
            
            <!-- Block if paths are unreachable -->
            <do_if value="not $pathResult.$IsReachable">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'path_blocked'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByPathBlocked" exact="$filterStats.$filteredByPathBlocked + 1"/>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Return result -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IsAllowed" exact="$isAllowed"/>
        <set_value name="$result.$FilterReason" exact="$filterReason"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Build Docking Cache -->
    <library name="GT_BuildDockingCache" purpose="run_actions">
      <params>
        <param name="sellOffers" comment="List of sell offers"/>
        <param name="buyOffers" comment="List of buy offers"/>
        <param name="ship" comment="Ship to check docking for"/>
      </params>
      <actions>
        <set_value name="$dockingCache" exact="table[]"/>
        <set_value name="$uniqueStations" exact="table[]"/>
        
        <!-- Collect all unique stations from sell offers -->
        <do_all exact="$sellOffers.count" counter="$i">
          <set_value name="$offer" exact="$sellOffers.{$i}"/>
          <set_value name="$station" exact="@$offer.owner"/>
          <!-- Validate station is valid before using as table key -->
          <set_value name="$stationValid" exact="false"/>
          <do_if value="$station? and not ($station == null)">
            <set_value name="$stationId" exact="@$station.idcode"/>
            <do_if value="$stationId?">
              <set_value name="$stationValid" exact="true"/>
            </do_if>
          </do_if>
          <do_if value="$stationValid and $station? and not ($station == null)">
            <do_if value="not $uniqueStations.{$station}?">
              <set_value name="$uniqueStations.{$station}" exact="true"/>
            </do_if>
          </do_if>
        </do_all>
        
        <!-- Collect all unique stations from buy offers -->
        <do_all exact="$buyOffers.count" counter="$i">
          <set_value name="$offer" exact="$buyOffers.{$i}"/>
          <set_value name="$station" exact="@$offer.owner"/>
          <!-- Validate station is valid before using as table key -->
          <set_value name="$stationValid" exact="false"/>
          <do_if value="$station? and not ($station == null)">
            <set_value name="$stationId" exact="@$station.idcode"/>
            <do_if value="$stationId?">
              <set_value name="$stationValid" exact="true"/>
            </do_if>
          </do_if>
          <do_if value="$stationValid and $station? and not ($station == null)">
            <do_if value="not $uniqueStations.{$station}?">
              <set_value name="$uniqueStations.{$station}" exact="true"/>
            </do_if>
          </do_if>
        </do_all>
        
        <!-- Pre-cache docking permissions for all unique stations -->
        <do_all exact="$uniqueStations.keys.count" counter="$stationIdx">
          <set_value name="$station" exact="$uniqueStations.keys.{$stationIdx}"/>
          <set_value name="$canDock" exact="@$station.dockingallowed.{$ship}"/>
          <set_value name="$dockingCache.{$station}" exact="$canDock"/>
        </do_all>
        
        <return value="$dockingCache"/>
      </actions>
    </library>
    
    <!-- Separate Offers By Sector -->
    <library name="GT_SeparateOffersBySector" purpose="run_actions">
      <params>
        <param name="sellOffers" comment="List of sell offers"/>
        <param name="buyOffers" comment="List of buy offers"/>
        <param name="currentSector" comment="Current sector to compare against"/>
      </params>
      <actions>
        <set_value name="$intraSectorSellOffers" exact="[]"/>
        <set_value name="$intraSectorBuyOffers" exact="[]"/>
        <set_value name="$crossSectorSellOffers" exact="[]"/>
        <set_value name="$crossSectorBuyOffers" exact="[]"/>
        
        <!-- ✅ FIX: Validate currentSector is set and not null -->
        <do_if value="not $currentSector?">
          <!-- If currentSector is null, all offers are cross-sector -->
          <set_value name="$crossSectorSellOffers" exact="$sellOffers"/>
          <set_value name="$crossSectorBuyOffers" exact="$buyOffers"/>
        </do_if>
        <do_else>
          <!-- Separate sell offers -->
          <do_all exact="$sellOffers.count" counter="$idx">
            <set_value name="$offer" exact="$sellOffers.{$idx}"/>
            <set_value name="$offerSector" exact="@$offer.owner.sector"/>
            <!-- ✅ FIX: Compare sectors directly - == should work for same component reference -->
            <do_if value="$offerSector? and $offerSector == $currentSector">
              <append_to_list name="$intraSectorSellOffers" exact="$offer"/>
            </do_if>
            <do_else>
              <append_to_list name="$crossSectorSellOffers" exact="$offer"/>
            </do_else>
          </do_all>
          
          <!-- Separate buy offers -->
          <do_all exact="$buyOffers.count" counter="$idx">
            <set_value name="$offer" exact="$buyOffers.{$idx}"/>
            <set_value name="$offerSector" exact="@$offer.owner.sector"/>
            <!-- ✅ FIX: Compare sectors directly - == should work for same component reference -->
            <do_if value="$offerSector? and $offerSector == $currentSector">
              <append_to_list name="$intraSectorBuyOffers" exact="$offer"/>
            </do_if>
            <do_else>
              <append_to_list name="$crossSectorBuyOffers" exact="$offer"/>
            </do_else>
          </do_all>
        </do_else>
        
        <!-- Return result table -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IntraSectorSell" exact="$intraSectorSellOffers"/>
        <set_value name="$result.$IntraSectorBuy" exact="$intraSectorBuyOffers"/>
        <set_value name="$result.$CrossSectorSell" exact="$crossSectorSellOffers"/>
        <set_value name="$result.$CrossSectorBuy" exact="$crossSectorBuyOffers"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Calculate Trade Thresholds -->
    <library name="GT_CalculateTradeThresholds" purpose="run_actions">
      <params>
        <param name="minROI" comment="Base minimum ROI"/>
        <param name="minAbsoluteProfit" comment="Base minimum profit"/>
        <param name="useAdvancedAnalytics" default="false" comment="Apply 95% multiplier"/>
        <param name="isIntraSector" default="false" comment="Is intra-sector trade"/>
        <param name="isIsolated" default="false" comment="Is ship isolated"/>
      </params>
      <actions>
        <set_value name="$roiThreshold" exact="$minROI"/>
        <set_value name="$profitThreshold" exact="$minAbsoluteProfit"/>
        
        <!-- Apply advanced analytics adjustment -->
        <!-- ✅ FIX: Use integer math to avoid floating-point to money conversion warnings -->
        <!-- CRITICAL: $profitThreshold is already in raw format (centicredits), so don't use Cr suffix -->
        <do_if value="$useAdvancedAnalytics">
          <set_value name="$roiThreshold" exact="$roiThreshold * 0.95"/>
          <set_value name="$profitThreshold" exact="$profitThreshold * 95 / 100"/>
        </do_if>
        
        <!-- Apply intra-sector/isolation adjustments -->
        <!-- ✅ FIX: Use integer math to avoid floating-point to money conversion warnings -->
        <!-- CRITICAL: $profitThreshold is already in raw format (centicredits), so divide by 2 (or multiply by 50/100) without Cr suffix -->
        <do_if value="$isIntraSector">
          <do_if value="$isIsolated">
            <!-- Isolated intra-sector: 25% of threshold -->
            <set_value name="$roiThreshold" exact="$roiThreshold * 0.25"/>
            <set_value name="$profitThreshold" exact="$profitThreshold * 25 / 100"/>
          </do_if>
          <do_else>
            <!-- Normal intra-sector: 50% of threshold -->
            <set_value name="$roiThreshold" exact="$roiThreshold * 0.5"/>
            <set_value name="$profitThreshold" exact="$profitThreshold / 2"/>
          </do_else>
        </do_if>
        
        <!-- Return result table -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$ROIThreshold" exact="$roiThreshold"/>
        <set_value name="$result.$ProfitThreshold" exact="$profitThreshold"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Create Trade Object -->
    <library name="GT_CreateTradeObject" purpose="run_actions">
      <params>
        <param name="sellOffer" comment="Sell offer"/>
        <param name="buyOffer" comment="Buy offer"/>
        <param name="sellStation" comment="Sell station"/>
        <param name="buyStation" comment="Buy station"/>
        <param name="amount" comment="Trade amount"/>
        <param name="profit" comment="Trade profit"/>
        <param name="roi" comment="Trade ROI"/>
        <param name="efficiency" comment="Trade efficiency score"/>
        <param name="buyPrice" comment="Buy price"/>
        <param name="sellPrice" comment="Sell price"/>
        <param name="distance" default="0" comment="Route distance"/>
        <param name="risk" default="0" comment="Trade risk"/>
      </params>
      <actions>
        <set_value name="$trade" exact="table[
          $BuyOffer = $sellOffer,
          $SellOffer = $buyOffer,
          $BuyStation = $sellStation,
          $SellStation = $buyStation,
          $Amount = $amount,
          $Profit = $profit,
          $ROI = $roi,
          $Score = $efficiency,
          $BuyPrice = $buyPrice,
          $SellPrice = $sellPrice,
          $Distance = $distance,
          $Risk = $risk
        ]"/>
        <return value="$trade"/>
      </actions>
    </library>
    
    <!-- Add Intra-Sector Offers -->
    <library name="GT_AddIntraSectorOffers" purpose="run_actions">
      <params>
        <param name="originalSellOffers" comment="Original sell offers before limiting"/>
        <param name="originalBuyOffers" comment="Original buy offers before limiting"/>
        <param name="limitedSellOffers" comment="Limited sell offers (will be modified)"/>
        <param name="limitedBuyOffers" comment="Limited buy offers (will be modified)"/>
        <param name="currentSector" comment="Current sector"/>
        <param name="currentSectorIsBlacklisted" default="false" comment="Is current sector blacklisted"/>
      </params>
      <actions>
        <set_value name="$addedSellCount" exact="0"/>
        <set_value name="$addedBuyCount" exact="0"/>
        
        <!-- Only add intra-sector offers if current sector is not blacklisted -->
        <do_if value="$currentSector? and not $currentSectorIsBlacklisted">
          <!-- Scan original sell offers for intra-sector ones not in limited list -->
          <do_all exact="$originalSellOffers.count" counter="$idx">
            <set_value name="$offer" exact="$originalSellOffers.{$idx}"/>
            <set_value name="$offerSector" exact="@$offer.owner.sector"/>
            <do_if value="$offerSector? and $offerSector == $currentSector">
              <!-- Check if already in limited list -->
              <set_value name="$alreadyIncluded" exact="false"/>
              <do_all exact="$limitedSellOffers.count" counter="$checkIdx">
                <do_if value="$limitedSellOffers.{$checkIdx} == $offer">
                  <set_value name="$alreadyIncluded" exact="true"/>
                  <break/>
                </do_if>
              </do_all>
              <!-- Add if not already included -->
              <do_if value="not $alreadyIncluded">
                <append_to_list name="$limitedSellOffers" exact="$offer"/>
                <set_value name="$addedSellCount" operation="add"/>
              </do_if>
            </do_if>
          </do_all>
          
          <!-- Scan original buy offers for intra-sector ones not in limited list -->
          <do_all exact="$originalBuyOffers.count" counter="$idx">
            <set_value name="$offer" exact="$originalBuyOffers.{$idx}"/>
            <set_value name="$offerSector" exact="@$offer.owner.sector"/>
            <do_if value="$offerSector? and $offerSector == $currentSector">
              <!-- Check if already in limited list -->
              <set_value name="$alreadyIncluded" exact="false"/>
              <do_all exact="$limitedBuyOffers.count" counter="$checkIdx">
                <do_if value="$limitedBuyOffers.{$checkIdx} == $offer">
                  <set_value name="$alreadyIncluded" exact="true"/>
                  <break/>
                </do_if>
              </do_all>
              <!-- Add if not already included -->
              <do_if value="not $alreadyIncluded">
                <append_to_list name="$limitedBuyOffers" exact="$offer"/>
                <set_value name="$addedBuyCount" operation="add"/>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
        
        <!-- Return result table -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$UpdatedSellOffers" exact="$limitedSellOffers"/>
        <set_value name="$result.$UpdatedBuyOffers" exact="$limitedBuyOffers"/>
        <set_value name="$result.$AddedSellCount" exact="$addedSellCount"/>
        <set_value name="$result.$AddedBuyCount" exact="$addedBuyCount"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Validate Trade Offer Pair -->
    <library name="GT_ValidateTradeOfferPair" purpose="run_actions">
      <params>
        <param name="sellOffer" comment="Sell offer to validate"/>
        <param name="buyOffer" comment="Buy offer to validate"/>
      </params>
      <actions>
        <!-- Validate sell offer -->
        <set_value name="$sellOfferOwner" exact="@$sellOffer.owner"/>
        <set_value name="$sellOfferPrice" exact="@$sellOffer.unitprice"/>
        <do_if value="not $sellOffer? or not $sellOfferOwner? or not $sellOfferPrice?">
          <return value="false"/>
        </do_if>
        
        <!-- Validate buy offer -->
        <set_value name="$buyOfferOwner" exact="@$buyOffer.owner"/>
        <set_value name="$buyOfferPrice" exact="@$buyOffer.unitprice"/>
        <do_if value="not $buyOffer? or not $buyOfferOwner? or not $buyOfferPrice?">
          <return value="false"/>
        </do_if>
        
        <!-- Different stations only -->
        <do_if value="$sellOfferOwner == $buyOfferOwner">
          <return value="false"/>
        </do_if>
        
        <return value="true"/>
      </actions>
    </library>
    
    <!-- Check Failed Sector Pair -->
    <library name="GT_CheckFailedSectorPair" purpose="run_actions">
      <params>
        <param name="buySector" comment="Buy station sector"/>
        <param name="sellSector" comment="Sell station sector"/>
        <param name="failedTrades" comment="List of failed trades to check against"/>
      </params>
      <actions>
        <set_value name="$isFailed" exact="false"/>
        <do_if value="$failedTrades.count gt 0">
          <do_all exact="$failedTrades.count" counter="$failIdx">
            <set_value name="$failedTrade" exact="$failedTrades.{$failIdx}"/>
            <do_if value="$failedTrade.$BuySector? and $failedTrade.$SellSector?">
              <do_if value="$buySector == $failedTrade.$BuySector and $sellSector == $failedTrade.$SellSector">
                <set_value name="$isFailed" exact="true"/>
                <break/>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
        <return value="$isFailed"/>
      </actions>
    </library>
    
    <!-- Check Route Conflict -->
    <library name="GT_CheckRouteConflict" purpose="run_actions">
      <params>
        <param name="sellStation" comment="Sell station"/>
        <param name="buyStation" comment="Buy station"/>
        <param name="ware" comment="Ware being traded"/>
        <param name="reservedRoutes" comment="List of reserved route keys"/>
      </params>
      <actions>
        <set_value name="$isConflicted" exact="false"/>
        <do_if value="$reservedRoutes.count gt 0">
          <set_value name="$tradeCacheKey" exact="$sellStation.idcode + '_' + $buyStation.idcode + '_' + $ware"/>
          <set_value name="$isConflicted" exact="$reservedRoutes.indexof.{$tradeCacheKey}?"/>
        </do_if>
        <return value="$isConflicted"/>
      </actions>
    </library>
    
    <!-- Update Trade Quota -->
    <library name="GT_UpdateTradeQuota" purpose="run_actions">
      <params>
        <param name="tradesPerWare" comment="Table of trades per ware (may be null or invalid)"/>
        <param name="ware" comment="Ware to update quota for"/>
        <param name="increment" default="1" comment="Amount to increment"/>
      </params>
      <actions>
        <!-- Ensure tradesPerWare is a valid table -->
        <set_value name="$validTable" exact="$tradesPerWare"/>
        <set_value name="$keysCheck" exact="@$validTable.keys"/>
        <set_value name="$countCheck" exact="@$keysCheck.count"/>
        <do_if value="not $countCheck? or $countCheck lt 0">
          <set_value name="$validTable" exact="table[]"/>
        </do_if>
        
        <!-- Get current count for this ware -->
        <set_value name="$currentCount" exact="0"/>
        <do_if value="$validTable.{$ware}?">
          <set_value name="$currentCount" exact="$validTable.{$ware}"/>
        </do_if>
        
        <!-- Update count -->
        <set_value name="$newCount" exact="$currentCount + $increment"/>
        <set_value name="$validTable.{$ware}" exact="$newCount"/>
        
        <!-- Return updated table and new count -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$UpdatedTable" exact="$validTable"/>
        <set_value name="$result.$NewCount" exact="$newCount"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Clear Pending Trade Data -->
    <!-- ✅ EXTRACTED: Cleanup function for pending trade data to avoid code duplication -->
    <library name="GT_ClearPendingTradeData" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to clear pending trade data for"/>
      </params>
      <actions>
        <!-- Clear pending trade list -->
        <do_if value="global.$GT_PendingTrades? and global.$GT_PendingTrades.{$ship}?">
          <remove_value name="global.$GT_PendingTrades.{$ship}"/>
        </do_if>
        
        <!-- Clear search method tracking -->
        <do_if value="global.$GT_PendingTradesSearchMethod? and global.$GT_PendingTradesSearchMethod.{$ship}?">
          <remove_value name="global.$GT_PendingTradesSearchMethod.{$ship}"/>
        </do_if>
      </actions>
    </library>
    
    <!-- ========================================= -->
    <!-- CACHE UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Calculate Total Cache Count -->
    <library name="GT_CalculateTotalCacheCount" purpose="run_actions">
      <params>
      </params>
      <actions>
        <!-- ✅ PERFORMANCE OPTIMIZATION v5: Calculate total cache count from all home sectors -->
        <!-- global.$GT_TradeCache is now a table indexed by home sector -->
        <!-- Returns total count of all trades across all home sector caches -->
        <set_value name="$totalCount" exact="0"/>
        <do_if value="global.$GT_TradeCache?">
          <do_all exact="global.$GT_TradeCache.keys.count" counter="$sectorIdx">
            <set_value name="$sectorCache" exact="global.$GT_TradeCache.{global.$GT_TradeCache.keys.{$sectorIdx}}"/>
            <do_if value="$sectorCache? and $sectorCache.count?">
              <set_value name="$totalCount" exact="$totalCount + $sectorCache.count"/>
            </do_if>
          </do_all>
        </do_if>
        <return value="$totalCount"/>
      </actions>
    </library>
    
    <!-- Get Home Sector Cache -->
    <library name="GT_GetHomeSectorCache" purpose="run_actions">
      <params>
        <param name="homeSector" comment="Home sector to get cache for"/>
      </params>
      <actions>
        <!-- Returns the cache list for a specific home sector, or null if not found -->
        <!-- ✅ PERFORMANCE OPTIMIZATION v5: Per-home-sector cache -->
        <set_value name="$cache" exact="null"/>
        <do_if value="$homeSector? and $homeSector.exists and global.$GT_TradeCache? and global.$GT_TradeCache.{$homeSector}?">
          <set_value name="$cache" exact="global.$GT_TradeCache.{$homeSector}"/>
        </do_if>
        <return value="$cache"/>
      </actions>
    </library>
    
    <!-- Calculate Fallback Distance -->
    <library name="GT_CalculateFallbackDistance" purpose="run_actions">
      <params>
        <param name="maxDistance" comment="Maximum distance (pilot's maxJumps)"/>
      </params>
      <actions>
        <!-- Calculates fallback search distance: max(maxJumps / 3, 2) -->
        <!-- Minimum: 2 jumps, Maximum: pilot's maxDistance / 3 -->
        <!-- This compensates for lower profit thresholds in fallback search -->
        <set_value name="$calculatedDistance" exact="($maxDistance / 3)"/>  <!-- Calculate as maxJumps / 3 -->
        <!-- Use maximum of (calculated distance, 2) to ensure minimum of 2 jumps -->
        <set_value name="$fallbackDistance" exact="[$calculatedDistance, 2].max"/>
        <return value="$fallbackDistance"/>
      </actions>
    </library>
    
    <!-- Check Batch Status -->
    <library name="GT_CheckBatchStatus" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to check batch status for"/>
      </params>
      <actions>
        <!-- Checks if batch processing is in progress and returns status information -->
        <!-- Returns table with: $IsBatchActive, $BatchShip, $ShouldProceed, $IsForThisShip -->
        <set_value name="$waitingForBatch" exact="false"/>
        <set_value name="$batchShip" exact="null"/>
        <do_if value="global.$GT_SearchResult.$WaitingForBatch? and global.$GT_SearchResult.$WaitingForBatch">
          <set_value name="$waitingForBatch" exact="true"/>
          <do_if value="global.$GT_SearchResult.$Ship?">
            <set_value name="$batchShip" exact="global.$GT_SearchResult.$Ship"/>
          </do_if>
        </do_if>
        
        <set_value name="$isForThisShip" exact="false"/>
        <do_if value="$waitingForBatch and $batchShip? and $batchShip == $ship">
          <set_value name="$isForThisShip" exact="true"/>
        </do_if>
        
        <set_value name="$shouldProceed" exact="true"/>
        <do_if value="$waitingForBatch and $isForThisShip">
          <set_value name="$shouldProceed" exact="false"/>
        </do_if>
        
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IsBatchActive" exact="$waitingForBatch"/>
        <set_value name="$result.$BatchShip" exact="$batchShip"/>
        <set_value name="$result.$ShouldProceed" exact="$shouldProceed"/>
        <set_value name="$result.$IsForThisShip" exact="$isForThisShip"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Update Rejection Stats -->
    <library name="GT_UpdateRejectionStats" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to update stats for"/>
        <param name="stats" comment="Rejection statistics table"/>
      </params>
      <actions>
        <!-- Updates LastRejectionStats in global.$GT_SearchResult for a ship -->
        <!-- Preserves existing entries for other ships, updates/adds entry for this ship -->
        <!-- ✅ SIMPLIFIED: Initialization guarantees global.$GT_SearchResult exists -->
        <set_value name="$existingLastRejectionStats" exact="null"/>
        <do_if value="global.$GT_SearchResult.$LastRejectionStats?">
          <set_value name="$existingLastRejectionStats" exact="global.$GT_SearchResult.$LastRejectionStats"/>
        </do_if>
        
        <!-- Build new $LastRejectionStats: preserve existing entries, update/add per-ship entry -->
        <set_value name="$newLastRejectionStats" exact="table[]"/>
        <!-- Copy existing entries if valid -->
        <do_if value="$existingLastRejectionStats?">
          <set_value name="$existingStatsKeys" exact="@$existingLastRejectionStats.keys"/>
          <do_if value="$existingStatsKeys?">
            <set_value name="$existingStatsKeysCount" exact="@$existingStatsKeys.count"/>
            <do_if value="$existingStatsKeysCount? and $existingStatsKeysCount gt 0">
              <do_all exact="$existingStatsKeysCount" counter="$k">
                <set_value name="$key" exact="$existingStatsKeys.{$k}"/>
                <do_if value="$key != $ship">
                  <set_value name="$newLastRejectionStats.{$key}" exact="@$existingLastRejectionStats.{$key}"/>
                </do_if>
              </do_all>
            </do_if>
          </do_if>
        </do_if>
        <!-- Add/update per-ship entry -->
        <set_value name="$newLastRejectionStats.{$ship}" exact="$stats"/>
        
        <!-- Build new $searchResultTable: preserve existing properties, set new $LastRejectionStats -->
        <set_value name="$newSearchResultTable" exact="table[$LastRejectionStats = $newLastRejectionStats]"/>
        <!-- Copy other existing properties -->
        <set_value name="$existingSearchResult" exact="global.$GT_SearchResult"/>
        <do_if value="$existingSearchResult?">
          <set_value name="$existingKeys" exact="@$existingSearchResult.keys"/>
          <do_if value="$existingKeys?">
            <set_value name="$existingKeysCount" exact="@$existingKeys.count"/>
            <do_if value="$existingKeysCount? and $existingKeysCount gt 0">
              <do_all exact="$existingKeysCount" counter="$tk">
                <set_value name="$tableKey" exact="$existingKeys.{$tk}"/>
                <do_if value="$tableKey != 'LastRejectionStats'">
                  <set_value name="$newSearchResultTable.{$tableKey}" exact="@$existingSearchResult.{$tableKey}"/>
                </do_if>
              </do_all>
            </do_if>
          </do_if>
        </do_if>
        <!-- Set atomically to global -->
        <set_value name="global.$GT_SearchResult" exact="$newSearchResultTable"/>
      </actions>
    </library>
    
    <!-- Get Price Range -->
    <library name="GT_GetPriceRange" purpose="run_actions">
      <params>
        <param name="shipIsIsolated" default="false" comment="Whether ship is isolated"/>
      </params>
      <actions>
        <!-- Returns price range from config: $sellPriceMax, $buyPriceMin -->
        <!-- For isolated ships, uses isolated-specific price ranges -->
        <set_value name="$sellPriceMax" exact="0.5"/>  <!-- Default fallback -->
        <set_value name="$buyPriceMin" exact="-0.5"/>  <!-- Default fallback -->
        <do_if value="global.$GT_Config? and global.$GT_Config.$Trading?">
          <do_if value="$shipIsIsolated">
            <!-- Isolated ships: Use isolated-specific price ranges -->
            <do_if value="global.$GT_Config.$Trading.$IsolatedSellPriceMax?">
              <set_value name="$sellPriceMax" exact="@global.$GT_Config.$Trading.$IsolatedSellPriceMax"/>
            </do_if>
            <do_if value="global.$GT_Config.$Trading.$IsolatedBuyPriceMin?">
              <set_value name="$buyPriceMin" exact="@global.$GT_Config.$Trading.$IsolatedBuyPriceMin"/>
            </do_if>
          </do_if>
          <do_else>
            <!-- Normal ships: Use standard price ranges -->
            <do_if value="global.$GT_Config.$Trading.$SellPriceMax?">
              <set_value name="$sellPriceMax" exact="@global.$GT_Config.$Trading.$SellPriceMax"/>
            </do_if>
            <do_if value="global.$GT_Config.$Trading.$BuyPriceMin?">
              <set_value name="$buyPriceMin" exact="@global.$GT_Config.$Trading.$BuyPriceMin"/>
            </do_if>
          </do_else>
        </do_if>
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$SellPriceMax" exact="$sellPriceMax"/>
        <set_value name="$result.$BuyPriceMin" exact="$buyPriceMin"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Sort Trades By Distance -->
    <library name="GT_SortTradesByDistance" purpose="run_actions">
      <params>
        <param name="tradesWithDistance" comment="List of trades with Distance field"/>
      </params>
      <actions>
        <!-- Sorts trades by distance (shortest first) using selection sort -->
        <!-- Input: List of tables with $Trade and $Distance fields -->
        <!-- Output: Sorted list (shortest distance first) -->
        <!-- Uses same pattern as original: check if already sorted to avoid duplicates -->
        <set_value name="$sortedTrades" exact="[]"/>
        <do_all exact="$tradesWithDistance.count" counter="$sortIdx">
          <set_value name="$minDistance" exact="999999999"/>
          <set_value name="$minIdx" exact="-1"/>
          <do_all exact="$tradesWithDistance.count" counter="$i">
            <set_value name="$alreadySorted" exact="false"/>
            <do_all exact="$sortedTrades.count" counter="$j">
              <do_if value="$sortedTrades.{$j}.$Trade == $tradesWithDistance.{$i}.$Trade">
                <set_value name="$alreadySorted" exact="true"/>
                <break/>
              </do_if>
            </do_all>
            <do_if value="not $alreadySorted">
              <set_value name="$tradeDistance" exact="@$tradesWithDistance.{$i}.$Distance"/>
              <do_if value="$tradeDistance? and $tradeDistance lt $minDistance">
                <set_value name="$minDistance" exact="$tradeDistance"/>
                <set_value name="$minIdx" exact="$i"/>
              </do_if>
            </do_if>
          </do_all>
          <do_if value="$minIdx ge 0">
            <append_to_list name="$sortedTrades" exact="$tradesWithDistance.{$minIdx}"/>
          </do_if>
        </do_all>
        <return value="$sortedTrades"/>
      </actions>
    </library>
    
    <!-- Calculate Fallback Trade Distances -->
    <library name="GT_CalculateFallbackTradeDistances" purpose="run_actions">
      <params>
        <param name="wareTrades" comment="List of trades for a specific ware"/>
        <param name="ship" comment="Ship executing the trade"/>
        <param name="homeSector" comment="Home sector for distance calculations"/>
        <param name="currentSector" comment="Current sector (ship's current position)"/>
        <param name="maxDistance" comment="Maximum distance from home sector"/>
        <param name="originalMaxDistance" comment="Original max distance (for fallback search)"/>
        <param name="isFallbackSearch" default="false" comment="Whether this is a fallback search"/>
      </params>
      <actions>
        <!-- Calculates distances for fallback search trades -->
        <!-- Filters by home sector distance, calculates current distance for sorting -->
        <!-- Returns: $tradesWithDistance list, $rejectionStats -->
        <set_value name="$tradesWithDistance" exact="[]"/>
        <set_value name="$rejectedByUnreachable" exact="0"/>
        <set_value name="$rejectedByHomeDistance" exact="0"/>
        <set_value name="$evaluatedCount" exact="0"/>
        
        <!-- Get filterMaxDistance (home sector distance limit) -->
        <set_value name="$filterMaxDistance" exact="$maxDistance"/>  <!-- Default: use maxDistance -->
        <do_if value="$isFallbackSearch and $originalMaxDistance?">
          <set_value name="$filterMaxDistance" exact="$originalMaxDistance"/>  <!-- Fallback: use original pilot maxDistance -->
        </do_if>
        
        <do_all exact="$wareTrades.count" counter="$i">
          <set_value name="$trade" exact="$wareTrades.{$i}"/>
          <set_value name="$buySector" exact="@$trade.$BuyStation.sector"/>
          <set_value name="$sellSector" exact="@$trade.$SellStation.sector"/>
          <set_value name="$buyStation" exact="@$trade.$BuyStation"/>
          <set_value name="$sellStation" exact="@$trade.$SellStation"/>
          <set_value name="$ware" exact="@$trade.$BuyOffer.ware"/>
          
          <!-- Calculate distance from HOME SECTOR FIRST (primary filter) -->
          <set_value name="$buyDistance" exact="-1"/>
          <set_value name="$sellDistance" exact="-1"/>
          
          <do_if value="$buySector == $homeSector">
            <set_value name="$buyDistance" exact="0"/>
          </do_if>
          <do_else>
            <set_value name="$buyDistance" exact="$homeSector.gatedistance.{$buySector}"/>
          </do_else>
          
          <do_if value="$sellSector == $homeSector">
            <set_value name="$sellDistance" exact="0"/>
          </do_if>
          <do_else>
            <set_value name="$sellDistance" exact="$homeSector.gatedistance.{$sellSector}"/>
          </do_else>
          
          <!-- Use max distance (farthest station from home) for filtering -->
          <set_value name="$maxStationDistance" exact="[$buyDistance, $sellDistance].max"/>
          
          <!-- Filter by home distance FIRST (primary filter) -->
          <do_if value="$buyDistance lt 0 or $sellDistance lt 0">
            <!-- Unreachable from home sector - skip -->
            <set_value name="$rejectedByUnreachable" exact="$rejectedByUnreachable + 1"/>
            <continue/>
          </do_if>
          <do_if value="$maxStationDistance gt $filterMaxDistance">
            <!-- Too far from home sector - skip -->
            <set_value name="$rejectedByHomeDistance" exact="$rejectedByHomeDistance + 1"/>
            <continue/>
          </do_if>
          
          <!-- Trade passed home distance filter - calculate distance from current for SCORING/SORTING -->
          <set_value name="$currentToBuyDistance" exact="-1"/>
          <set_value name="$currentToSellDistance" exact="-1"/>
          <set_value name="$maxDistanceFromCurrent" exact="-1"/>
          <do_if value="$isFallbackSearch">
            <do_if value="$buySector == $currentSector">
              <set_value name="$currentToBuyDistance" exact="0"/>
            </do_if>
            <do_else>
              <set_value name="$currentToBuyDistance" exact="$currentSector.gatedistance.{$buySector}"/>
            </do_else>
            <do_if value="$sellSector == $currentSector">
              <set_value name="$currentToSellDistance" exact="0"/>
            </do_if>
            <do_else>
              <set_value name="$currentToSellDistance" exact="$currentSector.gatedistance.{$sellSector}"/>
            </do_else>
            <set_value name="$maxDistanceFromCurrent" exact="[$currentToBuyDistance, $currentToSellDistance].max"/>
          </do_if>
          
          <!-- Count trade as evaluated (passed home distance filter) -->
          <set_value name="$evaluatedCount" exact="$evaluatedCount + 1"/>
          
          <!-- For fallback search, sort by distance from current position; otherwise sort by distance from home -->
          <set_value name="$sortDistance" exact="$maxStationDistance"/>  <!-- Default: sort by home distance -->
          <do_if value="$isFallbackSearch">
            <set_value name="$sortDistance" exact="$maxDistanceFromCurrent"/>  <!-- Fallback: sort by current position distance -->
          </do_if>
          <append_to_list name="$tradesWithDistance" exact="table[
            $Trade = $trade,
            $Distance = $sortDistance,
            $HomeDistance = $maxStationDistance
          ]"/>
        </do_all>
        
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$TradesWithDistance" exact="$tradesWithDistance"/>
        <set_value name="$result.$RejectedByUnreachable" exact="$rejectedByUnreachable"/>
        <set_value name="$result.$RejectedByHomeDistance" exact="$rejectedByHomeDistance"/>
        <set_value name="$result.$EvaluatedCount" exact="$evaluatedCount"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Select Best Trades With Diversity -->
    <library name="GT_SelectBestTradesWithDiversity" purpose="run_actions">
      <params>
        <param name="sortedTrades" comment="List of trades sorted by distance"/>
        <param name="maxDistance" comment="Maximum distance limit"/>
        <param name="filterMaxDistance" comment="Filter max distance (for fallback search)"/>
        <param name="isFallbackSearch" default="false" comment="Whether this is a fallback search"/>
        <param name="ware" comment="Ware being traded (for logging)"/>
        <param name="ship" comment="Ship executing the trade"/>
      </params>
      <actions>
        <!-- Selects top 5 trades with station pair diversity -->
        <!-- Returns: $topTrades list (up to 5 trades), $skippedDueToDistance -->
        <set_value name="$topTrades" exact="[]"/>
        <set_value name="$skippedDueToDistance" exact="0"/>
        <set_value name="$distanceLimit" exact="$maxDistance"/>  <!-- Default: use maxDistance (home sector) -->
        <do_if value="$isFallbackSearch">
          <set_value name="$distanceLimit" exact="$filterMaxDistance"/>  <!-- Fallback: use home distance limit -->
        </do_if>
        
        <do_all exact="$sortedTrades.count" counter="$i">
          <!-- Early exit: If this trade exceeds distance limit, all subsequent trades are also too far -->
          <do_if value="$sortedTrades.{$i}.$HomeDistance gt $distanceLimit">
            <set_value name="$skippedDueToDistance" exact="$sortedTrades.count - $i"/>
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <set_value name="$distanceType" exact="'home sector'"/>  <!-- Always home sector for distance limit check -->
              <debug_text text="'[GT-Resume] (' + $ship.idcode + ') ⚡ EARLY EXIT for ware ' + @$ware.name + ': Reached distance limit (' + $distanceLimit + ' jumps from ' + $distanceType + ') at trade ' + $i + '/' + $sortedTrades.count + ' (skipped ' + $skippedDueToDistance + ' trades)'" chance="100"/>
            </do_if>
            <break/>
          </do_if>
          
          <!-- Trade is within distance - select top 5 by Score with STATION PAIR DIVERSITY -->
          <set_value name="$trade" exact="$sortedTrades.{$i}.$Trade"/>
          <set_value name="$buyStation" exact="$trade.$BuyStation"/>
          <set_value name="$sellStation" exact="$trade.$SellStation"/>
          
          <!-- Check if this station pair already exists in topTrades -->
          <set_value name="$stationPairExists" exact="false"/>
          <do_all exact="$topTrades.count" counter="$j">
            <set_value name="$existingBuyStation" exact="$topTrades.{$j}.$BuyStation"/>
            <set_value name="$existingSellStation" exact="$topTrades.{$j}.$SellStation"/>
            <do_if value="$existingBuyStation == $buyStation and $existingSellStation == $sellStation">
              <set_value name="$stationPairExists" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          
          <!-- Skip if station pair already exists (ensure diversity) -->
          <do_if value="not $stationPairExists">
            <set_value name="$shouldAdd" exact="false"/>
            <do_if value="$topTrades.count lt 5">
              <!-- Still building initial top 5 - add unique station pair -->
              <set_value name="$shouldAdd" exact="true"/>
            </do_if>
            <do_else>
              <!-- Top 5 full - check if this trade's Score is better than worst -->
              <set_value name="$worstScore" exact="999999999"/>
              <set_value name="$worstIdx" exact="-1"/>
              <do_all exact="5" counter="$j">
                <do_if value="$topTrades.{$j}.$Score lt $worstScore">
                  <set_value name="$worstScore" exact="$topTrades.{$j}.$Score"/>
                  <set_value name="$worstIdx" exact="$j"/>
                </do_if>
              </do_all>
              <do_if value="$trade.$Score gt $worstScore">
                <!-- Replace worst with this trade (unique station pair) -->
                <set_value name="$shouldAdd" exact="true"/>
              </do_if>
            </do_else>
            <do_if value="$shouldAdd">
              <do_if value="$topTrades.count lt 5">
                <append_to_list name="$topTrades" exact="$trade"/>
              </do_if>
              <do_else>
                <!-- Replace worst trade in top5 -->
                <set_value name="$worstScore" exact="999999999"/>
                <set_value name="$worstIdx" exact="-1"/>
                <do_all exact="5" counter="$j">
                  <do_if value="$topTrades.{$j}.$Score lt $worstScore">
                    <set_value name="$worstScore" exact="$topTrades.{$j}.$Score"/>
                    <set_value name="$worstIdx" exact="$j"/>
                  </do_if>
                </do_all>
                <do_if value="$worstIdx ge 0">
                  <set_value name="$topTrades.{$worstIdx}" exact="$trade"/>
                </do_if>
              </do_else>
            </do_if>
          </do_if>
        </do_all>
        
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$TopTrades" exact="$topTrades"/>
        <set_value name="$result.$SkippedDueToDistance" exact="$skippedDueToDistance"/>
        <return value="$result"/>
      </actions>
    </library>
    
  </cues>
</mdscript>
