<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Trade_Utilities" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================= -->
    <!-- TRADE UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Is Intra-Sector Trade -->
    <library name="GT_IsIntraSectorTrade" purpose="run_actions">
      <params>
        <param name="buySector" comment="Buy station sector"/>
        <param name="sellSector" comment="Sell station sector"/>
        <param name="currentSector" comment="Ship's current sector"/>
      </params>
      <actions>
        <do_if value="$buySector? and $sellSector? and $currentSector?">
          <do_if value="$buySector == $currentSector and $sellSector == $currentSector">
            <return value="true"/>
          </do_if>
        </do_if>
        <return value="false"/>
      </actions>
    </library>
    
    <!-- Calculate Trade Efficiency -->
    <library name="GT_CalculateTradeEfficiency" purpose="run_actions">
      <params>
        <param name="profit" comment="Trade profit"/>
        <param name="distance" comment="Trade distance (jumps)"/>
        <param name="distancePenaltyMultiplier" default="1.0" comment="Distance penalty multiplier (0.0-2.0)"/>
        <param name="factionPriority" default="2" comment="Faction priority (0=Player, 1=Foreign, 2=Equal)"/>
        <param name="buyStationOwner" default="null" comment="Buy station owner faction"/>
        <param name="sellStationOwner" default="null" comment="Sell station owner faction"/>
      </params>
      <actions>
        <!-- Base efficiency calculation -->
        <set_value name="$adjustedDistance" exact="$distance * $distancePenaltyMultiplier"/>
        <set_value name="$efficiency" exact="if $adjustedDistance gt 0 then ($profit / $adjustedDistance) else $profit"/>
        
        <!-- Apply faction priority boost -->
        <do_if value="$factionPriority == 0 and ($buyStationOwner == faction.player or $sellStationOwner == faction.player)">
          <set_value name="$boost" exact="$efficiency / 5"/>
          <set_value name="$efficiency" exact="$efficiency + $boost"/>
        </do_if>
        <do_elseif value="$factionPriority == 1 and $buyStationOwner != faction.player and $sellStationOwner != faction.player">
          <set_value name="$boost" exact="$efficiency / 5"/>
          <set_value name="$efficiency" exact="$efficiency + $boost"/>
        </do_elseif>
        
        <return value="$efficiency"/>
      </actions>
    </library>
    
    <!-- Get Distance Penalty Multiplier -->
    <library name="GT_GetDistancePenaltyMultiplier" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to get distance penalty for"/>
        <param name="defaultMultiplier" default="1.0" comment="Default multiplier (for 50% distance penalty)"/>
      </params>
      <actions>
        <set_value name="$distancePenalty" exact="@global.$GT_AIParameters.{$ship}.$DistancePenalty"/>
        <do_if value="$distancePenalty?">
          <!-- Convert 0-100% to 0.0-2.0: 0%=0.0, 50%=1.0, 100%=2.0 -->
          <return value="$distancePenalty / 50.0"/>
        </do_if>
        <return value="$defaultMultiplier"/>
      </actions>
    </library>
    
    <!-- Get Faction Priority Text -->
    <library name="GT_GetFactionPriorityText" purpose="run_actions">
      <params>
        <param name="factionPriority" comment="Faction priority value (0, 1, or 2)"/>
      </params>
      <actions>
        <return value="if $factionPriority == 0 then 'Player Only' else if $factionPriority == 1 then 'Foreign First' else 'Equal Priority'"/>
      </actions>
    </library>
    
  </cues>
</mdscript>
