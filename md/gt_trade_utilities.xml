<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Trade_Utilities" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================= -->
    <!-- TRADE UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Is Intra-Sector Trade -->
    <library name="GT_IsIntraSectorTrade" purpose="run_actions">
      <params>
        <param name="buySector" comment="Buy station sector"/>
        <param name="sellSector" comment="Sell station sector"/>
        <param name="currentSector" comment="Ship's current sector"/>
      </params>
      <actions>
        <do_if value="$buySector? and $sellSector? and $currentSector?">
          <do_if value="$buySector == $currentSector and $sellSector == $currentSector">
            <return value="true"/>
          </do_if>
        </do_if>
        <return value="false"/>
      </actions>
    </library>
    
    <!-- Calculate Trade Efficiency -->
    <library name="GT_CalculateTradeEfficiency" purpose="run_actions">
      <params>
        <param name="profit" comment="Trade profit"/>
        <param name="distance" comment="Trade distance (jumps)"/>
        <param name="distancePenaltyMultiplier" default="1.0" comment="Distance penalty multiplier (0.0-2.0)"/>
        <param name="factionPriority" default="2" comment="Faction priority (0=Player, 1=Foreign, 2=Equal)"/>
        <param name="buyStationOwner" default="null" comment="Buy station owner faction"/>
        <param name="sellStationOwner" default="null" comment="Sell station owner faction"/>
        <param name="homeSector" default="null" comment="Home sector for path efficiency calculation"/>
        <param name="shipSector" default="null" comment="Ship's current sector"/>
        <param name="buySector" default="null" comment="Buy station sector"/>
        <param name="sellSector" default="null" comment="Sell station sector"/>
        <param name="shipToBuyDistance" default="-1" comment="Distance from ship to buy station (for path efficiency)"/>
      </params>
      <actions>
        <!-- Base efficiency calculation with NON-LINEAR distance penalty -->
        <!-- Formula: adjustedDistance = distance * multiplier * (1 + (distance / 10)^2) -->
        <!-- This creates quadratic penalty: longer distances get exponentially more penalized -->
        <!-- Examples with multiplier=2.0:
             - Distance 1:  1 * 2 * (1 + 0.01) = 2.02   (minimal penalty)
             - Distance 5:  5 * 2 * (1 + 0.25) = 12.5   (25% extra)
             - Distance 10: 10 * 2 * (1 + 1)   = 40     (100% extra = 2x)
             - Distance 20: 20 * 2 * (1 + 4)   = 200    (400% extra = 5x)
        -->
        <set_value name="$distanceBase" exact="10.0"/>
        <set_value name="$distanceRatio" exact="$distance / $distanceBase"/>
        <set_value name="$nonLinearFactor" exact="1.0 + ($distanceRatio * $distanceRatio)"/>
        <set_value name="$adjustedDistance" exact="$distance * $distancePenaltyMultiplier * $nonLinearFactor"/>
        <!-- ✅ FIX: Convert money to number before division to avoid "Loss of data while converting floating point" error -->
        <!-- Convert profit (money in cents) to numeric value using f suffix to force float conversion -->
        <!-- Pattern from order.trade.perform.xml:243: (money / 1Cr)f forces float conversion -->
        <set_value name="$efficiency" exact="0.0"/>
        <do_if value="$adjustedDistance gt 0">
          <!-- Convert profit from money (cents) to number by dividing by 1ct, then scale by 100 -->
          <!-- Use f suffix to force float conversion (pattern from order.trade.perform.xml:243) -->
          <set_value name="$profitNum" exact="(($profit / 1ct) * 100)f"/>
          <!-- Scale adjustedDistance by 10000 for precision -->
          <set_value name="$scaledDistance" exact="$adjustedDistance * 10000.0"/>
          <!-- Division: number / number = number (efficiency scaled by 10000) -->
          <!-- Note: Efficiency is now scaled by 10000, but all comparisons/scoring work correctly with scaled values -->
          <set_value name="$efficiency" exact="$profitNum / $scaledDistance"/>
        </do_if>
        <do_else>
          <!-- If distance is 0, efficiency equals profit (converted to number) -->
          <set_value name="$efficiency" exact="($profit / 1ct)f"/>
        </do_else>
        
        <!-- Apply faction priority boost -->
        <do_if value="$factionPriority == 0 and ($buyStationOwner == faction.player or $sellStationOwner == faction.player)">
          <set_value name="$boost" exact="$efficiency / 5"/>
          <set_value name="$efficiency" exact="$efficiency + $boost"/>
        </do_if>
        <do_elseif value="$factionPriority == 1 and $buyStationOwner != faction.player and $sellStationOwner != faction.player">
          <set_value name="$boost" exact="$efficiency / 5"/>
          <set_value name="$efficiency" exact="$efficiency + $boost"/>
        </do_elseif>
        
        <!-- ✅ NEW: Apply "same path" bonus for efficient routing -->
        <!-- Favors trades where stations are "in order" relative to home and ship position -->
        <!-- Example: Home=E, Ship=B, Buy=C, Sell=E → Efficient (moves toward home) -->
        <!-- Example: Home=E, Ship=B, Buy=E, Sell=C → Less efficient (backtracks) -->
        <set_value name="$pathBonus" exact="1.0"/>
        <do_if value="$homeSector? and $shipSector? and $buySector? and $sellSector? and $shipToBuyDistance ge 0">
          <!-- Calculate distances from home to stations -->
          <set_value name="$homeToBuy" exact="$homeSector.gatedistance.{$buySector}"/>
          <set_value name="$homeToSell" exact="$homeSector.gatedistance.{$sellSector}"/>
          <set_value name="$shipToSell" exact="$shipSector.gatedistance.{$sellSector}"/>
          
          <!-- Only apply bonus if all distances are valid (non-negative, paths exist) -->
          <do_if value="$homeToBuy ge 0 and $homeToSell ge 0 and $shipToSell ge 0">
            <!-- Case 1: Buy station is further from home than sell station -->
            <!-- Efficient route: Ship → Buy (further) → Sell (closer) → Home -->
            <!-- This is efficient if ship is closer to buy than sell (ship between buy and sell, or beyond buy) -->
            <do_if value="$homeToBuy gt $homeToSell">
              <!-- Efficient if ship is closer to buy station than sell station -->
              <!-- This means ship can move forward (toward sell/home) without backtracking -->
              <do_if value="$shipToBuyDistance le $shipToSell">
                <!-- Same path bonus: 10% efficiency boost -->
                <set_value name="$pathBonus" exact="1.1"/>
              </do_if>
            </do_if>
            <!-- Case 2: Sell station is further from home than buy station -->
            <!-- Efficient route: Ship → Sell (further) → Buy (closer) → Home -->
            <!-- This is efficient if ship is closer to sell than buy -->
            <do_elseif value="$homeToSell gt $homeToBuy">
              <!-- Efficient if ship is closer to sell station than buy station -->
              <do_if value="$shipToSell le $shipToBuyDistance">
                <!-- Same path bonus: 10% efficiency boost -->
                <set_value name="$pathBonus" exact="1.1"/>
              </do_if>
            </do_elseif>
            <!-- Case 3: Both stations same distance from home (same sector or equidistant) -->
            <!-- Already efficient - smaller bonus -->
            <do_elseif value="$homeToBuy == $homeToSell">
              <set_value name="$pathBonus" exact="1.05"/>
            </do_elseif>
          </do_if>
        </do_if>
        
        <!-- Apply path bonus to efficiency -->
        <set_value name="$efficiency" exact="$efficiency * $pathBonus"/>
        
        <return value="$efficiency"/>
      </actions>
    </library>
    
    <!-- Get Distance Penalty Multiplier -->
    <library name="GT_GetDistancePenaltyMultiplier" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to get distance penalty for"/>
        <param name="defaultMultiplier" default="1.0" comment="Default multiplier (for 50% distance penalty)"/>
      </params>
      <actions>
        <set_value name="$distancePenalty" exact="@global.$GT_AIParameters.{$ship}.$DistancePenalty"/>
        <do_if value="$distancePenalty?">
          <!-- Convert 0-100% to 0.0-2.0: 0%=0.0, 50%=1.0, 100%=2.0 -->
          <return value="$distancePenalty / 50.0"/>
        </do_if>
        <return value="$defaultMultiplier"/>
      </actions>
    </library>
    
    <!-- Get Faction Priority Text -->
    <library name="GT_GetFactionPriorityText" purpose="run_actions">
      <params>
        <param name="factionPriority" comment="Faction priority value (0, 1, or 2)"/>
      </params>
      <actions>
        <return value="if $factionPriority == 0 then 'Player Only' else if $factionPriority == 1 then 'Foreign First' else 'Equal Priority'"/>
      </actions>
    </library>
    
    <!-- Calculate ROI from Prices -->
    <library name="GT_CalculateROIFromPrices" purpose="run_actions">
      <params>
        <param name="buyPrice" comment="Price per unit to buy"/>
        <param name="sellPrice" comment="Price per unit to sell"/>
      </params>
      <actions>
        <!-- Calculate ROI as percentage: ((sellPrice - buyPrice) / buyPrice) * 100 -->
        <do_if value="$buyPrice gt 0">
          <return value="(($sellPrice - $buyPrice) * 100) / $buyPrice"/>
        </do_if>
        <return value="0"/>
      </actions>
    </library>
    
    <!-- Get Skill-Based Multiplier -->
    <library name="GT_GetSkillMultiplier" purpose="run_actions">
      <params>
        <param name="skillLevel" comment="Pilot skill level (1-15+)"/>
      </params>
      <actions>
        <!-- Returns multiplier: 0.5 at Lv1 → 2.0 at Lv15 -->
        <!-- Formula: 0.5 + ((skillLevel - 1) * (1.5 / 14)) -->
        <return value="0.5 + (($skillLevel - 1) * (1.5 / 14))"/>
      </actions>
    </library>
    
    <!-- Validate Trade -->
    <library name="GT_IsTradeValid" purpose="run_actions">
      <params>
        <param name="trade" comment="Trade object to validate"/>
        <param name="minScore" default="0" comment="Minimum score required (default: 0 = any positive score)"/>
      </params>
      <actions>
        <!-- ✅ CRITICAL: Validate trade has all required properties -->
        <set_value name="$testBuyOffer" exact="@$trade.$BuyOffer"/>
        <set_value name="$testSellOffer" exact="@$trade.$SellOffer"/>
        <set_value name="$testScore" exact="@$trade.$Score"/>
        <do_if value="$testBuyOffer? and $testSellOffer? and $testScore? and $testScore gt $minScore">
          <set_value name="$testWare" exact="@$testBuyOffer.ware"/>
          <do_if value="$testWare?">
            <return value="true"/>
          </do_if>
        </do_if>
        <return value="false"/>
      </actions>
    </library>
    
    <!-- Calculate Max Tradeable Amount -->
    <library name="GT_CalculateMaxTradeableAmount" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship for cargo capacity calculation"/>
        <param name="ware" comment="Ware to calculate capacity for"/>
        <param name="buyOfferAmount" comment="Buy offer amount"/>
        <param name="sellOfferAmount" comment="Sell offer amount"/>
        <param name="availableMoney" default="999999Cr" comment="Available money"/>
        <param name="buyPrice" default="0" comment="Buy price per unit"/>
      </params>
      <actions>
        <!-- Calculate max cargo capacity for this ware -->
        <set_value name="$maxCargoCapacity" exact="($ship.cargo.free.all / $ware.volume)i"/>
        <!-- Calculate max affordable based on available money -->
        <set_value name="$maxAffordable" exact="99999"/>
        <do_if value="$buyPrice gt 0">
          <set_value name="$maxAffordable" exact="($availableMoney / $buyPrice)i"/>
        </do_if>
        <!-- Return minimum of offer amounts, cargo capacity, and money limit -->
        <return value="[$buyOfferAmount, $sellOfferAmount, $maxCargoCapacity, $maxAffordable].min"/>
      </actions>
    </library>
    
    <!-- Index Offers By Ware -->
    <library name="GT_IndexOffersByWare" purpose="run_actions">
      <params>
        <param name="offersList" comment="List of trade offers to index"/>
      </params>
      <actions>
        <set_value name="$offersByWare" exact="table[]"/>
        <do_all exact="$offersList.count" counter="$i">
          <set_value name="$offer" exact="$offersList.{$i}"/>
          <do_if value="not $offersByWare.{$offer.ware}?">
            <set_value name="$offersByWare.{$offer.ware}" exact="[]"/>
          </do_if>
          <append_to_list name="$offersByWare.{$offer.ware}" exact="$offer"/>
        </do_all>
        <return value="$offersByWare"/>
      </actions>
    </library>
    
    <!-- Filter Offers By Distance -->
    <library name="GT_FilterOffersByDistance" purpose="run_actions">
      <params>
        <param name="offersList" comment="List of offers to filter"/>
        <param name="homeSector" comment="Home/base sector for distance calculation"/>
        <param name="maxDistance" comment="Maximum distance (jumps)"/>
      </params>
      <actions>
        <set_value name="$filteredOffers" exact="[]"/>
        <set_value name="$filteredCount" exact="0"/>
        <do_all exact="$offersList.count" counter="$i">
          <set_value name="$offer" exact="$offersList.{$i}"/>
          <set_value name="$targetSector" exact="$offer.owner.sector"/>
          
          <!-- Calculate range-only distance (using library function) -->
          <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculateRangeOnlyDistance" result="$distance">
            <param name="fromSector" value="$homeSector"/>
            <param name="toSector" value="$targetSector"/>
          </run_actions>
          
          <!-- Keep offer if within max distance and path exists (distance >= 0) -->
          <do_if value="$distance ge 0 and $distance le $maxDistance">
            <append_to_list name="$filteredOffers" exact="$offer"/>
          </do_if>
          <do_else>
            <set_value name="$filteredCount" exact="$filteredCount + 1"/>
          </do_else>
        </do_all>
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$FilteredOffers" exact="$filteredOffers"/>
        <set_value name="$result.$FilteredCount" exact="$filteredCount"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Sort and Limit Offers -->
    <library name="GT_SortAndLimitOffers" purpose="run_actions">
      <params>
        <param name="offersList" comment="List of offers to sort and limit"/>
        <param name="maxCount" comment="Maximum number of offers to return"/>
        <param name="sortAscending" default="true" comment="If true, sort ascending (take first N), if false sort descending (take last N)"/>
      </params>
      <actions>
        <set_value name="$offers" exact="$offersList"/>
        <!-- Sort by relativeprice -->
        <sort_trades name="$offers" tradelist="$offers" sorter="relativeprice"/>
        
        <set_value name="$limitedOffers" exact="[]"/>
        <do_if value="$sortAscending">
          <!-- Take first N offers (lowest price for buy offers) -->
          <set_value name="$limitCount" exact="[$offers.count, $maxCount].min"/>
          <do_all exact="$limitCount" counter="$idx">
            <append_to_list name="$limitedOffers" exact="$offers.{$idx}"/>
          </do_all>
        </do_if>
        <do_else>
          <!-- Take last N offers (highest price for sell offers) -->
          <do_if value="$offers.count gt $maxCount">
            <set_value name="$startIndex" exact="$offers.count - $maxCount + 1"/>
            <do_all exact="$maxCount" counter="$idx">
              <set_value name="$actualIndex" exact="$startIndex + $idx - 1"/>
              <append_to_list name="$limitedOffers" exact="$offers.{$actualIndex}"/>
            </do_all>
          </do_if>
          <do_else>
            <!-- Less than limit, take all -->
            <do_all exact="$offers.count" counter="$idx">
              <append_to_list name="$limitedOffers" exact="$offers.{$idx}"/>
            </do_all>
          </do_else>
        </do_else>
        <return value="$limitedOffers"/>
      </actions>
    </library>
    
    <!-- Sort Trades By Score (highest first) -->
    <library name="GT_SortTradesByScore" purpose="run_actions">
      <params>
        <param name="tradeList" comment="List of trades to sort"/>
      </params>
      <actions>
        <!-- ✅ OPTIMIZATION #5: Optimize sort for small lists (≤10 items: O(n) vs O(n²)) -->
        <do_if value="$tradeList? and $tradeList.count gt 1">
          <do_if value="$tradeList.count gt 10">
            <!-- Large list: Full selection sort (necessary for proper ordering) -->
            <set_value name="$sortedTradeList" exact="[]"/>
            <set_value name="$remainingTrades" exact="$tradeList"/>
            <do_all exact="$tradeList.count" counter="$sortIdx">
              <set_value name="$maxScore" exact="-999999999"/>
              <set_value name="$maxIdx" exact="-1"/>
              <do_all exact="$remainingTrades.count" counter="$i">
                <set_value name="$trade" exact="$remainingTrades.{$i}"/>
                <set_value name="$tradeScore" exact="$trade.$Score"/>
                <do_if value="$tradeScore gt $maxScore">
                  <set_value name="$maxScore" exact="$tradeScore"/>
                  <set_value name="$maxIdx" exact="$i"/>
                </do_if>
              </do_all>
              <do_if value="$maxIdx ge 0">
                <append_to_list name="$sortedTradeList" exact="$remainingTrades.{$maxIdx}"/>
                <remove_value name="$remainingTrades.{$maxIdx}"/>
              </do_if>
            </do_all>
            <set_value name="$tradeList" exact="$sortedTradeList"/>
          </do_if>
          <do_elseif value="$tradeList.count gt 1">
            <!-- Small list (2-10): Single pass bubble-like sort (O(n²) but n is small) -->
            <set_value name="$sortedTradeList" exact="$tradeList"/>
            <!-- Single pass: swap adjacent elements if wrong order (n-1 comparisons) -->
            <do_all exact="$tradeList.count - 1" counter="$pass">
              <set_value name="$swapped" exact="false"/>
              <do_all exact="$tradeList.count - 1 - $pass" counter="$i">
                <set_value name="$currentScore" exact="$sortedTradeList.{$i}.$Score"/>
                <set_value name="$nextScore" exact="$sortedTradeList.{$i + 1}.$Score"/>
                <do_if value="$currentScore lt $nextScore">
                  <!-- Swap -->
                  <set_value name="$temp" exact="$sortedTradeList.{$i}"/>
                  <set_value name="$sortedTradeList.{$i}" exact="$sortedTradeList.{$i + 1}"/>
                  <set_value name="$sortedTradeList.{$i + 1}" exact="$temp"/>
                  <set_value name="$swapped" exact="true"/>
                </do_if>
              </do_all>
              <!-- Early exit if no swaps (already sorted) -->
              <do_if value="not $swapped">
                <break/>
              </do_if>
            </do_all>
            <set_value name="$tradeList" exact="$sortedTradeList"/>
          </do_elseif>
          <!-- Single item or empty: no sort needed -->
        </do_if>
        <return value="$tradeList"/>
      </actions>
    </library>
    
    <!-- Filter Trade For Ship (ware basket, illegal, blacklist, path availability) -->
    <library name="GT_FilterTradeForShip" purpose="run_actions">
      <params>
        <param name="trade" comment="Trade to filter"/>
        <param name="ship" comment="Ship that would execute the trade"/>
        <param name="ware" comment="Ware being traded"/>
        <param name="wareBasket" comment="Allowed ware basket (empty = all wares allowed)"/>
        <param name="allowIllegal" default="false" comment="Whether to allow illegal wares"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group"/>
        <param name="currentSector" comment="Ship's current sector"/>
        <param name="buySector" comment="Buy station sector"/>
        <param name="sellSector" comment="Sell station sector"/>
        <param name="filterStats" default="null" comment="Optional filter statistics table to update"/>
        <param name="isIntraSectorTrade" default="false" comment="Whether this is an intra-sector trade"/>
      </params>
      <actions>
        <!-- Initialize result -->
        <set_value name="$isAllowed" exact="true"/>
        <set_value name="$filterReason" exact="''"/>
        
        <!-- Ware basket check -->
        <set_value name="$wareAllowed" exact="true"/>
        <do_if value="$wareBasket.count gt 0">
          <run_actions ref="md.GT_Utilities.GT_IsWareInBasket" result="$wareAllowed">
            <param name="ware" value="$ware"/>
            <param name="basket" value="$wareBasket"/>
          </run_actions>
          <do_if value="not $wareAllowed">
            <set_value name="$isAllowed" exact="false"/>
            <set_value name="$filterReason" exact="'ware_basket'"/>
            <do_if value="$filterStats?">
              <set_value name="$filterStats.$filteredByWareBasket" exact="$filterStats.$filteredByWareBasket + 1"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Illegal ware check -->
        <do_if value="$wareAllowed and not $allowIllegal and @$ware.illegal">
          <set_value name="$wareAllowed" exact="false"/>
          <set_value name="$isAllowed" exact="false"/>
          <set_value name="$filterReason" exact="'illegal'"/>
          <do_if value="$filterStats?">
            <set_value name="$filterStats.$filteredByIllegal" exact="$filterStats.$filteredByIllegal + 1"/>
          </do_if>
        </do_if>
        
        <!-- Blacklist check -->
        <set_value name="$isBlacklisted" exact="false"/>
        <do_if value="$wareAllowed">
          <!-- ✅ FIX: Block intra-sector trades in blacklisted sectors (force escape) -->
          <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$currentSectorIsBlacklisted">
            <param name="sector" value="$currentSector"/>
            <param name="ship" value="$ship"/>
            <param name="blacklistgroup" value="$blacklistgroup"/>
          </run_actions>
          <do_if value="$currentSectorIsBlacklisted">
            <do_if value="$buySector == $currentSector and $sellSector == $currentSector">
              <!-- Intra-sector trade in blacklisted sector - BLOCK to force escape -->
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_intra'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check buy station blacklist -->
          <do_if value="not $isBlacklisted">
            <set_value name="$buyStation" exact="@$trade.$BuyStation"/>
            <run_actions ref="md.GT_Blacklist_Utilities.GT_IsStationBlacklisted" result="$buyStationBlacklisted">
              <param name="station" value="$buyStation"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$buyStationBlacklisted">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_buy_station'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check sell station blacklist -->
          <do_if value="not $isBlacklisted">
            <set_value name="$sellStation" exact="@$trade.$SellStation"/>
            <run_actions ref="md.GT_Blacklist_Utilities.GT_IsStationBlacklisted" result="$sellStationBlacklisted">
              <param name="station" value="$sellStation"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$sellStationBlacklisted">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_sell_station'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check buy sector blacklist -->
          <do_if value="not $isBlacklisted">
            <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$buySectorBlacklisted">
              <param name="sector" value="$buySector"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$buySectorBlacklisted">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_buy_sector'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check sell sector blacklist -->
          <do_if value="not $isBlacklisted">
            <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$sellSectorBlacklisted">
              <param name="sector" value="$sellSector"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$sellSectorBlacklisted">
              <do_if value="$sellSector != $currentSector">
                <!-- Ship needs to travel TO a blacklisted sector - BLOCK -->
                <set_value name="$isBlacklisted" exact="true"/>
                <set_value name="$isAllowed" exact="false"/>
                <set_value name="$filterReason" exact="'blacklist_sell_sector'"/>
                <do_if value="$filterStats?">
                  <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
                </do_if>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Path availability check -->
          <do_if value="not $isBlacklisted">
            <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculateTradePathDistances" result="$pathResult">
              <param name="ship" value="$ship"/>
              <param name="currentSector" value="$currentSector"/>
              <param name="buySector" value="$buySector"/>
              <param name="sellSector" value="$sellSector"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            
            <!-- Debug logging (if enabled) -->
            <!-- ✅ FIX: Only log intra-sector trades for isolated ships (they're common for non-isolated ships) -->
            <!-- Always log unreachable paths as they indicate problems -->
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <set_value name="$shouldLogIntraSector" exact="false"/>
              <do_if value="$pathResult.$IsIntraSectorTrade">
                <!-- Check if ship is isolated - only log intra-sector trades for isolated ships -->
                <do_if value="$currentSector?">
                  <run_actions ref="md.GT_Blacklist_Utilities.GT_CheckConnectedSectorsBlacklisted" result="$isolationCheck">
                    <param name="sector" value="$currentSector"/>
                    <param name="ship" value="$ship"/>
                    <param name="returnDetails" value="false"/>
                  </run_actions>
                  <set_value name="$isolatedValue" exact="@$isolationCheck.$IsIsolated"/>
                  <set_value name="$shouldLogIntraSector" exact="if $isolatedValue? and ($isolatedValue == true or $isolatedValue == 1) then true else false"/>
                </do_if>
              </do_if>
              <do_if value="$shouldLogIntraSector or not $pathResult.$IsReachable">
                <set_value name="$buySectorName" exact="@$buySector.knownname"/>
                <set_value name="$sellSectorName" exact="@$sellSector.knownname"/>
                <set_value name="$currentSectorName" exact="@$currentSector.knownname"/>
                <set_value name="$wareName" exact="@$ware.name"/>
                <set_value name="$tradeType" exact="if $pathResult.$IsIntraSectorTrade then 'INTRA-SECTOR' else 'CROSS-SECTOR'"/>
                <debug_text text="'[GT-Resume] ' + $ship.idcode + ': ' + $tradeType + ' trade (' + $wareName + '):' +
                  '\n  Current sector: ' + $currentSectorName + ' (blacklisted: ' + $pathResult.$CurrentSectorIsBlacklisted + ')' +
                  '\n  Buy sector: ' + $buySectorName + ' (distance: ' + $pathResult.$BuyPathDistance + ', same as current: ' + ($buySector == $currentSector) + ')' +
                  '\n  Sell sector: ' + $sellSectorName + ' (distance: ' + $pathResult.$SellPathDistance + ', same as buy: ' + ($sellSector == $buySector) + ', same as current: ' + ($sellSector == $currentSector) + ')' +
                  (if not $pathResult.$IsReachable then ' [PATH BLOCKED]' else '')"
                  chance="100"/>
              </do_if>
            </do_if>
            
            <!-- Block if paths are unreachable -->
            <do_if value="not $pathResult.$IsReachable">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'path_blocked'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByPathBlocked" exact="$filterStats.$filteredByPathBlocked + 1"/>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Return result -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IsAllowed" exact="$isAllowed"/>
        <set_value name="$result.$FilterReason" exact="$filterReason"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Build Docking Cache -->
    <library name="GT_BuildDockingCache" purpose="run_actions">
      <params>
        <param name="sellOffers" comment="List of sell offers"/>
        <param name="buyOffers" comment="List of buy offers"/>
        <param name="ship" comment="Ship to check docking for"/>
      </params>
      <actions>
        <set_value name="$dockingCache" exact="table[]"/>
        <set_value name="$uniqueStations" exact="table[]"/>
        
        <!-- Collect all unique stations from sell offers -->
        <do_all exact="$sellOffers.count" counter="$i">
          <set_value name="$offer" exact="$sellOffers.{$i}"/>
          <set_value name="$station" exact="@$offer.owner"/>
          <!-- Validate station is valid before using as table key -->
          <set_value name="$stationValid" exact="false"/>
          <do_if value="$station? and not ($station == null)">
            <set_value name="$stationId" exact="@$station.idcode"/>
            <do_if value="$stationId?">
              <set_value name="$stationValid" exact="true"/>
            </do_if>
          </do_if>
          <do_if value="$stationValid and $station? and not ($station == null)">
            <do_if value="not $uniqueStations.{$station}?">
              <set_value name="$uniqueStations.{$station}" exact="true"/>
            </do_if>
          </do_if>
        </do_all>
        
        <!-- Collect all unique stations from buy offers -->
        <do_all exact="$buyOffers.count" counter="$i">
          <set_value name="$offer" exact="$buyOffers.{$i}"/>
          <set_value name="$station" exact="@$offer.owner"/>
          <!-- Validate station is valid before using as table key -->
          <set_value name="$stationValid" exact="false"/>
          <do_if value="$station? and not ($station == null)">
            <set_value name="$stationId" exact="@$station.idcode"/>
            <do_if value="$stationId?">
              <set_value name="$stationValid" exact="true"/>
            </do_if>
          </do_if>
          <do_if value="$stationValid and $station? and not ($station == null)">
            <do_if value="not $uniqueStations.{$station}?">
              <set_value name="$uniqueStations.{$station}" exact="true"/>
            </do_if>
          </do_if>
        </do_all>
        
        <!-- Pre-cache docking permissions for all unique stations -->
        <do_all exact="$uniqueStations.keys.count" counter="$stationIdx">
          <set_value name="$station" exact="$uniqueStations.keys.{$stationIdx}"/>
          <set_value name="$canDock" exact="@$station.dockingallowed.{$ship}"/>
          <set_value name="$dockingCache.{$station}" exact="$canDock"/>
        </do_all>
        
        <return value="$dockingCache"/>
      </actions>
    </library>
    
    <!-- Separate Offers By Sector -->
    <library name="GT_SeparateOffersBySector" purpose="run_actions">
      <params>
        <param name="sellOffers" comment="List of sell offers"/>
        <param name="buyOffers" comment="List of buy offers"/>
        <param name="currentSector" comment="Current sector to compare against"/>
      </params>
      <actions>
        <set_value name="$intraSectorSellOffers" exact="[]"/>
        <set_value name="$intraSectorBuyOffers" exact="[]"/>
        <set_value name="$crossSectorSellOffers" exact="[]"/>
        <set_value name="$crossSectorBuyOffers" exact="[]"/>
        
        <!-- ✅ FIX: Validate currentSector is set and not null -->
        <do_if value="not $currentSector?">
          <!-- If currentSector is null, all offers are cross-sector -->
          <set_value name="$crossSectorSellOffers" exact="$sellOffers"/>
          <set_value name="$crossSectorBuyOffers" exact="$buyOffers"/>
        </do_if>
        <do_else>
          <!-- Separate sell offers -->
          <do_all exact="$sellOffers.count" counter="$idx">
            <set_value name="$offer" exact="$sellOffers.{$idx}"/>
            <set_value name="$offerSector" exact="@$offer.owner.sector"/>
            <!-- ✅ FIX: Compare sectors directly - == should work for same component reference -->
            <do_if value="$offerSector? and $offerSector == $currentSector">
              <append_to_list name="$intraSectorSellOffers" exact="$offer"/>
            </do_if>
            <do_else>
              <append_to_list name="$crossSectorSellOffers" exact="$offer"/>
            </do_else>
          </do_all>
          
          <!-- Separate buy offers -->
          <do_all exact="$buyOffers.count" counter="$idx">
            <set_value name="$offer" exact="$buyOffers.{$idx}"/>
            <set_value name="$offerSector" exact="@$offer.owner.sector"/>
            <!-- ✅ FIX: Compare sectors directly - == should work for same component reference -->
            <do_if value="$offerSector? and $offerSector == $currentSector">
              <append_to_list name="$intraSectorBuyOffers" exact="$offer"/>
            </do_if>
            <do_else>
              <append_to_list name="$crossSectorBuyOffers" exact="$offer"/>
            </do_else>
          </do_all>
        </do_else>
        
        <!-- Return result table -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IntraSectorSell" exact="$intraSectorSellOffers"/>
        <set_value name="$result.$IntraSectorBuy" exact="$intraSectorBuyOffers"/>
        <set_value name="$result.$CrossSectorSell" exact="$crossSectorSellOffers"/>
        <set_value name="$result.$CrossSectorBuy" exact="$crossSectorBuyOffers"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Calculate Trade Thresholds -->
    <library name="GT_CalculateTradeThresholds" purpose="run_actions">
      <params>
        <param name="minROI" comment="Base minimum ROI"/>
        <param name="minAbsoluteProfit" comment="Base minimum profit"/>
        <param name="useAdvancedAnalytics" default="false" comment="Apply 95% multiplier"/>
        <param name="isIntraSector" default="false" comment="Is intra-sector trade"/>
        <param name="isIsolated" default="false" comment="Is ship isolated"/>
      </params>
      <actions>
        <set_value name="$roiThreshold" exact="$minROI"/>
        <set_value name="$profitThreshold" exact="$minAbsoluteProfit"/>
        
        <!-- Apply advanced analytics adjustment -->
        <do_if value="$useAdvancedAnalytics">
          <set_value name="$roiThreshold" exact="$roiThreshold * 0.95"/>
          <set_value name="$profitThreshold" exact="($profitThreshold * 0.95)i"/>
        </do_if>
        
        <!-- Apply intra-sector/isolation adjustments -->
        <do_if value="$isIntraSector">
          <do_if value="$isIsolated">
            <!-- Isolated intra-sector: 25% of threshold -->
            <set_value name="$roiThreshold" exact="$roiThreshold * 0.25"/>
            <set_value name="$profitThreshold" exact="($profitThreshold * 0.25)i"/>
          </do_if>
          <do_else>
            <!-- Normal intra-sector: 50% of threshold -->
            <set_value name="$roiThreshold" exact="$roiThreshold * 0.5"/>
            <set_value name="$profitThreshold" exact="($profitThreshold * 0.5)i"/>
          </do_else>
        </do_if>
        
        <!-- Return result table -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$ROIThreshold" exact="$roiThreshold"/>
        <set_value name="$result.$ProfitThreshold" exact="$profitThreshold"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Create Trade Object -->
    <library name="GT_CreateTradeObject" purpose="run_actions">
      <params>
        <param name="sellOffer" comment="Sell offer"/>
        <param name="buyOffer" comment="Buy offer"/>
        <param name="sellStation" comment="Sell station"/>
        <param name="buyStation" comment="Buy station"/>
        <param name="amount" comment="Trade amount"/>
        <param name="profit" comment="Trade profit"/>
        <param name="roi" comment="Trade ROI"/>
        <param name="efficiency" comment="Trade efficiency score"/>
        <param name="buyPrice" comment="Buy price"/>
        <param name="sellPrice" comment="Sell price"/>
        <param name="distance" default="0" comment="Route distance"/>
        <param name="risk" default="0" comment="Trade risk"/>
      </params>
      <actions>
        <set_value name="$trade" exact="table[
          $BuyOffer = $sellOffer,
          $SellOffer = $buyOffer,
          $BuyStation = $sellStation,
          $SellStation = $buyStation,
          $Amount = $amount,
          $Profit = $profit,
          $ROI = $roi,
          $Score = $efficiency,
          $BuyPrice = $buyPrice,
          $SellPrice = $sellPrice,
          $Distance = $distance,
          $Risk = $risk
        ]"/>
        <return value="$trade"/>
      </actions>
    </library>
    
    <!-- Add Intra-Sector Offers -->
    <library name="GT_AddIntraSectorOffers" purpose="run_actions">
      <params>
        <param name="originalSellOffers" comment="Original sell offers before limiting"/>
        <param name="originalBuyOffers" comment="Original buy offers before limiting"/>
        <param name="limitedSellOffers" comment="Limited sell offers (will be modified)"/>
        <param name="limitedBuyOffers" comment="Limited buy offers (will be modified)"/>
        <param name="currentSector" comment="Current sector"/>
        <param name="currentSectorIsBlacklisted" default="false" comment="Is current sector blacklisted"/>
      </params>
      <actions>
        <set_value name="$addedSellCount" exact="0"/>
        <set_value name="$addedBuyCount" exact="0"/>
        
        <!-- Only add intra-sector offers if current sector is not blacklisted -->
        <do_if value="$currentSector? and not $currentSectorIsBlacklisted">
          <!-- Scan original sell offers for intra-sector ones not in limited list -->
          <do_all exact="$originalSellOffers.count" counter="$idx">
            <set_value name="$offer" exact="$originalSellOffers.{$idx}"/>
            <set_value name="$offerSector" exact="@$offer.owner.sector"/>
            <do_if value="$offerSector? and $offerSector == $currentSector">
              <!-- Check if already in limited list -->
              <set_value name="$alreadyIncluded" exact="false"/>
              <do_all exact="$limitedSellOffers.count" counter="$checkIdx">
                <do_if value="$limitedSellOffers.{$checkIdx} == $offer">
                  <set_value name="$alreadyIncluded" exact="true"/>
                  <break/>
                </do_if>
              </do_all>
              <!-- Add if not already included -->
              <do_if value="not $alreadyIncluded">
                <append_to_list name="$limitedSellOffers" exact="$offer"/>
                <set_value name="$addedSellCount" operation="add"/>
              </do_if>
            </do_if>
          </do_all>
          
          <!-- Scan original buy offers for intra-sector ones not in limited list -->
          <do_all exact="$originalBuyOffers.count" counter="$idx">
            <set_value name="$offer" exact="$originalBuyOffers.{$idx}"/>
            <set_value name="$offerSector" exact="@$offer.owner.sector"/>
            <do_if value="$offerSector? and $offerSector == $currentSector">
              <!-- Check if already in limited list -->
              <set_value name="$alreadyIncluded" exact="false"/>
              <do_all exact="$limitedBuyOffers.count" counter="$checkIdx">
                <do_if value="$limitedBuyOffers.{$checkIdx} == $offer">
                  <set_value name="$alreadyIncluded" exact="true"/>
                  <break/>
                </do_if>
              </do_all>
              <!-- Add if not already included -->
              <do_if value="not $alreadyIncluded">
                <append_to_list name="$limitedBuyOffers" exact="$offer"/>
                <set_value name="$addedBuyCount" operation="add"/>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
        
        <!-- Return result table -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$UpdatedSellOffers" exact="$limitedSellOffers"/>
        <set_value name="$result.$UpdatedBuyOffers" exact="$limitedBuyOffers"/>
        <set_value name="$result.$AddedSellCount" exact="$addedSellCount"/>
        <set_value name="$result.$AddedBuyCount" exact="$addedBuyCount"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Validate Trade Offer Pair -->
    <library name="GT_ValidateTradeOfferPair" purpose="run_actions">
      <params>
        <param name="sellOffer" comment="Sell offer to validate"/>
        <param name="buyOffer" comment="Buy offer to validate"/>
      </params>
      <actions>
        <!-- Validate sell offer -->
        <set_value name="$sellOfferOwner" exact="@$sellOffer.owner"/>
        <set_value name="$sellOfferPrice" exact="@$sellOffer.unitprice"/>
        <do_if value="not $sellOffer? or not $sellOfferOwner? or not $sellOfferPrice?">
          <return value="false"/>
        </do_if>
        
        <!-- Validate buy offer -->
        <set_value name="$buyOfferOwner" exact="@$buyOffer.owner"/>
        <set_value name="$buyOfferPrice" exact="@$buyOffer.unitprice"/>
        <do_if value="not $buyOffer? or not $buyOfferOwner? or not $buyOfferPrice?">
          <return value="false"/>
        </do_if>
        
        <!-- Different stations only -->
        <do_if value="$sellOfferOwner == $buyOfferOwner">
          <return value="false"/>
        </do_if>
        
        <return value="true"/>
      </actions>
    </library>
    
    <!-- Check Failed Sector Pair -->
    <library name="GT_CheckFailedSectorPair" purpose="run_actions">
      <params>
        <param name="buySector" comment="Buy station sector"/>
        <param name="sellSector" comment="Sell station sector"/>
        <param name="failedTrades" comment="List of failed trades to check against"/>
      </params>
      <actions>
        <set_value name="$isFailed" exact="false"/>
        <do_if value="$failedTrades.count gt 0">
          <do_all exact="$failedTrades.count" counter="$failIdx">
            <set_value name="$failedTrade" exact="$failedTrades.{$failIdx}"/>
            <do_if value="$failedTrade.$BuySector? and $failedTrade.$SellSector?">
              <do_if value="$buySector == $failedTrade.$BuySector and $sellSector == $failedTrade.$SellSector">
                <set_value name="$isFailed" exact="true"/>
                <break/>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
        <return value="$isFailed"/>
      </actions>
    </library>
    
    <!-- Check Route Conflict -->
    <library name="GT_CheckRouteConflict" purpose="run_actions">
      <params>
        <param name="sellStation" comment="Sell station"/>
        <param name="buyStation" comment="Buy station"/>
        <param name="ware" comment="Ware being traded"/>
        <param name="reservedRoutes" comment="List of reserved route keys"/>
      </params>
      <actions>
        <set_value name="$isConflicted" exact="false"/>
        <do_if value="$reservedRoutes.count gt 0">
          <set_value name="$tradeCacheKey" exact="$sellStation.idcode + '_' + $buyStation.idcode + '_' + $ware"/>
          <set_value name="$isConflicted" exact="$reservedRoutes.indexof.{$tradeCacheKey}?"/>
        </do_if>
        <return value="$isConflicted"/>
      </actions>
    </library>
    
    <!-- Update Trade Quota -->
    <library name="GT_UpdateTradeQuota" purpose="run_actions">
      <params>
        <param name="tradesPerWare" comment="Table of trades per ware (may be null or invalid)"/>
        <param name="ware" comment="Ware to update quota for"/>
        <param name="increment" default="1" comment="Amount to increment"/>
      </params>
      <actions>
        <!-- Ensure tradesPerWare is a valid table -->
        <set_value name="$validTable" exact="$tradesPerWare"/>
        <set_value name="$keysCheck" exact="@$validTable.keys"/>
        <set_value name="$countCheck" exact="@$keysCheck.count"/>
        <do_if value="not $countCheck? or $countCheck lt 0">
          <set_value name="$validTable" exact="table[]"/>
        </do_if>
        
        <!-- Get current count for this ware -->
        <set_value name="$currentCount" exact="0"/>
        <do_if value="$validTable.{$ware}?">
          <set_value name="$currentCount" exact="$validTable.{$ware}"/>
        </do_if>
        
        <!-- Update count -->
        <set_value name="$newCount" exact="$currentCount + $increment"/>
        <set_value name="$validTable.{$ware}" exact="$newCount"/>
        
        <!-- Return updated table and new count -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$UpdatedTable" exact="$validTable"/>
        <set_value name="$result.$NewCount" exact="$newCount"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Clear Pending Trade Data -->
    <!-- ✅ EXTRACTED: Cleanup function for pending trade data to avoid code duplication -->
    <library name="GT_ClearPendingTradeData" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to clear pending trade data for"/>
      </params>
      <actions>
        <!-- Clear pending trade list -->
        <do_if value="global.$GT_PendingTrades? and global.$GT_PendingTrades.{$ship}?">
          <remove_value name="global.$GT_PendingTrades.{$ship}"/>
        </do_if>
        
        <!-- Clear search method tracking -->
        <do_if value="global.$GT_PendingTradesSearchMethod? and global.$GT_PendingTradesSearchMethod.{$ship}?">
          <remove_value name="global.$GT_PendingTradesSearchMethod.{$ship}"/>
        </do_if>
      </actions>
    </library>
    
  </cues>
</mdscript>
