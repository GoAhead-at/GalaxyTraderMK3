<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Trade_Utilities" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================= -->
    <!-- TRADE UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Is Intra-Sector Trade -->
    <library name="GT_IsIntraSectorTrade" purpose="run_actions">
      <params>
        <param name="buySector" comment="Buy station sector"/>
        <param name="sellSector" comment="Sell station sector"/>
        <param name="currentSector" comment="Ship's current sector"/>
      </params>
      <actions>
        <do_if value="$buySector? and $sellSector? and $currentSector?">
          <do_if value="$buySector == $currentSector and $sellSector == $currentSector">
            <return value="true"/>
          </do_if>
        </do_if>
        <return value="false"/>
      </actions>
    </library>
    
    <!-- Calculate Trade Efficiency -->
    <library name="GT_CalculateTradeEfficiency" purpose="run_actions">
      <params>
        <param name="profit" comment="Trade profit"/>
        <param name="distance" comment="Trade distance (jumps)"/>
        <param name="distancePenaltyMultiplier" default="1.0" comment="Distance penalty multiplier (0.0-2.0)"/>
        <param name="factionPriority" default="2" comment="Faction priority (0=Player, 1=Foreign, 2=Equal)"/>
        <param name="buyStationOwner" default="null" comment="Buy station owner faction"/>
        <param name="sellStationOwner" default="null" comment="Sell station owner faction"/>
      </params>
      <actions>
        <!-- Base efficiency calculation with NON-LINEAR distance penalty -->
        <!-- Formula: adjustedDistance = distance * multiplier * (1 + (distance / 10)^2) -->
        <!-- This creates quadratic penalty: longer distances get exponentially more penalized -->
        <!-- Examples with multiplier=2.0:
             - Distance 1:  1 * 2 * (1 + 0.01) = 2.02   (minimal penalty)
             - Distance 5:  5 * 2 * (1 + 0.25) = 12.5   (25% extra)
             - Distance 10: 10 * 2 * (1 + 1)   = 40     (100% extra = 2x)
             - Distance 20: 20 * 2 * (1 + 4)   = 200    (400% extra = 5x)
        -->
        <set_value name="$distanceBase" exact="10.0"/>
        <set_value name="$distanceRatio" exact="$distance / $distanceBase"/>
        <set_value name="$nonLinearFactor" exact="1.0 + ($distanceRatio * $distanceRatio)"/>
        <set_value name="$adjustedDistance" exact="$distance * $distancePenaltyMultiplier * $nonLinearFactor"/>
        <!-- ✅ FIX: Convert float result to integer to avoid "Loss of data while converting floating point" error -->
        <!-- Use scaled integer math: multiply profit by 10000, convert adjustedDistance to integer (multiply by 10000), then do integer division -->
        <!-- This gives us integer result with precision (efficiency scaled by 10000 for integer math) -->
        <set_value name="$efficiency" exact="$profit"/>
        <do_if value="$adjustedDistance gt 0">
          <!-- Scale to integers: profit is already in cents (×100), multiply by 100 more to get ×10000 scale -->
          <!-- This ensures we have integer precision for the division -->
          <set_value name="$scaledProfit" exact="$profit * 100"/>
          <!-- Convert adjustedDistance to integer by multiplying by 10000 and storing in integer variable -->
          <!-- X4 will truncate float to int when assigning to integer variable -->
          <set_value name="$scaledDistanceInt" exact="($adjustedDistance * 10000)"/>
          <!-- Integer division: integer / integer = integer result (efficiency scaled by 10000) -->
          <!-- Note: Efficiency is now scaled by 10000, but all comparisons/scoring work correctly with scaled values -->
          <set_value name="$efficiency" exact="$scaledProfit / $scaledDistanceInt"/>
        </do_if>
        
        <!-- Apply faction priority boost -->
        <do_if value="$factionPriority == 0 and ($buyStationOwner == faction.player or $sellStationOwner == faction.player)">
          <set_value name="$boost" exact="$efficiency / 5"/>
          <set_value name="$efficiency" exact="$efficiency + $boost"/>
        </do_if>
        <do_elseif value="$factionPriority == 1 and $buyStationOwner != faction.player and $sellStationOwner != faction.player">
          <set_value name="$boost" exact="$efficiency / 5"/>
          <set_value name="$efficiency" exact="$efficiency + $boost"/>
        </do_elseif>
        
        <return value="$efficiency"/>
      </actions>
    </library>
    
    <!-- Get Distance Penalty Multiplier -->
    <library name="GT_GetDistancePenaltyMultiplier" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to get distance penalty for"/>
        <param name="defaultMultiplier" default="1.0" comment="Default multiplier (for 50% distance penalty)"/>
      </params>
      <actions>
        <set_value name="$distancePenalty" exact="@global.$GT_AIParameters.{$ship}.$DistancePenalty"/>
        <do_if value="$distancePenalty?">
          <!-- Convert 0-100% to 0.0-2.0: 0%=0.0, 50%=1.0, 100%=2.0 -->
          <return value="$distancePenalty / 50.0"/>
        </do_if>
        <return value="$defaultMultiplier"/>
      </actions>
    </library>
    
    <!-- Get Faction Priority Text -->
    <library name="GT_GetFactionPriorityText" purpose="run_actions">
      <params>
        <param name="factionPriority" comment="Faction priority value (0, 1, or 2)"/>
      </params>
      <actions>
        <return value="if $factionPriority == 0 then 'Player Only' else if $factionPriority == 1 then 'Foreign First' else 'Equal Priority'"/>
      </actions>
    </library>
    
    <!-- Calculate ROI from Prices -->
    <library name="GT_CalculateROIFromPrices" purpose="run_actions">
      <params>
        <param name="buyPrice" comment="Price per unit to buy"/>
        <param name="sellPrice" comment="Price per unit to sell"/>
      </params>
      <actions>
        <!-- Calculate ROI as percentage: ((sellPrice - buyPrice) / buyPrice) * 100 -->
        <do_if value="$buyPrice gt 0">
          <return value="(($sellPrice - $buyPrice) * 100) / $buyPrice"/>
        </do_if>
        <return value="0"/>
      </actions>
    </library>
    
    <!-- Get Skill-Based Multiplier -->
    <library name="GT_GetSkillMultiplier" purpose="run_actions">
      <params>
        <param name="skillLevel" comment="Pilot skill level (1-15+)"/>
      </params>
      <actions>
        <!-- Returns multiplier: 0.5 at Lv1 → 2.0 at Lv15 -->
        <!-- Formula: 0.5 + ((skillLevel - 1) * (1.5 / 14)) -->
        <return value="0.5 + (($skillLevel - 1) * (1.5 / 14))"/>
      </actions>
    </library>
    
    <!-- Validate Trade -->
    <library name="GT_IsTradeValid" purpose="run_actions">
      <params>
        <param name="trade" comment="Trade object to validate"/>
        <param name="minScore" default="0" comment="Minimum score required (default: 0 = any positive score)"/>
      </params>
      <actions>
        <!-- ✅ CRITICAL: Validate trade has all required properties -->
        <set_value name="$testBuyOffer" exact="@$trade.$BuyOffer"/>
        <set_value name="$testSellOffer" exact="@$trade.$SellOffer"/>
        <set_value name="$testScore" exact="@$trade.$Score"/>
        <do_if value="$testBuyOffer? and $testSellOffer? and $testScore? and $testScore gt $minScore">
          <set_value name="$testWare" exact="@$testBuyOffer.ware"/>
          <do_if value="$testWare?">
            <return value="true"/>
          </do_if>
        </do_if>
        <return value="false"/>
      </actions>
    </library>
    
    <!-- Calculate Max Tradeable Amount -->
    <library name="GT_CalculateMaxTradeableAmount" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship for cargo capacity calculation"/>
        <param name="ware" comment="Ware to calculate capacity for"/>
        <param name="buyOfferAmount" comment="Buy offer amount"/>
        <param name="sellOfferAmount" comment="Sell offer amount"/>
      </params>
      <actions>
        <!-- Calculate max cargo capacity for this ware -->
        <set_value name="$maxCargoCapacity" exact="($ship.cargo.free.all / $ware.volume)i"/>
        <!-- Return minimum of offer amounts and cargo capacity -->
        <return value="[$buyOfferAmount, $sellOfferAmount, $maxCargoCapacity].min"/>
      </actions>
    </library>
    
    <!-- Index Offers By Ware -->
    <library name="GT_IndexOffersByWare" purpose="run_actions">
      <params>
        <param name="offersList" comment="List of trade offers to index"/>
      </params>
      <actions>
        <set_value name="$offersByWare" exact="table[]"/>
        <do_all exact="$offersList.count" counter="$i">
          <set_value name="$offer" exact="$offersList.{$i}"/>
          <do_if value="not $offersByWare.{$offer.ware}?">
            <set_value name="$offersByWare.{$offer.ware}" exact="[]"/>
          </do_if>
          <append_to_list name="$offersByWare.{$offer.ware}" exact="$offer"/>
        </do_all>
        <return value="$offersByWare"/>
      </actions>
    </library>
    
    <!-- Filter Offers By Distance -->
    <library name="GT_FilterOffersByDistance" purpose="run_actions">
      <params>
        <param name="offersList" comment="List of offers to filter"/>
        <param name="homeSector" comment="Home/base sector for distance calculation"/>
        <param name="maxDistance" comment="Maximum distance (jumps)"/>
      </params>
      <actions>
        <set_value name="$filteredOffers" exact="[]"/>
        <set_value name="$filteredCount" exact="0"/>
        <do_all exact="$offersList.count" counter="$i">
          <set_value name="$offer" exact="$offersList.{$i}"/>
          <set_value name="$targetSector" exact="$offer.owner.sector"/>
          
          <!-- Calculate range-only distance (using library function) -->
          <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculateRangeOnlyDistance" result="$distance">
            <param name="fromSector" value="$homeSector"/>
            <param name="toSector" value="$targetSector"/>
          </run_actions>
          
          <!-- Keep offer if within max distance and path exists (distance >= 0) -->
          <do_if value="$distance ge 0 and $distance le $maxDistance">
            <append_to_list name="$filteredOffers" exact="$offer"/>
          </do_if>
          <do_else>
            <set_value name="$filteredCount" exact="$filteredCount + 1"/>
          </do_else>
        </do_all>
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$FilteredOffers" exact="$filteredOffers"/>
        <set_value name="$result.$FilteredCount" exact="$filteredCount"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Sort and Limit Offers -->
    <library name="GT_SortAndLimitOffers" purpose="run_actions">
      <params>
        <param name="offersList" comment="List of offers to sort and limit"/>
        <param name="maxCount" comment="Maximum number of offers to return"/>
        <param name="sortAscending" default="true" comment="If true, sort ascending (take first N), if false sort descending (take last N)"/>
      </params>
      <actions>
        <set_value name="$offers" exact="$offersList"/>
        <!-- Sort by relativeprice -->
        <sort_trades name="$offers" tradelist="$offers" sorter="relativeprice"/>
        
        <set_value name="$limitedOffers" exact="[]"/>
        <do_if value="$sortAscending">
          <!-- Take first N offers (lowest price for buy offers) -->
          <set_value name="$limitCount" exact="[$offers.count, $maxCount].min"/>
          <do_all exact="$limitCount" counter="$idx">
            <append_to_list name="$limitedOffers" exact="$offers.{$idx}"/>
          </do_all>
        </do_if>
        <do_else>
          <!-- Take last N offers (highest price for sell offers) -->
          <do_if value="$offers.count gt $maxCount">
            <set_value name="$startIndex" exact="$offers.count - $maxCount + 1"/>
            <do_all exact="$maxCount" counter="$idx">
              <set_value name="$actualIndex" exact="$startIndex + $idx - 1"/>
              <append_to_list name="$limitedOffers" exact="$offers.{$actualIndex}"/>
            </do_all>
          </do_if>
          <do_else>
            <!-- Less than limit, take all -->
            <do_all exact="$offers.count" counter="$idx">
              <append_to_list name="$limitedOffers" exact="$offers.{$idx}"/>
            </do_all>
          </do_else>
        </do_else>
        <return value="$limitedOffers"/>
      </actions>
    </library>
    
    <!-- Sort Trades By Score (highest first) -->
    <library name="GT_SortTradesByScore" purpose="run_actions">
      <params>
        <param name="tradeList" comment="List of trades to sort"/>
      </params>
      <actions>
        <!-- ✅ OPTIMIZATION #5: Optimize sort for small lists (≤10 items: O(n) vs O(n²)) -->
        <do_if value="$tradeList? and $tradeList.count gt 1">
          <do_if value="$tradeList.count gt 10">
            <!-- Large list: Full selection sort (necessary for proper ordering) -->
            <set_value name="$sortedTradeList" exact="[]"/>
            <set_value name="$remainingTrades" exact="$tradeList"/>
            <do_all exact="$tradeList.count" counter="$sortIdx">
              <set_value name="$maxScore" exact="-999999999"/>
              <set_value name="$maxIdx" exact="-1"/>
              <do_all exact="$remainingTrades.count" counter="$i">
                <set_value name="$trade" exact="$remainingTrades.{$i}"/>
                <set_value name="$tradeScore" exact="$trade.$Score"/>
                <do_if value="$tradeScore gt $maxScore">
                  <set_value name="$maxScore" exact="$tradeScore"/>
                  <set_value name="$maxIdx" exact="$i"/>
                </do_if>
              </do_all>
              <do_if value="$maxIdx ge 0">
                <append_to_list name="$sortedTradeList" exact="$remainingTrades.{$maxIdx}"/>
                <remove_value name="$remainingTrades.{$maxIdx}"/>
              </do_if>
            </do_all>
            <set_value name="$tradeList" exact="$sortedTradeList"/>
          </do_if>
          <do_elseif value="$tradeList.count gt 1">
            <!-- Small list (2-10): Single pass bubble-like sort (O(n²) but n is small) -->
            <set_value name="$sortedTradeList" exact="$tradeList"/>
            <!-- Single pass: swap adjacent elements if wrong order (n-1 comparisons) -->
            <do_all exact="$tradeList.count - 1" counter="$pass">
              <set_value name="$swapped" exact="false"/>
              <do_all exact="$tradeList.count - 1 - $pass" counter="$i">
                <set_value name="$currentScore" exact="$sortedTradeList.{$i}.$Score"/>
                <set_value name="$nextScore" exact="$sortedTradeList.{$i + 1}.$Score"/>
                <do_if value="$currentScore lt $nextScore">
                  <!-- Swap -->
                  <set_value name="$temp" exact="$sortedTradeList.{$i}"/>
                  <set_value name="$sortedTradeList.{$i}" exact="$sortedTradeList.{$i + 1}"/>
                  <set_value name="$sortedTradeList.{$i + 1}" exact="$temp"/>
                  <set_value name="$swapped" exact="true"/>
                </do_if>
              </do_all>
              <!-- Early exit if no swaps (already sorted) -->
              <do_if value="not $swapped">
                <break/>
              </do_if>
            </do_all>
            <set_value name="$tradeList" exact="$sortedTradeList"/>
          </do_elseif>
          <!-- Single item or empty: no sort needed -->
        </do_if>
        <return value="$tradeList"/>
      </actions>
    </library>
    
    <!-- Filter Trade For Ship (ware basket, illegal, blacklist, path availability) -->
    <library name="GT_FilterTradeForShip" purpose="run_actions">
      <params>
        <param name="trade" comment="Trade to filter"/>
        <param name="ship" comment="Ship that would execute the trade"/>
        <param name="ware" comment="Ware being traded"/>
        <param name="wareBasket" comment="Allowed ware basket (empty = all wares allowed)"/>
        <param name="allowIllegal" default="false" comment="Whether to allow illegal wares"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group"/>
        <param name="currentSector" comment="Ship's current sector"/>
        <param name="buySector" comment="Buy station sector"/>
        <param name="sellSector" comment="Sell station sector"/>
        <param name="filterStats" default="null" comment="Optional filter statistics table to update"/>
        <param name="isIntraSectorTrade" default="false" comment="Whether this is an intra-sector trade"/>
      </params>
      <actions>
        <!-- Initialize result -->
        <set_value name="$isAllowed" exact="true"/>
        <set_value name="$filterReason" exact="''"/>
        
        <!-- Ware basket check -->
        <set_value name="$wareAllowed" exact="true"/>
        <do_if value="$wareBasket.count gt 0">
          <run_actions ref="md.GT_Utilities.GT_IsWareInBasket" result="$wareAllowed">
            <param name="ware" value="$ware"/>
            <param name="basket" value="$wareBasket"/>
          </run_actions>
          <do_if value="not $wareAllowed">
            <set_value name="$isAllowed" exact="false"/>
            <set_value name="$filterReason" exact="'ware_basket'"/>
            <do_if value="$filterStats?">
              <set_value name="$filterStats.$filteredByWareBasket" exact="$filterStats.$filteredByWareBasket + 1"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Illegal ware check -->
        <do_if value="$wareAllowed and not $allowIllegal and @$ware.illegal">
          <set_value name="$wareAllowed" exact="false"/>
          <set_value name="$isAllowed" exact="false"/>
          <set_value name="$filterReason" exact="'illegal'"/>
          <do_if value="$filterStats?">
            <set_value name="$filterStats.$filteredByIllegal" exact="$filterStats.$filteredByIllegal + 1"/>
          </do_if>
        </do_if>
        
        <!-- Blacklist check -->
        <set_value name="$isBlacklisted" exact="false"/>
        <do_if value="$wareAllowed">
          <!-- ✅ FIX: Block intra-sector trades in blacklisted sectors (force escape) -->
          <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$currentSectorIsBlacklisted">
            <param name="sector" value="$currentSector"/>
            <param name="ship" value="$ship"/>
            <param name="blacklistgroup" value="$blacklistgroup"/>
          </run_actions>
          <do_if value="$currentSectorIsBlacklisted">
            <do_if value="$buySector == $currentSector and $sellSector == $currentSector">
              <!-- Intra-sector trade in blacklisted sector - BLOCK to force escape -->
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_intra'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check buy station blacklist -->
          <do_if value="not $isBlacklisted">
            <set_value name="$buyStation" exact="@$trade.$BuyStation"/>
            <run_actions ref="md.GT_Blacklist_Utilities.GT_IsStationBlacklisted" result="$buyStationBlacklisted">
              <param name="station" value="$buyStation"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$buyStationBlacklisted">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_buy_station'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check sell station blacklist -->
          <do_if value="not $isBlacklisted">
            <set_value name="$sellStation" exact="@$trade.$SellStation"/>
            <run_actions ref="md.GT_Blacklist_Utilities.GT_IsStationBlacklisted" result="$sellStationBlacklisted">
              <param name="station" value="$sellStation"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$sellStationBlacklisted">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_sell_station'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check buy sector blacklist -->
          <do_if value="not $isBlacklisted">
            <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$buySectorBlacklisted">
              <param name="sector" value="$buySector"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$buySectorBlacklisted">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'blacklist_buy_sector'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Check sell sector blacklist -->
          <do_if value="not $isBlacklisted">
            <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$sellSectorBlacklisted">
              <param name="sector" value="$sellSector"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$sellSectorBlacklisted">
              <do_if value="$sellSector != $currentSector">
                <!-- Ship needs to travel TO a blacklisted sector - BLOCK -->
                <set_value name="$isBlacklisted" exact="true"/>
                <set_value name="$isAllowed" exact="false"/>
                <set_value name="$filterReason" exact="'blacklist_sell_sector'"/>
                <do_if value="$filterStats?">
                  <set_value name="$filterStats.$filteredByBlacklist" exact="$filterStats.$filteredByBlacklist + 1"/>
                </do_if>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Path availability check -->
          <do_if value="not $isBlacklisted">
            <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculateTradePathDistances" result="$pathResult">
              <param name="ship" value="$ship"/>
              <param name="currentSector" value="$currentSector"/>
              <param name="buySector" value="$buySector"/>
              <param name="sellSector" value="$sellSector"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            
            <!-- Debug logging (if enabled) -->
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <do_if value="$pathResult.$IsIntraSectorTrade or not $pathResult.$IsReachable">
                <set_value name="$buySectorName" exact="@$buySector.knownname"/>
                <set_value name="$sellSectorName" exact="@$sellSector.knownname"/>
                <set_value name="$currentSectorName" exact="@$currentSector.knownname"/>
                <set_value name="$wareName" exact="@$ware.name"/>
                <set_value name="$tradeType" exact="if $pathResult.$IsIntraSectorTrade then 'INTRA-SECTOR' else 'CROSS-SECTOR'"/>
                <debug_text text="'[GT-Resume] ' + $ship.idcode + ': ' + $tradeType + ' trade (' + $wareName + '):' +
                  '\n  Current sector: ' + $currentSectorName + ' (blacklisted: ' + $pathResult.$CurrentSectorIsBlacklisted + ')' +
                  '\n  Buy sector: ' + $buySectorName + ' (distance: ' + $pathResult.$BuyPathDistance + ', same as current: ' + ($buySector == $currentSector) + ')' +
                  '\n  Sell sector: ' + $sellSectorName + ' (distance: ' + $pathResult.$SellPathDistance + ', same as buy: ' + ($sellSector == $buySector) + ', same as current: ' + ($sellSector == $currentSector) + ')' +
                  (if not $pathResult.$IsReachable then ' [PATH BLOCKED]' else '')"
                  chance="100"/>
              </do_if>
            </do_if>
            
            <!-- Block if paths are unreachable -->
            <do_if value="not $pathResult.$IsReachable">
              <set_value name="$isBlacklisted" exact="true"/>
              <set_value name="$isAllowed" exact="false"/>
              <set_value name="$filterReason" exact="'path_blocked'"/>
              <do_if value="$filterStats?">
                <set_value name="$filterStats.$filteredByPathBlocked" exact="$filterStats.$filteredByPathBlocked + 1"/>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Return result -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IsAllowed" exact="$isAllowed"/>
        <set_value name="$result.$FilterReason" exact="$filterReason"/>
        <return value="$result"/>
      </actions>
    </library>
    
  </cues>
</mdscript>
