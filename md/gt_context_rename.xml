<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Context_Rename" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/x4Original/libraries/md.xsd">
  <cues>
    <!-- Listen for Interact_Menu_API.Get_Actions to add our "MK3 Rename" entry -->
    <cue name="AddRenameAction" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.Interact_Menu_API.Get_Actions"/>
      </conditions>
      <actions>
        <set_value name="$target" exact="event.param.$object"/>
        <debug_text text="'[GT Context Rename] MD: AddRenameAction - target = ' + $target" chance="100"/>
        
        <!-- Only add for player-owned ships -->
        <do_if value="$target.isclass.{class.ship} and $target.isplayerowned">
          <debug_text text="'[GT Context Rename] MD: Adding MK3 Rename action for ship'" chance="100"/>
          <!-- Use string literal for text (MD doesn't support {page, id} in table params) -->
          <!-- Omit $icon parameter instead of using empty string to avoid icon lookup errors -->
          <signal_cue_instantly
            cue="md.Interact_Menu_API.Add_Action"
            param="table[
              $id         = 'gt_mk3_rename',
              $text       = 'MK3 Rename',
              $section    = 'main',
              $callback   = GT_RenameAction,
            ]"/>
          <debug_text text="'[GT Context Rename] MD: Action added successfully'" chance="100"/>
        </do_if>
        <do_else>
          <debug_text text="'[GT Context Rename] MD: Target is not a player-owned ship - skipping'" chance="100"/>
        </do_else>
      </actions>
    </cue>
    
    <!-- Handle when user clicks "MK3 Rename" -->
    <cue name="GT_RenameAction" instantiate="true" namespace="this">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <debug_text text="'[GT Context Rename] MD: GT_RenameAction triggered'" chance="100"/>
        <set_value name="$component" exact="event.param.$object"/>
        <debug_text text="'[GT Context Rename] MD: Component = ' + $component" chance="100"/>
        
        <!-- Get GT original name from pilot registry -->
        <set_value name="$originalName" exact="null"/>
        <set_value name="$pilot" exact="null"/>
        <do_if value="$component.pilot?">
          <set_value name="$pilot" exact="$component.pilot"/>
          <do_if value="global.$GT_Pilots.{$pilot}? and global.$GT_Pilots.{$pilot}.$OriginalShipName?">
            <set_value name="$originalName" exact="global.$GT_Pilots.{$pilot}.$OriginalShipName"/>
            <debug_text text="'[GT Context Rename] MD: Found original name: ' + $originalName" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- If no original name found, use current ship name as fallback -->
        <do_if value="not $originalName?">
          <set_value name="$originalName" exact="$component.knownname"/>
          <debug_text text="'[GT Context Rename] MD: Using current ship name as fallback: ' + $originalName" chance="100"/>
        </do_if>
        
        <!-- Store original name in NPCBlackboard for Lua to read -->
        <set_value name="player.entity.$GT_ContextRename_OriginalName" exact="$originalName"/>
        
        <!-- Trigger Lua event to open rename dialog -->
        <debug_text text="'[GT Context Rename] MD: Raising Lua event gt.openRenameContext with originalName: ' + $originalName" chance="100"/>
        <raise_lua_event name="'gt.openRenameContext'" param="$component"/>
        <debug_text text="'[GT Context Rename] MD: Lua event raised'" chance="100"/>
      </actions>
    </cue>
    
    <!-- Handle rename confirmation from Lua - set GT original name -->
    <cue name="HandleRenameConfirmation" instantiate="true">
      <conditions>
        <event_object_signalled object="event.object" param="'gt_set_original_name'"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        <set_value name="$newName" exact="event.param"/>
        
        <!-- Get pilot from ship -->
        <set_value name="$pilot" exact="null"/>
        <do_if value="$ship.pilot?">
          <set_value name="$pilot" exact="$ship.pilot"/>
        </do_if>
        
        <!-- Store original name in GT_Pilots registry -->
        <do_if value="$pilot and global.$GT_Pilots.{$pilot}?">
          <set_value name="global.$GT_Pilots.{$pilot}.$OriginalShipName" exact="$newName"/>
          
          <!-- Trigger GT ship name update to apply the new original name -->
          <run_actions ref="md.GT_Ship_Management.Update_Pilot_Ship_Name">
            <param name="pilot" value="$pilot"/>
            <param name="ship" value="$ship"/>
            <param name="forceUpdate" value="true"/>
          </run_actions>
          
          <debug_text text="'[GT Context Rename] Set original name for pilot ' + $pilot.name + ' to: ' + $newName" chance="100"/>
        </do_if>
        <do_else>
          <debug_text text="'[GT Context Rename] WARNING: Could not set original name - pilot not found or ship not registered in GT'" chance="100"/>
        </do_else>
      </actions>
    </cue>
  </cues>
</mdscript>
