<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Context_Rename" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/x4Original/libraries/md.xsd">
  <cues>
    <!-- Listen for Interact_Menu_API.Get_Actions to add our "GT Rename" entry -->
    <cue name="AddRenameAction" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.Interact_Menu_API.Get_Actions"/>
      </conditions>
      <actions>
        <set_value name="$target" exact="event.param.$object"/>
        
        <!-- PERFORMANCE FIX: Early exit for non-player ships - skip all processing and logging -->
        <!-- Only process if it's actually a player-owned ship -->
        <do_if value="$target.isclass.{class.ship} and $target.isplayerowned">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT Context Rename] MD: Adding GT Rename action for ship (ID: ' + $target.idcode + ')'" chance="100"/>
          </do_if>
          <set_value name="$renameActionText" exact="{77000,9001}"/>
          <!-- Omit $icon parameter instead of using empty string to avoid icon lookup errors -->
          <signal_cue_instantly
            cue="md.Interact_Menu_API.Add_Action"
            param="table[
              $id         = 'gt_mk3_rename',
              $text       = $renameActionText,
              $section    = 'gt_actions',
              $callback   = GT_RenameAction,
            ]"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT Context Rename] MD: Action added successfully for ship (ID: ' + $target.idcode + ')'" chance="100"/>
          </do_if>
          
          <!-- Add manual training action only when AutoTraining is disabled and pilot is blocked -->
          <set_value name="$autoTrainingEnabled" exact="true"/>
          <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$XP? and global.$GT_GlobalSettings.$XP.$AutoTraining?">
            <set_value name="$autoTrainingEnabled" exact="global.$GT_GlobalSettings.$XP.$AutoTraining"/>
          </do_if>
          
          <set_value name="$pilot" exact="null"/>
          <set_value name="$blockedLevel" exact="0"/>
          <do_if value="$target.pilot?">
            <set_value name="$pilot" exact="$target.pilot"/>
            <do_if value="$pilot and global.$GT_Pilots? and global.$GT_Pilots.{$pilot}? and global.$GT_Pilots.{$pilot}.$BlockedLevel?">
              <set_value name="$blockedLevel" exact="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
            </do_if>
          </do_if>
          
          <do_if value="not $autoTrainingEnabled and $pilot and $blockedLevel gt 1">
            <set_value name="$manualTrainingActionText" exact="{77000,9902}"/>
            <signal_cue_instantly
              cue="md.Interact_Menu_API.Add_Action"
              param="table[
                $id         = 'gt_mk3_manual_training',
                $text       = $manualTrainingActionText,
                $section    = 'gt_actions',
                $callback   = GT_QueueManualTrainingAction,
              ]"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT Context Rename] MD: Added manual training action for ship (ID: ' + $target.idcode + ', blocked level ' + $blockedLevel + ')'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
        <!-- PERFORMANCE FIX: Removed else block - early exit above prevents unnecessary processing -->
      </actions>
    </cue>
    
    <!-- Handle manual training request from context menu -->
    <cue name="GT_QueueManualTrainingAction" instantiate="true" namespace="this">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$component" exact="event.param.$object"/>
        <set_value name="$pilot" exact="null"/>
        <set_value name="$blockedLevel" exact="0"/>
        
        <do_if value="$component.pilot?">
          <set_value name="$pilot" exact="$component.pilot"/>
        </do_if>
        
        <do_if value="$pilot and global.$GT_Pilots? and global.$GT_Pilots.{$pilot}?">
          <do_if value="global.$GT_Pilots.{$pilot}.$BlockedLevel?">
            <set_value name="$blockedLevel" exact="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
          </do_if>
          
          <do_if value="$blockedLevel gt 1">
            <!-- Queue manual training request; AI processes it after current cycle -->
            <set_value name="global.$GT_Pilots.{$pilot}.$ManualTrainingRequested" exact="true"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$TrainingState" exact="'manual_training_queued'"/>
            
            <show_notification text="{77000,9903}.[$pilot.name]" timeout="6s" priority="7"/>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT Context Rename] Manual training queued for ' + $pilot.name + ' on ship ' + $component.idcode + ' (blocked level ' + $blockedLevel + ')'" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT Context Rename] Manual training requested but blocked level invalid for ship ' + $component.idcode" chance="100"/>
            </do_if>
          </do_else>
        </do_if>
      </actions>
    </cue>
    
    <!-- Handle when user clicks "GT Rename" -->
    <cue name="GT_RenameAction" instantiate="true" namespace="this">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT Context Rename] MD: GT_RenameAction triggered'" chance="100"/>
        </do_if>
        <set_value name="$component" exact="event.param.$object"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT Context Rename] MD: Component = ' + $component" chance="100"/>
        </do_if>
        
        <!-- Get GT original name from pilot registry -->
        <set_value name="$originalName" exact="null"/>
        <set_value name="$pilot" exact="null"/>
        <do_if value="$component.pilot?">
          <set_value name="$pilot" exact="$component.pilot"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT Context Rename] MD: Pilot found: ' + $pilot.name" chance="100"/>
          </do_if>
          <do_if value="global.$GT_Pilots.{$pilot}?">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT Context Rename] MD: Pilot exists in GT_Pilots registry'" chance="100"/>
            </do_if>
            <do_if value="global.$GT_Pilots.{$pilot}.$OriginalShipName?">
              <set_value name="$originalName" exact="global.$GT_Pilots.{$pilot}.$OriginalShipName"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT Context Rename] MD: Found original name: ' + $originalName" chance="100"/>
              </do_if>
            </do_if>
            <do_else>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT Context Rename] MD: Pilot exists but $OriginalShipName field is missing'" chance="100"/>
              </do_if>
            </do_else>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT Context Rename] MD: Pilot NOT found in GT_Pilots registry'" chance="100"/>
            </do_if>
          </do_else>
        </do_if>
        <do_else>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT Context Rename] MD: Ship has no pilot'" chance="100"/>
          </do_if>
        </do_else>
        
        <!-- If no original name found, use empty string (let user enter new name) -->
        <do_if value="not $originalName?">
          <set_value name="$originalName" exact="''"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT Context Rename] MD: No GT original name found - starting with empty string'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Store original name in NPCBlackboard for Lua to read -->
        <set_value name="player.entity.$GT_ContextRename_OriginalName" exact="$originalName"/>
        
        <!-- Trigger Lua event to open rename dialog -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT Context Rename] MD: Raising Lua event gt.openRenameContext with originalName: ' + $originalName" chance="100"/>
        </do_if>
        <raise_lua_event name="'gt.openRenameContext'" param="$component"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT Context Rename] MD: Lua event raised'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Handle rename confirmation from Lua - set GT original name -->
    <!-- Event-driven: triggered when Lua signals the rename confirmation -->
    <cue name="HandleRenameConfirmation" instantiate="true">
      <conditions>
        <event_object_signalled object="player.entity" param="'gt_context_rename_confirmed'"/>
      </conditions>
      <actions>
        <!-- Get component from event parameter (SignalObject third param becomes event.param2) -->
        <set_value name="$component" exact="event.param2"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT Context Rename] HandleRenameConfirmation: Received signal for component = ' + $component" chance="100"/>
        </do_if>
        
        <!-- Get newName from NPCBlackboard (stored separately to avoid table access issues) -->
        <set_value name="$newName" exact="player.entity.$GT_ContextRename_NewName"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT Context Rename] HandleRenameConfirmation: newName from blackboard = ' + $newName" chance="100"/>
        </do_if>
        
        <!-- event.param2 should be a component object (like in vanilla orders.xml) -->
        <!-- Use component from event.param2 directly as the ship -->
        <set_value name="$ship" exact="event.param2"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT Context Rename] HandleRenameConfirmation: Processing rename - ship = ' + $ship + ', newName = ' + $newName" chance="100"/>
        </do_if>
        
        <!-- Clear the data immediately to prevent reprocessing -->
        <set_value name="player.entity.$GT_ContextRename_NewName" exact="null"/>
        
        <!-- Get pilot from ship -->
        <set_value name="$pilot" exact="null"/>
        <do_if value="$ship.pilot?">
          <set_value name="$pilot" exact="$ship.pilot"/>
        </do_if>
        
        <!-- Store original name in GT_Pilots registry -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT Context Rename] HandleRenameConfirmation: ship = ' + $ship + ', newName = ' + $newName" chance="100"/>
          <debug_text text="'[GT Context Rename] HandleRenameConfirmation: pilot = ' + (if $pilot != null then @$pilot.name else 'null')" chance="100"/>
        </do_if>
        
        <do_if value="$pilot?">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT Context Rename] HandleRenameConfirmation: Checking if pilot exists in GT_Pilots registry'" chance="100"/>
          </do_if>
          <do_if value="global.$GT_Pilots.{$pilot}?">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT Context Rename] HandleRenameConfirmation: Pilot found in registry, setting $OriginalShipName'" chance="100"/>
            </do_if>
            <set_value name="global.$GT_Pilots.{$pilot}.$OriginalShipName" exact="$newName"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT Context Rename] HandleRenameConfirmation: Set global.$GT_Pilots.{' + $pilot.name + '}.$OriginalShipName = ' + $newName" chance="100"/>
            </do_if>
            
            <!-- CRITICAL FIX: Also update ship registry so custom name takes priority -->
            <!-- The UpdateShipName cue checks ship registry first, then pilot registry -->
            <do_if value="not global.$GT_Ships?">
              <set_value name="global.$GT_Ships" exact="table[]"/>
            </do_if>
            <do_if value="not global.$GT_Ships.{$ship}?">
              <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
            </do_if>
            <set_value name="global.$GT_Ships.{$ship}.$OriginalShipName" exact="$newName"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT Context Rename] HandleRenameConfirmation: Also updated global.$GT_Ships.{' + $ship.idcode + '}.$OriginalShipName = ' + $newName" chance="100"/>
            </do_if>
            
            <!-- Trigger GT ship name update to apply the new original name -->
            <run_actions ref="md.GT_Ship_Management.Update_Pilot_Ship_Name">
              <param name="pilot" value="$pilot"/>
              <param name="ship" value="$ship"/>
              <param name="forceUpdate" value="true"/>
            </run_actions>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT Context Rename] Set original name for pilot ' + $pilot.name + ' to: ' + $newName + ' and triggered name update'" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <!-- Pilot not registered yet - register them first so we can store the original name -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT Context Rename] HandleRenameConfirmation: Pilot ' + $pilot.name + ' NOT found in GT_Pilots registry - registering pilot first'" chance="100"/>
            </do_if>
            <run_actions ref="md.GT_Ship_Management.Register_Pilot">
              <param name="pilot" value="$pilot"/>
              <param name="ship" value="$ship"/>
            </run_actions>
            
            <!-- Now set the original name -->
            <do_if value="global.$GT_Pilots.{$pilot}?">
              <set_value name="global.$GT_Pilots.{$pilot}.$OriginalShipName" exact="$newName"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT Context Rename] HandleRenameConfirmation: Registered pilot and set $OriginalShipName = ' + $newName" chance="100"/>
              </do_if>
              
              <!-- CRITICAL FIX: Also update ship registry so custom name takes priority -->
              <!-- The UpdateShipName cue checks ship registry first, then pilot registry -->
              <do_if value="not global.$GT_Ships?">
                <set_value name="global.$GT_Ships" exact="table[]"/>
              </do_if>
              <do_if value="not global.$GT_Ships.{$ship}?">
                <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
              </do_if>
              <set_value name="global.$GT_Ships.{$ship}.$OriginalShipName" exact="$newName"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT Context Rename] HandleRenameConfirmation: Also updated global.$GT_Ships.{' + $ship.idcode + '}.$OriginalShipName = ' + $newName" chance="100"/>
              </do_if>
              
              <!-- Trigger GT ship name update to apply the new original name -->
              <run_actions ref="md.GT_Ship_Management.Update_Pilot_Ship_Name">
                <param name="pilot" value="$pilot"/>
                <param name="ship" value="$ship"/>
                <param name="forceUpdate" value="true"/>
              </run_actions>
              
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT Context Rename] Set original name for newly registered pilot ' + $pilot.name + ' to: ' + $newName + ' and triggered name update'" chance="100"/>
              </do_if>
            </do_if>
          </do_else>
        </do_if>
        <do_else>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT Context Rename] WARNING: Ship has no pilot - cannot save original name'" chance="100"/>
          </do_if>
        </do_else>
      </actions>
    </cue>
  </cues>
</mdscript>
