<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Ship_State_Utilities" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================= -->
    <!-- SHIP STATE UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Check Commander Status -->
    <!-- Returns table with HasCommander, CommanderHasGT, Commander -->
    <library name="GT_CheckCommanderStatus" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to check commander for"/>
      </params>
      <actions>
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$HasCommander" exact="false"/>
        <set_value name="$result.$CommanderHasGT" exact="false"/>
        <set_value name="$result.$Commander" exact="null"/>
        
        <do_if value="$ship.commander? and $ship.commander.exists and $ship.commander != $ship">
          <set_value name="$result.$HasCommander" exact="true"/>
          <set_value name="$result.$Commander" exact="$ship.commander"/>
          <do_if value="$ship.commander.defaultorder? and @$ship.commander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$result.$CommanderHasGT" exact="true"/>
          </do_if>
        </do_if>
        
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Is Subordinate of GT Commander -->
    <!-- Quick check if ship is subordinate to a GT commander -->
    <library name="GT_IsSubordinateOfGTCommander" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to check"/>
      </params>
      <actions>
        <run_actions ref="md.GT_Ship_State_Utilities.GT_CheckCommanderStatus" result="$commanderStatus">
          <param name="ship" value="$ship"/>
        </run_actions>
        <return value="$commanderStatus.$HasCommander and $commanderStatus.$CommanderHasGT"/>
      </actions>
    </library>
    
    <!-- Get Ship State -->
    <!-- Returns ship state with safe property access -->
    <library name="GT_GetShipState" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to get state for"/>
      </params>
      <actions>
        <set_value name="$state" exact="null"/>
        <do_if value="global.$GT_Ship_State? and global.$GT_Ship_State.{$ship}?">
          <set_value name="$state" exact="global.$GT_Ship_State.{$ship}"/>
        </do_if>
        
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$State" exact="$state"/>
        <set_value name="$result.$HasGTOrder" exact="false"/>
        <set_value name="$result.$OperationalState" exact="'unknown'"/>
        <set_value name="$result.$SubordinateState" exact="'unknown'"/>
        <set_value name="$result.$CommanderHasGT" exact="false"/>
        <set_value name="$result.$OriginalShipName" exact="null"/>
        
        <do_if value="$state?">
          <do_if value="$state.$HasGTOrder? and $state.$HasGTOrder">
            <set_value name="$result.$HasGTOrder" exact="true"/>
          </do_if>
          <do_if value="$state.$OperationalState?">
            <set_value name="$result.$OperationalState" exact="$state.$OperationalState"/>
          </do_if>
          <do_if value="$state.$SubordinateState?">
            <set_value name="$result.$SubordinateState" exact="$state.$SubordinateState"/>
          </do_if>
          <do_if value="$state.$CommanderHasGT? and $state.$CommanderHasGT">
            <set_value name="$result.$CommanderHasGT" exact="true"/>
          </do_if>
          <do_if value="$state.$OriginalShipName?">
            <set_value name="$result.$OriginalShipName" exact="$state.$OriginalShipName"/>
          </do_if>
        </do_if>
        
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Restore Ship Name -->
    <!-- Handles name restoration logic with subordinate checking -->
    <library name="GT_RestoreShipName" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to restore name for"/>
        <param name="reason" comment="Reason for name restoration"/>
        <param name="checkSubordinate" default="true" comment="Check if subordinate to GT commander"/>
        <param name="state" default="null" comment="Ship state (optional, for state-based name lookup)"/>
        <param name="checkDirectGTOrder" default="true" comment="Check if ship has direct GT order"/>
      </params>
      <actions>
        <!-- Check if ship has direct GT order -->
        <set_value name="$hasDirectGTOrder" exact="false"/>
        <do_if value="$checkDirectGTOrder">
          <do_if value="$ship.defaultorder? and @$ship.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$hasDirectGTOrder" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- If ship has direct GT order, don't restore name -->
        <do_if value="$hasDirectGTOrder">
          <return value="false"/>
        </do_if>
        
        <!-- Check if ship is subordinate to GT commander -->
        <set_value name="$isSubordinateOfGTCommander" exact="false"/>
        <do_if value="$checkSubordinate">
          <run_actions ref="md.GT_Ship_State_Utilities.GT_IsSubordinateOfGTCommander" result="$isSubordinate">
            <param name="ship" value="$ship"/>
          </run_actions>
          <set_value name="$isSubordinateOfGTCommander" exact="$isSubordinate"/>
        </do_if>
        
        <!-- Restore name if ship is not GT-controlled -->
        <set_value name="$shouldRestore" exact="false"/>
        <do_if value="not $isSubordinateOfGTCommander and $ship.pilot?">
          <set_value name="$shouldRestore" exact="true"/>
        </do_if>
        
        <do_if value="$shouldRestore">
          <set_value name="$originalName" exact="null"/>
          
          <!-- Try to get original name from pilot registry -->
          <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{$ship.pilot}? and global.$GT_Pilots.{$ship.pilot}.$OriginalShipName?">
            <set_value name="$originalName" exact="global.$GT_Pilots.{$ship.pilot}.$OriginalShipName"/>
          </do_if>
          <!-- Fallback to state if available -->
          <do_elseif value="$state? and $state.$OriginalShipName?">
            <set_value name="$originalName" exact="$state.$OriginalShipName"/>
          </do_elseif>
          
          <do_if value="$originalName">
            <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
              $Ship = $ship,
              $Pilot = $ship.pilot,
              $Reason = $reason,
              $OriginalName = $originalName
            ]"/>
            <return value="true"/>
          </do_if>
        </do_if>
        <return value="false"/>
      </actions>
    </library>
    
  </cues>
</mdscript>
