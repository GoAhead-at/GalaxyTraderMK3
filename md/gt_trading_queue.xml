<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Trading_Queue" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - QUEUE MANAGEMENT
         Handles trading and search queue processing
         ======================================== -->
    
    <!-- Trading Queue Processor -->
    <cue name="ProcessTradingQueue" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <!-- DEBUG: Queue processing called -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3 DEBUG] ProcessTradingQueue called. Queue size: ' + global.$GT_TradingQueue.$Ships.count + ', Processing: ' + global.$GT_TradingQueue.$Processing" chance="100"/>
        </do_if>
        
        <!-- Prevent concurrent processing -->
        <do_if value="not global.$GT_TradingQueue.$Processing and global.$GT_TradingQueue.$Ships.count gt 0">
          <set_value name="global.$GT_TradingQueue.$Processing" exact="true"/>
          
          <!-- DEBUG: Starting batch processing -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] Starting batch processing of ' + global.$GT_TradingQueue.$Ships.count + ' ships'" chance="100"/>
          </do_if>
          
          <!-- Process ships ONE AT A TIME with delays to prevent stuttering -->
          <set_value name="$batchSize" exact="1"/> <!-- Process 1 ship at a time for better performance -->
          <set_value name="$processed" exact="0"/>
          <set_value name="$toProcessCount" exact="[global.$GT_TradingQueue.$Ships.count, $batchSize].min"/>
          
          <do_while value="global.$GT_TradingQueue.$Ships.count gt 0 and $processed lt $batchSize">
            <set_value name="$ship" exact="global.$GT_TradingQueue.$Ships.{1}"/>
            <remove_from_list name="global.$GT_TradingQueue.$Ships" exact="$ship"/>
            
            <!-- DEBUG: Processing individual ship -->
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') DEQUEUED: Processing ship ' + ($processed + 1) + '/' + $toProcessCount + ': ' + $ship.knownname + ' (queue size now: ' + global.$GT_TradingQueue.$Ships.count + ')'" chance="100"/>
            </do_if>
            
            <!-- Process ship trading with optional skill-based pre-search delay -->
            <do_if value="$ship.exists and $ship.isoperational">
              <!-- CRITICAL: Verify AI parameters exist before processing -->
              <!-- Parameters may have been deleted between queueing and processing -->
              <!-- This prevents "AI parameters missing" errors when parameters are cleaned up -->
              <do_if value="not (global.$GT_AIParameters? and global.$GT_AIParameters.{$ship}?)">
                <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Skipping ship - AI parameters missing (may have been cleaned up or released between queueing and processing)'" chance="100"/>
                </do_if>
                <!-- Signal AI that no trade is available -->
                <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
                <!-- Release any stale lock if it exists -->
                <do_if value="global.$GT_SearchLocks? and global.$GT_SearchLocks.{$ship}?">
                  <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Release">
                    <param name="ship" value="$ship"/>
                    <param name="reason" value="'parameters_missing_in_queue'"/>
                  </run_actions>
                </do_if>
                <!-- Skip to next ship -->
                <continue/>
              </do_if>
              
              <!-- Resolve pilot skill level -->
              <run_actions ref="md.GT_Ship_Management.Calculate_Skill_Level" result="$skillInfo">
                <param name="ship" value="$ship"/>
              </run_actions>
              <set_value name="$skillLevel" exact="if @$skillInfo.$Level != null then @$skillInfo.$Level else 1"/>

              <!-- Add randomization to prevent simultaneous searches -->
              <set_value name="$penaltyDelay" exact="0s"/>
              <do_if value="$skillLevel le 1">
                <!-- 30s ± 5s randomization (25-35s range) -->
                <set_value name="$penaltyDelay" min="25s" max="35s"/>
              </do_if>
              <do_elseif value="$skillLevel == 2">
                <!-- 22.5s ± 3.75s randomization (18.75-26.25s range) -->
                <set_value name="$penaltyDelay" min="18.75s" max="26.25s"/>
              </do_elseif>
              <do_elseif value="$skillLevel == 3">
                <!-- 15s ± 2.5s randomization (12.5-17.5s range) -->
                <set_value name="$penaltyDelay" min="12.5s" max="17.5s"/>
              </do_elseif>
              <do_elseif value="$skillLevel == 4">
                <!-- 7.5s ± 1.25s randomization (6.25-8.75s range) -->
                <set_value name="$penaltyDelay" min="6.25s" max="8.75s"/>
              </do_elseif>

              <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Randomized skill-based delay: ' + $penaltyDelay + 's (Skill Level: ' + $skillLevel + ')'" chance="100"/>
              </do_if>

              <do_if value="$penaltyDelay gt 0s">
                <!-- Pass ship and delay in a table parameter -->
                <signal_cue_instantly cue="FindBestTrade_Delayed" param="table[$Ship = $ship, $Delay = $penaltyDelay, $ShipID = $ship.idcode]"/>
              </do_if>
              <do_else>
                <!-- Pass ship directly as parameter -->
                <signal_cue_instantly cue="FindBestTrade" param="$ship"/>
              </do_else>
            </do_if>
            <do_else>
              <!-- DEBUG: Ship not operational -->
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Ship ' + $ship.knownname + ' is not operational (exists: ' + $ship.exists + ', operational: ' + $ship.isoperational + ')'" chance="100"/>
              </do_if>
            </do_else>
            
            <set_value name="$processed" exact="$processed + 1"/>
          </do_while>
          
          <set_value name="global.$GT_TradingQueue.$Processing" exact="false"/>
          
          <!-- Continue processing if more ships in queue WITH DELAY to prevent stuttering -->
          <do_if value="global.$GT_TradingQueue.$Ships.count gt 0">
            <!-- DEBUG: More ships to process -->
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] ' + global.$GT_TradingQueue.$Ships.count + ' ships remaining in queue, continuing after random 0.3-0.7s delay'" chance="100"/>
            </do_if>
            
            <!-- Add 0.5s delay between processing ships to prevent stuttering -->
            <signal_cue_instantly cue="DelayedQueueProcessing"/>
          </do_if>
          <do_else>
            <!-- DEBUG: Queue empty -->
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] Trading queue is now empty'" chance="100"/>
            </do_if>
          </do_else>
        </do_if>
        <do_else>
          <!-- DEBUG: Queue already processing or empty -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] Queue already processing or empty (Processing: ' + global.$GT_TradingQueue.$Processing + ', Size: ' + global.$GT_TradingQueue.$Ships.count + ')'" chance="100"/>
          </do_if>
        </do_else>
      </actions>
    </cue>
    
    <!-- Delayed queue processing to prevent stuttering -->
    <cue name="DelayedQueueProcessing" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <!-- Random 0.3-0.7s delay to spread load -->
      <delay min="0.3s" max="0.7s"/>
      <actions>
        <signal_cue_instantly cue="ProcessTradingQueue"/>
      </actions>
    </cue>
    
    <!-- Skill-based pre-search delay wrapper -->
    <cue name="FindBestTrade_Delayed" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <!-- Use this.$ to ensure instance-level variable scope -->
        <set_value name="$data" exact="event.param"/>
        <set_value name="this.$ship" exact="$data.$Ship"/>
        <set_value name="this.$delayTime" exact="$data.$Delay"/>
        <set_value name="this.$shipID" exact="$data.$ShipID"/>
        
        <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + this.$shipID + ') Applying pre-search delay: ' + this.$delayTime + ' [instance: ' + this + ']'" chance="100"/>
        </do_if>
      </actions>
      <delay exact="this.$delayTime"/>
      <actions>
        <!-- FIX: Check if AI parameters still exist after delay expires -->
        <!-- Race condition: Live search may have completed during delay and cleaned up parameters -->
        <do_if value="not (global.$GT_AIParameters? and global.$GT_AIParameters.{this.$ship}?)">
          <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + this.$shipID + ') Stale delayed cue: AI parameters missing (search already completed) - canceling [instance: ' + this + ']'" chance="100"/>
          </do_if>
          
          <!-- Signal AI script that no new trade is available -->
          <do_if value="this.$ship.exists">
            <signal_objects object="this.$ship" param="'GT_No_Trade_Found'"/>
          </do_if>
          
          <!-- Cancel this stale delayed cue instance -->
          <cancel_cue cue="this"/>
        </do_if>
        
        <!-- Check if ship is currently busy with orders -->
        <set_value name="$isBusy" exact="false"/>
        
        <!-- Check 1: Has trade orders in queue -->
        <do_if value="this.$ship.tradeorders? and this.$ship.tradeorders.count gt 0">
          <set_value name="$isBusy" exact="true"/>
          <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + this.$shipID + ') Ship busy: has ' + this.$ship.tradeorders.count + ' trade orders'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Check 2: Has training order OR pilot needs advancement (XPBlocked) -->
        <do_if value="not $isBusy and this.$ship.order? and this.$ship.order.id == 'DockAndTrain'">
          <set_value name="$isBusy" exact="true"/>
          <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + this.$shipID + ') Ship busy: in training'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Check if pilot needs advancement (XPBlocked) - ship should go to training, not search for trades -->
        <!-- When pilot has XPBlocked set (ADVANCE status), they need to complete advancement exam before trading -->
        <do_if value="not $isBusy and this.$ship.pilot?">
          <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.$ship.pilot}? and global.$GT_Pilots.{this.$ship.pilot}.$XPBlocked?">
            <set_value name="$isBusy" exact="true"/>
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + this.$shipID + ') Ship busy: pilot needs advancement (XPBlocked, ADVANCE status) - should go to training'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
        
        <do_if value="this.$ship.exists and this.$ship.isoperational and not $isBusy">
          <!-- Pass ship directly as parameter -->
          <signal_cue_instantly cue="FindBestTrade" param="this.$ship"/>
        </do_if>
        <do_elseif value="$isBusy">
          <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + this.$shipID + ') Skipping delayed search; ship already has active trade [instance: ' + this + ']'" chance="100"/>
          </do_if>
          
          <!-- CRITICAL FIX: Signal AI script that no new trade is available (ship is busy) -->
          <signal_objects object="this.$ship" param="'GT_No_Trade_Found'"/>
          
          <!-- Release lock and parameters using Request Registry -->
          <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Release">
            <param name="ship" value="this.$ship"/>
            <param name="reason" value="'skipped_delayed_search_active_trade'"/>
          </run_actions>
        </do_elseif>
        <do_else>
          <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + this.$shipID + ') Skipping trade search after delay; ship no longer operational'" chance="100"/>
          </do_if>
          
          <!-- Signal AI script if ship still exists (even if not operational) -->
          <do_if value="this.$ship.exists">
            <signal_objects object="this.$ship" param="'GT_No_Trade_Found'"/>
          </do_if>
          
          <!-- Release lock and parameters using Request Registry -->
          <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Release">
            <param name="ship" value="this.$ship"/>
            <param name="reason" value="'ship_not_operational'"/>
          </run_actions>
        </do_else>
      </actions>
    </cue>
    
    <!-- Find Best Trade for Ship (Main Entry Point) -->
    <cue name="FindBestTrade" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <!-- Receive ship as parameter -->
        <set_value name="$ship" exact="event.param"/>
        
        <!-- CRITICAL: Check AI parameters IMMEDIATELY (before any other processing) -->
        <!-- Race condition: Parameters may be cleaned up between ProcessTradingQueue check and here -->
        <!-- This matches the guard in FindBestTrade_Delayed (lines 171-185) for zero-delay pilots -->
        <!-- Wrap ALL processing in do_if - only execute when parameters exist -->
        <do_if value="global.$GT_AIParameters? and global.$GT_AIParameters.{$ship}?">
          <!-- Parameters exist - proceed with all processing -->
          
          <!-- Validate ship -->
        <run_actions ref="md.GT_Libraries_General.GT_ValidateShip" result="$shipValid">
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <!-- Clean up immediately if ship validation fails (before checking busy status) -->
        <!-- Without this cleanup, ships that lose pilot/destroyed while search pending get permanently stuck -->
        <do_if value="not $shipValid">
          <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Invalid ship for trading (validation failed) - cleaning up locks and params'" chance="100"/>
          </do_if>
          
          <!-- Release lock and parameters using Request Registry -->
          <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Release">
            <param name="ship" value="$ship"/>
            <param name="reason" value="'ship_validation_failed'"/>
          </run_actions>
          
          <!-- Signal AI to restart (clear any waiting state) -->
          <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
          
          <!-- Exit immediately - don't process invalid ships -->
          <cancel_cue cue="this"/>
        </do_if>
        
        <!-- Check if ship is currently busy with orders -->
        <set_value name="$isBusy" exact="false"/>
        
        <!-- Check 1: Has trade orders in queue -->
        <do_if value="$ship.tradeorders? and $ship.tradeorders.count gt 0">
          <set_value name="$isBusy" exact="true"/>
          <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Ship busy: has ' + $ship.tradeorders.count + ' trade orders'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Check 2: Has training order OR pilot needs advancement (XPBlocked) -->
        <do_if value="not $isBusy and $ship.order? and $ship.order.id == 'DockAndTrain'">
          <set_value name="$isBusy" exact="true"/>
          <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Ship busy: in training'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Check if pilot needs advancement (XPBlocked) - ship should go to training, not search for trades -->
        <!-- When pilot has XPBlocked set (ADVANCE status), they need to complete advancement exam before trading -->
        <do_if value="not $isBusy and $ship.pilot?">
          <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{$ship.pilot}? and global.$GT_Pilots.{$ship.pilot}.$XPBlocked?">
            <set_value name="$isBusy" exact="true"/>
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Ship busy: pilot needs advancement (XPBlocked, ADVANCE status) - should go to training'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Check 3: Maintenance orders (Repair, Resupply, Equipment Installation, DockAndWait) -->
        <do_if value="not $isBusy and $ship.order?">
          <set_value name="$orderId" exact="$ship.order.id"/>
          <do_if value="$orderId == 'Repair' or $orderId == 'Resupply' or $orderId == 'order.build.equip' or $orderId == 'DockAndWait'">
            <set_value name="$isBusy" exact="true"/>
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Ship busy: ' + $orderId + ' order active'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
        
        <do_if value="$shipValid and not $isBusy">
          <!-- Get configuration values with safe defaults -->
          <!-- FORCE MinROI to 0% (ignore saved config) -->
          <set_value name="$minROI" exact="0"/> <!-- Accept any profit (0% ROI minimum) as integer -->
          
          <!-- Get pilot level-based profit threshold -->
          <!-- Level 1: 0 Cr, Level 2: 100 Cr, Level 3: 500 Cr, Level 4+: Config value with skill multiplier -->
          <!-- Threshold is scaled by ship cargo capacity (smaller ships = lower thresholds) -->
          <run_actions ref="md.GT_Ship_Management.Calculate_Skill_Level" result="$skillInfo">
            <param name="ship" value="$ship"/>
          </run_actions>
          <set_value name="$skillLevel" exact="if @$skillInfo.$Level != null then @$skillInfo.$Level else 1"/>
          
          <!-- Get ship cargo capacity for threshold scaling -->
          <set_value name="$shipCargoCapacity" exact="$ship.cargo.capacity.all"/>
          
          <!-- Get config base profit for level 4+ -->
          <set_value name="$configBaseProfit" exact="10000"/> <!-- Default: 100 Cr -->
          <do_if value="global.$GT_Config? and global.$GT_Config.$Trading? and global.$GT_Config.$Trading.$MinAbsoluteProfit?">
            <set_value name="$configBaseProfit" exact="@global.$GT_Config.$Trading.$MinAbsoluteProfit"/>
          </do_if>
          
          <!-- Get pilot level-based profit threshold (scaled by cargo capacity) -->
          <run_actions ref="md.GT_Libraries_General.GT_GetPilotLevelProfitThreshold" result="$minAbsoluteProfit">
            <param name="skillLevel" value="$skillLevel"/>
            <param name="shipCargoCapacity" value="$shipCargoCapacity"/>
            <param name="configBaseProfit" value="$configBaseProfit"/>
          </run_actions>
          
          <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$thresholdSource" exact="'Level ' + $skillLevel + ' based'"/>
            <do_if value="$skillLevel == 1">
              <set_value name="$thresholdSource" exact="'Level 1 (0 Cr - accepts 0 profit)'"/>
            </do_if>
            <do_elseif value="$skillLevel == 2">
              <set_value name="$thresholdSource" exact="'Level 2 (100 Cr minimum)'"/>
            </do_elseif>
            <do_elseif value="$skillLevel == 3">
              <set_value name="$thresholdSource" exact="'Level 3 (500 Cr minimum)'"/>
            </do_elseif>
            <do_else>
              <set_value name="$thresholdSource" exact="'Level ' + $skillLevel + ' (config base ' + ($configBaseProfit / 100) + ' Cr with skill multiplier)'"/>
            </do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Profit threshold calculated: ' + ($minAbsoluteProfit / 100) + ' Cr - ' + $thresholdSource" chance="100"/>
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Search parameters: MinROI=' + $minROI + '%, MinAbsoluteProfit=' + ($minAbsoluteProfit / 100) + ' Cr (Level ' + $skillLevel + ' based)'" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- Use AI script parameters - REQUIRED, no fallbacks -->
          <!-- MaxBuy/MaxSell are REQUIRED parameters - signal must always include them -->
          <!-- No fallbacks - fail loudly if missing to prevent hiding issues -->
          <set_value name="$allowIllegal" exact="false"/> <!-- Default: illegal trades not allowed -->
          <do_if value="global.$GT_AIParameters? and global.$GT_AIParameters.{$ship}?">
            <set_value name="$aiParams" exact="global.$GT_AIParameters.{$ship}"/>
            
            <!-- Extract MaxBuy and MaxSell - these MUST exist (validated when signal received) -->
            <set_value name="$maxBuy" exact="@$aiParams.$MaxBuy"/>
            <set_value name="$maxSell" exact="@$aiParams.$MaxSell"/>
            
            <!-- Fail loudly if MaxBuy/MaxSell are missing (should never happen if signal validation works) -->
            <set_value name="$maxBuyValid" exact="false"/>
            <set_value name="$maxSellValid" exact="false"/>
            <do_if value="$maxBuy? and $maxBuy ge 0">
              <set_value name="$maxBuyValid" exact="true"/>
            </do_if>
            <do_if value="$maxSell? and $maxSell ge 0">
              <set_value name="$maxSellValid" exact="true"/>
            </do_if>
            
            <do_if value="not $maxBuyValid or not $maxSellValid">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-TradingQueue]  ERROR: AI parameters missing required MaxBuy/MaxSell for ship ' + $ship.idcode + ' (MaxBuy: ' + $maxBuy + ', MaxSell: ' + $maxSell + ') - this should never happen if signal validation works!'" chance="100"/>
              </do_if>
              <!-- Cancel - cannot proceed without valid distance parameters -->
              <cancel_cue cue="this"/>
            </do_if>
            
            <!-- Use the maximum of MaxBuy and MaxSell -->
            <!-- Validate maxDistance is never null (fail loudly, no fallback) -->
            <set_value name="$maxDistance" exact="[$maxBuy, $maxSell].max"/>
            <do_if value="not $maxDistance? or $maxDistance lt 0">
              <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-TradingQueue] ERROR: (' + $ship.idcode + ') Calculated maxDistance is null or invalid (' + $maxDistance + ') from MaxBuy=' + $maxBuy + ', MaxSell=' + $maxSell + ' - cannot proceed!'" chance="100"/>
              </do_if>
              <cancel_cue cue="this"/>
            </do_if>
            
            <!-- Get AllowIllegal setting from AI parameters -->
            <do_if value="$aiParams.$AllowIllegal?">
              <set_value name="$allowIllegal" exact="$aiParams.$AllowIllegal"/>
            </do_if>
            
            <!-- DEBUG: Using AI script parameters -->
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Using AI script distance limits: MaxBuy=' + $maxBuy + ', MaxSell=' + $maxSell + ', using max=' + $maxDistance + ' jumps'" chance="100"/>
            </do_if>
            
            <!-- Clean up old parameters (older than 5 minutes) -->
            <!-- CRITICAL: Never delete AI parameters while a SearchLock exists for this ship.
                 The lock-stale detector relies on AIParameters.$RequestTime; deleting params under lock can permanently strand the ship in "search already in progress". -->
            <set_value name="$paramsRequestTime" exact="@$aiParams.$RequestTime"/>
            <do_if value="$paramsRequestTime? and (player.age - $paramsRequestTime) gt 300s">
              <do_if value="not global.$GT_SearchLocks? or not global.$GT_SearchLocks.{$ship}?">
                <remove_value name="global.$GT_AIParameters.{$ship}"/>
                <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Cleaned up old AI parameters (age: ' + ((player.age - $paramsRequestTime) / 1s) + 's)'" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
          </do_if>
          <do_else>
            <!-- AI parameters missing - this should never happen if signal validation works -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-TradingQueue]  ERROR: AI parameters missing for ship ' + $ship.idcode + ' - this should never happen if signal validation works!'" chance="100"/>
            </do_if>
            <!-- Cancel - cannot proceed without AI parameters -->
            <cancel_cue cue="this"/>
          </do_else>
          
          <do_if value="global.$GT_Config? and global.$GT_Config.$Trading? and global.$GT_Config.$Trading.$FactionPriority?">
            <set_value name="$factionPriority" exact="@global.$GT_Config.$Trading.$FactionPriority"/>
          </do_if>
          <do_else>
            <set_value name="$factionPriority" exact="'player'"/> <!-- Default to player faction -->
          </do_else>
          
          <!-- PERFORMANCE: Queue for trade search (SearchTradeRoutes handles cache + live in one place) -->
          <!-- NEW: Check if ForceLiveSearch flag is set (from AI rejecting all cached trades) -->
          <!-- FIX: Clear flag from global BEFORE reading to prevent persistence across cycles -->
          <set_value name="$forceLiveSearch" exact="false"/>
          <do_if value="global.$GT_AIParameters? and global.$GT_AIParameters.{$ship}? and global.$GT_AIParameters.{$ship}.$ForceLiveSearch?">
            <set_value name="$forceLiveSearch" exact="global.$GT_AIParameters.{$ship}.$ForceLiveSearch"/>
            <!-- Clear immediately after reading to prevent it from persisting in next cycle -->
            <remove_value name="global.$GT_AIParameters.{$ship}.$ForceLiveSearch"/>
          </do_if>
          
          <set_value name="$searchParams" exact="table[
            $Ship = $ship,
            $MaxDistance = $maxDistance,
            $MinROI = $minROI,
            $MinAbsoluteProfit = $minAbsoluteProfit,
            $FactionPriority = $factionPriority,
            $AllowIllegal = $allowIllegal,
            $ForceLiveSearch = $forceLiveSearch
          ]"/>

          <!-- Start trade search via centralized scheduler.
               We do NOT use the legacy global.$GT_SearchQueue gate here: it can pin at max and cause "no trades generated".
               The scheduler already spreads starts across frames, and SearchTradeRoutes handles cache/live internally. -->
          <signal_cue_instantly cue="md.GT_Trading_Queue.EnqueueSearchTradeRoutes" param="$searchParams"/>
        </do_if>
        <do_else>
          <!-- Ship is busy (orders/training/maintenance) - release lock and let AI retry later -->
          <do_if value="$isBusy">
            <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
            <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Release">
              <param name="ship" value="$ship"/>
              <param name="reason" value="'ship_busy'"/>
            </run_actions>
          </do_if>
          <do_else>
            <!-- Fallback: if we got here, do not hold the lock indefinitely -->
            <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
            <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Release">
              <param name="ship" value="$ship"/>
              <param name="reason" value="'findbesttrade_skipped'"/>
            </run_actions>
          </do_else>
        </do_else>
        
        <!-- Close outer AI-parameter guard -->
        </do_if>
        <do_else>
          <!-- AI parameters missing - cleanup and exit immediately -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-TradingQueue] (' + $ship.idcode + ') AI parameters missing at FindBestTrade entry - cannot compute search params'" chance="100"/>
          </do_if>
          <do_if value="$ship.exists">
            <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
          </do_if>
          <do_if value="global.$GT_SearchLocks? and global.$GT_SearchLocks.{$ship}?">
            <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Release">
              <param name="ship" value="$ship"/>
              <param name="reason" value="'parameters_missing_at_findbesttrade'"/>
            </run_actions>
          </do_if>
          <cancel_cue cue="this"/>
        </do_else>
      </actions>
    </cue>
    
    <!-- PERFORMANCE FIX: Check Trade Cache (fast, no queue needed) -->
    <cue name="CheckTradeCache" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$params" exact="event.param"/>
        <set_value name="$ship" exact="$params.$Ship"/>
        
        <!-- FIX: Extract parameters -->
        <set_value name="$maxDistance" exact="@$params.$MaxDistance"/>
        <set_value name="$minROI" exact="@$params.$MinROI"/>
        <set_value name="$minAbsoluteProfit" exact="@$params.$MinAbsoluteProfit"/>
        <set_value name="$factionPriority" exact="@$params.$FactionPriority"/>
        <set_value name="$allowIllegal" exact="@$params.$AllowIllegal"/>
        <set_value name="$forceLiveSearch" exact="@$params.$ForceLiveSearch"/>
        
        <!-- FIX: Check if ForceLiveSearch is set - if so, skip cache and queue for live search -->
        <do_if value="$forceLiveSearch">
          <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') ForceLiveSearch set skipping cache, queuing for live search'" chance="100"/>
          </do_if>
          
          <!-- Queue for live search -->
          <do_if value="not global.$GT_SearchQueue?">
            <set_value name="global.$GT_SearchQueue" exact="table[]"/>
          </do_if>
          <do_if value="not global.$GT_SearchQueue.$Ships?">
            <set_value name="global.$GT_SearchQueue.$Ships" exact="[]"/>
          </do_if>
          <do_if value="not global.$GT_SearchQueue.$ActiveSearches?">
            <set_value name="global.$GT_SearchQueue.$ActiveSearches" exact="0"/>
          </do_if>
          <do_if value="not global.$GT_SearchQueue.$MaxConcurrent?">
            <!-- Cache searches are cheap: use separate cache concurrency setting (fallback to legacy MaxConcurrentSearches) -->
            <set_value name="$maxConcurrent" exact="5"/>
            <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$MaxConcurrentCacheSearches?">
              <set_value name="$maxConcurrent" exact="@global.$GT_GlobalSettings.$Performance.$MaxConcurrentCacheSearches"/>
            </do_if>
            <do_elseif value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$MaxConcurrentSearches?">
              <set_value name="$maxConcurrent" exact="@global.$GT_GlobalSettings.$Performance.$MaxConcurrentSearches"/>
            </do_elseif>
            <do_if value="$maxConcurrent lt 1">
              <set_value name="$maxConcurrent" exact="1"/>
            </do_if>
            <do_if value="$maxConcurrent gt 20">
              <set_value name="$maxConcurrent" exact="20"/>
            </do_if>
            <set_value name="global.$GT_SearchQueue.$MaxConcurrent" exact="$maxConcurrent"/>
          </do_if>
          <do_if value="not global.$GT_SearchQueue.$Params?">
            <set_value name="global.$GT_SearchQueue.$Params" exact="table[]"/>
          </do_if>
          <set_value name="global.$GT_SearchQueue.$Params.{$ship}" exact="$params"/>

          <!-- PERF: O(1) queue membership marker (avoid list scans + redundant signals under big fleets) -->
          <do_if value="not global.$GT_SearchQueue.$QueuedShips?">
            <set_value name="global.$GT_SearchQueue.$QueuedShips" exact="table[]"/>
          </do_if>
          <do_if value="not global.$GT_SearchQueue.$QueuedShips.{$ship}?">
            <set_value name="global.$GT_SearchQueue.$QueuedShips.{$ship}" exact="true"/>
            <append_to_list name="global.$GT_SearchQueue.$Ships" exact="$ship"/>
          </do_if>

          <!-- Avoid thundering herd: only signal queue processor if it's not already processing -->
          <do_if value="not global.$GT_SearchQueue.$Processing?">
            <set_value name="global.$GT_SearchQueue.$Processing" exact="false"/>
          </do_if>
          <do_if value="not global.$GT_SearchQueue.$Processing">
            <signal_cue_instantly cue="ProcessSearchQueue"/>
          </do_if>
        </do_if>
        <do_else>
          <!-- FIX #2: Use synchronous GT_TS_CachePickBest instead of async SearchCachedTrades -->
          <!-- This matches the modern cache search path used by SearchTradeRoutes -->
          <!-- SearchCachedTrades is async with delays, but CheckTradeCache reads results synchronously - this was a bug! -->
          <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Checking trade cache synchronously...'" chance="100"/>
          </do_if>
          
          <!-- Calculate derived parameters needed for cache search -->
          <run_actions ref="md.GT_Libraries_General.GT_GetDistancePenaltyMultiplier" result="$distancePenaltyMultiplier">
            <param name="ship" value="$ship"/>
          </run_actions>
          
          <run_actions ref="md.GT_Ship_Management.Calculate_Skill_Level" result="$skillInfo">
            <param name="ship" value="$ship"/>
          </run_actions>
          <set_value name="$skillLevel" exact="if @$skillInfo.$Level != null then @$skillInfo.$Level else 1"/>
          
          <!-- Apply ROI multiplier (same as SearchTradeRoutes) -->
          <run_actions ref="md.GT_Libraries_General.GT_GetSkillMultiplier" result="$roiMultiplier">
            <param name="skillLevel" value="$skillLevel"/>
          </run_actions>
          <set_value name="$minROI" exact="$minROI * $roiMultiplier"/>
          
          <!-- Get home sector for cache lookup -->
          <run_actions ref="md.GT_Libraries_General.GT_GetHomeSector" result="$homeSector">
            <param name="ship" value="$ship"/>
          </run_actions>
          
          <!-- Get ship-specific cache filters -->
          <set_value name="$ignoreBuildStorage" exact="false"/>
          <do_if value="global.$GT_AIParameters? and global.$GT_AIParameters.{$ship}? and global.$GT_AIParameters.{$ship}.$IgnoreBuildStorage?">
            <set_value name="$ignoreBuildStorage" exact="global.$GT_AIParameters.{$ship}.$IgnoreBuildStorage"/>
          </do_if>
          <set_value name="$ignoreCarrierAux" exact="false"/>
          <do_if value="global.$GT_AIParameters? and global.$GT_AIParameters.{$ship}? and global.$GT_AIParameters.{$ship}.$IgnoreCarrierAux?">
            <set_value name="$ignoreCarrierAux" exact="global.$GT_AIParameters.{$ship}.$IgnoreCarrierAux"/>
          </do_if>
          
          <!-- Call synchronous cache search (same as SearchTradeRoutes) -->
          <run_actions ref="md.GT_Libraries_General.GT_TS_CachePickBest" result="$cachePick">
            <param name="ship" value="$ship"/>
            <param name="homeSector" value="$homeSector"/>
            <param name="maxDistance" value="$maxDistance"/>
            <param name="minROI" value="$minROI"/>
            <param name="minAbsoluteProfit" value="$minAbsoluteProfit"/>
            <param name="ignoreBuildStorage" value="$ignoreBuildStorage"/>
            <param name="ignoreCarrierAux" value="$ignoreCarrierAux"/>
          </run_actions>
          
          <!-- Extract cache results directly from library function (synchronous) -->
          <set_value name="$foundCachedTrade" exact="false"/>
          <set_value name="$cacheTradeList" exact="[]"/>
          <set_value name="$cacheBestTrade" exact="null"/>
          <do_if value="$cachePick? and $cachePick.$Found">
            <set_value name="$foundCachedTrade" exact="true"/>
            <set_value name="$cacheBestTrade" exact="$cachePick.$Trade"/>
            <!-- Prefer candidate list if available, otherwise use single trade -->
            <do_if value="$cachePick.$Trades? and $cachePick.$Trades != null and $cachePick.$Trades.count gt 0">
              <set_value name="$cacheTradeList" exact="$cachePick.$Trades"/>
            </do_if>
            <do_else>
              <do_if value="$cacheBestTrade != null">
                <set_value name="$cacheTradeList" exact="[$cacheBestTrade]"/>
              </do_if>
            </do_else>
          </do_if>
          
          <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch">
            <set_value name="$cacheTradeCount" exact="if @$cacheTradeList.count != null then @$cacheTradeList.count else 0"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Cache check result: Found=' + $foundCachedTrade + ', Trades=' + $cacheTradeCount" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- If cache hit, send directly to execution pipeline (bypass queue) -->
          <do_if value="$foundCachedTrade and ((if $cacheTradeList != null then $cacheTradeList.count else 0) gt 0)">
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') CACHE HIT: ' + (if $cacheTradeList != null then $cacheTradeList.count else 0) + ' trades found - sending to execution pipeline'" chance="100"/>
            </do_if>
            
            <!-- Send directly to execution pipeline (same as SearchTradeRoutes does) -->
            <!-- Use cacheBestTrade if available, otherwise extract first from list -->
            <set_value name="$firstTrade" exact="$cacheBestTrade"/>
            <do_if value="$firstTrade == null and (if $cacheTradeList != null then $cacheTradeList.count else 0) gt 0">
              <set_value name="$firstTrade" exact="$cacheTradeList.{1}"/>
            </do_if>
            
            <!-- CRITICAL FIX: Extract $AllowIllegal BEFORE cleanup (needed for ExecuteTrade) -->
            <!-- ExecuteTrade reads this from global.$GT_AIParameters, but cleanup deletes it before ExecuteTrade runs -->
            <set_value name="$allowIllegal" exact="false"/>
            <do_if value="global.$GT_AIParameters.{$ship}? and global.$GT_AIParameters.{$ship}.$AllowIllegal?">
              <set_value name="$allowIllegal" exact="global.$GT_AIParameters.{$ship}.$AllowIllegal"/>
            </do_if>
            
            <signal_cue_instantly cue="md.GT_Trading_Execution.ExecuteTrade" param="table[
              $Ship = $ship,
              $Trade = $firstTrade,
              $TradeList = $cacheTradeList,
              $SearchMethod = 'cache',
              $AllowIllegal = $allowIllegal
            ]"/>
            
            <!-- Release lock and parameters using Request Registry -->
            <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Release">
              <param name="ship" value="$ship"/>
              <param name="reason" value="'cache_hit_complete'"/>
            </run_actions>
          </do_if>
          <do_else>
            <!-- Cache miss - queue for live search -->
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') CACHE MISS: Queuing for live search'" chance="100"/>
            </do_if>
            
            <!-- Queue for live search -->
            <do_if value="not global.$GT_SearchQueue?">
              <set_value name="global.$GT_SearchQueue" exact="table[]"/>
            </do_if>
            <do_if value="not global.$GT_SearchQueue.$Ships?">
              <set_value name="global.$GT_SearchQueue.$Ships" exact="[]"/>
            </do_if>
            <do_if value="not global.$GT_SearchQueue.$ActiveSearches?">
              <set_value name="global.$GT_SearchQueue.$ActiveSearches" exact="0"/>
            </do_if>
            <do_if value="not global.$GT_SearchQueue.$MaxConcurrent?">
              <!-- Cache searches are cheap: use separate cache concurrency setting (fallback to legacy MaxConcurrentSearches) -->
              <set_value name="$maxConcurrent" exact="5"/>
              <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$MaxConcurrentCacheSearches?">
                <set_value name="$maxConcurrent" exact="@global.$GT_GlobalSettings.$Performance.$MaxConcurrentCacheSearches"/>
              </do_if>
              <do_elseif value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$MaxConcurrentSearches?">
                <set_value name="$maxConcurrent" exact="@global.$GT_GlobalSettings.$Performance.$MaxConcurrentSearches"/>
              </do_elseif>
              <do_if value="$maxConcurrent lt 1">
                <set_value name="$maxConcurrent" exact="1"/>
              </do_if>
              <do_if value="$maxConcurrent gt 20">
                <set_value name="$maxConcurrent" exact="20"/>
              </do_if>
              <set_value name="global.$GT_SearchQueue.$MaxConcurrent" exact="$maxConcurrent"/>
            </do_if>
            <do_if value="not global.$GT_SearchQueue.$Params?">
              <set_value name="global.$GT_SearchQueue.$Params" exact="table[]"/>
            </do_if>
            <set_value name="global.$GT_SearchQueue.$Params.{$ship}" exact="$params"/>

            <!-- PERF: O(1) queue membership marker to avoid list scans under big fleets -->
            <do_if value="not global.$GT_SearchQueue.$QueuedShips?">
              <set_value name="global.$GT_SearchQueue.$QueuedShips" exact="table[]"/>
            </do_if>
            <do_if value="not global.$GT_SearchQueue.$QueuedShips.{$ship}?">
              <set_value name="global.$GT_SearchQueue.$QueuedShips.{$ship}" exact="true"/>
              <append_to_list name="global.$GT_SearchQueue.$Ships" exact="$ship"/>
              <signal_cue_instantly cue="ProcessSearchQueue"/>
            </do_if>
          </do_else>
        </do_else>
      </actions>
    </cue>
    
    <!-- PERFORMANCE FIX: Process Search Queue - Use ActiveSearches as atomic lock -->
    <cue name="ProcessSearchQueue" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <!-- CPU YIELDING + JITTER: Spread trade search starts across frames when many ships enqueue at once -->
      <!-- Prevents “200 ships search” from turning into synchronized bursts -->
      <delay min="5ms" max="20ms"/>
      <actions>
        <!-- CRITICAL FIX: Ensure global.$GT_SearchQueue exists and initialize required properties -->
        <do_if value="not global.$GT_SearchQueue?">
          <set_value name="global.$GT_SearchQueue" exact="table[]"/>
        </do_if>

        <!-- CRITICAL: Ensure this queue processor is single-threaded.
             Without this, hundreds of ProcessSearchQueue instances can run in the same frame (thundering herd),
             popping many ships and/or signalling busy repeatedly → spikes/stutter. -->
        <do_if value="not global.$GT_SearchQueue.$Processing?">
          <set_value name="global.$GT_SearchQueue.$Processing" exact="false"/>
        </do_if>
        <do_if value="global.$GT_SearchQueue.$Processing">
          <cancel_cue cue="this"/>
        </do_if>
        <set_value name="global.$GT_SearchQueue.$Processing" exact="true"/>
        
        <do_if value="not global.$GT_SearchQueue.$Ships?">
          <set_value name="global.$GT_SearchQueue.$Ships" exact="[]"/>
        </do_if>
        
        <do_if value="not global.$GT_SearchQueue.$ActiveSearches?">
          <set_value name="global.$GT_SearchQueue.$ActiveSearches" exact="0"/>
        </do_if>
        <!-- Fix corrupted state from older versions (negative counter breaks concurrency gating) -->
        <do_if value="global.$GT_SearchQueue.$ActiveSearches lt 0">
          <set_value name="global.$GT_SearchQueue.$ActiveSearches" exact="0"/>
        </do_if>
        
        <do_if value="not global.$GT_SearchQueue.$MaxConcurrent?">
          <set_value name="global.$GT_SearchQueue.$MaxConcurrent" exact="1"/>
        </do_if>

        <!-- Update cache-search concurrency from global settings (allows runtime changes) -->
        <set_value name="$desiredMaxConcurrentCache" exact="global.$GT_SearchQueue.$MaxConcurrent"/>
        <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$MaxConcurrentCacheSearches?">
          <set_value name="$desiredMaxConcurrentCache" exact="@global.$GT_GlobalSettings.$Performance.$MaxConcurrentCacheSearches"/>
        </do_if>
        <do_elseif value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$MaxConcurrentSearches?">
          <set_value name="$desiredMaxConcurrentCache" exact="@global.$GT_GlobalSettings.$Performance.$MaxConcurrentSearches"/>
        </do_elseif>
        <do_if value="$desiredMaxConcurrentCache lt 1">
          <set_value name="$desiredMaxConcurrentCache" exact="1"/>
        </do_if>
        <do_if value="$desiredMaxConcurrentCache gt 20">
          <set_value name="$desiredMaxConcurrentCache" exact="20"/>
        </do_if>
        <do_if value="global.$GT_SearchQueue.$MaxConcurrent != $desiredMaxConcurrentCache">
          <set_value name="global.$GT_SearchQueue.$MaxConcurrent" exact="$desiredMaxConcurrentCache"/>
        </do_if>
        
        <do_if value="not global.$GT_SearchQueue.$Params?">
          <set_value name="global.$GT_SearchQueue.$Params" exact="table[]"/>
        </do_if>

        <!-- PERF: O(1) queue membership marker to avoid list scans under big fleets -->
        <do_if value="not global.$GT_SearchQueue.$QueuedShips?">
          <set_value name="global.$GT_SearchQueue.$QueuedShips" exact="table[]"/>
        </do_if>

        <!-- Smooth gameplay first: hard start budgeting across frames -->
        <!-- Note: player.age arithmetic with ms units is vanilla-supported (see x4Original aiscripts usage). -->
        <do_if value="not global.$GT_SearchQueue.$NextStartTime?">
          <set_value name="global.$GT_SearchQueue.$NextStartTime" exact="0"/>
        </do_if>
        <!-- TODO: Keep hardcoded for now. Consider exposing as a performance setting later (frame budget tuning). -->
        <set_value name="$startInterval" exact="30ms"/>
        <do_if value="player.age lt global.$GT_SearchQueue.$NextStartTime">
          <!-- Too soon since last start; reschedule -->
          <signal_cue_instantly cue="md.GT_Trading_Queue.ProcessSearchQueue"/>
          <set_value name="global.$GT_SearchQueue.$Processing" exact="false"/>
          <cancel_cue cue="this"/>
        </do_if>

        <!-- Backpressure: if batch processor backlog is high, don't start more searches this frame -->
        <set_value name="$batchBacklog" exact="0"/>
        <do_if value="global.$GT_BatchProcessorQueue? and global.$GT_BatchProcessorQueue.$Ships?">
          <set_value name="$batchBacklog" exact="global.$GT_BatchProcessorQueue.$Ships.count"/>
        </do_if>
        <!-- TODO: Keep hardcoded for now. Consider exposing as a performance setting later (backpressure threshold). -->
        <set_value name="$batchBacklogHard" exact="25"/>
        <do_if value="$batchBacklog ge $batchBacklogHard and global.$GT_SearchQueue.$Ships.count gt 0">
          <!-- Pop one ship and tell it to retry shortly (AI uses fixed 10s for busy) -->
          <set_value name="$ship" exact="global.$GT_SearchQueue.$Ships.{1}"/>
          <remove_from_list name="global.$GT_SearchQueue.$Ships" exact="$ship"/>
          <do_if value="global.$GT_SearchQueue.$QueuedShips.{$ship}?">
            <remove_value name="global.$GT_SearchQueue.$QueuedShips.{$ship}"/>
          </do_if>
          <!-- Remove stored params for this request; ship will re-request -->
          <do_if value="global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}?">
            <remove_value name="global.$GT_SearchQueue.$Params.{$ship}"/>
          </do_if>
          <!-- Release request registry lock so ship can retry cleanly -->
          <do_if value="$ship? and $ship.exists">
            <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Release">
              <param name="ship" value="$ship"/>
              <param name="reason" value="'busy_batch'"/>
            </run_actions>
            <signal_objects object="$ship" param="'GT_No_Trade_Found'" param2="'busy_batch'"/>
          </do_if>
          <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-TradingQueue] (' + $ship.idcode + ') Backpressure: batch backlog high (' + $batchBacklog + ') - signalling busy_batch retry'" chance="100"/>
          </do_if>
          <!-- If there are still ships queued, keep the queue moving (budgeting will throttle starts) -->
          <do_if value="global.$GT_SearchQueue.$Ships.count gt 0">
            <signal_cue_instantly cue="md.GT_Trading_Queue.ProcessSearchQueue"/>
          </do_if>
          <set_value name="global.$GT_SearchQueue.$Processing" exact="false"/>
          <cancel_cue cue="this"/>
        </do_if>
        
        <!-- ATOMIC LOCK: Process if below max concurrent searches (prevents race conditions) -->
        <do_if value="global.$GT_SearchQueue.$ActiveSearches lt global.$GT_SearchQueue.$MaxConcurrent and global.$GT_SearchQueue.$Ships.count gt 0">
          
          <!-- Get first ship from queue -->
          <set_value name="$ship" exact="global.$GT_SearchQueue.$Ships.{1}"/>
          <remove_from_list name="global.$GT_SearchQueue.$Ships" exact="$ship"/>
          <do_if value="global.$GT_SearchQueue.$QueuedShips.{$ship}?">
            <remove_value name="global.$GT_SearchQueue.$QueuedShips.{$ship}"/>
          </do_if>
          
          <!-- CRITICAL FIX: Get stored parameters for this ship, validate they exist -->
          <set_value name="$params" exact="@global.$GT_SearchQueue.$Params.{$ship}"/>
          
          <!-- CRITICAL FIX: Skip if params don't exist (shouldn't happen, but handle gracefully) -->
          <do_if value="$params?">
            <!-- Increment active search counter (atomic lock) -->
            <run_actions ref="md.GT_Libraries_General.GT_IncrementActiveSearches">
              <param name="initializeIfMissing" value="true"/>
            </run_actions>
            <!-- Frame budget: record next allowed start time -->
            <set_value name="global.$GT_SearchQueue.$NextStartTime" exact="player.age + $startInterval"/>
            
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') SEARCH STARTING (active: ' + global.$GT_SearchQueue.$ActiveSearches + '/' + global.$GT_SearchQueue.$MaxConcurrent + ', queued: ' + global.$GT_SearchQueue.$Ships.count + ')'" chance="100"/>
            </do_if>
            
            <!-- Start the actual search (delegate to search module) -->
            <!-- Set SearchState='fresh' only if caller didn't provide one (continuations must preserve state) -->
            <do_if value="not $params.$SearchState?">
              <set_value name="$params.$SearchState" exact="'fresh'"/>
            </do_if>
            <!-- Mark that this invocation uses the cache-search queue counter -->
            <set_value name="$params.$UseSearchQueueCounter" exact="true"/>
            <set_value name="$params.$FromSearchQueue" exact="true"/>
            <!-- V2: Never start SearchTradeRoutes directly from ProcessSearchQueue.
                 Route through EnqueueSearchTradeRoutes which feeds the hard-budget scheduler (prevents stampedes). -->
            <signal_cue_instantly cue="md.GT_Trading_Queue.EnqueueSearchTradeRoutes" param="$params"/>
          </do_if>
          <do_else>
            <!-- Params missing - log error and skip this ship -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-TradingQueue]  ERROR: Missing search parameters for ' + $ship.idcode + ' - skipping search'" chance="100"/>
            </do_if>
          </do_else>
        </do_if>
        <do_else>
          <!-- Cache-search slots are busy: do NOT leave ships waiting for 180s AI timeout. -->
          <!-- Instead, immediately tell the ship "busy" so it can retry shortly (AI uses 10s). -->
          <do_if value="global.$GT_SearchQueue.$Ships.count gt 0 and global.$GT_SearchQueue.$ActiveSearches ge global.$GT_SearchQueue.$MaxConcurrent">
            <set_value name="$ship" exact="global.$GT_SearchQueue.$Ships.{1}"/>
            <remove_from_list name="global.$GT_SearchQueue.$Ships" exact="$ship"/>
            <do_if value="global.$GT_SearchQueue.$QueuedShips.{$ship}?">
              <remove_value name="global.$GT_SearchQueue.$QueuedShips.{$ship}"/>
            </do_if>
            <!-- Remove stored params for this request; ship will re-request -->
            <do_if value="global.$GT_SearchQueue.$Params? and global.$GT_SearchQueue.$Params.{$ship}?">
              <remove_value name="global.$GT_SearchQueue.$Params.{$ship}"/>
            </do_if>
            <do_if value="$ship? and $ship.exists">
              <!-- IMPORTANT: release request registry lock/params so ship can retry -->
              <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Release">
                <param name="ship" value="$ship"/>
                <param name="reason" value="'busy'"/>
              </run_actions>
              <signal_objects object="$ship" param="'GT_No_Trade_Found'" param2="'busy'"/>
            </do_if>
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-TradingQueue] (' + $ship.idcode + ') Cache-search slots busy (' + global.$GT_SearchQueue.$ActiveSearches + '/' + global.$GT_SearchQueue.$MaxConcurrent + ') - signalling busy retry'" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging and global.$GT_SearchQueue.$ActiveSearches gt 0 and global.$GT_SearchQueue.$Ships.count gt 0">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] Search in progress, skipping (active: ' + global.$GT_SearchQueue.$ActiveSearches + ', queued: ' + global.$GT_SearchQueue.$Ships.count + ')'" chance="100"/>
            </do_if>
          </do_else>
        </do_else>

        <!-- Release single-thread lock and keep draining the queue (one action per invocation; jitter spreads load). -->
        <set_value name="global.$GT_SearchQueue.$Processing" exact="false"/>
        <do_if value="global.$GT_SearchQueue.$Ships.count gt 0">
          <signal_cue_instantly cue="md.GT_Trading_Queue.ProcessSearchQueue"/>
        </do_if>
      </actions>
    </cue>

    <!-- Live Search Concurrency Gate (separate from cache concurrency) -->
    <cue name="ProcessLiveSearchQueue" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <!-- Small jitter to avoid thundering herd when multiple ships enqueue for live search -->
      <delay min="5ms" max="20ms"/>
      <actions>
        <!-- Initialize live search queue structure -->
        <do_if value="not global.$GT_LiveSearchQueue?">
          <set_value name="global.$GT_LiveSearchQueue" exact="table[]"/>
        </do_if>
        <!-- Single-thread this queue processor to avoid double start/finish sound bursts and racey selection. -->
        <do_if value="not global.$GT_LiveSearchQueue.$Processing?">
          <set_value name="global.$GT_LiveSearchQueue.$Processing" exact="false"/>
        </do_if>
        <do_if value="global.$GT_LiveSearchQueue.$Processing">
          <cancel_cue cue="this"/>
        </do_if>
        <set_value name="global.$GT_LiveSearchQueue.$Processing" exact="true"/>
        <set_value name="$kickAgain" exact="false"/>

        <do_if value="not global.$GT_LiveSearchQueue.$Params?">
          <set_value name="global.$GT_LiveSearchQueue.$Params" exact="table[]"/>
        </do_if>
        <!-- Per-home-sector fairness queue (round-robin across home sectors) -->
        <do_if value="not global.$GT_LiveSearchQueue.$BySector?">
          <set_value name="global.$GT_LiveSearchQueue.$BySector" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_LiveSearchQueue.$Sectors?">
          <set_value name="global.$GT_LiveSearchQueue.$Sectors" exact="[]"/>
        </do_if>
        <do_if value="not global.$GT_LiveSearchQueue.$NextSectorIndex?">
          <set_value name="global.$GT_LiveSearchQueue.$NextSectorIndex" exact="1"/>
        </do_if>
        <do_if value="not global.$GT_LiveSearchQueue.$ActiveLiveSearches?">
          <set_value name="global.$GT_LiveSearchQueue.$ActiveLiveSearches" exact="0"/>
        </do_if>
        <do_if value="global.$GT_LiveSearchQueue.$ActiveLiveSearches lt 0">
          <set_value name="global.$GT_LiveSearchQueue.$ActiveLiveSearches" exact="0"/>
        </do_if>

        <!-- Update MaxConcurrentLive from settings (fallback to legacy MaxConcurrentSearches) -->
        <set_value name="$maxConcurrentLive" exact="1"/>
        <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$MaxConcurrentLiveSearches?">
          <set_value name="$maxConcurrentLive" exact="@global.$GT_GlobalSettings.$Performance.$MaxConcurrentLiveSearches"/>
        </do_if>
        <do_elseif value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$MaxConcurrentSearches?">
          <set_value name="$maxConcurrentLive" exact="@global.$GT_GlobalSettings.$Performance.$MaxConcurrentSearches"/>
        </do_elseif>
        <do_if value="$maxConcurrentLive lt 1">
          <set_value name="$maxConcurrentLive" exact="1"/>
        </do_if>
        <do_if value="$maxConcurrentLive gt 10">
          <set_value name="$maxConcurrentLive" exact="10"/>
        </do_if>
        <set_value name="global.$GT_LiveSearchQueue.$MaxConcurrent" exact="$maxConcurrentLive"/>

        <!-- Start ONE live search if we have capacity -->
        <!-- Fair scheduler: select next HOME SECTOR with queued ships (round-robin) -->
        <set_value name="$selectedShip" exact="null"/>
        <set_value name="$selectedSector" exact="null"/>
        <set_value name="$sectorCount" exact="global.$GT_LiveSearchQueue.$Sectors.count"/>
        <do_if value="global.$GT_LiveSearchQueue.$ActiveLiveSearches lt global.$GT_LiveSearchQueue.$MaxConcurrent and $sectorCount gt 0">
          <set_value name="$attempts" exact="$sectorCount"/>
          <do_all exact="$attempts" counter="$try">
            <!-- Wrap index -->
            <do_if value="global.$GT_LiveSearchQueue.$NextSectorIndex gt global.$GT_LiveSearchQueue.$Sectors.count">
              <set_value name="global.$GT_LiveSearchQueue.$NextSectorIndex" exact="1"/>
            </do_if>
            <set_value name="$sector" exact="global.$GT_LiveSearchQueue.$Sectors.{global.$GT_LiveSearchQueue.$NextSectorIndex}"/>
            <set_value name="global.$GT_LiveSearchQueue.$NextSectorIndex" operation="add"/>
            <do_if value="$sector? and global.$GT_LiveSearchQueue.$BySector.{$sector}? and global.$GT_LiveSearchQueue.$BySector.{$sector}.$Ships.count gt 0">
              <set_value name="$selectedSector" exact="$sector"/>
              <set_value name="$selectedShip" exact="global.$GT_LiveSearchQueue.$BySector.{$sector}.$Ships.{1}"/>
              <remove_from_list name="global.$GT_LiveSearchQueue.$BySector.{$sector}.$Ships" exact="$selectedShip"/>
              <break/>
            </do_if>
          </do_all>
        </do_if>

        <do_if value="$selectedShip != null">
          <set_value name="$ship" exact="$selectedShip"/>
          <set_value name="$params" exact="@global.$GT_LiveSearchQueue.$Params.{$ship}"/>

          <do_if value="$ship? and $ship.exists and $params?">
            <!-- Acquire live slot -->
            <run_actions ref="md.GT_Libraries_General.GT_IncrementActiveLiveSearches">
              <param name="initializeIfMissing" value="true"/>
            </run_actions>

            <!-- Live-search sounds removed (keep live search silent) -->

            <!-- Ensure we skip cache and do live search immediately -->
            <set_value name="$params.$ForceLiveSearch" exact="true"/>
            <set_value name="$params.$SearchState" exact="'fresh'"/>
            <set_value name="$params.$FromLiveQueue" exact="true"/>
            <set_value name="$params.$LiveSlotAcquired" exact="true"/>
            <set_value name="$params.$UseSearchQueueCounter" exact="false"/>
            <!-- Persist updated params so SearchLiveTrades_Resume can recover them reliably -->
            <set_value name="global.$GT_LiveSearchQueue.$Params.{$ship}" exact="$params"/>

            <!-- Start the search now; live concurrency is handled by ProcessLiveSearchQueue. -->
            <signal_cue_instantly cue="md.GT_Trading_Queue.EnqueueSearchTradeRoutes" param="$params"/>
          </do_if>
          <do_else>
            <!-- Invalid ship/params - clean up entry -->
            <do_if value="global.$GT_LiveSearchQueue.$Params.{$ship}?">
              <remove_value name="global.$GT_LiveSearchQueue.$Params.{$ship}"/>
            </do_if>
          </do_else>

          <!-- If we still have capacity and ANY sector has queued ships, continue immediately -->
          <set_value name="$hasAnyQueued" exact="false"/>
          <do_all exact="global.$GT_LiveSearchQueue.$Sectors.count" counter="$i">
            <set_value name="$sec" exact="global.$GT_LiveSearchQueue.$Sectors.{$i}"/>
            <do_if value="global.$GT_LiveSearchQueue.$BySector.{$sec}? and global.$GT_LiveSearchQueue.$BySector.{$sec}.$Ships.count gt 0">
              <set_value name="$hasAnyQueued" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          <do_if value="global.$GT_LiveSearchQueue.$ActiveLiveSearches lt global.$GT_LiveSearchQueue.$MaxConcurrent and $hasAnyQueued">
            <set_value name="$kickAgain" exact="true"/>
          </do_if>
        </do_if>

        <!-- If we did not select a ship, we might still need to finish the session sound (idle) or retry selection (stale sectors list). -->
        <set_value name="$hasAnyQueuedNow" exact="false"/>
        <do_if value="global.$GT_LiveSearchQueue.$Sectors?">
          <do_all exact="global.$GT_LiveSearchQueue.$Sectors.count" counter="$i">
            <set_value name="$sec" exact="global.$GT_LiveSearchQueue.$Sectors.{$i}"/>
            <do_if value="$sec? and global.$GT_LiveSearchQueue.$BySector? and global.$GT_LiveSearchQueue.$BySector.{$sec}? and global.$GT_LiveSearchQueue.$BySector.{$sec}.$Ships.count gt 0">
              <set_value name="$hasAnyQueuedNow" exact="true"/>
              <break/>
            </do_if>
          </do_all>
        </do_if>

        <!-- Live-search sounds removed (keep live search silent) -->

        <!-- If we can still start more live searches, schedule another pass. -->
        <do_if value="not $kickAgain and global.$GT_LiveSearchQueue.$ActiveLiveSearches lt global.$GT_LiveSearchQueue.$MaxConcurrent and $hasAnyQueuedNow">
          <set_value name="$kickAgain" exact="true"/>
        </do_if>

        <set_value name="global.$GT_LiveSearchQueue.$Processing" exact="false"/>
        <do_if value="$kickAgain">
          <signal_cue_instantly cue="md.GT_Trading_Queue.ProcessLiveSearchQueue"/>
        </do_if>
      </actions>
    </cue>

    <!-- LiveSearchFinishSound_Delayed removed (live search should remain silent). -->

    <!-- Centralized scheduling gate for SearchTradeRoutes.
         Use this instead of signalling SearchTradeRoutes directly from cache/live continuation cues.
         This prevents large same-frame bursts (hundreds of concurrent instances) and keeps CPU stable. -->
    <cue name="EnqueueSearchTradeRoutes" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <!-- Small jitter so large fleets don't wake in the same frame (reduces bursts). -->
      <delay min="0ms" max="30ms"/>
      <actions>
        <set_value name="$params" exact="event.param"/>
        <set_value name="$ship" exact="@$params.$Ship"/>

        <do_if value="not $ship? or not $ship.exists">
          <cancel_cue cue="this"/>
        </do_if>

        <!-- Persist params so SearchTradeRoutes can recover/validate against per-ship storage if needed -->
        <do_if value="not global.$GT_SearchQueue?">
          <set_value name="global.$GT_SearchQueue" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_SearchQueue.$Params?">
          <set_value name="global.$GT_SearchQueue.$Params" exact="table[]"/>
        </do_if>
        <set_value name="global.$GT_SearchQueue.$Params.{$ship}" exact="$params"/>

        <!-- V2: Start searches through the hard-budget scheduler (one start per tick). -->
        <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.Enqueue" param="$params"/>
      </actions>
    </cue>
  </cues>
</mdscript>
