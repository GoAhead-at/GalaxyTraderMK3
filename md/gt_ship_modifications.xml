<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Ship_Modifications" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - SHIP MODIFICATIONS
         Automatic modification installation/removal system
         ======================================== -->
    
    <!-- Reusable Library: Install GT Modifications for Ship -->
    <library name="Install_GT_Modifications" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to install modifications on"/>
        <param name="pilot" comment="Pilot (optional, will be retrieved from ship if not provided)"/>
      </params>
      <actions>
        <!-- CHECK: Is modification feature enabled? -->
        <set_value name="$modificationsEnabled" exact="true"/>
        <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Modifications? and global.$GT_GlobalSettings.$Modifications.$Enabled?">
          <set_value name="$modificationsEnabled" exact="global.$GT_GlobalSettings.$Modifications.$Enabled"/>
        </do_if>
        
        <!-- Exit early if modifications are disabled -->
        <do_if value="not $modificationsEnabled">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Mods] Modifications feature disabled in global settings - skipping installation for ' + $ship.idcode" chance="100"/>
          </do_if>
        </do_if>
        <do_else>
          <!-- Get pilot if not provided -->
          <do_if value="not $pilot?">
            <set_value name="$pilot" exact="@$ship.pilot"/>
          </do_if>
          
          <!-- PRIORITY: Install penalty mods first (penalty overrides bonus) -->
          <run_actions ref="Install_Penalty_Modifications">
            <param name="ship" value="$ship"/>
            <param name="pilot" value="$pilot"/>
          </run_actions>
          
          <!-- Check if penalty mod was installed - if so, skip bonus mods -->
          <set_value name="$hasPenaltyMod" exact="false"/>
          <do_if value="global.$GT_Ships.{$ship}? and global.$GT_Ships.{$ship}.$GTModifications? and (global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod? or global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod?)">
            <set_value name="$hasPenaltyMod" exact="true"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Penalty mod installed on ' + $ship.idcode + ' - skipping bonus mod installation (penalty takes priority)'" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- Only install bonus mods if no penalty mod is installed -->
          <do_if value="not $hasPenaltyMod">
            <!-- Get pilot level -->
            <set_value name="$pilotLevel" exact="0"/>
            <do_if value="$pilot? and global.$GT_Pilots? and global.$GT_Pilots.{$pilot}?">
              <set_value name="$pilotLevel" exact="@global.$GT_Pilots.{$pilot}.$Level"/>
            </do_if>
          
          <!-- Calculate pilot-supported mod level based on pilot level -->
          <!-- Level 9 = Level 1 mod, Level 12 = Level 2 mod, Level 15 = Level 3 mod -->
          <set_value name="$pilotModLevel" exact="0"/>
          <do_if value="$pilotLevel ge 15">
            <set_value name="$pilotModLevel" exact="3"/>
          </do_if>
          <do_elseif value="$pilotLevel ge 12">
            <set_value name="$pilotModLevel" exact="2"/>
          </do_elseif>
          <do_elseif value="$pilotLevel ge 9">
            <set_value name="$pilotModLevel" exact="1"/>
          </do_elseif>
          
          <!-- CHECK RESEARCH REQUIREMENTS: Find highest researched level that pilot supports -->
          <!-- Start from pilot's max level and work down until we find researched level -->
          <!-- Both ship and engine mods must be researched for a level to be available -->
          <set_value name="$modLevel" exact="0"/>
          <do_if value="$pilotModLevel ge 3">
            <!-- Check if level 3 is researched -->
            <do_if value="ware.mod_ship_gt_level3.research.unlocked and ware.mod_engine_gt_level3.research.unlocked">
              <set_value name="$modLevel" exact="3"/>
            </do_if>
            <do_elseif value="$pilotModLevel ge 2">
              <!-- Check if level 2 is researched -->
              <do_if value="ware.mod_ship_gt_level2.research.unlocked and ware.mod_engine_gt_level2.research.unlocked">
                <set_value name="$modLevel" exact="2"/>
              </do_if>
              <do_elseif value="$pilotModLevel ge 1">
                <!-- Check if level 1 is researched -->
                <do_if value="ware.mod_ship_gt_level1.research.unlocked and ware.mod_engine_gt_level1.research.unlocked">
                  <set_value name="$modLevel" exact="1"/>
                </do_if>
              </do_elseif>
            </do_elseif>
          </do_if>
          <do_elseif value="$pilotModLevel ge 2">
            <!-- Check if level 2 is researched -->
            <do_if value="ware.mod_ship_gt_level2.research.unlocked and ware.mod_engine_gt_level2.research.unlocked">
              <set_value name="$modLevel" exact="2"/>
            </do_if>
            <do_elseif value="$pilotModLevel ge 1">
              <!-- Check if level 1 is researched -->
              <do_if value="ware.mod_ship_gt_level1.research.unlocked and ware.mod_engine_gt_level1.research.unlocked">
                <set_value name="$modLevel" exact="1"/>
              </do_if>
            </do_elseif>
          </do_elseif>
          <do_elseif value="$pilotModLevel ge 1">
            <!-- Check if level 1 is researched -->
            <do_if value="ware.mod_ship_gt_level1.research.unlocked and ware.mod_engine_gt_level1.research.unlocked">
              <set_value name="$modLevel" exact="1"/>
            </do_if>
          </do_elseif>
          
          <!-- Install mods if both pilot level qualifies AND research is completed -->
          <do_if value="$modLevel gt 0">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$researchInfo" exact="' (pilot supports level ' + $pilotModLevel + ', research allows level ' + $modLevel + ')'"/>
            <do_if value="$modLevel lt $pilotModLevel">
              <set_value name="$researchInfo" exact="' (pilot supports level ' + $pilotModLevel + ', but only level ' + $modLevel + ' researched)'"/>
            </do_if>
            <debug_text text="'[GT-Mods] Installing Level ' + $modLevel + ' modifications for pilot level ' + $pilotLevel + ' on ' + $ship.idcode + $researchInfo" chance="100"/>
          </do_if>
          
          <!-- Initialize mod tracking if needed -->
          <do_if value="not global.$GT_Ships.{$ship}?">
            <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
          </do_if>
          <do_if value="not global.$GT_Ships.{$ship}.$GTModifications?">
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications" exact="table[]"/>
          </do_if>
          <do_if value="not global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots?">
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="[]"/>
          </do_if>
          
          <!-- CHECK: Are mods already installed? (GT-installed or player-installed) -->
          <set_value name="$installedSlots" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots"/>
          <set_value name="$shipModAlreadyInstalled" exact="false"/>
          <set_value name="$engineModAlreadyInstalled" exact="false"/>
          
          <!-- Check if ship mod slot is already in installed list (GT-installed) -->
          <do_all exact="$installedSlots.count" counter="$i">
            <do_if value="$installedSlots.{$i} == 'ship'">
              <set_value name="$shipModAlreadyInstalled" exact="true"/>
            </do_if>
            <do_if value="$installedSlots.{$i} == 'engine'">
              <set_value name="$engineModAlreadyInstalled" exact="true"/>
            </do_if>
          </do_all>
          
          <!-- Determine mod ware IDs based on level -->
          <set_value name="$shipModWare" exact="null"/>
          <set_value name="$engineModWare" exact="null"/>
          
          <do_if value="$modLevel == 1">
            <set_value name="$shipModWare" exact="ware.mod_ship_gt_level1"/>
            <set_value name="$engineModWare" exact="ware.mod_engine_gt_level1"/>
          </do_if>
          <do_elseif value="$modLevel == 2">
            <set_value name="$shipModWare" exact="ware.mod_ship_gt_level2"/>
            <set_value name="$engineModWare" exact="ware.mod_engine_gt_level2"/>
          </do_elseif>
          <do_elseif value="$modLevel == 3">
            <set_value name="$shipModWare" exact="ware.mod_ship_gt_level3"/>
            <set_value name="$engineModWare" exact="ware.mod_engine_gt_level3"/>
          </do_elseif>
          
          <!-- Install ship mod only if not already installed -->
          <do_if value="$shipModWare? and not $shipModAlreadyInstalled">
            <add_equipment_mods object="$ship">
              <ship ware="$shipModWare"/>
            </add_equipment_mods>
            <append_to_list name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="'ship'"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Installed ship mod: ' + $shipModWare.name" chance="100"/>
            </do_if>
          </do_if>
          <do_elseif value="$shipModWare? and $shipModAlreadyInstalled">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Ship mod already installed on ' + $ship.idcode + ' - skipping installation'" chance="100"/>
            </do_if>
          </do_elseif>
          
          <!-- Install engine mod only if not already installed -->
          <do_if value="$engineModWare? and not $engineModAlreadyInstalled">
            <add_equipment_mods object="$ship">
              <engine ware="$engineModWare"/>
            </add_equipment_mods>
            <append_to_list name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="'engine'"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Installed engine mod: ' + $engineModWare.name" chance="100"/>
            </do_if>
          </do_if>
          <do_elseif value="$engineModWare? and $engineModAlreadyInstalled">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Engine mod already installed on ' + $ship.idcode + ' - skipping installation'" chance="100"/>
            </do_if>
          </do_elseif>
          
          <!-- Store mod level for reference (update even if mods were already installed) -->
          <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$InstalledLevel" exact="$modLevel"/>
          
          <!-- Only show success message if we actually installed something -->
          <do_if value="not $shipModAlreadyInstalled or not $engineModAlreadyInstalled">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Successfully installed Level ' + $modLevel + ' modifications on ' + $ship.idcode" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Level ' + $modLevel + ' modifications already installed on ' + $ship.idcode + ' - skipped'" chance="100"/>
            </do_if>
          </do_else>
        </do_if>
        <do_else>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <!-- Check why mods weren't installed -->
            <set_value name="$reason" exact="'Pilot level too low (need level 9+)'"/>
            <do_if value="$pilotModLevel gt 0">
              <set_value name="$reason" exact="'Research not completed'"/>
              <do_if value="$pilotModLevel ge 3">
                <do_if value="not (ware.mod_ship_gt_level3.research.unlocked and ware.mod_engine_gt_level3.research.unlocked)">
                  <set_value name="$reason" exact="'Level 3 mods not researched (pilot supports level ' + $pilotModLevel + ')'"/>
                </do_if>
              </do_if>
              <do_elseif value="$pilotModLevel ge 2">
                <do_if value="not (ware.mod_ship_gt_level2.research.unlocked and ware.mod_engine_gt_level2.research.unlocked)">
                  <set_value name="$reason" exact="'Level 2 mods not researched (pilot supports level ' + $pilotModLevel + ')'"/>
                </do_if>
              </do_elseif>
              <do_elseif value="$pilotModLevel ge 1">
                <do_if value="not (ware.mod_ship_gt_level1.research.unlocked and ware.mod_engine_gt_level1.research.unlocked)">
                  <set_value name="$reason" exact="'Level 1 mods not researched (pilot supports level ' + $pilotModLevel + ')'"/>
                </do_if>
              </do_elseif>
            </do_if>
            <debug_text text="'[GT-Mods] Cannot install modifications for pilot level ' + $pilotLevel + ' (pilot supports level ' + $pilotModLevel + '): ' + $reason" chance="100"/>
          </do_if>
        </do_else>
          </do_if>
          <!-- End: Only install bonus mods if no penalty mod -->
        </do_else>
      </actions>
    </library>
    
    <!-- Reusable Library: Install Penalty Modifications for Ship -->
    <library name="Install_Penalty_Modifications" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to install penalty modifications on"/>
        <param name="pilot" comment="Pilot (optional, will be retrieved from ship if not provided)"/>
      </params>
      <actions>
        <!-- CHECK: Is modification feature enabled? -->
        <set_value name="$modificationsEnabled" exact="true"/>
        <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Modifications? and global.$GT_GlobalSettings.$Modifications.$Enabled?">
          <set_value name="$modificationsEnabled" exact="global.$GT_GlobalSettings.$Modifications.$Enabled"/>
        </do_if>
        
        <!-- Exit early if modifications are disabled -->
        <do_if value="not $modificationsEnabled">
          <!-- Remove any existing penalty mods if feature is disabled -->
          <set_value name="$existingPenaltyShipMod" exact="null"/>
          <set_value name="$existingPenaltyEngineMod" exact="null"/>
          <do_if value="global.$GT_Ships.{$ship}? and global.$GT_Ships.{$ship}.$GTModifications?">
            <do_if value="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod?">
              <set_value name="$existingPenaltyShipMod" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod"/>
            </do_if>
            <do_if value="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod?">
              <set_value name="$existingPenaltyEngineMod" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod"/>
            </do_if>
          </do_if>
          <do_if value="$existingPenaltyShipMod? or $existingPenaltyEngineMod?">
            <set_value name="$shipIdCode" exact="@$ship.idcode"/>
            <do_if value="$existingPenaltyShipMod?">
              <raise_lua_event name="'GT_DismantleMod'" param="'ship|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|' + $existingPenaltyShipMod"/>
            </do_if>
            <do_if value="$existingPenaltyEngineMod?">
              <raise_lua_event name="'GT_DismantleMod'" param="'engine|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|' + $existingPenaltyEngineMod"/>
            </do_if>
            <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod"/>
            <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod"/>
            <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyLevel"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Penalty] Removed penalty mods from ' + $ship.idcode + ' (modifications feature disabled)'" chance="100"/>
            </do_if>
          </do_if>
          <return/>
        </do_if>
        
        <!-- Get pilot if not provided -->
        <do_if value="not $pilot?">
          <set_value name="$pilot" exact="@$ship.pilot"/>
        </do_if>
        
        <!-- Get pilot level -->
        <set_value name="$pilotLevel" exact="0"/>
        <do_if value="$pilot? and global.$GT_Pilots? and global.$GT_Pilots.{$pilot}?">
          <set_value name="$pilotLevel" exact="@global.$GT_Pilots.{$pilot}.$Level"/>
        </do_if>
        
        <!-- Determine ship size class -->
        <set_value name="$shipClass" exact="'unknown'"/>
        <do_if value="$ship.isclass.ship_xl">
          <set_value name="$shipClass" exact="'xl'"/>
        </do_if>
        <do_elseif value="$ship.isclass.ship_l">
          <set_value name="$shipClass" exact="'l'"/>
        </do_elseif>
        <do_elseif value="$ship.isclass.ship_m">
          <set_value name="$shipClass" exact="'m'"/>
        </do_elseif>
        <do_elseif value="$ship.isclass.ship_s">
          <set_value name="$shipClass" exact="'s'"/>
        </do_elseif>
        
        <!-- Calculate penalty level based on ship class and pilot level -->
        <!-- NOTE: Penalty mods do NOT require research (unlike bonus mods) -->
        <set_value name="$penaltyLevel" exact="0"/> <!-- 0 = no penalty, 1 = light, 2 = moderate, 3 = severe -->
        <set_value name="$penaltyShipModWare" exact="null"/>
        <set_value name="$penaltyEngineModWare" exact="null"/>
        
        <do_if value="$shipClass == 'xl'">
          <do_if value="$pilotLevel lt 4">
            <set_value name="$penaltyLevel" exact="3"/> <!-- Severe -->
            <set_value name="$penaltyShipModWare" exact="ware.mod_penalty_ship_severe"/>
            <set_value name="$penaltyEngineModWare" exact="ware.mod_penalty_engine_severe"/>
          </do_if>
          <do_elseif value="$pilotLevel lt 7">
            <set_value name="$penaltyLevel" exact="2"/> <!-- Moderate -->
            <set_value name="$penaltyShipModWare" exact="ware.mod_penalty_ship_moderate"/>
            <set_value name="$penaltyEngineModWare" exact="ware.mod_penalty_engine_moderate"/>
          </do_elseif>
          <do_elseif value="$pilotLevel lt 10">
            <set_value name="$penaltyLevel" exact="1"/> <!-- Light -->
            <set_value name="$penaltyShipModWare" exact="ware.mod_penalty_ship_light"/>
            <set_value name="$penaltyEngineModWare" exact="ware.mod_penalty_engine_light"/>
          </do_elseif>
        </do_if>
        <do_elseif value="$shipClass == 'l'">
          <do_if value="$pilotLevel lt 4">
            <set_value name="$penaltyLevel" exact="2"/> <!-- Moderate -->
            <set_value name="$penaltyShipModWare" exact="ware.mod_penalty_ship_moderate"/>
            <set_value name="$penaltyEngineModWare" exact="ware.mod_penalty_engine_moderate"/>
          </do_if>
          <do_elseif value="$pilotLevel lt 7">
            <set_value name="$penaltyLevel" exact="1"/> <!-- Light -->
            <set_value name="$penaltyShipModWare" exact="ware.mod_penalty_ship_light"/>
            <set_value name="$penaltyEngineModWare" exact="ware.mod_penalty_engine_light"/>
          </do_elseif>
        </do_elseif>
        <do_elseif value="$shipClass == 'm'">
          <do_if value="$pilotLevel lt 4">
            <set_value name="$penaltyLevel" exact="1"/> <!-- Light -->
            <set_value name="$penaltyShipModWare" exact="ware.mod_penalty_ship_light"/>
            <set_value name="$penaltyEngineModWare" exact="ware.mod_penalty_engine_light"/>
          </do_if>
        </do_elseif>
        <!-- S ships: always no penalty -->
        
        <!-- Initialize mod tracking if needed -->
        <do_if value="not global.$GT_Ships.{$ship}?">
          <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_Ships.{$ship}.$GTModifications?">
          <set_value name="global.$GT_Ships.{$ship}.$GTModifications" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots?">
          <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="[]"/>
        </do_if>
        
        <!-- MIGRATION: Handle old save games with single $GTPenaltyMod entry -->
        <!-- Old saves had: $GTPenaltyMod = ware.mod_penalty_severe/moderate/light -->
        <!-- New structure: $GTPenaltyShipMod and $GTPenaltyEngineMod with separate wares -->
        <!-- NOTE: Import errors may occur during save load - this migration cleans up invalid references -->
        <do_if value="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyMod? and 
                      not global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod? and 
                      not global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod?">
          <!-- Use safe operator to get old mod (may be invalid due to import failure) -->
          <set_value name="$oldPenaltyMod" exact="@global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyMod"/>
          <set_value name="$migratedShipMod" exact="null"/>
          <set_value name="$migratedEngineMod" exact="null"/>
          <set_value name="$oldModId" exact="null"/>
          
          <!-- Try to get old mod ID as string (ware might not exist due to import failure) -->
          <do_if value="$oldPenaltyMod?">
            <set_value name="$oldModId" exact="@$oldPenaltyMod.id"/>
            <do_if value="not $oldModId?">
              <!-- If .id doesn't work, try to get it as string directly (might be stored as string) -->
              <set_value name="$oldModId" exact="$oldPenaltyMod"/>
            </do_if>
          </do_if>
          
          <!-- Map old ware IDs to new separate ship/engine wares by comparing ID strings -->
          <do_if value="$oldModId? and $oldModId == 'mod_penalty_severe'">
            <set_value name="$migratedShipMod" exact="ware.mod_penalty_ship_severe"/>
            <set_value name="$migratedEngineMod" exact="ware.mod_penalty_engine_severe"/>
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyLevel" exact="3"/>
          </do_if>
          <do_elseif value="$oldModId? and $oldModId == 'mod_penalty_moderate'">
            <set_value name="$migratedShipMod" exact="ware.mod_penalty_ship_moderate"/>
            <set_value name="$migratedEngineMod" exact="ware.mod_penalty_engine_moderate"/>
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyLevel" exact="2"/>
          </do_elseif>
          <do_elseif value="$oldModId? and $oldModId == 'mod_penalty_light'">
            <set_value name="$migratedShipMod" exact="ware.mod_penalty_ship_light"/>
            <set_value name="$migratedEngineMod" exact="ware.mod_penalty_engine_light"/>
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyLevel" exact="1"/>
          </do_elseif>
          
          <!-- Store migrated values and remove old entry -->
          <do_if value="$migratedShipMod? and $migratedEngineMod?">
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod" exact="$migratedShipMod"/>
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod" exact="$migratedEngineMod"/>
            <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyMod"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <set_value name="$oldModName" exact="if $oldModId? then $oldModId else 'INVALID_IMPORT'"/>
              <set_value name="$shipModName" exact="@$migratedShipMod.name"/>
              <set_value name="$engineModName" exact="@$migratedEngineMod.name"/>
              <debug_text text="'[GT-Penalty] Migrated old penalty mod data for ' + $ship.idcode + ' (old: ' + $oldModName + ' ship: ' + (if $shipModName? then $shipModName else 'UNKNOWN') + ', engine: ' + (if $engineModName? then $engineModName else 'UNKNOWN') + ')'" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <!-- Old mod not recognized or import failed - remove invalid entry -->
            <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyMod"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <set_value name="$oldModName" exact="if $oldModId? then $oldModId else 'INVALID_IMPORT'"/>
              <debug_text text="'[GT-Penalty] Removed invalid/unrecognized old penalty mod data for ' + $ship.idcode + ' (old: ' + $oldModName + ' - likely import failure)'" chance="100"/>
            </do_if>
          </do_else>
        </do_if>
        
        <!-- Check if penalty mod is already installed -->
        <set_value name="$existingPenaltyShipMod" exact="null"/>
        <set_value name="$existingPenaltyEngineMod" exact="null"/>
        <do_if value="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod?">
          <set_value name="$existingPenaltyShipMod" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod"/>
        </do_if>
        <do_if value="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod?">
          <set_value name="$existingPenaltyEngineMod" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod"/>
        </do_if>
        
        <!-- Remove existing penalty mods if they're different from what we need, or if no penalty is needed -->
        <do_if value="($existingPenaltyShipMod? and $existingPenaltyShipMod != null and ($existingPenaltyShipMod != $penaltyShipModWare or not $penaltyShipModWare?)) or 
                      ($existingPenaltyEngineMod? and $existingPenaltyEngineMod != null and ($existingPenaltyEngineMod != $penaltyEngineModWare or not $penaltyEngineModWare?))">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$existingShipModName" exact="'none'"/>
            <set_value name="$existingEngineModName" exact="'none'"/>
            <do_if value="$existingPenaltyShipMod? and $existingPenaltyShipMod != null">
              <set_value name="$existingShipModName" exact="@$existingPenaltyShipMod.name"/>
            </do_if>
            <do_if value="$existingPenaltyEngineMod? and $existingPenaltyEngineMod != null">
              <set_value name="$existingEngineModName" exact="@$existingPenaltyEngineMod.name"/>
            </do_if>
            <debug_text text="'[GT-Penalty] Removing old penalty mods from ' + $ship.idcode + ' (ship: ' + (if $existingShipModName? then $existingShipModName else 'none') + ', engine: ' + (if $existingEngineModName? then $existingEngineModName else 'none') + ')'" chance="100"/>
          </do_if>
          <set_value name="$shipIdCode" exact="@$ship.idcode"/>
          <do_if value="$existingPenaltyShipMod? and $existingPenaltyShipMod != null">
            <raise_lua_event name="'GT_DismantleMod'" param="'ship|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|' + $existingPenaltyShipMod"/>
          </do_if>
          <do_if value="$existingPenaltyEngineMod? and $existingPenaltyEngineMod != null">
            <raise_lua_event name="'GT_DismantleMod'" param="'engine|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|' + $existingPenaltyEngineMod"/>
          </do_if>
          <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod"/>
          <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod"/>
          <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyLevel"/>
        </do_if>
        
        <!-- Install new penalty mods if needed and not already installed -->
        <do_if value="($penaltyShipModWare? and (not $existingPenaltyShipMod? or $existingPenaltyShipMod != $penaltyShipModWare)) or 
                      ($penaltyEngineModWare? and (not $existingPenaltyEngineMod? or $existingPenaltyEngineMod != $penaltyEngineModWare))">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$penaltyName" exact="'Severe'"/>
            <do_if value="$penaltyLevel == 2">
              <set_value name="$penaltyName" exact="'Moderate'"/>
            </do_if>
            <do_elseif value="$penaltyLevel == 1">
              <set_value name="$penaltyName" exact="'Light'"/>
            </do_elseif>
            <debug_text text="'[GT-Penalty] Installing ' + $penaltyName + ' penalty mods on ' + $ship.idcode + ' (Pilot Level: ' + $pilotLevel + ', Ship Size: ' + $shipClass + ')'" chance="100"/>
          </do_if>
          
          <!-- Install penalty mods in ship and engine slots (separate wares) -->
          <do_if value="$penaltyShipModWare?">
            <add_equipment_mods object="$ship">
              <ship ware="$penaltyShipModWare"/>
            </add_equipment_mods>
            <!-- Track in GTInstalledSlots to protect against removing player-installed mods -->
            <append_to_list name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="'ship'"/>
          </do_if>
          <do_if value="$penaltyEngineModWare?">
            <add_equipment_mods object="$ship">
              <engine ware="$penaltyEngineModWare"/>
            </add_equipment_mods>
            <!-- Track in GTInstalledSlots to protect against removing player-installed mods -->
            <append_to_list name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="'engine'"/>
          </do_if>
          
          <!-- Track penalty mod installation -->
          <do_if value="$penaltyShipModWare?">
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod" exact="$penaltyShipModWare"/>
          </do_if>
          <do_if value="$penaltyEngineModWare?">
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod" exact="$penaltyEngineModWare"/>
          </do_if>
          <do_if value="$penaltyLevel gt 0">
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyLevel" exact="$penaltyLevel"/>
          </do_if>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Penalty] Successfully installed penalty mods on ' + $ship.idcode + ' (ship: ' + (if $penaltyShipModWare != null then @$penaltyShipModWare.name else 'none') + ', engine: ' + (if $penaltyEngineModWare != null then @$penaltyEngineModWare.name else 'none') + ')'" chance="100"/>
          </do_if>
        </do_if>
        <do_elseif value="not $penaltyShipModWare? and not $penaltyEngineModWare? and ($existingPenaltyShipMod? or $existingPenaltyEngineMod?)">
          <!-- No penalty needed, but old one is present - already removed above -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Penalty] No penalty required for ' + $ship.idcode + ' (Pilot Level: ' + $pilotLevel + ', Ship Size: ' + $shipClass + ')'" chance="100"/>
          </do_if>
        </do_elseif>
      </actions>
    </library>
    
    <!-- Remove Penalty Modifications -->
    <library name="Remove_Penalty_Modifications" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to remove penalty modifications from"/>
      </params>
      <actions>
        <!-- SAFETY CHECK: Only remove mods that WE installed (check GTInstalledSlots) -->
        <!-- This prevents removing player-installed mods -->
        <set_value name="$installedSlots" exact="[]"/>
        <do_if value="global.$GT_Ships.{$ship}? 
                          and global.$GT_Ships.{$ship}.$GTModifications? 
                          and global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots?">
          <set_value name="$installedSlots" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots"/>
        </do_if>
        
        <set_value name="$hasShipSlot" exact="false"/>
        <set_value name="$hasEngineSlot" exact="false"/>
        
        <!-- Check which slots we installed -->
        <do_all exact="$installedSlots.count" counter="$i">
          <do_if value="$installedSlots.{$i} == 'ship'">
            <set_value name="$hasShipSlot" exact="true"/>
          </do_if>
          <do_if value="$installedSlots.{$i} == 'engine'">
            <set_value name="$hasEngineSlot" exact="true"/>
          </do_if>
        </do_all>
        
        <set_value name="$currentPenaltyShipMod" exact="null"/>
        <set_value name="$currentPenaltyEngineMod" exact="null"/>
        <do_if value="global.$GT_Ships.{$ship}? and global.$GT_Ships.{$ship}.$GTModifications?">
          <do_if value="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod?">
            <set_value name="$currentPenaltyShipMod" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod"/>
          </do_if>
          <do_if value="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod?">
            <set_value name="$currentPenaltyEngineMod" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod"/>
          </do_if>
        </do_if>

        <do_if value="($currentPenaltyShipMod? and $hasShipSlot) or ($currentPenaltyEngineMod? and $hasEngineSlot)">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$shipModName" exact="'none'"/>
            <set_value name="$engineModName" exact="'none'"/>
            <do_if value="$currentPenaltyShipMod?">
              <set_value name="$shipModName" exact="@$currentPenaltyShipMod.name"/>
            </do_if>
            <do_if value="$currentPenaltyEngineMod?">
              <set_value name="$engineModName" exact="@$currentPenaltyEngineMod.name"/>
            </do_if>
            <debug_text text="'[GT-Penalty] Removing penalty mods from ' + $ship.idcode + ' (ship: ' + (if $shipModName? then $shipModName else 'none') + ', engine: ' + (if $engineModName? then $engineModName else 'none') + ', explicit removal call)'" chance="100"/>
          </do_if>
          <set_value name="$shipIdCode" exact="@$ship.idcode"/>
          <do_if value="$currentPenaltyShipMod? and $hasShipSlot">
            <raise_lua_event name="'GT_DismantleMod'" param="'ship|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|' + $currentPenaltyShipMod"/>
          </do_if>
          <do_if value="$currentPenaltyEngineMod? and $hasEngineSlot">
            <raise_lua_event name="'GT_DismantleMod'" param="'engine|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|' + $currentPenaltyEngineMod"/>
          </do_if>
          <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod"/>
          <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod"/>
          <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyLevel"/>
        </do_if>
        <do_else>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <do_if value="$currentPenaltyShipMod? or $currentPenaltyEngineMod?">
              <debug_text text="'[GT-Penalty] Skipping penalty mod removal for ' + $ship.idcode + ' - not GT-installed (player mod may be present)'" chance="100"/>
            </do_if>
            <do_else>
              <debug_text text="'[GT-Penalty] No penalty mod found on ' + $ship.idcode + ' to remove (explicit removal call)'" chance="100"/>
            </do_else>
          </do_if>
        </do_else>
      </actions>
    </library>
    
    <!-- MIGRATION: Clean up old penalty mod data on game load -->
    <!-- Handles save games with old $GTPenaltyMod entries (ware.mod_penalty_severe/moderate/light) -->
    <!-- Converts to new structure ($GTPenaltyShipMod and $GTPenaltyEngineMod) -->
    <cue name="MigrateOldPenaltyModData" instantiate="true">
      <conditions>
        <check_any>
          <event_game_loaded/>
          <event_game_started/>
        </check_any>
      </conditions>
      <actions>
        <set_value name="$migrationCount" exact="0"/>
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
          <set_value name="$shipKeys" exact="@global.$GT_Ships.keys"/>
          <set_value name="$keysCount" exact="@$shipKeys.count"/>
          <do_if value="$keysCount? and $keysCount gt 0">
            <do_all exact="$keysCount" counter="$i">
              <set_value name="$ship" exact="$shipKeys.{$i}"/>
              <set_value name="$shipData" exact="@global.$GT_Ships.{$ship}"/>
              
              <!-- Check if ship has old penalty mod structure -->
              <do_if value="$shipData.$GTModifications? and 
                            $shipData.$GTModifications.$GTPenaltyMod? and 
                            (not $shipData.$GTModifications.$GTPenaltyShipMod? or not $shipData.$GTModifications.$GTPenaltyEngineMod?)">
                <!-- Use safe operator to get old mod (may be invalid due to import failure) -->
                <set_value name="$oldPenaltyMod" exact="@$shipData.$GTModifications.$GTPenaltyMod"/>
                <set_value name="$migratedShipMod" exact="null"/>
                <set_value name="$migratedEngineMod" exact="null"/>
                <set_value name="$oldModId" exact="null"/>
                
                <!-- Try to get old mod ID as string (ware might not exist due to import failure) -->
                <do_if value="$oldPenaltyMod?">
                  <set_value name="$oldModId" exact="@$oldPenaltyMod.id"/>
                  <do_if value="not $oldModId?">
                    <!-- If .id doesn't work, try to get it as string directly (might be stored as string) -->
                    <set_value name="$oldModId" exact="$oldPenaltyMod"/>
                  </do_if>
                </do_if>
                
                <!-- Map old ware IDs to new separate ship/engine wares by comparing ID strings -->
                <do_if value="$oldModId? and $oldModId == 'mod_penalty_severe'">
                  <set_value name="$migratedShipMod" exact="ware.mod_penalty_ship_severe"/>
                  <set_value name="$migratedEngineMod" exact="ware.mod_penalty_engine_severe"/>
                  <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyLevel" exact="3"/>
                </do_if>
                <do_elseif value="$oldModId? and $oldModId == 'mod_penalty_moderate'">
                  <set_value name="$migratedShipMod" exact="ware.mod_penalty_ship_moderate"/>
                  <set_value name="$migratedEngineMod" exact="ware.mod_penalty_engine_moderate"/>
                  <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyLevel" exact="2"/>
                </do_elseif>
                <do_elseif value="$oldModId? and $oldModId == 'mod_penalty_light'">
                  <set_value name="$migratedShipMod" exact="ware.mod_penalty_ship_light"/>
                  <set_value name="$migratedEngineMod" exact="ware.mod_penalty_engine_light"/>
                  <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyLevel" exact="1"/>
                </do_elseif>
                
                <!-- Store migrated values and remove old entry -->
                <do_if value="$migratedShipMod? and $migratedEngineMod?">
                  <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod" exact="$migratedShipMod"/>
                  <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod" exact="$migratedEngineMod"/>
                  <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyMod"/>
                  <set_value name="$migrationCount" operation="add"/>
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <set_value name="$oldModName" exact="if $oldModId? then $oldModId else 'INVALID_IMPORT'"/>
                    <set_value name="$shipModName" exact="@$migratedShipMod.name"/>
                    <set_value name="$engineModName" exact="@$migratedEngineMod.name"/>
                    <debug_text text="'[GT-Penalty] Migration: Migrated old penalty mod for ' + $ship.idcode + ' (old: ' + $oldModName + ' ship: ' + (if $shipModName? then $shipModName else 'UNKNOWN') + ', engine: ' + (if $engineModName? then $engineModName else 'UNKNOWN') + ')'" chance="100"/>
                  </do_if>
                </do_if>
                <do_else>
                  <!-- Old mod not recognized or import failed - remove invalid entry -->
                  <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyMod"/>
                  <set_value name="$migrationCount" operation="add"/>
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <set_value name="$oldModName" exact="if $oldModId? then $oldModId else 'INVALID_IMPORT'"/>
                    <debug_text text="'[GT-Penalty] Migration: Removed invalid/unrecognized old penalty mod for ' + $ship.idcode + ' (old: ' + $oldModName + ' - likely import failure)'" chance="100"/>
                  </do_if>
                </do_else>
              </do_if>
            </do_all>
          </do_if>
        </do_if>
        
        <do_if value="$migrationCount gt 0">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Penalty] Migration: Migrated ' + $migrationCount + ' old penalty mod entries to new structure'" chance="100"/>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Load Lua Module for Mod Removal -->
    <cue name="Load_ModRemoval_Lua" instantiate="true">
      <conditions>
        <event_ui_triggered screen="'Lua_Loader'" control="'Ready'" />
      </conditions>
      <actions>
        <raise_lua_event 
          name="'Lua_Loader.Load'" 
          param="'extensions.galaxytradermk3.lua.gt_mod_removal'"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Mods] Loading mod removal Lua module...'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Install Modifications When GT Order is Assigned -->
    <cue name="InstallModifications" instantiate="true">
      <conditions>
        <event_object_order_ready object="player.galaxy"/>
        <check_value value="event.object.isclass.ship"/>
        <check_value value="event.object.owner == faction.player"/>
        <check_value value="event.param.id == 'GalaxyTraderMK3'"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Mods] GT order assigned - installing modifications for ship: ' + $ship.idcode" chance="100"/>
        </do_if>
        
        <!-- Use reusable library function -->
        <run_actions ref="Install_GT_Modifications">
          <param name="ship" value="$ship"/>
        </run_actions>
      </actions>
    </cue>
    
    <!-- Also listen to state updates for GT_Order_Assigned and Commander_Changed (if sent) -->
    <cue name="InstallModificationsFromState" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Ship_State_Update'"/>
      </conditions>
      <actions>
        <set_value name="$params" exact="event.param2"/>
        <set_value name="$updateType" exact="$params.$UpdateType"/>
        
        <!-- Process GT_Order_Assigned events -->
        <do_if value="$updateType == 'GT_Order_Assigned'">
          <set_value name="$ship" exact="$params.$Ship"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Mods] Installing modifications for ship: ' + $ship.idcode + ' (from state update - GT order assigned)'" chance="100"/>
          </do_if>
          
          <!-- Use reusable library function -->
          <!-- Get pilot from ship (library will handle if null) -->
          <set_value name="$pilot" exact="@$ship.pilot"/>
          <run_actions ref="Install_GT_Modifications">
            <param name="ship" value="$ship"/>
            <param name="pilot" value="$pilot"/>
          </run_actions>
        </do_if>
        
        <!-- Process Commander_Changed events - install mods when ship becomes subordinate to GT commander -->
        <do_elseif value="$updateType == 'Commander_Changed'">
          <set_value name="$ship" exact="$params.$Ship"/>
          <set_value name="$commanderHasGT" exact="false"/>
          <do_if value="$params.$CommanderHasGT?">
            <set_value name="$commanderHasGT" exact="$params.$CommanderHasGT"/>
          </do_if>
          
          <!-- Only install mods if commander has GT order -->
          <do_if value="$commanderHasGT">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Installing modifications for subordinate: ' + $ship.idcode + ' (commander has GT order)'" chance="100"/>
            </do_if>
            
            <!-- Use reusable library function -->
            <!-- Get pilot from ship (library will handle if null) -->
            <set_value name="$pilot" exact="@$ship.pilot"/>
            <run_actions ref="Install_GT_Modifications">
              <param name="ship" value="$ship"/>
              <param name="pilot" value="$pilot"/>
            </run_actions>
          </do_if>
        </do_elseif>
        
        <!-- Legacy code below - only used if updateType doesn't match above -->
        <do_elseif value="false">
          <!-- This block never executes, kept for reference -->
          <set_value name="$ship" exact="$params.$Ship"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Mods] Installing modifications for ship: ' + $ship.idcode + ' (from state update)'" chance="100"/>
          </do_if>
          
          <!-- Get pilot level -->
          <set_value name="$pilot" exact="@$ship.pilot"/>
          <set_value name="$pilotLevel" exact="0"/>
          
          <do_if value="$pilot? and global.$GT_Pilots? and global.$GT_Pilots.{$pilot}?">
            <set_value name="$pilotLevel" exact="@global.$GT_Pilots.{$pilot}.$Level"/>
          </do_if>
          
          <!-- Calculate mod level based on pilot level -->
          <!-- Level 9 = Level 1 mod, Level 12 = Level 2 mod, Level 15 = Level 3 mod -->
          <set_value name="$modLevel" exact="0"/>
          
          <do_if value="$pilotLevel ge 15">
            <set_value name="$modLevel" exact="3"/>
          </do_if>
          <do_elseif value="$pilotLevel ge 12">
            <set_value name="$modLevel" exact="2"/>
          </do_elseif>
          <do_elseif value="$pilotLevel ge 9">
            <set_value name="$modLevel" exact="1"/>
          </do_elseif>
          
          <!-- Install mods if pilot level qualifies -->
          <do_if value="$modLevel gt 0">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Pilot level ' + $pilotLevel + ' qualifies for Level ' + $modLevel + ' modifications'" chance="100"/>
            </do_if>
            
            <!-- Initialize mod tracking if needed -->
            <do_if value="not global.$GT_Ships.{$ship}?">
              <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
            </do_if>
            <do_if value="not global.$GT_Ships.{$ship}.$GTModifications?">
              <set_value name="global.$GT_Ships.{$ship}.$GTModifications" exact="table[]"/>
            </do_if>
            <do_if value="not global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots?">
              <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="[]"/>
            </do_if>
            
            <!-- Determine mod ware IDs based on level -->
            <set_value name="$shipModWare" exact="null"/>
            <set_value name="$engineModWare" exact="null"/>
            
            <do_if value="$modLevel == 1">
              <set_value name="$shipModWare" exact="ware.mod_ship_gt_level1"/>
              <set_value name="$engineModWare" exact="ware.mod_engine_gt_level1"/>
            </do_if>
            <do_elseif value="$modLevel == 2">
              <set_value name="$shipModWare" exact="ware.mod_ship_gt_level2"/>
              <set_value name="$engineModWare" exact="ware.mod_engine_gt_level2"/>
            </do_elseif>
            <do_elseif value="$modLevel == 3">
              <set_value name="$shipModWare" exact="ware.mod_ship_gt_level3"/>
              <set_value name="$engineModWare" exact="ware.mod_engine_gt_level3"/>
            </do_elseif>
            
            <!-- Install ship mod -->
            <do_if value="$shipModWare?">
              <add_equipment_mods object="$ship">
                <ship ware="$shipModWare"/>
              </add_equipment_mods>
              <append_to_list name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="'ship'"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Installed ship mod: ' + $shipModWare.name" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- Install engine mod -->
            <do_if value="$engineModWare?">
              <add_equipment_mods object="$ship">
                <engine ware="$engineModWare"/>
              </add_equipment_mods>
              <append_to_list name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="'engine'"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Installed engine mod: ' + $engineModWare.name" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- Store mod level for reference -->
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$InstalledLevel" exact="$modLevel"/>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Successfully installed Level ' + $modLevel + ' modifications on ' + $ship.idcode" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Pilot level ' + $pilotLevel + ' does not qualify for modifications (need level 9+)'" chance="100"/>
            </do_if>
          </do_else>
        </do_elseif>
      </actions>
    </cue>
    
    <!-- Remove Modifications When GT Order is Cancelled -->
    <cue name="RemoveModifications" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Ship_State_Update'"/>
      </conditions>
      <actions>
        <set_value name="$params" exact="event.param2"/>
        <set_value name="$updateType" exact="@$params.$UpdateType"/>
        <set_value name="$ship" exact="$params.$Ship"/>
        
        <!-- PERFORMANCE FIX: Early exit check for non-GT ships -->
        <!-- Only process GT_Order_Cancelled events for ships that were GT-controlled -->
        <set_value name="$shouldProcess" exact="false"/>
        
        <!-- Only process GT_Order_Cancelled events -->
        <do_if value="$updateType == 'GT_Order_Cancelled'">
          <!-- PRIMARY CHECK: Is ship in GT_Ships registry? (definitive indicator it was GT-controlled) -->
          <do_if value="global.$GT_Ships? and global.$GT_Ships.{$ship}?">
            <set_value name="$shouldProcess" exact="true"/>
          </do_if>
          <do_else>
            <!-- Fallback: Check if ship currently has GT order (might be removing but still has order) -->
            <set_value name="$hasGTOrder" exact="false"/>
            <do_if value="$ship.defaultorder? and @$ship.defaultorder.id == 'GalaxyTraderMK3'">
              <set_value name="$hasGTOrder" exact="true"/>
            </do_if>
            <do_if value="not $hasGTOrder and $ship.commander? and $ship.commander.exists and $ship.commander != $ship">
              <do_if value="$ship.commander.defaultorder? and @$ship.commander.defaultorder.id == 'GalaxyTraderMK3'">
                <set_value name="$hasGTOrder" exact="true"/>
              </do_if>
            </do_if>
            <do_if value="$hasGTOrder">
              <set_value name="$shouldProcess" exact="true"/>
            </do_if>
          </do_else>
        </do_if>
        
        <!-- EARLY EXIT: If ship is not GT-controlled, exit immediately without logging -->
        <!-- Ship IS GT-controlled and update type is GT_Order_Cancelled - proceed -->
        <do_if value="$shouldProcess">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Mods] Received GT_Ship_State_Update signal, updateType: ' + (if $updateType then $updateType else 'NULL')" chance="100"/>
          </do_if>
          
          <!-- TRUST THE SIGNAL: GT_Order_Cancelled means the order was cancelled -->
          <!-- CRITICAL: During signal processing window, ship.commander may still point to old commander (race condition) -->
          <!-- Solution: Only check for direct GT order, trust the signal for commander removal -->
          <!-- Only suppress if ship has direct GT order (not via commander, since commander check is unreliable during race window) -->
          <set_value name="$hasDirectGTOrder" exact="false"/>
          <do_if value="$ship.defaultorder? and @$ship.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$hasDirectGTOrder" exact="true"/>
          </do_if>
          
          <!-- Only proceed if ship doesn't have direct GT order (trust signal for commander removal) -->
          <do_if value="not $hasDirectGTOrder">
            <!-- CRITICAL FIX: Release search locks and clear home refresh markers when GT order is cancelled -->
            <!-- This prevents ships from blocking others after losing their GT order -->
            <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Release">
              <param name="ship" value="$ship"/>
              <param name="reason" value="'gt_order_cancelled'"/>
            </run_actions>
            
            <!-- Clear home refresh marker if this ship was the initiator -->
            <do_if value="global.$GT_TS_LiveRefreshBySector? and global.$GT_TS_LiveRefreshBySector.keys.count gt 0">
              <do_all exact="global.$GT_TS_LiveRefreshBySector.keys.count" counter="$hsIdx">
                <set_value name="$hs" exact="global.$GT_TS_LiveRefreshBySector.keys.{$hsIdx}"/>
                <do_if value="$hs? and global.$GT_TS_LiveRefreshBySector.{$hs}?">
                  <set_value name="$refreshEntry" exact="global.$GT_TS_LiveRefreshBySector.{$hs}"/>
                  <do_if value="$refreshEntry? and $refreshEntry.$Initiator? and $refreshEntry.$Initiator == $ship">
                    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                      <debug_text text="'[GT-Mods] Clearing home refresh marker (home=' + @$hs.knownname + ', initiator=' + $ship.idcode + ' lost GT order)'" chance="100"/>
                    </do_if>
                    <remove_value name="global.$GT_TS_LiveRefreshBySector.{$hs}"/>
                  </do_if>
                </do_if>
              </do_all>
            </do_if>
            
            <!-- CRITICAL: Remove penalty mods first (before bonus mods) -->
            <!-- Penalty mods are always GT-installed and should be removed when GT order is revoked -->
            <run_actions ref="md.GT_Ship_Modifications.Remove_Penalty_Modifications">
              <param name="ship" value="$ship"/>
            </run_actions>
            
            <!-- FIX: Prevent duplicate removals - check if mods were already removed -->
            <!-- Use a timestamp to track when removal was last processed for this ship -->
            <set_value name="$lastRemovalTime" exact="0"/>
            <do_if value="global.$GT_Ships.{$ship}? 
                          and global.$GT_Ships.{$ship}.$GTModifications? 
                          and global.$GT_Ships.{$ship}.$GTModifications.$LastRemovalTime?">
              <set_value name="$lastRemovalTime" exact="@global.$GT_Ships.{$ship}.$GTModifications.$LastRemovalTime"/>
            </do_if>
            
            <!-- Only process if removal wasn't done recently (within last 5 seconds) -->
            <!-- This prevents duplicate removals from repeated signals -->
            <set_value name="$timeSinceLastRemoval" exact="player.age - $lastRemovalTime"/>
            <do_if value="$timeSinceLastRemoval gt 5s or $lastRemovalTime == 0">
              <!-- SAFETY CHECK: Only remove mods that WE installed (check GTInstalledSlots) -->
              <!-- This prevents removing player-installed mods -->
              <set_value name="$installedSlots" exact="[]"/>
              <do_if value="global.$GT_Ships.{$ship}? 
                                and global.$GT_Ships.{$ship}.$GTModifications? 
                                and global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots?">
                <set_value name="$installedSlots" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots"/>
              </do_if>
              
              <set_value name="$hasShipMod" exact="false"/>
              <set_value name="$hasEngineMod" exact="false"/>
              
              <!-- Check which slots we installed -->
              <do_all exact="$installedSlots.count" counter="$i">
                <do_if value="$installedSlots.{$i} == 'ship'">
                  <set_value name="$hasShipMod" exact="true"/>
                </do_if>
                <do_if value="$installedSlots.{$i} == 'engine'">
                  <set_value name="$hasEngineMod" exact="true"/>
                </do_if>
              </do_all>
              
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Removing modifications for ship: ' + $ship.idcode + ' (GT-installed: ship=' + $hasShipMod + ', engine=' + $hasEngineMod + ', last removal: ' + (if $lastRemovalTime gt 0 then ($timeSinceLastRemoval / 1s) + 's ago' else 'never') + ')'" chance="100"/>
              </do_if>
              
              <!-- Initialize tracking data if needed -->
              <do_if value="not global.$GT_Ships.{$ship}?">
                <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
              </do_if>
              <do_if value="not global.$GT_Ships.{$ship}.$GTModifications?">
                <set_value name="global.$GT_Ships.{$ship}.$GTModifications" exact="table[]"/>
              </do_if>
              
              <!-- Only remove ship mod if WE installed it -->
              <do_if value="$hasShipMod">
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Mods] Calling Lua to remove ship mod from ' + $ship.idcode + ' (GT-installed)'" chance="100"/>
                </do_if>
                <set_value name="$shipIdCode" exact="@$ship.idcode"/>
                <raise_lua_event name="'GT_DismantleMod'" param="'ship|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|null'"/>
              </do_if>
              <do_else>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Mods] Skipping ship mod removal for ' + $ship.idcode + ' - not GT-installed (player mod may be present)'" chance="100"/>
                </do_if>
              </do_else>
              
              <!-- Only remove engine mod if WE installed it -->
              <do_if value="$hasEngineMod">
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Mods] Calling Lua to remove engine mod from ' + $ship.idcode + ' (GT-installed)'" chance="100"/>
                </do_if>
                <set_value name="$shipIdCode" exact="@$ship.idcode"/>
                <raise_lua_event name="'GT_DismantleMod'" param="'engine|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|null'"/>
              </do_if>
              <do_else>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Mods] Skipping engine mod removal for ' + $ship.idcode + ' - not GT-installed (player mod may be present)'" chance="100"/>
                </do_if>
              </do_else>
              
              <!-- Clear tracking data and record removal time -->
              <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="[]"/>
              <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$InstalledLevel" exact="0"/>
              <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$LastRemovalTime" exact="player.age"/>
              
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Removed GT modifications from ' + $ship.idcode" chance="100"/>
              </do_if>
            </do_if>
            <do_else>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods]  Skipping duplicate removal for ' + $ship.idcode + ' (removed ' + ($timeSinceLastRemoval / 1s) + 's ago)'" chance="100"/>
              </do_if>
            </do_else>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods]  SAFEGUARD: Skipping mod removal for ' + $ship.idcode + ' - ship has direct GT order'" chance="100"/>
            </do_if>
          </do_else>
        </do_if>
        <do_else>
          <!-- Ship is not GT-controlled or update type is not GT_Order_Cancelled - exit silently -->
          <!-- This prevents stutter from constant property lookups for non-GT ships -->
        </do_else>
      </actions>
    </cue>
    
    <!-- Backup: Remove Modifications When Name Restoration Signal is Sent -->
    <!-- This ensures mods are removed even if GT_Ship_State_Update signal is missed -->
    <cue name="RemoveModificationsOnNameRestore" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Ship_Order_Aborted'"/>
      </conditions>
      <actions>
        <set_value name="$abortData" exact="event.param2"/>
        <set_value name="$ship" exact="$abortData.$Ship"/>
        <set_value name="$reason" exact="@$abortData.$Reason"/>
        
        <!-- Only process if reason indicates GT order was removed -->
        <do_if value="$reason == 'GT order removed - restoring original name' or $reason == 'Subordinate removed from GT commander - restoring original name'">
          <!-- FIX: Prevent duplicate removals - check if mods were already removed -->
          <set_value name="$lastRemovalTime" exact="0"/>
          <do_if value="global.$GT_Ships.{$ship}? 
                        and global.$GT_Ships.{$ship}.$GTModifications? 
                        and global.$GT_Ships.{$ship}.$GTModifications.$LastRemovalTime?">
            <set_value name="$lastRemovalTime" exact="@global.$GT_Ships.{$ship}.$GTModifications.$LastRemovalTime"/>
          </do_if>
          
          <!-- Only process if removal wasn't done recently (within last 5 seconds) -->
          <set_value name="$timeSinceLastRemoval" exact="player.age - $lastRemovalTime"/>
          <do_if value="$timeSinceLastRemoval gt 5s or $lastRemovalTime == 0">
            <!-- SAFETY CHECK: Only remove mods that WE installed (check GTInstalledSlots) -->
            <!-- This prevents removing player-installed mods -->
            <set_value name="$installedSlots" exact="[]"/>
            <do_if value="global.$GT_Ships.{$ship}? 
                              and global.$GT_Ships.{$ship}.$GTModifications? 
                              and global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots?">
              <set_value name="$installedSlots" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots"/>
            </do_if>
            
            <set_value name="$hasShipMod" exact="false"/>
            <set_value name="$hasEngineMod" exact="false"/>
            
            <!-- Check which slots we installed -->
            <do_all exact="$installedSlots.count" counter="$i">
              <do_if value="$installedSlots.{$i} == 'ship'">
                <set_value name="$hasShipMod" exact="true"/>
              </do_if>
              <do_if value="$installedSlots.{$i} == 'engine'">
                <set_value name="$hasEngineMod" exact="true"/>
              </do_if>
            </do_all>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Backup removal: Removing modifications for ship: ' + $ship.idcode + ' (GT-installed: ship=' + $hasShipMod + ', engine=' + $hasEngineMod + ', reason: ' + $reason + ')'" chance="100"/>
            </do_if>
            
            <!-- Initialize tracking data if needed -->
            <do_if value="not global.$GT_Ships.{$ship}?">
              <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
            </do_if>
            <do_if value="not global.$GT_Ships.{$ship}.$GTModifications?">
              <set_value name="global.$GT_Ships.{$ship}.$GTModifications" exact="table[]"/>
            </do_if>
            
            <!-- Only remove ship mod if WE installed it -->
            <do_if value="$hasShipMod">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Calling Lua to remove ship mod from ' + $ship.idcode + ' (GT-installed)'" chance="100"/>
              </do_if>
              <set_value name="$shipIdCode" exact="@$ship.idcode"/>
              <raise_lua_event name="'GT_DismantleMod'" param="'ship|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|null'"/>
            </do_if>
            <do_else>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Skipping ship mod removal for ' + $ship.idcode + ' - not GT-installed (player mod may be present)'" chance="100"/>
              </do_if>
            </do_else>
            
            <!-- Only remove engine mod if WE installed it -->
            <do_if value="$hasEngineMod">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Calling Lua to remove engine mod from ' + $ship.idcode + ' (GT-installed)'" chance="100"/>
              </do_if>
              <set_value name="$shipIdCode" exact="@$ship.idcode"/>
              <raise_lua_event name="'GT_DismantleMod'" param="'engine|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|null'"/>
            </do_if>
            <do_else>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Skipping engine mod removal for ' + $ship.idcode + ' - not GT-installed (player mod may be present)'" chance="100"/>
              </do_if>
            </do_else>
            
            <!-- Remove penalty mods if installed -->
            <set_value name="$existingPenaltyShipMod" exact="null"/>
            <set_value name="$existingPenaltyEngineMod" exact="null"/>
            <do_if value="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod?">
              <set_value name="$existingPenaltyShipMod" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod"/>
            </do_if>
            <do_if value="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod?">
              <set_value name="$existingPenaltyEngineMod" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod"/>
            </do_if>
            <do_if value="$existingPenaltyShipMod? or $existingPenaltyEngineMod?">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <set_value name="$shipModName" exact="'none'"/>
                <set_value name="$engineModName" exact="'none'"/>
                <do_if value="$existingPenaltyShipMod?">
                  <set_value name="$shipModName" exact="@$existingPenaltyShipMod.name"/>
                </do_if>
                <do_if value="$existingPenaltyEngineMod?">
                  <set_value name="$engineModName" exact="@$existingPenaltyEngineMod.name"/>
                </do_if>
                <debug_text text="'[GT-Penalty] Backup removal: Removing penalty mods from ' + $ship.idcode + ' (ship: ' + (if $shipModName? then $shipModName else 'none') + ', engine: ' + (if $engineModName? then $engineModName else 'none') + ', GT order cancelled)'" chance="100"/>
              </do_if>
              <set_value name="$shipIdCode" exact="@$ship.idcode"/>
              <do_if value="$existingPenaltyShipMod?">
                <raise_lua_event name="'GT_DismantleMod'" param="'ship|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|' + $existingPenaltyShipMod"/>
              </do_if>
              <do_if value="$existingPenaltyEngineMod?">
                <raise_lua_event name="'GT_DismantleMod'" param="'engine|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|' + $existingPenaltyEngineMod"/>
              </do_if>
              <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyShipMod"/>
              <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyEngineMod"/>
              <remove_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTPenaltyLevel"/>
            </do_if>
            
            <!-- Clear tracking data and record removal time -->
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="[]"/>
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$InstalledLevel" exact="0"/>
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$LastRemovalTime" exact="player.age"/>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Backup removal: Removed GT modifications from ' + $ship.idcode" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods]  Skipping duplicate backup removal for ' + $ship.idcode + ' (removed ' + ($timeSinceLastRemoval / 1s) + 's ago)'" chance="100"/>
            </do_if>
          </do_else>
        </do_if>
      </actions>
    </cue>
  </cues>
</mdscript>
