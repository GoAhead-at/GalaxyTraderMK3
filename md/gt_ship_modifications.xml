<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Ship_Modifications" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - SHIP MODIFICATIONS
         Automatic modification installation/removal system
         ======================================== -->
    
    <!-- Reusable Library: Install GT Modifications for Ship -->
    <library name="Install_GT_Modifications" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to install modifications on"/>
        <param name="pilot" comment="Pilot (optional, will be retrieved from ship if not provided)"/>
      </params>
      <actions>
        <!-- CHECK: Is modification feature enabled? -->
        <set_value name="$modificationsEnabled" exact="true"/>
        <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Modifications? and global.$GT_GlobalSettings.$Modifications.$Enabled?">
          <set_value name="$modificationsEnabled" exact="global.$GT_GlobalSettings.$Modifications.$Enabled"/>
        </do_if>
        
        <!-- Exit early if modifications are disabled -->
        <do_if value="not $modificationsEnabled">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Mods] Modifications feature disabled in global settings - skipping installation for ' + $ship.idcode" chance="100"/>
          </do_if>
        </do_if>
        <do_else>
          <!-- Get pilot if not provided -->
          <do_if value="not $pilot?">
            <set_value name="$pilot" exact="@$ship.pilot"/>
          </do_if>
          
          <!-- Get pilot level -->
          <set_value name="$pilotLevel" exact="0"/>
          <do_if value="$pilot? and global.$GT_Pilots? and global.$GT_Pilots.{$pilot}?">
            <set_value name="$pilotLevel" exact="@global.$GT_Pilots.{$pilot}.$Level"/>
          </do_if>
          
          <!-- Calculate mod level based on pilot level -->
          <!-- Level 9 = Level 1 mod, Level 12 = Level 2 mod, Level 15 = Level 3 mod -->
          <set_value name="$modLevel" exact="0"/>
          <do_if value="$pilotLevel ge 15">
            <set_value name="$modLevel" exact="3"/>
          </do_if>
          <do_elseif value="$pilotLevel ge 12">
            <set_value name="$modLevel" exact="2"/>
          </do_elseif>
          <do_elseif value="$pilotLevel ge 9">
            <set_value name="$modLevel" exact="1"/>
          </do_elseif>
          
          <!-- Install mods if pilot level qualifies -->
          <do_if value="$modLevel gt 0">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Mods] Installing Level ' + $modLevel + ' modifications for pilot level ' + $pilotLevel + ' on ' + $ship.idcode" chance="100"/>
          </do_if>
          
          <!-- Initialize mod tracking if needed -->
          <do_if value="not global.$GT_Ships.{$ship}?">
            <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
          </do_if>
          <do_if value="not global.$GT_Ships.{$ship}.$GTModifications?">
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications" exact="table[]"/>
          </do_if>
          <do_if value="not global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots?">
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="[]"/>
          </do_if>
          
          <!-- CHECK: Are mods already installed? (GT-installed or player-installed) -->
          <set_value name="$installedSlots" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots"/>
          <set_value name="$shipModAlreadyInstalled" exact="false"/>
          <set_value name="$engineModAlreadyInstalled" exact="false"/>
          
          <!-- Check if ship mod slot is already in installed list (GT-installed) -->
          <do_all exact="$installedSlots.count" counter="$i">
            <do_if value="$installedSlots.{$i} == 'ship'">
              <set_value name="$shipModAlreadyInstalled" exact="true"/>
            </do_if>
            <do_if value="$installedSlots.{$i} == 'engine'">
              <set_value name="$engineModAlreadyInstalled" exact="true"/>
            </do_if>
          </do_all>
          
          <!-- Determine mod ware IDs based on level -->
          <set_value name="$shipModWare" exact="null"/>
          <set_value name="$engineModWare" exact="null"/>
          
          <do_if value="$modLevel == 1">
            <set_value name="$shipModWare" exact="ware.mod_ship_gt_level1"/>
            <set_value name="$engineModWare" exact="ware.mod_engine_gt_level1"/>
          </do_if>
          <do_elseif value="$modLevel == 2">
            <set_value name="$shipModWare" exact="ware.mod_ship_gt_level2"/>
            <set_value name="$engineModWare" exact="ware.mod_engine_gt_level2"/>
          </do_elseif>
          <do_elseif value="$modLevel == 3">
            <set_value name="$shipModWare" exact="ware.mod_ship_gt_level3"/>
            <set_value name="$engineModWare" exact="ware.mod_engine_gt_level3"/>
          </do_elseif>
          
          <!-- Install ship mod only if not already installed -->
          <do_if value="$shipModWare? and not $shipModAlreadyInstalled">
            <add_equipment_mods object="$ship">
              <ship ware="$shipModWare"/>
            </add_equipment_mods>
            <append_to_list name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="'ship'"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Installed ship mod: ' + $shipModWare.name" chance="100"/>
            </do_if>
          </do_if>
          <do_elseif value="$shipModWare? and $shipModAlreadyInstalled">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Ship mod already installed on ' + $ship.idcode + ' - skipping installation'" chance="100"/>
            </do_if>
          </do_elseif>
          
          <!-- Install engine mod only if not already installed -->
          <do_if value="$engineModWare? and not $engineModAlreadyInstalled">
            <add_equipment_mods object="$ship">
              <engine ware="$engineModWare"/>
            </add_equipment_mods>
            <append_to_list name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="'engine'"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Installed engine mod: ' + $engineModWare.name" chance="100"/>
            </do_if>
          </do_if>
          <do_elseif value="$engineModWare? and $engineModAlreadyInstalled">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Engine mod already installed on ' + $ship.idcode + ' - skipping installation'" chance="100"/>
            </do_if>
          </do_elseif>
          
          <!-- Store mod level for reference (update even if mods were already installed) -->
          <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$InstalledLevel" exact="$modLevel"/>
          
          <!-- Only show success message if we actually installed something -->
          <do_if value="not $shipModAlreadyInstalled or not $engineModAlreadyInstalled">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Successfully installed Level ' + $modLevel + ' modifications on ' + $ship.idcode" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Level ' + $modLevel + ' modifications already installed on ' + $ship.idcode + ' - skipped'" chance="100"/>
            </do_if>
          </do_else>
        </do_if>
        <do_else>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Mods] Pilot level ' + $pilotLevel + ' does not qualify for modifications (need level 9+)'" chance="100"/>
          </do_if>
        </do_else>
        </do_else>
      </actions>
    </library>
    
    <!-- Load Lua Module for Mod Removal -->
    <cue name="Load_ModRemoval_Lua" instantiate="true">
      <conditions>
        <event_ui_triggered screen="'Lua_Loader'" control="'Ready'" />
      </conditions>
      <actions>
        <raise_lua_event 
          name="'Lua_Loader.Load'" 
          param="'extensions.galaxytradermk3.lua.gt_mod_removal'"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Mods] Loading mod removal Lua module...'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Install Modifications When GT Order is Assigned -->
    <cue name="InstallModifications" instantiate="true">
      <conditions>
        <event_object_order_ready object="player.galaxy"/>
        <check_value value="event.object.isclass.ship"/>
        <check_value value="event.object.owner == faction.player"/>
        <check_value value="event.param.id == 'GalaxyTraderMK3'"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Mods] GT order assigned - installing modifications for ship: ' + $ship.idcode" chance="100"/>
        </do_if>
        
        <!-- Use reusable library function -->
        <run_actions ref="Install_GT_Modifications">
          <param name="ship" value="$ship"/>
        </run_actions>
      </actions>
    </cue>
    
    <!-- Also listen to state updates for GT_Order_Assigned and Commander_Changed (if sent) -->
    <cue name="InstallModificationsFromState" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Ship_State_Update'"/>
      </conditions>
      <actions>
        <set_value name="$params" exact="event.param2"/>
        <set_value name="$updateType" exact="$params.$UpdateType"/>
        
        <!-- Process GT_Order_Assigned events -->
        <do_if value="$updateType == 'GT_Order_Assigned'">
          <set_value name="$ship" exact="$params.$Ship"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Mods] Installing modifications for ship: ' + $ship.idcode + ' (from state update - GT order assigned)'" chance="100"/>
          </do_if>
          
          <!-- Use reusable library function -->
          <!-- Get pilot from ship (library will handle if null) -->
          <set_value name="$pilot" exact="@$ship.pilot"/>
          <run_actions ref="Install_GT_Modifications">
            <param name="ship" value="$ship"/>
            <param name="pilot" value="$pilot"/>
          </run_actions>
        </do_if>
        
        <!-- Process Commander_Changed events - install mods when ship becomes subordinate to GT commander -->
        <do_elseif value="$updateType == 'Commander_Changed'">
          <set_value name="$ship" exact="$params.$Ship"/>
          <set_value name="$commanderHasGT" exact="false"/>
          <do_if value="$params.$CommanderHasGT?">
            <set_value name="$commanderHasGT" exact="$params.$CommanderHasGT"/>
          </do_if>
          
          <!-- Only install mods if commander has GT order -->
          <do_if value="$commanderHasGT">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Installing modifications for subordinate: ' + $ship.idcode + ' (commander has GT order)'" chance="100"/>
            </do_if>
            
            <!-- Use reusable library function -->
            <!-- Get pilot from ship (library will handle if null) -->
            <set_value name="$pilot" exact="@$ship.pilot"/>
            <run_actions ref="Install_GT_Modifications">
              <param name="ship" value="$ship"/>
              <param name="pilot" value="$pilot"/>
            </run_actions>
          </do_if>
        </do_elseif>
        
        <!-- Legacy code below - only used if updateType doesn't match above -->
        <do_elseif value="false">
          <!-- This block never executes, kept for reference -->
          <set_value name="$ship" exact="$params.$Ship"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Mods] Installing modifications for ship: ' + $ship.idcode + ' (from state update)'" chance="100"/>
          </do_if>
          
          <!-- Get pilot level -->
          <set_value name="$pilot" exact="@$ship.pilot"/>
          <set_value name="$pilotLevel" exact="0"/>
          
          <do_if value="$pilot? and global.$GT_Pilots? and global.$GT_Pilots.{$pilot}?">
            <set_value name="$pilotLevel" exact="@global.$GT_Pilots.{$pilot}.$Level"/>
          </do_if>
          
          <!-- Calculate mod level based on pilot level -->
          <!-- Level 9 = Level 1 mod, Level 12 = Level 2 mod, Level 15 = Level 3 mod -->
          <set_value name="$modLevel" exact="0"/>
          
          <do_if value="$pilotLevel ge 15">
            <set_value name="$modLevel" exact="3"/>
          </do_if>
          <do_elseif value="$pilotLevel ge 12">
            <set_value name="$modLevel" exact="2"/>
          </do_elseif>
          <do_elseif value="$pilotLevel ge 9">
            <set_value name="$modLevel" exact="1"/>
          </do_elseif>
          
          <!-- Install mods if pilot level qualifies -->
          <do_if value="$modLevel gt 0">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Pilot level ' + $pilotLevel + ' qualifies for Level ' + $modLevel + ' modifications'" chance="100"/>
            </do_if>
            
            <!-- Initialize mod tracking if needed -->
            <do_if value="not global.$GT_Ships.{$ship}?">
              <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
            </do_if>
            <do_if value="not global.$GT_Ships.{$ship}.$GTModifications?">
              <set_value name="global.$GT_Ships.{$ship}.$GTModifications" exact="table[]"/>
            </do_if>
            <do_if value="not global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots?">
              <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="[]"/>
            </do_if>
            
            <!-- Determine mod ware IDs based on level -->
            <set_value name="$shipModWare" exact="null"/>
            <set_value name="$engineModWare" exact="null"/>
            
            <do_if value="$modLevel == 1">
              <set_value name="$shipModWare" exact="ware.mod_ship_gt_level1"/>
              <set_value name="$engineModWare" exact="ware.mod_engine_gt_level1"/>
            </do_if>
            <do_elseif value="$modLevel == 2">
              <set_value name="$shipModWare" exact="ware.mod_ship_gt_level2"/>
              <set_value name="$engineModWare" exact="ware.mod_engine_gt_level2"/>
            </do_elseif>
            <do_elseif value="$modLevel == 3">
              <set_value name="$shipModWare" exact="ware.mod_ship_gt_level3"/>
              <set_value name="$engineModWare" exact="ware.mod_engine_gt_level3"/>
            </do_elseif>
            
            <!-- Install ship mod -->
            <do_if value="$shipModWare?">
              <add_equipment_mods object="$ship">
                <ship ware="$shipModWare"/>
              </add_equipment_mods>
              <append_to_list name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="'ship'"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Installed ship mod: ' + $shipModWare.name" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- Install engine mod -->
            <do_if value="$engineModWare?">
              <add_equipment_mods object="$ship">
                <engine ware="$engineModWare"/>
              </add_equipment_mods>
              <append_to_list name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="'engine'"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Installed engine mod: ' + $engineModWare.name" chance="100"/>
              </do_if>
            </do_if>
            
            <!-- Store mod level for reference -->
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$InstalledLevel" exact="$modLevel"/>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Successfully installed Level ' + $modLevel + ' modifications on ' + $ship.idcode" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Pilot level ' + $pilotLevel + ' does not qualify for modifications (need level 9+)'" chance="100"/>
            </do_if>
          </do_else>
        </do_elseif>
      </actions>
    </cue>
    
    <!-- Remove Modifications When GT Order is Cancelled -->
    <cue name="RemoveModifications" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Ship_State_Update'"/>
      </conditions>
      <actions>
        <set_value name="$params" exact="event.param2"/>
        <set_value name="$updateType" exact="@$params.$UpdateType"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Mods] Received GT_Ship_State_Update signal, updateType: ' + (if $updateType then $updateType else 'NULL')" chance="100"/>
        </do_if>
        
        <!-- Only process GT_Order_Cancelled events -->
        <do_if value="$updateType == 'GT_Order_Cancelled'">
          <set_value name="$ship" exact="$params.$Ship"/>
          
          <!-- TRUST THE SIGNAL: GT_Order_Cancelled means the order was cancelled -->
          <!-- CRITICAL: During signal processing window, ship.commander may still point to old commander (race condition) -->
          <!-- Solution: Only check for direct GT order, trust the signal for commander removal -->
          <!-- Only suppress if ship has direct GT order (not via commander, since commander check is unreliable during race window) -->
          <set_value name="$hasDirectGTOrder" exact="false"/>
          <do_if value="$ship.defaultorder? and @$ship.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$hasDirectGTOrder" exact="true"/>
          </do_if>
          
          <!-- Only proceed if ship doesn't have direct GT order (trust signal for commander removal) -->
          <do_if value="not $hasDirectGTOrder">
            <!-- FIX: Prevent duplicate removals - check if mods were already removed -->
            <!-- Use a timestamp to track when removal was last processed for this ship -->
            <set_value name="$lastRemovalTime" exact="0"/>
            <do_if value="global.$GT_Ships.{$ship}? 
                          and global.$GT_Ships.{$ship}.$GTModifications? 
                          and global.$GT_Ships.{$ship}.$GTModifications.$LastRemovalTime?">
              <set_value name="$lastRemovalTime" exact="@global.$GT_Ships.{$ship}.$GTModifications.$LastRemovalTime"/>
            </do_if>
            
            <!-- Only process if removal wasn't done recently (within last 5 seconds) -->
            <!-- This prevents duplicate removals from repeated signals -->
            <set_value name="$timeSinceLastRemoval" exact="player.age - $lastRemovalTime"/>
            <do_if value="$timeSinceLastRemoval gt 5s or $lastRemovalTime == 0">
              <!-- SAFETY CHECK: Only remove mods that WE installed (check GTInstalledSlots) -->
              <!-- This prevents removing player-installed mods -->
              <set_value name="$installedSlots" exact="[]"/>
              <do_if value="global.$GT_Ships.{$ship}? 
                                and global.$GT_Ships.{$ship}.$GTModifications? 
                                and global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots?">
                <set_value name="$installedSlots" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots"/>
              </do_if>
              
              <set_value name="$hasShipMod" exact="false"/>
              <set_value name="$hasEngineMod" exact="false"/>
              
              <!-- Check which slots we installed -->
              <do_all exact="$installedSlots.count" counter="$i">
                <do_if value="$installedSlots.{$i} == 'ship'">
                  <set_value name="$hasShipMod" exact="true"/>
                </do_if>
                <do_if value="$installedSlots.{$i} == 'engine'">
                  <set_value name="$hasEngineMod" exact="true"/>
                </do_if>
              </do_all>
              
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Removing modifications for ship: ' + $ship.idcode + ' (GT-installed: ship=' + $hasShipMod + ', engine=' + $hasEngineMod + ', last removal: ' + (if $lastRemovalTime gt 0 then ($timeSinceLastRemoval / 1s) + 's ago' else 'never') + ')'" chance="100"/>
              </do_if>
              
              <!-- Initialize tracking data if needed -->
              <do_if value="not global.$GT_Ships.{$ship}?">
                <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
              </do_if>
              <do_if value="not global.$GT_Ships.{$ship}.$GTModifications?">
                <set_value name="global.$GT_Ships.{$ship}.$GTModifications" exact="table[]"/>
              </do_if>
              
              <!-- Only remove ship mod if WE installed it -->
              <do_if value="$hasShipMod">
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Mods] Calling Lua to remove ship mod from ' + $ship.idcode + ' (GT-installed)'" chance="100"/>
                </do_if>
                <set_value name="$shipIdCode" exact="@$ship.idcode"/>
                <raise_lua_event name="'GT_DismantleMod'" param="'ship|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|null'"/>
              </do_if>
              <do_else>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Mods] Skipping ship mod removal for ' + $ship.idcode + ' - not GT-installed (player mod may be present)'" chance="100"/>
                </do_if>
              </do_else>
              
              <!-- Only remove engine mod if WE installed it -->
              <do_if value="$hasEngineMod">
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Mods] Calling Lua to remove engine mod from ' + $ship.idcode + ' (GT-installed)'" chance="100"/>
                </do_if>
                <set_value name="$shipIdCode" exact="@$ship.idcode"/>
                <raise_lua_event name="'GT_DismantleMod'" param="'engine|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|null'"/>
              </do_if>
              <do_else>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Mods] Skipping engine mod removal for ' + $ship.idcode + ' - not GT-installed (player mod may be present)'" chance="100"/>
                </do_if>
              </do_else>
              
              <!-- Clear tracking data and record removal time -->
              <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="[]"/>
              <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$InstalledLevel" exact="0"/>
              <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$LastRemovalTime" exact="player.age"/>
              
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Removed GT modifications from ' + $ship.idcode" chance="100"/>
              </do_if>
            </do_if>
            <do_else>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods]  Skipping duplicate removal for ' + $ship.idcode + ' (removed ' + ($timeSinceLastRemoval / 1s) + 's ago)'" chance="100"/>
              </do_if>
            </do_else>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods]  SAFEGUARD: Skipping mod removal for ' + $ship.idcode + ' - ship has direct GT order'" chance="100"/>
            </do_if>
          </do_else>
        </do_if>
      </actions>
    </cue>
    
    <!-- Backup: Remove Modifications When Name Restoration Signal is Sent -->
    <!-- This ensures mods are removed even if GT_Ship_State_Update signal is missed -->
    <cue name="RemoveModificationsOnNameRestore" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Ship_Order_Aborted'"/>
      </conditions>
      <actions>
        <set_value name="$abortData" exact="event.param2"/>
        <set_value name="$ship" exact="$abortData.$Ship"/>
        <set_value name="$reason" exact="@$abortData.$Reason"/>
        
        <!-- Only process if reason indicates GT order was removed -->
        <do_if value="$reason == 'GT order removed - restoring original name' or $reason == 'Subordinate removed from GT commander - restoring original name'">
          <!-- FIX: Prevent duplicate removals - check if mods were already removed -->
          <set_value name="$lastRemovalTime" exact="0"/>
          <do_if value="global.$GT_Ships.{$ship}? 
                        and global.$GT_Ships.{$ship}.$GTModifications? 
                        and global.$GT_Ships.{$ship}.$GTModifications.$LastRemovalTime?">
            <set_value name="$lastRemovalTime" exact="@global.$GT_Ships.{$ship}.$GTModifications.$LastRemovalTime"/>
          </do_if>
          
          <!-- Only process if removal wasn't done recently (within last 5 seconds) -->
          <set_value name="$timeSinceLastRemoval" exact="player.age - $lastRemovalTime"/>
          <do_if value="$timeSinceLastRemoval gt 5s or $lastRemovalTime == 0">
            <!-- SAFETY CHECK: Only remove mods that WE installed (check GTInstalledSlots) -->
            <!-- This prevents removing player-installed mods -->
            <set_value name="$installedSlots" exact="[]"/>
            <do_if value="global.$GT_Ships.{$ship}? 
                              and global.$GT_Ships.{$ship}.$GTModifications? 
                              and global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots?">
              <set_value name="$installedSlots" exact="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots"/>
            </do_if>
            
            <set_value name="$hasShipMod" exact="false"/>
            <set_value name="$hasEngineMod" exact="false"/>
            
            <!-- Check which slots we installed -->
            <do_all exact="$installedSlots.count" counter="$i">
              <do_if value="$installedSlots.{$i} == 'ship'">
                <set_value name="$hasShipMod" exact="true"/>
              </do_if>
              <do_if value="$installedSlots.{$i} == 'engine'">
                <set_value name="$hasEngineMod" exact="true"/>
              </do_if>
            </do_all>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Backup removal: Removing modifications for ship: ' + $ship.idcode + ' (GT-installed: ship=' + $hasShipMod + ', engine=' + $hasEngineMod + ', reason: ' + $reason + ')'" chance="100"/>
            </do_if>
            
            <!-- Initialize tracking data if needed -->
            <do_if value="not global.$GT_Ships.{$ship}?">
              <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
            </do_if>
            <do_if value="not global.$GT_Ships.{$ship}.$GTModifications?">
              <set_value name="global.$GT_Ships.{$ship}.$GTModifications" exact="table[]"/>
            </do_if>
            
            <!-- Only remove ship mod if WE installed it -->
            <do_if value="$hasShipMod">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Calling Lua to remove ship mod from ' + $ship.idcode + ' (GT-installed)'" chance="100"/>
              </do_if>
              <set_value name="$shipIdCode" exact="@$ship.idcode"/>
              <raise_lua_event name="'GT_DismantleMod'" param="'ship|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|null'"/>
            </do_if>
            <do_else>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Skipping ship mod removal for ' + $ship.idcode + ' - not GT-installed (player mod may be present)'" chance="100"/>
              </do_if>
            </do_else>
            
            <!-- Only remove engine mod if WE installed it -->
            <do_if value="$hasEngineMod">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Calling Lua to remove engine mod from ' + $ship.idcode + ' (GT-installed)'" chance="100"/>
              </do_if>
              <set_value name="$shipIdCode" exact="@$ship.idcode"/>
              <raise_lua_event name="'GT_DismantleMod'" param="'engine|' + $ship + '|' + (if $shipIdCode? then $shipIdCode else 'UNKNOWN') + '|0|0|null'"/>
            </do_if>
            <do_else>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Mods] Skipping engine mod removal for ' + $ship.idcode + ' - not GT-installed (player mod may be present)'" chance="100"/>
              </do_if>
            </do_else>
            
            <!-- Clear tracking data and record removal time -->
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$GTInstalledSlots" exact="[]"/>
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$InstalledLevel" exact="0"/>
            <set_value name="global.$GT_Ships.{$ship}.$GTModifications.$LastRemovalTime" exact="player.age"/>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods] Backup removal: Removed GT modifications from ' + $ship.idcode" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Mods]  Skipping duplicate backup removal for ' + $ship.idcode + ' (removed ' + ($timeSinceLastRemoval / 1s) + 's ago)'" chance="100"/>
            </do_if>
          </do_else>
        </do_if>
      </actions>
    </cue>
  </cues>
</mdscript>
