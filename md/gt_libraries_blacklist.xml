<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Libraries_Blacklist" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================= -->
    <!-- BLACKLIST UTILITIES -->
    <!-- ========================================= -->
    <!-- Consolidated from: gt_blacklist_utilities.xml + gt_blacklist_loader.xml -->
    
    <!-- Get Blacklist Group -->
    <library name="GT_GetBlacklistGroup" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to determine blacklist group for"/>
      </params>
      <actions>
        <set_value name="$blacklistgroup" exact="blacklistgroup.civilian"/>
        <do_if value="(@$ship.primarypurpose == purpose.fight) or (@$ship.primarypurpose == purpose.auxiliary)">
          <set_value name="$blacklistgroup" exact="blacklistgroup.military"/>
        </do_if>
        <return value="$blacklistgroup"/>
      </actions>
    </library>
    
    <!-- Get Sector Whitelist -->
    <library name="GT_GetSectorWhitelist" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to get whitelist for"/>
      </params>
      <actions>
        <set_value name="$whitelist" exact="[]"/>
        
        <!-- Check if ship is a subordinate - inherit commander's whitelist -->
        <do_if value="$ship.commander? and $ship.commander.exists and $ship.commander != $ship">
          <do_if value="$ship.commander.defaultorder? and $ship.commander.defaultorder.$sectorwhitelist?">
            <set_value name="$commanderWhitelist" exact="@$ship.commander.defaultorder.$sectorwhitelist"/>
            <!-- Extract count property with @ first, then check if result exists and is valid -->
            <set_value name="$commanderWhitelistCount" exact="@$commanderWhitelist.count"/>
            <do_if value="$commanderWhitelistCount? and $commanderWhitelistCount gt 0">
              <set_value name="$whitelist" exact="$commanderWhitelist"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- For non-subordinates: use ship's own whitelist -->
        <do_if value="not ($ship.commander? and $ship.commander.exists and $ship.commander != $ship)">
          <do_if value="$ship.defaultorder? and $ship.defaultorder.$sectorwhitelist?">
            <set_value name="$shipWhitelist" exact="@$ship.defaultorder.$sectorwhitelist"/>
            <!-- Extract count property with @ first, then check if result exists and is valid -->
            <set_value name="$shipWhitelistCount" exact="@$shipWhitelist.count"/>
            <do_if value="$shipWhitelistCount? and $shipWhitelistCount gt 0">
              <set_value name="$whitelist" exact="$shipWhitelist"/>
            </do_if>
          </do_if>
        </do_if>
        
        <return value="$whitelist"/>
      </actions>
    </library>
    
    <!-- Is Sector Blacklisted -->
    <library name="GT_IsSectorBlacklisted" purpose="run_actions">
      <params>
        <param name="sector" comment="Sector to check"/>
        <param name="ship" comment="Ship for blacklist context"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group (will be auto-determined if null)"/>
        <param name="returnDetails" default="false" comment="If true, returns table with activity/travel flags"/>
        <param name="sectorWhitelist" default="null" comment="List of sectors to exclude from blacklist checks (if null, will be auto-determined from ship's order)"/>
      </params>
      <actions>
        <!-- Get whitelist if not provided -->
        <set_value name="$whitelist" exact="[]"/>
        <do_if value="not $sectorWhitelist? or $sectorWhitelist == null">
          <run_actions ref="md.GT_Libraries_Blacklist.GT_GetSectorWhitelist" result="$whitelist">
            <param name="ship" value="$ship"/>
          </run_actions>
        </do_if>
        <do_else>
          <set_value name="$whitelist" exact="$sectorWhitelist"/>
        </do_else>
        
        <!-- Check whitelist first: if sector is in whitelist, it's not blacklisted -->
        <set_value name="$isWhitelisted" exact="false"/>
        <do_if value="$whitelist.count gt 0">
          <do_all exact="$whitelist.count" counter="$i">
            <do_if value="$whitelist.{$i} == $sector">
              <set_value name="$isWhitelisted" exact="true"/>
              <break/>
            </do_if>
          </do_all>
        </do_if>
        
        <!-- If whitelisted, return false (not blacklisted) -->
        <do_if value="$isWhitelisted">
          <do_if value="$returnDetails">
            <set_value name="$result" exact="table[]"/>
            <set_value name="$result.$IsBlacklisted" exact="false"/>
            <set_value name="$result.$ActivityBlacklisted" exact="false"/>
            <set_value name="$result.$TravelBlacklisted" exact="false"/>
            <return value="$result"/>
          </do_if>
          <do_else>
            <return value="false"/>
          </do_else>
        </do_if>
        
        <!-- Auto-determine blacklist group if not provided or null (memory:10529400 - ? checks existence, not null) -->
        <do_if value="not $blacklistgroup? or $blacklistgroup == null">
          <run_actions ref="md.GT_Libraries_Blacklist.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
        </do_if>
        
        <set_value name="$activityBlacklisted" exact="@$sector.isblacklisted.{blacklisttype.sectoractivity}.{$blacklistgroup}.{$ship}"/>
        <set_value name="$travelBlacklisted" exact="@$sector.isblacklisted.{blacklisttype.sectortravel}.{$blacklistgroup}.{$ship}"/>
        <set_value name="$isBlacklisted" exact="$activityBlacklisted or $travelBlacklisted"/>
        
        <do_if value="$returnDetails">
          <set_value name="$result" exact="table[]"/>
          <set_value name="$result.$IsBlacklisted" exact="$isBlacklisted"/>
          <set_value name="$result.$ActivityBlacklisted" exact="$activityBlacklisted"/>
          <set_value name="$result.$TravelBlacklisted" exact="$travelBlacklisted"/>
          <return value="$result"/>
        </do_if>
        <do_else>
          <return value="$isBlacklisted"/>
        </do_else>
      </actions>
    </library>
    
    <!-- Is Station Blacklisted -->
    <library name="GT_IsStationBlacklisted" purpose="run_actions">
      <params>
        <param name="station" comment="Station to check"/>
        <param name="ship" comment="Ship for blacklist context"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group (auto-determined if null)"/>
      </params>
      <actions>
        <do_if value="not $blacklistgroup?">
          <run_actions ref="md.GT_Libraries_Blacklist.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
        </do_if>
        <return value="@$station.isblacklisted.{blacklisttype.objectactivity}.{$blacklistgroup}.{$ship}"/>
      </actions>
    </library>
    
    <!-- Check Trade Blacklist -->
    <library name="GT_CheckTradeBlacklist" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship executing trade"/>
        <param name="buyStation" comment="Buy station"/>
        <param name="sellStation" comment="Sell station"/>
        <param name="currentSector" default="null" comment="Ship's current sector (for escape logic)"/>
        <param name="enableEscapeLogic" default="true" comment="Enable escape logic (block buying in blacklisted sectors)"/>
      </params>
      <actions>
        <!-- Initialize result -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IsBlacklisted" exact="false"/>
        <set_value name="$result.$Reason" exact="''"/>
        
        <!-- Get blacklist group -->
        <run_actions ref="md.GT_Libraries_Blacklist.GT_GetBlacklistGroup" result="$blacklistgroup">
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <!-- Extract sectors -->
        <set_value name="$buySector" exact="@$buyStation.sector"/>
        <set_value name="$sellSector" exact="@$sellStation.sector"/>
        <set_value name="$currentSector" exact="if $currentSector? then $currentSector else $ship.sector"/>
        
        <!-- Check current sector for intra-sector trades -->
        <run_actions ref="md.GT_Libraries_General.GT_IsIntraSectorTrade" result="$isIntraSector">
          <param name="buySector" value="$buySector"/>
          <param name="sellSector" value="$sellSector"/>
          <param name="currentSector" value="$currentSector"/>
        </run_actions>
        
        <do_if value="$isIntraSector">
          <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$currentSectorBlacklisted">
            <param name="sector" value="$currentSector"/>
            <param name="ship" value="$ship"/>
            <param name="blacklistgroup" value="$blacklistgroup"/>
          </run_actions>
          <do_if value="$currentSectorBlacklisted">
            <set_value name="$result.$IsBlacklisted" exact="true"/>
            <set_value name="$result.$Reason" exact="'Intra-sector trade in blacklisted sector'"/>
            <return value="$result"/>
          </do_if>
        </do_if>
        
        <!-- Check stations -->
        <run_actions ref="md.GT_Libraries_Blacklist.GT_IsStationBlacklisted" result="$buyStationBlacklisted">
          <param name="station" value="$buyStation"/>
          <param name="ship" value="$ship"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
        </run_actions>
        <do_if value="$buyStationBlacklisted">
          <set_value name="$result.$IsBlacklisted" exact="true"/>
          <set_value name="$result.$Reason" exact="'Buy station blacklisted'"/>
          <return value="$result"/>
        </do_if>
        
        <run_actions ref="md.GT_Libraries_Blacklist.GT_IsStationBlacklisted" result="$sellStationBlacklisted">
          <param name="station" value="$sellStation"/>
          <param name="ship" value="$ship"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
        </run_actions>
        <do_if value="$sellStationBlacklisted">
          <set_value name="$result.$IsBlacklisted" exact="true"/>
          <set_value name="$result.$Reason" exact="'Sell station blacklisted'"/>
          <return value="$result"/>
        </do_if>
        
        <!-- Check sectors (with escape logic) -->
        <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$buySectorBlacklisted">
          <param name="sector" value="$buySector"/>
          <param name="ship" value="$ship"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
        </run_actions>
        <do_if value="$enableEscapeLogic and $buySectorBlacklisted">
          <!-- Escape logic: block buying in blacklisted sector -->
          <set_value name="$result.$IsBlacklisted" exact="true"/>
          <set_value name="$result.$Reason" exact="'Buy sector blacklisted (escape logic)'"/>
          <return value="$result"/>
        </do_if>
        
        <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$sellSectorBlacklisted">
          <param name="sector" value="$sellSector"/>
          <param name="ship" value="$ship"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
        </run_actions>
        <do_if value="$enableEscapeLogic and $sellSectorBlacklisted and $sellSector != $currentSector">
          <!-- Escape logic: block selling to blacklisted sector (unless already there) -->
          <set_value name="$result.$IsBlacklisted" exact="true"/>
          <set_value name="$result.$Reason" exact="'Sell sector blacklisted (escape logic)'"/>
          <return value="$result"/>
        </do_if>
        
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Check if Ship Needs Escape (is in blacklisted sector) -->
    <library name="GT_CheckNeedsEscape" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to check"/>
      </params>
      <actions>
        <set_value name="$needsEscape" exact="false"/>
        <set_value name="$currentSector" exact="$ship.sector"/>
        <run_actions ref="md.GT_Libraries_Blacklist.GT_GetBlacklistGroup" result="$blacklistgroup">
          <param name="ship" value="$ship"/>
        </run_actions>
        <do_if value="$blacklistgroup? and $currentSector?">
          <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$needsEscape">
            <param name="sector" value="$currentSector"/>
            <param name="ship" value="$ship"/>
            <param name="blacklistgroup" value="$blacklistgroup"/>
          </run_actions>
        </do_if>
        <return value="$needsEscape"/>
      </actions>
    </library>
    
    <!-- Check Connected Sectors Blacklist Status -->
    <!-- Returns information about connected sectors and whether the sector is isolated -->
    <library name="GT_CheckConnectedSectorsBlacklisted" purpose="run_actions">
      <params>
        <param name="sector" comment="Sector to check connected sectors from"/>
        <param name="ship" comment="Ship for blacklist context and reference object"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group (auto-determined if null)"/>
        <param name="returnDetails" default="false" comment="If true, returns detailed table with sector lists"/>
      </params>
      <actions>
        <!-- Initialize result -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IsIsolated" exact="false"/>
        <set_value name="$result.$ConnectedSectorsCount" exact="0"/>
        <set_value name="$result.$BlacklistedSectorsCount" exact="0"/>
        <set_value name="$result.$NonBlacklistedSectorsCount" exact="0"/>
        
        <!-- Auto-determine blacklist group if not provided -->
        <do_if value="not $blacklistgroup? or $blacklistgroup == null">
          <run_actions ref="md.GT_Libraries_Blacklist.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
        </do_if>
        
        <!-- Validate inputs -->
        <do_if value="not $sector? or not $ship? or not $blacklistgroup?">
          <return value="$result"/>
        </do_if>
        
        <!-- Use ship's effective blacklist context (includes sector whitelist rules) -->

        <!-- Targeted isolation diagnostics (avoid log spam / micro-stutter when debug is enabled) -->
        <!-- To enable detailed logging for ONE ship: set global.$GT_Config.$Debug.$WatchIsolationShipId = 'ABC-123' -->
        <set_value name="$watchShipId" exact="@global.$GT_Config.$Debug.$WatchIsolationShipId"/>
        <set_value name="$doWatch" exact="$watchShipId != null and $watchShipId != '' and $ship.idcode == $watchShipId"/>

        <!-- Shared connectivity cache (per sector): avoids expensive galaxy-wide accelerator/highway fallback scans per ship -->
        <set_value name="$connCacheTtl" exact="300s"/>
        <set_value name="$connCacheKeys" exact="@global.$GT_SectorConnectivityCache.keys.count"/>
        <do_if value="$connCacheKeys == null">
          <set_value name="global.$GT_SectorConnectivityCache" exact="table[]"/>
        </do_if>

        <!-- Short-lived cache to avoid repeated expensive enumeration (and log spam) -->
        <!-- Many callers may request this repeatedly while filtering trades; caching keeps it O(1) per tick. -->
        <set_value name="$cacheHit" exact="false"/>
        <!-- Smoothness > speed: keep results longer; connectivity/blacklist topology rarely changes moment-to-moment -->
        <set_value name="$cacheTtl" exact="30s"/>
        <set_value name="$cachedEntry" exact="null"/>
        <do_if value="$returnDetails">
          <set_value name="$cachedEntry" exact="@global.$GT_IsolationCheckCache.{$ship}.{$sector}.$Details"/>
        </do_if>
        <do_else>
          <set_value name="$cachedEntry" exact="@global.$GT_IsolationCheckCache.{$ship}.{$sector}.$Simple"/>
        </do_else>
        <set_value name="$cachedTime" exact="@$cachedEntry.$Time"/>
        <set_value name="$cachedGroup" exact="@$cachedEntry.$BlacklistGroup"/>
        <set_value name="$cachedResult" exact="@$cachedEntry.$Result"/>
        <do_if value="$cachedTime? and $cachedTime != null and $cachedGroup? and $cachedGroup != null and $cachedResult? and $cachedResult != null">
          <set_value name="$cacheAge" exact="player.age - $cachedTime"/>
          <do_if value="$cacheAge le $cacheTtl and $cachedGroup == $blacklistgroup">
            <set_value name="$cacheHit" exact="true"/>
            <set_value name="$result" exact="$cachedResult"/>
          </do_if>
        </do_if>
        
        <!-- Only compute (and only log) if cache miss -->
        <do_if value="not $cacheHit">
        
        <!-- Find all sectors directly connected via gates and accelerators -->
        <!-- Use find_gate to enumerate all gates and accelerators in the target sector -->
        <set_value name="$validConnectedSectors" exact="[]"/>
        <set_value name="$blacklistedSectors" exact="[]"/>
        <set_value name="$nonBlacklistedSectors" exact="[]"/>
        <set_value name="$foundSectors" exact="table[]"/>
        <set_value name="$skipEnumeration" exact="false"/>

        <!-- Try shared sector connectivity cache (ship-independent) -->
        <set_value name="$connCacheHit" exact="false"/>
        <set_value name="$connEntry" exact="@global.$GT_SectorConnectivityCache.{$sector}"/>
        <set_value name="$connTime" exact="@$connEntry.$Time"/>
        <set_value name="$connSectors" exact="@$connEntry.$Sectors"/>
        <do_if value="$connTime? and $connTime != null and $connSectors? and $connSectors != null">
          <set_value name="$connAge" exact="player.age - $connTime"/>
          <do_if value="$connAge le $connCacheTtl">
            <set_value name="$connCacheHit" exact="true"/>
            <set_value name="$skipEnumeration" exact="true"/>
            <set_value name="$validConnectedSectors" exact="$connSectors"/>
          </do_if>
        </do_if>

        <!-- If connectivity cache hit: classify connected sectors for THIS ship's blacklist context -->
        <do_if value="$connCacheHit">
          <do_all exact="$validConnectedSectors.count" counter="$i">
            <set_value name="$connectedSector" exact="$validConnectedSectors.{$i}"/>
            <set_value name="$isBlacklisted" exact="false"/>
            <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$isBlacklisted">
              <param name="sector" value="$connectedSector"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$isBlacklisted">
              <append_to_list name="$blacklistedSectors" exact="$connectedSector"/>
              <set_value name="$result.$BlacklistedSectorsCount" exact="$result.$BlacklistedSectorsCount + 1"/>
            </do_if>
            <do_else>
              <append_to_list name="$nonBlacklistedSectors" exact="$connectedSector"/>
              <set_value name="$result.$NonBlacklistedSectorsCount" exact="$result.$NonBlacklistedSectorsCount + 1"/>
            </do_else>
          </do_all>
        </do_if>

        <!-- Only enumerate gates/accelerators/highways when we must (connectivity cache miss) -->
        <do_if value="not $skipEnumeration">
        
        <!-- Find all gates in the target sector -->
        <find_gate name="$gates" multiple="true" space="$sector"/>
        <set_value name="$gatesExist" exact="if $gates? then 'YES' else 'NO'"/>
        <set_value name="$gateCount" exact="if $gates != null then @$gates.count else 0"/>
        <do_if value="$doWatch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <set_value name="$sectorName" exact="@$sector.knownname"/>
          <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ') ISOLATION CHECK: Gates exist=' + $gatesExist + ', Found ' + $gateCount + ' gates in sector ' + $sectorName" chance="100"/>
        </do_if>
        <do_for_each name="$gate" in="$gates">
          <!-- Log each gate found (even if exit is invalid) -->
          <do_if value="$doWatch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$gateExit" exact="@$gate.exit"/>
            <set_value name="$gateExitSector" exact="@$gate.exit.sector"/>
            <set_value name="$gateDestSector" exact="@$gate.destination.sector"/>
            <set_value name="$hasExit" exact="if $gateExit? then 'YES' else 'NO'"/>
            <set_value name="$exitSectorName" exact="if $gateExitSector? then @$gateExitSector.knownname else 'NULL'"/>
            <set_value name="$destSectorName" exact="if $gateDestSector? then @$gateDestSector.knownname else 'NULL'"/>
            <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   GATE found: exit=' + $hasExit + ', exit.sector=' + $exitSectorName + ', destination.sector=' + $destSectorName" chance="100"/>
          </do_if>
          <!-- IMPORTANT: For superhighway gates (highwayentrygate), vanilla uses gate.highway.destination.sector -->
          <set_value name="$connectedSector" exact="@$gate.exit.sector"/>
          <do_if value="$gate.isclass.highwayentrygate">
            <set_value name="$connectedSector" exact="@$gate.highway.destination.sector"/>
          </do_if>
          <do_elseif value="not $connectedSector? or $connectedSector == null">
            <set_value name="$connectedSector" exact="@$gate.destination.sector"/>
          </do_elseif>
          <!-- Check that connectedSector exists AND is not null before using as table key -->
          <!-- The ? operator checks existence, not null - a variable can exist but be null -->
          <!-- We need to verify the sector is valid before using it as a table key -->
          <do_if value="$connectedSector? and $connectedSector != null and $connectedSector != $sector">
            <!-- Gate connects to a different sector - check if we've already seen this sector -->
            <do_if value="not $foundSectors.{$connectedSector}?">
              <set_value name="$foundSectors.{$connectedSector}" exact="true"/>
              <!-- Check blacklist status -->
              <set_value name="$isBlacklisted" exact="false"/>
              <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$isBlacklisted">
                <param name="sector" value="$connectedSector"/>
                <param name="ship" value="$ship"/>
                <param name="blacklistgroup" value="$blacklistgroup"/>
              </run_actions>
              
              <!-- Log each connected sector -->
              <do_if value="$doWatch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <set_value name="$connectedSectorName" exact="@$connectedSector.knownname"/>
                <set_value name="$blacklistStatus" exact="if $isBlacklisted then 'BLACKLISTED' else 'OK'"/>
                <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   GATE ' + $connectedSectorName + ' (' + $blacklistStatus + ')'" chance="100"/>
              </do_if>
              
              <!-- Add to appropriate list -->
              <append_to_list name="$validConnectedSectors" exact="$connectedSector"/>
              <do_if value="$isBlacklisted">
                <append_to_list name="$blacklistedSectors" exact="$connectedSector"/>
                <set_value name="$result.$BlacklistedSectorsCount" exact="$result.$BlacklistedSectorsCount + 1"/>
              </do_if>
              <do_else>
                <append_to_list name="$nonBlacklistedSectors" exact="$connectedSector"/>
                <set_value name="$result.$NonBlacklistedSectorsCount" exact="$result.$NonBlacklistedSectorsCount + 1"/>
              </do_else>
            </do_if>
          </do_if>
        </do_for_each>
        
        <!-- Find all accelerators in the target sector -->
        <!-- Note: Accelerators are bidirectional, so we need to check both:
             1. Accelerators IN this sector (pointing out)
             2. Accelerators pointing TO this sector (from other sectors)
        -->
        <find_gate name="$accelerators" multiple="true" space="$sector" accelerator="true"/>
        <set_value name="$acceleratorsExist" exact="if $accelerators? then 'YES' else 'NO'"/>
        <set_value name="$acceleratorCount" exact="if $accelerators != null then @$accelerators.count else 0"/>
        <do_if value="$doWatch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ') ISOLATION CHECK: Accelerators exist=' + $acceleratorsExist + ', Found ' + $acceleratorCount + ' accelerators IN sector ' + $sectorName" chance="100"/>
        </do_if>
        <do_for_each name="$accelerator" in="$accelerators">
          <!-- Log each accelerator found (even if exit is invalid) -->
          <do_if value="$doWatch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$acceleratorExit" exact="@$accelerator.exit"/>
            <set_value name="$acceleratorExitSector" exact="@$accelerator.exit.sector"/>
            <set_value name="$hasExit" exact="if $acceleratorExit? then 'YES' else 'NO'"/>
            <set_value name="$exitSectorName" exact="if $acceleratorExitSector? then @$acceleratorExitSector.knownname else 'NULL'"/>
            <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   ACCELERATOR found: exit=' + $hasExit + ', exit.sector=' + $exitSectorName" chance="100"/>
          </do_if>
          <set_value name="$connectedSector" exact="@$accelerator.exit.sector"/>
          <!-- Check that connectedSector exists AND is not null before using as table key -->
          <do_if value="$connectedSector? and $connectedSector != null and $connectedSector != $sector">
            <!-- Accelerator connects to a different sector - check if we've already seen this sector -->
            <do_if value="not $foundSectors.{$connectedSector}?">
              <set_value name="$foundSectors.{$connectedSector}" exact="true"/>
              <!-- Check blacklist status -->
              <set_value name="$isBlacklisted" exact="false"/>
              <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$isBlacklisted">
                <param name="sector" value="$connectedSector"/>
                <param name="ship" value="$ship"/>
                <param name="blacklistgroup" value="$blacklistgroup"/>
              </run_actions>
              
              <!-- Log each connected sector -->
              <do_if value="$doWatch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <set_value name="$connectedSectorName" exact="@$connectedSector.knownname"/>
                <set_value name="$blacklistStatus" exact="if $isBlacklisted then 'BLACKLISTED' else 'OK'"/>
                <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   ACCELERATOR ' + $connectedSectorName + ' (' + $blacklistStatus + ')'" chance="100"/>
              </do_if>
              
              <!-- Add to appropriate list -->
              <append_to_list name="$validConnectedSectors" exact="$connectedSector"/>
              <do_if value="$isBlacklisted">
                <append_to_list name="$blacklistedSectors" exact="$connectedSector"/>
                <set_value name="$result.$BlacklistedSectorsCount" exact="$result.$BlacklistedSectorsCount + 1"/>
              </do_if>
              <do_else>
                <append_to_list name="$nonBlacklistedSectors" exact="$connectedSector"/>
                <set_value name="$result.$NonBlacklistedSectorsCount" exact="$result.$NonBlacklistedSectorsCount + 1"/>
              </do_else>
            </do_if>
          </do_if>
        </do_for_each>
        
        <!-- Also search for accelerators pointing TO this sector (bidirectional check) -->
        <!-- Accelerators are bidirectional but may be defined from either direction -->
        <!-- Search in player.galaxy for all accelerators, then filter by exit.sector == our sector -->
        <!-- This catches accelerators defined from the opposite direction -->
        <do_if value="$acceleratorCount == 0">
          <!-- No accelerators found IN this sector - search for accelerators pointing TO this sector -->
          <find_gate name="$allAccelerators" multiple="true" space="player.galaxy" accelerator="true"/>
          <set_value name="$allAcceleratorCount" exact="if $allAccelerators != null then @$allAccelerators.count else 0"/>
          <do_if value="$doWatch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ') FALLBACK: Searching ' + $allAcceleratorCount + ' accelerators in galaxy for ones pointing TO sector ' + $sectorName" chance="100"/>
          </do_if>
          <do_for_each name="$accelerator" in="$allAccelerators">
            <set_value name="$acceleratorExitSector" exact="@$accelerator.exit.sector"/>
            <set_value name="$acceleratorSector" exact="@$accelerator.sector"/>
            <!-- Check if this accelerator points TO our sector -->
            <do_if value="$acceleratorExitSector? and $acceleratorExitSector == $sector">
              <!-- This accelerator points TO our sector - get the source sector (where accelerator is located) -->
              <set_value name="$sourceSector" exact="@$accelerator.sector"/>
              <do_if value="$sourceSector? and $sourceSector != $sector">
                <!-- Source sector is different from our sector - check if we've already seen this sector -->
                <do_if value="not $foundSectors.{$sourceSector}?">
                  <set_value name="$foundSectors.{$sourceSector}" exact="true"/>
                  <!-- Check blacklist status of source sector -->
                  <set_value name="$isBlacklisted" exact="false"/>
                  <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$isBlacklisted">
                    <param name="sector" value="$sourceSector"/>
                    <param name="ship" value="$ship"/>
                    <param name="blacklistgroup" value="$blacklistgroup"/>
                  </run_actions>
                  
                  <!-- Log accelerator found from opposite direction -->
                  <do_if value="$doWatch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <set_value name="$sourceSectorName" exact="@$sourceSector.knownname"/>
                    <set_value name="$blacklistStatus" exact="if $isBlacklisted then 'BLACKLISTED' else 'OK'"/>
                    <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   ACCELERATOR (FROM OPPOSITE): ' + $sourceSectorName + ' ' + $sectorName + ' (' + $blacklistStatus + ')'" chance="100"/>
                  </do_if>
                  
                  <!-- Add to appropriate list -->
                  <append_to_list name="$validConnectedSectors" exact="$sourceSector"/>
                  <do_if value="$isBlacklisted">
                    <append_to_list name="$blacklistedSectors" exact="$sourceSector"/>
                    <set_value name="$result.$BlacklistedSectorsCount" exact="$result.$BlacklistedSectorsCount + 1"/>
                  </do_if>
                  <do_else>
                    <append_to_list name="$nonBlacklistedSectors" exact="$sourceSector"/>
                    <set_value name="$result.$NonBlacklistedSectorsCount" exact="$result.$NonBlacklistedSectorsCount + 1"/>
                  </do_else>
                </do_if>
              </do_if>
            </do_if>
          </do_for_each>
        </do_if>
        
        <!-- Find all highway entry gates in the target sector -->
        <!-- Highway entry gates connect sectors via superhighways; vanilla uses highway.destination.sector -->
        <find_object name="$highwayEntries" class="class.highwayentrygate" space="$sector" multiple="true"/>
        <set_value name="$highwayEntriesExist" exact="if $highwayEntries? then 'YES' else 'NO'"/>
        <set_value name="$highwayEntryCount" exact="if $highwayEntries != null then @$highwayEntries.count else 0"/>
        <do_if value="$doWatch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ') ISOLATION CHECK: Highway entries exist=' + $highwayEntriesExist + ', Found ' + $highwayEntryCount + ' highway entries IN sector ' + $sectorName" chance="100"/>
        </do_if>
        <do_for_each name="$highwayEntry" in="$highwayEntries">
          <!-- Log each highway entry found (even if destination is invalid) -->
          <do_if value="$doWatch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$hwDestination" exact="@$highwayEntry.highway.destination"/>
            <set_value name="$hwDestinationSector" exact="@$highwayEntry.highway.destination.sector"/>
            <set_value name="$hasDestination" exact="if $hwDestination? then 'YES' else 'NO'"/>
            <set_value name="$destinationSectorName" exact="if $hwDestinationSector? then @$hwDestinationSector.knownname else 'NULL'"/>
            <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   HIGHWAY ENTRY found: destination=' + $hasDestination + ', destination.sector=' + $destinationSectorName" chance="100"/>
          </do_if>
          <set_value name="$connectedSector" exact="@$highwayEntry.highway.destination.sector"/>
          <!-- Check that connectedSector exists AND is not null before using as table key -->
          <do_if value="$connectedSector? and $connectedSector != null and $connectedSector != $sector">
            <!-- Highway entry connects to a different sector - check if we've already seen this sector -->
            <do_if value="not $foundSectors.{$connectedSector}?">
              <set_value name="$foundSectors.{$connectedSector}" exact="true"/>
              <!-- Check blacklist status -->
              <set_value name="$isBlacklisted" exact="false"/>
              <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$isBlacklisted">
                <param name="sector" value="$connectedSector"/>
                <param name="ship" value="$ship"/>
                <param name="blacklistgroup" value="$blacklistgroup"/>
              </run_actions>
              
              <!-- Log each connected sector -->
              <do_if value="$doWatch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <set_value name="$connectedSectorName" exact="@$connectedSector.knownname"/>
                <set_value name="$blacklistStatus" exact="if $isBlacklisted then 'BLACKLISTED' else 'OK'"/>
                <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   HIGHWAY ' + $connectedSectorName + ' (' + $blacklistStatus + ')'" chance="100"/>
              </do_if>
              
              <!-- Add to appropriate list -->
              <append_to_list name="$validConnectedSectors" exact="$connectedSector"/>
              <do_if value="$isBlacklisted">
                <append_to_list name="$blacklistedSectors" exact="$connectedSector"/>
                <set_value name="$result.$BlacklistedSectorsCount" exact="$result.$BlacklistedSectorsCount + 1"/>
              </do_if>
              <do_else>
                <append_to_list name="$nonBlacklistedSectors" exact="$connectedSector"/>
                <set_value name="$result.$NonBlacklistedSectorsCount" exact="$result.$NonBlacklistedSectorsCount + 1"/>
              </do_else>
            </do_if>
          </do_if>
        </do_for_each>
        
        <!-- Also search for highway entries pointing TO this sector (bidirectional check) -->
        <!-- Highways are bidirectional, so we need to check both directions -->
        <do_if value="$highwayEntryCount == 0">
          <!-- No highway entries found IN this sector - search for highway entries pointing TO this sector -->
          <!-- Vanilla pattern: highwayentrygate.highway.destination.sector -->
          <find_object name="$allHighwayEntries" class="class.highwayentrygate" space="player.galaxy" multiple="true"/>
          <set_value name="$allHighwayEntryCount" exact="if $allHighwayEntries != null then @$allHighwayEntries.count else 0"/>
          <do_if value="$doWatch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ') FALLBACK: Searching ' + $allHighwayEntryCount + ' highway entries in galaxy for ones pointing TO sector ' + $sectorName" chance="100"/>
          </do_if>
          <do_for_each name="$highwayEntry" in="$allHighwayEntries">
            <set_value name="$hwDestinationSector" exact="@$highwayEntry.highway.destination.sector"/>
            <set_value name="$hwSourceSector" exact="@$highwayEntry.highway.origin.sector"/>
            <!-- Check if this highway entry points TO our sector -->
            <do_if value="$hwDestinationSector? and $hwDestinationSector == $sector">
              <!-- This highway entry points TO our sector - get the source sector (where highway starts) -->
              <set_value name="$sourceSector" exact="$hwSourceSector"/>
              <do_if value="$sourceSector? and $sourceSector != null and $sourceSector != $sector">
                <!-- Source sector is different from our sector - check if we've already seen this sector -->
                <do_if value="not $foundSectors.{$sourceSector}?">
                  <set_value name="$foundSectors.{$sourceSector}" exact="true"/>
                  <!-- Check blacklist status of source sector -->
                  <set_value name="$isBlacklisted" exact="false"/>
                  <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$isBlacklisted">
                    <param name="sector" value="$sourceSector"/>
                    <param name="ship" value="$ship"/>
                    <param name="blacklistgroup" value="$blacklistgroup"/>
                  </run_actions>
                  
                  <!-- Log highway entry found from opposite direction -->
                  <do_if value="$doWatch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <set_value name="$sourceSectorName" exact="@$sourceSector.knownname"/>
                    <set_value name="$blacklistStatus" exact="if $isBlacklisted then 'BLACKLISTED' else 'OK'"/>
                    <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ')   HIGHWAY (FROM OPPOSITE): ' + $sourceSectorName + ' ' + $sectorName + ' (' + $blacklistStatus + ')'" chance="100"/>
                  </do_if>
                  
                  <!-- Add to appropriate list -->
                  <append_to_list name="$validConnectedSectors" exact="$sourceSector"/>
                  <do_if value="$isBlacklisted">
                    <append_to_list name="$blacklistedSectors" exact="$sourceSector"/>
                    <set_value name="$result.$BlacklistedSectorsCount" exact="$result.$BlacklistedSectorsCount + 1"/>
                  </do_if>
                  <do_else>
                    <append_to_list name="$nonBlacklistedSectors" exact="$sourceSector"/>
                    <set_value name="$result.$NonBlacklistedSectorsCount" exact="$result.$NonBlacklistedSectorsCount + 1"/>
                  </do_else>
                </do_if>
              </do_if>
            </do_if>
          </do_for_each>
        </do_if>
        
        <!-- Populate shared sector connectivity cache -->
        <set_value name="global.$GT_SectorConnectivityCache.{$sector}" exact="table[$Time = player.age, $Sectors = $validConnectedSectors]"/>

        </do_if>

        <!-- Update result counts -->
        <set_value name="$result.$ConnectedSectorsCount" exact="$validConnectedSectors.count"/>
        
        <!-- Sector is isolated if it has connected sectors AND all of them are blacklisted -->
        <do_if value="$validConnectedSectors.count gt 0">
          <set_value name="$result.$IsIsolated" exact="$result.$NonBlacklistedSectorsCount == 0"/>
        </do_if>
        <do_else>
          <!-- No connected sectors found - might be a dead-end or single-sector zone -->
          <!-- Consider it NOT isolated (can't be isolated if there's nothing to isolate from) -->
          <set_value name="$result.$IsIsolated" exact="false"/>
        </do_else>
        
        <!-- Return detailed information if requested -->
        <do_if value="$returnDetails">
          <set_value name="$result.$ConnectedSectors" exact="$validConnectedSectors"/>
          <set_value name="$result.$BlacklistedSectors" exact="$blacklistedSectors"/>
          <set_value name="$result.$NonBlacklistedSectors" exact="$nonBlacklistedSectors"/>
        </do_if>
        
        <!-- Log final isolation check summary -->
        <do_if value="$doWatch and global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <set_value name="$finalStatus" exact="if $result.$IsIsolated then 'ISOLATED' else 'NOT ISOLATED'"/>
          <set_value name="$sectorName" exact="@$sector.knownname"/>
          <debug_text text="'[GT-Blacklist] (' + $ship.idcode + ') ' + $finalStatus + ': ' + $result.$ConnectedSectorsCount + ' connected sectors (' + $result.$BlacklistedSectorsCount + ' blacklisted, ' + $result.$NonBlacklistedSectorsCount + ' OK) in ' + $sectorName" chance="100"/>
        </do_if>

        <!-- Cache result (short-lived, per ship+sector) -->
        <!-- IMPORTANT: Do NOT use '.simple' as a table member. It is reserved/read-only in MD and causes:
             "Failed to set table[].simple ..."
          -->
        <set_value name="$cacheTime" exact="player.age"/>
        <set_value name="$cacheEntry" exact="table[
          $BlacklistGroup = $blacklistgroup,
          $Result = $result,
          $Time = $cacheTime
        ]"/>
        <!-- Ensure cache root exists and is a valid table -->
        <set_value name="$isolationCacheRootCheck" exact="@global.$GT_IsolationCheckCache.keys.count"/>
        <do_if value="$isolationCacheRootCheck == null">
          <set_value name="global.$GT_IsolationCheckCache" exact="table[]"/>
        </do_if>
        <!-- Ensure ship cache table exists (and is valid) -->
        <set_value name="$isolationCacheShipCheck" exact="@global.$GT_IsolationCheckCache.{$ship}.keys.count"/>
        <do_if value="$isolationCacheShipCheck == null">
          <set_value name="global.$GT_IsolationCheckCache.{$ship}" exact="table[]"/>
        </do_if>
        <!-- Ensure sector cache table exists (and is valid) -->
        <set_value name="$isolationCacheSectorCheck" exact="@global.$GT_IsolationCheckCache.{$ship}.{$sector}.keys.count"/>
        <do_if value="$isolationCacheSectorCheck == null">
          <set_value name="global.$GT_IsolationCheckCache.{$ship}.{$sector}" exact="table[]"/>
        </do_if>
        <!-- Store by mode using $-prefixed keys to avoid reserved members like '.simple' -->
        <do_if value="$returnDetails">
          <set_value name="global.$GT_IsolationCheckCache.{$ship}.{$sector}.$Details" exact="$cacheEntry"/>
        </do_if>
        <do_else>
          <set_value name="global.$GT_IsolationCheckCache.{$ship}.{$sector}.$Simple" exact="$cacheEntry"/>
        </do_else>

        </do_if>
        
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Check And Handle Isolation -->
    <!-- Extracted from gt_trading_batch_processor.xml for reusability and maintainability -->
    <!-- This function checks if a ship is isolated, manages state, handles logging, and writes logbook messages -->
    <library name="GT_CheckAndHandleIsolation" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to check isolation for"/>
        <param name="state" comment="Batch state table (will be updated and returned)"/>
      </params>
      <actions>
        <set_value name="$shipIsIsolated" exact="false"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Batch] GT_CheckAndHandleIsolation called for ship: ' + $ship.idcode" chance="100"/>
        </do_if>
        <!-- Targeted one-ship isolation diagnostics (high signal, low noise) -->
        <!-- To enable: set global.$GT_Config.$Debug.$WatchIsolationShipId = 'BZK-058' (or any idcode) -->
        <set_value name="$watchShipId" exact="@global.$GT_Config.$Debug.$WatchIsolationShipId"/>
        <set_value name="$doWatch" exact="$watchShipId? and $watchShipId != null and $watchShipId != '' and $ship.idcode == $watchShipId"/>
        
        <!-- Ensure state is valid (save game compatibility) -->
        <!-- If state is null or invalid, initialize as empty table -->
        <!-- Always initialize $updatedState to prevent null property access errors -->
        <set_value name="$updatedState" exact="table[]"/>
        <set_value name="$stateValid" exact="false"/>
        <do_if value="$state?">
          <!-- State variable exists - check if it's actually a valid table (not null) -->
          <!-- Try to access .keys property - if state is null, this will fail safely with @ operator -->
          <set_value name="$stateKeysTest" exact="@$state.keys"/>
          <!-- Check if keys test returned a valid list (not null) -->
          <!-- In X4, if $state is null, @$state.keys returns null, and null? returns true (variable exists) -->
          <!-- So we need to check if the result is actually a valid list by trying to access .count -->
          <set_value name="$stateKeysCountTest" exact="@$stateKeysTest.count"/>
          <!-- Only valid if count test succeeded AND returned a number >= 0 -->
          <!-- If $stateKeysTest was null, then $stateKeysCountTest will be null, and null ge 0 is false -->
          <do_if value="$stateKeysCountTest? and $stateKeysCountTest ge 0">
            <!-- State is valid table - safe to use -->
            <set_value name="$stateValid" exact="true"/>
          </do_if>
        </do_if>
        <do_if value="$stateValid">
          <!-- State is valid - use it instead of empty table -->
          <!-- Final safety check - ensure state is still valid before overwriting -->
          <set_value name="$stateFinalKeysCheck" exact="@$state.keys"/>
          <set_value name="$stateFinalCountCheck" exact="@$stateFinalKeysCheck.count"/>
          <do_if value="$stateFinalCountCheck? and $stateFinalCountCheck ge 0">
            <set_value name="$updatedState" exact="$state"/>
          </do_if>
        </do_if>
        <!-- If not valid, $updatedState already initialized to table[] above -->
        
        <!-- Ensure $updatedState is never null before using it -->
        <!-- This must happen BEFORE any property access on $updatedState -->
        <!-- Direct validation - check if $updatedState is a valid table -->
        <set_value name="$updatedStateIsValid" exact="false"/>
        <do_if value="$updatedState?">
          <!-- $updatedState variable exists - verify it's actually a valid table (not null) -->
          <!-- Try accessing .keys property - if $updatedState is null, @ operator returns null safely -->
          <set_value name="$updatedStateKeysTest" exact="@$updatedState.keys"/>
          <!-- If $updatedState is null, $updatedStateKeysTest will be null -->
          <!-- Check if we got a valid list back (not null) by trying to access .count -->
          <set_value name="$updatedStateCountTest" exact="@$updatedStateKeysTest.count"/>
          <!-- Check if count is actually a number (not null) -->
          <!-- If $updatedStateCountTest is null, we can't compare it, so check if it exists AND is >= 0 -->
          <do_if value="$updatedStateCountTest?">
            <!-- Count variable exists - verify it's actually a number by checking it's >= 0 -->
            <!-- If count is null, the comparison will fail or be false -->
            <do_if value="$updatedStateCountTest ge 0">
              <!-- Comparison succeeded - count is >= 0, so it's a valid number and $updatedState is valid table -->
              <set_value name="$updatedStateIsValid" exact="true"/>
            </do_if>
          </do_if>
        </do_if>
        <do_if value="not $updatedStateIsValid">
          <!-- $updatedState is null or invalid - reinitialize to empty table -->
          <set_value name="$updatedState" exact="table[]"/>
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Blacklist]  $updatedState was null/invalid - reinitialized to empty table (countTest: ' + $updatedStateCountTest + ')'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Ensure $updatedState is still valid before property access -->
        <!-- Double-check that $updatedState hasn't become null somehow -->
        <set_value name="$updatedStateFinalKeysCheck" exact="@$updatedState.keys"/>
        <set_value name="$updatedStateFinalCountCheck" exact="@$updatedStateFinalKeysCheck.count"/>
        <do_if value="not $updatedStateFinalCountCheck? or $updatedStateFinalCountCheck lt 0">
          <!-- $updatedState became invalid - reinitialize to empty table -->
          <set_value name="$updatedState" exact="table[]"/>
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Blacklist]  $updatedState became invalid after validation - reinitialized to empty table'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Check if isolation has already been checked for this ship -->
        <!-- Use safe operator @ for property access to prevent null errors -->
        <set_value name="$isolationAlreadyChecked" exact="@$updatedState.$shipIsIsolatedChecked"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Isolation check: alreadyChecked=' + (if $isolationAlreadyChecked? then 'yes' else 'no')" chance="100"/>
        </do_if>
        <do_if value="not $isolationAlreadyChecked?">
          <!-- First time checking isolation for this ship -->
          <set_value name="$currentSector" exact="$ship.sector"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Current sector check: sector=' + (if $currentSector? then 'exists' else 'null')" chance="100"/>
          </do_if>
          <do_if value="$currentSector?">
            <!-- Check if current sector is blacklisted (if yes, not isolated, it's just blacklisted) -->
            <run_actions ref="md.GT_Libraries_Blacklist.GT_GetBlacklistGroup" result="$blacklistgroup">
              <param name="ship" value="$ship"/>
            </run_actions>
            <run_actions ref="md.GT_Libraries_Blacklist.GT_IsSectorBlacklisted" result="$currentSectorIsBlacklisted">
              <param name="sector" value="$currentSector"/>
              <param name="ship" value="$ship"/>
              <param name="blacklistgroup" value="$blacklistgroup"/>
            </run_actions>
            <do_if value="$doWatch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Isolation] (' + $ship.idcode + ') CurrentSector=' + @$currentSector.knownname + ' | CurrentSectorBlacklisted=' + $currentSectorIsBlacklisted + ' | blacklistgroup=' + $blacklistgroup" chance="100"/>
            </do_if>
            <do_if value="not $currentSectorIsBlacklisted">
              <!-- Ship is in non-blacklisted sector - check if all routes are blocked -->
              <run_actions ref="md.GT_Libraries_Blacklist.GT_CheckConnectedSectorsBlacklisted" result="$isolationCheck">
                <param name="sector" value="$currentSector"/>
                <param name="ship" value="$ship"/>
                <param name="returnDetails" value="$doWatch"/>
              </run_actions>
              <set_value name="$isolatedValue" exact="@$isolationCheck.$IsIsolated"/>
              <set_value name="$shipIsIsolated" exact="if $isolatedValue? and ($isolatedValue == true or $isolatedValue == 1) then true else false"/>
              <do_if value="$doWatch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Isolation] (' + $ship.idcode + ') Connected=' + @$isolationCheck.$ConnectedSectorsCount + ' | Blacklisted=' + @$isolationCheck.$BlacklistedSectorsCount + ' | OK=' + @$isolationCheck.$NonBlacklistedSectorsCount + ' | IsIsolated=' + $shipIsIsolated" chance="100"/>
                <!-- When watched, GT_CheckConnectedSectorsBlacklisted returns $ConnectedSectors/$BlacklistedSectors/$NonBlacklistedSectors -->
                <set_value name="$okList" exact="@$isolationCheck.$NonBlacklistedSectors"/>
                <set_value name="$blList" exact="@$isolationCheck.$BlacklistedSectors"/>
                <set_value name="$okCount" exact="if $okList != null then @$okList.count else 0"/>
                <set_value name="$blCount" exact="if $blList != null then @$blList.count else 0"/>
                <set_value name="$okNames" exact="''"/>
                <set_value name="$blNames" exact="''"/>
                <do_all exact="$okCount" counter="$i">
                  <set_value name="$s" exact="$okList.{$i}"/>
                  <do_if value="$okNames != ''">
                    <set_value name="$okNames" exact="$okNames + ', '"/>
                  </do_if>
                  <set_value name="$okNames" exact="$okNames + (if @$s.knownname then @$s.knownname else 'NULL')"/>
                </do_all>
                <do_all exact="$blCount" counter="$j">
                  <set_value name="$s" exact="$blList.{$j}"/>
                  <do_if value="$blNames != ''">
                    <set_value name="$blNames" exact="$blNames + ', '"/>
                  </do_if>
                  <set_value name="$blNames" exact="$blNames + (if @$s.knownname then @$s.knownname else 'NULL')"/>
                </do_all>
                <debug_text text="'[GT-Isolation] (' + $ship.idcode + ') OK connected sectors: ' + (if $okNames != '' then $okNames else '(none)') " chance="100"/>
                <debug_text text="'[GT-Isolation] (' + $ship.idcode + ') BLACKLISTED connected sectors: ' + (if $blNames != '' then $blNames else '(none)') " chance="100"/>
              </do_if>
              <!-- Final safety check before setting properties -->
              <!-- Ensure $updatedState is still valid (not null) before setting properties -->
              <set_value name="$updatedStatePreSetCheck" exact="@$updatedState.keys"/>
              <do_if value="$updatedStatePreSetCheck?">
                <!-- $updatedState is valid - safe to set properties -->
                <set_value name="$updatedState.$shipIsIsolated" exact="if $shipIsIsolated then 1 else 0"/>
                <set_value name="$updatedState.$shipIsIsolatedChecked" exact="1"/>
              </do_if>
              <do_else>
                <!-- $updatedState is null - reinitialize and set properties -->
                <set_value name="$updatedState" exact="table[]"/>
                <set_value name="$updatedState.$shipIsIsolated" exact="if $shipIsIsolated then 1 else 0"/>
                <set_value name="$updatedState.$shipIsIsolatedChecked" exact="1"/>
                <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Blacklist]  $updatedState was null before setting isolation properties - reinitialized'" chance="100"/>
                </do_if>
              </do_else>
              
              <!-- Log isolation status -->
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <set_value name="$connectedCount" exact="@$isolationCheck.$ConnectedSectorsCount"/>
                <set_value name="$blacklistedCount" exact="@$isolationCheck.$BlacklistedSectorsCount"/>
                <set_value name="$nonBlacklistedCount" exact="@$isolationCheck.$NonBlacklistedSectorsCount"/>
                <set_value name="$currentSectorName" exact="@$currentSector.knownname"/>
                <do_if value="$shipIsIsolated">
                  <debug_text text="'[GT-Batch] (' + $ship.idcode + ') ISOLATED: All ' + $connectedCount + ' connected sectors are blacklisted (ship in ' + $currentSectorName + ')'" chance="100"/>
                </do_if>
                <do_else>
                  <debug_text text="'[GT-Batch] (' + $ship.idcode + ') NOT ISOLATED: ' + $nonBlacklistedCount + ' of ' + $connectedCount + ' connected sectors are non-blacklisted (ship in ' + $currentSectorName + ')'" chance="100"/>
                </do_else>
              </do_if>
              
              <!-- Set isolated flag and trigger name update if isolated -->
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Isolation check result: shipIsIsolated=' + $shipIsIsolated + ', isolatedValue=' + $isolatedValue" chance="100"/>
              </do_if>
              
              <do_if value="$shipIsIsolated">
                <!-- Set isolated flag for ship name updates (always set when isolated, not just on first detection) -->
                <do_if value="not global.$GT_IsolatedTradeActive?">
                  <set_value name="global.$GT_IsolatedTradeActive" exact="table[]"/>
                </do_if>
                <set_value name="global.$GT_IsolatedTradeActive.{$ship}" exact="true"/>
                
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Batch] (' + $ship.idcode + ') ISOLATION FLAG SET: global.$GT_IsolatedTradeActive.{$ship} = true'" chance="100"/>
                </do_if>
                
                <!-- Check if isolation was already logged (for logbook message only) -->
                <set_value name="$isolationAlreadyLogged" exact="false"/>
                <do_if value="global.$GT_Ships? and global.$GT_Ships.{$ship}? and global.$GT_Ships.{$ship}.$IsolationLogged?">
                  <set_value name="$isolationAlreadyLogged" exact="global.$GT_Ships.{$ship}.$IsolationLogged"/>
                </do_if>
                
                <!-- Log isolation message if not already logged -->
                <do_if value="not $isolationAlreadyLogged">
                  <!-- Initialization guarantees global.$GT_Ships exists -->
                  <do_if value="not global.$GT_Ships.{$ship}?">
                    <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
                  </do_if>
                  <set_value name="global.$GT_Ships.{$ship}.$IsolationLogged" exact="true"/>
                  <set_value name="$currentSectorName" exact="@$currentSector.knownname"/>
                  <do_if value="not $currentSectorName?">
                    <set_value name="$currentSectorName" exact="'Unknown Sector'"/>
                  </do_if>
                  <set_value name="$shipName" exact="@$ship.knownname"/>
                  <do_if value="not $shipName?">
                    <set_value name="$shipName" exact="$ship.idcode"/>
                  </do_if>
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-Batch] (' + $ship.idcode + ') ISOLATION DETECTED: Ship in ' + $currentSectorName + ' (non-blacklisted) but ALL routes to other sectors blocked by blacklist - prioritizing intra-sector trades'" chance="100"/>
                  </do_if>
                  <set_value name="$logbookEnabled" exact="true"/>
                  <do_if value="global.$GT_Ships.{$ship}.$LogbookEntries?">
                    <set_value name="$logbookEnabled" exact="global.$GT_Ships.{$ship}.$LogbookEntries"/>
                  </do_if>
                  <do_if value="$logbookEnabled">
                    <!-- Construct logbook message using TextDB syntax (vanilla pattern) -->
                    <set_value name="$logbookMessage" exact="{77000,3211}.[$shipName, $currentSectorName]"/>
                    
                    <run_actions ref="md.GT_Libraries_General.WriteLogbookMessage">
                      <param name="Message" value="$logbookMessage"/>
                      <param name="Category" value="'general'"/>
                      <param name="Title" value="'Isolated Trading: ' + $shipName"/>
                      <param name="Object" value="$ship"/>
                      <param name="Interaction" value="'showonmap'"/>
                      <param name="CheckGlobalSettings" value="false"/>
                    </run_actions>
                    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                      <debug_text text="'[GT-Batch] (' + $ship.idcode + ') ISOLATION LOGBOOK MESSAGE WRITTEN: Ship ' + $shipName + ' in sector ' + $currentSectorName + ' - forced to intra-sector trades only due to blacklisted hub sectors'" chance="100"/>
                    </do_if>
                  </do_if>
                </do_if>
                
                <!-- Trigger ship name update to show [ISOLATED] flag (always, not just on first detection) -->
                <!-- Only update if ship has a pilot (required for name update) -->
                <set_value name="$pilot" exact="@$ship.pilot"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Checking pilot for name update: pilot=' + (if $pilot? then 'exists' else 'null') + ', exists=' + (if $pilot.exists then 'yes' else 'no')" chance="100"/>
                </do_if>
                <do_if value="$pilot? and $pilot.exists">
                  <set_value name="$pilotXP" exact="@global.$GT_Pilots.{$pilot}.$XP"/>
                  <do_if value="not $pilotXP?">
                    <set_value name="$pilotXP" exact="0"/>
                  </do_if>
                  <set_value name="$skillLevel" exact="1"/>
                  <do_all exact="15" counter="$lvl">
                    <do_if value="$pilotXP ge global.$GT_Config.$XP.$SkillThresholds.{$lvl}">
                      <set_value name="$skillLevel" exact="$lvl"/>
                    </do_if>
                  </do_all>
                  <set_value name="$rankTitle" exact="'Lehrling'"/>
                  <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                    <set_value name="$rankIndex" exact="($skillLevel / 3)i + 1"/>
                    <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                      <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
                    </do_if>
                    <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                      <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                    </do_if>
                  </do_if>
                  
                  <!-- Signal ship name update with isolated nameType -->
                  <signal_objects object="player.galaxy" param="'GT_Update_Ship_Name'" param2="table[
                    $ship = $ship,
                    $pilot = $pilot,
                    $xp = $pilotXP,
                    $level = $skillLevel,
                    $rank = $rankTitle,
                    $nameType = 'isolated'
                  ]"/>
                  
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Triggered ship name update for isolated ship'" chance="100"/>
                  </do_if>
                </do_if>
              </do_if>
            </do_if>
            <do_else>
              <!-- Current sector is blacklisted - ship is not isolated, it's just in a blacklisted sector -->
              <set_value name="$shipIsIsolated" exact="false"/>
              <!-- Clear isolated flag if it was previously set -->
              <do_if value="global.$GT_IsolatedTradeActive? and global.$GT_IsolatedTradeActive.{$ship}?">
                <remove_value name="global.$GT_IsolatedTradeActive.{$ship}"/>
              </do_if>
              <!-- Final safety check before setting properties -->
              <set_value name="$updatedStatePreSetCheck2" exact="@$updatedState.keys"/>
              <do_if value="$updatedStatePreSetCheck2?">
                <!-- $updatedState is valid - safe to set properties -->
                <set_value name="$updatedState.$shipIsIsolated" exact="0"/>
                <set_value name="$updatedState.$shipIsIsolatedChecked" exact="1"/>
              </do_if>
              <do_else>
                <!-- $updatedState is null - reinitialize and set properties -->
                <set_value name="$updatedState" exact="table[]"/>
                <set_value name="$updatedState.$shipIsIsolated" exact="0"/>
                <set_value name="$updatedState.$shipIsIsolatedChecked" exact="1"/>
                <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-Blacklist]  $updatedState was null before setting isolation properties (blacklisted sector) - reinitialized'" chance="100"/>
                </do_if>
              </do_else>
            </do_else>
          </do_if>
        </do_if>
        <do_else>
          <!-- Isolation already checked - retrieve from state -->
          <set_value name="$isolatedStateValue" exact="@$updatedState.$shipIsIsolated"/>
          <set_value name="$shipIsIsolated" exact="if $isolatedStateValue? and ($isolatedStateValue == 1 or $isolatedStateValue == true) then true else false"/>
          
          <!-- CRITICAL: Also check global flag as authoritative source (state might be stale) -->
          <!-- The global flag is set when isolation is detected, so it's the source of truth -->
          <do_if value="global.$GT_IsolatedTradeActive? and global.$GT_IsolatedTradeActive.{$ship}?">
            <set_value name="$shipIsIsolated" exact="true"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Overriding cached isolation state with global flag (state=' + $isolatedStateValue + ', global=true)'" chance="100"/>
            </do_if>
          </do_if>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Cached isolation check: stateValue=' + $isolatedStateValue + ', shipIsIsolated=' + $shipIsIsolated + ', globalFlag=' + (if global.$GT_IsolatedTradeActive? and global.$GT_IsolatedTradeActive.{$ship}? then 'true' else 'false')" chance="100"/>
          </do_if>
          
          <!-- Set or clear isolated flag based on current state -->
          <do_if value="$shipIsIsolated">
            <!-- Ship is isolated - ensure flag is set -->
            <!-- CRITICAL: Isolated and fallback are mutually exclusive - clear fallback flag when isolated is active -->
            <do_if value="global.$GT_FallbackTradeActive? and global.$GT_FallbackTradeActive.{$ship}?">
              <remove_value name="global.$GT_FallbackTradeActive.{$ship}"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Cleared [FALLBACK] flag - isolated takes precedence'" chance="100"/>
              </do_if>
            </do_if>
            
            <do_if value="not global.$GT_IsolatedTradeActive?">
              <set_value name="global.$GT_IsolatedTradeActive" exact="table[]"/>
            </do_if>
            <do_if value="not global.$GT_IsolatedTradeActive.{$ship}?">
              <set_value name="global.$GT_IsolatedTradeActive.{$ship}" exact="true"/>
            </do_if>
            
            <!-- Trigger ship name update to show [ISOLATED] flag (always when isolated) -->
            <set_value name="$pilot" exact="@$ship.pilot"/>
            <do_if value="$pilot? and $pilot.exists">
              <set_value name="$pilotXP" exact="@global.$GT_Pilots.{$pilot}.$XP"/>
              <do_if value="not $pilotXP?">
                <set_value name="$pilotXP" exact="0"/>
              </do_if>
              <set_value name="$skillLevel" exact="1"/>
              <do_all exact="15" counter="$lvl">
                <do_if value="$pilotXP ge global.$GT_Config.$XP.$SkillThresholds.{$lvl}">
                  <set_value name="$skillLevel" exact="$lvl"/>
                </do_if>
              </do_all>
              <set_value name="$rankTitle" exact="'Lehrling'"/>
              <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                <set_value name="$rankIndex" exact="($skillLevel / 3)i + 1"/>
                <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                  <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
                </do_if>
                <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                  <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                </do_if>
              </do_if>
              
              <!-- Signal ship name update with isolated nameType -->
              <signal_objects object="player.galaxy" param="'GT_Update_Ship_Name'" param2="table[
                $ship = $ship,
                $pilot = $pilot,
                $xp = $pilotXP,
                $level = $skillLevel,
                $rank = $rankTitle,
                $nameType = 'isolated'
              ]"/>
              
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Triggered ship name update for isolated ship (from cached state)'" chance="100"/>
              </do_if>
            </do_if>
          </do_if>
          <do_else>
            <!-- Ship is not isolated - clear flag if it was set -->
            <do_if value="global.$GT_IsolatedTradeActive? and global.$GT_IsolatedTradeActive.{$ship}?">
              <remove_value name="global.$GT_IsolatedTradeActive.{$ship}"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Batch] (' + $ship.idcode + ') Ship no longer isolated - cleared [ISOLATED] flag'" chance="100"/>
              </do_if>
            </do_if>
          </do_else>
        </do_else>
        
        <!-- Return result table -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$IsIsolated" exact="$shipIsIsolated"/>
        <set_value name="$result.$UpdatedState" exact="$updatedState"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- ========================================= -->
    <!-- BLACKLIST LOADER -->
    <!-- ========================================= -->
    <!-- Consolidated from: gt_blacklist_loader.xml -->
    
    <!-- Load Lua file via sn_mod_support_apis Lua Loader -->
    <cue name="Load_Blacklist_Manager" instantiate="true">
      <conditions>
        <event_ui_triggered screen="'Lua_Loader'" control="'Ready'" />
      </conditions>
      <actions>
        <raise_lua_event 
          name="'Lua_Loader.Load'" 
          param="'extensions.galaxytradermk3.ui.gt_blacklist_manager'"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Loading dynamic blacklist manager via Lua Loader...'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Verify Lua module loaded successfully -->
    <cue name="Verify_Blacklist_Manager" instantiate="true">
      <conditions>
        <event_ui_triggered screen="'Lua_Loader'" 
          control="'Loaded extensions.galaxytradermk3.ui.gt_blacklist_manager'" />
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Dynamic blacklist manager loaded successfully!'" chance="100"/>
        </do_if>
        <!-- Initialization is now handled by gt_threat_intelligence.xml with proper parameters -->
      </actions>
    </cue>
    
  </cues>
</mdscript>
