<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_ThreatIntelligence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  
  <!-- DYNAMIC THREAT INTELLIGENCE SYSTEM -->
  <!-- Real-time hostile activity detection and fleet-wide reporting for GalaxyTrader MK3 -->
  
  <cues>
    
    <!-- Initialize the Threat Intelligence System -->
    <cue name="InitializeThreatSystem">
      <conditions>
        <event_game_started/>
      </conditions>
      <actions>
        <!-- Initialize global threat database -->
        <do_if value="not global.$GT_ThreatIntelligence?">
          <set_value name="global.$GT_ThreatIntelligence" exact="table[]"/>
          <debug_text text="'[GalaxyTrader MK3] Threat Intelligence System initialized'" chance="100"/>
        </do_if>
        
        <!-- Initialize cleanup tracking -->
        <do_if value="not global.$GT_ThreatCleanupTime?">
          <set_value name="global.$GT_ThreatCleanupTime" exact="player.age"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Attack Threat Detection -->
    <cue name="DetectAttackThreats">
      <conditions>
        <event_object_attacked object="player.galaxy"/>
      </conditions>
      <actions>
        <set_value name="$victim" exact="event.object"/>
        <set_value name="$attacker" exact="event.param"/>
        
        <!-- Only process attacks on GalaxyTrader ships -->
        <do_if value="$victim.isplayerowned and global.$GT_Ships.{$victim}? and $victim.sector? and $attacker?">
          <set_value name="$currentSector" exact="$victim.sector"/>
          
          <!-- Determine threat level based on attacker characteristics -->
          <set_value name="$threatLevel" exact="2"/> <!-- Default: Medium threat -->
          
          <!-- Very high threat for Xenon/Kha'ak -->
          <do_if value="$attacker.owner? and ($attacker.owner.id == 'xenon' or $attacker.owner.id == 'khaak')">
            <set_value name="$threatLevel" exact="5"/>
          </do_if>
          <!-- High threat for capital ships and large attackers -->
          <do_elseif value="$attacker.isclass.ship_xl or $attacker.isclass.ship_l">
            <set_value name="$threatLevel" exact="4"/>
          </do_elseif>
          <!-- Medium-high threat for other hostile factions -->
          <do_elseif value="$attacker.owner? and faction.player.relationto.{$attacker.owner} le -0.2">
            <set_value name="$threatLevel" exact="3"/>
          </do_elseif>
          
          <!-- Report the threat -->
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}" exact="table[]"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$Timestamp" exact="player.age"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$ThreatLevel" exact="$threatLevel"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$AttackerType" exact="$attacker.idcode"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$AttackerFaction" exact="@$attacker.owner.knownname"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$ReportingShip" exact="$victim.knownname"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$ThreatType" exact="'Attack'"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$VictimShip" exact="$victim.knownname"/>
          
          <!-- Update ship statistics -->
          <set_value name="global.$GT_Ships.{$victim}.$ThreatReports" exact="global.$GT_Ships.{$victim}.$ThreatReports + 1"/>
          <set_value name="global.$GT_Ships.{$victim}.$LastThreatTime" exact="player.age"/>
          
          <debug_text text="'[GalaxyTrader MK3] âš ï¸ THREAT REPORT: ' + $victim.knownname + ' attacked by ' + @$attacker.knownname + ' (' + @$attacker.owner.knownname + ') in ' + $currentSector.knownname + ' - Threat Level: ' + $threatLevel" chance="100"/>
          
          <!-- Notify fleet for high threats -->
          <do_if value="$threatLevel ge 3">
            <show_notification text="'âš ï¸ FLEET ALERT: High threat activity in ' + $currentSector.knownname + ' - All traders advised to avoid'" timeout="10s"/>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Missile Threat Detection -->
    <cue name="DetectMissileThreats">
      <conditions>
        <event_object_incoming_missile object="player.galaxy"/>
      </conditions>
      <actions>
        <set_value name="$target" exact="event.object"/>
        <set_value name="$missile" exact="event.param"/>
        
        <!-- Only process missile threats to GalaxyTrader ships -->
        <do_if value="$target.isplayerowned and global.$GT_Ships.{$target}? and $target.sector? and $missile?">
          <set_value name="$currentSector" exact="$target.sector"/>
          
          <!-- Report missile threat (high level - missiles are serious) -->
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}" exact="table[]"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$Timestamp" exact="player.age"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$ThreatLevel" exact="4"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$AttackerType" exact="@$missile.launcher.idcode"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$AttackerFaction" exact="@$missile.launcher.owner.knownname"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$ReportingShip" exact="$target.knownname"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$ThreatType" exact="'Incoming Missile'"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$TargetShip" exact="$target.knownname"/>
          
          <debug_text text="'[GalaxyTrader MK3] ðŸš€ MISSILE THREAT: Incoming missile targeting ' + $target.knownname + ' in ' + $currentSector.knownname" chance="100"/>
          
          <!-- Always notify for missile threats -->
          <show_notification text="'ðŸš€ MISSILE ALERT: Hostile missile detected in ' + $currentSector.knownname + ' - Fleet advised extreme caution'" timeout="8s"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Ship Destruction Detection -->
    <cue name="DetectShipDestruction">
      <conditions>
        <event_object_destroyed object="player.galaxy"/>
      </conditions>
      <actions>
        <set_value name="$destroyedObject" exact="event.object"/>
        <set_value name="$killer" exact="event.param"/>
        
        <!-- Only process destruction of GalaxyTrader ships -->
        <do_if value="$destroyedObject.isplayerowned and global.$GT_Ships.{$destroyedObject}? and $destroyedObject.sector? and $killer?">
          <set_value name="$currentSector" exact="$destroyedObject.sector"/>
          
          <!-- Report ship destruction (very high threat level) -->
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}" exact="table[]"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$Timestamp" exact="player.age"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$ThreatLevel" exact="5"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$AttackerType" exact="$killer.idcode"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$AttackerFaction" exact="@$killer.owner.knownname"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$ReportingShip" exact="'Fleet Intelligence'"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$ThreatType" exact="'Ship Destroyed'"/>
          <set_value name="global.$GT_ThreatIntelligence.{$currentSector}.$DestroyedShip" exact="$destroyedObject.knownname"/>
          
          <debug_text text="'[GalaxyTrader MK3] ðŸ’€ CRITICAL THREAT: ' + $destroyedObject.knownname + ' destroyed by ' + @$killer.knownname + ' (' + @$killer.owner.knownname + ') in ' + $currentSector.knownname" chance="100"/>
          
          <!-- Always notify for ship destruction -->
          <show_notification text="'ðŸ’€ FLEET EMERGENCY: Trader ship destroyed in ' + $currentSector.knownname + ' - All ships avoid this sector immediately!'" timeout="15s"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Threat Database Cleanup - Remove old threats every 10 minutes -->
    <cue name="CleanupOldThreats">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <delay exact="600s"/> <!-- 10 minutes -->
      <actions>
        <do_if value="global.$GT_ThreatIntelligence?">
          <set_value name="$currentTime" exact="player.age"/>
          <set_value name="$threatsRemoved" exact="0"/>
          
          <!-- Remove threats older than 1 hour -->
          <do_all exact="global.$GT_ThreatIntelligence.keys.count" counter="$i" reverse="true">
            <set_value name="$sector" exact="global.$GT_ThreatIntelligence.keys.list.{$i}"/>
            <set_value name="$threatData" exact="global.$GT_ThreatIntelligence.{$sector}"/>
            
            <do_if value="$threatData.$Timestamp?">
              <set_value name="$age" exact="$currentTime - $threatData.$Timestamp"/>
              
              <!-- Remove threats older than 1 hour -->
              <do_if value="$age gt 3600s">
                <remove_value name="global.$GT_ThreatIntelligence.{$sector}"/>
                <set_value name="$threatsRemoved" exact="$threatsRemoved + 1"/>
              </do_if>
            </do_if>
          </do_all>
          
          <do_if value="$threatsRemoved gt 0">
            <debug_text text="'[GalaxyTrader MK3] Threat Intelligence cleanup: Removed ' + $threatsRemoved + ' old threat reports'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Signal self to repeat -->
        <signal_cue cue="CleanupOldThreats"/>
      </actions>
    </cue>
    
    <!-- Fleet Threat Status Reporter - Every 5 minutes, report fleet threat statistics -->
    <cue name="FleetThreatReporter">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <delay exact="300s"/> <!-- 5 minutes -->
      <actions>
        <do_if value="global.$GT_Ships? and global.$GT_ThreatIntelligence?">
          <set_value name="$activeThreatSectors" exact="0"/>
          <set_value name="$highThreatSectors" exact="0"/>
          <set_value name="$currentTime" exact="player.age"/>
          
          <!-- Count active threat sectors -->
          <do_all exact="global.$GT_ThreatIntelligence.keys.count" counter="$i">
            <set_value name="$sector" exact="global.$GT_ThreatIntelligence.keys.list.{$i}"/>
            <set_value name="$threatData" exact="global.$GT_ThreatIntelligence.{$sector}"/>
            
            <do_if value="$threatData.$Timestamp?">
              <set_value name="$age" exact="$currentTime - $threatData.$Timestamp"/>
              
              <!-- Only count recent threats (within last 30 minutes) -->
              <do_if value="$age le 1800s">
                <set_value name="$activeThreatSectors" exact="$activeThreatSectors + 1"/>
                
                <do_if value="$threatData.$ThreatLevel ge 3">
                  <set_value name="$highThreatSectors" exact="$highThreatSectors + 1"/>
                </do_if>
              </do_if>
            </do_if>
          </do_all>
          
          <!-- Report significant threat activity -->
          <do_if value="$highThreatSectors gt 0">
            <debug_text text="'[GalaxyTrader MK3] Fleet Intelligence Report: ' + $highThreatSectors + ' high-threat sectors, ' + $activeThreatSectors + ' total active threats'" chance="100"/>
            
            <do_if value="$highThreatSectors ge 3">
              <show_notification text="'âš ï¸ FLEET WARNING: Multiple high-threat sectors detected (' + $highThreatSectors + ') - Exercise extreme caution'" timeout="8s"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Signal self to repeat -->
        <signal_cue cue="FleetThreatReporter"/>
      </actions>
    </cue>
    
    <!-- 
    ============================================================================
    REAL-TIME THREAT DETECTION (True Vanilla Event-Driven System)
    ============================================================================
    
    REMOVED: All polling-based scans (CPU waste, unnecessary)
    
    VANILLA APPROACH:
    - Threat detection integrated into trade movement via activepatrol=true
    - Uses vanilla's move.seekenemies (event-driven, zero CPU when stationary)
    - Detection occurs naturally as ships travel to buy/sell stations
    - Skill-based reporting: Only Level 6+ pilots broadcast fleet warnings
    
    HOW IT WORKS:
    1. Ship starts trade execution â†’ Movement uses activepatrol=true
    2. Vanilla system detects enemies during movement (real-time)
    3. on_enemy_detected event fires â†’ Ship checks pilot level
    4. Level 6+ â†’ Broadcasts GT_Threat_Warning to fleet
    5. Level 1-5 â†’ Detects but stays quiet (inexperienced)
    
    BENEFITS:
    - Zero polling overhead (event-driven only)
    - Truly vanilla-compatible (uses same system as Guard/Patrol orders)
    - Detection only when ships are actually moving/trading
    - Skill progression mechanic maintained
    
    GAME BALANCE:
    - Early game (Lv1-5): Ships avoid threats individually, no fleet coordination
    - Mid-game (Lv6+): Fleet intelligence emerges, experienced pilots help rookies
    ============================================================================
    -->
    
    <!-- Event-Driven Threat Detection: Ships Attacked -->
    <cue name="ShipUnderAttack" instantiate="true">
      <conditions>
        <event_object_attacked object="player.galaxy"/>
        <check_value value="event.object.isplayerowned and global.$GT_Ships.{event.object}?"/> <!-- Is this a GT ship? -->
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        <set_value name="$attacker" exact="event.param"/>
        
        <!-- Check if attacker is hostile -->
        <do_if value="$attacker.exists and $ship.mayattack.{$attacker}">
          <!-- Get pilot skill level -->
          <set_value name="$pilotLevel" exact="1"/>
          <do_if value="$ship.pilot? and global.$GT_Pilots.{$ship.pilot}?">
            <set_value name="$pilotLevel" exact="@global.$GT_Pilots.{$ship.pilot}.$Level"/>
          </do_if>
          
          <!-- Find all nearby hostiles (within radar range) -->
          <find_ship name="$nearbyHostiles" space="$ship.sector" multiple="true">
            <match_distance object="$ship" max="$ship.maxradarrange"/>
            <match_relation_to object="$ship" relation="enemy" comparison="le"/>
          </find_ship>
          
          <!-- Calculate threat with detailed ship class & faction analysis -->
          <set_value name="$threatScore" exact="0"/>
          <set_value name="$shipClass_XL" exact="0"/>
          <set_value name="$shipClass_L" exact="0"/>
          <set_value name="$shipClass_M" exact="0"/>
          <set_value name="$shipClass_S" exact="0"/>
          <set_value name="$factionCounts" exact="table[]"/> <!-- Track faction counts -->
          
          <do_all exact="$nearbyHostiles.count" counter="$h">
            <set_value name="$hostile" exact="$nearbyHostiles.{$h}"/>
            
            <!-- Count by ship class -->
            <do_if value="$hostile.isclass.ship_xl">
              <set_value name="$threatScore" exact="$threatScore + 5"/>
              <set_value name="$shipClass_XL" operation="add"/>
            </do_if>
            <do_elseif value="$hostile.isclass.ship_l">
              <set_value name="$threatScore" exact="$threatScore + 3"/>
              <set_value name="$shipClass_L" operation="add"/>
            </do_elseif>
            <do_elseif value="$hostile.isclass.ship_m">
              <set_value name="$threatScore" exact="$threatScore + 2"/>
              <set_value name="$shipClass_M" operation="add"/>
            </do_elseif>
            <do_else>
              <set_value name="$threatScore" exact="$threatScore + 1"/>
              <set_value name="$shipClass_S" operation="add"/>
            </do_else>
            
            <!-- Track faction counts -->
            <do_if value="$hostile.owner?">
              <set_value name="$faction" exact="$hostile.owner"/>
              <set_value name="$factionCounts.{$faction}" exact="@$factionCounts.{$faction} + 1"/>
            </do_if>
          </do_all>
          
          <!-- Find dominant faction (most ships) -->
          <set_value name="$primaryFaction" exact="null"/>
          <set_value name="$maxCount" exact="0"/>
          <do_all exact="$factionCounts.keys.count" counter="$f">
            <set_value name="$faction" exact="$factionCounts.keys.{$f}"/>
            <do_if value="$factionCounts.{$faction} gt $maxCount">
              <set_value name="$primaryFaction" exact="$faction"/>
              <set_value name="$maxCount" exact="$factionCounts.{$faction}"/>
            </do_if>
          </do_all>
          
          <!-- Build ship class summary string -->
          <set_value name="$classBreakdown" exact="''"/>
          <do_if value="$shipClass_XL gt 0">
            <set_value name="$classBreakdown" exact="$classBreakdown + $shipClass_XL + 'XL '"/>
          </do_if>
          <do_if value="$shipClass_L gt 0">
            <set_value name="$classBreakdown" exact="$classBreakdown + $shipClass_L + 'L '"/>
          </do_if>
          <do_if value="$shipClass_M gt 0">
            <set_value name="$classBreakdown" exact="$classBreakdown + $shipClass_M + 'M '"/>
          </do_if>
          <do_if value="$shipClass_S gt 0">
            <set_value name="$classBreakdown" exact="$classBreakdown + $shipClass_S + 'S'"/>
          </do_if>
          
          <!-- Only Level 6+ pilots broadcast to fleet -->
          <do_if value="$pilotLevel ge 6">
            <signal_objects object="player.galaxy" param="'GT_Threat_Warning'" param2="table[
              $Sector = $ship.sector,
              $DetectedBy = $ship,
              $HostileCount = $nearbyHostiles.count,
              $PrimaryFaction = $primaryFaction,
              $ShipClass_XL = $shipClass_XL,
              $ShipClass_L = $shipClass_L,
              $ShipClass_M = $shipClass_M,
              $ShipClass_S = $shipClass_S,
              $ThreatScore = $threatScore,
              $Timestamp = player.age
            ]"/>
            
            <set_value name="$factionName" exact="if $primaryFaction then $primaryFaction.knownname else 'Unknown'"/>
            <debug_text text="'[GT-Threat] ðŸš¨ ' + $ship.knownname + ' (Pilot Lv.' + $pilotLevel + ') UNDER ATTACK by ' + $attacker.knownname + '\n  âš” Hostiles: ' + $nearbyHostiles.count + ' (' + $classBreakdown + ') - Threat: ' + $threatScore + '\n  ðŸ´ Primary Faction: ' + $factionName + ' - FLEET WARNING BROADCAST'" chance="100"/>
          </do_if>
          <do_else>
            <debug_text text="'[GT-Threat] ðŸš¨ ' + $ship.knownname + ' (Pilot Lv.' + $pilotLevel + ') under attack by ' + $attacker.knownname + ' but lacks experience to report to fleet (requires Lv.6+)'" chance="100"/>
          </do_else>
        </do_if>
      </actions>
    </cue>
    
    <!-- Event-Driven Threat Detection: Proactive Radar Scan During Trade Execution -->
    <cue name="TradeMovementScan" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_Trading_Execution.ExecuteTrade"/>
      </conditions>
      <actions>
        <!-- Get ship and trade from event params (safer than globals due to async instantiation) -->
        <set_value name="$ship" exact="event.param.$Ship"/>
        <set_value name="$trade" exact="event.param.$Trade"/>
        
        <!-- Scan for hostiles in destination sector (proactive intel) -->
        <do_if value="$trade.$BuyOffer.owner.sector?">
          <find_ship name="$hostiles" space="$trade.$BuyOffer.owner.sector" multiple="true">
            <match_relation_to object="$ship" relation="enemy" comparison="le"/>
          </find_ship>
          
          <do_if value="$hostiles.count gt 0">
            <!-- Get pilot skill -->
            <set_value name="$pilotLevel" exact="1"/>
            <do_if value="$ship.pilot? and global.$GT_Pilots.{$ship.pilot}?">
              <set_value name="$pilotLevel" exact="@global.$GT_Pilots.{$ship.pilot}.$Level"/>
            </do_if>
            
            <!-- Calculate threat with detailed ship class & faction analysis -->
            <set_value name="$threatScore" exact="0"/>
            <set_value name="$shipClass_XL" exact="0"/>
            <set_value name="$shipClass_L" exact="0"/>
            <set_value name="$shipClass_M" exact="0"/>
            <set_value name="$shipClass_S" exact="0"/>
            <set_value name="$factionCounts" exact="table[]"/> <!-- Track faction counts -->
            
            <do_all exact="$hostiles.count" counter="$h">
              <set_value name="$hostile" exact="$hostiles.{$h}"/>
              
              <!-- Count by ship class -->
              <do_if value="$hostile.isclass.ship_xl">
                <set_value name="$threatScore" exact="$threatScore + 5"/>
                <set_value name="$shipClass_XL" operation="add"/>
              </do_if>
              <do_elseif value="$hostile.isclass.ship_l">
                <set_value name="$threatScore" exact="$threatScore + 3"/>
                <set_value name="$shipClass_L" operation="add"/>
              </do_elseif>
              <do_elseif value="$hostile.isclass.ship_m">
                <set_value name="$threatScore" exact="$threatScore + 2"/>
                <set_value name="$shipClass_M" operation="add"/>
              </do_elseif>
              <do_else>
                <set_value name="$threatScore" exact="$threatScore + 1"/>
                <set_value name="$shipClass_S" operation="add"/>
              </do_else>
              
              <!-- Track faction counts -->
              <do_if value="$hostile.owner?">
                <set_value name="$faction" exact="$hostile.owner"/>
                <set_value name="$factionCounts.{$faction}" exact="@$factionCounts.{$faction} + 1"/>
              </do_if>
            </do_all>
            
            <!-- Find dominant faction (most ships) -->
            <set_value name="$primaryFaction" exact="null"/>
            <set_value name="$maxCount" exact="0"/>
            <do_all exact="$factionCounts.keys.count" counter="$f">
              <set_value name="$faction" exact="$factionCounts.keys.{$f}"/>
              <do_if value="$factionCounts.{$faction} gt $maxCount">
                <set_value name="$primaryFaction" exact="$faction"/>
                <set_value name="$maxCount" exact="$factionCounts.{$faction}"/>
              </do_if>
            </do_all>
            
            <!-- Build ship class summary string -->
            <set_value name="$classBreakdown" exact="''"/>
            <do_if value="$shipClass_XL gt 0">
              <set_value name="$classBreakdown" exact="$classBreakdown + $shipClass_XL + 'XL '"/>
            </do_if>
            <do_if value="$shipClass_L gt 0">
              <set_value name="$classBreakdown" exact="$classBreakdown + $shipClass_L + 'L '"/>
            </do_if>
            <do_if value="$shipClass_M gt 0">
              <set_value name="$classBreakdown" exact="$classBreakdown + $shipClass_M + 'M '"/>
            </do_if>
            <do_if value="$shipClass_S gt 0">
              <set_value name="$classBreakdown" exact="$classBreakdown + $shipClass_S + 'S'"/>
            </do_if>
            
            <!-- Only Level 6+ pilots report sector intel -->
            <do_if value="$pilotLevel ge 6">
              <signal_objects object="player.galaxy" param="'GT_Threat_Warning'" param2="table[
                $Sector = $trade.$BuyOffer.owner.sector,
                $DetectedBy = $ship,
                $HostileCount = $hostiles.count,
                $PrimaryFaction = $primaryFaction,
                $ShipClass_XL = $shipClass_XL,
                $ShipClass_L = $shipClass_L,
                $ShipClass_M = $shipClass_M,
                $ShipClass_S = $shipClass_S,
                $ThreatScore = $threatScore,
                $Timestamp = player.age
              ]"/>
              
              <set_value name="$factionName" exact="if $primaryFaction then $primaryFaction.knownname else 'Unknown'"/>
              <debug_text text="'[GT-Threat] ðŸ” ' + $ship.knownname + ' (Pilot Lv.' + $pilotLevel + ') detected hostiles in destination ' + $trade.$BuyOffer.owner.sector.knownname + '\n  âš” Hostiles: ' + $hostiles.count + ' (' + $classBreakdown + ') - Threat: ' + $threatScore + '\n  ðŸ´ Primary Faction: ' + $factionName + ' - FLEET WARNING BROADCAST'" chance="100"/>
            </do_if>
            <do_else>
              <debug_text text="'[GT-Threat] ðŸ” ' + $ship.knownname + ' (Pilot Lv.' + $pilotLevel + ') detected threats in destination but lacks experience to report (requires Lv.6+)'" chance="100"/>
            </do_else>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Fleet Threat Warning Receiver -->
    <cue name="ReceiveThreatWarning" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Threat_Warning'"/>
      </conditions>
      <actions>
        <set_value name="$warning" exact="event.param2"/>
        <set_value name="$sector" exact="$warning.$Sector"/>
        <set_value name="$detectedBy" exact="$warning.$DetectedBy"/>
        <set_value name="$hostileCount" exact="$warning.$HostileCount"/>
        <set_value name="$threatScore" exact="$warning.$ThreatScore"/>
        <set_value name="$primaryFaction" exact="$warning.$PrimaryFaction"/>
        <set_value name="$shipClass_XL" exact="$warning.$ShipClass_XL"/>
        <set_value name="$shipClass_L" exact="$warning.$ShipClass_L"/>
        <set_value name="$shipClass_M" exact="$warning.$ShipClass_M"/>
        <set_value name="$shipClass_S" exact="$warning.$ShipClass_S"/>
        <set_value name="$capitalShips" exact="$shipClass_XL + $shipClass_L"/>
        
        <!-- Update threat intelligence database -->
        <do_if value="not global.$GT_ThreatIntelligence?">
          <set_value name="global.$GT_ThreatIntelligence" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_ThreatIntelligence.{$sector}?">
          <set_value name="global.$GT_ThreatIntelligence.{$sector}" exact="table[]"/>
        </do_if>
        
        <!-- Calculate threat level (1-5) -->
        <set_value name="$threatLevel" exact="2"/> <!-- Base: hostiles present -->
        <do_if value="$capitalShips gt 0">
          <set_value name="$threatLevel" exact="4"/> <!-- High: capital ships -->
        </do_if>
        <do_elseif value="$threatScore ge 6">
          <set_value name="$threatLevel" exact="3"/> <!-- Medium-High: multiple hostiles -->
        </do_elseif>
        
        <set_value name="global.$GT_ThreatIntelligence.{$sector}.$ThreatLevel" exact="$threatLevel"/>
        <set_value name="global.$GT_ThreatIntelligence.{$sector}.$HostileCount" exact="$hostileCount"/>
        <set_value name="global.$GT_ThreatIntelligence.{$sector}.$ThreatScore" exact="$threatScore"/>
        <set_value name="global.$GT_ThreatIntelligence.{$sector}.$Timestamp" exact="player.age"/>
        <set_value name="global.$GT_ThreatIntelligence.{$sector}.$DetectedBy" exact="$detectedBy.knownname"/>
        <set_value name="global.$GT_ThreatIntelligence.{$sector}.$ThreatType" exact="'Real-Time Detection'"/>
        <set_value name="global.$GT_ThreatIntelligence.{$sector}.$PrimaryFaction" exact="if $primaryFaction then $primaryFaction.knownname else 'Unknown'"/>
        <set_value name="global.$GT_ThreatIntelligence.{$sector}.$ShipClass_XL" exact="$shipClass_XL"/>
        <set_value name="global.$GT_ThreatIntelligence.{$sector}.$ShipClass_L" exact="$shipClass_L"/>
        <set_value name="global.$GT_ThreatIntelligence.{$sector}.$ShipClass_M" exact="$shipClass_M"/>
        <set_value name="global.$GT_ThreatIntelligence.{$sector}.$ShipClass_S" exact="$shipClass_S"/>
        
        <!-- Build ship class breakdown for display -->
        <set_value name="$classBreakdown" exact="''"/>
        <do_if value="$shipClass_XL gt 0">
          <set_value name="$classBreakdown" exact="$classBreakdown + $shipClass_XL + ' XL'"/>
        </do_if>
        <do_if value="$shipClass_L gt 0">
          <set_value name="$classBreakdown" exact="$classBreakdown + (if $classBreakdown then ', ' else '') + $shipClass_L + ' L'"/>
        </do_if>
        <do_if value="$shipClass_M gt 0">
          <set_value name="$classBreakdown" exact="$classBreakdown + (if $classBreakdown then ', ' else '') + $shipClass_M + ' M'"/>
        </do_if>
        <do_if value="$shipClass_S gt 0">
          <set_value name="$classBreakdown" exact="$classBreakdown + (if $classBreakdown then ', ' else '') + $shipClass_S + ' S'"/>
        </do_if>
        
        <!-- Log to player if significant threat (capital ships or high threat) -->
        <do_if value="$capitalShips gt 0 or $threatLevel ge 3">
          <set_value name="$threatDesc" exact="if $threatLevel == 5 then 'CRITICAL' else if $threatLevel == 4 then 'HIGH' else 'MEDIUM'"/>
          <set_value name="$factionName" exact="if $primaryFaction then $primaryFaction.knownname else 'Unknown'"/>
          
          <set_value name="$logMessage" exact="'FLEET THREAT ALERT\n\n'"/>
          <set_value name="$logMessage" exact="$logMessage + $detectedBy.knownname + ' encountered hostile forces in ' + $sector.knownname + '\n\n'"/>
          <set_value name="$logMessage" exact="$logMessage + 'Threat Level: ' + $threatDesc + ' (' + $threatLevel + '/5)\n'"/>
          <set_value name="$logMessage" exact="$logMessage + 'Hostile Faction: ' + $factionName + '\n'"/>
          <set_value name="$logMessage" exact="$logMessage + 'Hostile Ships: ' + $hostileCount + ' (' + $classBreakdown + ')\n'"/>
          <set_value name="$logMessage" exact="$logMessage + '\nAll trading ships are advised to avoid this sector until the threat clears.'"/>
          
          <write_to_logbook 
            category="alerts" 
            title="'Fleet Alert: ' + $factionName + ' Hostiles in ' + $sector.knownname" 
            text="$logMessage"
            object="player.entity"/>
        </do_if>
        
        <debug_text text="'[GT-Threat] ðŸ“¡ Fleet warning received: ' + $hostileCount + ' hostile(s) in ' + $sector.knownname + ' (' + $classBreakdown + ') - Faction: ' + (if $primaryFaction then $primaryFaction.knownname else 'Unknown') + ' - Level ' + $threatLevel + ', detected by ' + $detectedBy.knownname" chance="100"/>
      </actions>
    </cue>
    
    <!-- ========================================================================= -->
    <!-- DYNAMIC BLACKLIST INTEGRATION                                            -->
    <!-- ========================================================================= -->
    
    <!-- Initialize blacklist integration after Lua module loads -->
    <cue name="InitializeBlacklistIntegration" instantiate="true">
      <conditions>
        <event_ui_triggered screen="'Lua_Loader'" 
          control="'Loaded extensions.galaxytradermk3.ui.gt_blacklist_manager'" />
      </conditions>
      <actions>
        <!-- Initialize Lua blacklist manager -->
        <raise_lua_event name="'GT_Blacklist.Initialize'" param="'startup'"/>
        
        <debug_text text="'[GalaxyTrader MK3] Initializing dynamic blacklist integration...'" chance="100"/>
        
        <!-- Perform initial sync of threat data -->
        <signal_cue_instantly cue="SyncThreatsToBlacklist"/>
        
        <!-- Start fleet application cycle -->
        <signal_cue_instantly cue="ApplyBlacklistToFleet"/>
        
        <!-- Start cleanup cycle -->
        <signal_cue_instantly cue="CleanupExpiredThreats_Blacklist"/>
      </actions>
    </cue>
    
    <!-- Periodic sync of threat data to Lua blacklist manager -->
    <cue name="SyncThreatsToBlacklist" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <delay exact="5s"/> <!-- Sync every 5 seconds -->
      <actions>
        <!-- Only sync if dynamic blacklist is enabled -->
        <do_if value="@global.$GT_GlobalSettings.$ThreatAvoidance.$UseDynamicBlacklist">
          <do_if value="global.$GT_ThreatIntelligence?">
            <!-- Build threat data string for Lua -->
            <set_value name="$threatDataString" exact="''"/>
            <set_value name="$threatCount" exact="0"/>
            
            <do_all exact="global.$GT_ThreatIntelligence.keys.count" counter="$i">
              <set_value name="$sector" exact="global.$GT_ThreatIntelligence.keys.list.{$i}"/>
              <set_value name="$threatData" exact="global.$GT_ThreatIntelligence.{$sector}"/>
              
              <do_if value="$threatData.$ThreatLevel? and $threatData.$Timestamp?">
                <!-- Format: "sector_macro:level:timestamp|" (send macro directly for Lua) -->
                <set_value name="$sectorMacro" exact="@$sector.macro.id"/> <!-- Get sector's macro ID -->
                <set_value name="$entry" exact="$sectorMacro + ':' + $threatData.$ThreatLevel + ':' + $threatData.$Timestamp"/>
                
                <do_if value="$threatDataString == ''">
                  <set_value name="$threatDataString" exact="$entry"/>
                </do_if>
                <do_else>
                  <set_value name="$threatDataString" exact="$threatDataString + '|' + $entry"/>
                </do_else>
                
                <set_value name="$threatCount" exact="$threatCount + 1"/>
              </do_if>
            </do_all>
            
            <!-- Send to Lua blacklist manager -->
            <do_if value="$threatCount gt 0">
              <raise_lua_event name="'GT_Blacklist.Update'" param="$threatDataString"/>
              
              <debug_text text="'[GT-Blacklist] Synced ' + $threatCount + ' threats to Lua manager'" chance="0"/>
            </do_if>
            <do_else>
              <!-- No threats - clear blacklist -->
              <raise_lua_event name="'GT_Blacklist.Update'" param="''"/>
            </do_else>
          </do_if>
        </do_if>
      </actions>
      <cues>
        <cue name="SyncThreatsToBlacklist_Delay">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <delay exact="5s"/>
          <actions>
            <!-- Continue syncing -->
            <signal_cue_instantly cue="SyncThreatsToBlacklist"/>
          </actions>
        </cue>
      </cues>
    </cue>
    
    <!-- Apply blacklist to all GT ships automatically -->
    <cue name="ApplyBlacklistToFleet" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <delay exact="10s"/> <!-- Apply every 10 seconds -->
      <actions>
        <debug_text text="'[GT-Blacklist] ApplyBlacklistToFleet triggered - UseDynamicBlacklist: ' + @global.$GT_GlobalSettings.$ThreatAvoidance.$UseDynamicBlacklist + ', GT_Ships exists: ' + global.$GT_Ships?" chance="100"/>
        
        <do_if value="@global.$GT_GlobalSettings.$ThreatAvoidance.$UseDynamicBlacklist">
          <!-- Setting ENABLED - apply blacklists to all ships -->
          <do_if value="global.$GT_Ships?">
            <!-- Build ship list string -->
            <set_value name="$shipListString" exact="''"/>
            <set_value name="$shipCount" exact="0"/>
            
            <debug_text text="'[GT-Blacklist] Found ' + global.$GT_Ships.keys.count + ' registered GT ships'" chance="100"/>
            
            <!-- Only apply blacklist to non-subordinate ships (solo + commanders) - subordinates inherit automatically -->
            <do_all exact="global.$GT_Ships.keys.count" counter="$i">
              <set_value name="$ship" exact="global.$GT_Ships.keys.list.{$i}"/>
              
              <!-- Check: operational AND not a subordinate (check live commander status, not cached data) -->
              <do_if value="$ship.isoperational and not ($ship.commander and $ship.commander != $ship)">
                <do_if value="$shipListString == ''">
                  <set_value name="$shipListString" exact="$ship"/>
                </do_if>
                <do_else>
                  <set_value name="$shipListString" exact="$shipListString + ',' + $ship"/>
                </do_else>
                <set_value name="$shipCount" operation="add"/>
              </do_if>
            </do_all>
            
            <!-- Apply to fleet -->
            <do_if value="$shipListString != ''">
              <debug_text text="'[GT-Blacklist] Applying blacklist to ' + $shipCount + ' non-subordinate ships (subordinates inherit from commanders)'" chance="100"/>
              <raise_lua_event name="'GT_Blacklist.ApplyToFleet'" param="$shipListString"/>
            </do_if>
            <do_else>
              <debug_text text="'[GT-Blacklist] No operational non-subordinate ships found'" chance="100"/>
            </do_else>
          </do_if>
          <do_else>
            <debug_text text="'[GT-Blacklist] global.$GT_Ships not found - no ships registered yet'" chance="100"/>
          </do_else>
        </do_if>
        <do_else>
          <!-- Setting DISABLED - remove blacklists from non-subordinate ships only -->
          <debug_text text="'[GT-Blacklist] Dynamic blacklist is DISABLED in settings'" chance="100"/>
          
          <do_if value="global.$GT_Ships?">
            <!-- Only remove from non-subordinate ships (solo + commanders) - subordinates inherit automatically -->
            <do_all exact="global.$GT_Ships.keys.count" counter="$i">
              <set_value name="$ship" exact="global.$GT_Ships.keys.list.{$i}"/>
              
              <do_if value="$ship.isoperational and not ($ship.commander and $ship.commander != $ship)">
                <raise_lua_event name="'GT_Blacklist.RemoveFromShip'" param="$ship"/>
              </do_if>
            </do_all>
          </do_if>
        </do_else>
      </actions>
      <cues>
        <cue name="ApplyBlacklistToFleet_Delay">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <delay exact="10s"/>
          <actions>
            <!-- Continue applying -->
            <signal_cue_instantly cue="ApplyBlacklistToFleet"/>
          </actions>
        </cue>
      </cues>
    </cue>
    
    <!-- Cleanup expired threats -->
    <cue name="CleanupExpiredThreats_Blacklist" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <delay exact="600s"/> <!-- Cleanup every 10 minutes -->
      <actions>
        <!-- Only cleanup if dynamic blacklist is enabled -->
        <do_if value="@global.$GT_GlobalSettings.$ThreatAvoidance.$UseDynamicBlacklist">
          <set_value name="$currentTime" exact="player.age"/>
          <set_value name="$expiryTime" exact="@global.$GT_GlobalSettings.$ThreatAvoidance.$ThreatExpiry"/>
          
          <do_if value="not $expiryTime?">
            <set_value name="$expiryTime" exact="3600"/> <!-- Default 1 hour -->
          </do_if>
          
          <!-- Signal Lua to cleanup -->
          <raise_lua_event name="'GT_Blacklist.CleanupExpired'" param="$currentTime + ':' + $expiryTime"/>
        </do_if>
      </actions>
      <cues>
        <cue name="CleanupExpiredThreats_Delay">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <delay exact="600s"/>
          <actions>
            <!-- Continue cleanup -->
            <signal_cue_instantly cue="CleanupExpiredThreats_Blacklist"/>
          </actions>
        </cue>
      </cues>
    </cue>
    
  </cues>
  
</mdscript> 
