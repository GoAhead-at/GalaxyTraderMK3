<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_WareFilter" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ============================================ -->
    <!-- GALAXYTRADER MK3 - WARE FILTER MANAGEMENT   -->
    <!-- ============================================ -->
    <!-- Advanced ware filtering system allowing     -->
    <!-- dynamic blacklist/whitelist management      -->
    <!-- ============================================ -->
    
    <!-- Initialization -->
    <cue name="Init" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_Configuration.ConfigInit"/>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3] Initializing Ware Filter Management System...'" chance="100"/>
        
        <!-- Initialize ware filter data -->
        <set_value name="global.$GT_WareFilter" exact="table[]"/>
        <set_value name="global.$GT_WareFilter.$Statistics" exact="table[]"/>
        <set_value name="global.$GT_WareFilter.$Statistics.$FiltersApplied" exact="0"/>
        <set_value name="global.$GT_WareFilter.$Statistics.$TradesBlocked" exact="0"/>
        <set_value name="global.$GT_WareFilter.$Statistics.$WaresBlocked" exact="table[]"/>
        
        <!-- Initialize dynamic ware lists -->
        <set_value name="global.$GT_WareFilter.$DefaultBlacklist" exact="[]"/>
        <set_value name="global.$GT_WareFilter.$DangerousWares" exact="[]"/>
        <set_value name="global.$GT_WareFilter.$HighValueWares" exact="[]"/>
        <set_value name="global.$GT_WareFilter.$LowValueWares" exact="[]"/>
        
        <!-- Trigger dynamic ware categorization -->
        <signal_cue cue="CategorizeWares"/>
        
        <debug_text text="'[GalaxyTrader MK3] Ware Filter Management System initialized successfully'" chance="100"/>
      </actions>
    </cue>
    
    <!-- Dynamic Ware Categorization -->
    <cue name="CategorizeWares" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3] Categorizing wares dynamically...'" chance="global.$GT_Config.$Debug.$LogLevel ge 1"/>
        
        <!-- Get all available wares by querying trade offers from stations -->
        <find_station name="$stations" space="player.galaxy" multiple="true"/>
        <set_value name="$allWares" exact="[]"/>
        <set_value name="$wareSet" exact="table[]"/>
        
        <!-- Collect unique wares from all trade offers -->
        <do_all exact="$stations.count" counter="$i">
          <set_value name="$station" exact="$stations.{$i}"/>
          
          <!-- Get buy offers -->
          <find_buy_offer buyer="$station" result="$buyOffers" multiple="true">
            <match_buyer tradesknownto="faction.player"/>
          </find_buy_offer>
          <do_all exact="$buyOffers.count" counter="$j">
            <set_value name="$ware" exact="$buyOffers.{$j}.ware"/>
            <do_if value="$ware.exists and not $wareSet.{$ware}?">
              <set_value name="$wareSet.{$ware}" exact="true"/>
              <append_to_list name="$allWares" exact="$ware"/>
            </do_if>
          </do_all>
          
          <!-- Get sell offers -->
          <find_sell_offer seller="$station" result="$sellOffers" multiple="true">
            <match_seller tradesknownto="faction.player"/>
          </find_sell_offer>
          <do_all exact="$sellOffers.count" counter="$k">
            <set_value name="$ware" exact="$sellOffers.{$k}.ware"/>
            <do_if value="$ware.exists and not $wareSet.{$ware}?">
              <set_value name="$wareSet.{$ware}" exact="true"/>
              <append_to_list name="$allWares" exact="$ware"/>
            </do_if>
          </do_all>
        </do_all>
        
        <debug_text text="'[GalaxyTrader MK3] Found ' + $allWares.count + ' unique wares from trade offers'" chance="global.$GT_Config.$Debug.$LogLevel ge 1"/>
        
        <!-- Categorize wares based on properties and tags -->
        <do_all exact="$allWares.count" counter="$i">
          <set_value name="$ware" exact="$allWares.{$i}"/>
          
          <!-- Skip invalid wares -->
          <do_if value="$ware.exists">
            <!-- Check for low-value/problematic wares -->
            <set_value name="$isLowValue" exact="false"/>
            <set_value name="$isDangerous" exact="false"/>
            <set_value name="$isHighValue" exact="false"/>
            
            <!-- Safely get ware properties -->
            <set_value name="$wareVolume" exact="@$ware.volume"/>
            <set_value name="$warePrice" exact="@$ware.price"/>
            <set_value name="$wareName" exact="@$ware.name"/>
            <set_value name="$wareIllegal" exact="@$ware.illegal"/>
            
            <!-- Get configurable thresholds -->
            <set_value name="$lowValueThreshold" exact="@global.$GT_Config.$WareFilter.$LowValueThreshold"/>
            <set_value name="$highValueThreshold" exact="@global.$GT_Config.$WareFilter.$HighValueThreshold"/>
            <set_value name="$autoCategorizeLowValue" exact="@global.$GT_Config.$WareFilter.$AutoCategorizeLowValue"/>
            <set_value name="$autoCategorizeDangerous" exact="@global.$GT_Config.$WareFilter.$AutoCategorizeDangerous"/>
            
            <!-- Low-value ware detection using configurable threshold -->
            <do_if value="$autoCategorizeLowValue and $warePrice le $lowValueThreshold">
              <set_value name="$isLowValue" exact="true"/>
            </do_if>
            
            <!-- Detect wares with typically low profit margins -->
            <do_if value="$autoCategorizeLowValue and $wareName">
              <set_value name="$nameCheck" exact="$wareName.tolowercase"/>
              <do_if value="$nameCheck.indexof.{'food'} != -1 or $nameCheck.indexof.{'medical'} != -1 or $nameCheck.indexof.{'energy'} != -1 or $nameCheck.indexof.{'ration'} != -1">
                <set_value name="$isLowValue" exact="true"/>
              </do_if>
            </do_if>
            
            <!-- High-value ware detection using configurable threshold -->
            <do_if value="$warePrice ge $highValueThreshold">
              <set_value name="$isHighValue" exact="true"/>
            </do_if>
            
            <!-- Detect high-tech components by name -->
            <do_if value="$wareName">
              <set_value name="$nameCheck" exact="$wareName.tolowercase"/>
              <do_if value="$nameCheck.indexof.{'advanced'} != -1 or $nameCheck.indexof.{'quantum'} != -1 or $nameCheck.indexof.{'smart'} != -1 or $nameCheck.indexof.{'microchip'} != -1">
                <set_value name="$isHighValue" exact="true"/>
              </do_if>
            </do_if>
            
            <!-- Dangerous ware detection (illegal, restricted) -->
            <do_if value="$autoCategorizeDangerous and $wareIllegal">
              <set_value name="$isDangerous" exact="true"/>
            </do_if>
            
            <!-- Add to appropriate lists -->
            <do_if value="$isLowValue">
              <append_to_list name="global.$GT_WareFilter.$LowValueWares" exact="$ware"/>
              <append_to_list name="global.$GT_WareFilter.$DefaultBlacklist" exact="$ware"/>
            </do_if>
            
            <do_if value="$isDangerous">
              <append_to_list name="global.$GT_WareFilter.$DangerousWares" exact="$ware"/>
            </do_if>
            
            <do_if value="$isHighValue">
              <append_to_list name="global.$GT_WareFilter.$HighValueWares" exact="$ware"/>
            </do_if>
          </do_if>
        </do_all>
        
        <!-- Log categorization results -->
        <debug_text text="'[GalaxyTrader MK3] Ware categorization complete:'" chance="global.$GT_Config.$Debug.$LogLevel ge 1"/>
        <debug_text text="'  - Low Value/Default Blacklisted: ' + global.$GT_WareFilter.$LowValueWares.count" chance="global.$GT_Config.$Debug.$LogLevel ge 1"/>
        <debug_text text="'  - Dangerous Wares: ' + global.$GT_WareFilter.$DangerousWares.count" chance="global.$GT_Config.$Debug.$LogLevel ge 1"/>
        <debug_text text="'  - High Value Wares: ' + global.$GT_WareFilter.$HighValueWares.count" chance="global.$GT_Config.$Debug.$LogLevel ge 1"/>
        
        <!-- Initialize configuration with dynamic defaults -->
        <do_if value="not global.$GT_Config.$WareFilter.$BlacklistedWares? or global.$GT_Config.$WareFilter.$BlacklistedWares.count == 0">
          <set_value name="global.$GT_Config.$WareFilter.$BlacklistedWares" exact="global.$GT_WareFilter.$DefaultBlacklist"/>
        </do_if>
        
        <do_if value="not global.$GT_Config.$WareFilter.$WhitelistedWares?">
          <set_value name="global.$GT_Config.$WareFilter.$WhitelistedWares" exact="[]"/>
        </do_if>
        
        <!-- Show categorization summary -->
        <run_actions ref="md.GT_Utilities.GT_ShowNotification">
          <param name="text" value="$allWares.count + ' wares categorized: ' + global.$GT_WareFilter.$LowValueWares.count + ' low-value, ' + global.$GT_WareFilter.$DangerousWares.count + ' dangerous, ' + global.$GT_WareFilter.$HighValueWares.count + ' high-value'"/>
          <param name="category" value="'upkeep'"/>
          <param name="timeout" value="8s"/>
        </run_actions>
      </actions>
    </cue>
    
    <!-- Periodic Ware Refresh - Safety mechanism for mod compatibility (2 hour interval) -->
    <cue name="RefreshWareCategories" instantiate="true" checkinterval="7200s">
      <conditions>
        <check_value value="global.$GT_WareFilter?"/>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3] Refreshing ware categories (periodic)...'" chance="global.$GT_Config.$Debug.$LogLevel ge 1"/>
        
        <!-- Re-categorize wares to catch new ones from other mods -->
        <signal_cue cue="CategorizeWares"/>
      </actions>
    </cue>
    
    <!-- Manual Ware Refresh -->
    <cue name="RefreshWaresOnDemand" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3] Refreshing ware categories (manual)...'" chance="100"/>
        
        <!-- Clear existing categories -->
        <set_value name="global.$GT_WareFilter.$DefaultBlacklist" exact="[]"/>
        <set_value name="global.$GT_WareFilter.$DangerousWares" exact="[]"/>
        <set_value name="global.$GT_WareFilter.$HighValueWares" exact="[]"/>
        <set_value name="global.$GT_WareFilter.$LowValueWares" exact="[]"/>
        
        <!-- Re-categorize -->
        <signal_cue cue="CategorizeWares"/>
        
        <run_actions ref="md.GT_Utilities.GT_ShowNotification">
          <param name="text" value="'Ware categories refreshed from current game state'"/>
          <param name="category" value="'upkeep'"/>
          <param name="timeout" value="5s"/>
        </run_actions>
      </actions>
    </cue>
    
    <!-- Dynamic Blacklist Management -->
    <cue name="AddToBlacklist" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$ware" exact="event.param"/>
        
        <do_if value="$ware">
          <!-- Check if already blacklisted -->
          <set_value name="$alreadyBlacklisted" exact="false"/>
          <do_if value="global.$GT_Config.$WareFilter.$BlacklistedWares?">
            <do_all exact="global.$GT_Config.$WareFilter.$BlacklistedWares.count" counter="$i">
              <do_if value="global.$GT_Config.$WareFilter.$BlacklistedWares.{$i} == $ware">
                <set_value name="$alreadyBlacklisted" exact="true"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>
          
          <do_if value="not $alreadyBlacklisted">
            <!-- Add to blacklist -->
            <append_to_list name="global.$GT_Config.$WareFilter.$BlacklistedWares" exact="$ware"/>
            
            <!-- Send notification -->
            <run_actions ref="md.GT_Utilities.GT_ShowNotification">
              <param name="text" value="'Ware ' + $ware.name + ' added to blacklist'"/>
              <param name="category" value="'upkeep'"/>
              <param name="timeout" value="5s"/>
            </run_actions>
            
            <!-- Update statistics -->
            <set_value name="global.$GT_WareFilter.$Statistics.$FiltersApplied" exact="global.$GT_WareFilter.$Statistics.$FiltersApplied + 1"/>
            
            <debug_text text="'[GalaxyTrader MK3] Added ' + $ware + ' to blacklist'" chance="100"/>
          </do_if>
          <do_else>
            <debug_text text="'[GalaxyTrader MK3] Ware ' + $ware + ' already blacklisted'" chance="100"/>
          </do_else>
        </do_if>
      </actions>
    </cue>
    
    <!-- Remove from Blacklist -->
    <cue name="RemoveFromBlacklist" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$ware" exact="event.param"/>
        
        <do_if value="$ware and global.$GT_Config.$WareFilter.$BlacklistedWares?">
          <set_value name="$found" exact="false"/>
          <do_all exact="global.$GT_Config.$WareFilter.$BlacklistedWares.count" counter="$i">
            <do_if value="global.$GT_Config.$WareFilter.$BlacklistedWares.{$i} == $ware">
              <remove_value name="global.$GT_Config.$WareFilter.$BlacklistedWares.{$i}"/>
              <set_value name="$found" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          
          <do_if value="$found">
            <!-- Send notification -->
            <run_actions ref="md.GT_Utilities.GT_ShowNotification">
              <param name="text" value="'Ware ' + $ware.name + ' removed from blacklist'"/>
              <param name="category" value="'upkeep'"/>
              <param name="timeout" value="5s"/>
            </run_actions>
            
            <debug_text text="'[GalaxyTrader MK3] Removed ' + $ware + ' from blacklist'" chance="100"/>
          </do_if>
          <do_else>
            <debug_text text="'[GalaxyTrader MK3] Ware ' + $ware + ' not found in blacklist'" chance="100"/>
          </do_else>
        </do_if>
      </actions>
    </cue>
    
    <!-- Auto-Blacklist Based on Performance -->
    <cue name="AutoBlacklistAnalysis" instantiate="true" checkinterval="1800s">
      <conditions>
        <check_value value="global.$GT_Config.$WareFilter? and global.$GT_Ships.keys.count gt 0"/>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3] Running auto-blacklist analysis...'" chance="global.$GT_Config.$Debug.$LogLevel ge 1"/>
        
        <!-- Analyze poor-performing wares -->
        <set_value name="$poorWares" exact="[]"/>
        
        <!-- Check each ship's trading history -->
        <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
          <set_value name="$shipKeys" exact="global.$GT_Ships.keys.list"/>
          <do_all exact="$shipKeys.count" counter="$i">
            <set_value name="$ship" exact="$shipKeys.{$i}"/>
          
          <!-- Analyze ship's recent trades -->
          <do_if value="global.$GT_Ships.{$ship}.$TradeHistory?">
            <!-- Look for consistently unprofitable wares -->
            <do_all exact="global.$GT_Ships.{$ship}.$TradeHistory.keys.count" counter="$j">
              <set_value name="$ware" exact="global.$GT_Ships.{$ship}.$TradeHistory.keys.list.{$j}"/>
              <set_value name="$wareData" exact="global.$GT_Ships.{$ship}.$TradeHistory.{$ware}"/>
              
              <!-- Check if ware has poor profit ratio -->
              <do_if value="$wareData.$TotalTrades ge 5 and ($wareData.$TotalProfit / $wareData.$TotalTrades) lt 100000"> <!-- 1000 Cr in RAW format -->
                <do_if value="$poorWares.indexof.{$ware} == -1">
                  <append_to_list name="$poorWares" exact="$ware"/>
                </do_if>
              </do_if>
            </do_all>
          </do_if>
          </do_all>
        </do_if>
        
        <!-- Auto-blacklist consistently poor wares -->
        <do_all exact="$poorWares.count" counter="$k">
          <set_value name="$ware" exact="$poorWares.{$k}"/>
          
          <!-- Only auto-blacklist if not already handled -->
          <run_actions ref="md.GT_Utilities.GT_IsWareAllowed">
            <param name="ware" value="$ware"/>
          </run_actions>
          
                     <do_if value="$return">
             <signal_cue_instantly cue="AddToBlacklist" param="$ware"/>
             
             <run_actions ref="md.GT_Utilities.GT_ShowNotification">
               <param name="text" value="'Auto-blacklisted poor performer: ' + $ware.name"/>
               <param name="category" value="'info'"/>
               <param name="timeout" value="8s"/>
             </run_actions>
           </do_if>
        </do_all>
      </actions>
    </cue>
    
    <!-- Whitelist Management -->
    <cue name="AddToWhitelist" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$ware" exact="event.param"/>
        
        <do_if value="$ware">
          <!-- Check if already whitelisted -->
          <set_value name="$alreadyWhitelisted" exact="false"/>
          <do_if value="global.$GT_Config.$WareFilter.$WhitelistedWares?">
            <do_all exact="global.$GT_Config.$WareFilter.$WhitelistedWares.count" counter="$i">
              <do_if value="global.$GT_Config.$WareFilter.$WhitelistedWares.{$i} == $ware">
                <set_value name="$alreadyWhitelisted" exact="true"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>
          
          <do_if value="not $alreadyWhitelisted">
            <append_to_list name="global.$GT_Config.$WareFilter.$WhitelistedWares" exact="$ware"/>
            
            <run_actions ref="md.GT_Utilities.GT_ShowNotification">
              <param name="text" value="'Ware ' + $ware.name + ' added to whitelist'"/>
              <param name="category" value="'upkeep'"/>
              <param name="timeout" value="5s"/>
            </run_actions>
            
            <debug_text text="'[GalaxyTrader MK3] Added ' + $ware + ' to whitelist'" chance="100"/>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Dangerous Ware Handler -->
    <cue name="DangerousWareDetected" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$ware" exact="event.param"/>
        <set_value name="$ship" exact="event.param2"/>
        
        <!-- Handle based on dangerous ware policy -->
        <do_if value="global.$GT_Config.$WareFilter.$DangerousWareHandling == 'priority'">
          <!-- Prioritize dangerous wares for higher profits -->
          <run_actions ref="md.GT_Utilities.GT_ShowNotification">
            <param name="text" value="'Prioritizing dangerous ware: ' + $ware.name"/>
            <param name="category" value="'upkeep'"/>
            <param name="timeout" value="6s"/>
          </run_actions>
        </do_if>
                 <do_elseif value="global.$GT_Config.$WareFilter.$DangerousWareHandling == 'avoid'">
           <!-- Add to temporary blacklist -->
           <signal_cue_instantly cue="AddToBlacklist" param="$ware"/>
         </do_elseif>
      </actions>
    </cue>
    
    <!-- Filter Statistics Reporter - Safety mechanism for performance monitoring (2 hour interval) -->
    <cue name="FilterStatsReport" instantiate="true" checkinterval="7200s">
      <conditions>
        <check_value value="global.$GT_WareFilter.$Statistics?"/>
      </conditions>
      <actions>
        <!-- Generate filter effectiveness report -->
        <set_value name="$totalFilters" exact="global.$GT_WareFilter.$Statistics.$FiltersApplied"/>
        <set_value name="$totalBlocked" exact="global.$GT_WareFilter.$Statistics.$TradesBlocked"/>
        
        <do_if value="$totalFilters gt 0">
          <run_actions ref="md.GT_Utilities.GT_ShowNotification">
            <param name="text" value="'Ware filters: ' + $totalFilters + ' active, ' + $totalBlocked + ' trades blocked'"/>
            <param name="category" value="'info'"/>
            <param name="timeout" value="10s"/>
          </run_actions>
          
          <debug_text text="'[GalaxyTrader MK3] Filter stats - Active: ' + $totalFilters + ', Blocked: ' + $totalBlocked" chance="global.$GT_Config.$Debug.$LogLevel ge 1"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Clear All Filters -->
    <cue name="ClearAllFilters" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3] Clearing all ware filters...'" chance="100"/>
        
        <!-- Clear blacklist -->
        <set_value name="global.$GT_Config.$WareFilter.$BlacklistedWares" exact="[]"/>
        
        <!-- Clear whitelist -->
        <set_value name="global.$GT_Config.$WareFilter.$WhitelistedWares" exact="[]"/>
        
        <!-- Reset statistics -->
        <set_value name="global.$GT_WareFilter.$Statistics.$FiltersApplied" exact="0"/>
        <set_value name="global.$GT_WareFilter.$Statistics.$TradesBlocked" exact="0"/>
        <set_value name="global.$GT_WareFilter.$Statistics.$WaresBlocked" exact="table[]"/>
        
        <run_actions ref="md.GT_Utilities.GT_ShowNotification">
          <param name="text" value="'All ware filters cleared'"/>
          <param name="category" value="'upkeep'"/>
          <param name="timeout" value="5s"/>
        </run_actions>
      </actions>
    </cue>
    
    <!-- Reset to Defaults -->
    <cue name="ResetToDefaults" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3] Resetting filters to defaults...'" chance="100"/>
        
        <!-- Reset to default blacklist -->
        <set_value name="global.$GT_Config.$WareFilter.$BlacklistedWares" exact="global.$GT_WareFilter.$DefaultBlacklist"/>
        
        <!-- Clear whitelist -->
        <set_value name="global.$GT_Config.$WareFilter.$WhitelistedWares" exact="[]"/>
        
        <!-- Reset dangerous ware handling -->
        <set_value name="global.$GT_Config.$WareFilter.$DangerousWareHandling" exact="'avoid'"/>
        
        <run_actions ref="md.GT_Utilities.GT_ShowNotification">
          <param name="text" value="'Ware filters reset to defaults'"/>
          <param name="category" value="'upkeep'"/>
          <param name="timeout" value="5s"/>
        </run_actions>
      </actions>
    </cue>
    
    <!-- PHASE 4 IMPROVEMENT: Event-Driven Ware Filter Intelligence -->
    <!-- Initialize ware filter event system -->
    <cue name="InitWareFilterEvents" instantiate="true">
      <conditions>
        <event_cue_signalled cue="Init"/>
      </conditions>
      <actions>
        <!-- Initialize ware filter event queue -->
        <set_value name="global.$GT_WareFilterEventQueue" exact="[]"/>
        
        <debug_text text="'[GalaxyTrader MK3] ⚡ Ware filter event system initialized (event-driven)'" chance="100"/>
      </actions>
    </cue>
    
    <!-- Process Ware Filter Events -->
    <!-- ✅ EVENT-DRIVEN: Listen for signal instead of polling -->
    <cue name="ProcessWareFilterEvents" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.GT_WareFilter.ProcessWareFilterEvents"/>
      </conditions>
      <actions>
        
        <do_if value="global.$GT_WareFilterEventQueue? and global.$GT_WareFilterEventQueue.count gt 0">
          <debug_text text="'[GalaxyTrader MK3] ⚡ Processing ' + global.$GT_WareFilterEventQueue.count + ' ware filter events instantly'" chance="100"/>
          
          <!-- Process events in batches to handle high volume -->
          <set_value name="$batchSize" exact="10"/>
          <set_value name="$processedCount" exact="0"/>
          
          <do_all exact="[$batchSize, global.$GT_WareFilterEventQueue.count].min" counter="$i">
            <set_value name="$event" exact="global.$GT_WareFilterEventQueue.{$i}"/>
            <set_value name="$type" exact="$event.$type"/>
            
            <!-- Route to appropriate handler -->
            <do_if value="$type == 'market_change'">
              <signal_cue_instantly cue="HandleMarketChangeEvent" param="$event"/>
            </do_if>
            <do_elseif value="$type == 'trade_failure'">
              <signal_cue_instantly cue="HandleTradeFailureEvent" param="$event"/>
            </do_elseif>
            <do_elseif value="$type == 'ware_performance'">
              <signal_cue_instantly cue="HandleWarePerformanceEvent" param="$event"/>
            </do_elseif>
            <do_elseif value="$type == 'filter_stats'">
              <signal_cue_instantly cue="HandleFilterStatsEvent" param="$event"/>
            </do_elseif>
            
            <set_value name="$processedCount" exact="$processedCount + 1"/>
          </do_all>
          
          <!-- Remove processed events -->
          <do_all exact="$processedCount" counter="$j" reverse="true">
            <remove_value name="global.$GT_WareFilterEventQueue.{$j}"/>
          </do_all>
          
          <!-- If more events remain, schedule next batch -->
          <do_if value="global.$GT_WareFilterEventQueue.count gt 0">
            <!-- ✅ EVENT-DRIVEN: Signal MD cue directly (no polling needed) -->
            <signal_cue_instantly cue="md.GT_WareFilter.ProcessWareFilterEvents"/>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Handle Market Change Events -->
    <cue name="HandleMarketChangeEvent" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$event" exact="event.param"/>
        <set_value name="$ware" exact="$event.$ware"/>
        <set_value name="$changeType" exact="$event.$changeType"/>
        
        <debug_text text="'[GalaxyTrader MK3] Ware filter event: Market change for ' + $ware + ' (' + $changeType + ')'" chance="100"/>
      </actions>
    </cue>
    
    <!-- Handle Trade Failure Events -->
    <cue name="HandleTradeFailureEvent" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$event" exact="event.param"/>
        <set_value name="$ware" exact="$event.$ware"/>
        <set_value name="$ship" exact="$event.$ship"/>
        <set_value name="$reason" exact="$event.$reason"/>
        
        <debug_text text="'[GalaxyTrader MK3] Ware filter event: Trade failure for ' + $ware + ' on ' + $ship.idcode + ' (' + $reason + ')'" chance="100"/>
        
        <!-- Auto-analyze for potential blacklisting -->
        <do_if value="$reason == 'unprofitable' or $reason == 'no_demand'">
          <!-- Add to performance tracking -->
          <set_value name="$performanceData" exact="table[]"/>
          <set_value name="$performanceData.$ware" exact="$ware"/>
          <set_value name="$performanceData.$ship" exact="$ship"/>
          <set_value name="$performanceData.$success" exact="false"/>
          <set_value name="$performanceData.$profit" exact="0"/>
          <signal_cue_instantly cue="TrackWarePerformance" param="$performanceData"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- Handle Ware Performance Events -->
    <cue name="HandleWarePerformanceEvent" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$event" exact="event.param"/>
        <set_value name="$ware" exact="$event.$ware"/>
        <set_value name="$performance" exact="$event.$performance"/>
        
        <debug_text text="'[GalaxyTrader MK3] Ware filter event: Performance update for ' + $ware + ' (score: ' + $performance + ')'" chance="100"/>
        
        <!-- Check for auto-blacklist criteria -->
        <do_if value="$performance lt -50"> <!-- Consistently poor performance -->
          <signal_cue_instantly cue="AddToBlacklist" param="$ware"/>
        </do_if>
        <do_elseif value="$performance gt 100"> <!-- Excellent performance -->
          <!-- Consider for whitelist if not already there -->
          <signal_cue_instantly cue="AddToWhitelist" param="$ware"/>
        </do_elseif>
      </actions>
    </cue>
    
    <!-- Handle Filter Stats Events -->
    <cue name="HandleFilterStatsEvent" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$event" exact="event.param"/>
        <set_value name="$trigger" exact="$event.$trigger"/>
        
        <debug_text text="'[GalaxyTrader MK3] Ware filter event: Stats update triggered by ' + $trigger" chance="100"/>
        
        <!-- Generate real-time filter effectiveness report -->
        <signal_cue_instantly cue="GenerateFilterStats"/>
      </actions>
    </cue>
    
    <!-- Track Ware Performance -->
    <cue name="TrackWarePerformance" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$data" exact="event.param"/>
        <set_value name="$ware" exact="$data.ware"/>
        <set_value name="$ship" exact="$data.ship"/>
        <set_value name="$success" exact="$data.success"/>
        <set_value name="$profit" exact="$data.profit"/>
        
        <!-- Initialize ware performance tracking -->
        <do_if value="not global.$GT_WareFilter.$Performance?">
          <set_value name="global.$GT_WareFilter.$Performance" exact="table[]"/>
        </do_if>
        
        <do_if value="not global.$GT_WareFilter.$Performance.{$ware}?">
          <set_value name="global.$GT_WareFilter.$Performance.{$ware}" exact="table[]"/>
          <set_value name="global.$GT_WareFilter.$Performance.{$ware}.$TotalTrades" exact="0"/>
          <set_value name="global.$GT_WareFilter.$Performance.{$ware}.$SuccessfulTrades" exact="0"/>
          <set_value name="global.$GT_WareFilter.$Performance.{$ware}.$TotalProfit" exact="0"/>
          <set_value name="global.$GT_WareFilter.$Performance.{$ware}.$LastUpdate" exact="player.age"/>
        </do_if>
        
        <!-- Update performance data -->
        <set_value name="global.$GT_WareFilter.$Performance.{$ware}.$TotalTrades" exact="global.$GT_WareFilter.$Performance.{$ware}.$TotalTrades + 1"/>
        
        <do_if value="$success">
          <set_value name="global.$GT_WareFilter.$Performance.{$ware}.$SuccessfulTrades" exact="global.$GT_WareFilter.$Performance.{$ware}.$SuccessfulTrades + 1"/>
        </do_if>
        
        <set_value name="global.$GT_WareFilter.$Performance.{$ware}.$TotalProfit" exact="global.$GT_WareFilter.$Performance.{$ware}.$TotalProfit + $profit"/>
        <set_value name="global.$GT_WareFilter.$Performance.{$ware}.$LastUpdate" exact="player.age"/>
      </actions>
    </cue>
    
    <!-- Generate Real-time Filter Stats -->
    <cue name="GenerateFilterStats" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <!-- Real-time filter effectiveness calculation -->
        <set_value name="$totalFilters" exact="0"/>
        <set_value name="$totalBlocked" exact="0"/>
        
        <do_if value="global.$GT_WareFilter.$Statistics?">
          <set_value name="$totalFilters" exact="global.$GT_WareFilter.$Statistics.$FiltersApplied"/>
          <set_value name="$totalBlocked" exact="global.$GT_WareFilter.$Statistics.$TradesBlocked"/>
        </do_if>
        
        <!-- Performance analysis -->
        <set_value name="$avgPerformance" exact="0"/>
        <set_value name="$wareCount" exact="0"/>
        
        <do_if value="global.$GT_WareFilter.$Performance? and global.$GT_WareFilter.$Performance.keys.count gt 0">
          <do_all exact="global.$GT_WareFilter.$Performance.keys.count" counter="$i">
            <set_value name="$ware" exact="global.$GT_WareFilter.$Performance.keys.list.{$i}"/>
            <set_value name="$wareData" exact="global.$GT_WareFilter.$Performance.{$ware}"/>
            
            <do_if value="$wareData.$TotalTrades gt 0">
              <set_value name="$warePerformance" exact="($wareData.$TotalProfit / $wareData.$TotalTrades)"/>
              <set_value name="$avgPerformance" exact="$avgPerformance + $warePerformance"/>
              <set_value name="$wareCount" exact="$wareCount + 1"/>
            </do_if>
          </do_all>
          
          <do_if value="$wareCount gt 0">
            <set_value name="$avgPerformance" exact="$avgPerformance / $wareCount"/>
          </do_if>
        </do_if>
        
        <debug_text text="'[GalaxyTrader MK3] Filter intelligence: ' + $totalFilters + ' filters, ' + $totalBlocked + ' blocked, avg performance: ' + $avgPerformance + ' Cr/trade'" chance="100"/>
      </actions>
    </cue>
  </cues>
</mdscript> 
