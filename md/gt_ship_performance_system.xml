<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Ship_Performance_System" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  
  <cues>
    
    <!-- ==================== SIMPLE SHIP PERFORMANCE TRACKING ==================== -->
    <!-- Basic performance tracking without external modifications -->
    
    <cue name="Initialize_Performance_System" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start"/>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT Performance] Simple ship performance tracking system initialized'"/>
        </do_if>
        
        <!-- Initialize tracking tables -->
        <set_value name="global.$GT_Ship_Performance" exact="table[]"/>
        <set_value name="global.$GT_Performance_History" exact="[]"/>
      </actions>
    </cue>
    
    <!-- ==================== GT ORDER ASSIGNMENT MONITORING ==================== -->
    
    <cue name="Monitor_GT_Order_Assignment" instantiate="true">
      <conditions>
        <event_object_order_ready object="player.galaxy"/>
        <check_value value="event.object.isclass.ship"/>
        <check_value value="event.object.owner == faction.player"/>
        <check_value value="event.param.id == 'GalaxyTraderMK3'"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT Performance] GT order assigned to ' + $ship.knownname + ' - tracking performance'"/>
        </do_if>
        
        <!-- Track performance without modifications -->
        <signal_cue_instantly cue="Track_Performance" param="$ship"/>
      </actions>
    </cue>
    
    <!-- ==================== GT ORDER REMOVAL MONITORING ==================== -->
    
    <cue name="Monitor_GT_Order_Removal" instantiate="true">
      <conditions>
        <event_object_order_cancelled object="player.galaxy"/>
        <check_value value="event.object.isclass.ship"/>
        <check_value value="event.object.owner == faction.player"/>
        <check_value value="global.$GT_Ship_Performance.{event.object}?"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT Performance] GT order removed from ' + $ship.knownname + ' - removing tracking'"/>
        </do_if>
        
        <!-- Remove performance tracking -->
        <signal_cue_instantly cue="Remove_Performance_Tracking" param="$ship"/>
      </actions>
    </cue>
    
    <!-- ==================== PILOT CHANGE MONITORING ==================== -->
    
    <cue name="Monitor_Pilot_Changes" instantiate="true">
      <conditions>
        <event_object_commander_set object="player.galaxy"/>
        <check_value value="event.object.isclass.ship"/>
        <check_value value="event.object.owner == faction.player"/>
        <check_value value="global.$GT_Ship_Performance.{event.object}?"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT Performance] Pilot change detected on GT ship ' + $ship.knownname + ' - updating tracking'"/>
        </do_if>
        
        <!-- Update performance tracking for new pilot -->
        <signal_cue_instantly cue="Track_Performance" param="$ship"/>
      </actions>
    </cue>
    
    <!-- ==================== TRAINING COMPLETION MONITORING ==================== -->
    
    <cue name="Monitor_Training_Completion" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Training_Complete'"/>
        <check_value value="event.object.isclass.ship"/>
        <check_value value="event.object.owner == faction.player"/>
        <check_value value="global.$GT_Ship_Performance.{event.object}?"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT Performance] Training complete for ' + $ship.knownname + ' - updating tracking'"/>
        </do_if>
        
        <!-- Update performance tracking based on new pilot level -->
        <signal_cue_instantly cue="Track_Performance" param="$ship"/>
      </actions>
    </cue>
    
    <!-- ==================== PERFORMANCE TRACKING ==================== -->
    
    <cue name="Track_Performance" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.param"/>
        
        <!-- Validate ship and pilot -->
        <do_if value="not $ship.exists or not $ship.pilot.exists">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT Performance] Invalid ship or pilot - skipping performance tracking'"/>
          </do_if>
        </do_if>
        <do_else>
          
          <!-- Get pilot skill level from GT XP system -->
          <set_value name="$pilot" exact="$ship.pilot"/>
          <set_value name="$pilot_level" exact="1"/>
          
          <do_if value="global.$GT_Pilots.{$pilot}? and global.$GT_Pilots.{$pilot}.$XP?">
            <set_value name="$currentXP" exact="global.$GT_Pilots.{$pilot}.$XP"/>
            <!-- Calculate skill level from XP -->
            <do_all exact="15" counter="$level">
              <do_if value="$currentXP ge global.$GT_Config.$XP.$SkillThresholds.{$level}">
                <set_value name="$pilot_level" exact="$level"/>
              </do_if>
            </do_all>
          </do_if>
          
          <!-- Determine ship class string -->
          <set_value name="$ship_class" exact="'unknown'"/>
          <do_if value="$ship.isclass.ship_s">
            <set_value name="$ship_class" exact="'small'"/>
          </do_if>
          <do_elseif value="$ship.isclass.ship_m">
            <set_value name="$ship_class" exact="'medium'"/>
          </do_elseif>
          <do_elseif value="$ship.isclass.ship_l">
            <set_value name="$ship_class" exact="'large'"/>
          </do_elseif>
          <do_elseif value="$ship.isclass.ship_xl">
            <set_value name="$ship_class" exact="'capital'"/>
          </do_elseif>
          
          <!-- Calculate theoretical performance impact -->
          <set_value name="$performance_text" exact="'Baseline'"/>
          <set_value name="$speed_percentage" exact="100"/>
          
          <!-- APPRENTICE LEVEL (1-2): Ship class dependent theoretical penalties -->
          <do_if value="$pilot_level le 2">
            <do_if value="$ship.isclass.ship_s">
              <set_value name="$performance_text" exact="'Optimal'"/>
              <set_value name="$speed_percentage" exact="100"/>
            </do_if>
            <do_elseif value="$ship.isclass.ship_m">
              <set_value name="$performance_text" exact="'Sub-optimal'"/>
              <set_value name="$speed_percentage" exact="90"/>
            </do_elseif>
            <do_elseif value="$ship.isclass.ship_l">
              <set_value name="$performance_text" exact="'Poor'"/>
              <set_value name="$speed_percentage" exact="50"/>
            </do_elseif>
            <do_elseif value="$ship.isclass.ship_xl">
              <set_value name="$performance_text" exact="'Very Poor'"/>
              <set_value name="$speed_percentage" exact="10"/>
            </do_elseif>
          </do_if>
          
          <!-- BASIC LEVEL (3-8): Mixed performance -->
          <do_elseif value="$pilot_level ge 3 and $pilot_level le 8">
            <do_if value="$ship.isclass.ship_s">
              <set_value name="$performance_text" exact="'Enhanced'"/>
              <set_value name="$speed_percentage" exact="110"/>
            </do_if>
            <do_elseif value="$ship.isclass.ship_m">
              <set_value name="$performance_text" exact="'Optimal'"/>
              <set_value name="$speed_percentage" exact="100"/>
            </do_elseif>
            <do_elseif value="$ship.isclass.ship_l">
              <set_value name="$performance_text" exact="'Sub-optimal'"/>
              <set_value name="$speed_percentage" exact="90"/>
            </do_elseif>
            <do_elseif value="$ship.isclass.ship_xl">
              <set_value name="$performance_text" exact="'Poor'"/>
              <set_value name="$speed_percentage" exact="85"/>
            </do_elseif>
          </do_elseif>
          
          <!-- EXPERT LEVEL (9+): Enhanced performance -->
          <do_elseif value="$pilot_level ge 9">
            <do_if value="$ship.isclass.ship_s">
              <set_value name="$performance_text" exact="'Superior'"/>
              <set_value name="$speed_percentage" exact="125"/>
            </do_if>
            <do_elseif value="$ship.isclass.ship_m">
              <set_value name="$performance_text" exact="'Enhanced'"/>
              <set_value name="$speed_percentage" exact="110"/>
            </do_elseif>
            <do_elseif value="$ship.isclass.ship_l">
              <set_value name="$performance_text" exact="'Optimal'"/>
              <set_value name="$speed_percentage" exact="100"/>
            </do_elseif>
            <do_elseif value="$ship.isclass.ship_xl">
              <set_value name="$performance_text" exact="'Enhanced'"/>
              <set_value name="$speed_percentage" exact="110"/>
            </do_elseif>
          </do_elseif>
          
          <!-- Store performance tracking data -->
          <set_value name="global.$GT_Ship_Performance.{$ship}" exact="table[
            $pilot = $pilot,
            $pilot_level = $pilot_level,
            $ship_class = $ship_class,
            $performance_text = $performance_text,
            $speed_percentage = $speed_percentage,
            $applied_time = player.age,
            $last_updated = player.age,
            $active = true
          ]"/>
          
          <!-- Show performance notification -->
          <set_value name="$timestamp" exact="player.age"/>
          <append_to_list name="global.$GT_Performance_History" exact="table[
            $ship = $ship,
            $pilot = $pilot,
            $pilot_level = $pilot_level,
            $ship_class = $ship_class,
            $performance_text = $performance_text,
            $speed_percentage = $speed_percentage,
            $timestamp = player.age,
            $event = 'applied'
          ]"/>
          
          <!-- M3 FIX: Cap performance history to prevent unbounded growth -->
          <do_while value="global.$GT_Performance_History.count gt 200">
            <remove_from_list name="global.$GT_Performance_History" exact="global.$GT_Performance_History.{1}"/>
          </do_while>
          
          <show_notification text="'GT Performance: ' + $ship.knownname + '\nPilot Level ' + $pilot_level + ': ' + $performance_text + '\nâš¡ Theoretical Performance: ' + $speed_percentage + '%\nShip Class: ' + $ship_class" timeout="8s" priority="7"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT Performance] Performance tracking applied to ' + $ship.knownname + ' - Level: ' + $pilot_level + ', Class: ' + $ship_class + ', Performance: ' + $performance_text"/>
          </do_if>
        </do_else>
      </actions>
    </cue>
    
    <!-- ==================== PERFORMANCE TRACKING REMOVAL ==================== -->
    
    <cue name="Remove_Performance_Tracking" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.param"/>
        
        <!-- Remove performance tracking -->
        <do_if value="global.$GT_Ship_Performance.{$ship}?">
          <set_value name="global.$GT_Ship_Performance.{$ship}.$removed_time" exact="player.age"/>
          <set_value name="global.$GT_Ship_Performance.{$ship}.$active" exact="false"/>
          
          <!-- Add to history -->
          <append_to_list name="global.$GT_Performance_History" exact="table[
            $ship = $ship,
            $timestamp = player.age,
            $event = 'removed'
          ]"/>
          
          <!-- M3 FIX: Cap performance history to prevent unbounded growth -->
          <do_while value="global.$GT_Performance_History.count gt 200">
            <remove_from_list name="global.$GT_Performance_History" exact="global.$GT_Performance_History.{1}"/>
          </do_while>
          
          <remove_value name="global.$GT_Ship_Performance.{$ship}"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT Performance] Performance tracking removed from ' + $ship.knownname"/>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- ==================== COMPATIBILITY WRAPPER ==================== -->
    
    <cue name="Apply_GT_Modifications" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <!-- Forward the call to the actual performance tracking system -->
        <signal_cue_instantly cue="Track_Performance" param="event.param"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT Performance] Compatibility wrapper: Apply_GT_Modifications Track_Performance'"/>
        </do_if>
      </actions>
    </cue>

  </cues>
</mdscript> 
