<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Pathfinding_Utilities" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================= -->
    <!-- PATHFINDING UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Calculate Path Distance -->
    <library name="GT_CalculatePathDistance" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship for pathfinding"/>
        <param name="fromSector" comment="Source sector"/>
        <param name="toSector" comment="Destination sector"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group"/>
        <param name="useEscapeMode" default="false" comment="If true, use non-blacklist-aware for escape"/>
      </params>
      <actions>
        <!-- Same sector = 0 -->
        <do_if value="$fromSector == $toSector">
          <return value="0"/>
        </do_if>
        
        <!-- Escape mode: non-blacklist-aware -->
        <do_if value="$useEscapeMode">
          <return value="$ship.gatedistance.{$toSector}"/>
        </do_if>
        
        <!-- Normal mode: blacklist-aware -->
        <!-- Get blacklist group if not provided or null (memory:10529400 - ? checks existence, not null) -->
        <do_if value="not $blacklistgroup? or $blacklistgroup == null">
          <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
        </do_if>
        <return value="$ship.gatedistance.{$toSector}.{$blacklistgroup}.{$ship}"/>
      </actions>
    </library>
    
    <!-- Calculate Trade Route Distance -->
    <library name="GT_CalculateTradeRouteDistance" purpose="run_actions">
      <params>
        <param name="homeSector" comment="Home/base sector"/>
        <param name="buyStation" comment="Buy station (or buy station sector)"/>
        <param name="sellStation" comment="Sell station (or sell station sector)"/>
      </params>
      <actions>
        <!-- Extract sectors from stations if needed -->
        <set_value name="$buySector" exact="$buyStation"/>
        <do_if value="$buyStation.isclass.station">
          <set_value name="$buySector" exact="$buyStation.sector"/>
        </do_if>
        <set_value name="$sellSector" exact="$sellStation"/>
        <do_if value="$sellStation.isclass.station">
          <set_value name="$sellSector" exact="$sellStation.sector"/>
        </do_if>
        
        <!-- Calculate distance from home to buy station -->
        <set_value name="$buyDistance" exact="0"/>
        <do_if value="$homeSector == $buySector">
          <set_value name="$buyDistance" exact="0"/>
        </do_if>
        <do_else>
          <set_value name="$buyDistance" exact="$homeSector.gatedistance.{$buySector}"/>
        </do_else>
        
        <!-- Calculate distance from buy station to sell station (route distance) -->
        <set_value name="$routeDistance" exact="0"/>
        <do_if value="$buySector == $sellSector">
          <set_value name="$routeDistance" exact="0"/>
        </do_if>
        <do_else>
          <set_value name="$routeDistance" exact="$buySector.gatedistance.{$sellSector}"/>
        </do_else>
        
        <!-- Return total route distance (home → buy → sell) -->
        <return value="$buyDistance + $routeDistance"/>
      </actions>
    </library>
    
    <!-- Calculate Range-Only Distance (Universal Cache Validation) -->
    <library name="GT_CalculateRangeOnlyDistance" purpose="run_actions">
      <params>
        <param name="fromSector" comment="Source sector (typically home sector)"/>
        <param name="toSector" comment="Destination sector"/>
      </params>
      <actions>
        <!-- ✅ UNIVERSAL CACHE: Use range-only distance (NO blacklist params) -->
        <!-- Same sector = 0, otherwise use gatedistance -->
        <do_if value="$fromSector == $toSector">
          <return value="0"/>
        </do_if>
        <do_else>
          <return value="$fromSector.gatedistance.{$toSector}"/>
        </do_else>
      </actions>
    </library>
    
    <!-- Calculate Station Distance Cache -->
    <library name="GT_CalculateStationDistanceCache" purpose="run_actions">
      <params>
        <param name="stations" comment="List of stations to calculate distances for"/>
        <param name="homeSector" comment="Home/base sector for distance calculation"/>
      </params>
      <actions>
        <set_value name="$distanceCache" exact="table[]"/>
        <do_all exact="$stations.count" counter="$i">
          <set_value name="$station" exact="$stations.{$i}"/>
          <do_if value="not $distanceCache.{$station}?">
            <!-- ✅ UNIVERSAL CACHE: Use range-only distance (using library function) -->
            <set_value name="$targetSector" exact="$station.sector"/>
            <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculateRangeOnlyDistance" result="$distanceCache.{$station}">
              <param name="fromSector" value="$homeSector"/>
              <param name="toSector" value="$targetSector"/>
            </run_actions>
          </do_if>
        </do_all>
        <return value="$distanceCache"/>
      </actions>
    </library>
    
  </cues>
</mdscript>
