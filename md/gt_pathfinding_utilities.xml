<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Pathfinding_Utilities" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================= -->
    <!-- PATHFINDING UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Calculate Path Distance -->
    <library name="GT_CalculatePathDistance" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship for pathfinding"/>
        <param name="fromSector" comment="Source sector"/>
        <param name="toSector" comment="Destination sector"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group"/>
        <param name="useEscapeMode" default="false" comment="If true, use non-blacklist-aware for escape"/>
      </params>
      <actions>
        <!-- Same sector = 0 -->
        <do_if value="$fromSector == $toSector">
          <return value="0"/>
        </do_if>
        
        <!-- Escape mode: non-blacklist-aware -->
        <do_if value="$useEscapeMode">
          <return value="$ship.gatedistance.{$toSector}"/>
        </do_if>
        
        <!-- Normal mode: blacklist-aware -->
        <!-- Get blacklist group if not provided or null (memory:10529400 - ? checks existence, not null) -->
        <do_if value="not $blacklistgroup? or $blacklistgroup == null">
          <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
        </do_if>
        <return value="$ship.gatedistance.{$toSector}.{$blacklistgroup}.{$ship}"/>
      </actions>
    </library>
    
    <!-- Calculate Trade Route Distance -->
    <library name="GT_CalculateTradeRouteDistance" purpose="run_actions">
      <params>
        <param name="homeSector" comment="Home/base sector"/>
        <param name="buyStation" comment="Buy station (or buy station sector)"/>
        <param name="sellStation" comment="Sell station (or sell station sector)"/>
      </params>
      <actions>
        <!-- Extract sectors from stations if needed -->
        <set_value name="$buySector" exact="$buyStation"/>
        <do_if value="$buyStation.isclass.station">
          <set_value name="$buySector" exact="$buyStation.sector"/>
        </do_if>
        <set_value name="$sellSector" exact="$sellStation"/>
        <do_if value="$sellStation.isclass.station">
          <set_value name="$sellSector" exact="$sellStation.sector"/>
        </do_if>
        
        <!-- Calculate distance from home to buy station -->
        <set_value name="$buyDistance" exact="0"/>
        <do_if value="$homeSector == $buySector">
          <set_value name="$buyDistance" exact="0"/>
        </do_if>
        <do_else>
          <set_value name="$buyDistance" exact="$homeSector.gatedistance.{$buySector}"/>
        </do_else>
        
        <!-- Calculate distance from buy station to sell station (route distance) -->
        <set_value name="$routeDistance" exact="0"/>
        <do_if value="$buySector == $sellSector">
          <set_value name="$routeDistance" exact="0"/>
        </do_if>
        <do_else>
          <set_value name="$routeDistance" exact="$buySector.gatedistance.{$sellSector}"/>
        </do_else>
        
        <!-- Return total route distance (home → buy → sell) -->
        <return value="$buyDistance + $routeDistance"/>
      </actions>
    </library>
    
    <!-- Calculate Range-Only Distance (Universal Cache Validation) -->
    <library name="GT_CalculateRangeOnlyDistance" purpose="run_actions">
      <params>
        <param name="fromSector" comment="Source sector (typically home sector)"/>
        <param name="toSector" comment="Destination sector"/>
      </params>
      <actions>
        <!-- ✅ UNIVERSAL CACHE: Use range-only distance (NO blacklist params) -->
        <!-- Same sector = 0, otherwise use gatedistance -->
        <do_if value="$fromSector == $toSector">
          <return value="0"/>
        </do_if>
        <do_else>
          <return value="$fromSector.gatedistance.{$toSector}"/>
        </do_else>
      </actions>
    </library>
    
    <!-- Calculate Station Distance Cache -->
    <library name="GT_CalculateStationDistanceCache" purpose="run_actions">
      <params>
        <param name="stations" comment="List of stations to calculate distances for"/>
        <param name="homeSector" comment="Home/base sector for distance calculation"/>
      </params>
      <actions>
        <set_value name="$distanceCache" exact="table[]"/>
        <do_all exact="$stations.count" counter="$i">
          <set_value name="$station" exact="$stations.{$i}"/>
          <do_if value="not $distanceCache.{$station}?">
            <!-- ✅ UNIVERSAL CACHE: Use range-only distance (using library function) -->
            <set_value name="$targetSector" exact="$station.sector"/>
            <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculateRangeOnlyDistance" result="$distanceCache.{$station}">
              <param name="fromSector" value="$homeSector"/>
              <param name="toSector" value="$targetSector"/>
            </run_actions>
          </do_if>
        </do_all>
        <return value="$distanceCache"/>
      </actions>
    </library>
    
    <!-- Calculate Trade Path Distances (with escape logic) -->
    <library name="GT_CalculateTradePathDistances" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship for pathfinding"/>
        <param name="currentSector" comment="Ship's current sector"/>
        <param name="buySector" comment="Buy station sector"/>
        <param name="sellSector" comment="Sell station sector"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group"/>
      </params>
      <actions>
        <!-- ✅ FIX: Handle same-sector cases first (ship already there = 0 distance) -->
        <!-- If ship is in blacklisted sector, allow trades where ship stays in same sector OR escapes -->
        <set_value name="$buyPathDistance" exact="-1"/>
        <set_value name="$sellPathDistance" exact="-1"/>
        
        <!-- ✅ ESCAPE LOGIC: Buy path calculation with escape support -->
        <!-- Check if current sector is blacklisted for escape logic -->
        <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$currentSectorIsBlacklistedForEscape">
          <param name="sector" value="$currentSector"/>
          <param name="ship" value="$ship"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
        </run_actions>
        
        <!-- Buy path calculation -->
        <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculatePathDistance" result="$buyPathDistance">
          <param name="ship" value="$ship"/>
          <param name="fromSector" value="$currentSector"/>
          <param name="toSector" value="$buySector"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
          <param name="useEscapeMode" value="$currentSectorIsBlacklistedForEscape"/>
        </run_actions>
        
        <!-- Sell path calculation -->
        <!-- ✅ CRITICAL: If ship is in blacklisted sector and buy is same sector, use ship position (not buy sector) -->
        <!-- This allows escape: ship in Lasting Vengeance → buy in Lasting Vengeance → sell in safe sector -->
        <do_if value="$sellSector == $buySector">
          <!-- Buy and sell in same sector -->
          <set_value name="$sellPathDistance" exact="0"/>
        </do_if>
        <do_elseif value="$sellSector == $currentSector">
          <!-- ✅ ISOLATION FIX: Sell sector is current sector (intra-sector trade) - distance is 0 -->
          <set_value name="$sellPathDistance" exact="0"/>
        </do_elseif>
        <do_elseif value="$buySector == $currentSector">
          <!-- Ship is in buy sector (same as current) - check path FROM ship's current position to sell sector -->
          <!-- This handles escape case: ship in blacklisted sector, staying there to buy, then selling in safe sector -->
          <!-- ✅ ESCAPE LOGIC: If ship is in blacklisted sector, use NON-blacklist-aware gatedistance to find ANY path -->
          <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculatePathDistance" result="$sellPathDistance">
            <param name="ship" value="$ship"/>
            <param name="fromSector" value="$currentSector"/>
            <param name="toSector" value="$sellSector"/>
            <param name="blacklistgroup" value="$blacklistgroup"/>
            <param name="useEscapeMode" value="$currentSectorIsBlacklistedForEscape"/>
          </run_actions>
        </do_elseif>
        <do_else>
          <!-- Normal case: Need to travel from buy to sell sector -->
          <!-- Note: GT_CalculatePathDistance uses ship.gatedistance, but here we need buySector.gatedistance -->
          <!-- For sector-to-sector distance, calculate manually -->
          <do_if value="$buySector == $sellSector">
            <set_value name="$sellPathDistance" exact="0"/>
          </do_if>
          <do_else>
            <set_value name="$sellPathDistance" exact="$buySector.gatedistance.{$sellSector}.{$blacklistgroup}.{$ship}"/>
          </do_else>
        </do_else>
        
        <!-- Check if paths are reachable -->
        <set_value name="$isReachable" exact="($buyPathDistance ge 0 and $sellPathDistance ge 0)"/>
        
        <!-- Check if intra-sector trade -->
        <run_actions ref="md.GT_Trade_Utilities.GT_IsIntraSectorTrade" result="$isIntraSectorTrade">
          <param name="buySector" value="$buySector"/>
          <param name="sellSector" value="$sellSector"/>
          <param name="currentSector" value="$currentSector"/>
        </run_actions>
        
        <!-- Return result table -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$BuyPathDistance" exact="$buyPathDistance"/>
        <set_value name="$result.$SellPathDistance" exact="$sellPathDistance"/>
        <set_value name="$result.$IsReachable" exact="$isReachable"/>
        <set_value name="$result.$IsIntraSectorTrade" exact="$isIntraSectorTrade"/>
        <set_value name="$result.$CurrentSectorIsBlacklisted" exact="$currentSectorIsBlacklistedForEscape"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Check if Station is Reachable -->
    <library name="GT_IsStationReachable" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship for pathfinding"/>
        <param name="station" comment="Station to check reachability for"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group (will be auto-determined if null)"/>
        <param name="returnDetails" default="false" comment="If true, returns table with detailed results"/>
      </params>
      <actions>
        <!-- Initialize result -->
        <set_value name="$isReachable" exact="false"/>
        <set_value name="$failureReason" exact="''"/>
        
        <!-- Check 1: Station exists -->
        <do_if value="not $station? or not $station.exists">
          <set_value name="$failureReason" exact="'Station does not exist'"/>
          <do_if value="$returnDetails">
            <set_value name="$result" exact="table[]"/>
            <set_value name="$result.$IsReachable" exact="false"/>
            <set_value name="$result.$FailureReason" exact="$failureReason"/>
            <set_value name="$result.$StationKnown" exact="false"/>
            <set_value name="$result.$BasicPathDistance" exact="-1"/>
            <set_value name="$result.$BlacklistAwarePathDistance" exact="-1"/>
            <return value="$result"/>
          </do_if>
          <do_else>
            <return value="false"/>
          </do_else>
        </do_if>
        
        <!-- Check 2: Station is known to player OR ship is in same zone/sector -->
        <!-- ✅ FIX: Use correct property syntax - $station.isknown (not player.entity.isknown.{$station}) -->
        <!-- ✅ FIX: If ship is in same zone as station, skip "known" check (ship can see it) -->
        <set_value name="$sameZone" exact="$ship.zone == $station.zone"/>
        <set_value name="$sameSector" exact="$ship.sector == $station.sector"/>
        <set_value name="$stationIsKnown" exact="@$station.isknown"/>
        
        <!-- Station is accessible if: known to player OR ship is in same zone/sector -->
        <set_value name="$stationAccessible" exact="$stationIsKnown or $sameZone or $sameSector"/>
        
        <do_if value="not $stationAccessible">
          <set_value name="$failureReason" exact="'Station not known to player and not in same zone/sector'"/>
          <do_if value="$returnDetails">
            <set_value name="$result" exact="table[]"/>
            <set_value name="$result.$IsReachable" exact="false"/>
            <set_value name="$result.$FailureReason" exact="$failureReason"/>
            <set_value name="$result.$StationKnown" exact="$stationIsKnown"/>
            <set_value name="$result.$BasicPathDistance" exact="-1"/>
            <set_value name="$result.$BlacklistAwarePathDistance" exact="-1"/>
            <return value="$result"/>
          </do_if>
          <do_else>
            <return value="false"/>
          </do_else>
        </do_if>
        
        <!-- Check 3: If ship and station are in same zone, they're reachable (no pathfinding needed) -->
        <do_if value="$sameZone">
          <!-- Ship is in same zone as station - can reach directly -->
          <set_value name="$isReachable" exact="true"/>
          <set_value name="$basicPathDistance" exact="0"/>
          <set_value name="$blacklistAwarePathDistance" exact="0"/>
        </do_if>
        <do_else>
          <!-- Different zones - need to check pathfinding -->
          <!-- Get blacklist group if not provided -->
          <do_if value="not $blacklistgroup? or $blacklistgroup == null">
            <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
              <param name="ship" value="$ship"/>
            </run_actions>
          </do_if>
          
          <!-- Check 3a: Basic path (what vanilla's move.generic checks) -->
          <set_value name="$basicPathDistance" exact="$ship.gatedistance.{$station}"/>
          
          <!-- Check 3b: Blacklist-aware path (what we want to use) -->
          <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculatePathDistance" result="$blacklistAwarePathDistance">
            <param name="ship" value="$ship"/>
            <param name="fromSector" value="$ship.sector"/>
            <param name="toSector" value="$station.sector"/>
            <param name="blacklistgroup" value="$blacklistgroup"/>
            <param name="useEscapeMode" value="false"/>
          </run_actions>
          
          <!-- Determine if reachable (both paths must exist) -->
          <do_if value="$basicPathDistance lt 0">
            <set_value name="$failureReason" exact="'No basic path exists (distance: ' + $basicPathDistance + ')'"/>
          </do_if>
          <do_elseif value="$blacklistAwarePathDistance lt 0">
            <set_value name="$failureReason" exact="'No blacklist-aware path exists (distance: ' + $blacklistAwarePathDistance + ')'"/>
          </do_elseif>
          <do_else>
            <set_value name="$isReachable" exact="true"/>
          </do_else>
        </do_else>
        
        <!-- Return result -->
        <do_if value="$returnDetails">
          <set_value name="$result" exact="table[]"/>
          <set_value name="$result.$IsReachable" exact="$isReachable"/>
          <set_value name="$result.$FailureReason" exact="$failureReason"/>
          <set_value name="$result.$StationKnown" exact="$stationIsKnown"/>
          <set_value name="$result.$BasicPathDistance" exact="$basicPathDistance"/>
          <set_value name="$result.$BlacklistAwarePathDistance" exact="$blacklistAwarePathDistance"/>
          <return value="$result"/>
        </do_if>
        <do_else>
          <return value="$isReachable"/>
        </do_else>
      </actions>
    </library>
    
    <!-- Build Station Distance Cache from Offers -->
    <library name="GT_BuildStationDistanceCache" purpose="run_actions">
      <params>
        <param name="sellOffers" comment="List of sell offers"/>
        <param name="buyOffers" comment="List of buy offers"/>
        <param name="homeSector" comment="Home/base sector for distance calculation"/>
      </params>
      <actions>
        <!-- Extract unique stations from offers -->
        <set_value name="$sellStations" exact="[]"/>
        <set_value name="$buyStations" exact="[]"/>
        <set_value name="$sellStationsSeen" exact="table[]"/>
        <set_value name="$buyStationsSeen" exact="table[]"/>
        <do_all exact="$sellOffers.count" counter="$i">
          <set_value name="$station" exact="$sellOffers.{$i}.owner"/>
          <do_if value="not $sellStationsSeen.{$station}?">
            <set_value name="$sellStationsSeen.{$station}" exact="true"/>
            <append_to_list name="$sellStations" exact="$station"/>
          </do_if>
        </do_all>
        <do_all exact="$buyOffers.count" counter="$i">
          <set_value name="$station" exact="$buyOffers.{$i}.owner"/>
          <do_if value="not $buyStationsSeen.{$station}?">
            <set_value name="$buyStationsSeen.{$station}" exact="true"/>
            <append_to_list name="$buyStations" exact="$station"/>
          </do_if>
        </do_all>
        <!-- Calculate distance cache for sell stations -->
        <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculateStationDistanceCache" result="$sellDistanceCache">
          <param name="stations" value="$sellStations"/>
          <param name="homeSector" value="$homeSector"/>
        </run_actions>
        <!-- Calculate distance cache for buy stations -->
        <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculateStationDistanceCache" result="$buyDistanceCache">
          <param name="stations" value="$buyStations"/>
          <param name="homeSector" value="$homeSector"/>
        </run_actions>
        <!-- Merge caches -->
        <set_value name="$stationDistanceCache" exact="table[]"/>
        <do_all exact="$sellStations.count" counter="$i">
          <set_value name="$station" exact="$sellStations.{$i}"/>
          <set_value name="$stationDistanceCache.{$station}" exact="$sellDistanceCache.{$station}"/>
        </do_all>
        <do_all exact="$buyStations.count" counter="$i">
          <set_value name="$station" exact="$buyStations.{$i}"/>
          <set_value name="$stationDistanceCache.{$station}" exact="$buyDistanceCache.{$station}"/>
        </do_all>
        <return value="$stationDistanceCache"/>
      </actions>
    </library>
    
  </cues>
</mdscript>
