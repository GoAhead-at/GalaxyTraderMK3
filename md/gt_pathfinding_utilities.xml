<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Pathfinding_Utilities" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================= -->
    <!-- PATHFINDING UTILITIES -->
    <!-- ========================================= -->
    
    <!-- Calculate Path Distance -->
    <library name="GT_CalculatePathDistance" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship for pathfinding"/>
        <param name="fromSector" comment="Source sector"/>
        <param name="toSector" comment="Destination sector"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group"/>
        <param name="useEscapeMode" default="false" comment="If true, use non-blacklist-aware for escape"/>
      </params>
      <actions>
        <!-- Same sector = 0 -->
        <do_if value="$fromSector == $toSector">
          <return value="0"/>
        </do_if>
        
        <!-- Escape mode: non-blacklist-aware -->
        <do_if value="$useEscapeMode">
          <return value="$ship.gatedistance.{$toSector}"/>
        </do_if>
        
        <!-- Normal mode: blacklist-aware -->
        <!-- Get blacklist group if not provided or null (memory:10529400 - ? checks existence, not null) -->
        <do_if value="not $blacklistgroup? or $blacklistgroup == null">
          <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
        </do_if>
        <return value="$ship.gatedistance.{$toSector}.{$blacklistgroup}.{$ship}"/>
      </actions>
    </library>
    
    <!-- Calculate Trade Route Distance -->
    <library name="GT_CalculateTradeRouteDistance" purpose="run_actions">
      <params>
        <param name="homeSector" comment="Home/base sector"/>
        <param name="buyStation" comment="Buy station (or buy station sector)"/>
        <param name="sellStation" comment="Sell station (or sell station sector)"/>
      </params>
      <actions>
        <!-- Extract sectors from stations if needed -->
        <set_value name="$buySector" exact="$buyStation"/>
        <do_if value="$buyStation.isclass.station">
          <set_value name="$buySector" exact="$buyStation.sector"/>
        </do_if>
        <set_value name="$sellSector" exact="$sellStation"/>
        <do_if value="$sellStation.isclass.station">
          <set_value name="$sellSector" exact="$sellStation.sector"/>
        </do_if>
        
        <!-- Calculate distance from home to buy station -->
        <set_value name="$buyDistance" exact="0"/>
        <do_if value="$homeSector == $buySector">
          <set_value name="$buyDistance" exact="0"/>
        </do_if>
        <do_else>
          <set_value name="$buyDistance" exact="$homeSector.gatedistance.{$buySector}"/>
        </do_else>
        
        <!-- Calculate distance from buy station to sell station (route distance) -->
        <set_value name="$routeDistance" exact="0"/>
        <do_if value="$buySector == $sellSector">
          <set_value name="$routeDistance" exact="0"/>
        </do_if>
        <do_else>
          <set_value name="$routeDistance" exact="$buySector.gatedistance.{$sellSector}"/>
        </do_else>
        
        <!-- Return total route distance (home â†’ buy â†’ sell) -->
        <return value="$buyDistance + $routeDistance"/>
      </actions>
    </library>
    
    <!-- Calculate Range-Only Distance (Universal Cache Validation) -->
    <library name="GT_CalculateRangeOnlyDistance" purpose="run_actions">
      <params>
        <param name="fromSector" comment="Source sector (typically home sector)"/>
        <param name="toSector" comment="Destination sector"/>
      </params>
      <actions>
        <!-- âœ… UNIVERSAL CACHE: Use range-only distance (NO blacklist params) -->
        <!-- Same sector = 0, otherwise use gatedistance -->
        <do_if value="$fromSector == $toSector">
          <return value="0"/>
        </do_if>
        <do_else>
          <return value="$fromSector.gatedistance.{$toSector}"/>
        </do_else>
      </actions>
    </library>
    
    <!-- Calculate Station Distance Cache -->
    <library name="GT_CalculateStationDistanceCache" purpose="run_actions">
      <params>
        <param name="stations" comment="List of stations to calculate distances for"/>
        <param name="homeSector" comment="Home/base sector for distance calculation"/>
      </params>
      <actions>
        <set_value name="$distanceCache" exact="table[]"/>
        <do_all exact="$stations.count" counter="$i">
          <set_value name="$station" exact="$stations.{$i}"/>
          <do_if value="not $distanceCache.{$station}?">
            <!-- âœ… UNIVERSAL CACHE: Use range-only distance (using library function) -->
            <set_value name="$targetSector" exact="$station.sector"/>
            <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculateRangeOnlyDistance" result="$distanceCache.{$station}">
              <param name="fromSector" value="$homeSector"/>
              <param name="toSector" value="$targetSector"/>
            </run_actions>
          </do_if>
        </do_all>
        <return value="$distanceCache"/>
      </actions>
    </library>
    
    <!-- Calculate Trade Path Distances (with escape logic) -->
    <library name="GT_CalculateTradePathDistances" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship for pathfinding"/>
        <param name="currentSector" comment="Ship's current sector"/>
        <param name="buySector" comment="Buy station sector"/>
        <param name="sellSector" comment="Sell station sector"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group"/>
      </params>
      <actions>
        <!-- âœ… FIX: Handle same-sector cases first (ship already there = 0 distance) -->
        <!-- If ship is in blacklisted sector, allow trades where ship stays in same sector OR escapes -->
        <set_value name="$buyPathDistance" exact="-1"/>
        <set_value name="$sellPathDistance" exact="-1"/>
        
        <!-- âœ… ESCAPE LOGIC: Buy path calculation with escape support -->
        <!-- Check if current sector is blacklisted for escape logic -->
        <run_actions ref="md.GT_Blacklist_Utilities.GT_IsSectorBlacklisted" result="$currentSectorIsBlacklistedForEscape">
          <param name="sector" value="$currentSector"/>
          <param name="ship" value="$ship"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
        </run_actions>
        
        <!-- Buy path calculation -->
        <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculatePathDistance" result="$buyPathDistance">
          <param name="ship" value="$ship"/>
          <param name="fromSector" value="$currentSector"/>
          <param name="toSector" value="$buySector"/>
          <param name="blacklistgroup" value="$blacklistgroup"/>
          <param name="useEscapeMode" value="$currentSectorIsBlacklistedForEscape"/>
        </run_actions>
        
        <!-- Sell path calculation -->
        <!-- âœ… CRITICAL: If ship is in blacklisted sector and buy is same sector, use ship position (not buy sector) -->
        <!-- This allows escape: ship in Lasting Vengeance â†’ buy in Lasting Vengeance â†’ sell in safe sector -->
        <do_if value="$sellSector == $buySector">
          <!-- Buy and sell in same sector -->
          <set_value name="$sellPathDistance" exact="0"/>
        </do_if>
        <do_elseif value="$sellSector == $currentSector">
          <!-- âœ… ISOLATION FIX: Sell sector is current sector (intra-sector trade) - distance is 0 -->
          <set_value name="$sellPathDistance" exact="0"/>
        </do_elseif>
        <do_elseif value="$buySector == $currentSector">
          <!-- Ship is in buy sector (same as current) - check path FROM ship's current position to sell sector -->
          <!-- This handles escape case: ship in blacklisted sector, staying there to buy, then selling in safe sector -->
          <!-- âœ… ESCAPE LOGIC: If ship is in blacklisted sector, use NON-blacklist-aware gatedistance to find ANY path -->
          <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculatePathDistance" result="$sellPathDistance">
            <param name="ship" value="$ship"/>
            <param name="fromSector" value="$currentSector"/>
            <param name="toSector" value="$sellSector"/>
            <param name="blacklistgroup" value="$blacklistgroup"/>
            <param name="useEscapeMode" value="$currentSectorIsBlacklistedForEscape"/>
          </run_actions>
        </do_elseif>
        <do_else>
          <!-- Normal case: Need to travel from buy to sell sector -->
          <!-- Note: GT_CalculatePathDistance uses ship.gatedistance, but here we need buySector.gatedistance -->
          <!-- For sector-to-sector distance, calculate manually -->
          <do_if value="$buySector == $sellSector">
            <set_value name="$sellPathDistance" exact="0"/>
          </do_if>
          <do_else>
            <set_value name="$sellPathDistance" exact="$buySector.gatedistance.{$sellSector}.{$blacklistgroup}.{$ship}"/>
          </do_else>
        </do_else>
        
        <!-- Check if paths are reachable -->
        <set_value name="$isReachable" exact="($buyPathDistance ge 0 and $sellPathDistance ge 0)"/>
        
        <!-- Check if intra-sector trade -->
        <run_actions ref="md.GT_Trade_Utilities.GT_IsIntraSectorTrade" result="$isIntraSectorTrade">
          <param name="buySector" value="$buySector"/>
          <param name="sellSector" value="$sellSector"/>
          <param name="currentSector" value="$currentSector"/>
        </run_actions>
        
        <!-- Return result table -->
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$BuyPathDistance" exact="$buyPathDistance"/>
        <set_value name="$result.$SellPathDistance" exact="$sellPathDistance"/>
        <set_value name="$result.$IsReachable" exact="$isReachable"/>
        <set_value name="$result.$IsIntraSectorTrade" exact="$isIntraSectorTrade"/>
        <set_value name="$result.$CurrentSectorIsBlacklisted" exact="$currentSectorIsBlacklistedForEscape"/>
        <return value="$result"/>
      </actions>
    </library>
    
    <!-- Check if Station is Reachable -->
    <library name="GT_IsStationReachable" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship for pathfinding"/>
        <param name="station" comment="Station to check reachability for"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group (will be auto-determined if null)"/>
        <param name="returnDetails" default="false" comment="If true, returns table with detailed results"/>
      </params>
      <actions>
        <!-- Initialize result -->
        <set_value name="$isReachable" exact="false"/>
        <set_value name="$failureReason" exact="''"/>
        
        <!-- Check 1: Station exists -->
        <do_if value="not $station? or not $station.exists">
          <set_value name="$failureReason" exact="'Station does not exist'"/>
          <do_if value="$returnDetails">
            <set_value name="$result" exact="table[]"/>
            <set_value name="$result.$IsReachable" exact="false"/>
            <set_value name="$result.$FailureReason" exact="$failureReason"/>
            <set_value name="$result.$StationKnown" exact="false"/>
            <set_value name="$result.$BasicPathDistance" exact="-1"/>
            <set_value name="$result.$BlacklistAwarePathDistance" exact="-1"/>
            <return value="$result"/>
          </do_if>
          <do_else>
            <return value="false"/>
          </do_else>
        </do_if>
        
        <!-- Check 2: Station is known to player OR ship is in same zone/sector -->
        <!-- âœ… FIX: Use correct property syntax - $station.isknown (not player.entity.isknown.{$station}) -->
        <!-- âœ… FIX: If ship is in same zone as station, skip "known" check (ship can see it) -->
        <set_value name="$sameZone" exact="$ship.zone == $station.zone"/>
        <set_value name="$sameSector" exact="$ship.sector == $station.sector"/>
        <set_value name="$stationIsKnown" exact="@$station.isknown"/>
        
        <!-- Station is accessible if: known to player OR ship is in same zone/sector -->
        <set_value name="$stationAccessible" exact="$stationIsKnown or $sameZone or $sameSector"/>
        
        <do_if value="not $stationAccessible">
          <set_value name="$failureReason" exact="'Station not known to player and not in same zone/sector'"/>
          <do_if value="$returnDetails">
            <set_value name="$result" exact="table[]"/>
            <set_value name="$result.$IsReachable" exact="false"/>
            <set_value name="$result.$FailureReason" exact="$failureReason"/>
            <set_value name="$result.$StationKnown" exact="$stationIsKnown"/>
            <set_value name="$result.$BasicPathDistance" exact="-1"/>
            <set_value name="$result.$BlacklistAwarePathDistance" exact="-1"/>
            <return value="$result"/>
          </do_if>
          <do_else>
            <return value="false"/>
          </do_else>
        </do_if>
        
        <!-- Check 3: If ship and station are in same zone, they're reachable (no pathfinding needed) -->
        <do_if value="$sameZone">
          <!-- Ship is in same zone as station - can reach directly -->
          <set_value name="$isReachable" exact="true"/>
          <set_value name="$basicPathDistance" exact="0"/>
          <set_value name="$blacklistAwarePathDistance" exact="0"/>
        </do_if>
        <do_else>
          <!-- Different zones - need to check pathfinding -->
          <!-- Get blacklist group if not provided -->
          <do_if value="not $blacklistgroup? or $blacklistgroup == null">
            <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
              <param name="ship" value="$ship"/>
            </run_actions>
          </do_if>
          
          <!-- Check 3a: Basic path (what vanilla's move.generic checks) -->
          <set_value name="$basicPathDistance" exact="$ship.gatedistance.{$station}"/>
          
          <!-- Check 3b: Blacklist-aware path (what we want to use) -->
          <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculatePathDistance" result="$blacklistAwarePathDistance">
            <param name="ship" value="$ship"/>
            <param name="fromSector" value="$ship.sector"/>
            <param name="toSector" value="$station.sector"/>
            <param name="blacklistgroup" value="$blacklistgroup"/>
            <param name="useEscapeMode" value="false"/>
          </run_actions>
          
          <!-- Determine if reachable (both paths must exist) -->
          <do_if value="$basicPathDistance lt 0">
            <set_value name="$failureReason" exact="'No basic path exists (distance: ' + $basicPathDistance + ')'"/>
          </do_if>
          <do_elseif value="$blacklistAwarePathDistance lt 0">
            <set_value name="$failureReason" exact="'No blacklist-aware path exists (distance: ' + $blacklistAwarePathDistance + ')'"/>
          </do_elseif>
          <do_else>
            <set_value name="$isReachable" exact="true"/>
          </do_else>
        </do_else>
        
        <!-- Return result -->
        <do_if value="$returnDetails">
          <set_value name="$result" exact="table[]"/>
          <set_value name="$result.$IsReachable" exact="$isReachable"/>
          <set_value name="$result.$FailureReason" exact="$failureReason"/>
          <set_value name="$result.$StationKnown" exact="$stationIsKnown"/>
          <set_value name="$result.$BasicPathDistance" exact="$basicPathDistance"/>
          <set_value name="$result.$BlacklistAwarePathDistance" exact="$blacklistAwarePathDistance"/>
          <return value="$result"/>
        </do_if>
        <do_else>
          <return value="$isReachable"/>
        </do_else>
      </actions>
    </library>
    
    <!-- Find Sectors In Range (Vanilla Pattern) -->
    <!-- Replicates vanilla lib.find.sectors.inrange logic for MD scripts -->
    <!-- Pre-filters sectors by gate distance and blacklist BEFORE native trade queries -->
    <library name="GT_FindSectorsInRange" purpose="run_actions">
      <params>
        <param name="refobject" comment="Reference object (sector/station) from which gate distance is measured"/>
        <param name="mingatedistance" default="0" comment="Minimum gate distance from refobject"/>
        <param name="maxgatedistance" default="1" comment="Maximum gate distance from refobject"/>
        <param name="ship" comment="Ship for blacklist checks"/>
        <param name="blacklistgroup" default="null" comment="Blacklist group (auto-determined if null)"/>
        <param name="applyblacklist" default="true" comment="Apply blacklist filtering"/>
      </params>
      <actions>
        <!-- Get blacklist group if not provided -->
        <do_if value="not $blacklistgroup? or $blacklistgroup == null">
          <run_actions ref="md.GT_Blacklist_Utilities.GT_GetBlacklistGroup" result="$blacklistgroup">
            <param name="ship" value="$ship"/>
          </run_actions>
        </do_if>
        
        <!-- Extract reference sector from refobject -->
        <set_value name="$refsector" exact="null"/>
        <do_if value="$refobject.isclass.sector">
          <set_value name="$refsector" exact="$refobject"/>
        </do_if>
        <do_elseif value="$refobject.sector?">
          <set_value name="$refsector" exact="$refobject.sector"/>
        </do_elseif>
        <do_else>
          <!-- Try to find sector containing refobject -->
          <find_sector name="$locsectors" space="$refobject" multiple="true"/>
          <do_if value="$locsectors.count gt 0">
            <!-- Use closest sector (first one found) -->
            <set_value name="$refsector" exact="$locsectors.{1}"/>
          </do_if>
        </do_else>
        
        <!-- Validate refsector -->
        <do_if value="not $refsector? or not $refsector.exists">
          <debug_text text="'[GT-Pathfinding] ERROR: Failed to extract sector from refobject in GT_FindSectorsInRange'" chance="100"/>
          <return value="[]"/>
        </do_if>
        
        <!-- Get commander sector (ships can always operate in commander's sector regardless of blacklist) -->
        <set_value name="$commandersector" exact="null"/>
        <do_if value="$ship.commander? and $ship.commander.exists">
          <set_value name="$commandersector" exact="@$ship.commander.sector"/>
        </do_if>
        
        <!-- Get ship's current sector (fallback if all sectors blacklisted) -->
        <set_value name="$mysector" exact="$ship.sector"/>
        <do_if value="@$ship.zone.issuperhighway">
          <set_value name="$mysector" exact="@$ship.zone.destination.sector"/>
        </do_if>
        
        <!-- Use native find_cluster_in_range to find sectors within range -->
        <!-- This is the vanilla pattern - uses native C++ pathfinding for performance -->
        <set_value name="$locclusters" exact="table[]"/>
        <find_cluster_in_range distances="$locclusters" multiple="true" object="$refobject" mindistance="$mingatedistance" maxdistance="$maxgatedistance"/>
        
        <!-- Build sector table from clusters -->
        <set_value name="$sectortable" exact="table[]"/>
        <do_for_each name="$loccluster" valuename="$jumpdist" in="$locclusters">
          <find_sector name="$sectorlist" space="$loccluster" multiple="true"/>
          <do_if value="$sectorlist.count == 1">
            <!-- Single-sector cluster -->
            <set_value name="$locsector" exact="$sectorlist.{1}"/>
            <do_if value="not player.entity.isknown.{$locsector}? or @player.entity.isknown.{$locsector}">
              <!-- Check gate distance (for multi-sector clusters with one-way superhighways) -->
              <set_value name="$locgatedist" exact="$refsector.gatedistance.{$locsector}"/>
              <do_if value="($locgatedist ge 0) and ($locgatedist ge $mingatedistance) and ($locgatedist le $maxgatedistance)">
                <!-- Check return path distance -->
                <set_value name="$locreturngatedist" exact="$locsector.gatedistance.{$refsector}"/>
                <do_if value="($locreturngatedist ge 0) and ($locreturngatedist le $maxgatedistance)">
                  <!-- Apply blacklist filtering if enabled -->
                  <set_value name="$sectorValid" exact="true"/>
                  <do_if value="$applyblacklist">
                    <!-- Always allow commander's sector and ship's current sector -->
                    <do_if value="$locsector != $commandersector and $locsector != $mysector">
                      <!-- Check blacklist (sectoractivity AND sectortravel) -->
                      <set_value name="$sectorActivityBlacklisted" exact="@$locsector.isblacklisted.{blacklisttype.sectoractivity}.{$blacklistgroup}.{$ship}"/>
                      <set_value name="$sectorTravelBlacklisted" exact="@$locsector.isblacklisted.{blacklisttype.sectortravel}.{$blacklistgroup}.{$ship}"/>
                      <do_if value="$sectorActivityBlacklisted or $sectorTravelBlacklisted">
                        <set_value name="$sectorValid" exact="false"/>
                      </do_if>
                      <do_else>
                        <!-- Check blacklist-aware path distance (for return path) -->
                        <set_value name="$blacklistAwareDist" exact="$refsector.gatedistance.{$locsector}.{$blacklistgroup}.{$ship}"/>
                        <do_if value="$blacklistAwareDist lt 0">
                          <!-- No blacklist-aware path exists -->
                          <set_value name="$sectorValid" exact="false"/>
                        </do_if>
                        <do_else>
                          <!-- Check return path with blacklist -->
                          <set_value name="$blacklistAwareReturnDist" exact="$locsector.gatedistance.{$refsector}.{$blacklistgroup}.{$ship}"/>
                          <do_if value="$blacklistAwareReturnDist lt 0 or $blacklistAwareReturnDist gt $maxgatedistance">
                            <set_value name="$sectorValid" exact="false"/>
                          </do_if>
                        </do_else>
                      </do_else>
                    </do_if>
                  </do_if>
                  
                  <!-- Add sector if valid -->
                  <do_if value="$sectorValid">
                    <set_value name="$sectortable.{$locsector}" exact="$locgatedist"/>
                  </do_if>
                </do_if>
              </do_if>
            </do_if>
          </do_if>
          <do_else>
            <!-- Multi-sector cluster -->
            <do_for_each name="$locsector" in="$sectorlist">
              <do_if value="not player.entity.isknown.{$locsector}? or @player.entity.isknown.{$locsector}">
                <!-- Check gate distance -->
                <set_value name="$locgatedist" exact="$refsector.gatedistance.{$locsector}"/>
                <do_if value="($locgatedist ge 0) and ($locgatedist ge $mingatedistance) and ($locgatedist le $maxgatedistance)">
                  <!-- Check return path distance -->
                  <set_value name="$locreturngatedist" exact="$locsector.gatedistance.{$refsector}"/>
                  <do_if value="($locreturngatedist ge 0) and ($locreturngatedist le $maxgatedistance)">
                    <!-- Apply blacklist filtering if enabled -->
                    <set_value name="$sectorValid" exact="true"/>
                    <do_if value="$applyblacklist">
                      <!-- Always allow commander's sector and ship's current sector -->
                      <do_if value="$locsector != $commandersector and $locsector != $mysector">
                        <!-- Check blacklist (sectoractivity AND sectortravel) -->
                        <set_value name="$sectorActivityBlacklisted" exact="@$locsector.isblacklisted.{blacklisttype.sectoractivity}.{$blacklistgroup}.{$ship}"/>
                        <set_value name="$sectorTravelBlacklisted" exact="@$locsector.isblacklisted.{blacklisttype.sectortravel}.{$blacklistgroup}.{$ship}"/>
                        <do_if value="$sectorActivityBlacklisted or $sectorTravelBlacklisted">
                          <set_value name="$sectorValid" exact="false"/>
                        </do_if>
                        <do_else>
                          <!-- Check blacklist-aware path distance -->
                          <set_value name="$blacklistAwareDist" exact="$refsector.gatedistance.{$locsector}.{$blacklistgroup}.{$ship}"/>
                          <do_if value="$blacklistAwareDist lt 0">
                            <set_value name="$sectorValid" exact="false"/>
                          </do_if>
                          <do_else>
                            <!-- Check return path with blacklist -->
                            <set_value name="$blacklistAwareReturnDist" exact="$locsector.gatedistance.{$refsector}.{$blacklistgroup}.{$ship}"/>
                            <do_if value="$blacklistAwareReturnDist lt 0 or $blacklistAwareReturnDist gt $maxgatedistance">
                              <set_value name="$sectorValid" exact="false"/>
                            </do_if>
                          </do_else>
                        </do_else>
                      </do_if>
                    </do_if>
                    
                    <!-- Add sector if valid -->
                    <do_if value="$sectorValid">
                      <set_value name="$sectortable.{$locsector}" exact="$locgatedist"/>
                    </do_if>
                  </do_if>
                </do_if>
              </do_if>
            </do_for_each>
          </do_else>
        </do_for_each>
        
        <!-- If mingatedistance <= 0, include the refsector itself -->
        <do_if value="($mingatedistance le 0) and not $sectortable.{$refsector}?">
          <set_value name="$sectortable.{$refsector}" exact="0"/>
        </do_if>
        
        <!-- If no valid sectors found (probably due to blacklist), add ship's current sector as fallback -->
        <do_if value="not $sectortable.keys.count">
          <do_if value="$mysector? and $mysector.exists">
            <set_value name="$sectortable.{$mysector}" exact="0"/>
          </do_if>
        </do_if>
        
        <!-- Sort sectors by gate distance (vanilla pattern) -->
        <set_value name="$spaces" exact="$sectortable.keys.list"/>
        <shuffle_list list="$spaces"/>
        <sort_list list="$spaces" sortbyvalue="$sectortable.{loop.element}"/>
        
        <!-- If mingatedistance <= 0, ensure refsector is first -->
        <do_if value="($mingatedistance le 0) and $refsector? and not $spaces.indexof.{$refsector}?">
          <set_value name="$spaces.{1}" exact="$refsector" operation="insert"/>
        </do_if>
        
        <!-- If still no sectors, add ship's current sector -->
        <do_if value="not $spaces.count">
          <do_if value="$mysector? and $mysector.exists">
            <set_value name="$spaces.{1}" exact="$mysector" operation="insert"/>
          </do_if>
        </do_if>
        
        <!-- Return sorted list of sectors -->
        <return value="$spaces"/>
      </actions>
    </library>
    
    <!-- Build Station Distance Cache from Offers -->
    <library name="GT_BuildStationDistanceCache" purpose="run_actions">
      <params>
        <param name="sellOffers" comment="List of sell offers"/>
        <param name="buyOffers" comment="List of buy offers"/>
        <param name="homeSector" comment="Home/base sector for distance calculation"/>
      </params>
      <actions>
        <!-- Extract unique stations from offers -->
        <set_value name="$sellStations" exact="[]"/>
        <set_value name="$buyStations" exact="[]"/>
        <set_value name="$sellStationsSeen" exact="table[]"/>
        <set_value name="$buyStationsSeen" exact="table[]"/>
        <do_all exact="$sellOffers.count" counter="$i">
          <set_value name="$station" exact="$sellOffers.{$i}.owner"/>
          <do_if value="not $sellStationsSeen.{$station}?">
            <set_value name="$sellStationsSeen.{$station}" exact="true"/>
            <append_to_list name="$sellStations" exact="$station"/>
          </do_if>
        </do_all>
        <do_all exact="$buyOffers.count" counter="$i">
          <set_value name="$station" exact="$buyOffers.{$i}.owner"/>
          <do_if value="not $buyStationsSeen.{$station}?">
            <set_value name="$buyStationsSeen.{$station}" exact="true"/>
            <append_to_list name="$buyStations" exact="$station"/>
          </do_if>
        </do_all>
        <!-- Calculate distance cache for sell stations -->
        <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculateStationDistanceCache" result="$sellDistanceCache">
          <param name="stations" value="$sellStations"/>
          <param name="homeSector" value="$homeSector"/>
        </run_actions>
        <!-- Calculate distance cache for buy stations -->
        <run_actions ref="md.GT_Pathfinding_Utilities.GT_CalculateStationDistanceCache" result="$buyDistanceCache">
          <param name="stations" value="$buyStations"/>
          <param name="homeSector" value="$homeSector"/>
        </run_actions>
        <!-- Merge caches -->
        <set_value name="$stationDistanceCache" exact="table[]"/>
        <do_all exact="$sellStations.count" counter="$i">
          <set_value name="$station" exact="$sellStations.{$i}"/>
          <set_value name="$stationDistanceCache.{$station}" exact="$sellDistanceCache.{$station}"/>
        </do_all>
        <do_all exact="$buyStations.count" counter="$i">
          <set_value name="$station" exact="$buyStations.{$i}"/>
          <set_value name="$stationDistanceCache.{$station}" exact="$buyDistanceCache.{$station}"/>
        </do_all>
        <return value="$stationDistanceCache"/>
      </actions>
    </library>
    
    <!-- Build Trade Sector Lists -->
    <library name="GT_BuildTradeSectorLists" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to build sector lists for"/>
        <param name="homeSector" comment="Home sector for distance calculations"/>
        <param name="maxDistance" comment="Maximum gate distance"/>
        <param name="blacklistgroup" comment="Blacklist group for filtering"/>
      </params>
      <actions>
        <!-- Builds sector lists for trade searches with isolation handling -->
        <!-- Returns: $buyspaces, $sellspaces, $shipIsIsolated -->
        <!-- For isolated ships: Uses current sector only -->
        <!-- For normal ships: Uses GT_FindSectorsInRange to build lists -->
        <set_value name="$currentSector" exact="$ship.sector"/>
        <set_value name="$shipIsIsolated" exact="false"/>
        <set_value name="$buyspaces" exact="[]"/>
        <set_value name="$sellspaces" exact="[]"/>
        
        <!-- Check if ship is isolated -->
        <do_if value="$currentSector?">
          <run_actions ref="md.GT_Blacklist_Utilities.GT_CheckConnectedSectorsBlacklisted" result="$isolationCheck">
            <param name="sector" value="$currentSector"/>
            <param name="ship" value="$ship"/>
            <param name="returnDetails" value="false"/>
          </run_actions>
          <set_value name="$isolatedValue" exact="@$isolationCheck.$IsIsolated"/>
          <set_value name="$shipIsIsolated" exact="if $isolatedValue? and ($isolatedValue == true or $isolatedValue == 1) then true else false"/>
          <do_if value="$shipIsIsolated">
            <!-- Ship is isolated - use current sector only -->
            <set_value name="$buyspaces" exact="[$currentSector]"/>
            <set_value name="$sellspaces" exact="[$currentSector]"/>
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
              <set_value name="$sectorName" exact="@$currentSector.knownname"/>
              <debug_text text="'[GT-Search] (' + $ship.idcode + ') ðŸ”’ ISOLATED: Using current sector only: ' + (if $sectorName? then $sectorName else 'NULL') + ' (price range expanded)'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Build sector lists for non-isolated ships -->
        <do_if value="not $shipIsIsolated">
          <!-- Build buy sector list (sectors where ship can buy from) -->
          <run_actions ref="md.GT_Pathfinding_Utilities.GT_FindSectorsInRange" result="$buyspaces">
            <param name="refobject" value="$homeSector"/>
            <param name="mingatedistance" value="0"/>
            <param name="maxgatedistance" value="$maxDistance"/>
            <param name="ship" value="$ship"/>
            <param name="blacklistgroup" value="$blacklistgroup"/>
            <param name="applyblacklist" value="true"/>
          </run_actions>
          
          <!-- Build sell sector list (sectors where ship can sell to) -->
          <!-- For now, use same range as buy (can be optimized later if maxbuy != maxsell) -->
          <set_value name="$sellspaces" exact="$buyspaces"/>
          
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GT-Search] (' + $ship.idcode + ') âœ… VANILLA PATTERN: Built sector lists - ' + $buyspaces.count + ' buy sectors, ' + $sellspaces.count + ' sell sectors (max distance: ' + $maxDistance + ')'" chance="100"/>
          </do_if>
        </do_if>
        
        <set_value name="$result" exact="table[]"/>
        <set_value name="$result.$BuySpaces" exact="$buyspaces"/>
        <set_value name="$result.$SellSpaces" exact="$sellspaces"/>
        <set_value name="$result.$ShipIsIsolated" exact="$shipIsIsolated"/>
        <return value="$result"/>
      </actions>
    </library>
    
  </cues>
</mdscript>
