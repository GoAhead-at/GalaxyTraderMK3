<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Profit_Migration" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/x4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - PROFIT STATISTICS MIGRATION
         Version 0.6.0: Reset inflated profit statistics
         
         CONTEXT: Prior to v0.6.0, profit calculations tracked REVENUE instead of actual PROFIT.
         This resulted in statistics showing ~5-6x higher values than actual earnings.
         
         This migration resets all profit statistics so they start fresh with the corrected calculation.
         ======================================== -->
    
    <!-- Manual profit statistics reset (triggered by player via button in settings) -->
    <cue name="ResetInflatedProfitStats" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <debug_text text="'[GT-ProfitMigration] Starting manual profit statistics reset (player triggered)...'" chance="100"/>
          
          <set_value name="$pilotCount" exact="0"/>
          <set_value name="$shipCount" exact="0"/>
          
          <!-- Reset pilot profit statistics -->
          <do_if value="global.$GT_Pilots? and global.$GT_Pilots.keys.count gt 0">
            <do_all exact="global.$GT_Pilots.keys.count" counter="$i">
              <set_value name="$pilot" exact="global.$GT_Pilots.keys.{$i}"/>
              <set_value name="$pilotData" exact="global.$GT_Pilots.{$pilot}"/>
              
              <!-- Check if pilot has inflated profit (TotalProfit exists and is non-zero) -->
              <do_if value="$pilotData.$TotalProfit? and $pilotData.$TotalProfit gt 0">
                <debug_text text="'[GT-ProfitMigration] Resetting pilot ' + @$pilot.name + ': ' + 
                                  ($pilotData.$TotalProfit / 100) + ' Cr (was REVENUE, not profit) → 0 Cr'" 
                            chance="100"/>
                <set_value name="global.$GT_Pilots.{$pilot}.$TotalProfit" exact="0"/>
                <set_value name="$pilotCount" operation="add"/>
              </do_if>
            </do_all>
          </do_if>
          
          <!-- Reset ship profit statistics -->
          <do_if value="global.$GT_Ships? and global.$GT_Ships.keys.count gt 0">
            <do_all exact="global.$GT_Ships.keys.count" counter="$i">
              <set_value name="$ship" exact="global.$GT_Ships.keys.{$i}"/>
              <set_value name="$shipData" exact="global.$GT_Ships.{$ship}"/>
              
              <!-- Check if ship has inflated profit (TotalProfit exists and is non-zero) -->
              <do_if value="$shipData.$TotalProfit? and $shipData.$TotalProfit gt 0">
                <debug_text text="'[GT-ProfitMigration] Resetting ship ' + $ship.idcode + ': ' + 
                                  ($shipData.$TotalProfit / 100) + ' Cr (was REVENUE, not profit) → 0 Cr'" 
                            chance="100"/>
                <set_value name="global.$GT_Ships.{$ship}.$TotalProfit" exact="0"/>
                <set_value name="$shipCount" operation="add"/>
              </do_if>
            </do_all>
          </do_if>
          
          <!-- Reset global trade statistics -->
          <do_if value="global.$GT_TradeStats? and global.$GT_TradeStats.$TotalProfit?">
            <set_value name="$oldTotalProfit" exact="global.$GT_TradeStats.$TotalProfit"/>
            <set_value name="global.$GT_TradeStats.$TotalProfit" exact="0"/>
            <debug_text text="'[GT-ProfitMigration] Reset global statistics: ' + $oldTotalProfit + ' Cr (was REVENUE) → 0 Cr'" chance="100"/>
          </do_if>
          
          <!-- Reset lifetime profit tracking in logging system -->
          <do_if value="global.$GT_TradeLogging? and global.$GT_TradeLogging.$LifetimeProfit?">
            <set_value name="$lifetimeCount" exact="global.$GT_TradeLogging.$LifetimeProfit.keys.count"/>
            <do_if value="$lifetimeCount gt 0">
              <!-- Clear all lifetime profit entries -->
              <remove_value name="global.$GT_TradeLogging.$LifetimeProfit"/>
              <set_value name="global.$GT_TradeLogging.$LifetimeProfit" exact="table[]"/>
              <debug_text text="'[GT-ProfitMigration] Reset lifetime profit tracking for ' + $lifetimeCount + ' ships'" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- Show summary notification to player -->
          <show_notification text="'GalaxyTrader MK3 - Profit Statistics Reset Complete\n\n' +
                                   'All profit statistics have been reset to 0.\n\n' +
                                   'Reset Summary:\n' +
                                   '• Pilots reset: ' + $pilotCount + '\n' +
                                   '• Ships reset: ' + $shipCount + '\n\n' +
                                   'From now on, statistics will accurately track PROFIT (Revenue - Purchase Cost).\n' +
                                   'Previous versions tracked REVENUE, which showed inflated numbers.\n\n' +
                                   'Trade counts and XP are preserved.'"
                             sound="notification_generic"/>
          
          <debug_text text="'[GT-ProfitMigration] Manual profit statistics reset COMPLETE!' +
                            '\n  Pilots reset: ' + $pilotCount +
                            '\n  Ships reset: ' + $shipCount +
                            '\n  Statistics will now track actual PROFIT instead of REVENUE'"
                      chance="100"/>
      </actions>
    </cue>
    
  </cues>
</mdscript>
