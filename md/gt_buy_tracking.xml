<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Buy_Tracking" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/x4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - BUY TRACKING SYSTEM
         Tracks purchase costs for profit calculation
         ======================================== -->
    
    <!-- Initialize cargo cost tracking on game load (NO DELAY - must be immediate) -->
    <cue name="InitializeCargoCostTracking" instantiate="true">
      <conditions>
        <check_any>
          <event_game_loaded/>
          <event_player_created/>
        </check_any>
      </conditions>
      <actions>
      </actions>
    </cue>
    
    <!-- Process Buy Completion Queue -->
    <!-- Listen for signal instead of polling -->
    <cue name="ProcessBuyCompletion" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_BuyComplete'"/>
        <!-- Only process if initialization has completed (table exists) -->
        <check_value value="global.$GT_CargoCostTracking?"/>
      </conditions>
      <actions>
        <!-- Ensure table exists before processing (handles cue instances created before initialization) -->
        <do_if value="not global.$GT_CargoCostTracking?">
          <set_value name="global.$GT_CargoCostTracking" exact="table[]"/>
        </do_if>
        
        <do_if value="global.$GT_BuyCompleteQueue? and global.$GT_BuyCompleteQueue.count gt 0">
          <do_while value="global.$GT_BuyCompleteQueue.count gt 0">
            <set_value name="$data" exact="global.$GT_BuyCompleteQueue.{1}"/>
            <remove_from_list name="global.$GT_BuyCompleteQueue" exact="$data"/>
            <set_value name="$ship" exact="$data.$ship"/>
            
            <!-- Skip if ship no longer registered -->
            <do_if value="not global.$GT_Ships.{$ship}?">
              <!-- <debug_text text="'[GT-BuyTracking] âš  Skipping buy tracking for unregistered ship: ' + $ship.idcode" chance="100"/> -->
              <continue/>
            </do_if>
            
            <!-- Initialize ship's cargo cost tracking if not exists -->
            <do_if value="not global.$GT_CargoCostTracking.{$ship}?">
              <set_value name="global.$GT_CargoCostTracking.{$ship}" exact="table[]"/>
            </do_if>
            
            <!-- Calculate total purchase cost for this buy -->
            <set_value name="$ware" exact="$data.$ware"/>
            <set_value name="$amount" exact="$data.$amount"/>
            <set_value name="$unitPrice" exact="$data.$unitPrice"/>
            <set_value name="$totalCost" exact="$unitPrice * $amount"/>
            
            <!-- Track or update cargo cost for this ware -->
            <do_if value="not global.$GT_CargoCostTracking.{$ship}.{$ware}?">
              <!-- First purchase of this ware -->
              <set_value name="global.$GT_CargoCostTracking.{$ship}.{$ware}" exact="table[
                $Amount = $amount,
                $TotalCost = $totalCost,
                $LastUpdate = player.age
              ]"/>
            </do_if>
            <do_else>
              <!-- Additional purchase - add to existing (weighted average handled automatically) -->
              <set_value name="global.$GT_CargoCostTracking.{$ship}.{$ware}.$Amount" 
                          exact="global.$GT_CargoCostTracking.{$ship}.{$ware}.$Amount + $amount"/>
              <set_value name="global.$GT_CargoCostTracking.{$ship}.{$ware}.$TotalCost" 
                          exact="global.$GT_CargoCostTracking.{$ship}.{$ware}.$TotalCost + $totalCost"/>
              <set_value name="global.$GT_CargoCostTracking.{$ship}.{$ware}.$LastUpdate" exact="player.age"/>
            </do_else>
            
            <!-- Use safe operators for debug text to prevent errors if table structure is invalid -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <set_value name="$trackedAmount" exact="@global.$GT_CargoCostTracking.{$ship}.{$ware}.$Amount"/>
              <set_value name="$trackedCost" exact="@global.$GT_CargoCostTracking.{$ship}.{$ware}.$TotalCost"/>
              <debug_text text="'[GT-BuyTracking] BUY tracked: ' + $ship.idcode + ' bought ' + $amount + ' ' + $ware.name + 
                                ' for ' + ($totalCost / 100) + ' Cr (Total tracked: ' + 
                                (if $trackedAmount? then $trackedAmount else 0) + ' units, ' + 
                                (if $trackedCost? then ($trackedCost / 100) else 0) + ' Cr)'" 
                          chance="100"/>
            </do_if>
          </do_while>
        </do_if>
      </actions>
    </cue>
    
    <!-- Event-driven cleanup: Ship destroyed -->
    <cue name="CleanupOnShipDestroyed" instantiate="true">
      <conditions>
        <event_object_destroyed object="player.entity"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        
        <!-- Only cleanup if this was a registered GT ship with cargo tracking -->
        <do_if value="global.$GT_CargoCostTracking? and global.$GT_CargoCostTracking.{$ship}?">
          <remove_value name="global.$GT_CargoCostTracking.{$ship}"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-BuyTracking] Ship destroyed - cleared cargo tracking: ' + $ship.idcode + ' (Pilot may have survived via ejection - pilot data preserved)'" chance="100"/>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
  </cues>
</mdscript>
