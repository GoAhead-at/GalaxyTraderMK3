<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Trading_Signals" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/x4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - TRADE SIGNAL HANDLER
         Centralized listener for diff patch trade signals
         Replaces complex event_player_trade_completed monitoring
         ======================================== -->
    
    <!-- Trade Success Handler -->
    <!-- Listen for signal instead of polling -->
    <cue name="ProcessTradeSuccess" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_DirectTrade'"/>
      </conditions>
      <actions>
        
        <do_if value="global.$GT_DirectTradeQueue? and global.$GT_DirectTradeQueue.count gt 0">
          <do_while value="global.$GT_DirectTradeQueue.count gt 0">
            <set_value name="$data" exact="global.$GT_DirectTradeQueue.{1}"/>
            <remove_from_list name="global.$GT_DirectTradeQueue" exact="$data"/>
            <set_value name="$ship" exact="$data.$ship"/>
            
            <!-- Skip if ship no longer registered (removed from GT while old trade executing) -->
            <do_if value="not global.$GT_Ships.{$ship}?">
              <debug_text text="'[GT-Signals] ⚠ Skipping trade success for unregistered ship: ' + $ship.idcode + 
                '\n  Reason: Ship was removed from GalaxyTrader while old TradePerform order was still executing' +
                '\n  This is expected behavior when removing ships from GT - vanilla orders continue briefly'"
                chance="100"/>
              <continue/>
            </do_if>
            
            <!-- 1. XP System -->
            <signal_cue_instantly cue="md.GT_XP_Training.ProcessSingleXPEvent" param="$data"/>
            
            <!-- 2. Trade Logging -->
            <signal_cue_instantly cue="md.GT_TradeLogging.LogCompletedTrade" param="$data"/>
            
            <!-- 2.5. Update Ship Statistics (Total Profit and Trades Completed) -->
            <do_if value="md.GT_Fleet_Coordination.UpdateShipStats?">
              <run_actions ref="md.GT_Fleet_Coordination.UpdateShipStats">
                <param name="ship" value="$ship"/>
                <param name="profit" value="$data.$tradeValue"/>
                <param name="tradesCompleted" value="1"/>
              </run_actions>
              <debug_text text="'[GT-Signals] 📊 Updated ship statistics for ' + $ship.idcode + ': +' + ($data.$tradeValue / 100) + ' Cr'" chance="100"/>
            </do_if>
            
            <!-- 3. Fleet Coordination: Release trade reservation -->
            <do_if value="global.$GT_ActiveTradeReservations.{$ship}?">
              <remove_value name="global.$GT_ActiveTradeReservations.{$ship}"/>
              <debug_text text="'[GT-Fleet] ✅ Trade reservation released for ' + $ship.idcode" chance="100"/>
            </do_if>
            
            <!-- 4. Clear failed trades list (trade succeeded, start fresh) -->
            <do_if value="global.$GT_FailedTrades? and global.$GT_FailedTrades.{$ship}?">
              <remove_value name="global.$GT_FailedTrades.{$ship}"/>
              <debug_text text="'[GT-Signals] 🧹 Cleared failed trades list for ' + $ship.idcode + ' (trade succeeded)'" chance="100"/>
            </do_if>
            
            <!-- 4.5. Clear pending trade entry (no longer needed) -->
            <!-- Use library function to clear pending trade data -->
            <run_actions ref="md.GT_Libraries_General.GT_ClearPendingTradeData">
              <param name="ship" value="$ship"/>
            </run_actions>
            
            <!-- Clear sell-only cargo disposal rotation state when trade completes -->
            <!-- Check if ship has no cargo left (cargo emptied by sell) -->
            <set_value name="$hasCargo" exact="false"/>
            <do_if value="$ship.cargo.list? and $ship.cargo.list.count gt 0">
              <set_value name="$hasCargo" exact="true"/>
            </do_if>
            <do_if value="not $hasCargo and global.$GT_ForcedSellLastWare? and global.$GT_ForcedSellLastWare.{$ship}?">
              <remove_value name="global.$GT_ForcedSellLastWare.{$ship}"/>
              <debug_text text="'[GT-Disposal] (' + $ship.idcode + ') ✅ Cleared rotation state (cargo emptied by sell)'" chance="100"/>
            </do_if>
            
            <!-- 5. AI Script Notification (equipment check moved to pre-trade in AI script) -->
            <signal_objects object="$ship" param="'GT_Trade_Completed'"/>
            <debug_text text="'[GT-AI] ✅ Trade completed signal sent to ' + $ship.idcode" chance="100"/>
          </do_while>
        </do_if>
      </actions>
    </cue>
    
    <!-- Trade Failure Handler -->
    <!-- Listen for signal instead of polling -->
    <cue name="ProcessTradeFailure" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_TradeFailure'"/>
      </conditions>
      <actions>
        
        <do_if value="global.$GT_TradeFailureQueue? and global.$GT_TradeFailureQueue.count gt 0">
          <do_while value="global.$GT_TradeFailureQueue.count gt 0">
            <set_value name="$data" exact="global.$GT_TradeFailureQueue.{1}"/>
            <remove_from_list name="global.$GT_TradeFailureQueue" exact="$data"/>
            <set_value name="$ship" exact="$data.$ship"/>
            
            <!-- Skip if ship no longer registered (removed from GT while old trade executing) -->
            <do_if value="not global.$GT_Ships.{$ship}?">
              <debug_text text="'[GT-Signals] ⚠ Skipping trade failure for unregistered ship: ' + $ship.idcode + 
                '\n  Reason: Ship was removed from GalaxyTrader while old TradePerform order was still executing' +
                '\n  Failure type: ' + $data.$reason +
                '\n  This is expected behavior when removing ships from GT - vanilla orders continue briefly'"
                chance="100"/>
              <continue/>
            </do_if>
            
            <debug_text text="'[GT-Signals] ❌ Trade failed: ' + $ship.idcode + ' - ' + $data.$reason" chance="100"/>
            
            <!-- 1. Log failure -->
            <debug_text text="'[GT-Failure] ' + $ship.idcode + ' trade failed: ' + $data.$reason + ' (' + @$data.$failureText + ')'" chance="100"/>
            
            <!-- 2. Release fleet reservation if exists -->
            <do_if value="global.$GT_ActiveTradeReservations.{$ship}?">
              <remove_value name="global.$GT_ActiveTradeReservations.{$ship}"/>
            </do_if>
            
            <!-- 3. Categorize failure type and build structured payload -->
            <!-- Determine failure category and build structured payload for unified signal -->
            <set_value name="$failureCategory" exact="'MARKET'"/> <!-- Default: market failure -->
            <set_value name="$shouldTryNext" exact="false"/>
            <set_value name="$pathBlocked" exact="false"/>
            
            <!-- Check if this is a pathing failure -->
            <set_value name="$pathingFailureReasons" exact="[
              'ERR_NO_PATH_TO_DESTINATION',
              'ERR_DESTINATION_BLACKLISTED', 
              'ERR_SECTOR_BLACKLISTED',
              'TRADEPARTNER_BLACKLISTED',
              'ERR_CANNOT_DOCK',
              'ROUTE_PATH_CHANGED'
            ]"/>
            
            <set_value name="$isPathingFailure" exact="false"/>
            <do_all exact="$pathingFailureReasons.count" counter="$i">
              <do_if value="$pathingFailureReasons.{$i} == $data.$reason">
                <set_value name="$isPathingFailure" exact="true"/>
                <set_value name="$failureCategory" exact="'PATHING'"/>
                <set_value name="$shouldTryNext" exact="true"/>
                <set_value name="$pathBlocked" exact="true"/>
                <break/>
              </do_if>
            </do_all>
            
            <!-- Handle pathing failures: track failed routes -->
            <do_if value="$isPathingFailure">
              <!-- PATHFINDING/BLACKLIST FAILURE: Trade route not accessible -->
              <!-- This means the trade is theoretically good, but ship can't reach it -->
              <!-- Solution: Try NEXT BEST TRADE from cache (skip this failed one) -->
              
              <!-- Track this failed trade so cache search skips it -->
              <!-- Initialization guarantees global.$GT_FailedTrades exists -->
              <do_if value="not global.$GT_FailedTrades.{$ship}?">
                <set_value name="global.$GT_FailedTrades.{$ship}" exact="[]"/>
              </do_if>
              
              <!-- Get complete trade route from pending trades (stored before order creation) -->
              <!-- Only proceed if we have complete pending trade data - NO FALLBACK -->
              <!-- Incomplete data (from partial failure signals) cannot be used for blacklisting -->
              <do_if value="global.$GT_PendingTrades? and global.$GT_PendingTrades.{$ship}? and 
                            global.$GT_PendingTrades.{$ship}.$BuyStation? and 
                            global.$GT_PendingTrades.{$ship}.$SellStation? and 
                            global.$GT_PendingTrades.{$ship}.$Ware?">
                <!-- Use complete route from pending trades -->
                <set_value name="$buyStation" exact="global.$GT_PendingTrades.{$ship}.$BuyStation"/>
                <set_value name="$sellStation" exact="global.$GT_PendingTrades.{$ship}.$SellStation"/>
                <set_value name="$ware" exact="global.$GT_PendingTrades.{$ship}.$Ware"/>
                
                <debug_text text="'[GT-Failure] ✅ RETRIEVED complete trade from pending:' +
                  '\n  Buy: ' + @$buyStation.knownname +
                  '\n  Sell: ' + @$sellStation.knownname +
                  '\n  Ware: ' + @$ware.name"
                  chance="100"/>
                
                <!-- Clean up pending trade entry -->
                <!-- Use library function to clear pending trade data -->
                <run_actions ref="md.GT_Libraries_General.GT_ClearPendingTradeData">
                  <param name="ship" value="$ship"/>
                </run_actions>
                
                <!-- Extract sectors - only store sector PAIR (not individual stations) -->
                <set_value name="$buySector" exact="@$buyStation.sector"/>
                <set_value name="$sellSector" exact="@$sellStation.sector"/>
                
                <!-- Create failed trade record with complete sector information -->
                <set_value name="$failedTradeRecord" exact="table[
                  $BuySector = $buySector,
                  $SellSector = $sellSector,
                  $Reason = $data.$reason,
                  $Timestamp = player.age
                ]"/>
                
                <append_to_list name="global.$GT_FailedTrades.{$ship}" exact="$failedTradeRecord"/>
                
                <debug_text text="'[GT-Failure] 📝 BLOCKED sector pair for ' + $ship.idcode + ':' +
                  '\n  Route: ' + @$buySector.knownname + ' → ' + @$sellSector.knownname +
                  '\n  Reason: ' + $data.$reason +
                  '\n  Total blocked routes for ship: ' + global.$GT_FailedTrades.{$ship}.count +
                  '\n  ⚠ ALL station combinations in this sector pair will be filtered'"
                  chance="100"/>
              </do_if>
              <do_else>
                <!-- NO PENDING TRADE DATA: Cannot track failure -->
                <!-- This indicates a serious issue: pending trade was cleared before failure occurred -->
                <!-- OR pending trade was never created in the first place -->
                <debug_text text="'[GT-Failure] ❌ CRITICAL: Cannot track failed trade for ' + $ship.idcode +
                  '\n  Pending trade entry MISSING - this should never happen!' +
                  '\n  Failure reason: ' + $data.$reason +
                  '\n  Failure partner: ' + @$data.$partner.knownname +
                  '\n  ⚠ Ship will continue without blacklisting this route'" chance="100"/>
              </do_else>
              
              <do_if value="global.$GT_FailedTrades.{$ship}?">
                <debug_text text="'[GT-Failure] 🚫 PATHFINDING FAILURE: ' + $ship.idcode + ' | Failed trades tracked: ' + global.$GT_FailedTrades.{$ship}.count" chance="100"/>
              </do_if>
            </do_if>
            <do_else>
              <!-- MARKET FAILURE: Market conditions changed (destroyed, no stock, etc.) -->
              <!-- Solution: Start NEW SEARCH to find current market opportunities -->
              
              <!-- Clean up pending trade entry -->
              <!-- Use library function to clear pending trade data -->
              <run_actions ref="md.GT_Libraries_General.GT_ClearPendingTradeData">
                <param name="ship" value="$ship"/>
              </run_actions>
            </do_else>
            
            <!-- Build structured failure payload for unified signal -->
            <set_value name="$failurePayload" exact="table[
              $Ship = $ship,
              $Reason = $data.$reason,
              $FailureText = $data.$failureText,
              $Partner = $data.$partner,
              $IsBuying = $data.$isBuying,
              $ReasonType = $failureCategory,
              $PathBlocked = $pathBlocked,
              $ShouldTryNext = $shouldTryNext,
              $Timestamp = player.age
            ]"/>
            
            <!-- Send unified GT_Trade_Failed signal with structured payload -->
            <do_if value="$isPathingFailure">
              <debug_text text="'[GT-Signals] 📡 Sending GT_Trade_Failed (PATHING) signal to ' + $ship.idcode + ' - will try next cached trade'" chance="100"/>
            </do_if>
            <do_else>
              <debug_text text="'[GT-Failure] ❌ MARKET FAILURE: ' + $ship.idcode + ' - market conditions changed - will search for new trade'" chance="100"/>
            </do_else>
            
            <signal_objects object="$ship" param="'GT_Trade_Failed'" param2="$failurePayload"/>
            <debug_text text="'[GT-Signals] ✅ GT_Trade_Failed signal sent successfully to ' + $ship.idcode + ' (ReasonType: ' + $failureCategory + ', ShouldTryNext: ' + $shouldTryNext + ')'" chance="100"/>
            
            <!-- 4. Cargo Safety: Handle destroyed sell station -->
            <do_if value="$data.$reason == 'ERR_TRADEPARTNER_DESTROYED' and not $data.$isBuying">
              <debug_text text="'[GT-CargoSafety] ⚠ Sell station destroyed for ' + $ship.idcode + ' - Cargo safety system will handle this'" chance="100"/>
              <!-- TODO: Uncomment when cargo safety system is implemented -->
            </do_if>
          </do_while>
        </do_if>
      </actions>
    </cue>
    
    <!-- All handlers are now inlined in ProcessTradeSuccess and ProcessTradeFailure
         for better performance and simpler debugging -->
    
  </cues>
</mdscript>
