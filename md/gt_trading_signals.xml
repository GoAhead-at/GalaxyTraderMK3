<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Trading_Signals" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/x4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - TRADE SIGNAL HANDLER
         Centralized listener for diff patch trade signals
         Replaces complex event_player_trade_completed monitoring
         ======================================== -->
    
    <!-- Trade Success Handler -->
    <cue name="ProcessTradeSuccess" instantiate="true" checkinterval="0.05s">
      <conditions>
        <check_value value="global.$GT_DirectTradePending?"/>
      </conditions>
      <actions>
        <remove_value name="global.$GT_DirectTradePending"/>
        
        <do_if value="global.$GT_DirectTradeQueue? and global.$GT_DirectTradeQueue.count gt 0">
          <do_while value="global.$GT_DirectTradeQueue.count gt 0">
            <set_value name="$data" exact="global.$GT_DirectTradeQueue.{1}"/>
            <remove_from_list name="global.$GT_DirectTradeQueue" exact="$data"/>
            <set_value name="$ship" exact="$data.$ship"/>
            
            <!-- 1. XP System -->
            <signal_cue_instantly cue="md.GT_XP_Training.ProcessSingleXPEvent" param="$data"/>
            
            <!-- 2. Trade Logging -->
            <signal_cue_instantly cue="md.GT_TradeLogging.LogCompletedTrade" param="$data"/>
            
            <!-- 3. Fleet Coordination: Release trade reservation -->
            <do_if value="global.$GT_ActiveTradeReservations.{$ship}?">
              <remove_value name="global.$GT_ActiveTradeReservations.{$ship}"/>
              <debug_text text="'[GT-Fleet] ✅ Trade reservation released for ' + $ship.idcode" chance="100"/>
            </do_if>
            
            <!-- 4. Auto-Repair: Check if ship needs repairs -->
            <do_if value="$ship.hullpercentage lt 95">
              <signal_objects object="player.galaxy" param="'GT_CheckAutoRepair'" param2="$ship"/>
            </do_if>
            
            <!-- 5. AI Script Notification -->
            <signal_objects object="$ship" param="'GT_Trade_Completed'"/>
            <debug_text text="'[GT-AI] ✅ Trade completed signal sent to ' + $ship.idcode" chance="100"/>
          </do_while>
        </do_if>
      </actions>
    </cue>
    
    <!-- Trade Failure Handler -->
    <cue name="ProcessTradeFailure" instantiate="true" checkinterval="0.05s">
      <conditions>
        <check_value value="global.$GT_TradeFailurePending?"/>
      </conditions>
      <actions>
        <remove_value name="global.$GT_TradeFailurePending"/>
        
        <do_if value="global.$GT_TradeFailureQueue? and global.$GT_TradeFailureQueue.count gt 0">
          <do_while value="global.$GT_TradeFailureQueue.count gt 0">
            <set_value name="$data" exact="global.$GT_TradeFailureQueue.{1}"/>
            <remove_from_list name="global.$GT_TradeFailureQueue" exact="$data"/>
            <set_value name="$ship" exact="$data.$ship"/>
            
            <debug_text text="'[GT-Signals] ❌ Trade failed: ' + $ship.idcode + ' - ' + $data.$reason" chance="100"/>
            
            <!-- 1. Log failure -->
            <debug_text text="'[GT-Failure] ' + $ship.idcode + ' trade failed: ' + $data.$reason + ' (' + @$data.$failureText + ')'" chance="100"/>
            
            <!-- 2. Notify AI -->
            <signal_objects object="$ship" param="'GT_Trade_Failed'" param2="$data.$reason"/>
            
            <!-- 3. Release fleet reservation if exists -->
            <do_if value="global.$GT_ActiveTradeReservations.{$ship}?">
              <remove_value name="global.$GT_ActiveTradeReservations.{$ship}"/>
            </do_if>
            
            <!-- 4. Cargo Safety: Handle destroyed sell station -->
            <do_if value="$data.$reason == 'ERR_TRADEPARTNER_DESTROYED' and not $data.$isBuying">
              <debug_text text="'[GT-CargoSafety] ⚠ Sell station destroyed for ' + $ship.idcode + ' - Cargo safety system will handle this'" chance="100"/>
              <!-- TODO: Uncomment when cargo safety system is implemented -->
            </do_if>
          </do_while>
        </do_if>
      </actions>
    </cue>
    
    <!-- All handlers are now inlined in ProcessTradeSuccess and ProcessTradeFailure
         for better performance and simpler debugging -->
    
  </cues>
</mdscript>
