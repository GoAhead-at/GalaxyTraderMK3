<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Trading_Signals" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/x4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - TRADE SIGNAL HANDLER
         Centralized listener for diff patch trade signals
         Replaces complex event_player_trade_completed monitoring
         ======================================== -->
    
    <!-- Trade Success Handler -->
    <cue name="ProcessTradeSuccess" instantiate="true" checkinterval="0.05s">
      <conditions>
        <check_value value="global.$GT_DirectTradePending?"/>
      </conditions>
      <actions>
        <remove_value name="global.$GT_DirectTradePending"/>
        
        <do_if value="global.$GT_DirectTradeQueue? and global.$GT_DirectTradeQueue.count gt 0">
          <do_while value="global.$GT_DirectTradeQueue.count gt 0">
            <set_value name="$data" exact="global.$GT_DirectTradeQueue.{1}"/>
            <remove_from_list name="global.$GT_DirectTradeQueue" exact="$data"/>
            <set_value name="$ship" exact="$data.$ship"/>
            
            <!-- 1. XP System -->
            <signal_cue_instantly cue="md.GT_XP_Training.ProcessSingleXPEvent" param="$data"/>
            
            <!-- 2. Trade Logging -->
            <signal_cue_instantly cue="md.GT_TradeLogging.LogCompletedTrade" param="$data"/>
            
            <!-- 3. Fleet Coordination: Release trade reservation -->
            <do_if value="global.$GT_ActiveTradeReservations.{$ship}?">
              <remove_value name="global.$GT_ActiveTradeReservations.{$ship}"/>
              <debug_text text="'[GT-Fleet] âœ… Trade reservation released for ' + $ship.idcode" chance="100"/>
            </do_if>
            
            <!-- 4. Clear failed trades list (trade succeeded, start fresh) -->
            <do_if value="global.$GT_FailedTrades? and global.$GT_FailedTrades.{$ship}?">
              <remove_value name="global.$GT_FailedTrades.{$ship}"/>
              <debug_text text="'[GT-Signals] ðŸ§¹ Cleared failed trades list for ' + $ship.idcode + ' (trade succeeded)'" chance="100"/>
            </do_if>
            
            <!-- 4.5. Clear pending trade entry (no longer needed) -->
            <do_if value="global.$GT_PendingTrades? and global.$GT_PendingTrades.{$ship}?">
              <remove_value name="global.$GT_PendingTrades.{$ship}"/>
            </do_if>
            
            <!-- 5. AI Script Notification (equipment check moved to pre-trade in AI script) -->
            <signal_objects object="$ship" param="'GT_Trade_Completed'"/>
            <debug_text text="'[GT-AI] âœ… Trade completed signal sent to ' + $ship.idcode" chance="100"/>
          </do_while>
        </do_if>
      </actions>
    </cue>
    
    <!-- Trade Failure Handler -->
    <cue name="ProcessTradeFailure" instantiate="true" checkinterval="0.05s">
      <conditions>
        <check_value value="global.$GT_TradeFailurePending?"/>
      </conditions>
      <actions>
        <remove_value name="global.$GT_TradeFailurePending"/>
        
        <do_if value="global.$GT_TradeFailureQueue? and global.$GT_TradeFailureQueue.count gt 0">
          <do_while value="global.$GT_TradeFailureQueue.count gt 0">
            <set_value name="$data" exact="global.$GT_TradeFailureQueue.{1}"/>
            <remove_from_list name="global.$GT_TradeFailureQueue" exact="$data"/>
            <set_value name="$ship" exact="$data.$ship"/>
            
            <debug_text text="'[GT-Signals] âŒ Trade failed: ' + $ship.idcode + ' - ' + $data.$reason" chance="100"/>
            
            <!-- 1. Log failure -->
            <debug_text text="'[GT-Failure] ' + $ship.idcode + ' trade failed: ' + $data.$reason + ' (' + @$data.$failureText + ')'" chance="100"/>
            
            <!-- 2. Release fleet reservation if exists -->
            <do_if value="global.$GT_ActiveTradeReservations.{$ship}?">
              <remove_value name="global.$GT_ActiveTradeReservations.{$ship}"/>
            </do_if>
            
            <!-- 3. Categorize failure type and notify AI accordingly -->
            <set_value name="$isPathingFailure" exact="false"/>
            <set_value name="$pathingFailureReasons" exact="[
              'ERR_NO_PATH_TO_DESTINATION',
              'ERR_DESTINATION_BLACKLISTED', 
              'ERR_SECTOR_BLACKLISTED',
              'TRADEPARTNER_BLACKLISTED',
              'ERR_CANNOT_DOCK'
            ]"/>
            
            <do_if value="$pathingFailureReasons.indexof.{$data.$reason}">
              <set_value name="$isPathingFailure" exact="true"/>
            </do_if>
            
            <do_if value="$isPathingFailure">
              <!-- PATHFINDING/BLACKLIST FAILURE: Trade route not accessible -->
              <!-- This means the trade is theoretically good, but ship can't reach it -->
              <!-- Solution: Try NEXT BEST TRADE from cache (skip this failed one) -->
              
              <!-- Track this failed trade so cache search skips it -->
              <do_if value="not global.$GT_FailedTrades?">
                <set_value name="global.$GT_FailedTrades" exact="table[]"/>
              </do_if>
              <do_if value="not global.$GT_FailedTrades.{$ship}?">
                <set_value name="global.$GT_FailedTrades.{$ship}" exact="[]"/>
              </do_if>
              
              <!-- Get complete trade route from pending trades (stored before order creation) -->
              <!-- CRITICAL: Only proceed if we have complete pending trade data - NO FALLBACK -->
              <!-- Incomplete data (from partial failure signals) cannot be used for blacklisting -->
              <do_if value="global.$GT_PendingTrades? and global.$GT_PendingTrades.{$ship}?">
                <!-- Use complete route from pending trades -->
                <set_value name="$buyStation" exact="global.$GT_PendingTrades.{$ship}.$BuyStation"/>
                <set_value name="$sellStation" exact="global.$GT_PendingTrades.{$ship}.$SellStation"/>
                <set_value name="$ware" exact="global.$GT_PendingTrades.{$ship}.$Ware"/>
                
                <debug_text text="'[GT-Failure] âœ… RETRIEVED complete trade from pending:' +
                  '\n  Buy: ' + @$buyStation.knownname +
                  '\n  Sell: ' + @$sellStation.knownname +
                  '\n  Ware: ' + @$ware.name"
                  chance="100"/>
                
                <!-- Clean up pending trade entry -->
                <remove_value name="global.$GT_PendingTrades.{$ship}"/>
                
                <!-- Extract sectors - only store sector PAIR (not individual stations) -->
                <set_value name="$buySector" exact="@$buyStation.sector"/>
                <set_value name="$sellSector" exact="@$sellStation.sector"/>
                
                <!-- Create failed trade record with complete sector information -->
                <set_value name="$failedTradeRecord" exact="table[
                  $BuySector = $buySector,
                  $SellSector = $sellSector,
                  $Reason = $data.$reason,
                  $Timestamp = player.age
                ]"/>
                
                <append_to_list name="global.$GT_FailedTrades.{$ship}" exact="$failedTradeRecord"/>
                
                <debug_text text="'[GT-Failure] ðŸ“ BLOCKED sector pair for ' + $ship.idcode + ':' +
                  '\n  Route: ' + @$buySector.knownname + ' â†’ ' + @$sellSector.knownname +
                  '\n  Reason: ' + $data.$reason +
                  '\n  Total blocked routes for ship: ' + global.$GT_FailedTrades.{$ship}.count +
                  '\n  âš  ALL station combinations in this sector pair will be filtered'"
                  chance="100"/>
              </do_if>
              <do_else>
                <!-- NO PENDING TRADE DATA: Cannot track failure -->
                <!-- This indicates a serious issue: pending trade was cleared before failure occurred -->
                <!-- OR pending trade was never created in the first place -->
                <debug_text text="'[GT-Failure] âŒ CRITICAL: Cannot track failed trade for ' + $ship.idcode +
                  '\n  Pending trade entry MISSING - this should never happen!' +
                  '\n  Failure reason: ' + $data.$reason +
                  '\n  Failure partner: ' + @$data.$partner.knownname +
                  '\n  âš  Ship will continue without blacklisting this route'" chance="100"/>
              </do_else>
              
              <do_if value="global.$GT_FailedTrades.{$ship}?">
                <debug_text text="'[GT-Failure] ðŸš« PATHFINDING FAILURE: ' + $ship.idcode + ' | Failed trades tracked: ' + global.$GT_FailedTrades.{$ship}.count" chance="100"/>
              </do_if>
              
              <debug_text text="'[GT-Signals] ðŸ“¡ Sending GT_Try_Next_Trade signal to ' + $ship.idcode" chance="100"/>
              <signal_objects object="$ship" param="'GT_Try_Next_Trade'" param2="$data.$reason"/>
              <debug_text text="'[GT-Signals] âœ… GT_Try_Next_Trade signal sent successfully to ' + $ship.idcode" chance="100"/>
            </do_if>
            <do_else>
              <!-- OTHER FAILURE: Market conditions changed (destroyed, no stock, etc.) -->
              <!-- Solution: Start NEW SEARCH to find current market opportunities -->
              
              <!-- Clean up pending trade entry -->
              <do_if value="global.$GT_PendingTrades? and global.$GT_PendingTrades.{$ship}?">
                <remove_value name="global.$GT_PendingTrades.{$ship}"/>
              </do_if>
              
              <debug_text text="'[GT-Failure] âŒ MARKET FAILURE: ' + $ship.idcode + ' - market conditions changed - will search for new trade'" chance="100"/>
              <signal_objects object="$ship" param="'GT_Trade_Failed'" param2="$data.$reason"/>
            </do_else>
            
            <!-- 4. Cargo Safety: Handle destroyed sell station -->
            <do_if value="$data.$reason == 'ERR_TRADEPARTNER_DESTROYED' and not $data.$isBuying">
              <debug_text text="'[GT-CargoSafety] âš  Sell station destroyed for ' + $ship.idcode + ' - Cargo safety system will handle this'" chance="100"/>
              <!-- TODO: Uncomment when cargo safety system is implemented -->
            </do_if>
          </do_while>
        </do_if>
      </actions>
    </cue>
    
    <!-- All handlers are now inlined in ProcessTradeSuccess and ProcessTradeFailure
         for better performance and simpler debugging -->
    
  </cues>
</mdscript>
