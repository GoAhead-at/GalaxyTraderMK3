<?xml version="1.0" encoding="utf-8"?>
<!--
  GalaxyTrader MK1 — Global Settings
  
  Initializes MK1-specific settings (global.$GT_MK1_GlobalSettings) and
  registers a separate Simple Menu API options menu for MK1 Station Trader.
-->
<mdscript name="GT_MK1_GlobalSettings" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>

    <!-- ================================================================ -->
    <!-- MK1 Settings Initialization                                      -->
    <!-- Runs on game load / new game — preserves saved settings          -->
    <!-- ================================================================ -->
    <cue name="MK1_Init" instantiate="true" version="1">
      <conditions>
        <check_any>
          <event_game_loaded/>
          <event_player_created/>
        </check_any>
      </conditions>
      <actions>
        <!-- Only initialize if settings don't exist yet (preserve saves) -->
        <do_if value="not global.$GT_MK1_GlobalSettings?">
          <set_value name="global.$GT_MK1_GlobalSettings" exact="table[]"/>

          <!-- Station Trader Defaults -->
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader" exact="table[]"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultMaxSell" exact="0" comment="0 = skill-based"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultSellTarget" exact="90"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultBuyTarget" exact="80"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultIgnoreTradeRules" exact="false"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultBacktrackTolerance" exact="1"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$WaitTimeNoTrades" exact="60s"/>

          <!-- Debug Settings (shares global debug toggle with MK3 via $GT_GlobalSettings) -->
          <set_value name="global.$GT_MK1_GlobalSettings.$Debug" exact="table[]"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$Debug.$EnableDebugLogging" exact="false"/>

          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK1] Settings initialized (first load)'" chance="100"/>
          </do_if>
        </do_if>

        <!-- Ensure sub-tables exist (handles saves from older versions) -->
        <do_if value="not global.$GT_MK1_GlobalSettings.$StationTrader?">
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader" exact="table[]"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultMaxSell" exact="0"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultSellTarget" exact="90"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultBuyTarget" exact="80"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultIgnoreTradeRules" exact="false"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultBacktrackTolerance" exact="1"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$WaitTimeNoTrades" exact="60s"/>
        </do_if>
        <do_if value="not global.$GT_MK1_GlobalSettings.$Debug?">
          <set_value name="global.$GT_MK1_GlobalSettings.$Debug" exact="table[]"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$Debug.$EnableDebugLogging" exact="false"/>
        </do_if>

        <debug_text text="'[GalaxyTrader MK1] MK1 settings ready'" chance="if @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging then 100 else 0"/>
      </actions>
    </cue>

    <!-- ================================================================ -->
    <!-- Simple Menu API Registration                                     -->
    <!-- ================================================================ -->
    <cue name="MK1_MenuRegistration" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.Simple_Menu_API.Reloaded"/>
      </conditions>
      <actions>
        <!-- Ensure settings are initialized before menu registration -->
        <do_if value="not global.$GT_MK1_GlobalSettings?">
          <set_value name="global.$GT_MK1_GlobalSettings" exact="table[]"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader" exact="table[]"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultMaxSell" exact="0"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultSellTarget" exact="90"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultBuyTarget" exact="80"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultIgnoreTradeRules" exact="false"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultBacktrackTolerance" exact="1"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$WaitTimeNoTrades" exact="60s"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$Debug" exact="table[]"/>
          <set_value name="global.$GT_MK1_GlobalSettings.$Debug.$EnableDebugLogging" exact="false"/>
        </do_if>

        <!-- Register MK1 options menu -->
        <signal_cue_instantly cue="md.Simple_Menu_API.Register_Options_Menu" param="table[
          $id = 'gt_mk1_settings_menu',
          $columns = 6,
          $title = {77000, 30500},
          $onOpen = MK1_SettingsMenu,
          $defaultFocus = false
        ]"/>

        <debug_text text="'[GalaxyTrader MK1] Settings menu registered with Simple Menu API'" chance="if @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging then 100 else 0"/>
      </actions>
    </cue>

    <!-- ================================================================ -->
    <!-- MK1 Settings Menu Builder                                        -->
    <!-- Called by Simple Menu API when player opens the MK1 settings     -->
    <!-- ================================================================ -->
    <cue name="MK1_SettingsMenu" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$menu" exact="event.param"/>

        <!-- Section Header: Station Trader Defaults -->
        <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row" param="table[
          $columns = table[
            $col1 = table[$text = {77000, 30501}, $font = 'Zlib_bold', $color = table[$r = 180, $g = 200, $b = 255]],
            $col2 = table[],
            $col3 = table[],
            $col4 = table[],
            $col5 = table[],
            $col6 = table[]
          ]
        ]"/>

        <!-- Default Max Sell Distance -->
        <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row" param="table[
          $columns = table[
            $col1 = table[$text = {77000, 30502}],
            $col2 = table[$type = 'slidercell', $value = global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultMaxSell, $min = 0, $max = 25, $step = 1, $echo = 'mk1_maxsell', $onChange = MK1_UpdateSliderValue],
            $col3 = table[],
            $col4 = table[],
            $col5 = table[],
            $col6 = table[]
          ]
        ]"/>

        <!-- Default Sell Cargo Fill Target -->
        <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row" param="table[
          $columns = table[
            $col1 = table[$text = {77000, 30503}],
            $col2 = table[$type = 'slidercell', $value = global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultSellTarget, $min = 50, $max = 100, $step = 5, $echo = 'mk1_selltarget', $onChange = MK1_UpdateSliderValue],
            $col3 = table[],
            $col4 = table[],
            $col5 = table[],
            $col6 = table[]
          ]
        ]"/>

        <!-- Default Buy Cargo Fill Target -->
        <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row" param="table[
          $columns = table[
            $col1 = table[$text = {77000, 30507}],
            $col2 = table[$type = 'slidercell', $value = global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultBuyTarget, $min = 50, $max = 100, $step = 5, $echo = 'mk1_buytarget', $onChange = MK1_UpdateSliderValue],
            $col3 = table[],
            $col4 = table[],
            $col5 = table[],
            $col6 = table[]
          ]
        ]"/>

        <!-- Default Ignore Trade Rules -->
        <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row" param="table[
          $columns = table[
            $col1 = table[$text = {77000, 30504}],
            $col2 = table[$type = 'checkbox', $value = global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultIgnoreTradeRules, $echo = 'mk1_ignoretraderules', $onClick = MK1_ToggleSetting],
            $col3 = table[],
            $col4 = table[],
            $col5 = table[],
            $col6 = table[]
          ]
        ]"/>

        <!-- Default Backtrack Tolerance -->
        <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row" param="table[
          $columns = table[
            $col1 = table[$text = {77000, 30505}],
            $col2 = table[$type = 'slidercell', $value = global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultBacktrackTolerance, $min = 0, $max = 5, $step = 1, $echo = 'mk1_backtrack', $onChange = MK1_UpdateSliderValue],
            $col3 = table[],
            $col4 = table[],
            $col5 = table[],
            $col6 = table[]
          ]
        ]"/>

        <!-- Wait Time When No Trades -->
        <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row" param="table[
          $columns = table[
            $col1 = table[$text = {77000, 30506}],
            $col2 = table[$type = 'slidercell', $value = global.$GT_MK1_GlobalSettings.$StationTrader.$WaitTimeNoTrades / 1s, $min = 10, $max = 300, $step = 10, $suffix = 's', $echo = 'mk1_waittime', $onChange = MK1_UpdateSliderValue],
            $col3 = table[],
            $col4 = table[],
            $col5 = table[],
            $col6 = table[]
          ]
        ]"/>

        <!-- Section Header: Debug -->
        <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row" param="table[
          $columns = table[
            $col1 = table[$text = 'Debug', $font = 'Zlib_bold', $color = table[$r = 180, $g = 200, $b = 255]],
            $col2 = table[],
            $col3 = table[],
            $col4 = table[],
            $col5 = table[],
            $col6 = table[]
          ]
        ]"/>

        <!-- Debug Logging -->
        <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row" param="table[
          $columns = table[
            $col1 = table[$text = 'Enable MK1 Debug Logging'],
            $col2 = table[$type = 'checkbox', $value = global.$GT_MK1_GlobalSettings.$Debug.$EnableDebugLogging, $echo = 'mk1_debug', $onClick = MK1_ToggleSetting],
            $col3 = table[],
            $col4 = table[],
            $col5 = table[],
            $col6 = table[]
          ]
        ]"/>

      </actions>
    </cue>

    <!-- ================================================================ -->
    <!-- Slider Value Handler                                             -->
    <!-- ================================================================ -->
    <cue name="MK1_UpdateSliderValue" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$data" exact="event.param"/>
        <set_value name="$echo" exact="$data.$echo"/>
        <set_value name="$value" exact="$data.$value"/>

        <do_if value="$echo == 'mk1_maxsell'">
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultMaxSell" exact="$value"/>
        </do_if>
        <do_elseif value="$echo == 'mk1_selltarget'">
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultSellTarget" exact="$value"/>
        </do_elseif>
        <do_elseif value="$echo == 'mk1_buytarget'">
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultBuyTarget" exact="$value"/>
        </do_elseif>
        <do_elseif value="$echo == 'mk1_backtrack'">
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultBacktrackTolerance" exact="$value"/>
        </do_elseif>
        <do_elseif value="$echo == 'mk1_waittime'">
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$WaitTimeNoTrades" exact="$value * 1s"/>
        </do_elseif>

        <debug_text text="'[GalaxyTrader MK1] Setting updated: ' + $echo + ' = ' + $value" chance="if @global.$GT_MK1_GlobalSettings.$Debug.$EnableDebugLogging then 100 else 0"/>
      </actions>
    </cue>

    <!-- ================================================================ -->
    <!-- Checkbox Toggle Handler                                          -->
    <!-- ================================================================ -->
    <cue name="MK1_ToggleSetting" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$data" exact="event.param"/>
        <set_value name="$echo" exact="$data.$echo"/>

        <do_if value="$echo == 'mk1_ignoretraderules'">
          <set_value name="global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultIgnoreTradeRules" exact="not global.$GT_MK1_GlobalSettings.$StationTrader.$DefaultIgnoreTradeRules"/>
        </do_if>
        <do_elseif value="$echo == 'mk1_debug'">
          <set_value name="global.$GT_MK1_GlobalSettings.$Debug.$EnableDebugLogging" exact="not global.$GT_MK1_GlobalSettings.$Debug.$EnableDebugLogging"/>
        </do_elseif>

        <debug_text text="'[GalaxyTrader MK1] Toggle: ' + $echo" chance="if @global.$GT_MK1_GlobalSettings.$Debug.$EnableDebugLogging then 100 else 0"/>
      </actions>
    </cue>

  </cues>
</mdscript>
