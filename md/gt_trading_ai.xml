<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_TradingAI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - CORE COORDINATOR
         Main orchestration and AI request handlers
         
         This module coordinates between:
         - gt_trading_queue.xml (Queue Management)
         - gt_trading_search.xml (Trade Search Engine)
         - gt_trading_execution.xml (Trade Execution)
         - gt_trading_maintenance.xml (Background Tasks)
         ======================================== -->
    
    <!-- Trading AI System Initialization -->
    <cue name="SystemInit">
      <conditions>
        <event_cue_signalled cue="md.Setup.GameStart"/>
      </conditions>
      <actions>
        <debug_text text="'[GalaxyTrader MK3] Trading AI system initializing...'" chance="100"/>
        
        <!-- Initialize trading data structures -->
        <set_value name="global.$GT_TradingData" exact="table[]"/>
        <set_value name="global.$GT_TradingData.$ActiveTrades" exact="table[]"/>
        <set_value name="global.$GT_TradingData.$RouteCache" exact="table[]"/>
        <set_value name="global.$GT_TradingData.$LastUpdate" exact="player.age"/>
        
        <!-- Trade cache is NOT pre-initialized - X4 locks empty table[] -->
        <!-- It will be created WITH data on first cache write in gt_trading_search.xml -->
        
        <!-- Initialize queue system -->
        <set_value name="global.$GT_TradingQueue" exact="table[]"/>
        <set_value name="global.$GT_TradingQueue.$Ships" exact="[]"/>
        <set_value name="global.$GT_TradingQueue.$Processing" exact="false"/>
        
        <!-- Initialize delayed ships table for variable isolation -->
        <set_value name="global.$GT_DelayedShips" exact="table[]"/>
        
        <!-- ✅ PERFORMANCE FIX: Initialize search queue - ONE search at a time to prevent stuttering -->
        <set_value name="global.$GT_SearchQueue" exact="table[]"/>
        <set_value name="global.$GT_SearchQueue.$Ships" exact="[]"/>
        <set_value name="global.$GT_SearchQueue.$ActiveSearches" exact="0"/>
        <set_value name="global.$GT_SearchQueue.$MaxConcurrent" exact="1"/> <!-- ONLY 1 search at a time! -->
        
        <debug_text text="'[GalaxyTrader MK3] Trading AI system initialized (Modular Architecture)'" chance="100"/>
      </actions>
    </cue>
    
    <!-- ========================================
         AI SCRIPT SIGNAL HANDLERS
         These handle requests from aiscripts
         ======================================== -->
    
    <!-- AI Script Trade Request Handler -->
    <cue name="HandleAITradeRequest" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Find_Trade'"/>
      </conditions>
      <actions>
        <set_value name="$requestData" exact="event.param2"/>
        <set_value name="$ship" exact="$requestData.$Ship"/>
        
        <!-- Initialize search locks table if needed -->
        <do_if value="not global.$GT_SearchLocks?">
          <set_value name="global.$GT_SearchLocks" exact="table[]"/>
        </do_if>
        
        <!-- Check if ship already has active search -->
        <do_if value="global.$GT_SearchLocks.{$ship}?">
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Trade search already in progress, ignoring duplicate request'" chance="100"/>
          </do_if>
          <!-- Skip duplicate request -->
        </do_if>
        <do_else>
          <!-- Set search lock for this ship -->
          <set_value name="this.$lockedShip" exact="$ship"/>
          <set_value name="global.$GT_SearchLocks.{$ship}" exact="player.age"/>
          
          <!-- DEBUG: Trade request received -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') AI trade request received for ' + $ship.knownname + ' (MaxBuy: ' + $requestData.$MaxBuy + ', MaxSell: ' + $requestData.$MaxSell + ')'" chance="100"/>
          </do_if>
          
          <!-- CRITICAL FIX: Store AI script parameters for this ship -->
          <do_if value="not global.$GT_AIParameters?">
            <set_value name="global.$GT_AIParameters" exact="table[]"/>
          </do_if>
          
          <!-- Store the AI script parameters for use in trade search -->
          <set_value name="global.$GT_AIParameters.{$ship}" exact="table[
            $HomeBase = $requestData.$HomeBase,
            $MaxBuy = $requestData.$MaxBuy,
            $MaxSell = $requestData.$MaxSell,
            $CargoTarget = $requestData.$CargoTarget,
            $WareBasket = $requestData.$WareBasket,
            $AllowIllegal = $requestData.$AllowIllegal,
            $RiskTolerance = $requestData.$RiskTolerance,
            $DistancePenalty = $requestData.$DistancePenalty,
            $FleetCoordination = $requestData.$FleetCoordination,
            $RequestTime = player.age
          ]"/>
          
          <!-- Add ship to trading queue -->
          <do_if value="not global.$GT_TradingQueue?">
            <set_value name="global.$GT_TradingQueue" exact="table[]"/>
            <set_value name="global.$GT_TradingQueue.$Ships" exact="[]"/>
            <set_value name="global.$GT_TradingQueue.$Processing" exact="false"/>
          </do_if>
          
          <!-- ✅ DEDUPLICATION FIX: Only add ship if not already in queue -->
          <do_if value="not global.$GT_TradingQueue.$Ships.indexof.{$ship}">
            <append_to_list name="global.$GT_TradingQueue.$Ships" exact="$ship"/>
            
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') ✅ QUEUED: Added ship to trading queue (queue size now: ' + global.$GT_TradingQueue.$Ships.count + ')'" chance="100"/>
            </do_if>
            
            <!-- Start processing queue (delegate to queue module) -->
            <signal_cue_instantly cue="md.GT_Trading_Queue.ProcessTradingQueue"/>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') ⚠️ DUPLICATE PREVENTED: Ship already in queue'" chance="100"/>
            </do_if>
          </do_else>
        </do_else>
      </actions>
      
      <cues>
        <!-- CRITICAL FIX: Cleanup search lock on cue completion -->
        <cue name="CleanupLock" instantiate="true">
          <conditions>
            <event_cue_completed cue="parent"/>
          </conditions>
          <actions>
            <do_if value="parent.$lockedShip? and global.$GT_SearchLocks.{parent.$lockedShip}?">
              <remove_value name="global.$GT_SearchLocks.{parent.$lockedShip}"/>
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                <debug_text text="'[GT-AI] Search lock auto-cleaned for ' + parent.$lockedShip.idcode" chance="100"/>
              </do_if>
            </do_if>
          </actions>
        </cue>
      </cues>
    </cue>

    <!-- AI Script Sell Request Handler -->
    <cue name="HandleAISellRequest" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Find_Sell'" comment="Handle sell request from AI script"/>
      </conditions>
      <actions>
        <set_value name="$requestData" exact="event.param2"/>
        <set_value name="$ship" exact="$requestData.$Ship"/>
        
        <!-- DEBUG: AI sell request received -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
          <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') AI sell request received for ' + $ship.knownname + ' (cargo full)'" chance="100"/>
        </do_if>
        
        <!-- Store AI parameters for sell request -->
        <do_if value="not global.$GT_AIParameters?">
          <set_value name="global.$GT_AIParameters" exact="table[]"/>
        </do_if>
        
        <set_value name="global.$GT_AIParameters.{$ship}" exact="table[
          $HomeBase = $requestData.$HomeBase,
          $MaxSell = $requestData.$MaxSell,
          $RiskTolerance = $requestData.$RiskTolerance,
          $DistancePenalty = $requestData.$DistancePenalty,
          $RequestTime = player.age
        ]"/>
        
        <!-- Find best sell opportunities (delegate to search module) -->
        <signal_cue_instantly cue="md.GT_Trading_Search.SearchSellOpportunities" param="table[
          $Ship = $ship,
          $MaxDistance = $requestData.$MaxSell,
          $MinProfit = 500Cr
        ]"/>
      </actions>
    </cue>

    <!-- AI Script Initialization Handler -->
    <cue name="HandleAIStarted" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_AI_Started'" comment="Handle AI script startup"/>
      </conditions>
      <actions>
        <set_value name="$initData" exact="event.param2"/>
        <set_value name="$ship" exact="$initData.$Ship"/>
        
        <debug_text text="'[GalaxyTrader MK3] AI script started for ship ' + $ship.knownname + ' - registering with MD system'" chance="100"/>
        
        <!-- Register ship with GT system if not already registered -->
        <do_if value="not global.$GT_Ships.{$ship}?">
          <signal_objects object="player.galaxy" param="'GT_Register_Ship'" param2="table[
            $Ship = $ship,
            $Config = $initData.$Config
          ]"/>
        </do_if>
      </actions>
    </cue>

    <!-- Configuration Change Handler -->
    <cue name="OnConfigurationChanged" instantiate="true">
      <conditions>
        <event_cue_signalled comment="Handle configuration changes from GT_Configuration"/>
      </conditions>
      <actions>
        <set_value name="$changeData" exact="event.param"/>
        
        <!-- DEBUG: Configuration change received -->
        <do_if value="@global.$GT_Config.$Debug.$Enabled">
          <debug_text text="'[GalaxyTrader MK3] Configuration changed: ' + $changeData.$section + '.' + $changeData.$key + ' = ' + $changeData.$value" chance="100"/>
        </do_if>
        
        <!-- Configuration changes are automatically picked up from global.$GT_Config -->
        <!-- No action needed - modules read from global state -->
      </actions>
    </cue>

    <!-- Ship Trading Order Handler (Legacy - for internal order processing) -->
    <cue name="ShipTradingOrder" instantiate="true">
      <conditions>
        <event_object_order_ready object="player.entity" comment="Detect when ship is ready for new order"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        
        <!-- DEBUG: Ship order ready -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
          <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Ship order ready: ' + $ship.knownname" chance="100"/>
        </do_if>
        
        <!-- Validate ship is registered and ready for trading -->
        <do_if value="global.$GT_Ships.{$ship}? and $ship.isplayerowned and $ship.primarypurpose == purpose.trade">
          <!-- Check if PILOT XP is blocked -->
          <set_value name="$isBlocked" exact="false"/>
          <do_if value="$ship.pilot and global.$GT_Pilots.{$ship.pilot}? and global.$GT_Pilots.{$ship.pilot}.$XPBlocked?">
            <set_value name="$isBlocked" exact="true"/>
            <debug_text text="'[GalaxyTrader MK3] ' + $ship.knownname + ' pilot ' + $ship.pilot.name + ' is blocked for training'" chance="100"/>
          </do_if>
          
          <!-- Add to trading queue if not blocked -->
          <do_if value="not $isBlocked">
            <!-- ✅ DEDUPLICATION FIX: Only add ship if not already in queue -->
            <do_if value="not global.$GT_TradingQueue.$Ships.indexof.{$ship}">
              <append_to_list name="global.$GT_TradingQueue.$Ships" exact="$ship"/>
              
              <!-- DEBUG: Adding to queue -->
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch">
                <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') ✅ QUEUED (InternalQueueShip): Added ' + $ship.knownname + ' to trading queue'" chance="100"/>
              </do_if>
              
              <!-- Delegate to queue module -->
              <signal_cue_instantly cue="md.GT_Trading_Queue.ProcessTradingQueue"/>
            </do_if>
            <do_else>
              <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch">
                <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') ⚠️ DUPLICATE PREVENTED (InternalQueueShip): Ship already in queue'" chance="100"/>
              </do_if>
            </do_else>
          </do_if>
        </do_if>
      </actions>
    </cue>
  </cues>
</mdscript>
