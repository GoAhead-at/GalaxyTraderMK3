<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_TradingAI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- ========================================
         GALAXY TRADER MK3 - CORE COORDINATOR
         Main orchestration and AI request handlers
         
         This module coordinates between:
         - gt_trading_queue.xml (Queue Management)
         - gt_trading_search.xml (Trade Search Engine)
         - gt_trading_execution.xml (Trade Execution)
         - gt_trading_maintenance.xml (Background Tasks)
         ======================================== -->
    
    <!-- Trading AI System Initialization -->
    <cue name="SystemInit">
      <conditions>
        <check_any>
          <event_cue_signalled cue="md.Setup.GameStart"/>
          <event_game_loaded/>
        </check_any>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Trading AI system initializing...'" chance="100"/>
        </do_if>
        
        <!-- Initialize trading data structures -->
        <set_value name="global.$GT_TradingData" exact="table[]"/>
        <set_value name="global.$GT_TradingData.$ActiveTrades" exact="table[]"/>
        <set_value name="global.$GT_TradingData.$RouteCache" exact="table[]"/>
        <set_value name="global.$GT_TradingData.$LastUpdate" exact="player.age"/>
        
        <!-- Trade cache is NOT pre-initialized - X4 locks empty table[] -->
        <!-- It will be created WITH data on first cache write in gt_trading_search.xml -->
        
        <!-- Initialize queue system -->
        <set_value name="global.$GT_TradingQueue" exact="table[]"/>
        <set_value name="global.$GT_TradingQueue.$Ships" exact="[]"/>
        <set_value name="global.$GT_TradingQueue.$Processing" exact="false"/>
        
        <!-- Initialize delayed ships table for variable isolation -->
        <set_value name="global.$GT_DelayedShips" exact="table[]"/>
        
        <!-- Initialize search queue - ONE search at a time to prevent stuttering -->
        <set_value name="global.$GT_SearchQueue" exact="table[]"/>
        <set_value name="global.$GT_SearchQueue.$Ships" exact="[]"/>
        <set_value name="global.$GT_SearchQueue.$ActiveSearches" exact="0"/>
        <!-- REMOVED: Configurable MaxConcurrentSearches - now hardcoded to 1 -->
        <set_value name="global.$GT_SearchQueue.$MaxConcurrent" exact="1"/>
        
        <!-- Initialize batch processor queue - ONE batch processor at a time to prevent stuttering -->
        <set_value name="global.$GT_BatchProcessorQueue" exact="table[]"/>
        
        <!-- CRITICAL FIX: Clean up stale queue entries from save game BEFORE initializing -->
        <!-- Old save games may have ships in queue that no longer have GT orders -->
        <set_value name="$staleEntriesRemoved" exact="0"/>
        <set_value name="$existingQueue" exact="[]"/>
        <do_if value="global.$GT_BatchProcessorQueue.$Ships? and global.$GT_BatchProcessorQueue.$Ships.count gt 0">
          <set_value name="$existingQueue" exact="global.$GT_BatchProcessorQueue.$Ships"/>
        </do_if>
        
        <!-- Clean up stale entries from existing queue -->
        <set_value name="$cleanedQueue" exact="[]"/>
        <do_all exact="$existingQueue.count" counter="$i">
          <set_value name="$queuedShip" exact="$existingQueue.{$i}"/>
          <set_value name="$hasGTOrder" exact="false"/>
          
          <!-- Check if ship has GT order (direct or via commander) -->
          <do_if value="$queuedShip.defaultorder? and @$queuedShip.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$hasGTOrder" exact="true"/>
          </do_if>
          <do_if value="not $hasGTOrder and $queuedShip.commander? and $queuedShip.commander.exists and $queuedShip.commander != $queuedShip">
            <do_if value="$queuedShip.commander.defaultorder? and @$queuedShip.commander.defaultorder.id == 'GalaxyTraderMK3'">
              <set_value name="$hasGTOrder" exact="true"/>
            </do_if>
          </do_if>
          
          <!-- Keep only ships with GT orders -->
          <do_if value="$hasGTOrder">
            <append_to_list name="$cleanedQueue" exact="$queuedShip"/>
          </do_if>
          <do_else>
            <set_value name="$staleEntriesRemoved" operation="add"/>
          </do_else>
        </do_all>
        
        <!-- Initialize queue with cleaned entries -->
        <set_value name="global.$GT_BatchProcessorQueue.$Ships" exact="$cleanedQueue"/>
        <set_value name="global.$GT_BatchProcessorQueue.$ActiveProcessors" exact="0"/>
        <set_value name="global.$GT_BatchProcessorQueue.$MaxConcurrent" exact="1"/>
        <set_value name="global.$GT_BatchProcessorQueue.$ActiveShips" exact="[]"/>
        
        <!-- Log cleanup if any stale entries were removed -->
        <do_if value="$staleEntriesRemoved gt 0">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3] Cleaned up ' + $staleEntriesRemoved + ' stale batch processor queue entries on game load (kept ' + $cleanedQueue.count + ' valid entries)'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Initialize pathfinding queue - Limit concurrent pathfinding instances to prevent CPU spikes -->
        <set_value name="global.$GT_PathfindingQueue" exact="table[]"/>
        <set_value name="global.$GT_PathfindingQueue.$Requests" exact="[]"/>
        <set_value name="global.$GT_PathfindingQueue.$ActiveInstances" exact="0"/>
        <set_value name="global.$GT_PathfindingQueue.$MaxConcurrent" exact="2"/>
        <set_value name="global.$GT_PathfindingQueue.$ActiveShips" exact="[]"/>
        
        <!-- Initialize batch processing globals as TABLES (not lists) -->
        <!-- Previous versions may have initialized these as lists - force reset to table at game start -->
        <!-- Clear any existing (might be list from old save) -->
        <do_if value="global.$GT_BatchDataList?">
          <remove_value name="global.$GT_BatchDataList"/>
        </do_if>
        <do_if value="global.$GT_BatchResultsList?">
          <remove_value name="global.$GT_BatchResultsList"/>
        </do_if>
        <!-- Initialize as tables -->
        <set_value name="global.$GT_BatchDataList" exact="table[]"/> <!-- Batch processor input data (string keys) -->
        <set_value name="global.$GT_BatchResultsList" exact="table[]"/> <!-- Batch processor output data (string keys) -->
        <!-- Mark as migrated for this session -->
        <set_value name="global.$GT_BatchDataListMigrated" exact="true"/>
        
        <!-- Initialize cached active trader count (performance optimization) -->
        <!-- Prevents O(n) loops when assigning orders to many ships -->
        <do_if value="not global.$GT_ActiveTraderCount?">
          <set_value name="global.$GT_ActiveTraderCount" exact="0"/>
        </do_if>
        
        <!-- Initialize failed trades cleanup tracking (performance optimization) -->
        <!-- Tracks last cleanup time per ship to avoid cleaning on every search -->
        <do_if value="not global.$GT_FailedTradesLastCleanup?">
          <set_value name="global.$GT_FailedTradesLastCleanup" exact="table[]"/>
        </do_if>
        
        <!-- Initialize registration queue - ONE registration at a time to prevent stuttering -->
        <set_value name="global.$GT_RegistrationQueue" exact="table[]"/>
        <set_value name="global.$GT_RegistrationQueue.$Ships" exact="[]"/>
        <set_value name="global.$GT_RegistrationQueue.$Processing" exact="false"/>
        
        <!-- Initialize trade request processing queue - Limit concurrent processing to prevent CPU spikes -->
        <set_value name="global.$GT_TradeRequestQueue" exact="table[]"/>
        <set_value name="global.$GT_TradeRequestQueue.$Requests" exact="[]"/>
        <set_value name="global.$GT_TradeRequestQueue.$ActiveInstances" exact="0"/>
        <!-- Trade request processing concurrency:
             - Too low → huge backlog → AI timeouts / duplicate requests
             - Too high → CPU spikes
           Tie to cache concurrency (cheap) but clamp to safe range (1-10). -->
        <set_value name="$maxTradeRequests" exact="2"/>
        <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$MaxConcurrentCacheSearches?">
          <set_value name="$maxTradeRequests" exact="@global.$GT_GlobalSettings.$Performance.$MaxConcurrentCacheSearches"/>
        </do_if>
        <do_elseif value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$MaxConcurrentSearches?">
          <set_value name="$maxTradeRequests" exact="@global.$GT_GlobalSettings.$Performance.$MaxConcurrentSearches"/>
        </do_elseif>
        <do_if value="$maxTradeRequests lt 1">
          <set_value name="$maxTradeRequests" exact="1"/>
        </do_if>
        <do_if value="$maxTradeRequests gt 10">
          <set_value name="$maxTradeRequests" exact="10"/>
        </do_if>
        <set_value name="global.$GT_TradeRequestQueue.$MaxConcurrent" exact="$maxTradeRequests"/>
        
        <!-- Initialize maintenance queue - Limit concurrent maintenance operations to prevent CPU spikes -->
        <set_value name="global.$GT_MaintenanceQueue" exact="table[]"/>
        <set_value name="global.$GT_MaintenanceQueue.$Requests" exact="[]"/>
        <set_value name="global.$GT_MaintenanceQueue.$ActiveInstances" exact="0"/>
        <set_value name="global.$GT_MaintenanceQueue.$MaxConcurrent" exact="2"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Trading AI system initialized (Modular Architecture)'" chance="100"/>
        </do_if>
      </actions>
    </cue>
    
    <!-- One-Time Wake-Up for Ships Stuck in Old Wait States -->
    <cue name="WakeUpShipsStuckInOldCode" instantiate="true">
      <conditions>
        <event_game_loaded/>
      </conditions>
      <delay exact="5s" comment="Wait for ships to register"/>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-WakeUp] ONE-TIME: Waking ships stuck in old wait states from previous save'" chance="100"/>
        </do_if>
        
        <do_if value="global.$GT_Ships?">
          <do_all exact="global.$GT_Ships.keys.count" counter="$idx">
            <set_value name="$ship" exact="global.$GT_Ships.keys.{$idx}"/>
            <do_if value="$ship.exists">
              <!-- <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-WakeUp] Sending GT_No_Trade_Found signal to ' + $ship.idcode + ' to wake from old wait state'" chance="100"/>
              </do_if> -->
              <!-- Signal the ship directly - it will trigger interrupt handlers in new wait states -->
              <signal_objects object="$ship" param="'GT_No_Trade_Found'" comment="Wake up ships stuck in old code"/>
            </do_if>
          </do_all>
        </do_if>
      </actions>
    </cue>
    
    <!-- ========================================
         AI SCRIPT SIGNAL HANDLERS
         These handle requests from aiscripts
         ======================================== -->
    
    <!-- AI Script Trade Request Handler -->
    <cue name="HandleAITradeRequest" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Find_Trade'"/>
      </conditions>
      <actions>
        <!-- Keep the proven normalization path:
             - validates required order params (MaxBuy/MaxSell)
             - stores AI parameters + acquires search lock
             - then FindBestTrade computes MinROI/MinAbsoluteProfit/MaxDistance and routes into scheduler -->
        <set_value name="$requestData" exact="event.param2"/>
        <signal_cue_instantly cue="ProcessDelayedTradeRequest" param="$requestData"/>
      </actions>
    </cue>

    <!-- Legacy ProcessTradeRequestQueue/ProcessDelayedTradeRequest remain for reference, but are not used by the active pipeline. -->
    
    <!-- AI Blacklist Validation Failure Handler -->
    <cue name="HandleAITradeFailure" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Trade_Failed'"/>
      </conditions>
      <actions>
        <set_value name="$failureData" exact="event.param2"/>
        <set_value name="$ship" exact="$failureData.$Ship"/>
        
        <!-- Read structured metadata (with legacy guard for backward compatibility) -->
        <!-- Extract properties with safe access, then check if they exist -->
        <set_value name="$reasonTypeValue" exact="@$failureData.$ReasonType"/>
        <set_value name="$pathBlockedValue" exact="@$failureData.$PathBlocked"/>
        <set_value name="$shouldTryNextValue" exact="@$failureData.$ShouldTryNext"/>
        <set_value name="$reasonType" exact="if $reasonTypeValue? then $reasonTypeValue else 'MARKET'"/>
        <set_value name="$pathBlocked" exact="if $pathBlockedValue? then $pathBlockedValue else false"/>
        <set_value name="$shouldTryNext" exact="if $shouldTryNextValue? then $shouldTryNextValue else false"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-MD]   RECEIVED GT_Trade_Failed from AI: ' + $ship.idcode + ' (Reason: ' + $failureData.$Reason + ', ReasonType: ' + $reasonType + ', PathBlocked: ' + $pathBlocked + ')'" chance="100"/>
        </do_if>
        
        <!-- Store failed trade to prevent re-selection (per-sector, not per-ship) -->
        <!-- Ensure table exists before accessing (handles race condition) -->
        <!-- Note: Actual storage happens later in the code where sector pair is extracted -->
        <do_if value="not global.$GT_FailedSectorPairs?">
          <set_value name="global.$GT_FailedSectorPairs" exact="table[]"/>
        </do_if>
        
        <!-- NEW: Record failed sector for future filtering -->
        <!-- AI now handles iteration through trade list internally, so no need to signal back -->
        <do_if value="$failureData.$Partner?">
          <!-- Extract sectors from failed partner -->
          <set_value name="$buySector" exact="null"/>
          <set_value name="$sellSector" exact="null"/>
          
          <!-- Determine which sector is the buy and which is sell based on IsBuying flag -->
          <do_if value="$failureData.$IsBuying">
            <set_value name="$buySector" exact="$failureData.$Partner.sector"/>
            <!-- Try to get sell sector from pending trade list (get first trade as reference) -->
            <do_if value="global.$GT_PendingTrades? and global.$GT_PendingTrades.{$ship}?">
              <set_value name="$tradeList" exact="global.$GT_PendingTrades.{$ship}"/>
              <do_if value="typeof $tradeList == datatype.list and $tradeList.count gt 0">
                <set_value name="$firstTrade" exact="$tradeList.{1}"/>
                <do_if value="$firstTrade.$SellStation?">
                  <set_value name="$sellSector" exact="@$firstTrade.$SellStation.sector"/>
                </do_if>
                <do_else>
                  <set_value name="$sellSector" exact="@$firstTrade.$SellOffer.owner.sector"/>
                </do_else>
              </do_if>
            </do_if>
          </do_if>
          <do_else>
            <set_value name="$sellSector" exact="$failureData.$Partner.sector"/>
            <!-- Try to get buy sector from pending trade list -->
            <do_if value="global.$GT_PendingTrades? and global.$GT_PendingTrades.{$ship}?">
              <set_value name="$tradeList" exact="global.$GT_PendingTrades.{$ship}"/>
              <do_if value="typeof $tradeList == datatype.list and $tradeList.count gt 0">
                <set_value name="$firstTrade" exact="$tradeList.{1}"/>
                <do_if value="$firstTrade.$BuyStation?">
                  <set_value name="$buySector" exact="@$firstTrade.$BuyStation.sector"/>
                </do_if>
                <do_else>
                  <set_value name="$buySector" exact="@$firstTrade.$BuyOffer.owner.sector"/>
                </do_else>
              </do_if>
            </do_if>
          </do_else>
          
          <!-- Store SECTOR PAIR for future filtering (per-sector, not per-ship) -->
          <!-- Ships in the same sector share failed sector pairs (same connectivity/blacklist context) -->
          <set_value name="$currentSector" exact="$ship.sector"/>
          <do_if value="$buySector? and $sellSector? and $currentSector? and $currentSector.exists">
            <do_if value="not global.$GT_FailedSectorPairs?">
              <set_value name="global.$GT_FailedSectorPairs" exact="table[]"/>
            </do_if>
            <do_if value="not global.$GT_FailedSectorPairs.{$currentSector}?">
              <set_value name="global.$GT_FailedSectorPairs.{$currentSector}" exact="[]"/>
            </do_if>
            <append_to_list name="global.$GT_FailedSectorPairs.{$currentSector}" exact="table[
              $BuySector = $buySector,
              $SellSector = $sellSector,
              $Reason = $failureData.$Reason,
              $Timestamp = player.age
            ]"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <set_value name="$currentSectorName" exact="@$currentSector.knownname"/>
              <set_value name="$buySectorName" exact="@$buySector.knownname"/>
              <set_value name="$sellSectorName" exact="@$sellSector.knownname"/>
              <debug_text text="'[GT-MD] Added failed sector pair to blacklist for sector ' + (if $currentSectorName? then $currentSectorName else 'Unknown') + ': ' + 
                (if $buySectorName? then $buySectorName else 'Unknown') + ' → ' + (if $sellSectorName? then $sellSectorName else 'Unknown') +
                ' (Ship: ' + $ship.idcode + ', will be filtered for all ships in this sector)'" 
                chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-MD] WARNING: Could not store failed trade for ' + $ship.idcode + ' - sector data incomplete'" chance="100"/>
            </do_if>
          </do_else>
        </do_if>
      </actions>
    </cue>
    
    <!-- SendTryNextTrade cue removed -->
    <!-- No longer needed - AI now iterates through trade list internally -->
    
    
    <!-- Trade Request Queue Processor -->
    <cue name="ProcessTradeRequestQueue" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <!-- CPU YIELDING: Prevent draining many requests in a single frame and creating a burst of delayed request instances -->
      <delay exact="10ms"/>
      <actions>
        <!-- Process next request in queue if below concurrency limit -->
        <do_if value="global.$GT_TradeRequestQueue? and global.$GT_TradeRequestQueue.$Requests? and global.$GT_TradeRequestQueue.$Requests.count gt 0">
          <do_if value="global.$GT_TradeRequestQueue.$ActiveInstances lt global.$GT_TradeRequestQueue.$MaxConcurrent">
            <!-- Below limit - process next request -->
            <!-- CRITICAL FIX: X4 lists are 1-based, not 0-based - use {1} for first element -->
            <set_value name="$nextRequest" exact="global.$GT_TradeRequestQueue.$Requests.{1}"/>
            <do_if value="$nextRequest?">
              <remove_from_list name="global.$GT_TradeRequestQueue.$Requests" exact="$nextRequest"/>
              <set_value name="global.$GT_TradeRequestQueue.$ActiveInstances" operation="add"/>
              
              <!-- Process request -->
              <signal_cue_instantly cue="ProcessDelayedTradeRequest" param="$nextRequest"/>
              
              <!-- Continue processing queue -->
              <signal_cue_instantly cue="md.GT_TradingAI.ProcessTradeRequestQueue"/>
            </do_if>
            <do_else>
              <!-- Invalid request - remove it and continue -->
              <do_if value="global.$GT_TradeRequestQueue.$Requests.count gt 0">
                <remove_from_list name="global.$GT_TradeRequestQueue.$Requests" exact="global.$GT_TradeRequestQueue.$Requests.{1}"/>
              </do_if>
              <!-- Continue processing queue -->
              <signal_cue_instantly cue="md.GT_TradingAI.ProcessTradeRequestQueue"/>
            </do_else>
          </do_if>
        </do_if>
      </actions>
    </cue>
    
    <!-- Delayed Trade Request Processing -->
    <cue name="ProcessDelayedTradeRequest" instantiate="true">
      <conditions>
        <event_cue_signalled/>
        <check_value value="event.param.$Ship.exists"/>
      </conditions>
      <delay exact="50ms" comment="Allow AI to enter wait state before processing"/>
      <actions>
        <set_value name="$requestData" exact="event.param"/>
        <set_value name="$ship" exact="$requestData.$Ship"/>
        <set_value name="$shouldProceed" exact="true"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-MD] Processing trade request for ' + $ship.idcode + ' at game time ' + player.age" chance="100"/>
        </do_if>
        
        <!-- Validate required parameters (MaxBuy/MaxSell) - fail loudly if missing -->
        <!-- These are REQUIRED - signal must always include them (no fallbacks to hide issues) -->
        <set_value name="$forceLiveSearch" exact="@$requestData.$ForceLiveSearch"/>
        <set_value name="$maxBuy" exact="@$requestData.$MaxBuy"/>
        <set_value name="$maxSell" exact="@$requestData.$MaxSell"/>
        <set_value name="$maxBuyValid" exact="false"/>
        <set_value name="$maxSellValid" exact="false"/>
        <do_if value="$maxBuy? and $maxBuy ge 0">
          <set_value name="$maxBuyValid" exact="true"/>
        </do_if>
        <do_if value="$maxSell? and $maxSell ge 0">
          <set_value name="$maxSellValid" exact="true"/>
        </do_if>
        
        <!-- Fail loudly if required parameters are missing (no silent fallbacks) -->
        <do_if value="not $maxBuyValid or not $maxSellValid">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-MD] ERROR: GT_Find_Trade signal missing required MaxBuy/MaxSell parameters for ship ' + $ship.idcode + ' (MaxBuy: ' + $maxBuy + ', MaxSell: ' + $maxSell + ') - signal must include these values!'" chance="100"/>
          </do_if>
          <!-- Cannot proceed without valid distance parameters.
               CRITICAL: decrement TradeRequestQueue ActiveInstances here to avoid stalling at MaxConcurrent. -->
          <set_value name="$shouldProceed" exact="false"/>
          <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
          <do_if value="global.$GT_TradeRequestQueue? and global.$GT_TradeRequestQueue.$ActiveInstances? and global.$GT_TradeRequestQueue.$ActiveInstances gt 0">
            <set_value name="global.$GT_TradeRequestQueue.$ActiveInstances" operation="subtract"/>
          </do_if>
          <signal_cue_instantly cue="md.GT_TradingAI.ProcessTradeRequestQueue"/>
          <!-- cancel_cue does not stop the current actions block immediately; the rest of this cue is gated by $shouldProceed -->
          <cancel_cue cue="this"/>
        </do_if>
        
        <do_if value="$shouldProceed">
          <!-- Build parameters table for Request Registry -->
          <set_value name="$parametersTable" exact="table[
            $HomeBase = @$requestData.$HomeBase,
            $MaxBuy = $maxBuy,
            $MaxSell = $maxSell,
            $CargoTarget = @$requestData.$CargoTarget,
            $WareBasket = @$requestData.$WareBasket,
            $AllowIllegal = @$requestData.$AllowIllegal,
            $IgnoreCarrierAux = @$requestData.$IgnoreCarrierAux,
            $IgnoreBuildStorage = @$requestData.$IgnoreBuildStorage,
            $DistancePenalty = @$requestData.$DistancePenalty,
            $FleetCoordination = @$requestData.$FleetCoordination,
            $RequestTime = player.age,
            $ForceLiveSearch = $forceLiveSearch
          ]"/>
        
        <!-- Acquire lock and store parameters using Request Registry -->
        <!-- Check if ship already has lock BEFORE calling library (to detect duplicates) -->
        <set_value name="$alreadyLocked" exact="false"/>
        <do_if value="global.$GT_SearchLocks? and global.$GT_SearchLocks.{$ship}?">
          <set_value name="$alreadyLocked" exact="true"/>
        </do_if>
        
        <do_if value="not $alreadyLocked">
          <!-- Ship not locked - acquire lock using Request Registry -->
          <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Acquire">
            <param name="ship" value="$ship"/>
            <param name="parameters" value="$parametersTable"/>
          </run_actions>
          
          <!-- Lock acquired successfully -->
          <set_value name="this.$lockedShip" exact="$ship"/>
          
          <!-- DEBUG: Trade request received -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <!-- Use safe access (@) for optional properties in debug text -->
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') AI trade request received for ' + $ship.knownname + ' (MaxBuy: ' + @$requestData.$MaxBuy + ', MaxSell: ' + @$requestData.$MaxSell + ')'" chance="100"/>
          </do_if>
          
          <!-- Add ship to trading queue -->
          <do_if value="not global.$GT_TradingQueue?">
            <set_value name="global.$GT_TradingQueue" exact="table[]"/>
            <set_value name="global.$GT_TradingQueue.$Ships" exact="[]"/>
            <set_value name="global.$GT_TradingQueue.$Processing" exact="false"/>
          </do_if>
          
          <!-- CRITICAL: Check if ship is busy BEFORE queueing -->
          <set_value name="$isBusy" exact="false"/>
          
          <!-- Check 1: Has trade orders in queue -->
          <do_if value="$ship.tradeorders? and $ship.tradeorders.count gt 0">
            <set_value name="$isBusy" exact="true"/>
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Ship busy: has ' + $ship.tradeorders.count + ' trade orders - NOT queueing'" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- Check 2: Has training order -->
          <do_if value="not $isBusy and $ship.order? and $ship.order.id == 'DockAndTrain'">
            <set_value name="$isBusy" exact="true"/>
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Ship busy: in training - NOT queueing'" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- DEDUPLICATION FIX: Only add ship if not busy and not already in queue -->
          <!-- Check if ship already in queue using explicit loop (indexof unreliable for lists) -->
          <set_value name="$alreadyInQueue" exact="false"/>
          <do_if value="global.$GT_TradingQueue.$Ships?">
            <do_all exact="global.$GT_TradingQueue.$Ships.count" counter="$i">
              <do_if value="global.$GT_TradingQueue.$Ships.{$i} == $ship">
                <set_value name="$alreadyInQueue" exact="true"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>
          
          <do_if value="not $isBusy and not $alreadyInQueue">
            <!-- Cargo check moved to AI script - AI sends GT_Find_Sell if cargo present -->
            <append_to_list name="global.$GT_TradingQueue.$Ships" exact="$ship"/>
            
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') QUEUED: Added ship to trading queue (queue size now: ' + global.$GT_TradingQueue.$Ships.count + ')'" chance="100"/>
            </do_if>
            
            <!-- Start processing queue (delegate to queue module) -->
            <signal_cue_instantly cue="md.GT_Trading_Queue.ProcessTradingQueue"/>

            <!-- IMPORTANT: Release TradeRequestQueue concurrency slot immediately after request is accepted and queued.
                 SearchLocks prevent duplicate in-flight searches; holding this slot until full search completion causes early stalls under fleet load. -->
            <do_if value="global.$GT_TradeRequestQueue? and global.$GT_TradeRequestQueue.$ActiveInstances? and global.$GT_TradeRequestQueue.$ActiveInstances gt 0">
              <set_value name="global.$GT_TradeRequestQueue.$ActiveInstances" operation="subtract"/>
            </do_if>
            <signal_cue_instantly cue="md.GT_TradingAI.ProcessTradeRequestQueue"/>
          </do_if>
          <do_elseif value="$isBusy">
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') NOT QUEUED: Ship is busy'" chance="100"/>
            </do_if>
            
            <!-- Release lock and parameters using Request Registry -->
            <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Release">
              <param name="ship" value="$ship"/>
              <param name="reason" value="'ship_busy'"/>
            </run_actions>
            
            <!-- Signal AI that ship is busy -->
            <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
            
            <!-- Decrement active instances counter and process next queue item -->
            <set_value name="global.$GT_TradeRequestQueue.$ActiveInstances" operation="subtract"/>
            <signal_cue_instantly cue="md.GT_TradingAI.ProcessTradeRequestQueue"/>
          </do_elseif>
          <do_else>
            <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') DUPLICATE PREVENTED: Ship already in queue'" chance="100"/>
            </do_if>
            
            <!-- Release lock and parameters using Request Registry -->
            <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Release">
              <param name="ship" value="$ship"/>
              <param name="reason" value="'duplicate_request'"/>
            </run_actions>
            
            <!-- Decrement active instances counter and process next queue item -->
            <set_value name="global.$GT_TradeRequestQueue.$ActiveInstances" operation="subtract"/>
            <signal_cue_instantly cue="md.GT_TradingAI.ProcessTradeRequestQueue"/>
          </do_else>
        </do_if>
        <do_else>
          <!-- Ship already locked - duplicate request -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Trade search already in progress, ignoring duplicate request'" chance="100"/>
          </do_if>

          <!-- IMPORTANT: Under heavy fleet load, the MD search can complete AFTER the AI wait timeout.
               The AI then sends a new request, but if we silently ignore it, the AI will wait another full timeout and still miss results.
               Mitigation:
               - If the in-progress request is OLD (older than the AI timeout), treat it as stale and clear transient state so the ship can recover.
               - Otherwise, immediately wake the AI with GT_No_Trade_Found so it doesn't sit in a 90s wait for a request we're ignoring. -->

          <set_value name="$requestAge" exact="0s"/>
          <set_value name="$hasRequestTime" exact="false"/>
          <do_if value="global.$GT_AIParameters? and global.$GT_AIParameters.{$ship}? and global.$GT_AIParameters.{$ship}.$RequestTime?">
            <set_value name="$requestAge" exact="player.age - global.$GT_AIParameters.{$ship}.$RequestTime"/>
            <set_value name="$hasRequestTime" exact="true"/>
          </do_if>

          <!-- If we have a lock but no RequestTime, the request registry got corrupted (usually by deleting AIParameters under lock).
               Treat as stale and clear the transient state + lock so the ship can recover. -->
          <do_if value="not $hasRequestTime">
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-MD] (' + $ship.idcode + ') STALE lock detected: SearchLock exists but AIParameters.$RequestTime is missing - clearing transient state to recover'" chance="100"/>
            </do_if>

            <!-- Clear transient per-ship search state so new requests can proceed -->
            <do_if value="global.$GT_SearchLiveTrades_State? and global.$GT_SearchLiveTrades_State.{$ship}?">
              <remove_value name="global.$GT_SearchLiveTrades_State.{$ship}"/>
            </do_if>
            <do_if value="global.$GT_SearchResult? and global.$GT_SearchResult.{$ship}?">
              <remove_value name="global.$GT_SearchResult.{$ship}"/>
            </do_if>
            <do_if value="global.$GT_BatchDataList? and global.$GT_BatchDataList.{$ship}?">
              <remove_value name="global.$GT_BatchDataList.{$ship}"/>
            </do_if>
            <do_if value="global.$GT_BatchResultsList? and global.$GT_BatchResultsList.{$ship}?">
              <remove_value name="global.$GT_BatchResultsList.{$ship}"/>
            </do_if>

            <!-- Release request registry lock + AI parameters (if any) -->
            <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Release">
              <param name="ship" value="$ship"/>
              <param name="reason" value="'stale_lock_missing_requesttime'"/>
            </run_actions>
          </do_if>

          <!-- If this search has been in-progress longer than the AI timeout window, clear it as stale. -->
          <!-- Note: Use standalone do_if here (not do_elseif) because the previous branch is an independent check. -->
          <!-- IMPORTANT: Under heavy fleet load, a legitimate in-progress request can exceed the AI timeout because:
               - Live searches are rate-limited
               - Batch matching is serialized (often MaxConcurrent=1)
               Only clear as stale if we see NO evidence of ongoing work for this ship. -->
          <set_value name="$hasOngoingWork" exact="false"/>
          <!-- Live-search state marker -->
          <do_if value="global.$GT_SearchLiveTrades_State? and global.$GT_SearchLiveTrades_State.{$ship}?">
            <set_value name="$hasOngoingWork" exact="true"/>
          </do_if>
          <!-- Waiting-for-batch marker -->
          <do_if value="not $hasOngoingWork and global.$GT_SearchResult? and global.$GT_SearchResult.{$ship}? and global.$GT_SearchResult.{$ship}.$WaitingForBatch? and global.$GT_SearchResult.{$ship}.$WaitingForBatch == true">
            <set_value name="$hasOngoingWork" exact="true"/>
          </do_if>
          <!-- Batch data present -->
          <do_if value="not $hasOngoingWork and global.$GT_BatchDataList? and global.$GT_BatchDataList.{$ship}?">
            <set_value name="$hasOngoingWork" exact="true"/>
          </do_if>
          <!-- Batch processor queue membership (ActiveShips or Ships) -->
          <do_if value="not $hasOngoingWork and global.$GT_BatchProcessorQueue? and global.$GT_BatchProcessorQueue.$ActiveShips? and global.$GT_BatchProcessorQueue.$ActiveShips.count gt 0">
            <do_all exact="global.$GT_BatchProcessorQueue.$ActiveShips.count" counter="$i">
              <do_if value="global.$GT_BatchProcessorQueue.$ActiveShips.{$i} == $ship">
                <set_value name="$hasOngoingWork" exact="true"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>
          <do_if value="not $hasOngoingWork and global.$GT_BatchProcessorQueue? and global.$GT_BatchProcessorQueue.$Ships? and global.$GT_BatchProcessorQueue.$Ships.count gt 0">
            <do_all exact="global.$GT_BatchProcessorQueue.$Ships.count" counter="$i">
              <do_if value="global.$GT_BatchProcessorQueue.$Ships.{$i} == $ship">
                <set_value name="$hasOngoingWork" exact="true"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>
          <!-- Live-search queue membership (per-home-sector fairness queue) -->
          <do_if value="not $hasOngoingWork and global.$GT_LiveSearchQueue? and global.$GT_LiveSearchQueue.$BySector? and global.$GT_LiveSearchQueue.$Sectors? and global.$GT_LiveSearchQueue.$Sectors.count gt 0">
            <do_all exact="global.$GT_LiveSearchQueue.$Sectors.count" counter="$s">
              <set_value name="$sec" exact="global.$GT_LiveSearchQueue.$Sectors.{$s}"/>
              <do_if value="global.$GT_LiveSearchQueue.$BySector.{$sec}? and global.$GT_LiveSearchQueue.$BySector.{$sec}.$Ships.count gt 0">
                <do_all exact="global.$GT_LiveSearchQueue.$BySector.{$sec}.$Ships.count" counter="$i">
                  <do_if value="global.$GT_LiveSearchQueue.$BySector.{$sec}.$Ships.{$i} == $ship">
                    <set_value name="$hasOngoingWork" exact="true"/>
                    <break/>
                  </do_if>
                </do_all>
              </do_if>
              <do_if value="$hasOngoingWork">
                <break/>
              </do_if>
            </do_all>
          </do_if>

          <do_if value="$hasRequestTime and $requestAge gt 95s and not $hasOngoingWork">
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-MD] (' + $ship.idcode + ') STALE in-progress trade search detected on duplicate request (age: ' + $requestAge + ') - clearing transient state to recover'" chance="100"/>
            </do_if>

            <!-- Clear transient per-ship search state so new requests can proceed -->
            <do_if value="global.$GT_SearchLiveTrades_State? and global.$GT_SearchLiveTrades_State.{$ship}?">
              <remove_value name="global.$GT_SearchLiveTrades_State.{$ship}"/>
            </do_if>
            <do_if value="global.$GT_SearchResult? and global.$GT_SearchResult.{$ship}?">
              <remove_value name="global.$GT_SearchResult.{$ship}"/>
            </do_if>
            <do_if value="global.$GT_BatchDataList? and global.$GT_BatchDataList.{$ship}?">
              <remove_value name="global.$GT_BatchDataList.{$ship}"/>
            </do_if>
            <do_if value="global.$GT_BatchResultsList? and global.$GT_BatchResultsList.{$ship}?">
              <remove_value name="global.$GT_BatchResultsList.{$ship}"/>
            </do_if>

            <!-- Release request registry lock + AI parameters -->
            <run_actions ref="md.GT_Libraries_General.GT_RequestRegistry_Release">
              <param name="ship" value="$ship"/>
              <param name="reason" value="'stale_inprogress_timeout'"/>
            </run_actions>
          </do_if>
          <do_elseif value="$hasRequestTime and $requestAge gt 95s and $hasOngoingWork">
            <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-MD] (' + $ship.idcode + ') Duplicate request while search is still in progress (age: ' + $requestAge + ') - NOT clearing state (ongoing work detected)'" chance="100"/>
            </do_if>
          </do_elseif>

          <!-- Always wake AI for ignored duplicate request -->
          <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
          
          <!-- Decrement active instances counter and process next queue item -->
          <!-- Defensive: GT_TradeRequestQueue may not exist in some V2 flows; never crash / never go negative -->
          <do_if value="global.$GT_TradeRequestQueue? and global.$GT_TradeRequestQueue.$ActiveInstances? and global.$GT_TradeRequestQueue.$ActiveInstances gt 0">
            <set_value name="global.$GT_TradeRequestQueue.$ActiveInstances" operation="subtract"/>
          </do_if>
          <do_if value="global.$GT_TradeRequestQueue?">
            <signal_cue_instantly cue="md.GT_TradingAI.ProcessTradeRequestQueue"/>
          </do_if>
        </do_else>

        </do_if>
        
        <!-- FIX: Search lock is now ONLY released when:
             1. Request rejected (busy/duplicate) - released above
             2. Search completes - released by SearchTradeRoutes (gt_trading_search.xml:1584-1590)
             3. Search aborted - released by queue cleanup handlers
            DO NOT release here - lock must persist until search actually runs and completes -->
        <!-- NOTE: ActiveInstances counter is decremented above when request is rejected -->
        <!-- When request succeeds and ship is queued, counter is decremented by SearchTradeRoutes after search completes -->
      </actions>
    </cue>
    
    <!-- Delayed Sell Request Processing -->
    <cue name="ProcessDelayedSellRequest" instantiate="true">
      <conditions>
        <event_cue_signalled/>
        <check_value value="event.param.$Ship.exists"/>
      </conditions>
      <delay exact="50ms" comment="Allow AI to enter wait state before processing"/>
      <actions>
        <set_value name="$requestData" exact="event.param"/>
        <set_value name="$ship" exact="$requestData.$Ship"/>
        
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Disposal] (' + $ship.idcode + ') Processing delayed sell request at game time ' + player.age" chance="100"/>
        </do_if>
        
        <!-- Verify ship still has cargo (may have changed during delay) -->
        <set_value name="$hasCargo" exact="false"/>
        <set_value name="$cargoCount" exact="0"/>
        <do_if value="$ship.cargo.list?">
          <set_value name="$cargoCount" exact="$ship.cargo.list.count"/>
          <do_if value="$cargoCount gt 0">
            <set_value name="$hasCargo" exact="true"/>
          </do_if>
        </do_if>
        
        <do_if value="not $hasCargo">
          <!-- Ship no longer has cargo - signal no trade found -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Disposal] (' + $ship.idcode + ') WARNING: Ship no longer has cargo during delayed processing - signaling GT_No_Trade_Found'" chance="100"/>
          </do_if>
          <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
          <cancel_cue cue="this"/>
        </do_if>
        
        <!-- Store AI parameters for sell request -->
        <set_value name="global.$GT_AIParameters.{$ship}" exact="table[
          $HomeBase = @$requestData.$HomeBase,
          $MaxSell = @$requestData.$MaxSell,
          $DistancePenalty = @$requestData.$DistancePenalty,
          $IgnoreCarrierAux = @$requestData.$IgnoreCarrierAux,
          $IgnoreBuildStorage = @$requestData.$IgnoreBuildStorage,
          $RequestTime = player.age
        ]"/>
        
        <!-- Find best sell opportunities (delegate to search module) -->
        <!-- CARGO SAFETY: Accept ANY offer, even losses - ship MUST clear cargo -->
        <!-- Cargo disposal is mandatory before new trades, profitability doesn't matter -->
        <set_value name="$maxDistance" exact="15"/>
        <do_if value="$requestData.$MaxSell?">
          <set_value name="$maxDistance" exact="$requestData.$MaxSell"/>
        </do_if>
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Disposal] (' + $ship.idcode + ') SIGNALING SearchSellOpportunities: MaxDistance=' + $maxDistance + ', MinProfit=0Cr'" chance="100"/>
        </do_if>
        <signal_cue_instantly cue="md.GT_Trading_Search.SearchSellOpportunities" param="table[
          $Ship = $ship,
          $MaxDistance = $maxDistance,
          $MinProfit = 0Cr
        ]"/>
      </actions>
    </cue>

    <!-- AI Script Sell Request Handler -->
    <cue name="HandleAISellRequest" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Find_Sell'" comment="Handle sell request from AI script"/>
      </conditions>
      <actions>
        <set_value name="$requestData" exact="event.param2"/>
        <set_value name="$ship" exact="$requestData.$Ship"/>
        
        <!-- CRITICAL: Verify ship actually has cargo before searching -->
        <!-- OPTIMIZATION: Compute cargo status once and reuse for debug -->
        <set_value name="$hasCargo" exact="false"/>
        <set_value name="$cargoCount" exact="0"/>
        <do_if value="$ship.cargo.list?">
          <set_value name="$cargoCount" exact="$ship.cargo.list.count"/>
          <do_if value="$cargoCount gt 0">
            <set_value name="$hasCargo" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- DEBUG: AI sell request received -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <set_value name="$maxSell" exact="15"/>
          <do_if value="$requestData.$MaxSell?">
            <set_value name="$maxSell" exact="$requestData.$MaxSell"/>
          </do_if>
          <debug_text text="'[GT-Disposal] (' + $ship.idcode + ') HandleAISellRequest: Ship=' + $ship.knownname + ', HasCargo=' + $hasCargo + ' (' + $cargoCount + ' types), MaxDistance=' + $maxSell + ' jumps'" chance="100"/>
        </do_if>
        
        <do_if value="not $hasCargo">
          <!-- Ship has no cargo - signal no trade found immediately -->
          <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Disposal] (' + $ship.idcode + ') WARNING: GT_Find_Sell received but ship has NO cargo - signaling GT_No_Trade_Found'" chance="100"/>
          </do_if>
          <signal_objects object="$ship" param="'GT_No_Trade_Found'"/>
          <cancel_cue cue="this"/>
        </do_if>
        
        <!-- Continue legacy sell pipeline for now; scheduler is applied later. -->
        <signal_cue_instantly cue="md.GT_TradingAI.ProcessDelayedSellRequest" param="$requestData"/>
      </actions>
    </cue>

    <!-- AI Script Initialization Handler -->
    <cue name="HandleAIStarted" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_AI_Started'" comment="Handle AI script startup"/>
      </conditions>
      <actions>
        <set_value name="$initData" exact="event.param2"/>
        <set_value name="$ship" exact="$initData.$Ship"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] AI script started for ship ' + $ship.knownname + ' - registering with MD system'" chance="100"/>
        </do_if>
        
        <!-- Register ship with GT system if not already registered -->
        <do_if value="not global.$GT_Ships.{$ship}?">
          <signal_objects object="player.galaxy" param="'GT_Register_Ship'" param2="table[
            $Ship = $ship,
            $Config = $initData.$Config
          ]"/>
        </do_if>
        
        <!-- PHASE 1: Initialize ship state in registry (state manager initialization only) -->
        <!-- This tests if state registry initialization interferes with trade order creation -->
        <do_if value="not global.$GT_Ship_State?">
          <set_value name="global.$GT_Ship_State" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_Ship_State.{$ship}?">
          <!-- Check if ship has GT order -->
          <set_value name="$hasGTOrder" exact="false"/>
          <do_if value="$ship.defaultorder? and @$ship.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$hasGTOrder" exact="true"/>
          </do_if>
          
          <set_value name="global.$GT_Ship_State.{$ship}" exact="table[
            $OperationalState = 'idle',
            $SubordinateState = 'independent',
            $Commander = null,
            $CommanderHasGT = false,
            $HasGTOrder = $hasGTOrder,
            $ActiveTradeOrders = 0,
            $LastStateUpdate = player.age,
            $MacroShipName = @$ship.macro.name
          ]"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-State] Phase 1: Initialized state registry for ' + $ship.idcode + ' (macro name: ' + @$ship.macro.name + ', HasGTOrder: ' + $hasGTOrder + ')'" chance="100"/>
          </do_if>
        </do_if>
        <do_else>
          <!-- PHASE 7: Check if GT order was removed when script restarts -->
          <!-- Ship already in state registry - check if GT order was removed -->
          <!-- Note: X4 always assigns a default order - when GT order is removed, it becomes "Hold Position" -->
          <set_value name="$state" exact="global.$GT_Ship_State.{$ship}"/>
          <set_value name="$currentDefaultOrder" exact="@$ship.defaultorder.id"/>
          <set_value name="$hasGTOrder" exact="false"/>
          <do_if value="$currentDefaultOrder == 'GalaxyTraderMK3'">
            <set_value name="$hasGTOrder" exact="true"/>
          </do_if>
          
          <!-- If state says ship has GT order but ship doesn't, GT order was removed -->
          <!-- Ship now has "Hold Position" or another default order -->
          <do_if value="$state.$HasGTOrder and not $hasGTOrder">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-State] Phase 7: ' + $ship.idcode + ' - GT order removed (detected in HandleAIStarted, new default order: ' + (if $currentDefaultOrder then $currentDefaultOrder else 'NONE') + ')'" chance="100"/>
            </do_if>
            
            <!-- Update state to reflect GT order cancellation -->
            <set_value name="$state.$HasGTOrder" exact="false"/>
            <set_value name="$state.$OperationalState" exact="'orphaned'"/>
            <set_value name="$state.$ActiveTradeOrders" exact="0"/>
            
            <!-- Determine subordinate state -->
            <set_value name="$hasCommander" exact="false"/>
            <do_if value="$ship.commander? and $ship.commander.exists and $ship.commander != $ship">
              <set_value name="$hasCommander" exact="true"/>
              <set_value name="$state.$Commander" exact="$ship.commander"/>
              
              <!-- Check if commander has GT order -->
              <set_value name="$commanderHasGT" exact="false"/>
              <do_if value="$ship.commander.defaultorder? and @$ship.commander.defaultorder.id == 'GalaxyTraderMK3'">
                <set_value name="$commanderHasGT" exact="true"/>
              </do_if>
              <set_value name="$state.$CommanderHasGT" exact="$commanderHasGT"/>
              
              <do_if value="$commanderHasGT">
                <set_value name="$state.$SubordinateState" exact="'subordinate'"/>
              </do_if>
              <do_else>
                <set_value name="$state.$SubordinateState" exact="'orphaned'"/>
              </do_else>
            </do_if>
            <do_else>
              <set_value name="$state.$Commander" exact="null"/>
              <set_value name="$state.$CommanderHasGT" exact="false"/>
              <set_value name="$state.$SubordinateState" exact="'orphaned'"/>
            </do_else>
            
            <set_value name="$state.$LastStateUpdate" exact="player.age"/>
            
            <!-- NAME RESTORATION: Restore ship name if not GT-controlled (direct or subordinate) -->
            <run_actions ref="md.GT_Ship_State_Utilities.GT_RestoreShipName" result="$nameRestored">
              <param name="ship" value="$ship"/>
              <param name="reason" value="'GT order removed - restoring original name (HandleAIStarted)'"/>
              <param name="checkSubordinate" value="true"/>
              <param name="state" value="$state"/>
              <param name="checkDirectGTOrder" value="true"/>
            </run_actions>
            <do_if value="$nameRestored">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-State] Phase 7: Name restoration signal sent for ' + $ship.idcode + ' (HandleAIStarted)'" chance="100"/>
              </do_if>
            </do_if>
          </do_if>
          <!-- If ship has GT order but state says it doesn't, update state -->
          <do_elseif value="not $state.$HasGTOrder and $hasGTOrder">
            <set_value name="$state.$HasGTOrder" exact="true"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-State] Phase 7: ' + $ship.idcode + ' - GT order detected (state was false, now true)'" chance="100"/>
            </do_if>
          </do_elseif>
        </do_else>
      </actions>
    </cue>

    <!-- Configuration Change Handler -->
    <cue name="OnConfigurationChanged" instantiate="true">
      <conditions>
        <event_cue_signalled comment="Handle configuration changes from GT_Configuration"/>
      </conditions>
      <actions>
        <set_value name="$changeData" exact="event.param"/>
        
        <!-- DEBUG: Configuration change received -->
        <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3] Configuration changed: ' + $changeData.$section + '.' + $changeData.$key + ' = ' + $changeData.$value" chance="100"/>
        </do_if>
        
        <!-- Configuration changes are automatically picked up from global.$GT_Config -->
        <!-- No action needed - modules read from global state -->
      </actions>
    </cue>

    <!-- Ship Trading Order Handler (Legacy - for internal order processing) -->
    <cue name="ShipTradingOrder" instantiate="true">
      <conditions>
        <event_object_order_ready object="player.entity" comment="Detect when ship is ready for new order"/>
      </conditions>
      <actions>
        <set_value name="$ship" exact="event.object"/>
        
        <!-- DEBUG: Ship order ready -->
        <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') Ship order ready: ' + $ship.knownname" chance="100"/>
        </do_if>
        
        <!-- Validate ship is registered and ready for trading -->
        <do_if value="global.$GT_Ships.{$ship}? and $ship.isplayerowned and $ship.primarypurpose == purpose.trade">
          <!-- Check if PILOT XP is blocked -->
          <set_value name="$isBlocked" exact="false"/>
          <do_if value="$ship.pilot and global.$GT_Pilots.{$ship.pilot}? and global.$GT_Pilots.{$ship.pilot}.$XPBlocked?">
            <set_value name="$isBlocked" exact="true"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GalaxyTrader MK3] ' + $ship.knownname + ' pilot ' + $ship.pilot.name + ' is blocked for training'" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- Add to trading queue if not blocked -->
          <do_if value="not $isBlocked">
            <!-- DEDUPLICATION FIX: Only add ship if not already in queue -->
            <!-- Check if ship already in queue using explicit loop (indexof unreliable for lists) -->
            <set_value name="$alreadyInQueue" exact="false"/>
            <do_if value="global.$GT_TradingQueue.$Ships?">
              <do_all exact="global.$GT_TradingQueue.$Ships.count" counter="$i">
                <do_if value="global.$GT_TradingQueue.$Ships.{$i} == $ship">
                  <set_value name="$alreadyInQueue" exact="true"/>
                  <break/>
                </do_if>
              </do_all>
            </do_if>
            
            <do_if value="not $alreadyInQueue">
              <append_to_list name="global.$GT_TradingQueue.$Ships" exact="$ship"/>
              
              <!-- DEBUG: Adding to queue -->
              <do_if value="global.$GT_Config.$Debug.$Enabled and global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') QUEUED (InternalQueueShip): Added ' + $ship.knownname + ' to trading queue'" chance="100"/>
              </do_if>
              
              <!-- Delegate to queue module -->
              <signal_cue_instantly cue="md.GT_Trading_Queue.ProcessTradingQueue"/>
            </do_if>
            <do_else>
              <do_if value="@global.$GT_Config.$Debug.$Enabled and @global.$GT_Config.$Debug.$TradeSearch and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GalaxyTrader MK3 DEBUG] (' + $ship.idcode + ') DUPLICATE PREVENTED (InternalQueueShip): Ship already in queue'" chance="100"/>
              </do_if>
            </do_else>
          </do_if>
        </do_if>
      </actions>
    </cue>
  </cues>
</mdscript>
