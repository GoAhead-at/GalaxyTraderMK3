<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_TradeSearch_Scheduler" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    <!-- Clean post-migration scheduler:
         GT_Search_Request -> GT_Search_Go -> GT_Search_Done -->

    <cue name="Init" instantiate="true" version="1">
      <conditions>
        <check_any>
          <event_game_loaded/>
          <event_player_created/>
        </check_any>
      </conditions>
      <actions>
        <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.InitSearchSemaphore"/>
      </actions>
    </cue>

    <cue name="InitSearchSemaphore" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <do_if value="not global.$GT_SearchSemaphore?">
          <set_value name="global.$GT_SearchSemaphore" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_SearchSemaphore.$Queue?">
          <set_value name="global.$GT_SearchSemaphore.$Queue" exact="[]"/>
        </do_if>
        <do_if value="not global.$GT_SearchSemaphore.$Queued?">
          <set_value name="global.$GT_SearchSemaphore.$Queued" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_SearchSemaphore.$ActiveShips?">
          <set_value name="global.$GT_SearchSemaphore.$ActiveShips" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_SearchSemaphore.$Active?">
          <set_value name="global.$GT_SearchSemaphore.$Active" exact="0"/>
        </do_if>
        <set_value name="$maxConcurrentLive" exact="1"/>
        <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$MaxConcurrentLiveSearches?">
          <set_value name="$maxConcurrentLive" exact="@global.$GT_GlobalSettings.$Performance.$MaxConcurrentLiveSearches"/>
        </do_if>
        <do_if value="$maxConcurrentLive lt 1">
          <set_value name="$maxConcurrentLive" exact="1"/>
        </do_if>
        <set_value name="global.$GT_SearchSemaphore.$MaxConcurrent" exact="$maxConcurrentLive"/>
        <do_if value="not global.$GT_SearchSemaphore.$DispatchScheduled?">
          <set_value name="global.$GT_SearchSemaphore.$DispatchScheduled" exact="false"/>
        </do_if>
      </actions>
    </cue>

    <!-- Legacy compatibility: older call sites can still enqueue here -->
    <cue name="Enqueue" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$req" exact="event.param"/>
        <do_if value="$req? and $req.$Ship? and $req.$Ship.exists">
          <signal_objects object="player.galaxy" param="'GT_Search_Request'" param2="$req"/>
        </do_if>
      </actions>
    </cue>

    <!-- Legacy compatibility: old delayed entrypoint now forwards to request -->
    <cue name="SearchTradeRoutes_Delayed" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <delay exact="1ms"/>
      <actions>
        <set_value name="$req" exact="event.param"/>
        <do_if value="$req? and $req.$Ship? and $req.$Ship.exists">
          <signal_objects object="player.galaxy" param="'GT_Search_Request'" param2="$req"/>
        </do_if>
      </actions>
    </cue>

    <!-- Compatibility kick points from removed queue/work-item flow -->
    <cue name="Tick" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.DispatchSearchGo"/>
      </actions>
    </cue>

    <cue name="ProcessWorkQueueDelayed" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <delay exact="1ms"/>
      <actions>
        <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.DispatchSearchGo"/>
      </actions>
    </cue>

    <cue name="HandleSearchRequest" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Search_Request'"/>
      </conditions>
      <actions>
        <set_value name="$params" exact="event.param2"/>
        <set_value name="$ship" exact="@$params.$Ship"/>
        <set_value name="$enqueueAllowed" exact="true"/>

        <do_if value="not $ship? or not $ship.exists">
          <set_value name="$enqueueAllowed" exact="false"/>
        </do_if>

        <do_if value="not global.$GT_SearchSemaphore?">
          <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.InitSearchSemaphore"/>
        </do_if>

        <do_if value="$enqueueAllowed and global.$GT_SearchSemaphore.$ActiveShips? and global.$GT_SearchSemaphore.$ActiveShips.{$ship}?">
          <set_value name="$enqueueAllowed" exact="false"/>
        </do_if>
        <do_if value="$enqueueAllowed and global.$GT_SearchSemaphore.$Queued? and global.$GT_SearchSemaphore.$Queued.{$ship}?">
          <set_value name="$enqueueAllowed" exact="false"/>
        </do_if>

        <do_if value="$enqueueAllowed">
          <append_to_list name="global.$GT_SearchSemaphore.$Queue" exact="table[
            $Ship = $ship,
            $Params = $params,
            $EnqueuedAt = player.age
          ]"/>
          <set_value name="global.$GT_SearchSemaphore.$Queued.{$ship}" exact="true"/>
          <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.DispatchSearchGo"/>
        </do_if>
      </actions>
    </cue>

    <cue name="DispatchSearchGoDelayed" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <delay exact="200ms"/>
      <actions>
        <do_if value="global.$GT_SearchSemaphore?">
          <set_value name="global.$GT_SearchSemaphore.$DispatchScheduled" exact="false"/>
        </do_if>
        <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.DispatchSearchGo"/>
      </actions>
    </cue>

    <cue name="DispatchSearchGo" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <do_if value="not global.$GT_SearchSemaphore?">
          <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.InitSearchSemaphore"/>
        </do_if>

        <do_if value="global.$GT_SearchSemaphore.$Queue.count gt 0 and global.$GT_SearchSemaphore.$Active ge global.$GT_SearchSemaphore.$MaxConcurrent">
          <do_if value="not global.$GT_SearchSemaphore.$DispatchScheduled">
            <set_value name="global.$GT_SearchSemaphore.$DispatchScheduled" exact="true"/>
            <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.DispatchSearchGoDelayed"/>
          </do_if>
        </do_if>
        <do_else>
          <do_while value="global.$GT_SearchSemaphore.$Queue.count gt 0 and global.$GT_SearchSemaphore.$Active lt global.$GT_SearchSemaphore.$MaxConcurrent">
            <set_value name="$entry" exact="global.$GT_SearchSemaphore.$Queue.{1}"/>
            <remove_from_list name="global.$GT_SearchSemaphore.$Queue" exact="$entry"/>

            <set_value name="$ship" exact="@$entry.$Ship"/>
            <set_value name="$params" exact="@$entry.$Params"/>

            <do_if value="$ship? and $ship.exists">
              <set_value name="global.$GT_SearchSemaphore.$Active" operation="add"/>
              <set_value name="global.$GT_SearchSemaphore.$ActiveShips.{$ship}" exact="table[
                $StartedAt = player.age,
                $Params = $params
              ]"/>
              <remove_value name="global.$GT_SearchSemaphore.$Queued.{$ship}"/>

              <signal_objects object="$ship" param="'GT_Search_Go'" param2="$params" delay="1ms"/>
            </do_if>
            <do_else>
              <!-- Ship no longer exists: clean up Queued table entry (prevent memory leak) -->
              <do_if value="$ship? and global.$GT_SearchSemaphore.$Queued? and global.$GT_SearchSemaphore.$Queued.{$ship}?">
                <remove_value name="global.$GT_SearchSemaphore.$Queued.{$ship}"/>
              </do_if>
            </do_else>
          </do_while>
        </do_else>
      </actions>
    </cue>

    <cue name="HandleSearchDone" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Search_Done'"/>
      </conditions>
      <actions>
        <set_value name="$data" exact="event.param2"/>
        <set_value name="$ship" exact="@$data.$Ship"/>
        <set_value name="$found" exact="if $data? and $data.$Found? then @$data.$Found else false"/>
        <set_value name="$tradeList" exact="if $data? and $data.$TradeList? then @$data.$TradeList else []"/>
        <set_value name="$searchMethod" exact="if $data? and $data.$SearchMethod? then @$data.$SearchMethod else 'live'"/>
        <set_value name="$activeEntry" exact="if $ship? and global.$GT_SearchSemaphore? and global.$GT_SearchSemaphore.$ActiveShips? and global.$GT_SearchSemaphore.$ActiveShips.{$ship}? then @global.$GT_SearchSemaphore.$ActiveShips.{$ship} else null"/>

        <do_if value="$ship? and global.$GT_SearchSemaphore? and global.$GT_SearchSemaphore.$ActiveShips? and global.$GT_SearchSemaphore.$ActiveShips.{$ship}?">
          <remove_value name="global.$GT_SearchSemaphore.$ActiveShips.{$ship}"/>
          <do_if value="global.$GT_SearchSemaphore.$Active gt 0">
            <set_value name="global.$GT_SearchSemaphore.$Active" operation="subtract"/>
          </do_if>
        </do_if>

        <!-- Cache write is now handled by the AI script (lib.gt.cache.write) BEFORE
             signaling GT_Search_Done. This allows sorted insertion with <wait> yields
             between entries, preventing frame drops on large caches.
             The scheduler only manages the semaphore and forwards trade results. -->

        <do_if value="$ship? and $ship.exists">
          <do_if value="$found and $tradeList.count gt 0">
            <signal_objects object="$ship" param="'GT_Trade_Found'" param2="table[
              $TradeList = $tradeList,
              $SearchMethod = $searchMethod
            ]" delay="1ms"/>
          </do_if>
          <do_else>
            <signal_objects object="$ship" param="'GT_No_Trade_Found'" param2="'no_trade'" delay="1ms"/>
          </do_else>
        </do_if>

        <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.DispatchSearchGo"/>
      </actions>
    </cue>

    <cue name="HandleSearchAbort" instantiate="true">
      <conditions>
        <event_object_signalled object="player.galaxy" param="'GT_Search_Abort'"/>
      </conditions>
      <actions>
        <set_value name="$data" exact="event.param2"/>
        <set_value name="$ship" exact="@$data.$Ship"/>

        <do_if value="global.$GT_SearchSemaphore? and $ship?">
          <!-- Remove from Queued lookup table -->
          <do_if value="global.$GT_SearchSemaphore.$Queued? and global.$GT_SearchSemaphore.$Queued.{$ship}?">
            <remove_value name="global.$GT_SearchSemaphore.$Queued.{$ship}"/>
          </do_if>
          <!-- Remove from Queue list (iterate reverse to safely remove by index) -->
          <do_if value="global.$GT_SearchSemaphore.$Queue? and global.$GT_SearchSemaphore.$Queue.count gt 0">
            <do_all exact="global.$GT_SearchSemaphore.$Queue.count" counter="$qi" reverse="true">
              <do_if value="@global.$GT_SearchSemaphore.$Queue.{$qi}.$Ship == $ship">
                <remove_value name="global.$GT_SearchSemaphore.$Queue.{$qi}"/>
              </do_if>
            </do_all>
          </do_if>
          <!-- Remove from ActiveShips and release semaphore slot -->
          <do_if value="global.$GT_SearchSemaphore.$ActiveShips? and global.$GT_SearchSemaphore.$ActiveShips.{$ship}?">
            <remove_value name="global.$GT_SearchSemaphore.$ActiveShips.{$ship}"/>
            <do_if value="global.$GT_SearchSemaphore.$Active gt 0">
              <set_value name="global.$GT_SearchSemaphore.$Active" operation="subtract"/>
            </do_if>
          </do_if>
        </do_if>

        <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.DispatchSearchGo"/>
      </actions>
    </cue>

    <!-- Periodic stale-check: kick-start on game load, then self-cycles via SemaphoreStaleCheckLoop -->
    <cue name="SemaphoreStaleCheckInit" instantiate="true" version="1">
      <conditions>
        <check_any>
          <event_game_loaded/>
          <event_player_created/>
        </check_any>
      </conditions>
      <actions>
        <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.SemaphoreStaleCheckLoop"/>
      </actions>
    </cue>

    <cue name="SemaphoreStaleCheckLoop" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <delay exact="30s"/>
      <actions>
        <!-- Cleanup expired fleet reservations (restored from pre-migration scheduler).
             Original release called GT_CleanupExpiredReservations every 10s;
             piggybacking on the 30s stale check is sufficient since TTL is 10s. -->
        <run_actions ref="md.GT_Libraries_General.GT_CleanupExpiredReservations" result="$cleanupResult">
          <param name="traceId" value="0"/>
        </run_actions>
        
        <!-- Safely get ActiveShips into a local; deep global.$X.$Y.keys chains can fail in MD -->
        <set_value name="$activeShipsTable" exact="@global.$GT_SearchSemaphore.$ActiveShips"/>
        <do_if value="$activeShipsTable? and typeof $activeShipsTable == datatype.table and $activeShipsTable.keys.count gt 0">
          <!-- Snapshot keys list so mutations during iteration are safe -->
          <set_value name="$activeKeys" exact="$activeShipsTable.keys.list"/>
          <set_value name="$purged" exact="0"/>
          <do_all exact="$activeKeys.count" counter="$ki">
            <set_value name="$activeShip" exact="$activeKeys.{$ki}"/>
            <set_value name="$shouldPurge" exact="false"/>
            <!-- Ship destroyed -->
            <do_if value="not $activeShip.exists">
              <set_value name="$shouldPurge" exact="true"/>
            </do_if>
            <!-- Ship no longer has GT order and not subordinate to GT commander -->
            <do_if value="not $shouldPurge and $activeShip.exists">
              <set_value name="$hasGT" exact="false"/>
              <do_if value="$activeShip.defaultorder? and @$activeShip.defaultorder.id == 'GalaxyTraderMK3'">
                <set_value name="$hasGT" exact="true"/>
              </do_if>
              <do_if value="not $hasGT and $activeShip.commander? and $activeShip.commander.exists and $activeShip.commander.defaultorder? and @$activeShip.commander.defaultorder.id == 'GalaxyTraderMK3'">
                <set_value name="$hasGT" exact="true"/>
              </do_if>
              <!-- Only purge non-GT ships that have been active longer than StaleThresholdSeconds -->
              <do_if value="not $hasGT">
                <set_value name="$staleAge" exact="120"/>
                <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$StaleThresholdSeconds?">
                  <set_value name="$staleAge" exact="@global.$GT_GlobalSettings.$Performance.$StaleThresholdSeconds"/>
                </do_if>
                <set_value name="$entryAge" exact="player.age - @global.$GT_SearchSemaphore.$ActiveShips.{$activeShip}.$StartedAt"/>
                <do_if value="$entryAge gt ($staleAge * 1s)">
                  <set_value name="$shouldPurge" exact="true"/>
                </do_if>
              </do_if>
            </do_if>
            <do_if value="$shouldPurge">
              <remove_value name="global.$GT_SearchSemaphore.$ActiveShips.{$activeShip}"/>
              <do_if value="global.$GT_SearchSemaphore.$Active gt 0">
                <set_value name="global.$GT_SearchSemaphore.$Active" operation="subtract"/>
              </do_if>
              <set_value name="$purged" operation="add"/>
            </do_if>
          </do_all>
          <do_if value="$purged gt 0">
            <debug_text text="'[GT-Scheduler] StaleCheck: purged ' + $purged + ' stale semaphore entries'" chance="100"/>
            <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.DispatchSearchGo"/>
          </do_if>
        </do_if>
        <!-- Re-schedule next check -->
        <signal_cue_instantly cue="md.GT_TradeSearch_Scheduler.SemaphoreStaleCheckLoop"/>
      </actions>
    </cue>
  </cues>
</mdscript>
