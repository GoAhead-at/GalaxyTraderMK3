<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GT_Ship_Management" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/md.xsd">
  <cues>
    
    <!-- ========================================================================= -->
    <!-- SHIP MANAGEMENT LIBRARIES -->
    <!-- ========================================================================= -->
    
    <!-- Ship Registration and Initialization -->
    <library name="Register_Ship" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to register"/>
        <param name="pilot" comment="Ship's pilot"/>
        <param name="config" comment="Ship configuration"/>
      </params>
      <actions>
        <!-- Ensure global data structures exist -->
        <do_if value="not global.$GT_Ships?">
          <set_value name="global.$GT_Ships" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_Pilots?">
          <set_value name="global.$GT_Pilots" exact="table[]"/>
        </do_if>
        
        <!-- Register ship if not already registered -->
        <do_if value="not global.$GT_Ships.{$ship}?">
          <set_value name="global.$GT_Ships.{$ship}" exact="table[]"/>
          <set_value name="global.$GT_Ships.{$ship}.$RegisterTime" exact="player.age"/>
          <set_value name="global.$GT_Ships.{$ship}.$Config" exact="$config"/>
          <set_value name="global.$GT_Ships.{$ship}.$LastUpdate" exact="player.age"/>
          <set_value name="global.$GT_Ships.{$ship}.$Status" exact="'active'"/>
          
          <debug_text text="'[GT-ShipMgmt] Registered ship: ' + $ship.knownname" chance="100"/>
        </do_if>
        <do_else>
          <!-- Update existing ship registration -->
          <set_value name="global.$GT_Ships.{$ship}.$LastUpdate" exact="player.age"/>
        </do_else>
        
        <!-- Always store/update pilot reference in ship data (required for info menu) -->
        <do_if value="$pilot">
          <set_value name="global.$GT_Ships.{$ship}.$Pilot" exact="$pilot"/>
        </do_if>
        
        <!-- Register pilot if provided -->
        <do_if value="$pilot">
          <run_actions ref="Register_Pilot">
            <param name="pilot" value="$pilot"/>
            <param name="ship" value="$ship"/>
          </run_actions>
          
          <!-- Apply ship modifications immediately upon registration -->
          <run_actions ref="Handle_Pilot_Ship_Assignment">
            <param name="ship" value="$ship"/>
            <param name="new_pilot" value="$pilot"/>
            <param name="old_pilot" value="null"/>
          </run_actions>
        </do_if>
      </actions>
    </library>
    
    <!-- Strip GT Name Formatting from Ship Names (Language-Independent) -->
    <!-- NOTE: This library now just forwards to Lua and returns original name -->
    <!-- The CALLER must wait for the Lua response via the Strip_Name_Response cue -->
    <!-- This is because MD libraries cannot wait/be asynchronous -->
    <library name="Strip_GT_Name_Formatting" purpose="run_actions">
      <params>
        <param name="shipName" comment="Current ship name that might have GT formatting"/>
      </params>
      <actions>
        <!-- Request Lua to strip the name (async) -->
        <raise_lua_event name="'GT_StringUtils.StripShipName'" param="$shipName"/>
        
        <!-- Return original name immediately - caller must wait for Lua response -->
        <return value="$shipName"/>
      </actions>
    </library>
    
    <!-- Pilot Registration and XP Management -->
    <library name="Register_Pilot" purpose="run_actions">
      <params>
        <param name="pilot" comment="Pilot to register"/>
        <param name="ship" comment="Associated ship"/>
      </params>
      <actions>
        <!-- ✅ OPTIMIZED: Use extracted initialization library -->
        <!-- This handles: new pilots, existing active pilots, and reactivated paused pilots -->
        <run_actions ref="Initialize_Pilot_Data" result="$wasNewPilot">
          <param name="pilot" value="$pilot"/>
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <!-- Check if pilot was paused and is being reactivated -->
        <set_value name="$wasPaused" exact="false"/>
        <do_if value="global.$GT_Pilots.{$pilot}?">
          <do_if value="global.$GT_Pilots.{$pilot}.$ResumedTime? and (player.age - global.$GT_Pilots.{$pilot}.$ResumedTime) lt 1s">
            <set_value name="$wasPaused" exact="true"/>
          </do_if>
        </do_if>
        
        <do_if value="$wasNewPilot">
          <!-- New pilot was initialized - update ship name with initial state -->
          <run_actions ref="Update_Pilot_Ship_Name" result="$newPilotNameResult">
            <param name="pilot" value="$pilot"/>
            <param name="ship" value="$ship"/>
            <param name="forceUpdate" value="true"/>
          </run_actions>
          <debug_text text="'[GT-ShipMgmt] Registered NEW pilot: ' + $pilot.name + ' - name update result: ' + $newPilotNameResult" chance="100"/>
          
          <!-- ✅ ROLEPLAY: Send logbook message when new pilot is registered -->
          <set_value name="$message" exact="{77000,3214}.[player.name]"/>
          <write_to_logbook 
            category="general" 
            title="'New Pilot: ' + $pilot.name" 
            interaction="showonmap" 
            object="$ship" 
            text="$message"/>
        </do_if>
        <do_elseif value="$wasPaused">
          <!-- ✅ CRITICAL: Pilot was reactivated - update ship name with their preserved XP/level -->
          <run_actions ref="Update_Pilot_Ship_Name" result="$reactivatedNameResult">
            <param name="pilot" value="$pilot"/>
            <param name="ship" value="$ship"/>
            <param name="forceUpdate" value="true"/>
          </run_actions>
          <debug_text text="'[GT-ShipMgmt] Reactivated pilot: ' + $pilot.name + ' (XP: ' + (if global.$GT_Pilots.{$pilot}.$XP? then global.$GT_Pilots.{$pilot}.$XP else 0) + ', Level: ' + (if global.$GT_Pilots.{$pilot}.$Level? then global.$GT_Pilots.{$pilot}.$Level else 1) + ') - name update result: ' + $reactivatedNameResult" chance="100"/>
          
          <!-- Note: Transfer message will be added later if ship swap is detected -->
          <!-- We'll add the "back from holiday" message after ship comparison -->
        </do_elseif>
        
        <!-- Ensure all fields exist (defensive programming) -->
        <run_actions ref="Ensure_Pilot_Fields">
          <param name="pilot" value="$pilot"/>
        </run_actions>
        
        <!-- Update ship association -->
        <set_value name="global.$GT_Pilots.{$pilot}.$AssociatedShip" exact="$ship"/>
        
        <!-- ✅ ENHANCED: Store ship ID for reliable swap detection (ship objects can become invalid) -->
        <!-- Use both ship object AND ship ID for comparison - ID is more reliable for persistence -->
        <set_value name="$currentShipID" exact="$ship.idcode"/>
        <set_value name="$previousShipID" exact="null"/>
        <do_if value="global.$GT_Pilots.{$pilot}.$ShipID?">
          <set_value name="$previousShipID" exact="global.$GT_Pilots.{$pilot}.$ShipID"/>
        </do_if>
        
        <!-- Determine if this is a new ship assignment or resuming on same ship -->
        <set_value name="$isNewShip" exact="false"/>
        
        <do_if value="global.$GT_Pilots.{$pilot}.$Ship? and $previousShipID?">
          <!-- Pilot already has a registered ship - compare ship IDs first (most reliable) -->
          <do_if value="$currentShipID == $previousShipID">
            <!-- Same ship ID - pilot resuming on same ship -->
            <!-- Also update ship object in case it was invalidated -->
            <set_value name="global.$GT_Pilots.{$pilot}.$Ship" exact="$ship"/>
            <debug_text text="'[GT-ShipMgmt] Pilot ' + $pilot.name + ' resuming on SAME ship: ' + $ship.knownname + ' (ID: ' + $currentShipID + ')'" chance="100"/>
            
            <!-- ✅ ROLEPLAY: Send logbook message when pilot returns from holiday on same ship -->
            <!-- ✅ FIX: Only send message if ship has GT default order active (not just when trade orders change) -->
            <do_if value="$wasPaused">
              <set_value name="$hasGTOrder" exact="false"/>
              <do_if value="$ship.defaultorder?">
                <do_if value="@$ship.defaultorder.id == 'GalaxyTraderMK3'">
                  <set_value name="$hasGTOrder" exact="true"/>
                </do_if>
              </do_if>
              <do_if value="$hasGTOrder">
                <set_value name="$message" exact="{77000,3216}.[player.name, $ship.knownname]"/>
                <write_to_logbook 
                  category="general" 
                  title="'Pilot Return: ' + $pilot.name" 
                  interaction="showonmap" 
                  object="$ship" 
                  text="$message"/>
              </do_if>
            </do_if>
          </do_if>
          <do_else>
            <!-- Different ship ID - pilot reassigned to NEW ship! -->
            <set_value name="$isNewShip" exact="true"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$Ship" exact="$ship"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$ShipID" exact="$currentShipID"/>
            <!-- Update original ship name if ship changed -->
            <run_actions ref="Strip_GT_Name_Formatting" result="$cleanedName">
              <param name="shipName" value="$ship.knownname"/>
            </run_actions>
            <set_value name="global.$GT_Pilots.{$pilot}.$OriginalShipName" exact="$cleanedName"/>
            <debug_text text="'[GT-ShipMgmt] Pilot ' + $pilot.name + ' reassigned to NEW ship: ' + $ship.knownname + ' (ID: ' + $currentShipID + ', previous ID: ' + $previousShipID + ')'" chance="100"/>
            
            <!-- ✅ ROLEPLAY: Send logbook message when pilot is transferred to new ship after reactivation -->
            <!-- ✅ FIX: Only send message if ship has GT default order active (not just when trade orders change) -->
            <do_if value="$wasPaused">
              <set_value name="$hasGTOrder" exact="false"/>
              <do_if value="$ship.defaultorder?">
                <do_if value="@$ship.defaultorder.id == 'GalaxyTraderMK3'">
                  <set_value name="$hasGTOrder" exact="true"/>
                </do_if>
              </do_if>
              <do_if value="$hasGTOrder">
                <set_value name="$message" exact="{77000,3217}.[$ship.knownname, player.name]"/>
                <write_to_logbook 
                  category="general" 
                  title="'Pilot Transfer: ' + $pilot.name" 
                  interaction="showonmap" 
                  object="$ship" 
                  text="$message"/>
              </do_if>
            </do_if>
          </do_else>
        </do_if>
        <do_else>
          <!-- First time registration OR pilot reactivated but ShipID was cleared when paused -->
          <set_value name="$isNewShip" exact="true"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$Ship" exact="$ship"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$ShipID" exact="$currentShipID"/>
          <!-- Ensure original name is stored -->
          <do_if value="not global.$GT_Pilots.{$pilot}.$OriginalShipName?">
            <run_actions ref="Strip_GT_Name_Formatting" result="$cleanedName">
              <param name="shipName" value="$ship.knownname"/>
            </run_actions>
            <set_value name="global.$GT_Pilots.{$pilot}.$OriginalShipName" exact="$cleanedName"/>
          </do_if>
          <debug_text text="'[GT-ShipMgmt] First-time registration - pilot ' + $pilot.name + ' on ship: ' + $ship.knownname + ' (ID: ' + $currentShipID + ')'" chance="100"/>
          
          <!-- ✅ ROLEPLAY: Send logbook message when pilot returns from holiday (ShipID was cleared when paused) -->
          <!-- ✅ FIX: Only send message if ship has GT default order active (not just when trade orders change) -->
          <do_if value="$wasPaused">
            <set_value name="$hasGTOrder" exact="false"/>
            <do_if value="$ship.defaultorder?">
              <do_if value="@$ship.defaultorder.id == 'GalaxyTraderMK3'">
                <set_value name="$hasGTOrder" exact="true"/>
              </do_if>
            </do_if>
            <do_if value="$hasGTOrder">
              <set_value name="$message" exact="{77000,3216}.[player.name, $ship.knownname]"/>
              <write_to_logbook 
                category="general" 
                title="'Pilot Return: ' + $pilot.name" 
                interaction="showonmap" 
                object="$ship" 
                text="$message"/>
            </do_if>
          </do_if>
        </do_else>
        
        <!-- ✅ OPTIMIZED: Use extracted ship name update library -->
        <!-- ALWAYS rename ship for existing pilots (whether new ship, same ship, or first registration) -->
        <!-- Note: New pilots already had name updated above, but we update again to ensure consistency -->
        <!-- ✅ CRITICAL: Use forceUpdate to ensure name is always updated, even if pilot data is incomplete -->
        <run_actions ref="Update_Pilot_Ship_Name" result="$nameUpdateResult">
          <param name="pilot" value="$pilot"/>
          <param name="ship" value="$ship"/>
          <param name="forceUpdate" value="true"/>
        </run_actions>
        <debug_text text="'[GT-ShipMgmt] Register_Pilot: Ship name update completed for ' + $pilot.name + ' on ' + $ship.knownname + ' (result: ' + $nameUpdateResult + ')'" chance="100"/>
      </actions>
    </library>
    
    <!-- Update Ship Status -->
    <library name="Update_Ship_Status" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to update"/>
        <param name="status" comment="New status"/>
      </params>
      <actions>
        <do_if value="global.$GT_Ships.{$ship}?">
          <set_value name="global.$GT_Ships.{$ship}.$Status" exact="$status"/>
          <set_value name="global.$GT_Ships.{$ship}.$LastUpdate" exact="player.age"/>
          <debug_text text="'[GT-ShipMgmt] Updated ship status: ' + $ship.knownname + ' -> ' + $status" chance="100"/>
        </do_if>
      </actions>
    </library>
    
    <!-- Skill Level Calculation -->
    <library name="Calculate_Skill_Level" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to check"/>
        <param name="use_md_system" default="true" comment="Prefer MD system over native game skill"/>
      </params>
      <actions>
        <set_value name="$skillLevel" exact="1"/>
        <set_value name="$pilotName" exact="'NONE'"/>
        <set_value name="$usingMDSkill" exact="false"/>
        
        <do_if value="$ship.pilot?">
          <set_value name="$pilotName" exact="$ship.pilot.name"/>
          
          <!-- Try MD system first if enabled -->
          <do_if value="$use_md_system and global.$GT_Pilots.{$ship.pilot}?">
            <set_value name="$mdXP" exact="global.$GT_Pilots.{$ship.pilot}.$XP"/>
            <set_value name="$mdSkillLevel" exact="1"/>
            
            <!-- Calculate skill level from XP using simple thresholds if config not available -->
            <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$SkillThresholds?">
              <!-- Use configuration thresholds -->
              <do_all exact="15" counter="$skillCheck">
                <do_if value="$mdXP ge global.$GT_Config.$XP.$SkillThresholds.{$skillCheck}">
                  <set_value name="$mdSkillLevel" exact="$skillCheck"/>
                </do_if>
              </do_all>
            </do_if>
            <do_else>
              <!-- Use simple XP-based calculation as fallback -->
              <do_if value="$mdXP ge 50000">
                <set_value name="$mdSkillLevel" exact="15"/>
              </do_if>
              <do_elseif value="$mdXP ge 30000">
                <set_value name="$mdSkillLevel" exact="10"/>
              </do_elseif>
              <do_elseif value="$mdXP ge 15000">
                <set_value name="$mdSkillLevel" exact="7"/>
              </do_elseif>
              <do_elseif value="$mdXP ge 5000">
                <set_value name="$mdSkillLevel" exact="4"/>
              </do_elseif>
              <do_elseif value="$mdXP ge 1000">
                <set_value name="$mdSkillLevel" exact="2"/>
              </do_elseif>
            </do_else>
            
            <set_value name="$skillLevel" exact="$mdSkillLevel"/>
            <set_value name="$usingMDSkill" exact="true"/>
          </do_if>
          <!-- Fallback to native game skill -->
          <do_elseif value="$ship.pilot.skill.management?">
            <set_value name="$skillLevel" exact="$ship.pilot.skill.management"/>
          </do_elseif>
        </do_if>
        
        <!-- Check commander skill if better -->
        <do_if value="$ship.commander? and $ship.commander.tradenpc? and $ship.commander.tradenpc.skill.management?">
          <set_value name="$commanderSkill" exact="$ship.commander.tradenpc.skill.management"/>
          <set_value name="$skillLevel" exact="[$skillLevel, $commanderSkill].max"/>
        </do_if>
        
        <debug_text text="'[GT-ShipMgmt] Calculate_Skill_Level returning: Level=' + $skillLevel + ', Pilot=' + $pilotName + ', UsingMD=' + $usingMDSkill" chance="100"/>
        
        <!-- Return comprehensive skill information as result -->
        <return value="table[
          $Level = $skillLevel,
          $PilotName = $pilotName,
          $UsingMDSystem = $usingMDSkill,
          $HasPilot = $ship.pilot?,
          $HasCommander = $ship.commander?
        ]"/>
      </actions>
    </library>
    
    <!-- Jump Distance Calculation Based on Skill -->
    <library name="Calculate_Jump_Distance" purpose="run_actions">
      <params>
        <param name="skill_level" comment="Pilot skill level"/>
      </params>
      <actions>
        <set_value name="$jumpDistance" exact="1"/>
        
        <!-- Skill-based jump distance calculation -->
        <do_if value="$skill_level le 2">
          <set_value name="$jumpDistance" exact="1"/>   <!-- Lehrling -->
        </do_if>
        <do_elseif value="$skill_level le 5">
          <set_value name="$jumpDistance" exact="3"/>   <!-- Kurier -->
        </do_elseif>
        <do_elseif value="$skill_level le 8">
          <set_value name="$jumpDistance" exact="5"/>   <!-- Lieferant -->
        </do_elseif>
        <do_elseif value="$skill_level le 11">
          <set_value name="$jumpDistance" exact="10"/>  <!-- Händler -->
        </do_elseif>
        <do_elseif value="$skill_level le 13">
          <set_value name="$jumpDistance" exact="15"/>  <!-- Kaufmann -->
        </do_elseif>
        <do_else>
          <set_value name="$jumpDistance" exact="25"/>  <!-- Fernkaufmann -->
        </do_else>
        
        <return value="$jumpDistance"/>
      </actions>
    </library>
    
    <!-- Detect Ship Class -->
    <library name="Detect_Ship_Class" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to analyze"/>
      </params>
      <actions>
        <set_value name="$shipClass" exact="'unknown'"/>
        <set_value name="$shipSize" exact="'unknown'"/>
        <set_value name="$isSmall" exact="false"/>
        <set_value name="$isMedium" exact="false"/>
        <set_value name="$isLarge" exact="false"/>
        <set_value name="$isCapital" exact="false"/>
        
        <!-- Detect ship class using X4 native properties -->
        <do_if value="$ship.isclass.ship_s">
          <set_value name="$shipClass" exact="'small'"/>
          <set_value name="$shipSize" exact="'S'"/>
          <set_value name="$isSmall" exact="true"/>
        </do_if>
        <do_elseif value="$ship.isclass.ship_m">
          <set_value name="$shipClass" exact="'medium'"/>
          <set_value name="$shipSize" exact="'M'"/>
          <set_value name="$isMedium" exact="true"/>
        </do_elseif>
        <do_elseif value="$ship.isclass.ship_l">
          <set_value name="$shipClass" exact="'large'"/>
          <set_value name="$shipSize" exact="'L'"/>
          <set_value name="$isLarge" exact="true"/>
        </do_elseif>
        <do_elseif value="$ship.isclass.ship_xl">
          <set_value name="$shipClass" exact="'capital'"/>
          <set_value name="$shipSize" exact="'XL'"/>
          <set_value name="$isCapital" exact="true"/>
        </do_elseif>
        <do_else>
          <!-- Fallback: assume medium ship if detection fails -->
          <set_value name="$shipClass" exact="'medium'"/>
          <set_value name="$shipSize" exact="'M'"/>
          <set_value name="$isMedium" exact="true"/>
          <debug_text text="'[GT-ShipMgmt] WARNING: Failed to detect ship class for ' + $ship.knownname + ', defaulting to medium'" chance="100"/>
        </do_else>
        
        <debug_text text="'[GT-ShipMgmt] Detect_Ship_Class returning: Class=' + $shipClass + ', Size=' + $shipSize + ', Small=' + $isSmall + ', Medium=' + $isMedium + ', Large=' + $isLarge + ', Capital=' + $isCapital" chance="100"/>
        
        <return value="table[
          $Class = $shipClass,
          $Size = $shipSize,
          $IsSmall = $isSmall,
          $IsMedium = $isMedium,
          $IsLarge = $isLarge,
          $IsCapital = $isCapital
        ]"/>
      </actions>
    </library>
    
    <!-- Calculate ship radar range using native property -->
    <library name="Calculate_Radar_Range" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to analyze"/>
      </params>
      <actions>
        <set_value name="$radarRangeMeters" exact="$ship.maxradarrange"/>
        <return value="$radarRangeMeters"/>
      </actions>
    </library>
    
    <!-- Main Ship Modification Handler -->
    <library name="Handle_Pilot_Ship_Assignment" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship receiving modifications"/>
        <param name="new_pilot" comment="New pilot assigned"/>
        <param name="old_pilot" comment="Previous pilot (may be null)"/>
      </params>
      <actions>
        <!-- Get ship class information -->
        <run_actions ref="Detect_Ship_Class" result="$classInfo">
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <!-- Get pilot skill level -->
        <run_actions ref="Calculate_Skill_Level" result="$skillInfo">
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <!-- Safety check: ensure we have valid results -->
        <do_if value="not $classInfo?">
          <debug_text text="'[GT-ShipMgmt] ERROR: Detect_Ship_Class returned null for ' + $ship.knownname" chance="100"/>
          <set_value name="$classInfo" exact="table[$Class = 'medium', $Size = 'M', $IsSmall = false, $IsMedium = true, $IsLarge = false, $IsCapital = false]"/>
        </do_if>
        
        <do_if value="not $skillInfo?">
          <debug_text text="'[GT-ShipMgmt] ERROR: Calculate_Skill_Level returned null for ' + $ship.knownname" chance="100"/>
          <set_value name="$skillInfo" exact="table[$Level = 1, $PilotName = 'UNKNOWN', $UsingMDSystem = false, $HasPilot = false, $HasCommander = false]"/>
        </do_if>
        
        <!-- Apply performance system to ship -->
        <run_actions ref="Apply_Ship_Performance_System">
          <param name="ship" value="$ship"/>
          <param name="skill_level" value="$skillInfo.$Level"/>
          <param name="pilot" value="$new_pilot"/>
        </run_actions>
        
        <debug_text text="'[GT-ShipMgmt] Applied modifications to ' + $ship.knownname + ' for pilot ' + $new_pilot.name + ' (Skill: ' + $skillInfo.$Level + ')'" chance="100"/>
      </actions>
    </library>
    
    <!-- Apply Ship Performance System -->
    <library name="Apply_Ship_Performance_System" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to apply performance system to"/>
        <param name="skill_level" comment="Pilot skill level"/>
        <param name="pilot" comment="Pilot"/>
      </params>
      <actions>
        <!-- Update ship performance display -->
        <run_actions ref="Update_Ship_Performance_Display">
          <param name="ship" value="$ship"/>
          <param name="pilot_level" value="$skill_level"/>
        </run_actions>
        
        <!-- Log performance application -->
        <debug_text text="'[GT-ShipMgmt] Performance system applied to ' + $ship.knownname + ' for pilot ' + $pilot.name + ' (Level: ' + $skill_level + ')'" chance="100"/>
      </actions>
    </library>
    
    <!-- Calculate Ship Performance Bonus/Malus -->
    <library name="Calculate_Performance_Modifier" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to analyze"/>
        <param name="pilot_level" comment="Pilot skill level"/>
      </params>
      <actions>
        <!-- Get ship class information -->
        <run_actions ref="Detect_Ship_Class" result="$classInfo">
          <param name="ship" value="$ship"/>
        </run_actions>
        
        <!-- Safety check: ensure we have valid class info -->
        <do_if value="not $classInfo?">
          <debug_text text="'[GT-ShipMgmt] ERROR: Detect_Ship_Class returned null in Calculate_Performance_Modifier for ' + $ship.knownname" chance="100"/>
          <set_value name="$classInfo" exact="table[$Class = 'medium', $Size = 'M', $IsSmall = false, $IsMedium = true, $IsLarge = false, $IsCapital = false]"/>
        </do_if>
        
        <!-- Initialize performance values -->
        <set_value name="$performanceModifier" exact="0"/>
        <set_value name="$statusText" exact="'Neutral'"/>
        <set_value name="$statusColor" exact="'white'"/>
        
        <!-- Performance Matrix from Specification -->
        <do_if value="$pilot_level le 2">
          <!-- Apprentice (1-2) -->
          <do_if value="$classInfo.$IsSmall">
            <set_value name="$performanceModifier" exact="0"/>
            <set_value name="$statusText" exact="'Optimal'"/>
            <set_value name="$statusColor" exact="'green'"/>
          </do_if>
          <do_elseif value="$classInfo.$IsMedium">
            <set_value name="$performanceModifier" exact="-5"/>
            <set_value name="$statusText" exact="'Penalty'"/>
            <set_value name="$statusColor" exact="'orange'"/>
          </do_elseif>
          <do_elseif value="$classInfo.$IsLarge">
            <set_value name="$performanceModifier" exact="-15"/>
            <set_value name="$statusText" exact="'Major Penalty'"/>
            <set_value name="$statusColor" exact="'red'"/>
          </do_elseif>
          <do_elseif value="$classInfo.$IsCapital">
            <set_value name="$performanceModifier" exact="-25"/>
            <set_value name="$statusText" exact="'Severe Penalty'"/>
            <set_value name="$statusColor" exact="'red'"/>
          </do_elseif>
        </do_if>
        <do_elseif value="$pilot_level == 3">
          <!-- Basic Certified (3) -->
          <do_if value="$classInfo.$IsSmall">
            <set_value name="$performanceModifier" exact="3"/>
            <set_value name="$statusText" exact="'Bonus'"/>
            <set_value name="$statusColor" exact="'green'"/>
          </do_if>
          <do_elseif value="$classInfo.$IsMedium">
            <set_value name="$performanceModifier" exact="0"/>
            <set_value name="$statusText" exact="'Neutral'"/>
            <set_value name="$statusColor" exact="'white'"/>
          </do_elseif>
          <do_elseif value="$classInfo.$IsLarge">
            <set_value name="$performanceModifier" exact="-8"/>
            <set_value name="$statusText" exact="'Penalty'"/>
            <set_value name="$statusColor" exact="'orange'"/>
          </do_elseif>
          <do_elseif value="$classInfo.$IsCapital">
            <set_value name="$performanceModifier" exact="-15"/>
            <set_value name="$statusText" exact="'Major Penalty'"/>
            <set_value name="$statusColor" exact="'red'"/>
          </do_elseif>
        </do_elseif>
        <do_elseif value="$pilot_level ge 4 and $pilot_level le 6">
          <!-- Courier (4-6) -->
          <do_if value="$classInfo.$IsSmall">
            <set_value name="$performanceModifier" exact="3"/>
            <set_value name="$statusText" exact="'Bonus'"/>
            <set_value name="$statusColor" exact="'green'"/>
          </do_if>
          <do_elseif value="$classInfo.$IsMedium">
            <set_value name="$performanceModifier" exact="0"/>
            <set_value name="$statusText" exact="'Neutral'"/>
            <set_value name="$statusColor" exact="'white'"/>
          </do_elseif>
          <do_elseif value="$classInfo.$IsLarge">
            <set_value name="$performanceModifier" exact="-8"/>
            <set_value name="$statusText" exact="'Penalty'"/>
            <set_value name="$statusColor" exact="'orange'"/>
          </do_elseif>
          <do_elseif value="$classInfo.$IsCapital">
            <set_value name="$performanceModifier" exact="-15"/>
            <set_value name="$statusText" exact="'Major Penalty'"/>
            <set_value name="$statusColor" exact="'red'"/>
          </do_elseif>
        </do_elseif>
        <do_elseif value="$pilot_level ge 7 and $pilot_level le 15">
          <!-- Advanced levels - progressively better performance -->
          <do_if value="$pilot_level ge 12">
            <!-- Master Certified (12+) -->
            <do_if value="$classInfo.$IsSmall">
              <set_value name="$performanceModifier" exact="12"/>
            </do_if>
            <do_elseif value="$classInfo.$IsMedium">
              <set_value name="$performanceModifier" exact="9"/>
            </do_elseif>
            <do_elseif value="$classInfo.$IsLarge">
              <set_value name="$performanceModifier" exact="6"/>
            </do_elseif>
            <do_elseif value="$classInfo.$IsCapital">
              <set_value name="$performanceModifier" exact="3"/>
            </do_elseif>
          </do_if>
          <do_elseif value="$pilot_level ge 9">
            <!-- Expert Trader (9-11) -->
            <do_if value="$classInfo.$IsSmall">
              <set_value name="$performanceModifier" exact="9"/>
            </do_if>
            <do_elseif value="$classInfo.$IsMedium">
              <set_value name="$performanceModifier" exact="6"/>
            </do_elseif>
            <do_elseif value="$classInfo.$IsLarge">
              <set_value name="$performanceModifier" exact="3"/>
            </do_elseif>
            <do_elseif value="$classInfo.$IsCapital">
              <set_value name="$performanceModifier" exact="0"/>
            </do_elseif>
          </do_elseif>
          <do_else>
            <!-- Supplier (7-8) -->
            <do_if value="$classInfo.$IsSmall">
              <set_value name="$performanceModifier" exact="6"/>
            </do_if>
            <do_elseif value="$classInfo.$IsMedium">
              <set_value name="$performanceModifier" exact="3"/>
            </do_elseif>
            <do_elseif value="$classInfo.$IsLarge">
              <set_value name="$performanceModifier" exact="0"/>
            </do_elseif>
            <do_elseif value="$classInfo.$IsCapital">
              <set_value name="$performanceModifier" exact="-8"/>
            </do_elseif>
          </do_else>
          
          <!-- Set status for advanced levels -->
          <do_if value="$performanceModifier gt 0">
            <set_value name="$statusText" exact="'Bonus'"/>
            <set_value name="$statusColor" exact="'green'"/>
          </do_if>
          <do_elseif value="$performanceModifier lt 0">
            <set_value name="$statusText" exact="'Penalty'"/>
            <set_value name="$statusColor" exact="'orange'"/>
          </do_elseif>
          <do_else>
            <set_value name="$statusText" exact="'Neutral'"/>
            <set_value name="$statusColor" exact="'white'"/>
          </do_else>
        </do_elseif>
        
        <!-- Master Merchant (15) gets additional bonuses -->
        <do_if value="$pilot_level == 15">
          <set_value name="$performanceModifier" exact="$performanceModifier + 3"/>
          <set_value name="$statusText" exact="'Master Bonus'"/>
          <set_value name="$statusColor" exact="'cyan'"/>
        </do_if>
        
        <!-- Return performance data -->
        <return value="table[
          $Modifier = $performanceModifier,
          $StatusText = $statusText,
          $StatusColor = $statusColor,
          $ShipClass = $classInfo.$Class,
          $ShipSize = $classInfo.$Size
        ]"/>
      </actions>
    </library>
    
    <!-- Get Ship Performance Data -->
    <library name="Get_Ship_Performance_Data" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to get performance data for"/>
      </params>
      <actions>
        <do_if value="global.$GT_Ships.{$ship}?">
          <return value="table[
            $PerformanceInfo = global.$GT_Ships.{$ship}.$PerformanceInfo,
            $PerformanceModifier = global.$GT_Ships.{$ship}.$PerformanceModifier,
            $PerformanceStatus = global.$GT_Ships.{$ship}.$PerformanceStatus,
            $PerformanceLevel = global.$GT_Ships.{$ship}.$PerformanceLevel
          ]"/>
        </do_if>
        <do_else>
          <return value="null"/>
        </do_else>
      </actions>
    </library>
    
    <!-- Update Ship Information Display -->
    <library name="Update_Ship_Performance_Display" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to update"/>
        <param name="pilot_level" comment="Pilot skill level"/>
      </params>
      <actions>
        <!-- Calculate performance modifier -->
        <run_actions ref="Calculate_Performance_Modifier" result="$perfData">
          <param name="ship" value="$ship"/>
          <param name="pilot_level" value="$pilot_level"/>
        </run_actions>
        
        <!-- Create performance info text -->
        <set_value name="$performanceInfo" exact="'GT Performance: ' + $perfData.$StatusText + ' (' + $perfData.$Modifier + '%) - Level ' + $pilot_level + ' pilot in ' + $perfData.$ShipSize + '-class ship'"/>
        
        <!-- Store performance data in global GT_Ships table (X4 doesn't allow custom properties on ship objects) -->
        <do_if value="global.$GT_Ships.{$ship}?">
          <set_value name="global.$GT_Ships.{$ship}.$PerformanceInfo" exact="$performanceInfo"/>
          <set_value name="global.$GT_Ships.{$ship}.$PerformanceModifier" exact="$perfData.$Modifier"/>
          <set_value name="global.$GT_Ships.{$ship}.$PerformanceStatus" exact="$perfData.$StatusText"/>
          <set_value name="global.$GT_Ships.{$ship}.$PerformanceLevel" exact="$pilot_level"/>
        </do_if>
        <do_else>
          <!-- Ship not in tracking table, initialize it first -->
          <debug_text text="'[GT-ShipMgmt] WARNING: Ship ' + $ship.knownname + ' not in GT_Ships table, initializing'" chance="100"/>
          <run_actions ref="Register_Ship">
            <param name="ship" value="$ship"/>
          </run_actions>
          <set_value name="global.$GT_Ships.{$ship}.$PerformanceInfo" exact="$performanceInfo"/>
          <set_value name="global.$GT_Ships.{$ship}.$PerformanceModifier" exact="$perfData.$Modifier"/>
          <set_value name="global.$GT_Ships.{$ship}.$PerformanceStatus" exact="$perfData.$StatusText"/>
          <set_value name="global.$GT_Ships.{$ship}.$PerformanceLevel" exact="$pilot_level"/>
        </do_else>
        
        <!-- Debug output -->
        <debug_text text="'[GT-ShipMgmt] Performance calculated: ' + $ship.knownname + ' - ' + $performanceInfo" chance="100"/>
        
        <!-- Show performance notification to player -->
        <do_if value="global.$GT_Config? and global.$GT_Config.$Notifications? and global.$GT_Config.$Notifications.$Level? and global.$GT_Config.$Notifications.$Level ge 1">
          <show_notification text="'Ship Performance Update:\n' + $ship.knownname + '\n' + $performanceInfo" timeout="8s" priority="6"/>
        </do_if>
      </actions>
    </library>
    
    <!-- Apply Ship Modifications - DEPRECATED: Replaced by GT_Ship_Modification_System -->
    <library name="Apply_Ship_Modifications" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to modify"/>
        <param name="performance_data" comment="Performance data from Calculate_Performance_Modifier"/>
        <param name="pilot_level" comment="Pilot skill level"/>
      </params>
      <actions>
        <!-- DEPRECATED: This library is no longer used. Ship modifications are now handled by -->
        <!-- the GT_Ship_Modification_System using direct engine parameter modification. -->
        <debug_text text="'[GT-ShipMgmt] DEPRECATED: Apply_Ship_Modifications called - use GT_Ship_Modification_System instead'" chance="100"/>
        <!-- Check if modifications are already applied -->
        <set_value name="$currentModLevel" exact="0"/>
        <set_value name="$needsUpdate" exact="true"/>
        
        <do_if value="global.$GT_Ships.{$ship}? and global.$GT_Ships.{$ship}.$AppliedModifications? and global.$GT_Ships.{$ship}.$AppliedModifications.count gt 0">
          <set_value name="$latestMod" exact="global.$GT_Ships.{$ship}.$AppliedModifications.{global.$GT_Ships.{$ship}.$AppliedModifications.count}"/>
          <set_value name="$currentModLevel" exact="$latestMod.$PilotLevel"/>
          
          <!-- Check if modification level matches current pilot level -->
          <do_if value="$currentModLevel == $pilot_level">
            <set_value name="$needsUpdate" exact="false"/>
            <debug_text text="'[GT-ShipMgmt] Ship ' + $ship.knownname + ' already has correct modifications for pilot level ' + $pilot_level" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Get modification values -->
        <set_value name="$modifier" exact="$performance_data.$Modifier"/>
        <set_value name="$shipClass" exact="$performance_data.$ShipClass"/>
        
        <!-- Convert percentage to X4 multiplier format -->
        <set_value name="$multiplier" exact="1.0 + ($modifier / 100.0)"/>
        
        <!-- Ship modifications now handled by GT_Ship_Performance_System -->
        <do_if value="$needsUpdate and $modifier != 0">
          <debug_text text="'[GT-ShipMgmt] Performance tracking updated: ' + $ship.knownname + ' - ' + $modifier + '% (Level ' + $pilot_level + ' pilot)'" chance="100"/>
          
          <!-- Store modification tracking -->
          <set_value name="$modificationData" exact="table[
            $applied_time = player.age
          ]"/>
          <set_value name="$modificationData.$Type" exact="'engine_performance'"/>
          <set_value name="$modificationData.$Multiplier" exact="$multiplier"/>
          <set_value name="$modificationData.$Percentage" exact="$modifier"/>
          <set_value name="$modificationData.$PilotLevel" exact="$pilot_level"/>
          <set_value name="$modificationData.$ShipClass" exact="$shipClass"/>
          <set_value name="$modificationData.$AppliedTime" exact="player.age"/>
          
          <append_to_list name="global.$GT_Ships.{$ship}.$AppliedModifications" exact="$modificationData"/>
          
          <!-- Show modification notification -->
          <show_notification text="'GalaxyTrader Ship Enhancement Applied:\n' + $ship.knownname + '\nEngine Performance: ' + $modifier + '%\nPilot Level: ' + $pilot_level" timeout="10s" priority="7"/>
        </do_if>
        <do_else>
          <debug_text text="'[GT-ShipMgmt] No modifications needed for ' + $ship.knownname + ' (neutral performance)'" chance="100"/>
        </do_else>
      </actions>
    </library>

    <!-- Clear GT Ship Modification Tracking -->
    <library name="Remove_GT_Ship_Modifications" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to clear modification tracking from"/>
      </params>
      <actions>
        <!-- Note: X4 equipment modifications are permanent once applied -->
        <!-- This function only clears our tracking data -->
        <do_if value="global.$GT_Ships.{$ship}? and global.$GT_Ships.{$ship}.$AppliedModifications?">
          <debug_text text="'[GT-ShipMgmt] Clearing GT modification tracking for ' + $ship.knownname" chance="100"/>
          
          <!-- Clear modification tracking -->
          <set_value name="global.$GT_Ships.{$ship}.$AppliedModifications" exact="[]"/>
          
          <debug_text text="'[GT-ShipMgmt] GT modification tracking cleared for ' + $ship.knownname" chance="100"/>
        </do_if>
      </actions>
    </library>

    <!-- Get Ship Modification Status -->
    <library name="Get_Ship_Modification_Status" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to check"/>
      </params>
      <actions>
        <do_if value="global.$GT_Ships.{$ship}? and global.$GT_Ships.{$ship}.$AppliedModifications?">
          <set_value name="$modifications" exact="global.$GT_Ships.{$ship}.$AppliedModifications"/>
          <set_value name="$hasModifications" exact="$modifications.count gt 0"/>
          
          <do_if value="$hasModifications">
            <set_value name="$latestMod" exact="$modifications.{$modifications.count}"/>
            <return value="table[
              $HasModifications = true,
              $ModificationCount = $modifications.count,
              $LatestModification = $latestMod,
              $PerformanceBonus = $latestMod.$Percentage,
              $PilotLevel = $latestMod.$PilotLevel,
              $ShipClass = $latestMod.$ShipClass
            ]"/>
          </do_if>
          <do_else>
            <return value="table[
              $HasModifications = false,
              $ModificationCount = 0
            ]"/>
          </do_else>
        </do_if>
        <do_else>
          <return value="table[
            $HasModifications = false,
            $ModificationCount = 0
          ]"/>
        </do_else>
      </actions>
    </library>

    <!-- Update Ship Modifications on Pilot Change -->
    <library name="Update_Ship_On_Pilot_Change" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship that changed pilot"/>
        <param name="new_pilot" comment="New pilot (can be null)"/>
        <param name="old_pilot" comment="Previous pilot (can be null)"/>
      </params>
      <actions>
        <debug_text text="'[GT-ShipMgmt] Pilot change detected: ' + $ship.knownname + ' - New: ' + @$new_pilot.name + ', Old: ' + @$old_pilot.name" chance="100"/>
        
        <!-- Note: Ship modifications are permanent in X4, but we update tracking for new pilot -->
        
        <!-- Apply new modifications if new pilot exists and is registered -->
        <do_if value="$new_pilot and global.$GT_Pilots.{$new_pilot}?">
          <set_value name="$pilotLevel" exact="1"/>
          
          <!-- Calculate pilot level from XP -->
          <do_if value="global.$GT_Pilots.{$new_pilot}.$XP?">
            <set_value name="$currentXP" exact="global.$GT_Pilots.{$new_pilot}.$XP"/>
            <do_all exact="15" counter="$level">
              <do_if value="$currentXP ge global.$GT_Config.$XP.$SkillThresholds.{$level}">
                <set_value name="$pilotLevel" exact="$level"/>
              </do_if>
            </do_all>
          </do_if>
          
          <debug_text text="'[GT-ShipMgmt] Ship modifications updated for new pilot ' + $new_pilot.name + ' (Level ' + $pilotLevel + ')'" chance="100"/>
        </do_if>
        <do_else>
          <debug_text text="'[GT-ShipMgmt] No modifications applied - pilot not registered or missing'" chance="100"/>
        </do_else>
      </actions>
    </library>
    
    <!-- ========================================================================= -->
    <!-- EXTRACTED LIBRARY FUNCTIONS - Common Pilot Operations                    -->
    <!-- ========================================================================= -->
    
    <!-- Calculate Rank Title from Skill Level -->
    <library name="Calculate_Rank_Title" purpose="run_actions">
      <params>
        <param name="skillLevel" comment="Pilot skill level (1-15)"/>
      </params>
      <actions>
        <set_value name="$rankTitle" exact="'Lehrling'"/>  <!-- Default rank -->
        <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
          <set_value name="$rankIndex" exact="($skillLevel / 3)i + 1"/>
          <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
            <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
          </do_if>
          <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
            <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
          </do_if>
        </do_if>
        <return value="$rankTitle"/>
      </actions>
    </library>
    
    <!-- Calculate Skill Level from XP (simpler version that works with pilot directly) -->
    <library name="Calculate_Skill_Level_From_XP" purpose="run_actions">
      <params>
        <param name="pilot" comment="Pilot to calculate level for"/>
        <param name="xp" comment="XP value (optional, will use pilot's XP if not provided)"/>
      </params>
      <actions>
        <set_value name="$xpValue" exact="0"/>
        <do_if value="$xp?">
          <set_value name="$xpValue" exact="$xp"/>
        </do_if>
        <do_elseif value="$pilot? and global.$GT_Pilots.{$pilot}? and global.$GT_Pilots.{$pilot}.$XP?">
          <set_value name="$xpValue" exact="global.$GT_Pilots.{$pilot}.$XP"/>
        </do_elseif>
        
        <set_value name="$skillLevel" exact="1"/>
        <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$SkillThresholds?">
          <do_all exact="15" counter="$level">
            <do_if value="$xpValue ge global.$GT_Config.$XP.$SkillThresholds.{$level}">
              <set_value name="$skillLevel" exact="$level"/>
            </do_if>
          </do_all>
        </do_if>
        
        <return value="$skillLevel"/>
      </actions>
    </library>
    
    <!-- Initialize Pilot Data Structure -->
    <library name="Initialize_Pilot_Data" purpose="run_actions">
      <params>
        <param name="pilot" comment="Pilot to initialize"/>
        <param name="ship" comment="Associated ship"/>
      </params>
      <actions>
        <!-- Initialize global registry if needed -->
        <do_if value="not global.$GT_Pilots?">
          <set_value name="global.$GT_Pilots" exact="table[]"/>
        </do_if>
        
        <!-- Check if pilot exists and if they were paused -->
        <set_value name="$pilotExists" exact="global.$GT_Pilots.{$pilot}?"/>
        <set_value name="$wasPaused" exact="false"/>
        <set_value name="$wasNewPilot" exact="false"/>
        
        <do_if value="$pilotExists">
          <!-- Pilot exists - check if they were paused -->
          <do_if value="global.$GT_Pilots.{$pilot}.$Status? and global.$GT_Pilots.{$pilot}.$Status == 'paused'">
            <set_value name="$wasPaused" exact="true"/>
            <debug_text text="'[GT-ShipMgmt] Reactivating PAUSED pilot: ' + $pilot.name + ' (XP: ' + (if global.$GT_Pilots.{$pilot}.$XP? then global.$GT_Pilots.{$pilot}.$XP else 0) + ', Level: ' + (if global.$GT_Pilots.{$pilot}.$Level? then global.$GT_Pilots.{$pilot}.$Level else 1) + ')'" chance="100"/>
            
            <!-- ✅ REACTIVATE: Restore pilot to active status with all previous data intact -->
            <set_value name="global.$GT_Pilots.{$pilot}.$Status" exact="'active'"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$ResumedTime" exact="player.age"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$AssociatedShip" exact="$ship"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$Ship" exact="$ship"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$ShipID" exact="$ship.idcode"/>
            
            <!-- Clean up pause-related fields -->
            <remove_value name="global.$GT_Pilots.{$pilot}.$PausedTime"/>
            <remove_value name="global.$GT_Pilots.{$pilot}.$PausedReason"/>
            
            <!-- Ensure all critical fields exist (defensive programming) -->
            <run_actions ref="Ensure_Pilot_Fields">
              <param name="pilot" value="$pilot"/>
            </run_actions>
            
            <!-- Update original ship name if ship changed (strip GT formatting from current name) -->
            <run_actions ref="Strip_GT_Name_Formatting" result="$cleanedName">
              <param name="shipName" value="$ship.knownname"/>
            </run_actions>
            <set_value name="global.$GT_Pilots.{$pilot}.$OriginalShipName" exact="$cleanedName"/>
            
            <!-- ✅ CRITICAL: Restore management skill level based on XP (not stored Level) -->
            <!-- Calculate current skill level from preserved XP -->
            <set_value name="$pilotXP" exact="0"/>
            <do_if value="global.$GT_Pilots.{$pilot}.$XP?">
              <set_value name="$pilotXP" exact="global.$GT_Pilots.{$pilot}.$XP"/>
            </do_if>
            <run_actions ref="Calculate_Skill_Level_From_XP" result="$currentSkillLevel">
              <param name="pilot" value="$pilot"/>
              <param name="xp" value="$pilotXP"/>
            </run_actions>
            <set_skill entity="$pilot" type="skilltype.management" exact="$currentSkillLevel"/>
            <debug_text text="'[GT-ShipMgmt] Restored management skill to level ' + $currentSkillLevel + ' for reactivated pilot ' + $pilot.name + ' (based on XP: ' + $pilotXP + ')'" chance="100"/>
            
            <!-- Update stored Level field to match calculated level -->
            <set_value name="global.$GT_Pilots.{$pilot}.$Level" exact="$currentSkillLevel"/>
            
            <return value="false"/>  <!-- Returns false because pilot was reactivated, not newly initialized -->
          </do_if>
          <do_else>
            <!-- Pilot exists and is already active - update ship association AND restore skill level -->
            <!-- ✅ CRITICAL: Also restore skill level for already-active pilots (they might have lost it) -->
            <set_value name="global.$GT_Pilots.{$pilot}.$AssociatedShip" exact="$ship"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$Ship" exact="$ship"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$ShipID" exact="$ship.idcode"/>
            
            <!-- Restore management skill level based on XP -->
            <set_value name="$pilotXP" exact="0"/>
            <do_if value="global.$GT_Pilots.{$pilot}.$XP?">
              <set_value name="$pilotXP" exact="global.$GT_Pilots.{$pilot}.$XP"/>
            </do_if>
            <run_actions ref="Calculate_Skill_Level_From_XP" result="$currentSkillLevel">
              <param name="pilot" value="$pilot"/>
              <param name="xp" value="$pilotXP"/>
            </run_actions>
            <set_skill entity="$pilot" type="skilltype.management" exact="$currentSkillLevel"/>
            <set_value name="global.$GT_Pilots.{$pilot}.$Level" exact="$currentSkillLevel"/>
            <debug_text text="'[GT-ShipMgmt] Restored management skill to level ' + $currentSkillLevel + ' for already-active pilot ' + $pilot.name + ' (based on XP: ' + $pilotXP + ')'" chance="100"/>
            
            <return value="false"/>  <!-- Returns false because pilot already existed -->
          </do_else>
        </do_if>
        <do_else>
          <!-- ✅ NEW PILOT: Initialize from scratch -->
          <set_value name="$wasNewPilot" exact="true"/>
          <set_value name="global.$GT_Pilots.{$pilot}" exact="table[]"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$XP" exact="0"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$Level" exact="1"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$TotalTrades" exact="0"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$TotalProfit" exact="0Cr"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$TrainingCompleted" exact="[]"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$PilotName" exact="$pilot.name"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$RegisterTime" exact="player.age"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$AssociatedShip" exact="$ship"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$Ship" exact="$ship"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$ShipID" exact="$ship.idcode"/>
          <set_value name="global.$GT_Pilots.{$pilot}.$Status" exact="'active'"/>
          
          <!-- Store original ship name (strip GT formatting) -->
          <run_actions ref="Strip_GT_Name_Formatting" result="$cleanedName">
            <param name="shipName" value="$ship.knownname"/>
          </run_actions>
          <set_value name="global.$GT_Pilots.{$pilot}.$OriginalShipName" exact="$cleanedName"/>
          
          <!-- Set initial management skill to level 1 -->
          <set_skill entity="$pilot" type="skilltype.management" exact="1"/>
          
          <return value="true"/>  <!-- Returns true if pilot was newly initialized -->
        </do_else>
      </actions>
    </library>
    
    <!-- Update Ship Name for Pilot -->
    <library name="Update_Pilot_Ship_Name" purpose="run_actions">
      <params>
        <param name="pilot" comment="Pilot to update ship name for"/>
        <param name="ship" comment="Ship to rename"/>
        <param name="forceUpdate" default="false" comment="Force update even if pilot data missing"/>
      </params>
      <actions>
        <!-- Check if pilot is registered -->
        <do_if value="not global.$GT_Pilots.{$pilot}?">
          <do_if value="$forceUpdate">
            <!-- Force update with default values -->
            <run_actions ref="Calculate_Rank_Title" result="$rankTitle">
              <param name="skillLevel" value="1"/>
            </run_actions>
            <signal_cue_instantly cue="md.GT_XP_Training.UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=0, $level=1, $rank=$rankTitle, $nameType='trader']"/>
          </do_if>
          <do_else>
            <debug_text text="'[GT-ShipMgmt] Cannot update ship name - pilot not registered: ' + $pilot.name" chance="100"/>
            <return value="false"/>
          </do_else>
        </do_if>
        
        <!-- Get pilot data -->
        <set_value name="$currentXP" exact="0"/>
        <set_value name="$currentLevel" exact="1"/>
        <set_value name="$isBlocked" exact="false"/>
        <set_value name="$blockedLevel" exact="0"/>
        
        <do_if value="global.$GT_Pilots.{$pilot}.$XP?">
          <set_value name="$currentXP" exact="global.$GT_Pilots.{$pilot}.$XP"/>
        </do_if>
        
        <!-- Calculate skill level from XP -->
        <run_actions ref="Calculate_Skill_Level_From_XP" result="$currentLevel">
          <param name="pilot" value="$pilot"/>
          <param name="xp" value="$currentXP"/>
        </run_actions>
        
        <!-- Check if XP is blocked -->
        <do_if value="global.$GT_Pilots.{$pilot}.$XPBlocked?">
          <set_value name="$isBlocked" exact="true"/>
          <do_if value="global.$GT_Pilots.{$pilot}.$BlockedLevel?">
            <set_value name="$blockedLevel" exact="global.$GT_Pilots.{$pilot}.$BlockedLevel"/>
          </do_if>
        </do_if>
        
        <!-- Calculate rank title -->
        <set_value name="$levelForRank" exact="if $isBlocked then $blockedLevel else $currentLevel"/>
        <run_actions ref="Calculate_Rank_Title" result="$rankTitle">
          <param name="skillLevel" value="$levelForRank"/>
        </run_actions>
        
        <!-- Determine name type -->
        <set_value name="$nameType" exact="'trader'"/>
        <do_if value="$isBlocked">
          <set_value name="$nameType" exact="'blocked'"/>
        </do_if>
        
        <!-- Update ship name -->
        <signal_cue_instantly cue="md.GT_XP_Training.UpdateShipName" param="table[$ship=$ship, $pilot=$pilot, $xp=$currentXP, $level=$levelForRank, $rank=$rankTitle, $nameType=$nameType]"/>
        
        <return value="true"/>
      </actions>
    </library>
    
    <!-- Ensure Pilot Fields Exist (Defensive Programming) -->
    <library name="Ensure_Pilot_Fields" purpose="run_actions">
      <params>
        <param name="pilot" comment="Pilot to ensure fields for"/>
      </params>
      <actions>
        <do_if value="global.$GT_Pilots.{$pilot}?">
          <!-- Ensure all required fields exist -->
          <do_if value="not global.$GT_Pilots.{$pilot}.$XP?">
            <set_value name="global.$GT_Pilots.{$pilot}.$XP" exact="0"/>
          </do_if>
          <do_if value="not global.$GT_Pilots.{$pilot}.$Level?">
            <set_value name="global.$GT_Pilots.{$pilot}.$Level" exact="1"/>
          </do_if>
          <do_if value="not global.$GT_Pilots.{$pilot}.$TotalTrades?">
            <set_value name="global.$GT_Pilots.{$pilot}.$TotalTrades" exact="0"/>
          </do_if>
          <do_if value="not global.$GT_Pilots.{$pilot}.$TotalProfit?">
            <set_value name="global.$GT_Pilots.{$pilot}.$TotalProfit" exact="0Cr"/>
          </do_if>
          <do_if value="not global.$GT_Pilots.{$pilot}.$TrainingCompleted?">
            <set_value name="global.$GT_Pilots.{$pilot}.$TrainingCompleted" exact="[]"/>
          </do_if>
          <do_if value="not global.$GT_Pilots.{$pilot}.$PilotName?">
            <set_value name="global.$GT_Pilots.{$pilot}.$PilotName" exact="$pilot.name"/>
          </do_if>
          <do_if value="not global.$GT_Pilots.{$pilot}.$Status?">
            <set_value name="global.$GT_Pilots.{$pilot}.$Status" exact="'active'"/>
          </do_if>
          
          <return value="true"/>
        </do_if>
        <do_else>
          <return value="false"/>
        </do_else>
      </actions>
    </library>
    
    <!-- Restore Original Ship Name -->
    <library name="Restore_Original_Ship_Name" purpose="run_actions">
      <params>
        <param name="ship" comment="Ship to restore name for"/>
        <param name="pilot" comment="Pilot associated with ship (optional, will use ship.pilot if not provided)"/>
        <param name="originalName" comment="Original name to restore (optional, will look up from pilot registry if not provided)"/>
      </params>
      <actions>
        <set_value name="$pilotToUse" exact="null"/>
        <do_if value="$pilot?">
          <set_value name="$pilotToUse" exact="$pilot"/>
        </do_if>
        <do_elseif value="$ship.pilot?">
          <set_value name="$pilotToUse" exact="$ship.pilot"/>
        </do_elseif>
        
        <set_value name="$nameToRestore" exact="null"/>
        
        <!-- Use provided original name if available -->
        <do_if value="$originalName?">
          <set_value name="$nameToRestore" exact="$originalName"/>
        </do_if>
        <!-- Otherwise try to get from pilot registry -->
        <do_elseif value="$pilotToUse and global.$GT_Pilots.{$pilotToUse}? and global.$GT_Pilots.{$pilotToUse}.$OriginalShipName?">
          <set_value name="$nameToRestore" exact="global.$GT_Pilots.{$pilotToUse}.$OriginalShipName"/>
        </do_elseif>
        
        <!-- Restore the name if we found one -->
        <do_if value="$nameToRestore?">
          <set_object_name object="$ship" name="$nameToRestore"/>
          <debug_text text="'[GT-ShipMgmt] Restored original ship name: ' + $nameToRestore + ' (Ship ID: ' + $ship.idcode + ')'" chance="100"/>
          <return value="true"/>
        </do_if>
        <do_else>
          <debug_text text="'[GT-ShipMgmt] WARNING: Could not restore original ship name for ' + $ship.knownname + ' (Ship ID: ' + $ship.idcode + ') - original name not found'" chance="100"/>
          <return value="false"/>
        </do_else>
      </actions>
    </library>

  </cues>
</mdscript> 