GalaxyTrader MK3 - Changelog
========================================

Version 0.5.0 - 2025-10-19
--------------------------

MAJOR REFACTOR: Unified Maintenance System
  - Replaced separate repair/equipment systems with unified gt_maintenance.xml
  - Consolidates repair and equipment checks into single maintenance flow
  - MD scripts prepare data, AI scripts execute (vanilla-first approach)
  - Ships handle repair AND equipment restocking in one maintenance trip
  - Event-driven architecture using signal-based communication
  - Affects: All ships with Level 12+ (repair) and Level 15+ (equipment)
  - Files: gt_maintenance.xml (NEW), order.trade.galaxytrader.xml
  - Deprecated: gt_defensive_equipment.xml, gt_auto_repair.xml (logic moved to gt_maintenance.xml)

NEW FEATURE: Complete Equipment Restocking System
  - Added: Automatic restocking of countermeasures AND units (drones/towers)
  - Countermeasures: Flares, chaff (ammostorage.countermeasure) - restocked to configured threshold
  - Units: Defense Drones, Cargo Drones, Repair Drones, Laser Towers (this.ship.units)
  - Uses Balance Profile from global settings to determine target unit quantities
  - Properly distinguishes ammostorage.countermeasure vs. ammostorage.deployable vs. this.ship.units
  - Ships request units using vanilla macro references (macro.ship_gen_s_fightingdrone_01_a_macro.ware)
  - Checks this.ship.units.maxcount for capacity (not units.capacity which returns null)
  - Uses add_build_to_modify_ship with proper shopping lists for BOTH ammo and units
  - Trading ships now properly maintain ALL defensive equipment in one trip
  - Files: gt_maintenance.xml, gt_global_settings.xml

ENHANCEMENT: MD Prepares, AI Executes Pattern
  - MD scripts (gt_maintenance.xml) now only prepare data and validate stations
  - AI scripts (order.trade.galaxytrader.xml) execute actual vanilla orders
  - Data stored in global variables: global.$GT_ResupplyOrders.{$ship}
  - AI uses vanilla actions: add_build_to_modify_ship (not create_order)
  - Prevents immediate="true" issues that terminate AI orders
  - Leverages vanilla's robust station finding, pathfinding, and execution
  - Eliminates need to duplicate complex vanilla logic
  - Files: gt_maintenance.xml, order.trade.galaxytrader.xml

ENHANCEMENT: Comprehensive Diagnostic Logging
  - Added extensive logging to every decision point in maintenance system
  - Logs include: station validation, stock checks, distance calculations, shopping lists
  - Uses emojis for visual scanning: ✅ ⚠️ ❌ 🚨 ⏰
  - All critical decisions logged with chance="100" for reliable debugging
  - Equipment status logged with percentages and thresholds
  - Station selection logged with capabilities and distances
  - Makes troubleshooting equipment issues much easier
  - Files: gt_maintenance.xml, order.trade.galaxytrader.xml

CRITICAL FIX: Resupply/Repair Orders Replacing GalaxyTrader Order
  - Fixed: immediate="true" flag caused Resupply/Repair orders to replace/pause GalaxyTrader order
  - Fixed: Ship would restart GalaxyTrader order and immediately trade (skipping maintenance wait)
  - Removed immediate="true" from BOTH Resupply and Repair order creation
  - Orders now queue normally while GalaxyTrader waits for completion signal
  - Added detection for order restart mid-resupply (checks global.$GT_ResupplyOrders)
  - Added cleanup of resupply tracking on order abort
  - Ship now properly waits for maintenance even if order is restarted
  - Affects: All Level 12+ ships (auto-repair) and Level 15 ships (equipment)
  - Files: gt_defensive_equipment.xml, gt_auto_repair.xml, order.trade.galaxytrader.xml

CRITICAL FIX: Ships Getting Stuck When Equipment System Disabled
  - Fixed: Ships waiting forever for equipment check that never completes when system disabled
  - Fixed: Ships stuck when no equipment dock/shipyard found (never signaled to continue)
  - Fixed: Null pointer error when trying to use $bestStation.knownname with no station found
  - Fixed: Missing validation for global.$GT_Config.$Defense.$Enabled (not validated on load)
  - Now signals GT_Restock_Complete in ALL failure scenarios:
    * System disabled in config
    * Pilot level below 15
    * No suitable station found
  - Ships no longer get stuck - they continue trading immediately
  - Added validation for both $GT_Config.$Defense and $GT_GlobalSettings.$DefensiveEquipment
  - Improved station existence check (now checks: $bestStation and $bestStation.exists)
  - Enhanced "no station found" logbook message with detailed equipment status
  - Affects: Old save games where config wasn't initialized, or when user disables equipment system
  - Files: gt_defensive_equipment.xml, gt_global_settings.xml

NEW FEATURE: Resupply Failure Handling
  - Added monitoring for equipment resupply order failures
  - Detects when station is out of stock (equipment still low after 60s)
  - Writes detailed logbook messages with failure reasons:
    * "No Station Found" - No equipment dock/shipyard within range
    * "Out of Stock" - Station cannot fulfill order, equipment still below thresholds
  - Shows current equipment levels and thresholds in logbook
  - Ship continues trading after failure and retries after next trade
  - Prevents ships from getting stuck waiting for unavailable equipment
  - 60-second timeout for stuck resupply orders
  - Files: gt_defensive_equipment.xml

CRITICAL FIX: Wrong Station Selection for Equipment Replenishment
  - Fixed: System was selecting wrong stations (e.g., Hauptquartier) that don't provide equipment
  - Fixed: Placeholder code set "$hasRequiredEquipment = true" for ALL stations without checking
  - Fixed: CRITICAL - Only searched player-owned stations, now searches ALL accessible stations (NPC + player)
  - Now properly filters for equipment docks and shipyards ONLY
  - Uses same pattern as repair system: checks $station.isequipmentdock and $station.isshipyard
  - Equipment docks: Specialize in missiles, countermeasures, mines, drones, satellites, etc.
  - Shipyards: Provide full range of military equipment and ammo
  - Searches all stations with docking rights (match_relation_to >= dock)
  - Stations sorted by distance, selects nearest equipment-capable station
  - Native Resupply order handles stock verification (fails gracefully if out of stock)
  - Note: Unlike repair (always available), equipment requires actual inventory at stations
  - Files: gt_defensive_equipment.xml

CRITICAL FIX: Initial Equipment Check Not Waiting
  - Fixed: Ships immediately started trading instead of waiting for equipment restock
  - Equipment-only path now waits for GT_Restock_Complete signal (up to 300s)
  - Ships will be fully equipped before starting first trade
  - Files: order.trade.galaxytrader.xml

CRITICAL FIX: Equipment Search Distance Wrong
  - Fixed: Restock search used 5 jumps instead of ship's configured trade distance
  - Fixed: Incorrect logic using pilot.skill.piloting instead of jump distance
  - Now correctly uses MaxBuy/MaxSell from AI parameters (matches trading distance)
  - Default fallback increased from 10 to 15 jumps
  - Files: gt_defensive_equipment.xml

CRITICAL FIX: Disabled Check Continued Execution
  - Fixed: System disabled check logged message but continued to execute
  - Wrapped all equipment logic in do_if block for proper gate-keeping
  - System now properly skips when disabled in configuration
  - Files: gt_defensive_equipment.xml

CRITICAL FIX: Equipment Replenishment - Ship's Own Pilot Only
  - Fixed: Subordinate ships with Level 15 pilots not getting equipment replenishment
  - Fixed: System was incorrectly using commander's pilot level for subordinates
  - Changed: Equipment checks now use ONLY the ship's own pilot level
  - Repair and equipment are managed by each ship's pilot, not the fleet commander
  - Fleet hierarchy does NOT apply to defensive equipment features
  - Example: Level 15 subordinate gets equipment replenishment regardless of commander level
  - Example: Level 12 subordinate does NOT get equipment replenishment even with Level 15 commander
  - Files: order.trade.galaxytrader.xml, gt_trading_signals.xml

ENHANCEMENT: Initial Maintenance Check
  - Added: Ships now check repair and equipment status BEFORE starting to trade
  - Level 15 ships restock equipment at order startup (not just after trades)
  - Level 12+ ships repair at order startup if damaged
  - Ships no longer enter dangerous sectors with depleted defensive equipment
  - Combined maintenance wait ensures ships are fully prepared before first trade
  - Prevents "one trade then restock" behavior, now "restock then trade"
  - Files: order.trade.galaxytrader.xml

CRITICAL FIX: Illegal Ware Trade Loop
  - Fixed: Ships stuck in infinite loop when cache contains illegal wares
  - Added: Illegal ware filtering in cache search (respects AllowIllegal setting)
  - Cache now skips illegal trades and continues to next entry automatically
  - Added: $AllowIllegal parameter propagation (AI → Queue → Search → Cache)
  - Ships without illegal trading enabled no longer attempt illegal trades
  - Fixed: Ship ENJ-399 loop issue (selecting Raumsprit repeatedly)
  - Files: gt_trading_search.xml, gt_trading_queue.xml, gt_trading_execution.xml

Enhanced Debug Logging - Signal Flow Visibility
  - Added: Detailed logging for GT_No_Trade_Found signal (send + receive)
  - Trade execution now logs AllowIllegal setting when blocking illegal wares
  - AI script now logs signal reception with high visibility (chance="100")
  - Improved troubleshooting for stuck ships
  - Files: gt_trading_execution.xml, order.trade.galaxytrader.xml

Defensive Equipment Auto-Replenishment System (Level 15 Feature)
  - NEW: Automatic restocking of countermeasures and deployables after trades
  - NEW: Fleet hierarchy support (subordinates benefit from commander's Level 15)
  - NEW: Combined maintenance optimization (repair + equipment in single trip)
  - NEW: Configurable equipment balance profiles (5 presets: Balanced, Defense-Focused, etc.)
  - NEW: Configurable restock thresholds (countermeasures: 50%, deployables: 70%)
  - NEW: Individual toggles for each equipment type
  - NEW: Menu UI in Global Settings for all configuration options
  - Event-driven system using diff patch (order.resupply.xml)
  - Integrated with existing auto-repair system (Level 12+)
  - Repair takes priority over equipment if both needed
  - Logbook messages for failed replenishment attempts
  - Files: gt_defensive_equipment.xml (NEW), gt_trading_signals.xml, 
          gt_configuration.xml, gt_global_settings.xml, order.resupply.xml (NEW),
          order.trade.galaxytrader.xml

Version 0.4.0 - 2025-10-18
--------------------------

MAJOR: Trade Completion System Refactor
  - Replaced event_player_trade_completed monitoring with diff patch system
  - Created aiscripts/order.trade.perform.xml (diff patch for X4 native trade orders)
  - Created md/gt_trading_signals.xml (centralized signal router)
  - Removed ~140 lines of complex event monitoring from gt_trading_execution.xml
  - Trade completion/failure now detected via direct X4 engine signals
  - Better trade data (exact amounts, quality, failure reasons)
  - Better performance (event-driven, no polling)
  - Fixed: Subordinate ships now log trades correctly

Version 0.3.8 - 2025-10-18
--------------------------

Training System
  - Fixed: Training duration now uses configured values (not hardcoded 30s)
  - Fixed in: order.dock.train.xml

Trade Cache
  - Added: Cache replenishment system (forces live search if cache < 10 entries)
  - Cache now self-sustaining and never fully depletes
  - Fixed in: gt_trading_search.xml

Version 0.3.7 - 2025-10-18
--------------------------

Trade Cache - CRITICAL: Stale Tradeoffer Fix
  - Fixed: Cached trades failing with "insufficient funds" error
  - Fixed: Ships stuck in infinite restart loop
  - Cache now acts as "hint" - re-queries fresh offers from cached stations
  - Fixed: Corrected find_sell_offer/find_buy_offer syntax (tradepartner vs match_seller)
  - Fixed: Removed stale price pre-filter
  - Fixed: Swapped BuyOffer/SellOffer perspective (ship vs station)
  - Cache hits now work reliably
  - Fixed in: gt_trading_search.xml

Version 0.3.6 - 2025-10-18 (REVERTED)
--------------------------

Subordinate Ships
  - Attempted fix for subordinate trade order failures (reverted)

Version 0.3.5 - 2025-10-18
--------------------------

Trade Loop
  - Fixed: AI order rapid abort/restart cycle
  - Fixed: Ships accumulating multiple trade orders
  - Added: Check for existing orders before requesting new trades
  - Added: Clear stale training flags on order start
  - Fixed in: order.trade.galaxytrader.xml

Version 0.3.4 - 2025-10-18
--------------------------

Trade Queue
  - Fixed: Ships getting multiple trade orders simultaneously
  - Moved busy check to run BEFORE queueing (not after)
  - Ships now execute one trade at a time
  - Fixed in: gt_trading_ai.xml

Version 0.3.3 - 2025-10-18
--------------------------

Trade System
  - Major refactor: Separated XP tracking from ship availability checking
  - Simplified availability check (only checks: has trade orders? has training order?)
  - Removed complex cargo/dock/time validation
  - Ships no longer blocked from trading
  - Fixed in: gt_trading_queue.xml

Version 0.3.2 - 2025-10-18
--------------------------

Trade Cache
  - Added 4-layer validation for cached offers (availability, stock, prices)
  - Ships no longer get failed orders from stale cache
  - Fixed in: gt_trading_search.xml

Version 0.3.1 - 2025-10-18
--------------------------

Settings Menu
  - Removed unused "Notification Level" slider

Version 0.3.0 - 2025-10-18
--------------------------

Training & Settings
  - Removed testing mode (production durations active)
  - Updated slider ranges (ROI: 1-30%, XP: 10-100%)

Version 0.2.1 - 2025-10-18
--------------------------

FIXES:
  - Ship names now persist through interruptions
  - Trade cache system completely rewritten and working
  - Settings menu now appears correctly
  - Fixed table key errors in cache writes
  - Fixed reversed buy/sell assignments
  - Better error handling throughout

FILES CHANGED:
  - gt_core_system.xml
  - gt_territory_management.xml
  - gt_trading_search.xml
  - gt_trade_logging.xml
  - gt_trading_execution.xml
  - gt_market_intelligence.xml
  - gt_reporting.xml
  - gt_global_settings.xml
  - gt_trading_maintenance.xml
  - gt_fleet_coordination.xml

Version 0.2.0 - 2024-01-01
--------------------------

Initial Release

FEATURES:
  - Advanced Trading AI with smart route selection
  - XP Progression System (15 levels)
  - Training requirements at levels 3, 6, 9, and 12
  - Fleet Coordination
  - Mobile Satellite Intelligence (Level 9+)
  - Threat Intelligence System
  - Auto-Repair System (Level 12+)
  - Ship Management and automatic renaming
  - Configuration system

REQUIREMENTS:
  - SirNukes Mod Support APIs
  - X4 version 6.0+

Author: GoAhead
