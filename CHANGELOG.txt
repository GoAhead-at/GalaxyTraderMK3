GalaxyTrader MK3 - Changelog
========================================

Version 0.5.1 - 2025-10-20
--------------------------

CRITICAL FIX: Brazilian Portuguese Text Display Bug
  - Fixed: Text showing as "=ReadText77000-9000=" for Brazilian Portuguese users
  - Root cause: Missing Brazilian Portuguese translation file (L055)
  - Solution: Complete Brazilian Portuguese translation added
  - All UI text, messages, and immersive training letters now fully translated
  - Translation covers: Order names, tooltips, XP/training messages, fleet coordination,
    territory management, ware filters, global settings, error messages, and trader titles
  - Files: 0001-L055.xml (NEW), content.xml

========================================

Version 0.5.0 - 2025-10-20
--------------------------

========== NEW FEATURES ==========

NEW FEATURE: Dynamic Blacklist System for Threat Intelligence
  - Added: Lua-based dynamic blacklist manager for real-time threat avoidance
  - Integrates with existing threat intelligence system (gt_threat_intelligence.xml)
  - Creates and manages fleet-wide blacklists via X4's internal FFI API
  - Threatened sectors automatically blacklisted using sector macro IDs
  - Blacklists applied only to fleet commanders and solo ships (subordinates inherit)
  - Empty blacklist created at game start/load for instant threat updates
  - Uses sn_mod_support_apis framework for Lua event handling
  - Vanilla pathfinding (gatedistance) automatically respects blacklists
  - No custom pathfinding needed - ships naturally avoid dangerous sectors
  - Configurable enable/disable in Global Settings
  - Configurable threat level threshold for blacklisting (default: 5)
  - Recurring sync (5s), apply (5s), and cleanup (30s) cycles
  - Files: gt_blacklist_manager.lua (NEW), gt_blacklist_loader.xml (NEW),
          gt_threat_intelligence.xml (modified), gt_global_settings.xml (modified)

NEW FEATURE: Defensive Equipment Auto-Replenishment System (Level 15)
  - Added: Automatic restocking of countermeasures AND units (drones/towers)
  - Countermeasures: Flares, chaff (ammostorage.countermeasure) - restocked to configured threshold
  - Units: Defense Drones, Cargo Drones, Repair Drones, Laser Towers (this.ship.units)
  - Configurable equipment balance profiles (5 presets: Balanced, Defense-Focused, etc.)
  - Configurable restock thresholds (countermeasures: 50%, deployables: 70%)
  - Individual toggles for each equipment type
  - Menu UI in Global Settings for all configuration options
  - Properly distinguishes ammostorage.countermeasure vs. ammostorage.deployable vs. this.ship.units
  - Ships request units using vanilla macro references (macro.ship_gen_s_fightingdrone_01_a_macro.ware)
  - Checks this.ship.units.maxcount for capacity (not units.capacity which returns null)
  - Uses add_build_to_modify_ship with proper shopping lists for BOTH ammo and units
  - Initial check: Ships check equipment status BEFORE starting to trade (not just after)
  - Ships no longer enter dangerous sectors with depleted defensive equipment
  - Prevents "one trade then restock" behavior, now "restock then trade"
  - Combined maintenance optimization (repair + equipment in single trip)
  - Integrated with existing auto-repair system (Level 12+)
  - Repair takes priority over equipment if both needed
  - Event-driven system using diff patch (order.resupply.xml)
  - Trading ships now properly maintain ALL defensive equipment in one trip
  - Failure handling: Monitors resupply orders, detects out-of-stock stations (60s timeout)
  - Detailed logbook messages for failed attempts with current equipment levels
  - Ships continue trading after failure and retry after next trade
  - Never get stuck waiting for unavailable equipment
  - Files: gt_maintenance.xml, gt_global_settings.xml, gt_defensive_equipment.xml, 
          gt_trading_signals.xml, gt_configuration.xml, order.resupply.xml (NEW),
          order.trade.galaxytrader.xml

MAJOR REFACTOR: Unified Maintenance System
  - Replaced separate repair/equipment systems with unified gt_maintenance.xml
  - Consolidates repair and equipment checks into single maintenance flow
  - MD scripts prepare data, AI scripts execute (vanilla-first approach)
  - Ships handle repair AND equipment restocking in one maintenance trip
  - Event-driven architecture using signal-based communication
  - Affects: All ships with Level 12+ (repair) and Level 15+ (equipment)
  - Files: gt_maintenance.xml (NEW), order.trade.galaxytrader.xml
  - Deprecated: gt_defensive_equipment.xml, gt_auto_repair.xml (logic moved to gt_maintenance.xml)

========== ENHANCEMENTS ==========

ENHANCEMENT: Logbook Category Reorganization
  - Improved: Reorganized logbook notifications to prevent "Upkeep" flooding
  - Level-up notifications now go to "News" category (was notification-only, now also in logbook)
  - Trade order logs moved to "Tips" category (was "Upkeep")
  - Training notices remain in "Upkeep" (correct category for maintenance)
  - Result: "Upkeep" category now only contains actual upkeep/maintenance notifications
  - Makes it much easier to spot important maintenance alerts
  - User-requested feature - Thanks to TheBaldNord (Nexus Mods) for the excellent suggestion!
  - Files: gt_xp_training.xml, gt_trade_logging.xml

ENHANCEMENT: MD Prepares, AI Executes Pattern
  - MD scripts (gt_maintenance.xml) now only prepare data and validate stations
  - AI scripts (order.trade.galaxytrader.xml) execute actual vanilla orders
  - Data stored in global variables: global.$GT_ResupplyOrders.{$ship}
  - AI uses vanilla actions: add_build_to_modify_ship (not create_order)
  - Prevents immediate="true" issues that terminate AI orders
  - Leverages vanilla's robust station finding, pathfinding, and execution
  - Eliminates need to duplicate complex vanilla logic
  - Files: gt_maintenance.xml, order.trade.galaxytrader.xml

ENHANCEMENT: Comprehensive Diagnostic Logging
  - Added extensive logging to every decision point in maintenance system
  - Logs include: station validation, stock checks, distance calculations, shopping lists
  - Uses visual markers for quick log scanning (checkmarks, warnings, errors, alerts, timers)
  - All critical decisions logged with chance="100" for reliable debugging
  - Equipment status logged with percentages and thresholds
  - Station selection logged with capabilities and distances
  - Makes troubleshooting equipment issues much easier
  - Files: gt_maintenance.xml, order.trade.galaxytrader.xml

ENHANCEMENT: Signal Flow Visibility
  - Added: Detailed logging for GT_No_Trade_Found signal (send + receive)
  - Trade execution now logs AllowIllegal setting when blocking illegal wares
  - AI script now logs signal reception with high visibility (chance="100")
  - Improved troubleshooting for stuck ships
  - Files: gt_trading_execution.xml, order.trade.galaxytrader.xml

========== BALANCE CHANGES ==========

BALANCE: XP Progression Rebalanced for Longer Campaigns
  - Rebalanced: XP values for more realistic progression (previously too fast)
  - Base XP per trade: 50 -> 8 (reduced by 84%)
  - Value divisor: 10,000 -> 100,000 (10x harder to get value bonus)
  - Quality multiplier: 0.5 -> 0.15 (reduced by 70%)
  - Distance divisor: 20 -> 50 (distance matters less)
  - XP cap per trade: 1000 -> 50 (prevents excessive gains)
  - Result: ~500 trades needed to reach max level (was ~85 trades)
  - With 50% multiplier: ~1000 trades | With 100%: ~500 trades | With 200%: ~250 trades
  - Provides meaningful progression throughout longer gameplay sessions
  - Files: gt_configuration.xml

========== CRITICAL FIXES ==========

CRITICAL FIX: Training Duration Showing "0 Minutes"
  - Fixed: Training messages showing "Die PrÃ¼fung wird etwa 0 Minuten dauern" (0 minutes duration)
  - Root cause: AI script (order.dock.train.xml) sent hardcoded 30-second duration to logging system
  - 30 seconds rounded down to 0 when converted to minutes for display
  - Solution: AI script now retrieves actual calculated duration from global.$GT_Pilots.{$pilot}.$TrainingDuration
  - No fallbacks - uses exact value calculated by MD system (10 min base + skill multiplier)
  - Removed unnecessary "minimum 1 minute" display logic - proper values don't need it
  - Training durations now correctly calculated based on config (10 min base + skill multiplier)
  - Files: order.dock.train.xml, gt_trade_logging.xml

CRITICAL FIX: Docking Check Log Flooding
  - Fixed: Debug logging causing massive log spam (thousands of lines per ship search)
  - Issue 1: Debug code was checking station capabilities using invalid syntax (class.ship_s)
  - Issue 2: After fix, debug logged EVERY trade pair evaluation during search loop
  - Issue 3: Selected trade logging failed with property lookup errors when $bestTrade incomplete
  - Each ship evaluates hundreds/thousands of trade combinations per search
  - Root cause: dockingallowed expects ship object, not ship class
  - Solution: Only log docking status for the FINAL SELECTED trade, not during search
  - Added: Null checks and safe operators (@) for trade property access
  - Debug output: "SELECTED TRADE DOCKING: Ship=X | BUY=Station [OK] | SELL=Station [OK]"
  - Summary: "Rejected X trade pairs due to incompatible docking" (counts only, no spam)
  - Prevents log flooding while maintaining diagnostic capability
  - Files: gt_trading_search.xml

CRITICAL FIX: XP Multiplier Not Applied
  - Fixed: XP Multiplier setting existed but was never applied to XP calculations
  - XP calculation was hardcoded, ignoring player's Global Settings multiplier
  - Implemented: Multiplier now properly applied to all XP gains in order.trade.perform.xml
  - Added: Save game compatibility with automatic validation (invalid values -> 100%)
  - Updated: Multiplier range from 10-100% to 50-200% (100% = default)
  - At 50%: ~1000 trades to max level | At 100%: ~500 trades | At 200%: ~250 trades
  - Allows players to customize progression speed to match playstyle
  - Files: order.trade.perform.xml, gt_global_settings.xml

CRITICAL FIX: Logbook Messages Too Long
  - Fixed: Fleet and Training reports exceeding X4's logbook message limit
  - Fleet Report: Reduced from showing 15 ships (120+ lines) to 5 ships with compact format
  - Training Report: Reduced from unlimited ships to 5 ships with compact format
  - Compact format: One line per ship instead of 8-10 lines
  - Example: "ABC-123: 1.2M Cr, 45 trades [ACTIVE]" or "ABC-123: 45% done, 12 min left"
  - Shows "+X more ships not shown" indicator when fleet exceeds display limit
  - Prevents logbook display errors and truncation issues
  - Files: gt_reporting.xml

CRITICAL FIX: M-Class Ships Stuck with Incompatible Docking
  - Fixed: M-class ships selecting factories with only E-piers (large L+ ship docks)
  - Fixed: Ships unable to complete trades, getting stuck with full cargo
  - Added: dockingallowed.{$ship} validation for BOTH buy and sell stations
  - Trade pairs where ship cannot dock are now skipped during search
  - Works for all ship classes (S/M/L/XL) with proper dock type checking
  - Debug logging shows docking status for SELECTED trade only (no spam)
  - Summary: "Rejected X trade pairs due to incompatible docking"
  - Prevents ships from selecting impossible trade routes
  - Files: gt_trading_search.xml

CRITICAL FIX: Illegal Ware Trade Loop
  - Fixed: Ships stuck in infinite loop when cache contains illegal wares
  - Added: Illegal ware filtering in cache search (respects AllowIllegal setting)
  - Cache now skips illegal trades and continues to next entry automatically
  - Added: $AllowIllegal parameter propagation (AI -> Queue -> Search -> Cache)
  - Ships without illegal trading enabled no longer attempt illegal trades
  - Fixed: Ship ENJ-399 loop issue (selecting Raumsprit repeatedly)
  - Files: gt_trading_search.xml, gt_trading_queue.xml, gt_trading_execution.xml

Version 0.4.0 - 2025-10-18
--------------------------

MAJOR: Trade Completion System Refactor
  - Replaced event_player_trade_completed monitoring with diff patch system
  - Created aiscripts/order.trade.perform.xml (diff patch for X4 native trade orders)
  - Created md/gt_trading_signals.xml (centralized signal router)
  - Removed ~140 lines of complex event monitoring from gt_trading_execution.xml
  - Trade completion/failure now detected via direct X4 engine signals
  - Better trade data (exact amounts, quality, failure reasons)
  - Better performance (event-driven, no polling)
  - Fixed: Subordinate ships now log trades correctly

Version 0.3.8 - 2025-10-18
--------------------------

Training System
  - Fixed: Training duration now uses configured values (not hardcoded 30s)
  - Fixed in: order.dock.train.xml

Trade Cache
  - Added: Cache replenishment system (forces live search if cache < 10 entries)
  - Cache now self-sustaining and never fully depletes
  - Fixed in: gt_trading_search.xml

Version 0.3.7 - 2025-10-18
--------------------------

Trade Cache - CRITICAL: Stale Tradeoffer Fix
  - Fixed: Cached trades failing with "insufficient funds" error
  - Fixed: Ships stuck in infinite restart loop
  - Cache now acts as "hint" - re-queries fresh offers from cached stations
  - Fixed: Corrected find_sell_offer/find_buy_offer syntax (tradepartner vs match_seller)
  - Fixed: Removed stale price pre-filter
  - Fixed: Swapped BuyOffer/SellOffer perspective (ship vs station)
  - Cache hits now work reliably
  - Fixed in: gt_trading_search.xml

Version 0.3.6 - 2025-10-18 (REVERTED)
--------------------------

Subordinate Ships
  - Attempted fix for subordinate trade order failures (reverted)

Version 0.3.5 - 2025-10-18
--------------------------

Trade Loop
  - Fixed: AI order rapid abort/restart cycle
  - Fixed: Ships accumulating multiple trade orders
  - Added: Check for existing orders before requesting new trades
  - Added: Clear stale training flags on order start
  - Fixed in: order.trade.galaxytrader.xml

Version 0.3.4 - 2025-10-18
--------------------------

Trade Queue
  - Fixed: Ships getting multiple trade orders simultaneously
  - Moved busy check to run BEFORE queueing (not after)
  - Ships now execute one trade at a time
  - Fixed in: gt_trading_ai.xml

Version 0.3.3 - 2025-10-18
--------------------------

Trade System
  - Major refactor: Separated XP tracking from ship availability checking
  - Simplified availability check (only checks: has trade orders? has training order?)
  - Removed complex cargo/dock/time validation
  - Ships no longer blocked from trading
  - Fixed in: gt_trading_queue.xml

Version 0.3.2 - 2025-10-18
--------------------------

Trade Cache
  - Added 4-layer validation for cached offers (availability, stock, prices)
  - Ships no longer get failed orders from stale cache
  - Fixed in: gt_trading_search.xml

Version 0.3.1 - 2025-10-18
--------------------------

Settings Menu
  - Removed unused "Notification Level" slider

Version 0.3.0 - 2025-10-18
--------------------------

Training & Settings
  - Removed testing mode (production durations active)
  - Updated slider ranges (ROI: 1-30%, XP: 10-100%)

Version 0.2.1 - 2025-10-18
--------------------------

FIXES:
  - Ship names now persist through interruptions
  - Trade cache system completely rewritten and working
  - Settings menu now appears correctly
  - Fixed table key errors in cache writes
  - Fixed reversed buy/sell assignments
  - Better error handling throughout

FILES CHANGED:
  - gt_core_system.xml
  - gt_territory_management.xml
  - gt_trading_search.xml
  - gt_trade_logging.xml
  - gt_trading_execution.xml
  - gt_market_intelligence.xml
  - gt_reporting.xml
  - gt_global_settings.xml
  - gt_trading_maintenance.xml
  - gt_fleet_coordination.xml

Version 0.2.0 - 2024-01-01
--------------------------

Initial Release

FEATURES:
  - Advanced Trading AI with smart route selection
  - XP Progression System (15 levels)
  - Training requirements at levels 3, 6, 9, and 12
  - Fleet Coordination
  - Mobile Satellite Intelligence (Level 9+)
  - Threat Intelligence System
  - Auto-Repair System (Level 12+)
  - Ship Management and automatic renaming
  - Configuration system

REQUIREMENTS:
  - SirNukes Mod Support APIs
  - X4 version 6.0+

Author: GoAhead
