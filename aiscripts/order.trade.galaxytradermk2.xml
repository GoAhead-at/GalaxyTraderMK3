<?xml version="1.0" encoding="utf-8"?>
<aiscript name="order.trade.galaxytraderMK2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/aiscripts.xsd" version="1">
  <order id="GalaxyTraderMK2" name="{77000, 20002}" description="{77000, 20102}" category="trade" infinite="true" allowinloop="false" canplayercancel="true">
    <params>
      <param name="homeStation" type="object" default="null" text="{77000, 20017}" comment="{77000, 20117}">
        <input_param name="class" value="[class.station]"/>
      </param>
      <param name="sourceList" type="list" default="[]" text="{77000, 20010}" comment="{77000, 20110}">
        <input_param name="type" value="'object'"/>
        <input_param name="class" value="[class.station]"/>
      </param>
      <param name="sourceStation" type="object" default="null" text="{77000, 20010}" comment="{77000, 20110}" advanced="true">
        <input_param name="class" value="[class.station]"/>
      </param>
      <param name="destList" type="list" default="[]" text="{77000, 20011}" comment="{77000, 20111}">
        <input_param name="type" value="'object'"/>
        <input_param name="class" value="[class.station]"/>
      </param>
              <param name="minStorage" type="number" default="if global.$GT_MK2_GlobalSettings? and global.$GT_MK2_GlobalSettings.$Distribution? and global.$GT_MK2_GlobalSettings.$Distribution.$DefaultMinStorage? then global.$GT_MK2_GlobalSettings.$Distribution.$DefaultMinStorage else 20" text="{77000, 20012}" comment="{77000, 20112}">
        <input_param name="min" value="0"/>
        <input_param name="max" value="98"/>
        <input_param name="step" value="1"/>
      </param>
              <param name="staticStorage" type="number" default="if global.$GT_MK2_GlobalSettings? and global.$GT_MK2_GlobalSettings.$Distribution? and global.$GT_MK2_GlobalSettings.$Distribution.$DefaultStaticStorage? then global.$GT_MK2_GlobalSettings.$Distribution.$DefaultStaticStorage else 40" text="{77000, 20013}" comment="{77000, 20113}">
        <input_param name="min" value="0"/>
        <input_param name="max" value="99"/>
        <input_param name="step" value="1"/>
      </param>
              <param name="maxStorage" type="number" default="if global.$GT_MK2_GlobalSettings? and global.$GT_MK2_GlobalSettings.$Distribution? and global.$GT_MK2_GlobalSettings.$Distribution.$DefaultMaxStorage? then global.$GT_MK2_GlobalSettings.$Distribution.$DefaultMaxStorage else 70" text="{77000, 20014}" comment="{77000, 20114}">
        <input_param name="min" value="0"/>
        <input_param name="max" value="100"/>
        <input_param name="step" value="1"/>
      </param>
      <param name="autowares" default="true" type="bool" text="{77000, 1015}" comment="{77000, 1023}"/>
      <param name="warebasket" default="[]" type="list" text="{77000, 20015}" comment="{77000, 20115}">
        <input_param name="type" value="'ware'"/>
        <input_param name="cancarry" value="this.ship"/>
      </param>
      <param name="ignoretraderules" default="false" type="bool" text="{77000, 30012}" comment="{77000, 30112}"/>
      <param name="allowillegal" default="false" type="bool" text="{77000, 1011}" comment="{77000, 1025}"/>
      <param name="bidirectional" default="false" type="bool" text="{77000, 20016}" comment="{77000, 20116}"/>
      <param name="maxDistance" default="[if @this.ship.pilot.skill.management le 2 then 1 else if @this.ship.pilot.skill.management le 5 then 3 else if @this.ship.pilot.skill.management le 8 then 5 else if @this.ship.pilot.skill.management le 11 then 10 else if @this.ship.pilot.skill.management le 13 then 15 else 25, 1].max" type="number" text="{77000, 20018}" comment="{77000, 20118}">
        <input_param name="startvalue" value="0"/>
        <input_param name="min" value="0"/>
        <input_param name="max" value="[if @this.ship.pilot.skill.management le 2 then 1 else if @this.ship.pilot.skill.management le 5 then 3 else if @this.ship.pilot.skill.management le 8 then 5 else if @this.ship.pilot.skill.management le 11 then 10 else if @this.ship.pilot.skill.management le 13 then 15 else 25, 1].max"/>
        <input_param name="step" value="1"/>
      </param>
      <param name="fleetcoordination" default="true" type="bool" text="{77000, 30019}" comment="{77000, 30119}" advanced="true"/>
              <param name="notifications" default="if global.$GT_MK2_GlobalSettings? and global.$GT_MK2_GlobalSettings.$Notifications? and global.$GT_MK2_GlobalSettings.$Notifications.$Verbosity? then global.$GT_MK2_GlobalSettings.$Notifications.$Verbosity else 1" type="number" text="{77000, 30018}" comment="{77000, 30118}">
        <input_param name="min" value="0"/>
        <input_param name="max" value="2"/>
        <input_param name="step" value="1"/>
      </param>
              <param name="debuglevel" default="if global.$GT_MK2_GlobalSettings? and global.$GT_MK2_GlobalSettings.$Debug? and global.$GT_MK2_GlobalSettings.$Debug.$DebugLevel? then global.$GT_MK2_GlobalSettings.$Debug.$DebugLevel else 1" type="number" text="{77000, 30020}" comment="{77000, 30120}" advanced="true">
        <input_param name="min" value="0"/>
        <input_param name="max" value="2"/>
        <input_param name="step" value="1"/>
      </param>
    </params>
    <requires>
      <match shiptype="shiptype.lasertower" negate="true"/>
    </requires>
  </order>

  <interrupts>
    <handler ref="SectorChangeHandler"/>
    <handler ref="AttackHandler"/>
    <handler ref="MissileLockHandler"/>
    <handler ref="ScannedHandler"/>
    <handler ref="InspectedHandler"/>
    <handler ref="FoundAbandonedHandler"/>
    <handler ref="FoundLockboxHandler"/>
    <handler ref="ResupplyHandler"/>
    <handler ref="TargetInvalidHandler"/>
    <handler ref="TideHandler"/>

    <!-- MK2 threat broadcast hook: level 6+ pilots can warn fleet when attacked -->
    <handler>
      <conditions>
        <event_object_attacked object="this.ship"/>
      </conditions>
      <actions>
        <set_value name="$pilotLevel" exact="1"/>
        <set_value name="$primaryFaction" exact="null"/>
        <do_if value="event.param? and event.param.owner?">
          <set_value name="$primaryFaction" exact="event.param.owner"/>
        </do_if>
        <do_if value="this.ship.pilot? and global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$Level?">
          <set_value name="$pilotLevel" exact="global.$GT_Pilots.{this.ship.pilot}.$Level"/>
        </do_if>
        <do_if value="$pilotLevel ge 6">
          <signal_objects object="player.galaxy" param="'GT_Threat_Warning'" param2="table[
            $Sector = this.ship.sector,
            $DetectedBy = this.ship,
            $HostileCount = 1,
            $PrimaryFaction = $primaryFaction,
            $ShipClass_XL = 0,
            $ShipClass_L = 0,
            $ShipClass_M = 1,
            $ShipClass_S = 0,
            $ThreatScore = 2,
            $Timestamp = player.age
          ]"/>
        </do_if>
      </actions>
    </handler>
  </interrupts>

  <init>
    <set_order_syncpoint_reached order="this.ship.order"/>
    <set_value name="$debugchance" exact="if $debuglevel ge 1 then 100 else 0"/>

    <create_list name="$activeSources"/>
    <do_if value="$sourceList? and $sourceList.count gt 0">
      <do_all exact="$sourceList.count" counter="$si">
        <set_value name="$s" exact="$sourceList.{$si}"/>
        <do_if value="$s? and $s.exists and $s.isclass.station">
          <append_to_list name="$activeSources" exact="$s"/>
        </do_if>
      </do_all>
    </do_if>
    <do_if value="$activeSources.count == 0 and $sourceStation? and $sourceStation.exists and $sourceStation.isclass.station">
      <append_to_list name="$activeSources" exact="$sourceStation"/>
    </do_if>
    <do_if value="$activeSources.count == 0">
      <show_notification text="'GalaxyTrader MK2: ' + {77000, 20203}.['(invalid)']" timeout="10s"/>
      <set_command_action commandaction="commandaction.standingby"/>
    </do_if>
    <do_if value="not $destList? or $destList.count == 0">
      <show_notification text="'GalaxyTrader MK2: ' + {77000, 20204}" timeout="10s"/>
      <set_command_action commandaction="commandaction.standingby"/>
    </do_if>

    <set_value name="$minStorage" exact="[0, [$minStorage, 98].min].max"/>
    <set_value name="$staticStorage" exact="[0, [$staticStorage, 99].min].max"/>
    <set_value name="$maxStorage" exact="[0, [$maxStorage, 100].min].max"/>
    <do_if value="$staticStorage le $minStorage">
      <set_value name="$staticStorage" exact="[99, $minStorage + 1].min"/>
    </do_if>
    <do_if value="$maxStorage le $staticStorage">
      <set_value name="$maxStorage" exact="[100, $staticStorage + 1].min"/>
    </do_if>

    <set_value name="this.$sourceStation" exact="$activeSources.{1}"/>
    <set_value name="this.$sourceList" exact="$activeSources"/>
    <set_value name="this.$homeStation" exact="$homeStation"/>
    <set_value name="this.$destList" exact="$destList"/>
    <set_value name="this.$minStorage" exact="$minStorage"/>
    <set_value name="this.$staticStorage" exact="$staticStorage"/>
    <set_value name="this.$maxStorage" exact="$maxStorage"/>
    <set_value name="this.$autowares" exact="$autowares"/>
    <set_value name="this.$warebasket" exact="$warebasket"/>
    <set_value name="this.$ignoretraderules" exact="$ignoretraderules"/>
    <set_value name="this.$allowillegal" exact="$allowillegal"/>
    <set_value name="this.$bidirectional" exact="$bidirectional"/>
    <set_value name="this.$maxDistance" exact="$maxDistance"/>
    <set_value name="this.$fleetcoordination" exact="$fleetcoordination"/>
    <set_value name="this.$notifications" exact="$notifications"/>
    <set_value name="this.$debuglevel" exact="$debuglevel"/>
    <set_value name="this.$debugchance" exact="$debugchance"/>
                <set_value name="this.$minCargoFillPercent" exact="25"/>
                <do_if value="global.$GT_MK2_GlobalSettings? and global.$GT_MK2_GlobalSettings.$Distribution? and global.$GT_MK2_GlobalSettings.$Distribution.$MinimumCargoFillPercent?">
                  <set_value name="this.$minCargoFillPercent" exact="[10, [100, global.$GT_MK2_GlobalSettings.$Distribution.$MinimumCargoFillPercent].min].max"/>
                </do_if>
    <set_value name="this.$sourceUsage" exact="table[]"/>
    <set_value name="this.$destUsage" exact="table[]"/>
    <set_value name="this.$initLogged" exact="false"/>
    <set_value name="this.$lastResolvedWaresDisplay" exact="''"/>
    <set_value name="this.$noTradeRetryCount" exact="0"/>
    <set_value name="this.$lastTradeDestination" exact="null"/>
    <set_value name="this.$lastTradeWare" exact="null"/>
    <set_value name="this.$lastTradeReservedAmount" exact="0"/>

    <!-- MK2 multi-ship reservation state (separate from shared scalar GT_TradeReservations table). -->
    <do_if value="not global.$GT_MK2_TradeReservations?">
      <set_value name="global.$GT_MK2_TradeReservations" exact="table[]"/>
    </do_if>
    <do_if value="not global.$GT_MK2_TradeReservationAmounts?">
      <set_value name="global.$GT_MK2_TradeReservationAmounts" exact="table[]"/>
    </do_if>

    <!-- Payment-source control:
         - with player homeStation: assign to station (station account pays non-internal trades)
         - without homeStation: unassign from station (player account pays non-internal trades)
         Ship-subordinates must remain under their ship commander. -->
    <do_if value="this.$homeStation? and this.$homeStation.exists and this.$homeStation.isplayerowned and (not this.ship.commander.exists or this.ship.commander == this.ship or this.ship.commander.isclass.station) and this.ship.commander != this.$homeStation">
      <do_if value="this.ship.commander.exists and this.ship.commander != this.ship">
        <remove_object_commander object="this.ship"/>
      </do_if>
      <set_object_commander object="this.ship" commander="this.$homeStation" assignment="assignment.trade"/>
    </do_if>
    <do_elseif value="(not this.$homeStation? or not this.$homeStation.exists or not this.$homeStation.isplayerowned) and this.ship.commander.exists and this.ship.commander.isclass.station">
      <remove_object_commander object="this.ship"/>
    </do_elseif>

    <set_command_action commandaction="commandaction.searchingtrades"/>
    <signal_objects object="player.galaxy" param="'GT_AI_Started'" param2="table[
      $Ship = this.ship,
      $Config = table[
        $allowillegal = this.$allowillegal,
        $debuglevel = this.$debuglevel,
        $orderType = 'MK2'
      ]
    ]"/>
  </init>

  <attention min="unknown">
    <actions>
      <set_value name="this.$gt_yieldMs" exact="1"/>
      <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$AIYieldInterval?">
        <set_value name="this.$gt_yieldMs" exact="[1, @global.$GT_GlobalSettings.$Performance.$AIYieldInterval].max"/>
      </do_if>

      <label name="main_loop"/>

      <do_if value="not this.$sourceStation? or not this.$sourceStation.exists">
        <set_value name="$sourceName" exact="'(invalid)'"/>
        <do_if value="this.$sourceStation?">
          <set_value name="$sourceName" exact="this.$sourceStation.knownname"/>
        </do_if>
        <show_notification text="'GalaxyTrader MK2: ' + {77000, 20203}.[$sourceName]" timeout="10s"/>
        <set_command_action commandaction="commandaction.standingby"/>
        <resume label="no_trade_retry"/>
      </do_if>

      <do_if value="this.ship.defaultorder? and this.ship.defaultorder.id == 'GalaxyTraderMK2'">
        <set_value name="this.$sourceList" exact="[]"/>
        <do_if value="this.ship.defaultorder.$sourceList? and this.ship.defaultorder.$sourceList.count gt 0">
          <set_value name="this.$sourceList" exact="this.ship.defaultorder.$sourceList"/>
        </do_if>
        <do_else>
          <do_if value="this.ship.defaultorder.$sourceStation? and this.ship.defaultorder.$sourceStation.exists and this.ship.defaultorder.$sourceStation.isclass.station">
            <append_to_list name="this.$sourceList" exact="this.ship.defaultorder.$sourceStation"/>
          </do_if>
        </do_else>
        <set_value name="this.$destList" exact="this.ship.defaultorder.$destList"/>
        <set_value name="this.$minStorage" exact="this.ship.defaultorder.$minStorage"/>
        <set_value name="this.$staticStorage" exact="this.ship.defaultorder.$staticStorage"/>
        <set_value name="this.$maxStorage" exact="this.ship.defaultorder.$maxStorage"/>
        <set_value name="this.$autowares" exact="if this.ship.defaultorder.$autowares? then this.ship.defaultorder.$autowares else true"/>
        <set_value name="this.$warebasket" exact="this.ship.defaultorder.$warebasket"/>
        <set_value name="this.$ignoretraderules" exact="this.ship.defaultorder.$ignoretraderules"/>
        <set_value name="this.$allowillegal" exact="this.ship.defaultorder.$allowillegal"/>
        <set_value name="this.$bidirectional" exact="this.ship.defaultorder.$bidirectional"/>
        <set_value name="this.$homeStation" exact="this.ship.defaultorder.$homeStation"/>
        <set_value name="this.$maxDistance" exact="this.ship.defaultorder.$maxDistance"/>
        <set_value name="this.$fleetcoordination" exact="this.ship.defaultorder.$fleetcoordination"/>
        <set_value name="this.$notifications" exact="this.ship.defaultorder.$notifications"/>
        <set_value name="this.$debuglevel" exact="this.ship.defaultorder.$debuglevel"/>
        <set_value name="this.$debugchance" exact="if this.$debuglevel ge 1 then 100 else 0"/>
      </do_if>
                  <set_value name="this.$minCargoFillPercent" exact="25"/>
                  <do_if value="global.$GT_MK2_GlobalSettings? and global.$GT_MK2_GlobalSettings.$Distribution? and global.$GT_MK2_GlobalSettings.$Distribution.$MinimumCargoFillPercent?">
                    <set_value name="this.$minCargoFillPercent" exact="[10, [100, global.$GT_MK2_GlobalSettings.$Distribution.$MinimumCargoFillPercent].min].max"/>
                  </do_if>

      <create_list name="$activeSources"/>
      <do_all exact="this.$sourceList.count" counter="$si">
        <set_value name="$s" exact="this.$sourceList.{$si}"/>
        <do_if value="$s? and $s.exists and $s.isclass.station">
          <append_to_list name="$activeSources" exact="$s"/>
        </do_if>
      </do_all>
      <do_if value="$activeSources.count == 0">
        <do_if value="this.$debuglevel ge 1">
          <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': no active sources (sourceList count=' + this.$sourceList.count + ', homeStation=' + (if this.$homeStation? then this.$homeStation.knownname else '(none)') + ')'" chance="this.$debugchance"/>
        </do_if>
        <show_notification text="'GalaxyTrader MK2: ' + {77000, 20203}.['(invalid)']" timeout="10s"/>
        <set_command_action commandaction="commandaction.standingby"/>
        <resume label="no_trade_retry"/>
      </do_if>
      <set_value name="this.$activeSources" exact="$activeSources"/>
      <set_value name="this.$sourceStation" exact="$activeSources.{1}"/>

      <!-- Reconcile commander assignment each loop so runtime order edits
           (setting/clearing homeStation) immediately switch payment source. -->
      <do_if value="this.$homeStation? and this.$homeStation.exists and this.$homeStation.isplayerowned and (not this.ship.commander.exists or this.ship.commander == this.ship or this.ship.commander.isclass.station) and this.ship.commander != this.$homeStation">
        <do_if value="this.ship.commander.exists and this.ship.commander != this.ship">
          <remove_object_commander object="this.ship"/>
        </do_if>
        <set_object_commander object="this.ship" commander="this.$homeStation" assignment="assignment.trade"/>
      </do_if>
      <do_elseif value="(not this.$homeStation? or not this.$homeStation.exists or not this.$homeStation.isplayerowned) and this.ship.commander.exists and this.ship.commander.isclass.station">
        <remove_object_commander object="this.ship"/>
      </do_elseif>

      <create_list name="$activeDestinations"/>
      <set_value name="$destInvalidCount" exact="0"/>
      <do_all exact="this.$destList.count" counter="$di">
        <set_value name="$d" exact="this.$destList.{$di}"/>
        <do_if value="not $d? or not $d.exists or not $d.isclass.station">
          <set_value name="$destInvalidCount" operation="add"/>
        </do_if>
        <do_else>
          <append_to_list name="$activeDestinations" exact="$d"/>
        </do_else>
      </do_all>
      <set_value name="$sourceNames" exact="''"/>
      <do_all exact="$activeSources.count" counter="$sn">
        <do_if value="$sn gt 1">
          <set_value name="$sourceNames" exact="$sourceNames + ', '"/>
        </do_if>
        <set_value name="$sourceNames" exact="$sourceNames + $activeSources.{$sn}.knownname + ' [' + $activeSources.{$sn}.idcode + ']'"/>
      </do_all>
      <set_value name="$destNames" exact="''"/>
      <do_all exact="$activeDestinations.count" counter="$dn">
        <do_if value="$dn gt 1">
          <set_value name="$destNames" exact="$destNames + ', '"/>
        </do_if>
        <set_value name="$destNames" exact="$destNames + $activeDestinations.{$dn}.knownname + ' [' + $activeDestinations.{$dn}.idcode + ']'"/>
      </do_all>

      <!-- One-time startup dump of resolved MK2 setup for diagnostics.
           Must run before early no-destination resume paths. -->
      <do_if value="this.$debuglevel ge 1 and (not this.$initLogged? or not this.$initLogged)">
        <set_value name="$homeName" exact="'(none)'"/>
        <do_if value="this.$homeStation? and this.$homeStation.exists">
          <set_value name="$homeName" exact="this.$homeStation.knownname + ' [' + this.$homeStation.idcode + ']'"/>
        </do_if>
        <set_value name="$sourceListMode" exact="'auto dynamic'"/>
        <do_if value="not this.$autowares">
          <set_value name="$sourceListMode" exact="'manual basket only'"/>
        </do_if>
        <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': INIT setup | home=' + $homeName + ' | sourceCursor=' + this.$sourceStation.knownname + ' [' + this.$sourceStation.idcode + ']' + ' | src=' + this.$activeSources.count + ' [' + $sourceNames + ']' + ' | dst=' + $activeDestinations.count + ' [' + $destNames + ']' + ' | min/static/max=' + this.$minStorage + '/' + this.$staticStorage + '/' + this.$maxStorage + ' | maxDist=' + this.$maxDistance + ' | minFill=' + this.$minCargoFillPercent + '% | bidir=' + this.$bidirectional + ' | ignoreRules=' + this.$ignoretraderules + ' | allowIllegal=' + this.$allowillegal + ' | wareMode=' + $sourceListMode + ' | notifications=' + this.$notifications + ' | fleet=' + this.$fleetcoordination + ' | destInvalid=' + $destInvalidCount + ' | diagRev=mk2-offerdiag-r3'" chance="this.$debugchance"/>
        <!-- Detailed one-time diagnostics for all involved stations and relevant wares. -->
        <set_value name="$diagWareLimit" exact="12"/>
        <do_all exact="this.$activeSources.count" counter="$dsi">
          <set_value name="$diagStation" exact="this.$activeSources.{$dsi}"/>
          <set_value name="$diagProducts" exact="$diagStation.products.list"/>
          <set_value name="$diagTradewares" exact="$diagStation.tradewares.list"/>
          <set_value name="$diagResources" exact="$diagStation.resources.list"/>
          <set_value name="$diagWareNames" exact="''"/>
          <set_value name="$diagWareLogged" exact="0"/>
          <create_list name="$diagSourceWares"/>
          <do_all exact="$diagProducts.count" counter="$dpi">
            <append_to_list name="$diagSourceWares" exact="$diagProducts.{$dpi}"/>
          </do_all>
          <do_all exact="$diagTradewares.count" counter="$dti">
            <set_value name="$dw" exact="$diagTradewares.{$dti}"/>
            <set_value name="$dup" exact="false"/>
            <do_all exact="$diagSourceWares.count" counter="$ddi">
              <do_if value="$diagSourceWares.{$ddi} == $dw">
                <set_value name="$dup" exact="true"/>
                <break/>
              </do_if>
            </do_all>
            <do_if value="not $dup">
              <append_to_list name="$diagSourceWares" exact="$dw"/>
            </do_if>
          </do_all>
          <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': STATION src ' + $diagStation.knownname + ' [' + $diagStation.idcode + '] owner=' + (if $diagStation.isplayerowned then 'player' else 'foreign') + ' products=' + $diagProducts.count + ' tradewares=' + $diagTradewares.count + ' resources=' + $diagResources.count + ' waresForOffers=' + $diagSourceWares.count" chance="this.$debugchance"/>
          <do_all exact="$diagSourceWares.count" counter="$dwi">
            <do_if value="$diagWareLogged ge $diagWareLimit">
              <break/>
            </do_if>
            <set_value name="$diagWare" exact="$diagSourceWares.{$dwi}"/>
            <set_value name="$cargoCount" exact="$diagStation.cargo.{$diagWare}.count"/>
            <set_value name="$cargoTarget" exact="$diagStation.cargo.{$diagWare}.target"/>
            <set_value name="$cargoTargetSafe" exact="[$cargoTarget, 1].max"/>
            <set_value name="$cargoRatio" exact="($cargoCount * 100) / $cargoTargetSafe"/>
            <find_sell_offer tradepartner="this.ship" seller="$diagStation" wares="$diagWare" result="$diagSellPartner"/>
            <find_buy_offer tradepartner="this.ship" buyer="$diagStation" wares="$diagWare" result="$diagBuyPartner"/>
            <set_value name="$sellPartnerAvail" exact="'0'"/>
            <set_value name="$sellPartnerAmount" exact="'n/a'"/>
            <do_if value="$diagSellPartner != null">
              <set_value name="$sellPartnerAmount" exact="$diagSellPartner.amount"/>
              <do_if value="$diagSellPartner.available">
                <set_value name="$sellPartnerAvail" exact="'1'"/>
              </do_if>
            </do_if>
            <set_value name="$buyPartnerAvail" exact="'0'"/>
            <set_value name="$buyPartnerAmount" exact="'n/a'"/>
            <do_if value="$diagBuyPartner != null">
              <set_value name="$buyPartnerAmount" exact="$diagBuyPartner.amount"/>
              <do_if value="$diagBuyPartner.available">
                <set_value name="$buyPartnerAvail" exact="'1'"/>
              </do_if>
            </do_if>
            <set_value name="$sellIgnoreAvail" exact="'n/a'"/>
            <set_value name="$sellIgnoreAmount" exact="'n/a'"/>
            <set_value name="$buyIgnoreAvail" exact="'n/a'"/>
            <set_value name="$buyIgnoreAmount" exact="'n/a'"/>
            <do_if value="this.$ignoretraderules and $diagStation.isplayerowned">
              <find_sell_offer seller="$diagStation" wares="$diagWare" result="$diagSellIgnore"/>
              <find_buy_offer buyer="$diagStation" wares="$diagWare" result="$diagBuyIgnore"/>
              <set_value name="$sellIgnoreAvail" exact="'0'"/>
              <set_value name="$sellIgnoreAmount" exact="'n/a'"/>
              <do_if value="$diagSellIgnore != null">
                <set_value name="$sellIgnoreAmount" exact="$diagSellIgnore.amount"/>
                <do_if value="$diagSellIgnore.available">
                  <set_value name="$sellIgnoreAvail" exact="'1'"/>
                </do_if>
              </do_if>
              <set_value name="$buyIgnoreAvail" exact="'0'"/>
              <set_value name="$buyIgnoreAmount" exact="'n/a'"/>
              <do_if value="$diagBuyIgnore != null">
                <set_value name="$buyIgnoreAmount" exact="$diagBuyIgnore.amount"/>
                <do_if value="$diagBuyIgnore.available">
                  <set_value name="$buyIgnoreAvail" exact="'1'"/>
                </do_if>
              </do_if>
            </do_if>
            <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': STATION src ' + $diagStation.idcode + ' ware=' + $diagWare + ' cargo=' + $cargoCount + '/' + $cargoTarget + ' (' + $cargoRatio + '%)' + ' sell(partner:a=' + $sellPartnerAvail + ',m=' + $sellPartnerAmount + '; ignore:a=' + $sellIgnoreAvail + ',m=' + $sellIgnoreAmount + ')' + ' buy(partner:a=' + $buyPartnerAvail + ',m=' + $buyPartnerAmount + '; ignore:a=' + $buyIgnoreAvail + ',m=' + $buyIgnoreAmount + ')'" chance="this.$debugchance"/>
            <set_value name="$diagWareLogged" operation="add"/>
          </do_all>
        </do_all>

        <do_all exact="$activeDestinations.count" counter="$ddi">
          <set_value name="$diagStation" exact="$activeDestinations.{$ddi}"/>
          <set_value name="$diagProducts" exact="$diagStation.products.list"/>
          <set_value name="$diagTradewares" exact="$diagStation.tradewares.list"/>
          <set_value name="$diagResources" exact="$diagStation.resources.list"/>
          <set_value name="$diagWareLogged" exact="0"/>
          <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': STATION dst ' + $diagStation.knownname + ' [' + $diagStation.idcode + '] owner=' + (if $diagStation.isplayerowned then 'player' else 'foreign') + ' products=' + $diagProducts.count + ' tradewares=' + $diagTradewares.count + ' resources=' + $diagResources.count" chance="this.$debugchance"/>
          <do_all exact="$diagResources.count" counter="$dri">
            <do_if value="$diagWareLogged ge $diagWareLimit">
              <break/>
            </do_if>
            <set_value name="$diagWare" exact="$diagResources.{$dri}"/>
            <set_value name="$cargoCount" exact="$diagStation.cargo.{$diagWare}.count"/>
            <set_value name="$cargoTarget" exact="$diagStation.cargo.{$diagWare}.target"/>
            <set_value name="$cargoTargetSafe" exact="[$cargoTarget, 1].max"/>
            <set_value name="$cargoRatio" exact="($cargoCount * 100) / $cargoTargetSafe"/>
            <find_sell_offer tradepartner="this.ship" seller="$diagStation" wares="$diagWare" result="$diagSellPartner"/>
            <find_buy_offer tradepartner="this.ship" buyer="$diagStation" wares="$diagWare" result="$diagBuyPartner"/>
            <set_value name="$sellPartnerAvail" exact="'0'"/>
            <set_value name="$sellPartnerAmount" exact="'n/a'"/>
            <do_if value="$diagSellPartner != null">
              <set_value name="$sellPartnerAmount" exact="$diagSellPartner.amount"/>
              <do_if value="$diagSellPartner.available">
                <set_value name="$sellPartnerAvail" exact="'1'"/>
              </do_if>
            </do_if>
            <set_value name="$buyPartnerAvail" exact="'0'"/>
            <set_value name="$buyPartnerAmount" exact="'n/a'"/>
            <do_if value="$diagBuyPartner != null">
              <set_value name="$buyPartnerAmount" exact="$diagBuyPartner.amount"/>
              <do_if value="$diagBuyPartner.available">
                <set_value name="$buyPartnerAvail" exact="'1'"/>
              </do_if>
            </do_if>
            <set_value name="$sellIgnoreAvail" exact="'n/a'"/>
            <set_value name="$sellIgnoreAmount" exact="'n/a'"/>
            <set_value name="$buyIgnoreAvail" exact="'n/a'"/>
            <set_value name="$buyIgnoreAmount" exact="'n/a'"/>
            <do_if value="this.$ignoretraderules and $diagStation.isplayerowned">
              <find_sell_offer seller="$diagStation" wares="$diagWare" result="$diagSellIgnore"/>
              <find_buy_offer buyer="$diagStation" wares="$diagWare" result="$diagBuyIgnore"/>
              <set_value name="$sellIgnoreAvail" exact="'0'"/>
              <set_value name="$sellIgnoreAmount" exact="'n/a'"/>
              <do_if value="$diagSellIgnore != null">
                <set_value name="$sellIgnoreAmount" exact="$diagSellIgnore.amount"/>
                <do_if value="$diagSellIgnore.available">
                  <set_value name="$sellIgnoreAvail" exact="'1'"/>
                </do_if>
              </do_if>
              <set_value name="$buyIgnoreAvail" exact="'0'"/>
              <set_value name="$buyIgnoreAmount" exact="'n/a'"/>
              <do_if value="$diagBuyIgnore != null">
                <set_value name="$buyIgnoreAmount" exact="$diagBuyIgnore.amount"/>
                <do_if value="$diagBuyIgnore.available">
                  <set_value name="$buyIgnoreAvail" exact="'1'"/>
                </do_if>
              </do_if>
            </do_if>
            <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': STATION dst ' + $diagStation.idcode + ' ware=' + $diagWare + ' cargo=' + $cargoCount + '/' + $cargoTarget + ' (' + $cargoRatio + '%)' + ' buy(partner:a=' + $buyPartnerAvail + ',m=' + $buyPartnerAmount + '; ignore:a=' + $buyIgnoreAvail + ',m=' + $buyIgnoreAmount + ')' + ' sell(partner:a=' + $sellPartnerAvail + ',m=' + $sellPartnerAmount + '; ignore:a=' + $sellIgnoreAvail + ',m=' + $sellIgnoreAmount + ')'" chance="this.$debugchance"/>
            <set_value name="$diagWareLogged" operation="add"/>
          </do_all>
        </do_all>
        <set_value name="this.$initLogged" exact="true"/>
      </do_if>

      <do_if value="$activeDestinations.count == 0">
        <do_if value="this.$debuglevel ge 1">
          <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': no active destinations (destList=' + this.$destList.count + ', sourceCursor=' + this.$sourceStation.knownname + ' [' + this.$sourceStation.idcode + '], srcList=' + this.$activeSources.count + ' [' + $sourceNames + '], invalid=' + $destInvalidCount + ')'" chance="this.$debugchance"/>
        </do_if>
        <show_notification text="'GalaxyTrader MK2: ' + {77000, 20204}" timeout="10s"/>
        <set_command_action commandaction="commandaction.standingby"/>
        <resume label="no_trade_retry"/>
      </do_if>
      <set_value name="this.$activeDestinations" exact="$activeDestinations"/>

      <signal_objects object="player.galaxy" param="'GT_Check_Maintenance'" param2="table[$Ship = this.ship]"/>
      <wait exact="this.$gt_yieldMs * 1ms"/>

      <do_if value="this.ship.cargo.count gt 0">
        <set_value name="$cargoWares" exact="this.ship.cargo.list"/>
        <do_all exact="$cargoWares.count" counter="$ci">
          <set_value name="$cWare" exact="$cargoWares.{$ci}"/>
          <set_value name="$cAmount" exact="this.ship.cargo.{$cWare}.count"/>
          <do_if value="$cAmount gt 0">
            <set_value name="$clearOffer" exact="null"/>
            <set_value name="$clearBestAmount" exact="0"/>
            <do_all exact="this.$activeSources.count" counter="$sci">
              <set_value name="$clearSource" exact="this.$activeSources.{$sci}"/>
              <set_value name="$clearCandidate" exact="null"/>
              <do_if value="this.$ignoretraderules and $clearSource.isplayerowned">
                <find_buy_offer buyer="$clearSource" wares="$cWare" result="$clearCandidate"/>
              </do_if>
              <do_else>
                <find_buy_offer tradepartner="this.ship" buyer="$clearSource" wares="$cWare" result="$clearCandidate"/>
              </do_else>
              <do_if value="$clearCandidate == null and this.$ignoretraderules and $clearSource.isplayerowned">
                <!-- Fallback: ignore-rules lookup may return null while partner-filtered returns a usable offer. -->
                <find_buy_offer tradepartner="this.ship" buyer="$clearSource" wares="$cWare" result="$clearCandidate"/>
              </do_if>
              <set_value name="$clearCandidateAmount" exact="0"/>
              <do_if value="$clearCandidate != null">
                <set_value name="$clearCandidateAmount" exact="$clearCandidate.offeramount.{this.ship}"/>
              </do_if>
              <do_if value="$clearCandidateAmount == null and $clearCandidate != null">
                <set_value name="$clearCandidateAmount" exact="$clearCandidate.amount"/>
              </do_if>
              <do_if value="$clearCandidateAmount == null">
                <set_value name="$clearCandidateAmount" exact="0"/>
              </do_if>
              <do_if value="$clearCandidate != null and $clearCandidate.available and $clearCandidateAmount gt $clearBestAmount">
                <set_value name="$clearBestAmount" exact="$clearCandidateAmount"/>
                <set_value name="$clearOffer" exact="$clearCandidate"/>
              </do_if>
            </do_all>
            <do_if value="$clearOffer != null and $clearOffer.available and $clearBestAmount gt 0">
              <set_value name="$clearAmount" exact="[$cAmount, $clearBestAmount].min"/>
              <create_trade_order object="this.ship" tradeoffer="$clearOffer" amount="$clearAmount" immediate="true" internal="false"/>
            </do_if>
          </do_if>
        </do_all>
        <do_while value="this.ship.orders.count gt 0">
          <wait exact="5s">
            <interrupt>
              <conditions>
                <event_object_order_ready object="this.ship"/>
              </conditions>
            </interrupt>
          </wait>
        </do_while>
      </do_if>

      <create_list name="$manualSourceWares"/>
      <do_if value="not this.$autowares and this.$warebasket? and this.$warebasket.count gt 0">
        <do_all exact="this.$warebasket.count" counter="$wi">
          <append_to_list name="$manualSourceWares" exact="this.$warebasket.{$wi}"/>
        </do_all>
      </do_if>

      <create_list name="$targetResourceWares"/>
      <do_all exact="this.$activeDestinations.count" counter="$di">
        <set_value name="$dest" exact="this.$activeDestinations.{$di}"/>
        <set_value name="$destResources" exact="$dest.resources.list"/>
        <do_all exact="$destResources.count" counter="$ri">
          <set_value name="$rw" exact="$destResources.{$ri}"/>
          <set_value name="$dup" exact="false"/>
          <do_all exact="$targetResourceWares.count" counter="$dri">
            <do_if value="$targetResourceWares.{$dri} == $rw">
              <set_value name="$dup" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          <do_if value="not $dup">
            <append_to_list name="$targetResourceWares" exact="$rw"/>
          </do_if>
        </do_all>
      </do_all>

      <set_value name="$resolvedWaresDisplay" exact="''"/>
      <set_value name="$resolvedWaresCount" exact="0"/>
      <do_if value="not this.$autowares">
        <do_all exact="$manualSourceWares.count" counter="$mwi">
          <do_if value="$mwi gt 1">
            <set_value name="$resolvedWaresDisplay" exact="$resolvedWaresDisplay + ', '"/>
          </do_if>
          <set_value name="$resolvedWaresDisplay" exact="$resolvedWaresDisplay + $manualSourceWares.{$mwi}"/>
        </do_all>
        <set_value name="$resolvedWaresCount" exact="$manualSourceWares.count"/>
      </do_if>
      <do_else>
        <create_list name="$autoSelectedWares"/>
        <do_all exact="this.$activeSources.count" counter="$as">
          <set_value name="$autoSource" exact="this.$activeSources.{$as}"/>
          <set_value name="$autoSourceProducts" exact="$autoSource.products.list"/>
          <set_value name="$autoSourceTradewares" exact="$autoSource.tradewares.list"/>
          <create_list name="$autoSourceSellable"/>
          <do_all exact="$autoSourceProducts.count" counter="$ap">
            <append_to_list name="$autoSourceSellable" exact="$autoSourceProducts.{$ap}"/>
          </do_all>
          <do_all exact="$autoSourceTradewares.count" counter="$at">
            <set_value name="$atw" exact="$autoSourceTradewares.{$at}"/>
            <set_value name="$dup" exact="false"/>
            <do_all exact="$autoSourceSellable.count" counter="$ad">
              <do_if value="$autoSourceSellable.{$ad} == $atw">
                <set_value name="$dup" exact="true"/>
                <break/>
              </do_if>
            </do_all>
            <do_if value="not $dup">
              <append_to_list name="$autoSourceSellable" exact="$atw"/>
            </do_if>
          </do_all>
          <do_all exact="$autoSourceSellable.count" counter="$aw">
            <set_value name="$awv" exact="$autoSourceSellable.{$aw}"/>
            <do_all exact="$targetResourceWares.count" counter="$trw">
              <do_if value="$awv == $targetResourceWares.{$trw}">
                <set_value name="$dup" exact="false"/>
                <do_all exact="$autoSelectedWares.count" counter="$dupi">
                  <do_if value="$autoSelectedWares.{$dupi} == $awv">
                    <set_value name="$dup" exact="true"/>
                    <break/>
                  </do_if>
                </do_all>
                <do_if value="not $dup">
                  <append_to_list name="$autoSelectedWares" exact="$awv"/>
                </do_if>
                <break/>
              </do_if>
            </do_all>
          </do_all>
        </do_all>
        <do_all exact="$autoSelectedWares.count" counter="$awi">
          <do_if value="$awi gt 1">
            <set_value name="$resolvedWaresDisplay" exact="$resolvedWaresDisplay + ', '"/>
          </do_if>
          <set_value name="$resolvedWaresDisplay" exact="$resolvedWaresDisplay + $autoSelectedWares.{$awi}"/>
        </do_all>
        <set_value name="$resolvedWaresCount" exact="$autoSelectedWares.count"/>
      </do_else>
      <set_value name="$currentWaresDisplay" exact="''"/>
      <do_if value="this.$warebasket? and this.$warebasket.count gt 0">
        <do_all exact="this.$warebasket.count" counter="$cwi">
          <do_if value="$cwi gt 1">
            <set_value name="$currentWaresDisplay" exact="$currentWaresDisplay + ', '"/>
          </do_if>
          <set_value name="$currentWaresDisplay" exact="$currentWaresDisplay + this.$warebasket.{$cwi}"/>
        </do_all>
      </do_if>

      <!-- Keep the UI-selected ware list in sync while AutoWares is enabled,
           but ONLY when the actual default-order warebasket differs. -->
      <do_if value="this.$autowares and $resolvedWaresDisplay != $currentWaresDisplay and this.ship.defaultorder? and this.ship.defaultorder.id == 'GalaxyTraderMK2'">
        <set_value name="this.$warebasket" exact="$autoSelectedWares"/>
        <edit_order_param order="this.ship.defaultorder" param="'warebasket'" value="$autoSelectedWares"/>
      </do_if>

      <do_if value="this.$debuglevel ge 1 and $resolvedWaresDisplay != this.$lastResolvedWaresDisplay">
        <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': resolved wares (' + (if this.$autowares then 'auto' else 'manual') + ') count=' + $resolvedWaresCount + ' [' + $resolvedWaresDisplay + ']'" chance="this.$debugchance"/>
      </do_if>
      <set_value name="this.$lastResolvedWaresDisplay" exact="$resolvedWaresDisplay"/>

      <set_value name="$bestTrade" exact="null"/>
      <set_value name="$bestSourceOffer" exact="null"/>
      <set_value name="$bestDestOffer" exact="null"/>
      <set_value name="$bestSourceOfferAmount" exact="0"/>
      <set_value name="$bestDestOfferAmount" exact="0"/>
      <set_value name="$bestScore" exact="-1"/>
      <create_list name="$mk2TradeList"/>
      <set_value name="$evalPairs" exact="0"/>
      <set_value name="$skipIllegalOrNoCargo" exact="0"/>
      <set_value name="$skipNoSourceOffer" exact="0"/>
      <set_value name="$skipSourceNoTarget" exact="0"/>
      <set_value name="$skipSourceBelowStatic" exact="0"/>
      <set_value name="$skipSelfTarget" exact="0"/>
      <set_value name="$skipDistance" exact="0"/>
      <set_value name="$skipNoDestOffer" exact="0"/>
      <set_value name="$skipNoNeed" exact="0"/>
      <set_value name="$skipMinTrade" exact="0"/>
      <set_value name="$skipReserved" exact="0"/>
      <set_value name="$sourceBelowStaticDetails" exact="''"/>
      <set_value name="$sourceBelowStaticDetailCount" exact="0"/>
      <set_value name="$noSourceOfferDetails" exact="''"/>
      <set_value name="$noSourceOfferDetailCount" exact="0"/>
      <set_value name="$noDestOfferDetails" exact="''"/>
      <set_value name="$noDestOfferDetailCount" exact="0"/>
      <set_value name="$noNeedDetails" exact="''"/>
      <set_value name="$noNeedDetailCount" exact="0"/>

      <do_all exact="this.$activeSources.count" counter="$sidx">
        <set_value name="$source" exact="this.$activeSources.{$sidx}"/>
        <create_list name="$effectiveWares"/>
        <do_if value="not this.$autowares">
          <do_all exact="$manualSourceWares.count" counter="$mwi">
            <append_to_list name="$effectiveWares" exact="$manualSourceWares.{$mwi}"/>
          </do_all>
        </do_if>
        <do_else>
          <set_value name="$sourceProducts" exact="$source.products.list"/>
          <set_value name="$sourceTradewares" exact="$source.tradewares.list"/>
          <create_list name="$sourceSellableWares"/>
          <do_all exact="$sourceProducts.count" counter="$pi">
            <append_to_list name="$sourceSellableWares" exact="$sourceProducts.{$pi}"/>
          </do_all>
          <do_all exact="$sourceTradewares.count" counter="$ti">
            <set_value name="$tw" exact="$sourceTradewares.{$ti}"/>
            <set_value name="$dup" exact="false"/>
            <do_all exact="$sourceSellableWares.count" counter="$dci">
              <do_if value="$sourceSellableWares.{$dci} == $tw">
                <set_value name="$dup" exact="true"/>
                <break/>
              </do_if>
            </do_all>
            <do_if value="not $dup">
              <append_to_list name="$sourceSellableWares" exact="$tw"/>
            </do_if>
          </do_all>
          <do_all exact="$sourceSellableWares.count" counter="$siw">
            <set_value name="$sw" exact="$sourceSellableWares.{$siw}"/>
            <do_all exact="$targetResourceWares.count" counter="$trw">
              <do_if value="$sw == $targetResourceWares.{$trw}">
                <append_to_list name="$effectiveWares" exact="$sw"/>
                <break/>
              </do_if>
            </do_all>
          </do_all>
        </do_else>

        <do_all exact="$effectiveWares.count" counter="$wi">
          <set_value name="$ware" exact="$effectiveWares.{$wi}"/>
          <set_value name="$evalPairs" operation="add"/>
          <do_if value="this.ship.cargo.{$ware}.max le 0 or (not this.$allowillegal and $ware.illegal)">
            <set_value name="$skipIllegalOrNoCargo" operation="add"/>
            <continue/>
          </do_if>
          <do_if value="this.$ignoretraderules and $source.isplayerowned">
            <find_sell_offer seller="$source" wares="$ware" result="$sourceOffer"/>
          </do_if>
          <do_else>
            <find_sell_offer tradepartner="this.ship" seller="$source" wares="$ware" result="$sourceOffer"/>
          </do_else>
          <do_if value="$sourceOffer == null and this.$ignoretraderules and $source.isplayerowned">
            <!-- Fallback: ignore-rules lookup can return null even when a partner-filtered offer exists. -->
            <find_sell_offer tradepartner="this.ship" seller="$source" wares="$ware" result="$sourceOffer"/>
          </do_if>
          <do_if value="$sourceOffer == null">
            <set_value name="$skipNoSourceOffer" operation="add"/>
            <do_if value="this.$debuglevel ge 1 and $noSourceOfferDetailCount lt 10">
              <do_if value="$noSourceOfferDetailCount gt 0">
                <set_value name="$noSourceOfferDetails" exact="$noSourceOfferDetails + '; '"/>
              </do_if>
              <set_value name="$sourceOfferAvailableFlag" exact="'0'"/>
              <set_value name="$sourceOfferAmountText" exact="'n/a'"/>
              <run_script name="'lib.gt.tradematch'" result="$sourceOfferDiagProbe">
                <param name="mode" value="'offerdiag_probe'"/>
                <param name="lineType" value="'source'"/>
                <param name="ship" value="this.ship"/>
                <param name="station" value="$source"/>
                <param name="wareText" value="$ware"/>
                <param name="ignoreTradeRules" value="this.$ignoretraderules"/>
              </run_script>
              <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after source offer diagnostics probe"/>
              <set_value name="$sourceOfferMode" exact="$sourceOfferDiagProbe.$Mode"/>
              <set_value name="$sourceOfferAltAvailableFlag" exact="$sourceOfferDiagProbe.$AltUnavailableFlag"/>
              <set_value name="$sourceOfferAltAmountText" exact="$sourceOfferDiagProbe.$AltAmountText"/>
              <run_script name="'lib.gt.tradematch'" result="$sourceOfferDetailText">
                <param name="mode" value="'offerdiag'"/>
                <param name="lineType" value="'source'"/>
                <param name="station" value="$source"/>
                <param name="wareText" value="$ware"/>
                <param name="isPlayerOwned" value="$source.isplayerowned"/>
                <param name="diagMode" value="$sourceOfferMode"/>
                <param name="unavailableFlag" value="$sourceOfferAvailableFlag"/>
                <param name="amountText" value="$sourceOfferAmountText"/>
                <param name="altUnavailableFlag" value="$sourceOfferAltAvailableFlag"/>
                <param name="altAmountText" value="$sourceOfferAltAmountText"/>
              </run_script>
              <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after source offer diagnostics formatting"/>
              <set_value name="$noSourceOfferDetails" exact="$noSourceOfferDetails + $sourceOfferDetailText"/>
              <set_value name="$noSourceOfferDetailCount" operation="add"/>
            </do_if>
            <continue/>
          </do_if>
          <set_value name="$sourceOfferAmount" exact="$sourceOffer.offeramount.{this.ship}"/>
          <do_if value="($sourceOfferAmount == null or $sourceOfferAmount le 0) and this.$ignoretraderules and $source.isplayerowned">
            <!-- Internal player-owned flow: derive transferable amount if offeramount is unresolved/zero. -->
            <set_value name="$sourceOfferAmount" exact="[$source.cargo.{$ware}.count, this.ship.cargo.{$ware}.max].min"/>
          </do_if>
          <do_if value="$sourceOfferAmount == null">
            <set_value name="$sourceOfferAmount" exact="0"/>
          </do_if>
          <do_if value="not $sourceOffer.available or $sourceOfferAmount le 0">
            <set_value name="$skipNoSourceOffer" operation="add"/>
            <do_if value="this.$debuglevel ge 1 and $noSourceOfferDetailCount lt 10">
              <do_if value="$noSourceOfferDetailCount gt 0">
                <set_value name="$noSourceOfferDetails" exact="$noSourceOfferDetails + '; '"/>
              </do_if>
              <set_value name="$sourceOfferAvailableFlag" exact="'1'"/>
              <set_value name="$sourceOfferAmountText" exact="'n/a'"/>
              <do_if value="not $sourceOffer.available">
                <set_value name="$sourceOfferAvailableFlag" exact="'0'"/>
              </do_if>
              <set_value name="$sourceOfferAmountText" exact="$sourceOfferAmount"/>
              <run_script name="'lib.gt.tradematch'" result="$sourceOfferDiagProbe">
                <param name="mode" value="'offerdiag_probe'"/>
                <param name="lineType" value="'source'"/>
                <param name="ship" value="this.ship"/>
                <param name="station" value="$source"/>
                <param name="wareText" value="$ware"/>
                <param name="ignoreTradeRules" value="this.$ignoretraderules"/>
              </run_script>
              <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after source offer diagnostics probe"/>
              <set_value name="$sourceOfferMode" exact="$sourceOfferDiagProbe.$Mode"/>
              <set_value name="$sourceOfferAltAvailableFlag" exact="$sourceOfferDiagProbe.$AltUnavailableFlag"/>
              <set_value name="$sourceOfferAltAmountText" exact="$sourceOfferDiagProbe.$AltAmountText"/>
              <run_script name="'lib.gt.tradematch'" result="$sourceOfferDetailText">
                <param name="mode" value="'offerdiag'"/>
                <param name="lineType" value="'source'"/>
                <param name="station" value="$source"/>
                <param name="wareText" value="$ware"/>
                <param name="isPlayerOwned" value="$source.isplayerowned"/>
                <param name="diagMode" value="$sourceOfferMode"/>
                <param name="unavailableFlag" value="$sourceOfferAvailableFlag"/>
                <param name="amountText" value="$sourceOfferAmountText"/>
                <param name="altUnavailableFlag" value="$sourceOfferAltAvailableFlag"/>
                <param name="altAmountText" value="$sourceOfferAltAmountText"/>
              </run_script>
              <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after source offer diagnostics formatting"/>
              <set_value name="$noSourceOfferDetails" exact="$noSourceOfferDetails + $sourceOfferDetailText"/>
              <set_value name="$noSourceOfferDetailCount" operation="add"/>
            </do_if>
            <continue/>
          </do_if>

          <set_value name="$sourceTarget" exact="$source.cargo.{$ware}.target"/>
          <do_if value="$sourceTarget le 0">
            <set_value name="$skipSourceNoTarget" operation="add"/>
            <continue/>
          </do_if>
          <set_value name="$sourceRatio" exact="($source.cargo.{$ware}.count * 100) / $sourceTarget"/>
          <do_if value="$sourceRatio le this.$staticStorage">
            <set_value name="$skipSourceBelowStatic" operation="add"/>
            <do_if value="this.$debuglevel ge 1 and $sourceBelowStaticDetailCount lt 8">
              <do_if value="$sourceBelowStaticDetailCount gt 0">
                <set_value name="$sourceBelowStaticDetails" exact="$sourceBelowStaticDetails + '; '"/>
              </do_if>
              <set_value name="$sourceBelowStaticDetails" exact="$sourceBelowStaticDetails + $source.knownname + ' [' + $source.idcode + ']:' + $ware + '=' + $sourceRatio + '% LE ' + this.$staticStorage + '%'"/>
              <set_value name="$sourceBelowStaticDetailCount" operation="add"/>
            </do_if>
            <continue/>
          </do_if>

          <create_list name="$candidateBuyOffers"/>
          <do_all exact="this.$activeDestinations.count" counter="$di">
            <set_value name="$dest" exact="this.$activeDestinations.{$di}"/>
            <do_if value="$dest == $source">
              <set_value name="$skipSelfTarget" operation="add"/>
              <continue/>
            </do_if>
            <do_if value="this.$maxDistance gt 0">
              <set_value name="$dist" exact="$source.gatedistance.{$dest}"/>
              <do_if value="$dist lt 0 or $dist gt this.$maxDistance">
                <set_value name="$skipDistance" operation="add"/>
                <continue/>
              </do_if>
            </do_if>

            <do_if value="this.$ignoretraderules and $dest.isplayerowned">
              <find_buy_offer buyer="$dest" wares="$ware" result="$destOffer"/>
            </do_if>
            <do_else>
              <find_buy_offer tradepartner="this.ship" buyer="$dest" wares="$ware" result="$destOffer"/>
            </do_else>
            <do_if value="$destOffer == null and this.$ignoretraderules and $dest.isplayerowned">
              <!-- Fallback: ignore-rules lookup can return null while partner-filtered returns a usable offer object. -->
              <find_buy_offer tradepartner="this.ship" buyer="$dest" wares="$ware" result="$destOffer"/>
            </do_if>
            <do_if value="$destOffer == null">
              <set_value name="$skipNoDestOffer" operation="add"/>
              <do_if value="this.$debuglevel ge 1 and $noDestOfferDetailCount lt 12">
                <do_if value="$noDestOfferDetailCount gt 0">
                  <set_value name="$noDestOfferDetails" exact="$noDestOfferDetails + '; '"/>
                </do_if>
                <set_value name="$destTargetPeek" exact="[$dest.cargo.{$ware}.target, 1].max"/>
                <set_value name="$destRatioPeek" exact="($dest.cargo.{$ware}.count * 100) / $destTargetPeek"/>
                <set_value name="$destOfferAvailableFlag" exact="'0'"/>
                <set_value name="$destOfferAmountText" exact="'n/a'"/>
                <run_script name="'lib.gt.tradematch'" result="$destOfferDiagProbe">
                  <param name="mode" value="'offerdiag_probe'"/>
                  <param name="lineType" value="'dest'"/>
                  <param name="ship" value="this.ship"/>
                  <param name="station" value="$dest"/>
                  <param name="wareText" value="$ware"/>
                  <param name="ignoreTradeRules" value="this.$ignoretraderules"/>
                </run_script>
                <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after destination offer diagnostics probe"/>
                <set_value name="$destOfferMode" exact="$destOfferDiagProbe.$Mode"/>
                <set_value name="$destOfferAltAvailableFlag" exact="$destOfferDiagProbe.$AltUnavailableFlag"/>
                <set_value name="$destOfferAltAmountText" exact="$destOfferDiagProbe.$AltAmountText"/>
                <run_script name="'lib.gt.tradematch'" result="$destOfferDetailText">
                  <param name="mode" value="'offerdiag'"/>
                  <param name="lineType" value="'dest'"/>
                  <param name="sourceStation" value="$source"/>
                  <param name="station" value="$dest"/>
                  <param name="wareText" value="$ware"/>
                  <param name="isPlayerOwned" value="$dest.isplayerowned"/>
                  <param name="diagMode" value="$destOfferMode"/>
                  <param name="unavailableFlag" value="$destOfferAvailableFlag"/>
                  <param name="amountText" value="$destOfferAmountText"/>
                  <param name="altUnavailableFlag" value="$destOfferAltAvailableFlag"/>
                  <param name="altAmountText" value="$destOfferAltAmountText"/>
                  <param name="cargoCount" value="$dest.cargo.{$ware}.count"/>
                  <param name="cargoTarget" value="$destTargetPeek"/>
                  <param name="cargoRatio" value="$destRatioPeek"/>
                </run_script>
                <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after destination offer diagnostics formatting"/>
                <set_value name="$noDestOfferDetails" exact="$noDestOfferDetails + $destOfferDetailText"/>
                <set_value name="$noDestOfferDetailCount" operation="add"/>
              </do_if>
              <continue/>
            </do_if>
            <set_value name="$destOfferAmount" exact="$destOffer.offeramount.{this.ship}"/>
            <do_if value="($destOfferAmount == null or $destOfferAmount le 0) and this.$ignoretraderules and $dest.isplayerowned">
              <!-- Internal player-owned flow: derive demand from target-count gap when offeramount is unresolved/zero. -->
              <set_value name="$destOfferAmount" exact="[0, $dest.cargo.{$ware}.target - $dest.cargo.{$ware}.count].max"/>
            </do_if>
            <do_if value="$destOfferAmount == null">
              <set_value name="$destOfferAmount" exact="0"/>
            </do_if>
            <do_if value="not $destOffer.available or $destOfferAmount le 0">
              <set_value name="$skipNoDestOffer" operation="add"/>
              <do_if value="this.$debuglevel ge 1 and $noDestOfferDetailCount lt 12">
                <do_if value="$noDestOfferDetailCount gt 0">
                  <set_value name="$noDestOfferDetails" exact="$noDestOfferDetails + '; '"/>
                </do_if>
                <set_value name="$destTargetPeek" exact="[$dest.cargo.{$ware}.target, 1].max"/>
                <set_value name="$destRatioPeek" exact="($dest.cargo.{$ware}.count * 100) / $destTargetPeek"/>
                <set_value name="$destOfferAvailableFlag" exact="'1'"/>
                <set_value name="$destOfferAmountText" exact="'n/a'"/>
                <do_if value="not $destOffer.available">
                  <set_value name="$destOfferAvailableFlag" exact="'0'"/>
                </do_if>
                <set_value name="$destOfferAmountText" exact="$destOfferAmount"/>
                <run_script name="'lib.gt.tradematch'" result="$destOfferDiagProbe">
                  <param name="mode" value="'offerdiag_probe'"/>
                  <param name="lineType" value="'dest'"/>
                  <param name="ship" value="this.ship"/>
                  <param name="station" value="$dest"/>
                  <param name="wareText" value="$ware"/>
                  <param name="ignoreTradeRules" value="this.$ignoretraderules"/>
                </run_script>
                <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after destination offer diagnostics probe"/>
                <set_value name="$destOfferMode" exact="$destOfferDiagProbe.$Mode"/>
                <set_value name="$destOfferAltAvailableFlag" exact="$destOfferDiagProbe.$AltUnavailableFlag"/>
                <set_value name="$destOfferAltAmountText" exact="$destOfferDiagProbe.$AltAmountText"/>
                <run_script name="'lib.gt.tradematch'" result="$destOfferDetailText">
                  <param name="mode" value="'offerdiag'"/>
                  <param name="lineType" value="'dest'"/>
                  <param name="sourceStation" value="$source"/>
                  <param name="station" value="$dest"/>
                  <param name="wareText" value="$ware"/>
                  <param name="isPlayerOwned" value="$dest.isplayerowned"/>
                  <param name="diagMode" value="$destOfferMode"/>
                  <param name="unavailableFlag" value="$destOfferAvailableFlag"/>
                  <param name="amountText" value="$destOfferAmountText"/>
                  <param name="altUnavailableFlag" value="$destOfferAltAvailableFlag"/>
                  <param name="altAmountText" value="$destOfferAltAmountText"/>
                  <param name="cargoCount" value="$dest.cargo.{$ware}.count"/>
                  <param name="cargoTarget" value="$destTargetPeek"/>
                  <param name="cargoRatio" value="$destRatioPeek"/>
                </run_script>
                <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after destination offer diagnostics formatting"/>
                <set_value name="$noDestOfferDetails" exact="$noDestOfferDetails + $destOfferDetailText"/>
                <set_value name="$noDestOfferDetailCount" operation="add"/>
              </do_if>
              <continue/>
            </do_if>
            <append_to_list name="$candidateBuyOffers" exact="$destOffer"/>
          </do_all>

          <do_if value="$candidateBuyOffers.count == 0">
            <continue/>
          </do_if>

          <create_list name="$candidateSellOffers"/>
          <append_to_list name="$candidateSellOffers" exact="$sourceOffer"/>
          <run_script name="'lib.gt.tradematch'" result="$mk2MatchResult">
            <param name="ship" value="this.ship"/>
            <param name="sellOffers" value="$candidateSellOffers"/>
            <param name="buyOffers" value="$candidateBuyOffers"/>
            <param name="homeSector" value="$source.sector"/>
            <param name="maxDistance" value="this.$maxDistance"/>
            <param name="scoreMode" value="'supply'"/>
            <param name="distancePenalty" value="0"/>
            <param name="maxTradesPerWare" value="100"/>
            <param name="debugchance" value="0"/>
          </run_script>
          <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after shared tradematch call"/>

          <do_if value="$mk2MatchResult.$Found and $mk2MatchResult.$TradeList? and $mk2MatchResult.$TradeList.count gt 0">
            <set_value name="$mk2AvailableTradeWaresCount" exact="1"/>
            <run_script name="'lib.gt.tradematch'" result="$mk2DistinctWaresResult">
              <param name="mode" value="'count_distinct_wares'"/>
              <param name="tradeListInput" value="$mk2MatchResult.$TradeList"/>
            </run_script>
            <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after distinct-ware helper call"/>
            <do_if value="$mk2DistinctWaresResult.$DistinctCount? and $mk2DistinctWaresResult.$DistinctCount gt 0">
              <set_value name="$mk2AvailableTradeWaresCount" exact="$mk2DistinctWaresResult.$DistinctCount"/>
            </do_if>
            <do_if value="$mk2AvailableTradeWaresCount le 0">
              <set_value name="$mk2AvailableTradeWaresCount" exact="1"/>
            </do_if>
            <do_all exact="$mk2MatchResult.$TradeList.count" counter="$mti">
              <set_value name="$matchedTrade" exact="$mk2MatchResult.$TradeList.{$mti}"/>
              <set_value name="$destOffer" exact="$matchedTrade.$SellOffer"/>
              <set_value name="$dest" exact="$destOffer.owner"/>
              <set_value name="$destOfferAmount" exact="if $matchedTrade.$SellOfferAmount? then $matchedTrade.$SellOfferAmount else $destOffer.offeramount.{this.ship}"/>
              <do_if value="$destOfferAmount == null">
                <set_value name="$destOfferAmount" exact="0"/>
              </do_if>

              <set_value name="$destTarget" exact="[$dest.cargo.{$ware}.target, 1].max"/>
              <set_value name="$destRatio" exact="($dest.cargo.{$ware}.count * 100) / $destTarget"/>

              <set_value name="$urgent" exact="false"/>
              <set_value name="$shouldDistribute" exact="false"/>
              <do_if value="$destRatio le this.$minStorage">
                <set_value name="$urgent" exact="true"/>
                <set_value name="$shouldDistribute" exact="true"/>
              </do_if>
              <do_elseif value="$sourceRatio gt this.$maxStorage and $sourceRatio gt ($destRatio + 10)">
                <set_value name="$shouldDistribute" exact="true"/>
              </do_elseif>
              <do_if value="not $shouldDistribute">
                <set_value name="$skipNoNeed" operation="add"/>
                <do_if value="this.$debuglevel ge 1 and $noNeedDetailCount lt 10">
                  <do_if value="$noNeedDetailCount gt 0">
                    <set_value name="$noNeedDetails" exact="$noNeedDetails + '; '"/>
                  </do_if>
                  <set_value name="$noNeedDetails" exact="$noNeedDetails + $source.idcode + '->' + $dest.idcode + ':' + $ware + ' src=' + $sourceRatio + '% dst=' + $destRatio + '% thresholds(min=' + this.$minStorage + ',max=' + this.$maxStorage + ')'"/>
                  <set_value name="$noNeedDetailCount" operation="add"/>
                </do_if>
                <continue/>
              </do_if>

              <set_value name="$cargoCapacity" exact="this.ship.cargo.{$ware}.max"/>
              <set_value name="$incomingReservedAmount" exact="0"/>
              <set_value name="$reservedShipCount" exact="0"/>
              <set_value name="$alreadyReservedByThisShip" exact="false"/>
              <set_value name="$effectiveDestOfferAmount" exact="$destOfferAmount"/>
              <do_if value="this.$fleetcoordination">
                <do_if value="not global.$GT_MK2_TradeReservations?">
                  <set_value name="global.$GT_MK2_TradeReservations" exact="table[]"/>
                </do_if>
                <do_if value="not global.$GT_MK2_TradeReservationAmounts?">
                  <set_value name="global.$GT_MK2_TradeReservationAmounts" exact="table[]"/>
                </do_if>
                <do_if value="not global.$GT_MK2_TradeReservations.{$dest}?">
                  <set_value name="$emptyMK2DestReservationTable" exact="table[]"/>
                  <set_value name="global.$GT_MK2_TradeReservations.{$dest}" exact="$emptyMK2DestReservationTable"/>
                </do_if>
                <do_if value="not global.$GT_MK2_TradeReservations.{$dest}.{$ware}?">
                  <create_list name="$emptyMK2TradeReservationList"/>
                  <set_value name="global.$GT_MK2_TradeReservations.{$dest}.{$ware}" exact="$emptyMK2TradeReservationList"/>
                </do_if>
                <do_if value="not global.$GT_MK2_TradeReservationAmounts.{$dest}?">
                  <set_value name="$emptyMK2DestReservationAmountTable" exact="table[]"/>
                  <set_value name="global.$GT_MK2_TradeReservationAmounts.{$dest}" exact="$emptyMK2DestReservationAmountTable"/>
                </do_if>
                <do_if value="not global.$GT_MK2_TradeReservationAmounts.{$dest}.{$ware}?">
                  <set_value name="$emptyMK2TradeReservationAmountTable" exact="table[]"/>
                  <set_value name="global.$GT_MK2_TradeReservationAmounts.{$dest}.{$ware}" exact="$emptyMK2TradeReservationAmountTable"/>
                </do_if>
                <!-- Prune stale entries and compute in-flight incoming amount for this destination ware. -->
                <create_list name="$prunedMK2Reservations"/>
                <do_if value="global.$GT_MK2_TradeReservations.{$dest}.{$ware}.count gt 0">
                  <do_all exact="global.$GT_MK2_TradeReservations.{$dest}.{$ware}.count" counter="$mk2ri">
                    <set_value name="$rsvShip" exact="global.$GT_MK2_TradeReservations.{$dest}.{$ware}.{$mk2ri}"/>
                    <do_if value="$rsvShip? and $rsvShip.exists">
                      <append_to_list name="$prunedMK2Reservations" exact="$rsvShip"/>
                      <set_value name="$reservedShipCount" operation="add"/>
                      <do_if value="$rsvShip == this.ship">
                        <set_value name="$alreadyReservedByThisShip" exact="true"/>
                      </do_if>
                      <do_else>
                        <do_if value="global.$GT_MK2_TradeReservationAmounts.{$dest}.{$ware}.{$rsvShip}?">
                          <set_value name="$incomingReservedAmount" exact="$incomingReservedAmount + global.$GT_MK2_TradeReservationAmounts.{$dest}.{$ware}.{$rsvShip}"/>
                        </do_if>
                      </do_else>
                    </do_if>
                  </do_all>
                  <set_value name="global.$GT_MK2_TradeReservations.{$dest}.{$ware}" exact="$prunedMK2Reservations"/>
                </do_if>
              </do_if>
              <set_value name="$shipChunkAmount" exact="[1, (($cargoCapacity * this.$minCargoFillPercent) / 100)i].max"/>
              <run_script name="'lib.gt.tradematch'" result="$mk2FairnessResult">
                <param name="mode" value="'ware_fairness'"/>
                <param name="rawNeedAmount" value="$destOfferAmount"/>
                <param name="incomingReservedAmount" value="$incomingReservedAmount"/>
                <param name="shipChunkAmount" value="$shipChunkAmount"/>
                <param name="availableTradeWaresCount" value="$mk2AvailableTradeWaresCount"/>
                <param name="reservedCount" value="$reservedShipCount"/>
                <param name="alreadyReservedByThisShip" value="$alreadyReservedByThisShip"/>
                <param name="fairnessCap" value="2"/>
              </run_script>
              <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after fairness helper call"/>
              <set_value name="$effectiveDestOfferAmount" exact="$mk2FairnessResult.$EffectiveNeedAmount"/>
              <set_value name="$maxShipsForWare" exact="$mk2FairnessResult.$MaxShipsForWare"/>
              <set_value name="$reservationAllowsTrade" exact="$mk2FairnessResult.$ReservationAllowsTrade"/>
              <do_if value="$effectiveDestOfferAmount le 0">
                <set_value name="$skipReserved" operation="add"/>
                <continue/>
              </do_if>
              <do_if value="this.$fleetcoordination and not $reservationAllowsTrade">
                <set_value name="$skipReserved" operation="add"/>
                <continue/>
              </do_if>

              <set_value name="$tradeAmount" exact="[this.ship.cargo.{$ware}.free, $sourceOfferAmount, $effectiveDestOfferAmount].min"/>
              <set_value name="$minimumTrade" exact="[1, (($cargoCapacity * this.$minCargoFillPercent) / 100)i].max"/>
              <do_if value="$tradeAmount lt $minimumTrade">
                <set_value name="$skipMinTrade" operation="add"/>
                <continue/>
              </do_if>

              <set_value name="$sourceUsage" exact="0"/>
              <set_value name="$destUsage" exact="0"/>
              <do_if value="this.$sourceUsage? and this.$sourceUsage.{$source}?">
                <set_value name="$sourceUsage" exact="this.$sourceUsage.{$source}"/>
              </do_if>
              <do_if value="this.$destUsage? and this.$destUsage.{$dest}?">
                <set_value name="$destUsage" exact="this.$destUsage.{$dest}"/>
              </do_if>
              <set_value name="$urgencyMultiplier" exact="if $urgent then 2 else 1"/>
              <set_value name="$balanceFactor" exact="[0, ($sourceRatio - $destRatio)].max / 100"/>
              <set_value name="$score" exact="(($sourceRatio - this.$staticStorage) * $urgencyMultiplier * ($tradeAmount / [$cargoCapacity, 1].max)) + $balanceFactor - (($sourceUsage + $destUsage) * 0.2)"/>
              <append_to_list name="$mk2TradeList" exact="table[
                $Ware = $ware,
                $Source = $source,
                $Destination = $dest,
                $Amount = $tradeAmount,
                $Urgent = $urgent,
                $Score = $score,
                $SourceOffer = $sourceOffer,
                $DestOffer = $destOffer,
                $SourceOfferAmount = $sourceOfferAmount,
                $DestOfferAmount = $destOfferAmount,
                $EffectiveDestOfferAmount = $effectiveDestOfferAmount,
                $IncomingReservedAmount = $incomingReservedAmount
              ]"/>
            </do_all>
          </do_if>
        </do_all>
      </do_all>

      <!-- Shared ranking: use the common scorer to pick the best MK2 candidate by precomputed $Score. -->
      <run_script name="'lib.gt.score.trades'" result="$mk2ScoreResult">
        <param name="tradeList" value="$mk2TradeList"/>
        <param name="debugchance" value="this.$debugchance"/>
      </run_script>
      <do_if value="$mk2ScoreResult.$Found and $mk2ScoreResult.$BestTrade?">
        <set_value name="$bestTrade" exact="$mk2ScoreResult.$BestTrade"/>
        <set_value name="$bestScore" exact="$mk2ScoreResult.$BestScore"/>
        <set_value name="$bestSourceOffer" exact="$bestTrade.$SourceOffer"/>
        <set_value name="$bestDestOffer" exact="$bestTrade.$DestOffer"/>
        <set_value name="$bestSourceOfferAmount" exact="$bestTrade.$SourceOfferAmount"/>
        <set_value name="$bestDestOfferAmount" exact="if $bestTrade.$EffectiveDestOfferAmount? then $bestTrade.$EffectiveDestOfferAmount else $bestTrade.$DestOfferAmount"/>
      </do_if>

      <do_if value="$bestTrade == null">
        <do_if value="this.$debuglevel ge 1">
          <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': no trade selected. src=' + this.$activeSources.count + ', dst=' + this.$activeDestinations.count + ', eval=' + $evalPairs + ', skips: illegal/cargo=' + $skipIllegalOrNoCargo + ', noSrcOffer=' + $skipNoSourceOffer + ', srcNoTarget=' + $skipSourceNoTarget + ', srcBelowStatic=' + $skipSourceBelowStatic + ', self=' + $skipSelfTarget + ', distance=' + $skipDistance + ', noDstOffer=' + $skipNoDestOffer + ', noNeed=' + $skipNoNeed + ', minTrade=' + $skipMinTrade + ', reserved=' + $skipReserved" chance="this.$debugchance"/>
          <do_if value="$noSourceOfferDetailCount gt 0">
            <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': noSrcOffer details: ' + $noSourceOfferDetails" chance="this.$debugchance"/>
          </do_if>
          <do_if value="$noDestOfferDetailCount gt 0">
            <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': noDstOffer details: ' + $noDestOfferDetails" chance="this.$debugchance"/>
          </do_if>
          <do_if value="$sourceBelowStaticDetailCount gt 0">
            <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': srcBelowStatic details: ' + $sourceBelowStaticDetails" chance="this.$debugchance"/>
          </do_if>
          <do_if value="$noNeedDetailCount gt 0">
            <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': noNeed details: ' + $noNeedDetails" chance="this.$debugchance"/>
          </do_if>
        </do_if>
        <do_if value="this.$notifications ge 2">
          <show_notification text="'MK2 ' + this.ship.knownname + ': ' + {77000, 20202}" timeout="5s"/>
        </do_if>
        <resume label="no_trade_retry"/>
      </do_if>

      <set_value name="$denyTrade" exact="false"/>
      <set_value name="$pilotLevel" exact="1"/>
      <do_if value="this.ship.pilot? and global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$Level?">
        <set_value name="$pilotLevel" exact="global.$GT_Pilots.{this.ship.pilot}.$Level"/>
      </do_if>
      <do_if value="$pilotLevel ge 12 and global.$GT_ThreatIntelligence? and global.$GT_ThreatIntelligence.$BlacklistedSectors?">
        <do_all exact="global.$GT_ThreatIntelligence.$BlacklistedSectors.count" counter="$bli">
          <do_if value="global.$GT_ThreatIntelligence.$BlacklistedSectors.{$bli} == $bestTrade.$Destination.sector">
            <set_value name="$denyTrade" exact="true"/>
            <do_if value="this.$debuglevel ge 1">
              <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': trade denied by threat intelligence for destination sector ' + $bestTrade.$Destination.sector.knownname" chance="this.$debugchance"/>
            </do_if>
            <break/>
          </do_if>
        </do_all>
      </do_if>

      <do_if value="not $denyTrade">
        <set_value name="$tradeOrderInternal" exact="$bestTrade.$Source.isplayerowned and $bestTrade.$Destination.isplayerowned"/>
        <do_if value="this.$debuglevel ge 1">
          <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': selected trade ' + $bestTrade.$Ware + ' from ' + $bestTrade.$Source.knownname + ' to ' + $bestTrade.$Destination.knownname + ' amount=' + $bestTrade.$Amount + ' score=' + $bestScore + ' incomingReserved=' + (if $bestTrade.$IncomingReservedAmount? then $bestTrade.$IncomingReservedAmount else 0) + ' effectiveNeed=' + $bestDestOfferAmount + ' internal=' + $tradeOrderInternal + ' ignoreRules=' + this.$ignoretraderules" chance="this.$debugchance"/>
        </do_if>
        <set_value name="this.$lastTradeReservedAmount" exact="0"/>
        <set_value name="this.$lastTradeDestination" exact="null"/>
        <set_value name="this.$lastTradeWare" exact="null"/>
        <do_if value="this.$fleetcoordination">
          <set_value name="this.$lastTradeDestination" exact="$bestTrade.$Destination"/>
          <set_value name="this.$lastTradeWare" exact="$bestTrade.$Ware"/>
          <do_if value="not global.$GT_MK2_TradeReservations?">
            <set_value name="global.$GT_MK2_TradeReservations" exact="table[]"/>
          </do_if>
          <do_if value="not global.$GT_MK2_TradeReservationAmounts?">
            <set_value name="global.$GT_MK2_TradeReservationAmounts" exact="table[]"/>
          </do_if>
          <do_if value="not global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}?">
            <set_value name="$emptyMK2LastTradeDestReservationTable" exact="table[]"/>
            <set_value name="global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}" exact="$emptyMK2LastTradeDestReservationTable"/>
          </do_if>
          <do_if value="not global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}?">
            <create_list name="$emptyMK2LastTradeReservationList"/>
            <set_value name="global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}" exact="$emptyMK2LastTradeReservationList"/>
          </do_if>
          <do_if value="not global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}?">
            <set_value name="$emptyMK2LastTradeDestReservationAmountTable" exact="table[]"/>
            <set_value name="global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}" exact="$emptyMK2LastTradeDestReservationAmountTable"/>
          </do_if>
          <do_if value="not global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}.{this.$lastTradeWare}?">
            <set_value name="$emptyMK2LastTradeReservationAmountTable" exact="table[]"/>
            <set_value name="global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}.{this.$lastTradeWare}" exact="$emptyMK2LastTradeReservationAmountTable"/>
          </do_if>
          <set_value name="$mk2HasReservationEntry" exact="false"/>
          <do_if value="global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}.count gt 0">
            <do_all exact="global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}.count" counter="$mkrsi">
              <do_if value="global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}.{$mkrsi} == this.ship">
                <set_value name="$mk2HasReservationEntry" exact="true"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>
          <do_if value="not $mk2HasReservationEntry">
            <append_to_list name="global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}" exact="this.ship"/>
          </do_if>
          <!-- Provisional amount until buy phase clamps are known. -->
          <set_value name="global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}.{this.$lastTradeWare}.{this.ship}" exact="$bestTrade.$Amount"/>
        </do_if>

        <set_command_action commandaction="commandaction.flying"/>
        <set_value name="$buyAmount" exact="[$bestTrade.$Amount, $bestSourceOfferAmount].min"/>
        <do_if value="$buyAmount gt 0">
          <do_if value="this.$fleetcoordination and this.$lastTradeDestination? and this.$lastTradeWare? and global.$GT_MK2_TradeReservationAmounts?">
            <do_if value="not global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}?">
              <set_value name="$emptyMK2ActiveTradeDestReservationAmountTable" exact="table[]"/>
              <set_value name="global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}" exact="$emptyMK2ActiveTradeDestReservationAmountTable"/>
            </do_if>
            <do_if value="not global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}.{this.$lastTradeWare}?">
              <set_value name="$emptyMK2ActiveTradeReservationAmountTable" exact="table[]"/>
              <set_value name="global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}.{this.$lastTradeWare}" exact="$emptyMK2ActiveTradeReservationAmountTable"/>
            </do_if>
            <set_value name="global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}.{this.$lastTradeWare}.{this.ship}" exact="$buyAmount"/>
            <set_value name="this.$lastTradeReservedAmount" exact="$buyAmount"/>
          </do_if>
          <create_trade_order object="this.ship" tradeoffer="$bestSourceOffer" amount="$buyAmount" immediate="true" internal="$tradeOrderInternal"/>
        </do_if>
        <do_while value="this.ship.orders.count gt 0">
          <wait exact="5s">
            <interrupt>
              <conditions>
                <event_object_order_ready object="this.ship"/>
              </conditions>
            </interrupt>
          </wait>
        </do_while>

        <set_value name="$sellAmount" exact="[this.ship.cargo.{$bestTrade.$Ware}.count, $bestTrade.$Amount, $bestDestOfferAmount].min"/>
        <do_if value="$sellAmount gt 0">
          <create_trade_order object="this.ship" tradeoffer="$bestDestOffer" amount="$sellAmount" immediate="true" internal="$tradeOrderInternal"/>
        </do_if>
        <do_while value="this.ship.orders.count gt 0">
          <wait exact="5s">
            <interrupt>
              <conditions>
                <event_object_order_ready object="this.ship"/>
              </conditions>
            </interrupt>
          </wait>
        </do_while>

        <do_if value="this.$fleetcoordination and this.$lastTradeDestination? and this.$lastTradeWare? and global.$GT_MK2_TradeReservations? and global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}? and global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}?">
          <create_list name="$mk2ReservationsAfterRelease"/>
          <do_all exact="global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}.count" counter="$mk2rri">
            <set_value name="$mk2RShip" exact="global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}.{$mk2rri}"/>
            <do_if value="$mk2RShip? and $mk2RShip.exists and $mk2RShip != this.ship">
              <append_to_list name="$mk2ReservationsAfterRelease" exact="$mk2RShip"/>
            </do_if>
          </do_all>
          <set_value name="global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}" exact="$mk2ReservationsAfterRelease"/>
          <do_if value="$mk2ReservationsAfterRelease.count == 0">
            <remove_value name="global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}"/>
          </do_if>
          <do_if value="global.$GT_MK2_TradeReservationAmounts? and global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}? and global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}.{this.$lastTradeWare}?">
            <remove_value name="global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}.{this.$lastTradeWare}.{this.ship}"/>
            <do_if value="$mk2ReservationsAfterRelease.count == 0">
              <remove_value name="global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}.{this.$lastTradeWare}"/>
            </do_if>
          </do_if>
          <set_value name="this.$lastTradeDestination" exact="null"/>
          <set_value name="this.$lastTradeWare" exact="null"/>
          <set_value name="this.$lastTradeReservedAmount" exact="0"/>
        </do_if>
        <!-- Successful trade cycle: reset no-trade backoff. -->
        <set_value name="this.$noTradeRetryCount" exact="0"/>
        <set_value name="this.$sourceUsage.{$bestTrade.$Source}" exact="if this.$sourceUsage? and this.$sourceUsage.{$bestTrade.$Source}? then this.$sourceUsage.{$bestTrade.$Source} + 1 else 1"/>
        <set_value name="this.$destUsage.{$bestTrade.$Destination}" exact="if this.$destUsage? and this.$destUsage.{$bestTrade.$Destination}? then this.$destUsage.{$bestTrade.$Destination} + 1 else 1"/>

        <signal_objects object="player.galaxy" param="'GT_WriteLogbook'" param2="table[
          $Message = {77000, 20200}.[$sellAmount, $bestTrade.$Ware.name, $bestTrade.$Source.knownname, $bestTrade.$Destination.knownname],
          $Category = 'upkeep',
          $Title = 'MK2 Distribution',
          $Object = this.ship,
          $CheckGlobalSettings = false
        ]"/>

        <do_if value="this.ship.pilot">
          <signal_objects object="player.galaxy" param="'GT_Update_Pilot_XP'" param2="table[
            $Ship = this.ship,
            $Pilot = this.ship.pilot
          ]"/>
        </do_if>

        <do_if value="this.$bidirectional">
          <set_value name="$returnInternal" exact="$bestTrade.$Source.isplayerowned and $bestTrade.$Destination.isplayerowned"/>
          <do_if value="this.$ignoretraderules and $bestTrade.$Destination.isplayerowned">
            <find_sell_offer seller="$bestTrade.$Destination" wares="$bestTrade.$Ware" result="$returnSell"/>
          </do_if>
          <do_else>
            <find_sell_offer tradepartner="this.ship" seller="$bestTrade.$Destination" wares="$bestTrade.$Ware" result="$returnSell"/>
          </do_else>
          <do_if value="this.$ignoretraderules and $bestTrade.$Source.isplayerowned">
            <find_buy_offer buyer="$bestTrade.$Source" wares="$bestTrade.$Ware" result="$returnBuy"/>
          </do_if>
          <do_else>
            <find_buy_offer tradepartner="this.ship" buyer="$bestTrade.$Source" wares="$bestTrade.$Ware" result="$returnBuy"/>
          </do_else>
          <set_value name="$returnSellAmount" exact="$returnSell.offeramount.{this.ship}"/>
          <set_value name="$returnBuyAmount" exact="$returnBuy.offeramount.{this.ship}"/>
          <do_if value="$returnSellAmount == null">
            <set_value name="$returnSellAmount" exact="0"/>
          </do_if>
          <do_if value="$returnBuyAmount == null">
            <set_value name="$returnBuyAmount" exact="0"/>
          </do_if>
          <do_if value="$returnSell.available and $returnSellAmount gt 0 and $returnBuy.available and $returnBuyAmount gt 0">
            <set_value name="$returnSourceTarget" exact="[$bestTrade.$Destination.cargo.{$bestTrade.$Ware}.target, 1].max"/>
            <set_value name="$returnDestTarget" exact="[$bestTrade.$Source.cargo.{$bestTrade.$Ware}.target, 1].max"/>
            <set_value name="$returnSourceRatio" exact="($bestTrade.$Destination.cargo.{$bestTrade.$Ware}.count * 100) / $returnSourceTarget"/>
            <set_value name="$returnDestRatio" exact="($bestTrade.$Source.cargo.{$bestTrade.$Ware}.count * 100) / $returnDestTarget"/>
            <set_value name="$doReturn" exact="false"/>
            <do_if value="$returnDestRatio le this.$minStorage">
              <set_value name="$doReturn" exact="true"/>
            </do_if>
            <do_elseif value="$returnSourceRatio gt this.$maxStorage and $returnSourceRatio gt ($returnDestRatio + 10)">
              <set_value name="$doReturn" exact="true"/>
            </do_elseif>
            <do_if value="$doReturn">
              <set_value name="$returnAmount" exact="[this.ship.cargo.{$bestTrade.$Ware}.free, $returnSellAmount, $returnBuyAmount].min"/>
                          <set_value name="$returnMinAmount" exact="[1, ((this.ship.cargo.{$bestTrade.$Ware}.max * this.$minCargoFillPercent) / 100)i].max"/>
              <do_if value="$returnAmount ge $returnMinAmount">
                <create_trade_order object="this.ship" tradeoffer="$returnSell" amount="$returnAmount" immediate="true" internal="$returnInternal"/>
                <do_while value="this.ship.orders.count gt 0">
                  <wait exact="5s">
                    <interrupt>
                      <conditions>
                        <event_object_order_ready object="this.ship"/>
                      </conditions>
                    </interrupt>
                  </wait>
                </do_while>
                <set_value name="$returnDeliverAmount" exact="[this.ship.cargo.{$bestTrade.$Ware}.count, $returnAmount, $returnBuyAmount].min"/>
                <do_if value="$returnDeliverAmount gt 0">
                  <create_trade_order object="this.ship" tradeoffer="$returnBuy" amount="$returnDeliverAmount" immediate="true" internal="$returnInternal"/>
                  <do_while value="this.ship.orders.count gt 0">
                    <wait exact="5s">
                      <interrupt>
                        <conditions>
                          <event_object_order_ready object="this.ship"/>
                        </conditions>
                      </interrupt>
                    </wait>
                  </do_while>
                  <signal_objects object="player.galaxy" param="'GT_WriteLogbook'" param2="table[
                    $Message = {77000, 20201}.[$returnDeliverAmount, $bestTrade.$Ware.name, $bestTrade.$Destination.knownname, $bestTrade.$Source.knownname],
                    $Category = 'upkeep',
                    $Title = 'MK2 Return',
                    $Object = this.ship,
                    $CheckGlobalSettings = false
                  ]"/>
                </do_if>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
      </do_if>

      <do_if value="$denyTrade">
        <resume label="no_trade_retry"/>
      </do_if>
      <wait min="8s" max="12s"/>
      <resume label="main_loop"/>

      <label name="no_trade_retry"/>
      <!-- Escalating retry: 10s, 20s, 30s, 40s, 50s, 60s (cap), with jitter. -->
      <set_value name="$retryStep" exact="[this.$noTradeRetryCount, 5].min"/>
      <set_value name="$retryBase" exact="(10 + ($retryStep * 10)) * 1s"/>
      <set_value name="$retryJitter" exact="($retryBase / 5)i * 1s"/>
      <set_value name="$retryMin" exact="[8s, $retryBase - $retryJitter].max"/>
      <set_value name="$retryMax" exact="[60s, $retryBase + $retryJitter].min"/>
      <do_if value="this.$debuglevel ge 1">
        <debug_text text="'[GT-MK2] ' + this.ship.idcode + ': retry backoff (count=' + this.$noTradeRetryCount + ', wait=' + ($retryMin / 1s)i + '-' + ($retryMax / 1s)i + 's)'" chance="this.$debugchance"/>
      </do_if>
      <wait min="$retryMin" max="$retryMax"/>
      <set_value name="this.$noTradeRetryCount" exact="[this.$noTradeRetryCount + 1, 5].min"/>
      <resume label="main_loop"/>
    </actions>
  </attention>

  <on_abort>
    <do_if value="this.$fleetcoordination and this.$lastTradeDestination? and this.$lastTradeWare? and global.$GT_MK2_TradeReservations? and global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}? and global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}?">
      <create_list name="$mk2AbortReservationsAfterRelease"/>
      <do_all exact="global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}.count" counter="$mk2ari">
        <set_value name="$mk2AShip" exact="global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}.{$mk2ari}"/>
        <do_if value="$mk2AShip? and $mk2AShip.exists and $mk2AShip != this.ship">
          <append_to_list name="$mk2AbortReservationsAfterRelease" exact="$mk2AShip"/>
        </do_if>
      </do_all>
      <set_value name="global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}" exact="$mk2AbortReservationsAfterRelease"/>
      <do_if value="$mk2AbortReservationsAfterRelease.count == 0">
        <remove_value name="global.$GT_MK2_TradeReservations.{this.$lastTradeDestination}.{this.$lastTradeWare}"/>
      </do_if>
      <do_if value="global.$GT_MK2_TradeReservationAmounts? and global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}? and global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}.{this.$lastTradeWare}?">
        <remove_value name="global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}.{this.$lastTradeWare}.{this.ship}"/>
        <do_if value="$mk2AbortReservationsAfterRelease.count == 0">
          <remove_value name="global.$GT_MK2_TradeReservationAmounts.{this.$lastTradeDestination}.{this.$lastTradeWare}"/>
        </do_if>
      </do_if>
      <set_value name="this.$lastTradeDestination" exact="null"/>
      <set_value name="this.$lastTradeWare" exact="null"/>
      <set_value name="this.$lastTradeReservedAmount" exact="0"/>
    </do_if>
  </on_abort>
</aiscript>
