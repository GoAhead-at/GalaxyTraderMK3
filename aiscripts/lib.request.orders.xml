<?xml version="1.0" encoding="utf-8" ?>
<!--
  GalaxyTrader — Station Subordinate Order Access
  
  Patches vanilla lib.request.orders to protect GT orders from being overwritten
  by the station manager when a ship is assigned as a station subordinate.
  
  Without this patch: assigning a GT ship to a station causes the station manager
  to replace the GT order with vanilla TradeRoutine.
  
  With this patch: if the ship's default order ID is in global.$GT_ProtectedOrderIDs,
  the vanilla TradeRoutine/MiningRoutine creation is skipped entirely.
  
  Pattern based on mules_and_warehouses_extended, but uses a global list for extensibility.
  
  Requires: global.$GT_ProtectedOrderIDs (initialized in gt_core_system.xml)
-->
<diff>
  <!--
    INJECTION POINT 1: Detection
    
    Prepend a flag check at the top of the station-assignment do_elseif block
    (the block starting with: $commander.isclass.[class.station, class.buildstorage])
    
    If the ship already has a default order whose ID is in our protected list,
    set a flag variable so we can intercept the trade/mining assignment below.
    
    Vanilla structure at this point:
      do_else (commander exists)
        do_if (unit subordinate)
        do_elseif ($commander.isclass.[class.station, class.buildstorage])  <— WE PREPEND HERE
          do_if (positiondefence validity check)
          do_if (defence)
          do_elseif (positiondefence and valid)
          do_elseif (trade or mining)           <— WE INTERCEPT THIS
          ...
  -->
  <add sel="/aiscript[@name='lib.request.orders']/attention/actions/do_else/do_elseif" pos="prepend">
    <!-- GalaxyTrader: Detect if this ship has a protected GT order -->
    <do_if value="$object.defaultorder? and global.$GT_ProtectedOrderIDs? and global.$GT_ProtectedOrderIDs.indexof.{($object.defaultorder).id}">
      <set_value name="$flag_gt_protected" exact="true"/>
      <debug_text text="'[GT] Ship %1 (%2) has protected GT order: %3 — will skip station manager override'.[$object.knownname, $object, $object.defaultorder.id]" chance="$debugchance"/>
    </do_if>
  </add>

  <!--
    INJECTION POINT 2: Protection
    
    Insert a do_elseif BEFORE the trade/mining assignment block.
    If our flag was set above, this catches the ship and does nothing —
    preventing vanilla from creating TradeRoutine or MiningRoutine.
    
    We target the first do_elseif inside the station-assignment block,
    which is the positiondefence check. We insert BEFORE it so our
    protection check comes right after the defence do_if.
    
    Vanilla structure:
      do_if (defence)
      [OUR do_elseif INSERTED HERE]
      do_elseif (positiondefence and valid)
      do_elseif (trade or mining)
      ...
  -->
  <add sel="/aiscript[@name='lib.request.orders']/attention/actions/do_else/do_elseif/do_elseif[1]" pos="before">
    <!-- GalaxyTrader: If this ship has a protected GT order, skip all station manager assignment logic -->
    <do_elseif value="$flag_gt_protected?">
      <debug_text text="'[GT] Ship %1 (%2) order %3 is protected — station manager override skipped'.[$object.knownname, $object, $object.defaultorder.id]" chance="$debugchance"/>
    </do_elseif>
  </add>
</diff>
