<?xml version="1.0" encoding="utf-8"?>
<diff>
  <!-- GalaxyTrader MK3: Sector-Change Rerouting for TradePerform orders -->
  
  <!-- Sector-Change Rerouting: Check destination reachability when entering new sector -->
  <!-- This handler runs DURING move.generic execution for all GT ships (trade, repair, supply, etc.) -->
  <!-- move.generic handles sector changes and prevents them from bubbling to parent scripts -->
  <!-- Add BEFORE SectorChangeHandler so our handler fires first -->
  <add sel="//aiscript[@name='move.generic']/interrupts/handler[@ref='SectorChangeHandler']" pos="before">
    <handler comment="GT Sector-Change Rerouting: Check destination reachability on sector change (for all GT ship activities)">
      <conditions>
        <check_any>
          <event_object_entered_gate object="this.ship"/>
          <event_object_entered_anomaly object="this.ship"/>
        </check_any>
      </conditions>
      <actions>
        <!-- Get new sector from event (needed for both rerouting and logging) -->
        <set_value name="$newSectorFromEvent" exact="null"/>
        <do_if value="event.param2?">
          <do_if value="event.param2.sector?">
            <set_value name="$newSectorFromEvent" exact="event.param2.sector"/>
          </do_if>
        </do_if>
        <set_value name="$newSector" exact="if $newSectorFromEvent then $newSectorFromEvent else this.ship.sector"/>
        
        <!-- Process for all GT ships (trade, repair, supply, etc.) -->
        <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.ship}?">
          <!-- Log sector change for GT ships -->
          <set_value name="$oldSector" exact="null"/>
          <do_if value="event.param?">
            <do_if value="event.param.sector?">
              <set_value name="$oldSector" exact="event.param.sector"/>
            </do_if>
          </do_if>
          <set_value name="$oldSectorName" exact="if $oldSector then @$oldSector.knownname else 'Unknown'"/>
          <set_value name="$newSectorName" exact="@$newSector.knownname"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-MoveGeneric] ' + this.ship.idcode + ': SECTOR CHANGE: ' + $oldSectorName + ' ' + $newSectorName" chance="100"/>
          </do_if>
          
          <!-- Check destination reachability for rerouting (applies to all GT ship activities) -->
          <!-- Only Level 12+ pilots have tactical awareness for mid-route analysis -->
          <!-- Only check blacklist-aware paths if threat avoidance and dynamic blacklist are enabled -->
          <do_if value="this.ship.pilot and global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}?">
            <set_value name="$pilotLevel" exact="@global.$GT_Pilots.{this.ship.pilot}.$Level"/>
            
            <do_if value="$pilotLevel ge 12">
              <!-- Get current destination from move.generic's $destination parameter -->
              <set_value name="$currentDestination" exact="$destination"/>
              
              <!-- Check if destination is valid and in different sector -->
              <do_if value="@$currentDestination.exists and @$currentDestination.sector != null and $newSector != null and $newSector != @$currentDestination.sector">
                <set_value name="$destinationSector" exact="@$currentDestination.sector"/>

                <!-- Prefer showing the destination's container (station/ship) in logbook messages.
                     move.generic callers often pass a dockingbay component as destination, whose knownname is unhelpful ("S Standard Docking Bay"). -->
                <set_value name="$destinationDisplay" exact="$currentDestination"/>
                <set_value name="$destinationContainer" exact="@$currentDestination.container"/>
                <do_if value="$destinationContainer != null">
                  <set_value name="$destinationDisplay" exact="$destinationContainer"/>
                </do_if>
                <set_value name="$destinationDisplayName" exact="@$destinationDisplay.knownname"/>
                
                <!-- Check if threat avoidance and dynamic blacklist are enabled -->
                <set_value name="$threatAvoidanceEnabled" exact="false"/>
                <set_value name="$useDynamicBlacklist" exact="false"/>
                <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$ThreatAvoidance?">
                  <set_value name="$threatAvoidanceEnabled" exact="@global.$GT_GlobalSettings.$ThreatAvoidance.$Enabled"/>
                  <set_value name="$useDynamicBlacklist" exact="@global.$GT_GlobalSettings.$ThreatAvoidance.$UseDynamicBlacklist"/>
                </do_if>
                
                <!-- Calculate normal distance (shortest path) -->
                <set_value name="$normalDistance" exact="this.ship.gatedistance.{$destinationSector}"/>
                
                <!-- Calculate blacklist-aware distance (avoiding threats) - only if threat avoidance is enabled -->
                <set_value name="$blacklistDistance" exact="-1"/>
                <do_if value="$threatAvoidanceEnabled and $useDynamicBlacklist">
                  <!-- Determine ship's blacklistgroup -->
                  <set_value name="$blacklistgroup" exact="blacklistgroup.civilian"/>
                  <do_if value="this.ship.isclass.[class.ship_m, class.ship_l, class.ship_xl]">
                    <set_value name="$blacklistgroup" exact="blacklistgroup.military"/>
                  </do_if>
                  <set_value name="$blacklistDistance" exact="this.ship.gatedistance.{$destinationSector}.{$blacklistgroup}.{this.ship}"/>
                </do_if>

                <!-- Debug: log EVERY validation check that is actually performed (distance calculations done) -->
                <!-- This helps measure how often these checks fire and correlate with CPU spikes -->
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <set_value name="$blacklistGroupDisplay" exact="if $threatAvoidanceEnabled and $useDynamicBlacklist then $blacklistgroup else 'N/A (threat avoidance disabled)'"/>
                  <debug_text text="'[GT-MoveGeneric] ' + this.ship.idcode + ': SECTOR CHANGE CHECK: dest=' + $destinationDisplayName + ' (sector ' + @$destinationSector.knownname + '), normal=' + $normalDistance + ', blacklist=' + $blacklistDistance + ', group=' + $blacklistGroupDisplay + ', threatAvoidance=' + $threatAvoidanceEnabled + ', useBlacklist=' + $useDynamicBlacklist" chance="100"/>
                </do_if>
                
                <!-- Check if reroute needed: unreachable OR path changed (longer due to blacklist) -->
                <!-- Case 1: Normal path doesn't exist (disconnected sectors, destroyed gates) -->
                <do_if value="$normalDistance lt 0">
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-MoveGeneric] ' + this.ship.idcode + ': SECTOR CHANGE REROUTE: Destination ' + @$currentDestination.knownname + ' unreachable (normal path: -1) - aborting movement'" chance="100"/>
                  </do_if>
                  
                  <!-- Set reroute flag for ship name -->
                  <set_value name="global.$GT_Ships.{this.ship}.$Rerouting" exact="true"/>
                  
                  <!-- Trigger ship rename to show [REROUTE] state -->
                  <signal_objects object="player.galaxy" param="'GT_Update_Ship_Name'" param2="table[
                    $ship=this.ship, 
                    $pilot=this.ship.pilot, 
                    $xp=global.$GT_Pilots.{this.ship.pilot}.$XP, 
                    $level=global.$GT_Pilots.{this.ship.pilot}.$Level,
                    $rank=@global.$GT_Pilots.{this.ship.pilot}.$CurrentRank,
                    $nameType='trader'
                  ]"/>
                  
                  <!-- Player logbook notification about route change -->
                  <!-- Construct logbook message using TextDB syntax (vanilla pattern) -->
                  <set_value name="$logbookMessage" exact="{77000,3218}.[@$newSector.knownname, $destinationDisplayName, @$destinationSector.knownname, -1, 'UNREACHABLE', 'No path available', this.ship.knownname]"/>
                  
                  <!-- Send logbook message via signal (handled by MD cue) -->
                  <signal_objects object="player.galaxy" param="'GT_WriteLogbook'" param2="table[
                    $Message = $logbookMessage,
                    $Category = 'alerts',
                    $Title = 'Route Path Changed: ' + this.ship.knownname,
                    $Object = this.ship,
                    $Interaction = 'showonmap',
                    $Highlighted = false
                  ]"/>
                  
                  <!-- Signal dock failure to parent order (TradePerform, Repair, Supply, etc.) -->
                  <do_if value="not global.$GT_DockFailures?">
                    <set_value name="global.$GT_DockFailures" exact="table[]"/>
                  </do_if>
                  <set_value name="global.$GT_DockFailures.{this.ship}" exact="table[
                    $Reason = 'ROUTE_PATH_CHANGED',
                    $FailureText = {1045, 124},
                    $Destination = $destination,
                    $Timestamp = player.age
                  ]"/>
                  
                  <!-- Abort move.generic - this will return control to parent order -->
                  <set_value name="$returnvalue" exact="false"/>
                  <abort_called_scripts resume="finish"/>
                </do_if>
                <!-- Case 2: Normal path exists, but blacklist-aware path is blocked or longer (only if threat avoidance enabled) -->
                <do_elseif value="$normalDistance ge 0">
                  <do_if value="$threatAvoidanceEnabled and $useDynamicBlacklist and ($blacklistDistance lt 0 or $blacklistDistance gt $normalDistance)">
                    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                      <debug_text text="'[GT-MoveGeneric] ' + this.ship.idcode + ': SECTOR CHANGE REROUTE: Destination ' + @$currentDestination.knownname + ' path changed (normal: ' + $normalDistance + ' jumps, blacklist-aware: ' + $blacklistDistance + ' jumps) - aborting movement'" chance="100"/>
                    </do_if>
                    
                    <!-- Set reroute flag for ship name -->
                    <set_value name="global.$GT_Ships.{this.ship}.$Rerouting" exact="true"/>
                    
                    <!-- Trigger ship rename to show [REROUTE] state -->
                    <signal_objects object="player.galaxy" param="'GT_Update_Ship_Name'" param2="table[
                      $ship=this.ship, 
                      $pilot=this.ship.pilot, 
                      $xp=global.$GT_Pilots.{this.ship.pilot}.$XP, 
                      $level=global.$GT_Pilots.{this.ship.pilot}.$Level,
                      $rank=@global.$GT_Pilots.{this.ship.pilot}.$CurrentRank,
                      $nameType='trader'
                    ]"/>
                    
                    <!-- Player logbook notification about route change -->
                    <!-- Format blacklist distance for display -->
                    <set_value name="$blacklistDistanceText" exact="if $blacklistDistance lt 0 then 'UNREACHABLE' else $blacklistDistance + ' jumps'"/>
                    
                    <!-- Format status text -->
                    <set_value name="$statusText" exact="if $blacklistDistance lt 0 then 'No safe path available' else 'Path requires detour'"/>
                    
                    <!-- Construct logbook message using TextDB syntax (vanilla pattern) -->
                    <set_value name="$logbookMessage" exact="{77000,3218}.[@$newSector.knownname, $destinationDisplayName, @$destinationSector.knownname, $normalDistance, $blacklistDistanceText, $statusText, this.ship.knownname]"/>
                    
                    <!-- Send logbook message via signal (handled by MD cue) -->
                    <signal_objects object="player.galaxy" param="'GT_WriteLogbook'" param2="table[
                      $Message = $logbookMessage,
                      $Category = 'alerts',
                      $Title = 'Route Path Changed: ' + this.ship.knownname,
                      $Object = this.ship,
                      $Interaction = 'showonmap',
                      $Highlighted = false
                    ]"/>
                    
                    <!-- Signal dock failure to parent order (TradePerform, Repair, Supply, etc.) -->
                    <do_if value="not global.$GT_DockFailures?">
                      <set_value name="global.$GT_DockFailures" exact="table[]"/>
                    </do_if>
                    <set_value name="global.$GT_DockFailures.{this.ship}" exact="table[
                      $Reason = 'ROUTE_PATH_CHANGED',
                      $FailureText = {1045, 124},
                      $Destination = $destination,
                      $Timestamp = player.age
                    ]"/>
                    
                    <!-- Abort move.generic - this will return control to parent order -->
                    <set_value name="$returnvalue" exact="false"/>
                    <abort_called_scripts resume="finish"/>
                  </do_if>
                </do_elseif>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
      </actions>
    </handler>
  </add>
  
  <!-- Enemy Ship Departure Detection: Track when enemy ships leave blacklisted sectors -->
  <!-- This handler runs for ALL ships when they change sectors -->
  <!-- If a tracked enemy ship leaves a blacklisted sector, remove it from tracking -->
  <add sel="//aiscript[@name='move.generic']/interrupts/handler[@ref='SectorChangeHandler']" pos="before">
    <handler comment="GT Enemy Departure Detection: Remove tracked enemies when they leave sectors">
      <conditions>
        <check_any>
          <event_object_entered_gate object="this.ship"/>
          <event_object_entered_anomaly object="this.ship"/>
        </check_any>
      </conditions>
      <actions>
        <!-- Get new sector from event -->
        <set_value name="$newSectorFromEvent" exact="null"/>
        <do_if value="event.param2?">
          <do_if value="event.param2.sector?">
            <set_value name="$newSectorFromEvent" exact="event.param2.sector"/>
          </do_if>
        </do_if>
        <set_value name="$newSector" exact="if $newSectorFromEvent then $newSectorFromEvent else this.ship.sector"/>
        
        <!-- Get old sector from event -->
        <set_value name="$oldSector" exact="null"/>
        <do_if value="event.param?">
          <do_if value="event.param.sector?">
            <set_value name="$oldSector" exact="event.param.sector"/>
          </do_if>
        </do_if>
        
        <!-- Check if threat intelligence system exists -->
        <do_if value="global.$GT_ThreatIntelligence?">
          <set_value name="$sectorsToCheck" exact="global.$GT_ThreatIntelligence.keys.list"/>
          
          <!-- Iterate through all tracked sectors -->
          <do_all exact="$sectorsToCheck.count" counter="$i">
            <set_value name="$trackedSector" exact="$sectorsToCheck.{$i}"/>
            <set_value name="$threatData" exact="global.$GT_ThreatIntelligence.{$trackedSector}"/>
            
            <!-- Check if this sector has tracked ships -->
            <do_if value="$threatData.$TrackedEnemyShips? and $threatData.$TrackedEnemyShips.count gt 0">
              <set_value name="$trackedShips" exact="$threatData.$TrackedEnemyShips"/>
              <set_value name="$shipFound" exact="false"/>
              
              <!-- Find and remove this ship from tracking if it's in the list -->
              <do_all exact="$trackedShips.count" counter="$j" reverse="true">
                <set_value name="$trackedShip" exact="$trackedShips.{$j}"/>
                <do_if value="$trackedShip == this.ship">
                  <set_value name="$shipFound" exact="true"/>
                  
                  <!-- Get sector name for logbook (before removal) -->
                  <set_value name="$leftSectorName" exact="@$trackedSector.knownname"/>
                  <set_value name="$newSectorName" exact="@$newSector.knownname"/>
                  <set_value name="$shipName" exact="@this.ship.knownname"/>
                  
                  <!-- Remove ship from tracking list -->
                  <remove_from_list name="global.$GT_ThreatIntelligence.{$trackedSector}.$TrackedEnemyShips" exact="$trackedShip"/>
                  
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-Threat] Tracked enemy ship ' + $shipName + ' left sector ' + $leftSectorName + ' and moved to ' + $newSectorName" chance="100"/>
                  </do_if>
                  
                  <!-- Check if all ships gone from this sector -->
                  <set_value name="$remainingShips" exact="@global.$GT_ThreatIntelligence.{$trackedSector}.$TrackedEnemyShips"/>
                  <do_if value="$remainingShips == null">
                    <set_value name="$remainingShips" exact="[]"/>
                  </do_if>
                  <do_if value="$remainingShips.count == 0">
                    <!-- All tracked ships eliminated - signal MD cue to clear sector -->
                    <signal_objects object="player.galaxy" param="'GT_ClearSectorIfAllShipsGone'" param2="table[$Sector=$trackedSector]"/>
                  </do_if>
                  <do_else>
                    <!-- Ship left but others remain - send logbook message about lost track -->
                    <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$LogbookEntries? and global.$GT_GlobalSettings.$LogbookEntries">
                      <!-- Construct logbook message using TextDB syntax (vanilla pattern) -->
                      <set_value name="$logbookMessage" exact="{77000,3220}.[$leftSectorName, $newSectorName, $shipName]"/>
                      
                      <signal_objects object="player.galaxy" param="'GT_WriteLogbook'" param2="table[
                        $Message = $logbookMessage,
                        $Category = 'alerts',
                        $Title = 'Enemy Ship Escaped: ' + $leftSectorName,
                        $Object = $trackedSector,
                        $Interaction = 'showonmap',
                        $Highlighted = false
                      ]"/>
                    </do_if>
                  </do_else>
                  
                  <break/>
                </do_if>
              </do_all>
            </do_if>
          </do_all>
        </do_if>
      </actions>
    </handler>
  </add>

  <!-- ThreatAvoidance: Hostile gravidar contact detection (event-driven, vanilla-pattern) -->
  <!-- WHY HERE: move.generic runs for all movement; ships may not currently be running order.trade.galaxytrader when contacts appear.
       This provides the most reliable hook with minimal overhead by gating on min=1 contacts (no work when none). -->
  <add sel="//aiscript[@name='move.generic']/interrupts/handler[@ref='SectorChangeHandler']" pos="before">
    <handler comment="GT ThreatAvoidance: hostile gravidar contact detection (move.generic)">
      <conditions>
        <!-- Vanilla event: fires on gravidar scans -->
        <event_gravidar_has_scanned object="this.assignedcontrolled"/>
        <!-- Vanilla safety gates (avoid highways / critical order state) -->
        <check_value value="this.sector and not this.zone.isclass.highway"/>
        <check_value value="this.assignedcontrolled.order and this.assignedcontrolled.order.state != orderstate.critical"/>

        <!-- Only for GT ships and only if ThreatAvoidance + DynamicBlacklist are enabled -->
        <check_value value="global.$GT_Ships? and global.$GT_Ships.{this.ship}?"/>
        <check_value value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$ThreatAvoidance? and global.$GT_GlobalSettings.$ThreatAvoidance.$Enabled"/>
        <check_value value="global.$GT_GlobalSettings.$ThreatAvoidance.$UseDynamicBlacklist"/>

        <!-- PERFORMANCE: Do not run actions unless at least 1 hostile ship contact exists (vanilla pattern: min=1 + maybeattackedby) -->
        <count_gravidar_contacts result="$_detectedHostiles" object="this.assignedcontrolled" class="[class.ship_s, class.ship_m, class.ship_l, class.ship_xl]" maybeattackedby="this.assignedcontrolled" checkoperational="false" masstraffic="false" docked="false" multiple="true" min="1">
          <match_context macro="this.sector.macro"/>
          <match_context class="class.highway" negate="true"/>
          <match class="class.buildstorage" negate="true"/>
          <match state="componentstate.wreck" negate="true"/>
        </count_gravidar_contacts>
      </conditions>
      <actions>
        <!-- Per-ship throttle (global table; survives across move.generic instances) -->
        <do_if value="not global.$GT_ThreatDetectThrottle?">
          <set_value name="global.$GT_ThreatDetectThrottle" exact="table[]"/>
        </do_if>
        <set_value name="$_last" exact="@global.$GT_ThreatDetectThrottle.{this.ship}"/>
        <do_if value="$_last == null">
          <set_value name="$_last" exact="0s"/>
        </do_if>

        <!-- Always LOG when hostiles are detected, but avoid log spam by throttling to at most once per 10s per ship -->
        <set_value name="$_logAllowed" exact="player.age - $_last ge 10s"/>

        <set_value name="$hostiles" exact="$_detectedHostiles"/>
        <!-- IMPORTANT: $hostiles.count may include non-operational contacts (checkoperational="false").
             We want HostileCount to match the class breakdown we compute below, so we derive it from class counters. -->
        <set_value name="$hostileListCount" exact="$hostiles.count"/>
        <set_value name="$hostileCount" exact="0"/>

        <!-- Compute threat (stop early once we exceed common thresholds) -->
        <set_value name="$threatScore" exact="0"/>
        <set_value name="$shipClass_XL" exact="0"/>
        <set_value name="$shipClass_L" exact="0"/>
        <set_value name="$shipClass_M" exact="0"/>
        <set_value name="$shipClass_S" exact="0"/>
        <set_value name="$factionCounts" exact="table[]"/>

        <do_all exact="$hostileListCount" counter="$i">
          <set_value name="$h" exact="$hostiles.{$i}"/>
          <do_if value="@$h.exists and @$h.isoperational">
            <do_if value="$h.isclass.ship_xl">
              <set_value name="$threatScore" exact="$threatScore + 5"/>
              <set_value name="$shipClass_XL" operation="add"/>
            </do_if>
            <do_elseif value="$h.isclass.ship_l">
              <set_value name="$threatScore" exact="$threatScore + 3"/>
              <set_value name="$shipClass_L" operation="add"/>
            </do_elseif>
            <do_elseif value="$h.isclass.ship_m">
              <set_value name="$threatScore" exact="$threatScore + 2"/>
              <set_value name="$shipClass_M" operation="add"/>
            </do_elseif>
            <do_else>
              <set_value name="$threatScore" exact="$threatScore + 1"/>
              <set_value name="$shipClass_S" operation="add"/>
            </do_else>

            <do_if value="@$h.owner != null">
              <set_value name="$f" exact="$h.owner"/>
              <set_value name="$factionCounts.{$f}" exact="@$factionCounts.{$f} + 1"/>
            </do_if>
          </do_if>
        </do_all>

        <!-- Make HostileCount match class counters -->
        <set_value name="$hostileCount" exact="$shipClass_XL + $shipClass_L + $shipClass_M + $shipClass_S"/>

        <!-- Determine primary faction (best-effort; used for logging/telemetry) -->
        <set_value name="$primaryFaction" exact="null"/>
        <set_value name="$maxFactionCount" exact="0"/>
        <do_all exact="$factionCounts.keys.count" counter="$fi">
          <set_value name="$f" exact="$factionCounts.keys.{$fi}"/>
          <do_if value="$factionCounts.{$f} gt $maxFactionCount">
            <set_value name="$primaryFaction" exact="$f"/>
            <set_value name="$maxFactionCount" exact="$factionCounts.{$f}"/>
          </do_if>
        </do_all>

        <!-- Convert score to threat level (1-5), matching GT_ThreatIntelligence receiver expectations -->
        <set_value name="$threatLevel" exact="2"/>
        <do_if value="$shipClass_XL gt 0 or $shipClass_L gt 0">
          <set_value name="$threatLevel" exact="4"/>
        </do_if>
        <do_elseif value="$threatScore ge 6">
          <set_value name="$threatLevel" exact="3"/>
        </do_elseif>

        <!-- Compare to configured threshold (fallback 3) -->
        <set_value name="$threshold" exact="global.$GT_GlobalSettings.$ThreatAvoidance.$BlacklistThreshold"/>
        <do_if value="not $threshold?">
          <set_value name="$threshold" exact="3"/>
        </do_if>

        <!-- Broadcast throttle (separate from logging throttle) -->
        <set_value name="$_broadcastAllowed" exact="player.age - $_last ge 30s"/>
        <do_if value="$hostileCount gt 0 and $_broadcastAllowed and $threatLevel ge $threshold">
          <signal_objects object="player.galaxy" param="'GT_Threat_Warning'" param2="table[
            $Sector = this.sector,
            $DetectedBy = this.ship,
            $HostileCount = $hostileCount,
            $PrimaryFaction = $primaryFaction,
            $ShipClass_XL = $shipClass_XL,
            $ShipClass_L = $shipClass_L,
            $ShipClass_M = $shipClass_M,
            $ShipClass_S = $shipClass_S,
            $ThreatScore = $threatScore,
            $Timestamp = player.age
          ]"/>
        </do_if>

        <do_if value="$hostileCount gt 0 and $_logAllowed">
          <set_value name="global.$GT_ThreatDetectThrottle.{this.ship}" exact="player.age"/>
          <set_value name="$_primaryFactionName" exact="if $primaryFaction? then @$primaryFaction.knownname else 'UNKNOWN'"/>
          <set_value name="$_broadcasted" exact="if ($_broadcastAllowed and $threatLevel ge $threshold) then 'YES' else 'NO'"/>
          <debug_text text="'[GT-Threat-Detect] ' + this.ship.idcode + ' in ' + this.sector.knownname
            + ' - hostiles=' + $hostileCount
            + ' (XL=' + $shipClass_XL + ', L=' + $shipClass_L + ', M=' + $shipClass_M + ', S=' + $shipClass_S + ')'
            + ', threatScore=' + $threatScore + ', threatLevel=' + $threatLevel + ', threshold=' + $threshold
            + ', primaryFaction=' + $_primaryFactionName
            + ', broadcasted=' + $_broadcasted" chance="100"/>
        </do_if>
      </actions>
    </handler>
  </add>
  
</diff>
