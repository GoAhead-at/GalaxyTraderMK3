<?xml version="1.0" encoding="utf-8"?>
<diff>
  <!-- GalaxyTrader MK3: Direct trade completion signalling patch -->
  <!-- This patch adds immediate XP signalling when trades complete successfully -->
  
  <add sel="//aiscript[@name='order.trade.perform']/attention/actions/label[@name='finish']" pos="before">
    
    <!-- GALAXYTRADER MK3: Direct trade completion signalling -->
    <!-- CRITICAL FIX: Only award XP on SELL operations (complete trades), not BUY operations -->
    <do_if value="$failreason == '' and $traderesult and this.ship.pilot and not $isbuying">
      <!-- Check if this pilot is managed by GalaxyTrader MK3 -->
      <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}?">
        
        <!-- Calculate GalaxyTrader XP (enhanced version of native XP) -->
        <!-- READ FROM SINGLE SOURCE OF TRUTH CONFIGURATION -->
        <set_value name="$gt_base_xp" exact="@global.$GT_Config.$XP.$BaseXPPerTrade"/>
        <set_value name="$gt_value_divisor" exact="@global.$GT_Config.$XP.$ValueDivisor"/>
        <set_value name="$gt_quality_multiplier" exact="@global.$GT_Config.$XP.$QualityMultiplier"/>
        <set_value name="$gt_max_distance" exact="@global.$GT_Config.$XP.$MaxDistanceForBonus"/>
        <set_value name="$gt_distance_divisor" exact="@global.$GT_Config.$XP.$DistanceBonusDivisor"/>
        <set_value name="$gt_min_xp" exact="@global.$GT_Config.$XP.$MinXPPerTrade"/>
        <set_value name="$gt_max_xp" exact="@global.$GT_Config.$XP.$MaxXPPerTrade"/>
        
        <!-- Apply configuration values with fallbacks for safety -->
        <do_if value="not $gt_base_xp?">
          <set_value name="$gt_base_xp" exact="50"/>  <!-- Fallback if config not loaded -->
        </do_if>
        <do_if value="not $gt_value_divisor?">
          <set_value name="$gt_value_divisor" exact="10000"/>
        </do_if>
        <do_if value="not $gt_quality_multiplier?">
          <set_value name="$gt_quality_multiplier" exact="0.5"/>
        </do_if>
        <do_if value="not $gt_max_distance?">
          <set_value name="$gt_max_distance" exact="10"/>
        </do_if>
        <do_if value="not $gt_distance_divisor?">
          <set_value name="$gt_distance_divisor" exact="20.0"/>
        </do_if>
        <do_if value="not $gt_min_xp?">
          <set_value name="$gt_min_xp" exact="10"/>
        </do_if>
        <do_if value="not $gt_max_xp?">
          <set_value name="$gt_max_xp" exact="1000"/>
        </do_if>
        
        <!-- Calculate XP components using configuration values -->
        <set_value name="$gt_value_multiplier" exact="(($tradedeal.unitprice * $tradedeal.transferredamount) / ($gt_value_divisor * 1Cr))f"/>
        <set_value name="$gt_quality_bonus" exact="1.0 + ($tradequality * $gt_quality_multiplier)"/>
        <set_value name="$gt_distance_bonus" exact="1.0"/>  <!-- Will be calculated below -->
        
        <!-- Calculate distance bonus if we can determine trade partner distance -->
        <do_if value="this.ship.sector? and $targetobject.sector?">
          <set_value name="$sector_distance" exact="this.ship.sector.distanceto.{$targetobject.sector}"/>
          <do_if value="$sector_distance gt 0">
            <!-- Distance bonus using configuration values -->
            <set_value name="$gt_distance_bonus" exact="1.0 + ([$sector_distance, $gt_max_distance].min / $gt_distance_divisor)"/>
          </do_if>
        </do_if>
        
        <!-- Final XP calculation -->
        <set_value name="$gt_xp_amount" exact="($gt_base_xp * $gt_value_multiplier * $gt_quality_bonus * $gt_distance_bonus)i"/>
        
        <!-- Cap XP to configured range -->
        <do_if value="$gt_xp_amount lt $gt_min_xp">
          <set_value name="$gt_xp_amount" exact="$gt_min_xp"/>
        </do_if>
        <do_if value="$gt_xp_amount gt $gt_max_xp">
          <set_value name="$gt_xp_amount" exact="$gt_max_xp"/>
        </do_if>
        
        <!-- Store rich trade data for advanced XP processing -->
        <set_value name="$trade_data" exact="table[
            $pilot = this.ship.pilot,
            $ship = this.ship,
            $xpAmount = $gt_xp_amount,
            $ware = $tradedeal.ware,
            $tradeValue = $tradedeal.unitprice * $tradedeal.transferredamount,
            $transferredAmount = $tradedeal.transferredamount,
            $unitPrice = $tradedeal.unitprice,
            $tradeQuality = $tradequality,
            $partner = $targetobject,
            $partnerSector = $targetobject.sector,
            $shipSector = this.ship.sector,
            $isPlayerOwned = this.ship.isplayerowned,
            $timestamp = player.age,
            $valueMultiplier = $gt_value_multiplier,
            $qualityBonus = $gt_quality_bonus,
            $distanceBonus = $gt_distance_bonus
        ]"/>
        
        <!-- Store trade data in global queue for MD system to process -->
        <do_if value="not global.$GT_DirectTradeQueue?">
          <set_value name="global.$GT_DirectTradeQueue" exact="[]"/>
        </do_if>
        
        <!-- Add trade data to queue -->
        <append_to_list name="global.$GT_DirectTradeQueue" exact="$trade_data"/>
        
        <!-- Set flag to trigger MD processing -->
        <set_value name="global.$GT_DirectTradePending" exact="true"/>
        
        <debug_text text="'[GT-TradePerform] ðŸŽ¯ DIRECT XP QUEUED (SELL ONLY): Pilot ' + this.ship.pilot.name + ' earned ' + $gt_xp_amount + ' XP for ' + $tradedeal.ware + ' trade (value: ' + ($tradedeal.unitprice * $tradedeal.transferredamount) + ', quality: ' + $tradequality + ', distance: ' + $gt_distance_bonus + ')'" chance="100"/>
      </do_if>
    </do_if>
    
  </add>
</diff>
