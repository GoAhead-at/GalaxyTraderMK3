<?xml version="1.0" encoding="utf-8"?>
<diff>
  <!-- GalaxyTrader MK3: Detect GT order removal when Hold Position is assigned -->
  <!-- When GT order is removed, X4 assigns Hold Position (Wait order) as default order -->
  <!-- This patch detects when Hold Position is assigned to a ship that previously had a GT order -->
  
  <!-- ✅ PHASE 7: Add GT order detection in init block -->
  <!-- Add detection logic at the start of init block (after set_command) -->
  <add sel="//aiscript[@name='order.wait']/init/set_command_action[@commandaction='commandaction.standingby']" pos="after">
    
    <!-- ✅ PHASE 7: Detect GT order removal when Hold Position is assigned -->
    <!-- When GT order is removed, X4 assigns Hold Position as default order -->
    <!-- Check if this ship was previously registered with GT order -->
    <do_if value="global.$GT_Ship_State? and global.$GT_Ship_State.{this.assignedcontrolled}?">
      <set_value name="$state" exact="global.$GT_Ship_State.{this.assignedcontrolled}"/>
      
      <!-- ✅ FIX: First check if ship ACTUALLY has GT order - if yes, don't send cancellation signal -->
      <!-- This prevents false positives when state is stale but ship still has GT order -->
      <set_value name="$actuallyHasGTOrder" exact="false"/>
      <do_if value="this.assignedcontrolled.defaultorder? and @this.assignedcontrolled.defaultorder.id == 'GalaxyTraderMK3'">
        <set_value name="$actuallyHasGTOrder" exact="true"/>
      </do_if>
      <do_if value="not $actuallyHasGTOrder and this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists and this.assignedcontrolled.commander != this.assignedcontrolled">
        <do_if value="this.assignedcontrolled.commander.defaultorder? and @this.assignedcontrolled.commander.defaultorder.id == 'GalaxyTraderMK3'">
          <set_value name="$actuallyHasGTOrder" exact="true"/>
        </do_if>
      </do_if>
      
      <!-- Only check for cancellation if ship does NOT currently have GT order -->
      <!-- If state says ship has GT order but ship now has Hold Position, GT order was removed -->
      <do_if value="not $actuallyHasGTOrder and $state.$HasGTOrder">
        <set_value name="$currentDefaultOrder" exact="@this.assignedcontrolled.defaultorder.id"/>
        
        <!-- Check if current default order is Hold Position (Wait) or another non-GT order -->
        <!-- CRITICAL: Only send GT_Order_Cancelled if ship NO LONGER has GT as default order -->
        <!-- For subordinates, default order is Assist, but GT order is still active via commander -->
        <do_if value="$currentDefaultOrder != 'GalaxyTraderMK3'">
          <!-- Check if ship still has GT order (direct or via commander) -->
          <set_value name="$hasGTOrder" exact="false"/>
          
          <!-- Re-check default order directly (might have changed) -->
          <set_value name="$actualDefaultOrder" exact="@this.assignedcontrolled.defaultorder.id"/>
          <do_if value="$actualDefaultOrder == 'GalaxyTraderMK3'">
            <set_value name="$hasGTOrder" exact="true"/>
          </do_if>
          
          <!-- Check if subordinate to GT commander -->
          <do_if value="not $hasGTOrder and this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists and this.assignedcontrolled.commander != this.assignedcontrolled">
            <do_if value="this.assignedcontrolled.commander.defaultorder? and @this.assignedcontrolled.commander.defaultorder.id == 'GalaxyTraderMK3'">
              <set_value name="$hasGTOrder" exact="true"/>
            </do_if>
          </do_if>
          
          <!-- Only proceed if GT order is actually gone -->
          <do_if value="not $hasGTOrder">
            <!-- ✅ FIX: Prevent duplicate signals - only send if we haven't already sent cancellation recently -->
            <!-- Check if cancellation signal was already sent recently (within last 10 seconds) -->
            <set_value name="$lastCancellationTime" exact="0"/>
            <do_if value="$state.$LastCancellationSignalTime?">
              <set_value name="$lastCancellationTime" exact="@$state.$LastCancellationSignalTime"/>
            </do_if>
            
            <set_value name="$timeSinceLastCancellation" exact="player.age - $lastCancellationTime"/>
            <do_if value="$timeSinceLastCancellation gt 10s or $lastCancellationTime == 0">
              <debug_text text="'[GT-State] Phase 7: ' + this.assignedcontrolled.idcode + ' - GT order removed (detected in Hold Position order, new default order: ' + (if $currentDefaultOrder then $currentDefaultOrder else 'NONE') + ')'" chance="100"/>
              
              <!-- Update state to reflect GT order cancellation -->
              <set_value name="$state.$HasGTOrder" exact="false"/>
              <set_value name="$state.$OperationalState" exact="'orphaned'"/>
              <set_value name="$state.$ActiveTradeOrders" exact="0"/>
              
              <!-- Determine subordinate state -->
              <set_value name="$hasCommander" exact="false"/>
              <do_if value="this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists and this.assignedcontrolled.commander != this.assignedcontrolled">
                <set_value name="$hasCommander" exact="true"/>
                <set_value name="$state.$Commander" exact="this.assignedcontrolled.commander"/>
                
                <!-- Check if commander has GT order -->
                <set_value name="$commanderHasGT" exact="false"/>
                <do_if value="this.assignedcontrolled.commander.defaultorder? and @this.assignedcontrolled.commander.defaultorder.id == 'GalaxyTraderMK3'">
                  <set_value name="$commanderHasGT" exact="true"/>
                </do_if>
                <set_value name="$state.$CommanderHasGT" exact="$commanderHasGT"/>
                
                <do_if value="$commanderHasGT">
                  <set_value name="$state.$SubordinateState" exact="'subordinate'"/>
                </do_if>
                <do_else>
                  <set_value name="$state.$SubordinateState" exact="'orphaned'"/>
                </do_else>
              </do_if>
              <do_else>
                <set_value name="$state.$Commander" exact="null"/>
                <set_value name="$state.$CommanderHasGT" exact="false"/>
                <set_value name="$state.$SubordinateState" exact="'orphaned'"/>
              </do_else>
              
              <set_value name="$state.$LastStateUpdate" exact="player.age"/>
              <set_value name="$state.$LastCancellationSignalTime" exact="player.age"/>
              
              <!-- ✅ MOD REMOVAL: Send GT_Ship_State_Update signal for mod removal system -->
              <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
                $Ship = this.assignedcontrolled,
                $UpdateType = 'GT_Order_Cancelled'
              ]"/>
            </do_if>
            <do_else>
              <debug_text text="'[GT-State] Phase 7: ' + this.assignedcontrolled.idcode + ' - Skipping duplicate GT_Order_Cancelled signal (sent ' + ($timeSinceLastCancellation / 1s) + 's ago)'" chance="100"/>
            </do_else>
          </do_if>
          <do_else>
            <debug_text text="'[GT-State] Phase 7: ' + this.assignedcontrolled.idcode + ' - Hold Position assigned but GT order still active (default order: ' + (if $currentDefaultOrder then $currentDefaultOrder else 'NONE') + ', actual default: ' + (if $actualDefaultOrder then $actualDefaultOrder else 'NONE') + ', has GT: ' + $hasGTOrder + ') - NOT sending GT_Order_Cancelled'" chance="100"/>
          </do_else>
          
          <!-- ✅ NAME RESTORATION: Restore ship name if not GT-controlled (direct or subordinate) -->
          <set_value name="$isSubordinateOfGTCommander" exact="false"/>
          <do_if value="this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists and this.assignedcontrolled.commander != this.assignedcontrolled">
            <do_if value="this.assignedcontrolled.commander.defaultorder? and @this.assignedcontrolled.commander.defaultorder.id == 'GalaxyTraderMK3'">
              <set_value name="$isSubordinateOfGTCommander" exact="true"/>
            </do_if>
          </do_if>
          
          <set_value name="$hasDirectGTOrder" exact="false"/>
          <do_if value="this.assignedcontrolled.defaultorder? and @this.assignedcontrolled.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$hasDirectGTOrder" exact="true"/>
          </do_if>
          
          <do_if value="not $hasDirectGTOrder and not $isSubordinateOfGTCommander and this.assignedcontrolled.pilot?">
            <set_value name="$originalName" exact="null"/>
            <do_if value="$state.$OriginalShipName?">
              <set_value name="$originalName" exact="$state.$OriginalShipName"/>
            </do_if>
            <do_elseif value="global.$GT_Pilots? and global.$GT_Pilots.{this.assignedcontrolled.pilot}? and global.$GT_Pilots.{this.assignedcontrolled.pilot}.$OriginalShipName?">
              <set_value name="$originalName" exact="global.$GT_Pilots.{this.assignedcontrolled.pilot}.$OriginalShipName"/>
            </do_elseif>
            
            <do_if value="$originalName">
              <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
                $Ship = this.assignedcontrolled,
                $Pilot = this.assignedcontrolled.pilot,
                $Reason = 'GT order removed - restoring original name',
                $OriginalName = $originalName
              ]"/>
              <debug_text text="'[GT-State] Phase 7: Name restoration signal sent for ' + this.assignedcontrolled.idcode + ' (original name: ' + $originalName + ')'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
      </do_if>
    </do_if>
    
  </add>
</diff>
