<?xml version="1.0" encoding="utf-8"?>
<diff>
  <!-- GalaxyTrader MK3: Detect GT order removal when Hold Position is assigned -->
  <!-- When GT order is removed, X4 assigns Hold Position (Wait order) as default order -->
  <!-- This patch detects when Hold Position is assigned to a ship that previously had a GT order -->
  
  <!-- ✅ PHASE 7: Add GT order detection in init block -->
  <!-- Add detection logic at the start of init block (after set_command) -->
  <add sel="//aiscript[@name='order.wait']/init/set_command_action[@commandaction='commandaction.standingby']" pos="after">
    
    <!-- ✅ PHASE 7: Detect GT order removal when Hold Position is assigned -->
    <!-- When GT order is removed, X4 assigns Hold Position as default order -->
    <!-- Check if this ship was previously registered with GT order -->
    <do_if value="global.$GT_Ship_State? and global.$GT_Ship_State.{this.assignedcontrolled}?">
      <set_value name="$state" exact="global.$GT_Ship_State.{this.assignedcontrolled}"/>
      
      <!-- If state says ship has GT order but ship now has Hold Position, GT order was removed -->
      <do_if value="$state.$HasGTOrder">
        <set_value name="$currentDefaultOrder" exact="@this.assignedcontrolled.defaultorder.id"/>
        
        <!-- Check if current default order is Hold Position (Wait) or another non-GT order -->
        <do_if value="$currentDefaultOrder != 'GalaxyTraderMK3'">
          <debug_text text="'[GT-State] Phase 7: ' + this.assignedcontrolled.idcode + ' - GT order removed (detected in Hold Position order, new default order: ' + (if $currentDefaultOrder then $currentDefaultOrder else 'NONE') + ')'" chance="100"/>
          
          <!-- Update state to reflect GT order cancellation -->
          <set_value name="$state.$HasGTOrder" exact="false"/>
          <set_value name="$state.$OperationalState" exact="'orphaned'"/>
          <set_value name="$state.$ActiveTradeOrders" exact="0"/>
          
          <!-- Determine subordinate state -->
          <set_value name="$hasCommander" exact="false"/>
          <do_if value="this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists and this.assignedcontrolled.commander != this.assignedcontrolled">
            <set_value name="$hasCommander" exact="true"/>
            <set_value name="$state.$Commander" exact="this.assignedcontrolled.commander"/>
            
            <!-- Check if commander has GT order -->
            <set_value name="$commanderHasGT" exact="false"/>
            <do_if value="this.assignedcontrolled.commander.defaultorder? and @this.assignedcontrolled.commander.defaultorder.id == 'GalaxyTraderMK3'">
              <set_value name="$commanderHasGT" exact="true"/>
            </do_if>
            <set_value name="$state.$CommanderHasGT" exact="$commanderHasGT"/>
            
            <do_if value="$commanderHasGT">
              <set_value name="$state.$SubordinateState" exact="'subordinate'"/>
            </do_if>
            <do_else>
              <set_value name="$state.$SubordinateState" exact="'orphaned'"/>
            </do_else>
          </do_if>
          <do_else>
            <set_value name="$state.$Commander" exact="null"/>
            <set_value name="$state.$CommanderHasGT" exact="false"/>
            <set_value name="$state.$SubordinateState" exact="'orphaned'"/>
          </do_else>
          
          <set_value name="$state.$LastStateUpdate" exact="player.age"/>
          
          <!-- ✅ NAME RESTORATION: Restore ship name if not GT-controlled (direct or subordinate) -->
          <set_value name="$needsNameRestore" exact="false"/>
          <!-- Check if ship is subordinate to GT commander -->
          <set_value name="$isSubordinateOfGTCommander" exact="false"/>
          <do_if value="this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists and this.assignedcontrolled.commander != this.assignedcontrolled">
            <do_if value="this.assignedcontrolled.commander.defaultorder? and @this.assignedcontrolled.commander.defaultorder.id == 'GalaxyTraderMK3'">
              <set_value name="$isSubordinateOfGTCommander" exact="true"/>
            </do_if>
          </do_if>
          
          <!-- Restore name if ship is not GT-controlled (no direct GT order and not subordinate to GT commander) -->
          <do_if value="not $isSubordinateOfGTCommander">
            <set_value name="$needsNameRestore" exact="true"/>
          </do_if>
          
          <do_if value="$needsNameRestore and this.assignedcontrolled.pilot?">
            <set_value name="$originalName" exact="null"/>
            <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.assignedcontrolled.pilot}? and global.$GT_Pilots.{this.assignedcontrolled.pilot}.$OriginalShipName?">
              <set_value name="$originalName" exact="global.$GT_Pilots.{this.assignedcontrolled.pilot}.$OriginalShipName"/>
            </do_if>
            <do_elseif value="$state.$OriginalShipName?">
              <set_value name="$originalName" exact="$state.$OriginalShipName"/>
            </do_elseif>
            
            <do_if value="$originalName">
              <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
                $Ship = this.assignedcontrolled,
                $Pilot = this.assignedcontrolled.pilot,
                $Reason = 'GT order removed - restoring original name',
                $OriginalName = $originalName
              ]"/>
              <debug_text text="'[GT-State] Phase 7: Name restoration signal sent for ' + this.assignedcontrolled.idcode + ' (original name: ' + $originalName + ')'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
      </do_if>
    </do_if>
    
  </add>
</diff>
