<?xml version="1.0" encoding="utf-8"?>
<aiscript name="lib.gt.pathfinding" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/aiscripts.xsd" version="1">
  <params>
    <param name="ship" default="this.ship"/>
    <param name="homeSector" default="this.ship.sector"/>
    <param name="maxDistance" default="0"/>
    <param name="blacklistGroup" default="null"/>
    <param name="debugchance" default="0"/>
  </params>
  <attention min="unknown">
    <actions>
      <run_script name="'lib.find.sectors.inrange'" result="$spaces">
        <param name="refobject" value="$homeSector"/>
        <param name="mingatedistance" value="0"/>
        <param name="maxgatedistance" value="$maxDistance"/>
        <param name="applyblacklist" value="true"/>
        <param name="blacklistgroup" value="$blacklistGroup"/>
        <param name="returndistancetable" value="false"/>
        <param name="debugchance" value="$debugchance"/>
      </run_script>

      <do_if value="not $spaces?">
        <set_value name="$spaces" exact="[]"/>
      </do_if>

      <!-- Filter out threat-blacklisted sectors -->
      <do_if value="$spaces.count gt 0 and global.$GT_ThreatIntelligence? and global.$GT_ThreatIntelligence.$BlacklistedSectors? and global.$GT_ThreatIntelligence.$BlacklistedSectors.count gt 0">
        <create_list name="$filteredSpaces"/>
        <do_all exact="$spaces.count" counter="$si">
          <set_value name="$sector" exact="$spaces.{$si}"/>
          <set_value name="$isThreatened" exact="false"/>
          <do_all exact="global.$GT_ThreatIntelligence.$BlacklistedSectors.count" counter="$bli">
            <do_if value="global.$GT_ThreatIntelligence.$BlacklistedSectors.{$bli} == $sector">
              <set_value name="$isThreatened" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          <do_if value="not $isThreatened">
            <append_to_list name="$filteredSpaces" exact="$sector"/>
          </do_if>
        </do_all>
        <set_value name="$spaces" exact="$filteredSpaces"/>
      </do_if>

      <set_value name="$result" exact="table[
        $BuySpaces = $spaces,
        $SellSpaces = $spaces,
        $ShipIsIsolated = ($spaces.count == 0)
      ]"/>
      <return value="$result"/>
    </actions>
  </attention>
</aiscript>
