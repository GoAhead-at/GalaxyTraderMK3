<?xml version="1.0" encoding="utf-8"?>
<diff>
  <!-- GalaxyTrader MK3: Restock (Resupply) completion signalling patch -->
  <!-- This patch adds completion signalling to notify the GT system when resupply is complete -->
  
  <!-- ========================================================================= -->
  <!-- COMPLETION SIGNALING: Notify GT system when Restock/Resupply completes  -->
  <!-- ========================================================================= -->
  <add sel="//aiscript[@name='order.restock']/attention[@min='unknown']" pos="after">
    <on_abort>
      <!-- PERFORMANCE FIX: Early exit check BEFORE any logging or property lookups -->
      <!-- If ship is not GT-controlled, exit immediately to prevent stutter -->
      <set_value name="$isGTControlled" exact="false"/>
      
      <!-- Quick check: Does ship have direct GT order? -->
      <do_if value="this.ship.defaultorder? and (@this.ship.defaultorder.id == 'GalaxyTraderMK3' or @this.ship.defaultorder.id == 'GalaxyTraderMK2' or @this.ship.defaultorder.id == 'GalaxyTraderMK1' or @this.ship.defaultorder.id == 'GalaxyMiner')">
        <set_value name="$isGTControlled" exact="true"/>
      </do_if>
      
      <!-- Fallback check: Is ship subordinate to GT commander? -->
      <do_if value="not $isGTControlled and this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
        <do_if value="this.ship.commander.defaultorder? and (@this.ship.commander.defaultorder.id == 'GalaxyTraderMK3' or @this.ship.commander.defaultorder.id == 'GalaxyTraderMK2' or @this.ship.commander.defaultorder.id == 'GalaxyTraderMK1' or @this.ship.commander.defaultorder.id == 'GalaxyMiner')">
          <set_value name="$isGTControlled" exact="true"/>
        </do_if>
      </do_if>
      
      <!-- EARLY EXIT: If ship is not GT-controlled, exit immediately without any processing -->
      <do_if value="not $isGTControlled">
        <!-- Ship is not GT-controlled - no signals needed, exit silently -->
        <!-- This prevents stutter from constant property lookups for non-GT ships -->
        <return/>
      </do_if>
      
      <!-- Ship IS GT-controlled - proceed with completion signaling -->
      <!-- CRITICAL: Check if GT order is still active before sending signals -->
      <!-- Resupply order can abort normally (completion) - only send signals if GT order is still active -->
      <set_value name="$hasDirectGTOrder" exact="false"/>
      <do_if value="this.ship.defaultorder? and (@this.ship.defaultorder.id == 'GalaxyTraderMK3' or @this.ship.defaultorder.id == 'GalaxyTraderMK2' or @this.ship.defaultorder.id == 'GalaxyTraderMK1' or @this.ship.defaultorder.id == 'GalaxyMiner')">
        <set_value name="$hasDirectGTOrder" exact="true"/>
      </do_if>
      
      <set_value name="$hasGTCommander" exact="false"/>
      <do_if value="not $hasDirectGTOrder and this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
        <do_if value="this.ship.commander.defaultorder? and (@this.ship.commander.defaultorder.id == 'GalaxyTraderMK3' or @this.ship.commander.defaultorder.id == 'GalaxyTraderMK2' or @this.ship.commander.defaultorder.id == 'GalaxyTraderMK1' or @this.ship.commander.defaultorder.id == 'GalaxyMiner')">
          <set_value name="$hasGTCommander" exact="true"/>
        </do_if>
      </do_if>
      
      <!-- Signal completion to GalaxyTrader system if this is a GT ship AND GT order is still active -->
      <do_if value="this.ship.pilot and this.ship.isplayerowned and global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and ($hasDirectGTOrder or $hasGTCommander)">
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Restock] Restock/Resupply complete for ' + this.ship.idcode" chance="100"/>
        </do_if>
        
        <!-- LOGGING: Show what was actually restocked when order finishes -->
        <set_value name="$resupplyOrder" exact="@global.$GT_ResupplyOrders.{this.ship}"/>
        <do_if value="$resupplyOrder?">
          <!-- Get "before" values from resupply order tracking -->
          <set_value name="$beforeCM" exact="@$resupplyOrder.$CountermeasuresBefore"/>
          <set_value name="$beforeUnits" exact="@$resupplyOrder.$UnitsBefore"/>
          <set_value name="$beforeDefenseDrones" exact="@$resupplyOrder.$DefenseDronesBefore"/>
          <set_value name="$beforeCargoDrones" exact="@$resupplyOrder.$CargoDronesBefore"/>
          <set_value name="$beforeLaserTowers" exact="@$resupplyOrder.$LaserTowersBefore"/>
          <set_value name="$beforeRepairDrones" exact="@$resupplyOrder.$RepairDronesBefore"/>
          
          <!-- Get current values -->
          <set_value name="$currentCM" exact="this.ship.ammostorage.countermeasure.count"/>
          <set_value name="$currentUnits" exact="this.ship.units.count"/>
          <set_value name="$currentDefenseDrones" exact="this.ship.units.{macro.ship_gen_s_fightingdrone_01_a_macro}.count"/>
          <set_value name="$currentCargoDrones" exact="this.ship.units.{macro.ship_gen_xs_cargodrone_empty_01_a_macro}.count"/>
          <set_value name="$currentLaserTowers" exact="this.ship.units.{macro.ship_gen_xs_lasertower_01_a_macro}.count"/>
          <set_value name="$currentRepairDrones" exact="this.ship.units.{macro.ship_gen_xs_repairdrone_01_a_macro}.count"/>
          
          <!-- Calculate what was gained -->
          <set_value name="$cmGained" exact="$currentCM - $beforeCM"/>
          <set_value name="$defenseGained" exact="$currentDefenseDrones - $beforeDefenseDrones"/>
          <set_value name="$cargoGained" exact="$currentCargoDrones - $beforeCargoDrones"/>
          <set_value name="$towersGained" exact="$currentLaserTowers - $beforeLaserTowers"/>
          <set_value name="$repairGained" exact="$currentRepairDrones - $beforeRepairDrones"/>
          <set_value name="$unitsGained" exact="$currentUnits - $beforeUnits"/>
          
          <!-- Build summary of what was restocked -->
          <set_value name="$restockedItems" exact="[]"/>
          <do_if value="$cmGained gt 0">
            <append_to_list name="$restockedItems" exact="'CM +' + $cmGained"/>
          </do_if>
          <do_if value="$defenseGained gt 0">
            <append_to_list name="$restockedItems" exact="'Defense Drones +' + $defenseGained"/>
          </do_if>
          <do_if value="$cargoGained gt 0">
            <append_to_list name="$restockedItems" exact="'Cargo Drones +' + $cargoGained"/>
          </do_if>
          <do_if value="$towersGained gt 0">
            <append_to_list name="$restockedItems" exact="'Laser Towers +' + $towersGained"/>
          </do_if>
          <do_if value="$repairGained gt 0">
            <append_to_list name="$restockedItems" exact="'Repair Drones +' + $repairGained"/>
          </do_if>
          
          <set_value name="$restockedSummary" exact="if $restockedItems.count gt 0 then $restockedItems.{1} + (if $restockedItems.count gt 1 then ', ' + $restockedItems.{2} else '') + (if $restockedItems.count gt 2 then ', ' + $restockedItems.{3} else '') + (if $restockedItems.count gt 3 then ', ' + $restockedItems.{4} else '') + (if $restockedItems.count gt 4 then ', ' + $restockedItems.{5} else '') else 'NOTHING'"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Restock] RESTOCKED for ' + this.ship.idcode + ': ' + $restockedSummary" chance="100"/>
            <debug_text text="'[GT-Restock] DETAILED RESTOCK for ' + this.ship.idcode + ':'" chance="100"/>
            <debug_text text="'[GT-Restock]   Countermeasures: ' + $beforeCM + ' ' + $currentCM + ' (gained: ' + $cmGained + ')'" chance="100"/>
            <debug_text text="'[GT-Restock]   Defense Drones: ' + $beforeDefenseDrones + ' ' + $currentDefenseDrones + ' (gained: ' + $defenseGained + ')'" chance="100"/>
            <debug_text text="'[GT-Restock]   Cargo Drones: ' + $beforeCargoDrones + ' ' + $currentCargoDrones + ' (gained: ' + $cargoGained + ')'" chance="100"/>
            <debug_text text="'[GT-Restock]   Laser Towers: ' + $beforeLaserTowers + ' ' + $currentLaserTowers + ' (gained: ' + $towersGained + ')'" chance="100"/>
            <debug_text text="'[GT-Restock]   Repair Drones: ' + $beforeRepairDrones + ' ' + $currentRepairDrones + ' (gained: ' + $repairGained + ')'" chance="100"/>
            <debug_text text="'[GT-Restock]   Total Units: ' + $beforeUnits + ' ' + $currentUnits + ' (gained: ' + $unitsGained + ')'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Queue completion notification -->
        <do_if value="not global.$GT_ResupplyCompleteQueue?">
          <set_value name="global.$GT_ResupplyCompleteQueue" exact="[]"/>
        </do_if>
        
        <append_to_list name="global.$GT_ResupplyCompleteQueue" exact="table[
          $ship = this.ship,
          $time = player.age
        ]"/>
        
        <!-- EVENT-DRIVEN: Signal MD cue directly (no polling needed) -->
        <signal_objects object="player.galaxy" param="'GT_ResupplyComplete'"/>
      </do_if>
      <do_else>
        <!-- Edge case: GT-controlled ship lost GT order during resupply -->
        <!-- This is rare, so reduce logging chance -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Restock] ' + this.ship.idcode + ': Resupply order aborted but GT order no longer active - skipping signals'" chance="10"/>
        </do_if>
      </do_else>
    </on_abort>
  </add>
  
</diff>
