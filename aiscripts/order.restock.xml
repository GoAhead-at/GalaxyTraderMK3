<?xml version="1.0" encoding="utf-8"?>
<diff>
  <!-- GalaxyTrader MK3: Restock (Resupply) completion signalling patch -->
  <!-- This patch adds completion signalling to notify the GT system when resupply is complete -->
  
  <!-- ========================================================================= -->
  <!-- COMPLETION SIGNALING: Notify GT system when Restock/Resupply completes  -->
  <!-- ========================================================================= -->
  <add sel="//aiscript[@name='order.restock']/attention[@min='unknown']" pos="after">
    <on_abort>
      <!-- Signal completion to GalaxyTrader system if this is a GT ship -->
      <do_if value="this.ship.pilot and this.ship.isplayerowned and global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}?">
        <debug_text text="'[GT-Restock] âœ… Restock/Resupply complete for ' + this.ship.idcode" chance="100"/>
        
        <!-- Queue completion notification -->
        <do_if value="not global.$GT_ResupplyCompleteQueue?">
          <set_value name="global.$GT_ResupplyCompleteQueue" exact="[]"/>
        </do_if>
        
        <append_to_list name="global.$GT_ResupplyCompleteQueue" exact="table[
          $ship = this.ship,
          $time = player.age
        ]"/>
        
        <!-- Set pending flag to trigger processing -->
        <set_value name="global.$GT_ResupplyCompletePending" exact="true"/>
      </do_if>
    </on_abort>
  </add>
  
</diff>
