<?xml version="1.0" encoding="utf-8"?>
<!--
  GalaxyTrader MK1 — Station Trader
  
  Sell-only station trader. Ships assigned to a player station pick up products
  and tradewares and sell them to NPC buyers. Supports multi-ware loading with
  a no-backtrack rule, trade rule bypass, and full GT system integration.
  
  See: DOCS/SPEC/OPEN_GALAXYTRADER_MK1_STATION_TRADER.md
-->
<aiscript name="order.trade.galaxytraderMK1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/aiscripts.xsd" version="1">
  <order id="GalaxyTraderMK1" name="{77000, 30002}" description="{77000, 30102}" category="trade" infinite="true" allowinloop="false" canplayercancel="true">
    <params>
      <!-- Home Station (required — must be player-owned station) -->
      <param name="homeStation" type="object" default="null" text="{77000, 30010}" comment="{77000, 30110}">
        <input_param name="class" value="[class.station]"/>
      </param>

      <!-- Max Sell Distance (skill-gated; MK1 commander is always station so use pilot only) -->
      <param name="maxsell" default="[if @this.ship.pilot.skill.management le 2 then 1 else if @this.ship.pilot.skill.management le 5 then 3 else if @this.ship.pilot.skill.management le 8 then 5 else if @this.ship.pilot.skill.management le 11 then 10 else if @this.ship.pilot.skill.management le 13 then 15 else 25, 1].max" type="number" text="{77000, 30011}" comment="{77000, 30111}">
        <input_param name="startvalue" value="0"/>
        <input_param name="min" value="0"/>
        <input_param name="max" value="[if @this.ship.pilot.skill.management le 2 then 1 else if @this.ship.pilot.skill.management le 5 then 3 else if @this.ship.pilot.skill.management le 8 then 5 else if @this.ship.pilot.skill.management le 11 then 10 else if @this.ship.pilot.skill.management le 13 then 15 else 25, 1].max"/>
        <input_param name="step" value="1"/>
      </param>

      <!-- Trade Rule Bypass -->
      <param name="ignoretraderules" default="false" type="bool" text="{77000, 30012}" comment="{77000, 30112}"/>

      <!-- Allow Illegal Wares -->
      <param name="allowillegal" default="false" type="bool" text="{77000, 30016}" comment="{77000, 30116}"/>

      <!-- Ware Filter (empty = auto-derive from station) -->
      <param name="warebasket" default="[]" type="list" text="{77000, 30013}" comment="{77000, 30113}">
        <input_param name="type" value="'ware'"/>
        <input_param name="cancarry" value="this.ship"/>
      </param>

      <!-- Cargo Fill Target -->
      <param name="cargotarget" default="90" type="number" text="{77000, 30014}" comment="{77000, 30114}">
        <input_param name="min" value="50"/>
        <input_param name="max" value="100"/>
        <input_param name="step" value="5"/>
      </param>

      <!-- Backtrack Tolerance (extra jumps for multi-ware) -->
      <param name="backtrackTolerance" default="1" type="number" text="{77000, 30015}" comment="{77000, 30115}">
        <input_param name="min" value="0"/>
        <input_param name="max" value="5"/>
        <input_param name="step" value="1"/>
      </param>

      <!-- Logbook Entries -->
      <param name="logbookentries" default="true" type="bool" text="{77000, 30017}" comment="{77000, 30117}"/>

      <!-- Notification Level -->
      <param name="notifications" default="1" type="number" text="{77000, 30018}" comment="{77000, 30118}">
        <input_param name="min" value="0"/>
        <input_param name="max" value="2"/>
        <input_param name="step" value="1"/>
      </param>

      <!-- Fleet Coordination -->
      <param name="fleetcoordination" default="true" type="bool" text="{77000, 30019}" comment="{77000, 30119}" advanced="true"/>

      <!-- Debug Level -->
      <param name="debuglevel" default="1" type="number" text="{77000, 30020}" comment="{77000, 30120}" advanced="true">
        <input_param name="min" value="0"/>
        <input_param name="max" value="2"/>
        <input_param name="step" value="1"/>
      </param>
    </params>
    <requires>
      <match shiptype="shiptype.lasertower" negate="true"/>
    </requires>
  </order>

  <interrupts>
    <handler ref="SectorChangeHandler"/>
    <handler ref="AttackHandler"/>
    <handler ref="MissileLockHandler"/>
    <handler ref="ScannedHandler"/>
    <handler ref="InspectedHandler"/>
    <handler ref="FoundAbandonedHandler"/>
    <handler ref="FoundLockboxHandler"/>
    <handler ref="ResupplyHandler"/>
    <handler ref="TargetInvalidHandler"/>
    <handler ref="TideHandler"/>
  </interrupts>

  <init>
    <!-- ================================================================ -->
    <!-- MK1 INITIALIZATION                                               -->
    <!-- ================================================================ -->
    <set_value name="$debugchance" exact="if $debuglevel ge 1 then 100 else 0"/>

    <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': === MK1 INIT STARTED === (Ship: ' + this.ship.knownname + ', Pilot: ' + @this.ship.pilot.knownname + ')'" chance="$debugchance"/>

    <!-- Validate home station -->
    <do_if value="not $homeStation? or not $homeStation.exists or not $homeStation.isclass.station">
      <show_notification text="'GalaxyTrader MK1: ' + {77000, 30204}" timeout="10s"/>
      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': ABORT — no valid station assigned'" chance="100"/>
      <set_command_action commandaction="commandaction.standingby"/>
      <return/>
    </do_if>

    <do_if value="not $homeStation.isplayerowned">
      <show_notification text="'GalaxyTrader MK1: ' + {77000, 30203}.[$homeStation.knownname]" timeout="10s"/>
      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': ABORT — station not player-owned: ' + $homeStation.knownname" chance="100"/>
      <set_command_action commandaction="commandaction.standingby"/>
      <return/>
    </do_if>

    <!-- Station assignment: assign ship as subordinate of the station -->
    <do_if value="this.ship.commander != $homeStation">
      <do_if value="this.ship.commander.exists and this.ship.commander != this.ship">
        <remove_object_commander object="this.ship"/>
      </do_if>
      <set_object_commander object="this.ship" commander="$homeStation" assignment="assignment.trade"/>
      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Assigned to station ' + $homeStation.knownname + ' as trade subordinate'" chance="$debugchance"/>
    </do_if>

    <!-- Store effective values -->
    <set_value name="this.$homeStation" exact="$homeStation"/>
    <set_value name="this.$maxsell" exact="$maxsell"/>
    <set_value name="this.$ignoretraderules" exact="$ignoretraderules"/>
    <set_value name="this.$allowillegal" exact="$allowillegal"/>
    <set_value name="this.$warebasket" exact="$warebasket"/>
    <set_value name="this.$cargotarget" exact="$cargotarget"/>
    <set_value name="this.$backtrackTolerance" exact="$backtrackTolerance"/>
    <set_value name="this.$logbookentries" exact="$logbookentries"/>
    <set_value name="this.$notifications" exact="$notifications"/>
    <set_value name="this.$fleetcoordination" exact="$fleetcoordination"/>
    <set_value name="this.$debuglevel" exact="$debuglevel"/>
    <set_value name="this.$debugchance" exact="$debugchance"/>

    <!-- Wait time when no trades found (from global settings or default 60s) -->
    <set_value name="this.$waitTimeNoTrades" exact="if global.$GT_MK1_GlobalSettings.$StationTrader.$WaitTimeNoTrades? then global.$GT_MK1_GlobalSettings.$StationTrader.$WaitTimeNoTrades else 60s"/>

    <set_command_action commandaction="commandaction.searchingtrades"/>

    <!-- Signal MD: ship registered as MK1 station trader -->
    <signal_objects object="player.galaxy" param="'GT_AI_Started'" param2="table[
      $Ship = this.ship,
      $Config = table[
        $allowillegal = $allowillegal,
        $debuglevel = $debuglevel,
        $orderType = 'MK1'
      ]
    ]"/>

    <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': === MK1 INIT COMPLETE === Home: ' + $homeStation.knownname + ', MaxSell: ' + $maxsell + ', IgnoreRules: ' + $ignoretraderules" chance="$debugchance"/>
  </init>

  <attention min="unknown">
    <actions>

      <!-- ================================================================ -->
      <!-- MK1 MAIN LOOP                                                    -->
      <!-- ================================================================ -->
      <label name="main_loop"/>

      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': === MAIN LOOP START ==='" chance="this.$debugchance"/>

      <!-- ============================================================== -->
      <!-- STEP 1: Validate station still exists and is player-owned      -->
      <!-- ============================================================== -->
      <do_if value="not this.$homeStation.exists">
        <do_if value="this.$notifications ge 1">
          <show_notification text="'GalaxyTrader MK1: ' + {77000, 30202}.['(destroyed)']" timeout="10s"/>
        </do_if>
        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': ABORT — home station destroyed'" chance="100"/>
        <set_command_action commandaction="commandaction.standingby"/>
        <return/>
      </do_if>

      <do_if value="not this.$homeStation.isplayerowned">
        <do_if value="this.$notifications ge 1">
          <show_notification text="'GalaxyTrader MK1: ' + {77000, 30203}.[this.$homeStation.knownname]" timeout="10s"/>
        </do_if>
        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': ABORT — station no longer player-owned'" chance="100"/>
        <set_command_action commandaction="commandaction.standingby"/>
        <return/>
      </do_if>

      <!-- Refresh params from order in case player changed them -->
      <do_if value="this.ship.defaultorder? and this.ship.defaultorder.id == 'GalaxyTraderMK1'">
        <set_value name="this.$maxsell" exact="this.ship.defaultorder.$maxsell"/>
        <set_value name="this.$ignoretraderules" exact="this.ship.defaultorder.$ignoretraderules"/>
        <set_value name="this.$allowillegal" exact="this.ship.defaultorder.$allowillegal"/>
        <set_value name="this.$warebasket" exact="this.ship.defaultorder.$warebasket"/>
        <set_value name="this.$cargotarget" exact="this.ship.defaultorder.$cargotarget"/>
        <set_value name="this.$backtrackTolerance" exact="this.ship.defaultorder.$backtrackTolerance"/>
        <set_value name="this.$logbookentries" exact="this.ship.defaultorder.$logbookentries"/>
        <set_value name="this.$notifications" exact="this.ship.defaultorder.$notifications"/>
        <set_value name="this.$fleetcoordination" exact="this.ship.defaultorder.$fleetcoordination"/>
        <set_value name="this.$debuglevel" exact="this.ship.defaultorder.$debuglevel"/>
        <set_value name="this.$debugchance" exact="if this.$debuglevel ge 1 then 100 else 0"/>
      </do_if>

      <!-- ============================================================== -->
      <!-- STEP 2: Maintenance check (shared GT system)                   -->
      <!-- ============================================================== -->
      <signal_objects object="player.galaxy" param="'GT_Check_Maintenance'" param2="table[$Ship = this.ship]"/>
      <wait exact="1ms" comment="Cooperative yield"/>

      <!-- ============================================================== -->
      <!-- STEP 3: Handle leftover cargo from interrupted trades          -->
      <!-- ============================================================== -->
      <set_value name="$hasLeftoverCargo" exact="this.ship.cargo.count gt 0"/>
      <do_if value="$hasLeftoverCargo">
        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Leftover cargo detected — selling at nearest buyer'" chance="this.$debugchance"/>

        <!-- Build sector list for leftover cargo clearance -->
        <create_list name="$clearSectors"/>
        <append_to_list name="$clearSectors" exact="this.ship.sector"/>
        <do_if value="this.$maxsell gt 0">
          <find_sector name="$clearNearbySectors" space="player.galaxy" multiple="true">
            <match_gate_distance object="this.ship.sector" min="0" max="this.$maxsell"/>
          </find_sector>
          <do_if value="$clearNearbySectors? and $clearNearbySectors.count gt 0">
            <do_all exact="$clearNearbySectors.count" counter="$csi">
              <do_if value="$clearNearbySectors.{$csi} != this.ship.sector">
                <append_to_list name="$clearSectors" exact="$clearNearbySectors.{$csi}"/>
              </do_if>
            </do_all>
          </do_if>
        </do_if>

        <!-- For each ware in cargo, find nearest NPC buyer and sell -->
        <set_value name="$cargoWares" exact="this.ship.cargo.list"/>
        <do_all exact="$cargoWares.count" counter="$ci">
          <set_value name="$cWare" exact="$cargoWares.{$ci}"/>
          <set_value name="$cAmount" exact="this.ship.cargo.{$cWare}.count"/>
          <do_if value="$cAmount gt 0">
            <!-- Find nearest buyer for this ware across sectors in range -->
            <set_value name="$clearBuyOffer" exact="null"/>
            <do_all exact="$clearSectors.count" counter="$csi">
              <find_buy_offer wares="$cWare" space="$clearSectors.{$csi}" result="$secClearOffer">
                <match_buyer tradesknownto="this.ship.owner" owner="faction.player" negateownerfilter="true">
                  <match_relation_to object="this.ship" relation="dock" comparison="ge"/>
                  <match_relation_to faction="this.ship.owner" relation="enemy" comparison="not"/>
                </match_buyer>
                <amount min="1"/>
              </find_buy_offer>
              <do_if value="$secClearOffer.available">
                <set_value name="$clearBuyOffer" exact="$secClearOffer"/>
                <break/>
              </do_if>
            </do_all>
            <do_if value="$clearBuyOffer? and $clearBuyOffer != null and $clearBuyOffer.available">
              <set_value name="$clearAmount" exact="[$cAmount, $clearBuyOffer.amount].min"/>
              <create_trade_order object="this.ship" tradeoffer="$clearBuyOffer" amount="$clearAmount" immediate="true" internal="false"/>
              <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Clearing leftover ' + $clearAmount + ' ' + $cWare.name + ' at ' + $clearBuyOffer.owner.knownname" chance="this.$debugchance"/>
              <wait exact="1ms" comment="Cooperative yield"/>
            </do_if>
          </do_if>
        </do_all>

        <!-- Wait for trade orders to execute -->
        <do_if value="this.ship.orders.count gt 0">
          <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Waiting for leftover cargo clearance...'" chance="this.$debugchance"/>
          <wait>
            <interrupt>
              <conditions>
                <event_object_order_ready object="this.ship"/>
              </conditions>
            </interrupt>
          </wait>
        </do_if>
      </do_if>

      <!-- ============================================================== -->
      <!-- STEP 4: Build effective ware basket from station               -->
      <!-- ============================================================== -->
      <set_command_action commandaction="commandaction.searchingtrades"/>

      <!-- Inline: Build effective ware basket from station products/tradewares -->
      <create_list name="$effectiveWares"/>
      <create_list name="$candidateWares"/>

      <do_if value="this.$warebasket? and this.$warebasket.count gt 0">
        <!-- Manual filter: use only user-specified wares -->
        <do_all exact="this.$warebasket.count" counter="$wi">
          <append_to_list name="$candidateWares" exact="this.$warebasket.{$wi}"/>
        </do_all>
      </do_if>
      <do_else>
        <!-- Auto-derive: station products + tradewares -->
        <set_value name="$stationProducts" exact="this.$homeStation.products.list"/>
        <set_value name="$stationTradewares" exact="this.$homeStation.tradewares.list"/>

        <do_all exact="$stationProducts.count" counter="$pi">
          <set_value name="$pw" exact="$stationProducts.{$pi}"/>
          <set_value name="$dupCheck" exact="false"/>
          <do_all exact="$candidateWares.count" counter="$dci">
            <do_if value="$candidateWares.{$dci} == $pw">
              <set_value name="$dupCheck" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          <do_if value="not $dupCheck">
            <append_to_list name="$candidateWares" exact="$pw"/>
          </do_if>
        </do_all>

        <do_all exact="$stationTradewares.count" counter="$ti">
          <set_value name="$tw" exact="$stationTradewares.{$ti}"/>
          <set_value name="$dupCheck" exact="false"/>
          <do_all exact="$candidateWares.count" counter="$dci">
            <do_if value="$candidateWares.{$dci} == $tw">
              <set_value name="$dupCheck" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          <do_if value="not $dupCheck">
            <append_to_list name="$candidateWares" exact="$tw"/>
          </do_if>
        </do_all>
      </do_else>

      <!-- Filter candidates: cargo compatibility, processed, illegal -->
      <do_all exact="$candidateWares.count" counter="$fi">
        <set_value name="$fw" exact="$candidateWares.{$fi}"/>
        <do_if value="this.ship.cargo.{$fw}.max le 0">
          <continue/>
        </do_if>
        <do_if value="$fw.isprocessed">
          <continue/>
        </do_if>
        <do_if value="not this.$allowillegal and $fw.illegal">
          <continue/>
        </do_if>
        <append_to_list name="$effectiveWares" exact="$fw"/>
      </do_all>

      <do_if value="$effectiveWares.count == 0">
        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': No wares available from station — waiting ' + this.$waitTimeNoTrades" chance="this.$debugchance"/>
        <wait exact="this.$waitTimeNoTrades"/>
        <resume label="main_loop"/>
      </do_if>

      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Effective ware basket: ' + $effectiveWares.count + ' wares'" chance="this.$debugchance"/>

      <!-- ============================================================== -->
      <!-- STEP 5: Find best sale opportunity                             -->
      <!-- ============================================================== -->
      <!-- Inline: Find best NPC buyer(s) for station wares -->
      <set_value name="$bestTrade" exact="null"/>
      <create_list name="$allTrades"/>
      <set_value name="$bestScore" exact="0"/>

      <!-- Build sector search list -->
      <create_list name="$searchSectors"/>
      <append_to_list name="$searchSectors" exact="this.$homeStation.sector"/>
      <do_if value="this.$maxsell gt 0">
        <find_sector name="$nearbySectors" space="player.galaxy" multiple="true">
          <match_gate_distance object="this.$homeStation.sector" min="0" max="this.$maxsell"/>
        </find_sector>
        <do_if value="$nearbySectors? and $nearbySectors.count gt 0">
          <do_all exact="$nearbySectors.count" counter="$nsi">
            <do_if value="$nearbySectors.{$nsi} != this.$homeStation.sector">
              <append_to_list name="$searchSectors" exact="$nearbySectors.{$nsi}"/>
            </do_if>
          </do_all>
        </do_if>
      </do_if>

      <!-- For each ware, find sell offer from station and matching NPC buy offers -->
      <do_all exact="$effectiveWares.count" counter="$ewi">
        <set_value name="$ware" exact="$effectiveWares.{$ewi}"/>

        <!-- Get sell offer from home station (station sells -> ship buys from station) -->
        <find_sell_offer seller="this.$homeStation" wares="$ware" result="$stationSellOffer"/>
        <do_if value="not $stationSellOffer.available">
          <continue/>
        </do_if>
        <do_if value="$stationSellOffer.amount le 0">
          <continue/>
        </do_if>

        <!-- Find NPC buyers in each sector within range -->
        <create_list name="$buyOffers"/>
        <do_all exact="$searchSectors.count" counter="$ssi">
          <set_value name="$searchSec" exact="$searchSectors.{$ssi}"/>
          <do_if value="this.$ignoretraderules">
            <find_buy_offer wares="$ware" space="$searchSec" result="$secBuyOffers" multiple="true">
              <match_buyer tradesknownto="this.ship.owner" owner="faction.player" negateownerfilter="true">
                <match_relation_to object="this.ship" relation="dock" comparison="ge"/>
                <match_relation_to faction="this.ship.owner" relation="enemy" comparison="not"/>
              </match_buyer>
              <amount min="1"/>
            </find_buy_offer>
          </do_if>
          <do_else>
            <find_buy_offer wares="$ware" tradepartner="this.ship" space="$searchSec" result="$secBuyOffers" multiple="true">
              <match_buyer tradesknownto="this.ship.owner" owner="faction.player" negateownerfilter="true">
                <match_relation_to object="this.ship" relation="dock" comparison="ge"/>
                <match_relation_to faction="this.ship.owner" relation="enemy" comparison="not"/>
              </match_buyer>
              <amount min="1"/>
            </find_buy_offer>
          </do_else>
          <do_if value="$secBuyOffers? and $secBuyOffers.count gt 0">
            <do_all exact="$secBuyOffers.count" counter="$boi">
              <append_to_list name="$buyOffers" exact="$secBuyOffers.{$boi}"/>
            </do_all>
          </do_if>
        </do_all>

        <do_if value="$buyOffers.count == 0">
          <continue/>
        </do_if>

        <!-- Evaluate each buyer -->
        <do_all exact="$buyOffers.count" counter="$bi">
          <set_value name="$buyOffer" exact="$buyOffers.{$bi}"/>

          <do_if value="$buyOffer.amount le 0">
            <continue/>
          </do_if>

          <!-- Calculate tradeable amount -->
          <set_value name="$tradeAmount" exact="[$stationSellOffer.amount, $buyOffer.amount, this.ship.cargo.{$ware}.free].min"/>
          <do_if value="$tradeAmount le 0">
            <continue/>
          </do_if>

          <!-- Calculate profit -->
          <set_value name="$unitProfit" exact="$buyOffer.unitprice - $stationSellOffer.unitprice"/>
          <do_if value="$unitProfit le 0">
            <continue/>
          </do_if>

          <!-- Get buyer station and distance -->
          <set_value name="$buyStation" exact="$buyOffer.owner"/>
          <set_value name="$buySector" exact="$buyStation.sector"/>
          <set_value name="$distance" exact="this.$homeStation.gatedistance.{$buyStation}"/>
          <do_if value="$distance lt 0">
            <continue/>
          </do_if>

          <!-- Check fleet reservation (if enabled) -->
          <do_if value="this.$fleetcoordination and global.$GT_TradeReservations?">
            <set_value name="$tradeKey" exact="'' + $ware + '_' + $buyStation"/>
            <set_value name="$isReserved" exact="false"/>
            <do_if value="global.$GT_TradeReservations.{$tradeKey}? and global.$GT_TradeReservations.{$tradeKey} != this.ship">
              <set_value name="$isReserved" exact="true"/>
            </do_if>
            <do_if value="$isReserved">
              <continue/>
            </do_if>
          </do_if>

          <!-- Check blacklist -->
          <do_if value="global.$GT_ThreatIntelligence? and global.$GT_ThreatIntelligence.$BlacklistedSectors?">
            <set_value name="$sectorBlacklisted" exact="false"/>
            <do_all exact="global.$GT_ThreatIntelligence.$BlacklistedSectors.count" counter="$bli">
              <do_if value="global.$GT_ThreatIntelligence.$BlacklistedSectors.{$bli} == $buySector">
                <set_value name="$sectorBlacklisted" exact="true"/>
                <break/>
              </do_if>
            </do_all>
            <do_if value="$sectorBlacklisted">
              <continue/>
            </do_if>
          </do_if>

          <!-- Score: (unitProfit * amount) / distancePenalty -->
          <set_value name="$distancePenalty" exact="1.0 + ($distance * 0.1)"/>
          <set_value name="$score" exact="($unitProfit * $tradeAmount) / $distancePenalty"/>

          <!-- Build trade entry -->
          <set_value name="$trade" exact="table[
            $Ware = $ware,
            $SellOffer = $stationSellOffer,
            $BuyOffer = $buyOffer,
            $Amount = $tradeAmount,
            $Score = $score,
            $BuyStation = $buyStation,
            $BuySector = $buySector,
            $Distance = $distance,
            $UnitProfit = $unitProfit
          ]"/>

          <append_to_list name="$allTrades" exact="$trade"/>

          <do_if value="$score gt $bestScore">
            <set_value name="$bestScore" exact="$score"/>
            <set_value name="$bestTrade" exact="$trade"/>
          </do_if>
        </do_all>

        <wait exact="1ms" comment="Cooperative yield between wares"/>
      </do_all>

      <do_if value="$bestTrade == null">
        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': No trades found — waiting ' + this.$waitTimeNoTrades" chance="this.$debugchance"/>
        <do_if value="this.$notifications ge 2">
          <show_notification text="'MK1 ' + this.ship.knownname + ': ' + {77000, 30201}.[this.$maxsell]" timeout="5s"/>
        </do_if>
        <wait exact="this.$waitTimeNoTrades"/>
        <resume label="main_loop"/>
      </do_if>

      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Best trade: ' + $bestTrade.$Ware.name + ' → ' + $bestTrade.$BuyStation.knownname + ' (score: ' + $bestTrade.$Score + ', amount: ' + $bestTrade.$Amount + ', dist: ' + $bestTrade.$Distance + ')'" chance="this.$debugchance"/>

      <!-- ============================================================== -->
      <!-- STEP 6: Multi-ware loading (no-backtrack rule)                 -->
      <!-- ============================================================== -->
      <create_list name="$deliveryRoute"/>
      <append_to_list name="$deliveryRoute" exact="$bestTrade"/>

      <!-- Calculate how full cargo will be after primary trade -->
      <set_value name="$primaryVolume" exact="$bestTrade.$Amount * $bestTrade.$Ware.volume"/>
      <set_value name="$cargoCapacity" exact="this.ship.cargo.capacity"/>
      <set_value name="$fillPercent" exact="if $cargoCapacity gt 0 then ($primaryVolume * 100 / $cargoCapacity) else 100"/>

      <do_if value="$fillPercent lt this.$cargotarget and $allTrades.count gt 1">
        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Cargo fill ' + $fillPercent + '% lt target ' + this.$cargotarget + '% — checking for secondary wares'" chance="this.$debugchance"/>

        <!-- Try to add up to 2 more wares (max 3 total) -->
        <set_value name="$additionalCount" exact="0"/>
        <do_all exact="$allTrades.count" counter="$ti">
          <do_if value="$additionalCount ge 2">
            <break/>
          </do_if>

          <set_value name="$candidateTrade" exact="$allTrades.{$ti}"/>

          <!-- Skip the primary trade -->
          <do_if value="$candidateTrade.$BuyStation == $bestTrade.$BuyStation and $candidateTrade.$Ware == $bestTrade.$Ware">
            <continue/>
          </do_if>

          <!-- Skip same ware (already loading it) -->
          <set_value name="$alreadyInRoute" exact="false"/>
          <do_all exact="$deliveryRoute.count" counter="$ri">
            <do_if value="$deliveryRoute.{$ri}.$Ware == $candidateTrade.$Ware">
              <set_value name="$alreadyInRoute" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          <do_if value="$alreadyInRoute">
            <continue/>
          </do_if>

          <!-- No-backtrack rule: is the secondary buyer "in line"? -->
          <!-- Check: distance from last buyer to new buyer vs distance from last buyer to home -->
          <set_value name="$lastBuyer" exact="$deliveryRoute.{$deliveryRoute.count}.$BuyStation"/>
          <set_value name="$distLastToNew" exact="$lastBuyer.gatedistance.{$candidateTrade.$BuyStation}"/>
          <set_value name="$distLastToHome" exact="$lastBuyer.gatedistance.{this.$homeStation}"/>

          <do_if value="$distLastToNew lt 0 or $distLastToHome lt 0">
            <continue/>
          </do_if>

          <do_if value="$distLastToNew gt ($distLastToHome + this.$backtrackTolerance)">
            <!-- Backtracking too much — skip -->
            <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Secondary ' + $candidateTrade.$Ware.name + ' → ' + $candidateTrade.$BuyStation.knownname + ' REJECTED (backtrack: ' + $distLastToNew + ' gt ' + ($distLastToHome + this.$backtrackTolerance) + ')'" chance="this.$debugchance"/>
            <continue/>
          </do_if>

          <!-- Check remaining cargo capacity -->
          <set_value name="$remainingCargo" exact="this.ship.cargo.{$candidateTrade.$Ware}.free"/>
          <set_value name="$secondaryAmount" exact="[$candidateTrade.$Amount, $remainingCargo].min"/>
          <do_if value="$secondaryAmount le 0">
            <continue/>
          </do_if>

          <!-- Update candidate amount and add to route -->
          <set_value name="$candidateTrade.$Amount" exact="$secondaryAmount"/>
          <append_to_list name="$deliveryRoute" exact="$candidateTrade"/>
          <set_value name="$additionalCount" operation="add"/>

          <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Added secondary: ' + $candidateTrade.$Ware.name + ' → ' + $candidateTrade.$BuyStation.knownname + ' (amount: ' + $secondaryAmount + ')'" chance="this.$debugchance"/>
        </do_all>
      </do_if>

      <do_if value="$deliveryRoute.count gt 1 and this.$notifications ge 2">
        <show_notification text="'MK1 ' + this.ship.knownname + ': ' + {77000, 30207}.[$deliveryRoute.count, $deliveryRoute.count]" timeout="5s"/>
      </do_if>

      <!-- ============================================================== -->
      <!-- STEP 7: Reserve trades (fleet coordination)                    -->
      <!-- ============================================================== -->
      <do_if value="this.$fleetcoordination and global.$GT_TradeReservations?">
        <do_all exact="$deliveryRoute.count" counter="$ri">
          <set_value name="$rt" exact="$deliveryRoute.{$ri}"/>
          <set_value name="$tradeKey" exact="'' + $rt.$Ware + '_' + $rt.$BuyStation"/>
          <set_value name="global.$GT_TradeReservations.{$tradeKey}" exact="this.ship"/>
        </do_all>
      </do_if>

      <!-- ============================================================== -->
      <!-- STEP 8: Fly to station and load wares                          -->
      <!-- ============================================================== -->
      <set_command_action commandaction="commandaction.flying"/>

      <!-- Create sell-side trade orders (ship buys FROM station = station sells TO ship) -->
      <do_all exact="$deliveryRoute.count" counter="$ri">
        <set_value name="$rt" exact="$deliveryRoute.{$ri}"/>
        <do_if value="$rt.$SellOffer.available">
          <set_value name="$loadAmount" exact="[$rt.$Amount, $rt.$SellOffer.amount].min"/>
          <do_if value="$loadAmount gt 0">
            <create_trade_order object="this.ship" tradeoffer="$rt.$SellOffer" amount="$loadAmount" immediate="true" internal="false"/>
            <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Loading ' + $loadAmount + ' ' + $rt.$Ware.name + ' from ' + this.$homeStation.knownname" chance="this.$debugchance"/>
          </do_if>
        </do_if>
      </do_all>

      <!-- Wait for loading to complete -->
      <wait exact="1ms" comment="Cooperative yield"/>

      <!-- ============================================================== -->
      <!-- STEP 9: Deliver to buyers (execute sell orders)                -->
      <!-- ============================================================== -->
      <set_command_action commandaction="commandaction.flying"/>

      <do_all exact="$deliveryRoute.count" counter="$ri">
        <set_value name="$rt" exact="$deliveryRoute.{$ri}"/>

        <!-- Re-validate buy offer (market may have changed while loading) -->
        <do_if value="$rt.$BuyOffer.available and $rt.$BuyOffer.amount gt 0">
          <set_value name="$sellAmount" exact="[this.ship.cargo.{$rt.$Ware}.count, $rt.$BuyOffer.amount].min"/>
          <do_if value="$sellAmount gt 0">
            <create_trade_order object="this.ship" tradeoffer="$rt.$BuyOffer" amount="$sellAmount" immediate="true" internal="false"/>
            <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Selling ' + $sellAmount + ' ' + $rt.$Ware.name + ' to ' + $rt.$BuyStation.knownname" chance="this.$debugchance"/>
          </do_if>
        </do_if>
      </do_all>

      <!-- Wait for all trade orders to execute -->
      <do_while value="this.ship.orders.count gt 0">
        <wait exact="5s">
          <interrupt>
            <conditions>
              <event_object_order_ready object="this.ship"/>
            </conditions>
          </interrupt>
        </wait>
      </do_while>

      <!-- ============================================================== -->
      <!-- STEP 10: Post-trade — log, XP, release reservations            -->
      <!-- ============================================================== -->

      <!-- Release fleet reservations -->
      <do_if value="this.$fleetcoordination and global.$GT_TradeReservations?">
        <do_all exact="$deliveryRoute.count" counter="$ri">
          <set_value name="$rt" exact="$deliveryRoute.{$ri}"/>
          <set_value name="$tradeKey" exact="'' + $rt.$Ware + '_' + $rt.$BuyStation"/>
          <do_if value="global.$GT_TradeReservations.{$tradeKey}? and global.$GT_TradeReservations.{$tradeKey} == this.ship">
            <remove_value name="global.$GT_TradeReservations.{$tradeKey}"/>
          </do_if>
        </do_all>
      </do_if>

      <!-- Logbook entry (via signal, same pattern as MK3) -->
      <do_if value="this.$logbookentries">
        <do_all exact="$deliveryRoute.count" counter="$ri">
          <set_value name="$rt" exact="$deliveryRoute.{$ri}"/>
          <set_value name="$logMsg" exact="'Sold ' + $rt.$Amount + ' ' + $rt.$Ware.name + ' to ' + $rt.$BuyStation.knownname + ' (distance: ' + $rt.$Distance + ' jumps)'"/>
          <signal_objects object="player.galaxy" param="'GT_WriteLogbook'" param2="table[
            $Message = $logMsg,
            $Category = 'upkeep',
            $Title = 'MK1 Sale: ' + $rt.$Ware.name,
            $Object = this.ship,
            $CheckGlobalSettings = false
          ]"/>
        </do_all>
      </do_if>

      <!-- Signal XP update (one per completed cycle, same as MK3) -->
      <do_if value="this.ship.pilot">
        <signal_objects object="player.galaxy" param="'GT_Update_Pilot_XP'" param2="table[
          $Ship = this.ship,
          $Pilot = this.ship.pilot
        ]"/>
      </do_if>

      <!-- Notification -->
      <do_if value="this.$notifications ge 1 and $deliveryRoute.count gt 0">
        <set_value name="$firstTrade" exact="$deliveryRoute.{1}"/>
        <show_notification text="'MK1 ' + this.ship.knownname + ': ' + {77000, 30206}.[$firstTrade.$Amount, $firstTrade.$Ware.name, $firstTrade.$BuyStation.knownname, ($firstTrade.$UnitProfit * $firstTrade.$Amount), ($firstTrade.$UnitProfit * $firstTrade.$Amount)]" timeout="5s"/>
      </do_if>

      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': === CYCLE COMPLETE === Delivered ' + $deliveryRoute.count + ' trades'" chance="this.$debugchance"/>

      <!-- Short yield before next cycle -->
      <wait exact="1ms" comment="Cooperative yield before next cycle"/>

      <!-- Loop back -->
      <resume label="main_loop"/>

    </actions>
  </attention>
</aiscript>
