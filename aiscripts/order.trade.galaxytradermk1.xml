<?xml version="1.0" encoding="utf-8"?>
<!--
  GalaxyTrader MK1 — Station Trader
  
  Sell-only station trader. Ships assigned to a player station pick up products
  and tradewares and sell them to NPC buyers. Supports multi-ware loading with
  a no-backtrack rule, trade rule bypass, and full GT system integration.
  
  See: DOCS/SPEC/OPEN_GALAXYTRADER_MK1_STATION_TRADER.md
-->
<aiscript name="order.trade.galaxytraderMK1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/aiscripts.xsd" version="1">
  <order id="GalaxyTraderMK1" name="{77000, 30002}" description="{77000, 30102}" category="trade" infinite="true" allowinloop="false" canplayercancel="true">
    <params>
      <!-- Home Station (required — must be player-owned station) -->
      <param name="homeStation" type="object" default="null" text="{77000, 30010}" comment="{77000, 30110}">
        <input_param name="class" value="[class.station]"/>
      </param>

      <!-- Max Sell Distance (skill-gated; MK1 commander is always station so use pilot only) -->
      <param name="maxsell" default="[if @this.ship.pilot.skill.management le 2 then 1 else if @this.ship.pilot.skill.management le 5 then 3 else if @this.ship.pilot.skill.management le 8 then 5 else if @this.ship.pilot.skill.management le 11 then 10 else if @this.ship.pilot.skill.management le 13 then 15 else 25, 1].max" type="number" text="{77000, 30011}" comment="{77000, 30111}">
        <input_param name="startvalue" value="0"/>
        <input_param name="min" value="0"/>
        <input_param name="max" value="[if @this.ship.pilot.skill.management le 2 then 1 else if @this.ship.pilot.skill.management le 5 then 3 else if @this.ship.pilot.skill.management le 8 then 5 else if @this.ship.pilot.skill.management le 11 then 10 else if @this.ship.pilot.skill.management le 13 then 15 else 25, 1].max"/>
        <input_param name="step" value="1"/>
      </param>

      <!-- Trade Rule Bypass -->
      <param name="ignoretraderules" default="false" type="bool" text="{77000, 30012}" comment="{77000, 30112}"/>

      <!-- Allow Illegal Wares -->
      <param name="allowillegal" default="false" type="bool" text="{77000, 30023}" comment="{77000, 30123}"/>

      <!-- Ware Filter (empty = auto-derive from station) -->
      <param name="warebasket" default="[]" type="list" text="{77000, 30013}" comment="{77000, 30113}">
        <input_param name="type" value="'ware'"/>
        <input_param name="cancarry" value="this.ship"/>
      </param>

      <!-- Sell Cargo Fill Target -->
      <param name="selltarget" default="90" type="number" text="{77000, 30014}" comment="{77000, 30114}">
        <input_param name="min" value="50"/>
        <input_param name="max" value="100"/>
        <input_param name="step" value="5"/>
      </param>

      <!-- Supply Cargo Fill Target -->
      <param name="buytarget" default="80" type="number" text="{77000, 30016}" comment="{77000, 30116}">
        <input_param name="min" value="50"/>
        <input_param name="max" value="100"/>
        <input_param name="step" value="5"/>
      </param>

      <!-- Backtrack Tolerance (extra jumps for multi-ware) -->
      <param name="backtrackTolerance" default="1" type="number" text="{77000, 30015}" comment="{77000, 30115}">
        <input_param name="min" value="0"/>
        <input_param name="max" value="5"/>
        <input_param name="step" value="1"/>
      </param>

      <!-- Logbook Entries -->
      <param name="logbookentries" default="true" type="bool" text="{77000, 30017}" comment="{77000, 30117}"/>

      <!-- Notification Level -->
      <param name="notifications" default="1" type="number" text="{77000, 30018}" comment="{77000, 30118}">
        <input_param name="min" value="0"/>
        <input_param name="max" value="2"/>
        <input_param name="step" value="1"/>
      </param>

      <!-- Fleet Coordination -->
      <param name="fleetcoordination" default="true" type="bool" text="{77000, 30019}" comment="{77000, 30119}" advanced="true"/>

      <!-- Debug Level -->
      <param name="debuglevel" default="1" type="number" text="{77000, 30020}" comment="{77000, 30120}" advanced="true">
        <input_param name="min" value="0"/>
        <input_param name="max" value="2"/>
        <input_param name="step" value="1"/>
      </param>

      <!-- Supply Station (buy resources for home station) -->
      <param name="supply" default="false" type="bool" text="{77000, 30021}" comment="{77000, 30121}"/>

      <!-- Min Station Storage % (supply priority threshold) -->
      <param name="minstorage" default="50" type="number" text="{77000, 30022}" comment="{77000, 30122}">
        <input_param name="startvalue" value="50"/>
        <input_param name="min" value="10"/>
        <input_param name="max" value="90"/>
        <input_param name="step" value="5"/>
      </param>
    </params>
    <requires>
      <match shiptype="shiptype.lasertower" negate="true"/>
    </requires>
  </order>

  <interrupts>
    <handler ref="SectorChangeHandler"/>
    <handler ref="AttackHandler"/>
    <handler ref="MissileLockHandler"/>
    <handler ref="ScannedHandler"/>
    <handler ref="InspectedHandler"/>
    <handler ref="FoundAbandonedHandler"/>
    <handler ref="FoundLockboxHandler"/>
    <handler ref="ResupplyHandler"/>
    <handler ref="TargetInvalidHandler"/>
    <handler ref="TideHandler"/>

    <!-- MK1 threat broadcast hook: level 6+ pilots can warn fleet when attacked -->
    <handler>
      <conditions>
        <event_object_attacked object="this.ship"/>
      </conditions>
      <actions>
        <set_value name="$pilotLevel" exact="1"/>
        <set_value name="$primaryFaction" exact="null"/>
        <do_if value="event.param? and event.param.owner?">
          <set_value name="$primaryFaction" exact="event.param.owner"/>
        </do_if>
        <do_if value="this.ship.pilot? and global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$Level?">
          <set_value name="$pilotLevel" exact="global.$GT_Pilots.{this.ship.pilot}.$Level"/>
        </do_if>
        <do_if value="$pilotLevel ge 6">
          <signal_objects object="player.galaxy" param="'GT_Threat_Warning'" param2="table[
            $Sector = this.ship.sector,
            $DetectedBy = this.ship,
            $HostileCount = 1,
            $PrimaryFaction = $primaryFaction,
            $ShipClass_XL = 0,
            $ShipClass_L = 0,
            $ShipClass_M = 1,
            $ShipClass_S = 0,
            $ThreatScore = 2,
            $Timestamp = player.age
          ]"/>
        </do_if>
      </actions>
    </handler>

    <!-- Training dispatch bridge: MK1 also needs to react to MD training station results -->
    <handler>
      <conditions>
        <event_object_signalled object="this.ship" param="'GT_Training_Station_Found'"/>
      </conditions>
      <actions>
        <set_value name="$trainingData" exact="event.param2"/>
        <set_value name="$trainingStation" exact="$trainingData.$Station"/>
        <set_value name="$requiredLevel" exact="$trainingData.$Level"/>
        <set_value name="$hasActiveTrainingOrder" exact="false"/>
        <do_all exact="this.ship.orders.count" counter="$oi">
          <do_if value="this.ship.orders.{$oi}.id == 'DockAndTrain'">
            <set_value name="$hasActiveTrainingOrder" exact="true"/>
            <break/>
          </do_if>
        </do_all>
        <do_if value="$trainingStation? and $trainingStation.exists and not $hasActiveTrainingOrder">
          <create_order object="this.ship" id="'DockAndTrain'" immediate="true">
            <param name="destination" value="$trainingStation"/>
            <param name="debugchance" value="this.$debugchance"/>
          </create_order>
          <set_value name="this.$mk1_lastTrainingSignalAt" exact="player.age"/>
          <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Training station received - DockAndTrain created for ' + $trainingStation.knownname + ' (level ' + $requiredLevel + ')'" chance="this.$debugchance"/>
        </do_if>
        <do_elseif value="$hasActiveTrainingOrder">
          <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Training station signal ignored - DockAndTrain already active'" chance="this.$debugchance"/>
        </do_elseif>
      </actions>
    </handler>
  </interrupts>

  <init>
    <set_order_syncpoint_reached order="this.ship.order"/>
    <!-- ================================================================ -->
    <!-- MK1 INITIALIZATION                                               -->
    <!-- ================================================================ -->
    <set_value name="$debugchance" exact="if $debuglevel ge 1 then 100 else 0"/>

    <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': === MK1 INIT STARTED === (Ship: ' + this.ship.knownname + ', Pilot: ' + @this.ship.pilot.knownname + ')'" chance="$debugchance"/>

    <!-- Validate home station -->
    <do_if value="not $homeStation? or not $homeStation.exists or not $homeStation.isclass.station">
      <show_notification text="'GalaxyTrader MK1: ' + {77000, 30204}" timeout="10s"/>
      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': ABORT — no valid station assigned'" chance="100"/>
      <set_command_action commandaction="commandaction.standingby"/>
      <return/>
    </do_if>

    <do_if value="not $homeStation.isplayerowned">
      <show_notification text="'GalaxyTrader MK1: ' + {77000, 30203}.[$homeStation.knownname]" timeout="10s"/>
      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': ABORT — station not player-owned: ' + $homeStation.knownname" chance="100"/>
      <set_command_action commandaction="commandaction.standingby"/>
      <return/>
    </do_if>

    <!-- Station assignment: only for top-level or station-assigned ships.
         Ship-subordinates must remain assigned to their ship commander. -->
    <do_if value="(not this.ship.commander.exists or this.ship.commander == this.ship or this.ship.commander.isclass.station) and this.ship.commander != $homeStation">
      <do_if value="this.ship.commander.exists and this.ship.commander != this.ship">
        <remove_object_commander object="this.ship"/>
      </do_if>
      <set_object_commander object="this.ship" commander="$homeStation" assignment="assignment.trade"/>
      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Assigned to station ' + $homeStation.knownname + ' as trade subordinate'" chance="$debugchance"/>
    </do_if>

    <!-- Store effective values -->
    <set_value name="this.$homeStation" exact="$homeStation"/>
    <set_value name="this.$maxsell" exact="$maxsell"/>
    <set_value name="this.$ignoretraderules" exact="$ignoretraderules"/>
    <set_value name="this.$allowillegal" exact="$allowillegal"/>
    <set_value name="this.$warebasket" exact="$warebasket"/>
    <set_value name="this.$selltarget" exact="$selltarget"/>
    <set_value name="this.$buytarget" exact="$buytarget"/>
    <set_value name="this.$backtrackTolerance" exact="$backtrackTolerance"/>
    <set_value name="this.$logbookentries" exact="$logbookentries"/>
    <set_value name="this.$notifications" exact="$notifications"/>
    <set_value name="this.$fleetcoordination" exact="$fleetcoordination"/>
    <set_value name="this.$debuglevel" exact="$debuglevel"/>
    <set_value name="this.$debugchance" exact="$debugchance"/>
    <set_value name="this.$supply" exact="$supply"/>
    <set_value name="this.$minstorage" exact="$minstorage"/>
    <!-- Wait time when no trades found (from global settings or default 60s) -->
    <set_value name="this.$waitTimeNoTrades" exact="if global.$GT_MK1_GlobalSettings.$StationTrader.$WaitTimeNoTrades? then global.$GT_MK1_GlobalSettings.$StationTrader.$WaitTimeNoTrades else 60s"/>

    <set_command_action commandaction="commandaction.searchingtrades"/>

    <!-- Signal MD: ship registered as MK1 station trader -->
    <signal_objects object="player.galaxy" param="'GT_AI_Started'" param2="table[
      $Ship = this.ship,
      $Config = table[
        $allowillegal = $allowillegal,
        $debuglevel = $debuglevel,
        $orderType = 'MK1'
      ]
    ]"/>
    <!-- Mirror MK3 lifecycle: register pilot/ship through GT_Update_Ship on init -->
    <do_if value="this.ship.pilot">
      <signal_objects object="player.galaxy" param="'GT_Update_Ship'" param2="table[
        $updateType = 'pilot_change',
        $ship = this.ship,
        $pilot = this.ship.pilot,
        $oldPilot = null
      ]"/>
    </do_if>
    <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
      $Ship = this.ship,
      $UpdateType = 'GT_Order_Assigned',
      $MacroShipName = @this.ship.macro.name
    ]"/>

    <!-- Register station as MK1-supplied (if supply is enabled) -->
    <do_if value="this.$supply">
      <do_if value="not global.$GT_MK1SuppliedStations?">
        <set_value name="global.$GT_MK1SuppliedStations" exact="table[]"/>
      </do_if>
      <set_value name="global.$GT_MK1SuppliedStations.{this.$homeStation}" exact="this.ship"/>
      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Registered station ' + this.$homeStation.knownname + ' as MK1-supplied'" chance="$debugchance"/>
    </do_if>

    <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': === MK1 INIT COMPLETE === Home: ' + $homeStation.knownname + ', MaxSell: ' + $maxsell + ', IgnoreRules: ' + $ignoretraderules + ', Supply: ' + $supply" chance="$debugchance"/>
  </init>

  <attention min="unknown">
    <actions>

      <!-- Read AI yield interval from global settings (persisted to instance var to survive waits) -->
      <set_value name="this.$gt_yieldMs" exact="1"/>
      <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$AIYieldInterval?">
        <set_value name="this.$gt_yieldMs" exact="[1, @global.$GT_GlobalSettings.$Performance.$AIYieldInterval].max"/>
      </do_if>

      <!-- ================================================================ -->
      <!-- MK1 MAIN LOOP                                                    -->
      <!-- ================================================================ -->
      <label name="main_loop"/>

      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': === MAIN LOOP START ==='" chance="this.$debugchance"/>

      <!-- Periodic training re-request for already blocked pilots (e.g. saves created before this handler existed). -->
      <do_if value="this.ship.pilot? and global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}?">
        <set_value name="$blockedLevel" exact="0"/>
        <do_if value="global.$GT_Pilots.{this.ship.pilot}.$BlockedLevel?">
          <set_value name="$blockedLevel" exact="global.$GT_Pilots.{this.ship.pilot}.$BlockedLevel"/>
        </do_if>
        <set_value name="$needsTrainingDispatch" exact="global.$GT_Pilots.{this.ship.pilot}.$XPBlocked? or global.$GT_Pilots.{this.ship.pilot}.$PausedWithTrainingNeeded? or $blockedLevel gt 1"/>
        <do_if value="$needsTrainingDispatch">
          <set_value name="$dispatchReady" exact="false"/>
          <do_if value="not this.$mk1_lastTrainingSignalAt? or (player.age - this.$mk1_lastTrainingSignalAt) ge 60s">
            <set_value name="$dispatchReady" exact="true"/>
          </do_if>
          <do_if value="$dispatchReady">
            <signal_objects object="player.galaxy" param="'GT_Training_Needed'" param2="table[
              $Ship = this.ship,
              $Pilot = this.ship.pilot,
              $RequiredLevel = $blockedLevel
            ]"/>
            <set_value name="this.$mk1_lastTrainingSignalAt" exact="player.age"/>
            <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Re-requested training dispatch for blocked pilot (level ' + $blockedLevel + ')'" chance="this.$debugchance"/>
          </do_if>
        </do_if>
      </do_if>

      <!-- ============================================================== -->
      <!-- STEP 1: Validate station still exists and is player-owned      -->
      <!-- ============================================================== -->
      <do_if value="not this.$homeStation.exists">
        <do_if value="this.$notifications ge 1">
          <show_notification text="'GalaxyTrader MK1: ' + {77000, 30202}.['(destroyed)']" timeout="10s"/>
        </do_if>
        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': ABORT — home station destroyed'" chance="100"/>
        <!-- Unregister from supply registry (station may still be in table if it was just destroyed) -->
        <do_if value="global.$GT_MK1SuppliedStations? and global.$GT_MK1SuppliedStations.{this.$homeStation}? and global.$GT_MK1SuppliedStations.{this.$homeStation} == this.ship">
          <remove_value name="global.$GT_MK1SuppliedStations.{this.$homeStation}"/>
        </do_if>
        <set_command_action commandaction="commandaction.standingby"/>
        <return/>
      </do_if>

      <do_if value="not this.$homeStation.isplayerowned">
        <do_if value="this.$notifications ge 1">
          <show_notification text="'GalaxyTrader MK1: ' + {77000, 30203}.[this.$homeStation.knownname]" timeout="10s"/>
        </do_if>
        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': ABORT — station no longer player-owned'" chance="100"/>
        <!-- Unregister from supply registry -->
        <do_if value="global.$GT_MK1SuppliedStations? and global.$GT_MK1SuppliedStations.{this.$homeStation}? and global.$GT_MK1SuppliedStations.{this.$homeStation} == this.ship">
          <remove_value name="global.$GT_MK1SuppliedStations.{this.$homeStation}"/>
        </do_if>
        <set_command_action commandaction="commandaction.standingby"/>
        <return/>
      </do_if>

      <!-- Refresh params from order in case player changed them -->
      <do_if value="this.ship.defaultorder? and this.ship.defaultorder.id == 'GalaxyTraderMK1'">
        <set_value name="this.$maxsell" exact="this.ship.defaultorder.$maxsell"/>
        <set_value name="this.$ignoretraderules" exact="this.ship.defaultorder.$ignoretraderules"/>
        <set_value name="this.$allowillegal" exact="this.ship.defaultorder.$allowillegal"/>
        <set_value name="this.$warebasket" exact="this.ship.defaultorder.$warebasket"/>
        <set_value name="this.$selltarget" exact="this.ship.defaultorder.$selltarget"/>
        <set_value name="this.$buytarget" exact="this.ship.defaultorder.$buytarget"/>
        <set_value name="this.$backtrackTolerance" exact="this.ship.defaultorder.$backtrackTolerance"/>
        <set_value name="this.$logbookentries" exact="this.ship.defaultorder.$logbookentries"/>
        <set_value name="this.$notifications" exact="this.ship.defaultorder.$notifications"/>
        <set_value name="this.$fleetcoordination" exact="this.ship.defaultorder.$fleetcoordination"/>
        <set_value name="this.$debuglevel" exact="this.ship.defaultorder.$debuglevel"/>
        <set_value name="this.$debugchance" exact="if this.$debuglevel ge 1 then 100 else 0"/>
        <set_value name="this.$supply" exact="this.ship.defaultorder.$supply"/>
        <set_value name="this.$minstorage" exact="this.ship.defaultorder.$minstorage"/>

        <!-- Update supply station registry if supply toggled -->
        <do_if value="not global.$GT_MK1SuppliedStations?">
          <set_value name="global.$GT_MK1SuppliedStations" exact="table[]"/>
        </do_if>
        <do_if value="this.$supply">
          <set_value name="global.$GT_MK1SuppliedStations.{this.$homeStation}" exact="this.ship"/>
        </do_if>
        <do_elseif value="global.$GT_MK1SuppliedStations.{this.$homeStation}? and global.$GT_MK1SuppliedStations.{this.$homeStation} == this.ship">
          <remove_value name="global.$GT_MK1SuppliedStations.{this.$homeStation}"/>
          <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Unregistered station ' + this.$homeStation.knownname + ' (supply toggled off)'" chance="this.$debugchance"/>
        </do_elseif>
      </do_if>

      <!-- ============================================================== -->
      <!-- STEP 2: Maintenance check (shared GT system)                   -->
      <!-- ============================================================== -->
      <signal_objects object="player.galaxy" param="'GT_Check_Maintenance'" param2="table[$Ship = this.ship]"/>
      <wait exact="this.$gt_yieldMs * 1ms" comment="Cooperative yield"/>

      <!-- ============================================================== -->
      <!-- STEP 2b: Supply mode — affordability + threshold check         -->
      <!-- ============================================================== -->
      <set_value name="this.$supplyPriority" exact="false"/>
      <set_value name="this.$supplySkipped" exact="false"/>

      <do_if value="this.$supply">
        <!-- Check if station can afford at least 1 unit of any resource -->
        <set_value name="$stationResources" exact="this.$homeStation.resources.list"/>
        <set_value name="$canAffordAny" exact="false"/>

        <do_if value="$stationResources.count gt 0">
          <do_all exact="$stationResources.count" counter="$ri">
            <set_value name="$res" exact="$stationResources.{$ri}"/>
            <do_if value="$res.averageprice? and this.$homeStation.money ge $res.averageprice">
              <set_value name="$canAffordAny" exact="true"/>
              <break/>
            </do_if>
          </do_all>
        </do_if>

        <do_if value="not $canAffordAny">
          <!-- Station can't afford any resources — skip supply entirely -->
          <set_value name="this.$supplySkipped" exact="true"/>
          <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Supply SKIPPED — station cannot afford any resources (balance: ' + this.$homeStation.money + ')'" chance="this.$debugchance"/>
        </do_if>
        <do_else>
          <!-- Check per-ware: is ANY resource below minstorage threshold? -->
          <do_all exact="$stationResources.count" counter="$ri">
            <set_value name="$res" exact="$stationResources.{$ri}"/>
            <set_value name="$resCurrent" exact="this.$homeStation.cargo.{$res}.count"/>
            <set_value name="$resTarget" exact="this.$homeStation.cargo.{$res}.target"/>
            <do_if value="$resTarget gt 0">
              <set_value name="$resPercent" exact="($resCurrent * 100) / $resTarget"/>
              <do_if value="$resPercent lt this.$minstorage">
                <set_value name="this.$supplyPriority" exact="true"/>
                <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Supply PRIORITY — ' + $res.name + ' at ' + $resPercent + '% (threshold: ' + this.$minstorage + '%)'" chance="this.$debugchance"/>
                <break/>
              </do_if>
            </do_if>
          </do_all>
        </do_else>
      </do_if>

      <!-- ============================================================== -->
      <!-- STEP 2c: Priority supply phase (runs before sell when urgent)  -->
      <!-- ============================================================== -->
      <do_if value="this.$supplyPriority">
        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': === SUPPLY PHASE START (priority) ==='" chance="this.$debugchance"/>
        <set_command_action commandaction="commandaction.searchingtrades"/>

        <!-- Build list of under-threshold resources -->
        <create_list name="$supplyWares"/>
        <set_value name="$stationResources" exact="this.$homeStation.resources.list"/>
        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Station resources count: ' + $stationResources.count + ', station money: ' + this.$homeStation.money" chance="this.$debugchance"/>
        <do_all exact="$stationResources.count" counter="$ri">
          <set_value name="$res" exact="$stationResources.{$ri}"/>
          <set_value name="$resTarget" exact="this.$homeStation.cargo.{$res}.target"/>
          <do_if value="$resTarget gt 0">
            <set_value name="$resCurrent" exact="this.$homeStation.cargo.{$res}.count"/>
            <set_value name="$resPercent" exact="($resCurrent * 100) / $resTarget"/>
            <do_if value="$resPercent lt this.$minstorage">
              <append_to_list name="$supplyWares" exact="$res"/>
              <debug_text text="'[GT-MK1] ' + this.ship.idcode + ':   Need ' + $res.name + ': ' + $resCurrent + '/' + $resTarget + ' (' + $resPercent + '%)'" chance="this.$debugchance"/>
            </do_if>
          </do_if>
        </do_all>

        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Supply wares to find: ' + $supplyWares.count" chance="this.$debugchance"/>
        <!-- Small stagger to reduce same-tick herd selection across many subordinates. -->
        <wait min="200ms" max="900ms"/>

        <!-- Shared pipeline: pathfinding + live search + trade match -->
        <run_script name="'lib.gt.pathfinding'" result="$supplySpaces">
          <param name="ship" value="this.ship"/>
          <param name="homeSector" value="this.$homeStation.sector"/>
          <param name="maxDistance" value="this.$maxsell"/>
        </run_script>

        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Searching ' + $supplySpaces.$BuySpaces.count + ' sectors (maxsell=' + this.$maxsell + ')'" chance="this.$debugchance"/>

        <!-- Read Normal price range from config (MK1 traders always use Normal) -->
        <set_value name="$mk1SellPriceMax" exact="1.0"/>
        <set_value name="$mk1BuyPriceMin" exact="-1.0"/>
        <do_if value="global.$GT_Config? and global.$GT_Config.$Trading?">
          <set_value name="$mk1SellPriceMax" exact="if global.$GT_Config.$Trading.$SellPriceMax? then @global.$GT_Config.$Trading.$SellPriceMax else 1.0"/>
          <set_value name="$mk1BuyPriceMin" exact="if global.$GT_Config.$Trading.$BuyPriceMin? then @global.$GT_Config.$Trading.$BuyPriceMin else -1.0"/>
        </do_if>
        <run_script name="'lib.gt.live.search'" result="$supplyLiveResult">
          <param name="ship" value="this.ship"/>
          <param name="searchMode" value="'buy_only'"/>
          <param name="buySpaces" value="$supplySpaces.$BuySpaces"/>
          <param name="sellSpaces" value="[]"/>
          <param name="homeSector" value="this.$homeStation.sector"/>
          <param name="maxDistance" value="this.$maxsell"/>
          <param name="wareBasket" value="$supplyWares"/>
          <param name="allowIllegal" value="false"/>
          <param name="ownerFilter" value="'npc_only'"/>
          <param name="ignoreTradeRules" value="this.$ignoretraderules"/>
          <param name="ignoreMK1Supply" value="false"/>
          <param name="sellPriceMax" value="$mk1SellPriceMax"/>
          <param name="buyPriceMin" value="$mk1BuyPriceMin"/>
          <param name="debugchance" value="this.$debugchance"/>
        </run_script>

        <!-- Safety filter: supply mode must not buy from the same home station.
             This prevents degenerate self-trades (buy+deliver on identical station). -->
        <create_list name="$supplySellOffersFiltered"/>
        <do_if value="$supplyLiveResult.$SellOffers? and $supplyLiveResult.$SellOffers.count gt 0">
          <do_all exact="$supplyLiveResult.$SellOffers.count" counter="$ssfi">
            <set_value name="$candSellOffer" exact="$supplyLiveResult.$SellOffers.{$ssfi}"/>
            <do_if value="$candSellOffer? and $candSellOffer.available and $candSellOffer.owner? and $candSellOffer.owner.exists and $candSellOffer.owner != this.$homeStation">
              <append_to_list name="$supplySellOffersFiltered" exact="$candSellOffer"/>
            </do_if>
            <do_elseif value="$candSellOffer? and $candSellOffer.owner? and $candSellOffer.owner == this.$homeStation">
              <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Supply filter dropped self-station seller offer for ' + $candSellOffer.ware.name + ' at ' + this.$homeStation.knownname" chance="this.$debugchance"/>
            </do_elseif>
          </do_all>
        </do_if>

        <create_list name="$stationBuyOffers"/>
        <do_all exact="$supplyWares.count" counter="$swi">
          <set_value name="$supplyWare" exact="$supplyWares.{$swi}"/>
          <find_buy_offer buyer="this.$homeStation" wares="$supplyWare" result="$stationBuyOffer"/>
          <do_if value="$stationBuyOffer.available and $stationBuyOffer.amount gt 0">
            <append_to_list name="$stationBuyOffers" exact="$stationBuyOffer"/>
          </do_if>
        </do_all>

        <run_script name="'lib.gt.tradematch'" result="$supplyMatchResult">
          <param name="ship" value="this.ship"/>
          <param name="sellOffers" value="$supplySellOffersFiltered"/>
          <param name="buyOffers" value="$stationBuyOffers"/>
          <param name="homeSector" value="this.$homeStation.sector"/>
          <param name="maxDistance" value="this.$maxsell"/>
          <param name="scoreMode" value="'supply'"/>
          <param name="distancePenalty" value="0.1"/>
        </run_script>
        <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after shared tradematch call"/>

        <set_value name="$bestSupplyTrade" exact="null"/>
        <set_value name="$bestSupplyScore" exact="-1"/>
        <set_value name="$availableSupplyTradeWaresCount" exact="0"/>
        <do_if value="$supplyMatchResult.$Found and $supplyMatchResult.$TradeList? and $supplyMatchResult.$TradeList.count gt 0">
          <run_script name="'lib.gt.tradematch'" result="$mk1DistinctWaresResult">
            <param name="mode" value="'count_distinct_wares'"/>
            <param name="tradeListInput" value="$supplyMatchResult.$TradeList"/>
          </run_script>
          <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after distinct-ware helper call"/>
          <set_value name="$availableSupplyTradeWaresCount" exact="if $mk1DistinctWaresResult.$DistinctCount? then $mk1DistinctWaresResult.$DistinctCount else 0"/>

          <do_if value="this.$debuglevel ge 1">
            <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': supply candidate wares available now=' + $availableSupplyTradeWaresCount" chance="this.$debugchance"/>
          </do_if>

          <do_all exact="$supplyMatchResult.$TradeList.count" counter="$smti">
            <set_value name="$candidateCoreTrade" exact="$supplyMatchResult.$TradeList.{$smti}"/>
            <set_value name="$candidateAmount" exact="$candidateCoreTrade.$Amount"/>

            <!-- Soft buytarget cap: don't force full cargo in supply mode -->
            <set_value name="$candidateTargetAmount" exact="$candidateAmount"/>
            <do_if value="$candidateCoreTrade.$Ware.volume gt 0 and this.$buytarget lt 100">
              <set_value name="$candidateTargetAmount" exact="[1, ((this.ship.cargo.capacity.all * this.$buytarget / 100) / $candidateCoreTrade.$Ware.volume)i].max"/>
            </do_if>
            <set_value name="$candidateAmount" exact="[$candidateAmount, $candidateTargetAmount].min"/>

            <do_if value="$candidateAmount gt 0">
              <!-- Use vanilla reservation state for supply fairness (no custom tracking tables). -->
              <set_value name="$reservedCount" exact="0"/>
              <set_value name="$alreadyReservedByThisShip" exact="false"/>
              <set_value name="$incomingReservedAmount" exact="0"/>
              <set_value name="$selfIncomingReservedAmount" exact="0"/>
              <get_ware_reservation object="this.$homeStation" ware="$candidateCoreTrade.$Ware" type="sell" virtual="false" result="$incomingReservedAmount"/>
              <get_ware_reservation object="this.$homeStation" ware="$candidateCoreTrade.$Ware" type="sell" reserver="this.ship" virtual="false" result="$selfIncomingReservedAmount"/>
              <do_if value="$selfIncomingReservedAmount gt 0">
                <set_value name="$alreadyReservedByThisShip" exact="true"/>
              </do_if>

              <!-- Dynamic slot count per ware:
                   max ships ~= ceil(remaining need / ship chunk). -->
              <set_value name="$needAmount" exact="0"/>
              <set_value name="$effectiveNeedAmount" exact="0"/>
              <set_value name="$targetAmount" exact="this.$homeStation.cargo.{$candidateCoreTrade.$Ware}.target"/>
              <set_value name="$currentAmount" exact="this.$homeStation.cargo.{$candidateCoreTrade.$Ware}.count"/>
              <do_if value="$targetAmount gt $currentAmount">
                <set_value name="$needAmount" exact="$targetAmount - $currentAmount"/>
              </do_if>
              <set_value name="$effectiveNeedAmount" exact="[$needAmount - $incomingReservedAmount, 0].max"/>
              <set_value name="$shipChunkAmount" exact="this.ship.cargo.{$candidateCoreTrade.$Ware}.max"/>
              <do_if value="this.$buytarget lt 100">
                <set_value name="$shipChunkAmount" exact="[1, ($shipChunkAmount * this.$buytarget / 100)i].max"/>
              </do_if>
              <do_if value="$shipChunkAmount lt 1">
                <set_value name="$shipChunkAmount" exact="1"/>
              </do_if>
              <set_value name="$reservedCount" exact="(($incomingReservedAmount + $shipChunkAmount - 1) / $shipChunkAmount)i"/>

              <run_script name="'lib.gt.tradematch'" result="$mk1FairnessResult">
                <param name="mode" value="'ware_fairness'"/>
                <param name="rawNeedAmount" value="$needAmount"/>
                <param name="incomingReservedAmount" value="$incomingReservedAmount"/>
                <param name="shipChunkAmount" value="$shipChunkAmount"/>
                <param name="availableTradeWaresCount" value="$availableSupplyTradeWaresCount"/>
                <param name="reservedCount" value="$reservedCount"/>
                <param name="alreadyReservedByThisShip" value="$alreadyReservedByThisShip"/>
                <param name="fairnessCap" value="2"/>
              </run_script>
              <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after fairness helper call"/>
              <set_value name="$effectiveNeedAmount" exact="$mk1FairnessResult.$EffectiveNeedAmount"/>
              <set_value name="$maxShipsForWare" exact="$mk1FairnessResult.$MaxShipsForWare"/>
              <set_value name="$reservationAllowsTrade" exact="$mk1FairnessResult.$ReservationAllowsTrade"/>
              <set_value name="$candidateAmount" exact="[$candidateAmount, $effectiveNeedAmount].min"/>

              <do_if value="$candidateAmount gt 0 and $candidateCoreTrade.$Score gt $bestSupplyScore">
                <set_value name="$bestSupplyScore" exact="$candidateCoreTrade.$Score"/>
                <set_value name="$bestSupplyTrade" exact="table[
                  $Ware = $candidateCoreTrade.$Ware,
                  $SellOffer = $candidateCoreTrade.$BuyOffer,
                  $BuyOffer = $candidateCoreTrade.$SellOffer,
                  $Amount = $candidateAmount,
                  $SellerStation = $candidateCoreTrade.$BuyOffer.owner,
                  $Distance = $candidateCoreTrade.$Distance,
                  $ReservedCount = $reservedCount,
                  $MaxShipsForWare = $maxShipsForWare,
                  $IncomingReservedAmount = $incomingReservedAmount,
                  $NeedAmount = $needAmount,
                  $EffectiveNeedAmount = $effectiveNeedAmount
                ]"/>
              </do_if>
            </do_if>
          </do_all>
        </do_if>

        <do_if value="$bestSupplyTrade != null">
          <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Supply trade found: buy ' + $bestSupplyTrade.$Amount + ' ' + $bestSupplyTrade.$Ware.name + ' from ' + $bestSupplyTrade.$SellerStation.knownname + ' (dist: ' + $bestSupplyTrade.$Distance + ', slots: ' + $bestSupplyTrade.$ReservedCount + '/' + $bestSupplyTrade.$MaxShipsForWare + ', incoming=' + $bestSupplyTrade.$IncomingReservedAmount + ', need=' + $bestSupplyTrade.$NeedAmount + ', effectiveNeed=' + $bestSupplyTrade.$EffectiveNeedAmount + ')'" chance="this.$debugchance"/>

          <!-- Create BOTH trade orders upfront so reservations are visible immediately.
               Pattern matches vanilla order.trade.routine: "create_trade_order adds the reservation automatically".
               The engine executes queued orders in sequence (buy first, then deliver). -->
          <set_command_action commandaction="commandaction.flying"/>
          <set_value name="$supplyOrdersCreated" exact="false"/>

          <do_if value="$bestSupplyTrade.$SellOffer.available and $bestSupplyTrade.$BuyOffer.available">
            <set_value name="$supOfferAmount" exact="$bestSupplyTrade.$SellOffer.offeramount.{this.ship}"/>
            <do_if value="$supOfferAmount == null">
              <set_value name="$supOfferAmount" exact="$bestSupplyTrade.$SellOffer.amount"/>
            </do_if>
            <do_if value="$supOfferAmount == null">
              <set_value name="$supOfferAmount" exact="0"/>
            </do_if>
            <set_value name="$supBuyAmount" exact="[$bestSupplyTrade.$Amount, $supOfferAmount].min"/>
            <do_if value="$bestSupplyTrade.$SellOffer.unitprice gt 0">
              <set_value name="$supAffordableAmount" exact="(this.$homeStation.money / $bestSupplyTrade.$SellOffer.unitprice)i"/>
              <set_value name="$supBuyAmount" exact="[$supBuyAmount, $supAffordableAmount].min"/>
            </do_if>
            <do_if value="$supBuyAmount gt 0">
              <!-- Queue delivery first, then buy.
                   With immediate="true", later created orders execute first (vanilla TradeRoutine pattern),
                   so this guarantees BUY executes before DELIVER. -->
              <create_trade_order object="this.ship" tradeoffer="$bestSupplyTrade.$BuyOffer" amount="$supBuyAmount" immediate="true" internal="false"/>
              <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Queued DELIVER order: ' + $supBuyAmount + ' ' + $bestSupplyTrade.$Ware.name + ' to ' + this.$homeStation.knownname + ' (vanilla reservation expected)'" chance="this.$debugchance"/>

              <create_trade_order object="this.ship" tradeoffer="$bestSupplyTrade.$SellOffer" amount="$supBuyAmount" immediate="true" internal="false"/>
              <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Queued BUY order: ' + $supBuyAmount + ' ' + $bestSupplyTrade.$Ware.name + ' from ' + $bestSupplyTrade.$SellerStation.knownname" chance="this.$debugchance"/>
              <do_if value="this.$logbookentries">
                <!-- Mirror MK3 queued-trade logging payload for MK1 supply trades. -->
                <set_value name="$mk1SupplyAmount" exact="if $supBuyAmount? and $supBuyAmount != null then $supBuyAmount else 0"/>
                <do_if value="$mk1SupplyAmount gt 0 and $bestSupplyTrade.$SellOffer != null and $bestSupplyTrade.$BuyOffer != null">
                  <set_value name="$mk1SupplyBuyPriceRaw" exact="if $bestSupplyTrade.$SellOffer.unitprice? and $bestSupplyTrade.$SellOffer.unitprice != null then $bestSupplyTrade.$SellOffer.unitprice else 0"/>
                  <set_value name="$mk1SupplySellPriceRaw" exact="if $bestSupplyTrade.$BuyOffer.unitprice? and $bestSupplyTrade.$BuyOffer.unitprice != null then $bestSupplyTrade.$BuyOffer.unitprice else 0"/>
                  <set_value name="$mk1SupplyProfitRaw" exact="($mk1SupplySellPriceRaw - $mk1SupplyBuyPriceRaw) * $mk1SupplyAmount"/>
                  <signal_objects object="player.galaxy" param="'GT_TradeLogging_LogTradeOrder'" param2="table[
                    $Ship = this.ship,
                    $BuyOffer = $bestSupplyTrade.$SellOffer,
                    $SellOffer = $bestSupplyTrade.$BuyOffer,
                    $Amount = $mk1SupplyAmount,
                    $Profit = $mk1SupplyProfitRaw,
                    $BuyPrice = $mk1SupplyBuyPriceRaw / 100,
                    $SellPrice = $mk1SupplySellPriceRaw / 100,
                    $IsSellOnly = false,
                    $SearchPipeline = 'normal'
                  ]"/>
                </do_if>
              </do_if>

              <set_value name="$supplyOrdersCreated" exact="true"/>
            </do_if>
          </do_if>

          <do_if value="not $supplyOrdersCreated">
            <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Supply trade offers no longer available — skipping'" chance="this.$debugchance"/>
          </do_if>

          <!-- Wait for both orders to complete (buy + deliver) -->
          <do_if value="$supplyOrdersCreated">
            <do_while value="this.ship.orders.count gt 0">
              <wait exact="5s">
                <interrupt>
                  <conditions>
                    <event_object_order_ready object="this.ship"/>
                  </conditions>
                </interrupt>
              </wait>
            </do_while>
          </do_if>

          <!-- Logbook and XP only if supply orders were actually created and executed -->
          <do_if value="$supplyOrdersCreated">
            <do_if value="this.$logbookentries">
              <set_value name="$supLogMsg" exact="'Supplied ' + $bestSupplyTrade.$Amount + ' ' + $bestSupplyTrade.$Ware.name + ' to ' + this.$homeStation.knownname + ' from ' + $bestSupplyTrade.$SellerStation.knownname"/>
              <signal_objects object="player.galaxy" param="'GT_WriteLogbook'" param2="table[
                $Message = $supLogMsg,
                $Category = 'upkeep',
                $Title = 'MK1 Supply: ' + $bestSupplyTrade.$Ware.name,
                $Object = this.ship,
                $CheckGlobalSettings = false
              ]"/>
            </do_if>

            <!-- XP for supply run -->
            <do_if value="this.ship.pilot">
              <signal_objects object="player.galaxy" param="'GT_Update_Pilot_XP'" param2="table[
                $Ship = this.ship,
                $Pilot = this.ship.pilot
              ]"/>
            </do_if>
          </do_if>

          <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': === SUPPLY PHASE COMPLETE === Re-evaluating...'" chance="this.$debugchance"/>
          <wait exact="this.$gt_yieldMs * 1ms" comment="Cooperative yield"/>
          <resume label="main_loop"/>
        </do_if>
        <do_else>
          <!-- Reset priority flag so the no-sell fallback can attempt supply again with a short retry -->
          <set_value name="this.$supplyPriority" exact="false"/>
          <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': No supply trades found — falling through to sell phase'" chance="this.$debugchance"/>
        </do_else>
      </do_if>

      <!-- ============================================================== -->
      <!-- STEP 3: Handle leftover cargo from interrupted trades          -->
      <!-- ============================================================== -->
      <set_value name="$hasLeftoverCargo" exact="this.ship.cargo.count gt 0"/>
      <do_if value="$hasLeftoverCargo">
        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Leftover cargo detected — selling at nearest buyer'" chance="this.$debugchance"/>

        <!-- Build sector list for leftover cargo clearance -->
        <create_list name="$clearSectors"/>
        <append_to_list name="$clearSectors" exact="this.ship.sector"/>
        <do_if value="this.$maxsell gt 0">
          <find_sector name="$clearNearbySectors" space="player.galaxy" multiple="true">
            <match_gate_distance object="this.ship.sector" min="0" max="this.$maxsell"/>
          </find_sector>
          <do_if value="$clearNearbySectors? and $clearNearbySectors.count gt 0">
            <do_all exact="$clearNearbySectors.count" counter="$csi">
              <do_if value="$clearNearbySectors.{$csi} != this.ship.sector">
                <append_to_list name="$clearSectors" exact="$clearNearbySectors.{$csi}"/>
              </do_if>
            </do_all>
          </do_if>
        </do_if>

        <!-- For each ware in cargo, find nearest NPC buyer and sell -->
        <set_value name="$cargoWares" exact="this.ship.cargo.list"/>
        <do_all exact="$cargoWares.count" counter="$ci">
          <set_value name="$cWare" exact="$cargoWares.{$ci}"/>
          <set_value name="$cAmount" exact="this.ship.cargo.{$cWare}.count"/>
          <do_if value="$cAmount gt 0">
            <!-- Find nearest buyer for this ware across sectors in range -->
            <set_value name="$clearBuyOffer" exact="null"/>
            <do_all exact="$clearSectors.count" counter="$csi">
              <find_buy_offer wares="$cWare" space="$clearSectors.{$csi}" result="$secClearOffer">
                <match_buyer tradesknownto="this.ship.owner" owner="faction.player" negateownerfilter="true">
                  <match_relation_to object="this.ship" relation="dock" comparison="ge"/>
                  <match_relation_to faction="this.ship.owner" relation="enemy" comparison="not"/>
                </match_buyer>
                <amount min="1"/>
              </find_buy_offer>
              <do_if value="$secClearOffer.available">
                <set_value name="$clearBuyOffer" exact="$secClearOffer"/>
                <break/>
              </do_if>
            </do_all>
            <do_if value="$clearBuyOffer? and $clearBuyOffer != null and $clearBuyOffer.available">
              <set_value name="$clearAmount" exact="[$cAmount, $clearBuyOffer.amount].min"/>
              <create_trade_order object="this.ship" tradeoffer="$clearBuyOffer" amount="$clearAmount" immediate="true" internal="false"/>
              <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Clearing leftover ' + $clearAmount + ' ' + $cWare.name + ' at ' + $clearBuyOffer.owner.knownname" chance="this.$debugchance"/>
              <wait exact="this.$gt_yieldMs * 1ms" comment="Cooperative yield"/>
            </do_if>
          </do_if>
        </do_all>

        <!-- Wait for trade orders to execute -->
        <do_if value="this.ship.orders.count gt 0">
          <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Waiting for leftover cargo clearance...'" chance="this.$debugchance"/>
          <wait>
            <interrupt>
              <conditions>
                <event_object_order_ready object="this.ship"/>
              </conditions>
            </interrupt>
          </wait>
        </do_if>
      </do_if>

      <!-- ============================================================== -->
      <!-- STEP 4: Build effective ware basket from station               -->
      <!-- ============================================================== -->
      <set_command_action commandaction="commandaction.searchingtrades"/>

      <!-- Inline: Build effective ware basket from station products/tradewares -->
      <create_list name="$effectiveWares"/>
      <create_list name="$candidateWares"/>

      <do_if value="this.$warebasket? and this.$warebasket.count gt 0">
        <!-- Manual filter: use only user-specified wares -->
        <do_all exact="this.$warebasket.count" counter="$wi">
          <append_to_list name="$candidateWares" exact="this.$warebasket.{$wi}"/>
        </do_all>
      </do_if>
      <do_else>
        <!-- Auto-derive: station products + tradewares -->
        <set_value name="$stationProducts" exact="this.$homeStation.products.list"/>
        <set_value name="$stationTradewares" exact="this.$homeStation.tradewares.list"/>

        <do_all exact="$stationProducts.count" counter="$pi">
          <set_value name="$pw" exact="$stationProducts.{$pi}"/>
          <set_value name="$dupCheck" exact="false"/>
          <do_all exact="$candidateWares.count" counter="$dci">
            <do_if value="$candidateWares.{$dci} == $pw">
              <set_value name="$dupCheck" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          <do_if value="not $dupCheck">
            <append_to_list name="$candidateWares" exact="$pw"/>
          </do_if>
        </do_all>

        <do_all exact="$stationTradewares.count" counter="$ti">
          <set_value name="$tw" exact="$stationTradewares.{$ti}"/>
          <set_value name="$dupCheck" exact="false"/>
          <do_all exact="$candidateWares.count" counter="$dci">
            <do_if value="$candidateWares.{$dci} == $tw">
              <set_value name="$dupCheck" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          <do_if value="not $dupCheck">
            <append_to_list name="$candidateWares" exact="$tw"/>
          </do_if>
        </do_all>
      </do_else>

      <!-- Filter candidates: cargo compatibility, processed, illegal -->
      <do_all exact="$candidateWares.count" counter="$fi">
        <set_value name="$fw" exact="$candidateWares.{$fi}"/>
        <do_if value="this.ship.cargo.{$fw}.max le 0">
          <continue/>
        </do_if>
        <do_if value="$fw.isprocessed">
          <continue/>
        </do_if>
        <do_if value="not this.$allowillegal and $fw.illegal">
          <continue/>
        </do_if>
        <append_to_list name="$effectiveWares" exact="$fw"/>
      </do_all>

      <do_if value="$effectiveWares.count == 0">
        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': No wares available from station — waiting ' + this.$waitTimeNoTrades" chance="this.$debugchance"/>
        <wait exact="this.$waitTimeNoTrades"/>
        <resume label="main_loop"/>
      </do_if>

      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Effective ware basket: ' + $effectiveWares.count + ' wares'" chance="this.$debugchance"/>

      <!-- ============================================================== -->
      <!-- STEP 5: Find best sale opportunity                             -->
      <!-- ============================================================== -->
      <!-- Shared pipeline: pathfinding + live search + trade match -->
      <run_script name="'lib.gt.pathfinding'" result="$sellSpaces">
        <param name="ship" value="this.ship"/>
        <param name="homeSector" value="this.$homeStation.sector"/>
        <param name="maxDistance" value="this.$maxsell"/>
      </run_script>

      <!-- Re-read Normal price range from config (may have changed since supply search) -->
      <set_value name="$mk1SellPriceMax" exact="1.0"/>
      <set_value name="$mk1BuyPriceMin" exact="-1.0"/>
      <do_if value="global.$GT_Config? and global.$GT_Config.$Trading?">
        <set_value name="$mk1SellPriceMax" exact="if global.$GT_Config.$Trading.$SellPriceMax? then @global.$GT_Config.$Trading.$SellPriceMax else 1.0"/>
        <set_value name="$mk1BuyPriceMin" exact="if global.$GT_Config.$Trading.$BuyPriceMin? then @global.$GT_Config.$Trading.$BuyPriceMin else -1.0"/>
      </do_if>
      <run_script name="'lib.gt.live.search'" result="$sellLiveResult">
        <param name="ship" value="this.ship"/>
        <param name="searchMode" value="'sell_only'"/>
        <param name="buySpaces" value="[]"/>
        <param name="sellSpaces" value="$sellSpaces.$SellSpaces"/>
        <param name="homeSector" value="this.$homeStation.sector"/>
        <param name="maxDistance" value="this.$maxsell"/>
        <param name="wareBasket" value="$effectiveWares"/>
        <param name="allowIllegal" value="this.$allowillegal"/>
        <param name="ownerFilter" value="'npc_only'"/>
        <param name="ignoreTradeRules" value="this.$ignoretraderules"/>
        <param name="ignoreMK1Supply" value="false"/>
        <param name="sellPriceMax" value="$mk1SellPriceMax"/>
        <param name="buyPriceMin" value="$mk1BuyPriceMin"/>
        <param name="debugchance" value="this.$debugchance"/>
      </run_script>

      <create_list name="$stationSellOffers"/>
      <do_all exact="$effectiveWares.count" counter="$ewi">
        <set_value name="$ware" exact="$effectiveWares.{$ewi}"/>
        <find_sell_offer seller="this.$homeStation" wares="$ware" result="$stationSellOffer"/>
        <do_if value="$stationSellOffer.available and $stationSellOffer.amount gt 0">
          <append_to_list name="$stationSellOffers" exact="$stationSellOffer"/>
        </do_if>
      </do_all>

      <run_script name="'lib.gt.tradematch'" result="$matchResult">
        <param name="ship" value="this.ship"/>
        <param name="sellOffers" value="$stationSellOffers"/>
        <param name="buyOffers" value="$sellLiveResult.$BuyOffers"/>
        <param name="homeSector" value="this.$homeStation.sector"/>
        <param name="maxDistance" value="this.$maxsell"/>
        <param name="distancePenalty" value="0.1"/>
        <param name="scoreMode" value="'sell'"/>
      </run_script>
      <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after shared tradematch call"/>

      <create_list name="$allTrades"/>
      <set_value name="$matchedTrades" exact="[]"/>
      <do_if value="$matchResult?">
        <do_if value="$matchResult.$TradeList?">
          <set_value name="$matchedTrades" exact="@$matchResult.$TradeList"/>
        </do_if>
      </do_if>
      <do_if value="$matchedTrades.count gt 0">
        <do_all exact="$matchedTrades.count" counter="$ti">
          <set_value name="$trade" exact="$matchedTrades.{$ti}"/>
          <set_value name="$keepTrade" exact="true"/>

          <!-- Keep old fleet reservation filter behavior -->
          <do_if value="$keepTrade and this.$fleetcoordination and global.$GT_TradeReservations?">
            <set_value name="$tradeKey" exact="'' + $trade.$Ware + '_' + $trade.$BuyStation"/>
            <do_if value="global.$GT_TradeReservations.{$tradeKey}? and global.$GT_TradeReservations.{$tradeKey} != this.ship">
              <set_value name="$keepTrade" exact="false"/>
            </do_if>
          </do_if>

          <!-- Keep old blacklist filter behavior -->
          <do_if value="$keepTrade and global.$GT_ThreatIntelligence? and global.$GT_ThreatIntelligence.$BlacklistedSectors?">
            <do_all exact="global.$GT_ThreatIntelligence.$BlacklistedSectors.count" counter="$bli">
              <do_if value="global.$GT_ThreatIntelligence.$BlacklistedSectors.{$bli} == $trade.$BuySector">
                <set_value name="$keepTrade" exact="false"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>

          <do_if value="$keepTrade">
            <append_to_list name="$allTrades" exact="$trade"/>
          </do_if>
        </do_all>
      </do_if>

      <run_script name="'lib.gt.score.trades'" result="$scoreResult">
        <param name="tradeList" value="$allTrades"/>
      </run_script>
      <set_value name="$bestTrade" exact="$scoreResult.$BestTrade"/>

      <do_if value="$bestTrade == null">
        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': No sell trades found'" chance="this.$debugchance"/>

        <!-- If supply is enabled and not skipped, try opportunistic supply before waiting -->
        <do_if value="this.$supply and not this.$supplySkipped and not this.$supplyPriority">
          <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': No sells — attempting opportunistic supply'" chance="this.$debugchance"/>
          <set_value name="this.$supplyPriority" exact="true"/>
          <resume label="main_loop"/>
        </do_if>

        <do_if value="this.$notifications ge 2">
          <show_notification text="'MK1 ' + this.ship.knownname + ': ' + {77000, 30201}.[this.$maxsell]" timeout="5s"/>
        </do_if>
        <!-- Short retry when supply is active (trade offers may not be populated yet), full wait otherwise -->
        <set_value name="$retryWait" exact="if this.$supply then 10s else this.$waitTimeNoTrades"/>
        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Waiting ' + $retryWait + ' before retry (supply=' + this.$supply + ')'" chance="this.$debugchance"/>
        <wait exact="$retryWait"/>
        <resume label="main_loop"/>
      </do_if>

      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Best trade: ' + $bestTrade.$Ware.name + ' → ' + $bestTrade.$BuyStation.knownname + ' (score: ' + $bestTrade.$Score + ', amount: ' + $bestTrade.$Amount + ', dist: ' + $bestTrade.$Distance + ')'" chance="this.$debugchance"/>

      <!-- ============================================================== -->
      <!-- STEP 6: Multi-ware loading (no-backtrack rule)                 -->
      <!-- ============================================================== -->
      <create_list name="$deliveryRoute"/>
      <append_to_list name="$deliveryRoute" exact="$bestTrade"/>

      <!-- Calculate how full cargo will be after primary trade -->
      <set_value name="$primaryVolume" exact="$bestTrade.$Amount * $bestTrade.$Ware.volume"/>
      <set_value name="$cargoCapacity" exact="this.ship.cargo.capacity.all"/>
      <set_value name="$fillPercent" exact="if $cargoCapacity gt 0 then ($primaryVolume * 100 / $cargoCapacity) else 100"/>

      <do_if value="$fillPercent lt this.$selltarget and $allTrades.count gt 1">
        <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Cargo fill ' + $fillPercent + '% lt selltarget ' + this.$selltarget + '% — checking for secondary wares'" chance="this.$debugchance"/>

        <!-- Try to add up to 2 more wares (max 3 total) -->
        <set_value name="$additionalCount" exact="0"/>
        <do_all exact="$allTrades.count" counter="$ti">
          <do_if value="$additionalCount ge 2">
            <break/>
          </do_if>

          <set_value name="$candidateTrade" exact="$allTrades.{$ti}"/>

          <!-- Skip the primary trade -->
          <do_if value="$candidateTrade.$BuyStation == $bestTrade.$BuyStation and $candidateTrade.$Ware == $bestTrade.$Ware">
            <continue/>
          </do_if>

          <!-- Skip same ware (already loading it) -->
          <set_value name="$alreadyInRoute" exact="false"/>
          <do_all exact="$deliveryRoute.count" counter="$ri">
            <do_if value="$deliveryRoute.{$ri}.$Ware == $candidateTrade.$Ware">
              <set_value name="$alreadyInRoute" exact="true"/>
              <break/>
            </do_if>
          </do_all>
          <do_if value="$alreadyInRoute">
            <continue/>
          </do_if>

          <!-- No-backtrack rule: is the secondary buyer "in line"? -->
          <!-- Check: distance from last buyer to new buyer vs distance from last buyer to home -->
          <set_value name="$lastBuyer" exact="$deliveryRoute.{$deliveryRoute.count}.$BuyStation"/>
          <set_value name="$distLastToNew" exact="$lastBuyer.gatedistance.{$candidateTrade.$BuyStation}"/>
          <set_value name="$distLastToHome" exact="$lastBuyer.gatedistance.{this.$homeStation}"/>

          <do_if value="$distLastToNew lt 0 or $distLastToHome lt 0">
            <continue/>
          </do_if>

          <do_if value="$distLastToNew gt ($distLastToHome + this.$backtrackTolerance)">
            <!-- Backtracking too much — skip -->
            <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Secondary ' + $candidateTrade.$Ware.name + ' → ' + $candidateTrade.$BuyStation.knownname + ' REJECTED (backtrack: ' + $distLastToNew + ' gt ' + ($distLastToHome + this.$backtrackTolerance) + ')'" chance="this.$debugchance"/>
            <continue/>
          </do_if>

          <!-- Check remaining cargo capacity -->
          <set_value name="$remainingCargo" exact="this.ship.cargo.{$candidateTrade.$Ware}.free"/>
          <set_value name="$secondaryAmount" exact="[$candidateTrade.$Amount, $remainingCargo].min"/>
          <do_if value="$secondaryAmount le 0">
            <continue/>
          </do_if>

          <!-- Update candidate amount and add to route -->
          <set_value name="$candidateTrade.$Amount" exact="$secondaryAmount"/>
          <append_to_list name="$deliveryRoute" exact="$candidateTrade"/>
          <set_value name="$additionalCount" operation="add"/>

          <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Added secondary: ' + $candidateTrade.$Ware.name + ' → ' + $candidateTrade.$BuyStation.knownname + ' (amount: ' + $secondaryAmount + ')'" chance="this.$debugchance"/>
        </do_all>
      </do_if>

      <do_if value="$deliveryRoute.count gt 1 and this.$notifications ge 2">
        <show_notification text="'MK1 ' + this.ship.knownname + ': ' + {77000, 30207}.[$deliveryRoute.count, $deliveryRoute.count]" timeout="5s"/>
      </do_if>

      <!-- ============================================================== -->
      <!-- STEP 7: Reserve trades (fleet coordination)                    -->
      <!-- ============================================================== -->
      <do_if value="this.$fleetcoordination and global.$GT_TradeReservations?">
        <do_all exact="$deliveryRoute.count" counter="$ri">
          <set_value name="$rt" exact="$deliveryRoute.{$ri}"/>
          <set_value name="$tradeKey" exact="'' + $rt.$Ware + '_' + $rt.$BuyStation"/>
          <set_value name="global.$GT_TradeReservations.{$tradeKey}" exact="this.ship"/>
        </do_all>
      </do_if>

      <!-- ============================================================== -->
      <!-- STEP 8/9: Queue paired load+sell orders safely                 -->
      <!-- ============================================================== -->
      <set_command_action commandaction="commandaction.flying"/>

      <!-- Queue SELL first, then LOAD for each trade.
           With immediate="true", later created orders execute first (vanilla pattern),
           so LOAD runs before SELL and prevents ERR_NOTHING_TO_SELL race failures. -->
      <do_all exact="$deliveryRoute.count" counter="$ri">
        <set_value name="$rt" exact="$deliveryRoute.{$ri}"/>
        <do_if value="$rt.$SellOffer.available and $rt.$BuyOffer.available">
          <set_value name="$loadOfferAmount" exact="$rt.$SellOffer.offeramount.{this.ship}"/>
          <do_if value="$loadOfferAmount == null">
            <set_value name="$loadOfferAmount" exact="$rt.$SellOffer.amount"/>
          </do_if>
          <do_if value="$loadOfferAmount == null">
            <set_value name="$loadOfferAmount" exact="0"/>
          </do_if>

          <set_value name="$sellOfferAmount" exact="$rt.$BuyOffer.offeramount.{this.ship}"/>
          <do_if value="$sellOfferAmount == null">
            <set_value name="$sellOfferAmount" exact="$rt.$BuyOffer.amount"/>
          </do_if>
          <do_if value="$sellOfferAmount == null">
            <set_value name="$sellOfferAmount" exact="0"/>
          </do_if>

          <set_value name="$tradePairAmount" exact="[$rt.$Amount, $loadOfferAmount, $sellOfferAmount].min"/>
          <do_if value="$tradePairAmount gt 0">
            <create_trade_order object="this.ship" tradeoffer="$rt.$BuyOffer" amount="$tradePairAmount" immediate="true" internal="false"/>
            <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Queued SELL ' + $tradePairAmount + ' ' + $rt.$Ware.name + ' to ' + $rt.$BuyStation.knownname" chance="this.$debugchance"/>

            <create_trade_order object="this.ship" tradeoffer="$rt.$SellOffer" amount="$tradePairAmount" immediate="true" internal="false"/>
            <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Queued LOAD ' + $tradePairAmount + ' ' + $rt.$Ware.name + ' from ' + $rt.$SellOffer.owner.knownname" chance="this.$debugchance"/>
            <do_if value="this.$logbookentries">
              <!-- Mirror MK3 queued-trade logging payload for MK1 sell cycle. -->
              <set_value name="$mk1QueuedAmount" exact="if $tradePairAmount? and $tradePairAmount != null then $tradePairAmount else 0"/>
              <do_if value="$mk1QueuedAmount gt 0 and $rt.$SellOffer != null and $rt.$BuyOffer != null">
                <set_value name="$mk1BuyPriceRaw" exact="if $rt.$SellOffer.unitprice? and $rt.$SellOffer.unitprice != null then $rt.$SellOffer.unitprice else 0"/>
                <set_value name="$mk1SellPriceRaw" exact="if $rt.$BuyOffer.unitprice? and $rt.$BuyOffer.unitprice != null then $rt.$BuyOffer.unitprice else 0"/>
                <set_value name="$mk1ProfitRaw" exact="($mk1SellPriceRaw - $mk1BuyPriceRaw) * $mk1QueuedAmount"/>
                <signal_objects object="player.galaxy" param="'GT_TradeLogging_LogTradeOrder'" param2="table[
                  $Ship = this.ship,
                  $BuyOffer = $rt.$SellOffer,
                  $SellOffer = $rt.$BuyOffer,
                  $Amount = $mk1QueuedAmount,
                  $Profit = $mk1ProfitRaw,
                  $BuyPrice = $mk1BuyPriceRaw / 100,
                  $SellPrice = $mk1SellPriceRaw / 100,
                  $IsSellOnly = false,
                  $SearchPipeline = 'normal'
                ]"/>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
      </do_all>

      <!-- Wait for all trade orders to execute -->
      <do_while value="this.ship.orders.count gt 0">
        <wait exact="5s">
          <interrupt>
            <conditions>
              <event_object_order_ready object="this.ship"/>
            </conditions>
          </interrupt>
        </wait>
      </do_while>

      <!-- ============================================================== -->
      <!-- STEP 10: Post-trade — log, XP, release reservations            -->
      <!-- ============================================================== -->

      <!-- Release fleet reservations -->
      <do_if value="this.$fleetcoordination and global.$GT_TradeReservations?">
        <do_all exact="$deliveryRoute.count" counter="$ri">
          <set_value name="$rt" exact="$deliveryRoute.{$ri}"/>
          <set_value name="$tradeKey" exact="'' + $rt.$Ware + '_' + $rt.$BuyStation"/>
          <do_if value="global.$GT_TradeReservations.{$tradeKey}? and global.$GT_TradeReservations.{$tradeKey} == this.ship">
            <remove_value name="global.$GT_TradeReservations.{$tradeKey}"/>
          </do_if>
        </do_all>
      </do_if>

      <!-- Logbook entry (via signal, same pattern as MK3) -->
      <do_if value="this.$logbookentries">
        <do_all exact="$deliveryRoute.count" counter="$ri">
          <set_value name="$rt" exact="$deliveryRoute.{$ri}"/>
          <set_value name="$logMsg" exact="'Sold ' + $rt.$Amount + ' ' + $rt.$Ware.name + ' to ' + $rt.$BuyStation.knownname + ' (distance: ' + $rt.$Distance + ' jumps)'"/>
          <signal_objects object="player.galaxy" param="'GT_WriteLogbook'" param2="table[
            $Message = $logMsg,
            $Category = 'upkeep',
            $Title = 'MK1 Sale: ' + $rt.$Ware.name,
            $Object = this.ship,
            $CheckGlobalSettings = false
          ]"/>
        </do_all>
      </do_if>

      <!-- Signal XP update (one per completed cycle, same as MK3) -->
      <do_if value="this.ship.pilot">
        <signal_objects object="player.galaxy" param="'GT_Update_Pilot_XP'" param2="table[
          $Ship = this.ship,
          $Pilot = this.ship.pilot
        ]"/>
      </do_if>

      <!-- Notification -->
      <do_if value="this.$notifications ge 1 and $deliveryRoute.count gt 0">
        <set_value name="$firstTrade" exact="$deliveryRoute.{1}"/>
        <show_notification text="'MK1 ' + this.ship.knownname + ': ' + {77000, 30206}.[$firstTrade.$Amount, $firstTrade.$Ware.name, $firstTrade.$BuyStation.knownname, ($firstTrade.$UnitProfit * $firstTrade.$Amount), ($firstTrade.$UnitProfit * $firstTrade.$Amount)]" timeout="5s"/>
      </do_if>

      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': === SELL CYCLE COMPLETE === Delivered ' + $deliveryRoute.count + ' trades'" chance="this.$debugchance"/>

      <!-- ============================================================== -->
      <!-- STEP 11: Opportunistic supply (after sell, if enabled)         -->
      <!-- ============================================================== -->
      <do_if value="this.$supply and not this.$supplySkipped and not this.$supplyPriority">
        <!-- Check if any resource is below target (not threshold — just below target) -->
        <set_value name="$needsSupply" exact="false"/>
        <set_value name="$stationResources" exact="this.$homeStation.resources.list"/>
        <do_if value="$stationResources.count gt 0 and this.$homeStation.money gt 0">
          <do_all exact="$stationResources.count" counter="$ri">
            <set_value name="$res" exact="$stationResources.{$ri}"/>
            <do_if value="this.$homeStation.cargo.{$res}.count lt this.$homeStation.cargo.{$res}.target">
              <set_value name="$needsSupply" exact="true"/>
              <break/>
            </do_if>
          </do_all>
        </do_if>

        <do_if value="$needsSupply">
          <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': Attempting opportunistic supply after sell cycle'" chance="this.$debugchance"/>
          <!-- Trigger supply phase on next iteration by setting the flag -->
          <set_value name="this.$supplyPriority" exact="true"/>
          <wait exact="this.$gt_yieldMs * 1ms" comment="Cooperative yield"/>
          <resume label="main_loop"/>
        </do_if>
      </do_if>

      <!-- Short yield before next cycle -->
      <wait exact="this.$gt_yieldMs * 1ms" comment="Cooperative yield before next cycle"/>

      <!-- Loop back -->
      <resume label="main_loop"/>

    </actions>
  </attention>
  <on_abort>
    <!-- Cleanup: unregister station from MK1 supply registry -->
    <do_if value="this.$homeStation? and global.$GT_MK1SuppliedStations? and global.$GT_MK1SuppliedStations.{this.$homeStation}? and global.$GT_MK1SuppliedStations.{this.$homeStation} == this.ship">
      <remove_value name="global.$GT_MK1SuppliedStations.{this.$homeStation}"/>
      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': on_abort — unregistered station from supply registry'" chance="100"/>
    </do_if>
    <!-- Bridge MK1 aborts into MD cleanup pipeline (name restore, registry cleanup, mod cleanup). -->
    <set_value name="$cleanupTraceId" exact="this.ship.idcode + '|MK1_ON_ABORT|' + (player.age / 1s)i"/>
    <set_value name="$cleanupDefaultOrder" exact="'NONE'"/>
    <do_if value="this.ship.defaultorder?">
      <set_value name="$cleanupDefaultOrder" exact="@$this.ship.defaultorder.id"/>
    </do_if>
    <set_value name="$cleanupCommanderId" exact="'NONE'"/>
    <set_value name="$cleanupCommanderOrder" exact="'NONE'"/>
    <do_if value="this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
      <set_value name="$cleanupCommanderId" exact="@$this.ship.commander.idcode"/>
      <do_if value="this.ship.commander.defaultorder?">
        <set_value name="$cleanupCommanderOrder" exact="@$this.ship.commander.defaultorder.id"/>
      </do_if>
    </do_if>
    <do_if value="not global.$GT_CleanupIntent?">
      <set_value name="global.$GT_CleanupIntent" exact="table[]"/>
    </do_if>
    <set_value name="global.$GT_CleanupIntent.{this.ship}" exact="table[
      $Active = true,
      $StartTime = player.age,
      $ExpireTime = player.age + 8s,
      $Source = 'MK1_ON_ABORT',
      $TraceId = $cleanupTraceId,
      $DefaultOrderAtSignal = $cleanupDefaultOrder,
      $CommanderAtSignal = $cleanupCommanderId
    ]"/>
    <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
      $Ship = this.ship,
      $UpdateType = 'GT_Order_Cancelled',
      $Source = 'MK1_ON_ABORT',
      $TraceId = $cleanupTraceId
    ]"/>
    <signal_objects object="player.galaxy" param="'GT_Check_Ship_Orphaned'" param2="table[
      $Ship = this.ship,
      $Source = 'MK1_ON_ABORT',
      $TraceId = $cleanupTraceId
    ]"/>
    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
      <debug_text text="'[GT-CleanupTrace] trace=' + $cleanupTraceId + ' source=MK1_ON_ABORT ship=' + this.ship.idcode + ' default=' + $cleanupDefaultOrder + ' commander=' + $cleanupCommanderId + ' commanderOrder=' + $cleanupCommanderOrder + ' action=SIGNAL_GT_ORDER_CANCELLED+ORPHAN_CHECK'" chance="100"/>
      <debug_text text="'[GT-MK1] ' + this.ship.idcode + ': on_abort -> triggered orphan cleanup check'" chance="100"/>
    </do_if>
  </on_abort>
</aiscript>
