<?xml version="1.0" encoding="utf-8"?>
<aiscript name="order.trade.galaxytrader" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/aiscripts.xsd" version="3">
  <order id="GalaxyTraderMK3" name="{77000, 10002}" description="{77000, 10102}" category="trade" infinite="true" allowinloop="false" canplayercancel="true">
    <params>
      <!-- ========================================== -->
      <!-- BASIC TRADING SETTINGS                    -->
      <!-- ========================================== -->
              <param name="home" default="this.sector" type="object" text="{77000,1002}" comment="Home base for trading operations (sector or station)">
        <input_param name="class" value="[class.sector,class.station]"/>
      </param>
      <param name="maxbuy" default="[if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 2) then 1 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 5) then 3 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 8) then 5 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 11) then 10 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 13) then 15 else 25, 1].max" type="number" text="{1041, 10054}" comment="Maximum gate distance for buy opportunities (skill-based: Lv1-2=1j, Lv3-5=3j, Lv6-8=5j, Lv9-11=10j, Lv12-13=15j, Lv14+=25j)">
        <input_param name="startvalue" value="0"/>
        <input_param name="min" value="0"/>
        <input_param name="max" value="[if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 2) then 1 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 5) then 3 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 8) then 5 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 11) then 10 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 13) then 15 else 25, 1].max"/>
        <input_param name="step" value="1"/>
      </param>
      <param name="maxsell" default="[if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 2) then 1 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 5) then 3 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 8) then 5 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 11) then 10 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 13) then 15 else 25, 1].max" type="number" text="{1041, 10057}" comment="Maximum gate distance for sell opportunities (skill-based: Lv1-2=1j, Lv3-5=3j, Lv6-8=5j, Lv9-11=10j, Lv12-13=15j, Lv14+=25j)">
        <input_param name="startvalue" value="0"/>
        <input_param name="min" value="0"/>
        <input_param name="max" value="[if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 2) then 1 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 5) then 3 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 8) then 5 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 11) then 10 else if ([@this.ship.pilot.skill.management, @this.ship.commander.tradenpc.skill.management].max le 13) then 15 else 25, 1].max"/>
        <input_param name="step" value="1"/>
      </param>
      <param name="allowillegal" default="false" type="bool" text="{77000,1011}" comment="{77000,1025}"/>
      <param name="ignorecarrieraux" default="false" type="bool" text="{77000,1054}" comment="{77000,1055}"/>
      <param name="ignorebuildstorage" default="false" type="bool" text="{77000,1056}" comment="{77000,1057}"/>
      <param name="logbookentries" default="true" type="bool" text="{77000,1012}" comment="{77000,1041}"/>
      <param name="factionpriority" default="1" type="number" text="{77000,1014}" comment="Trading priority: 0=Player stations only, 1=Foreign factions first (recommended), 2=All factions equally">
        <input_param name="min" value="0"/>
        <input_param name="max" value="2"/>
        <input_param name="step" value="1"/>
      </param>
      
      <!-- ========================================== -->
      <!-- WARE SELECTION                           -->
      <!-- ========================================== -->
      <param name="autowares" default="true" type="bool" text="{77000,1015}" comment="{77000,1023}"/>
      <param name="warebasket" default="[]" type="list" text="{1041, 10179}" comment="Manual ware selection (only used if Auto Wares is disabled)">
        <input_param name="type" value="'ware'"/>
        <input_param name="cancarry" value="this.ship"/>
      </param>
      <param name="sectorwhitelist" default="[]" type="list" text="{77000,1052}" comment="{77000,1053}">
        <input_param name="type" value="'object'"/>
        <input_param name="class" value="[class.sector]"/>
      </param>
      
      <!-- ========================================== -->
      <!-- TRADING RANGE (Ship-specific)             -->
      <!-- ========================================== -->
      <param name="distancepenalty" default="50" type="number" text="{77000,1016}" comment="Distance impact on trade scoring: 0%=Ignore distance (pure profit), 50%=Balanced, 100%=Prefer close trades (2x distance penalty)">
        <input_param name="min" value="0"/>
        <input_param name="max" value="100"/>
        <input_param name="step" value="5"/>
      </param>
      
      <!-- ========================================== -->
      <!-- NOTIFICATION LEVEL (Global setting override) -->
      <!-- ========================================== -->
      <param name="notifications" default="1" type="number" text="{77000,1017}" comment="{77000,1032}">
        <input_param name="min" value="0"/>
        <input_param name="max" value="2"/>
        <input_param name="step" value="1"/>
      </param>
      
      <!-- ========================================== -->
      <!-- ADVANCED SETTINGS                         -->
      <!-- ========================================== -->
      <param name="fleetcoordination" default="true" type="bool" text="{77000,1018}" advanced="true" comment="{77000,1029}"/>
      <param name="cargotarget" default="90" type="number" text="{77000,1019}" advanced="true" comment="{77000,1033}">
        <input_param name="min" value="50"/>
        <input_param name="max" value="100"/>
        <input_param name="step" value="5"/>
      </param>
      <param name="marketupdatefreq" default="60s" type="time" text="{77000,1050}" advanced="true" comment="{77000,1034}">
        <input_param name="min" value="30s"/>
        <input_param name="max" value="300s"/>
        <input_param name="step" value="30s"/>
      </param>
      <param name="debuglevel" default="1" type="number" text="{1041, 10086}" advanced="true" comment="{77000,1035}">
        <input_param name="min" value="0"/>
        <input_param name="max" value="2"/>
        <input_param name="step" value="1"/>
      </param>
      <param name="tradeeval" default="false" type="bool" text="{77000,1051}" advanced="true" comment="{77000,1040}"/>
    </params>
    <requires>
      <match shiptype="shiptype.lasertower" negate="true"/>
    </requires>
  </order>
  
  <interrupts>
    <handler ref="SectorChangeHandler"/>
    
    <handler ref="AttackHandler"/>
    <handler ref="MissileLockHandler"/>
    <handler ref="ScannedHandler"/>
    <handler ref="InspectedHandler"/>
    <handler ref="FoundAbandonedHandler"/>
    <handler ref="FoundLockboxHandler"/>
    <handler ref="ResupplyHandler"/>
    <handler ref="TargetInvalidHandler"/>
    <handler ref="TideHandler"/>
    
    <!-- High-Performance Training Event Handlers -->
    <handler>
      <conditions>
        <event_object_signalled object="this.ship" param="'GT_Training_Station_Found'"/>
      </conditions>
      <actions>
        <set_value name="$trainingData" exact="event.param2"/>
        <set_value name="$trainingStation" exact="$trainingData.$Station"/>
        <set_value name="$requiredLevel" exact="$trainingData.$Level"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': ðŸŽ“ Training station found: ' + $trainingStation.knownname + ' for level ' + $requiredLevel" chance="100"/>
        </do_if>
        
        <!-- Create training order immediately (event-driven, no polling) -->
        <create_order object="this.ship" id="'DockAndTrain'" immediate="true">
          <param name="destination" value="$trainingStation"/>
          <param name="debugchance" value="$debugchance"/>
        </create_order>
        
        <!-- Set flag to indicate training is in progress -->
        <set_value name="this.$training_in_progress" exact="true"/>
        <!-- Set flag to indicate training transition for on_abort handler -->
        <set_value name="this.$training_transition" exact="true"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': DockAndTrain order created for ' + $trainingStation.knownname" chance="100"/>
        </do_if>
        
        <!-- Set flag to prevent race condition in on_abort handler -->
        <!-- Ensures the on_abort handler knows a training order was just created -->
        <set_value name="this.$training_order_created" exact="player.age"/>
      </actions>
    </handler>
    
    <!-- Event-Driven Mobile Satellite Intelligence: Detect stations entering radar range -->
    <!-- 
    OPTIMIZED: Event-driven station detection (replaces polling-based MobileSatelliteIntelligence)
    - Uses vanilla gravidar scan events (zero CPU when no stations detected)
    - Only Level 9+ pilots can detect stations (skill gate maintained)
    - Signals MD immediately when stations detected (no polling overhead)
    - Same functionality as old polling system but much more efficient
    -->
    <handler comment="Detect stations entering radar range for mobile satellite intelligence">
      <conditions>
        <event_gravidar_has_scanned object="this.ship"/>
        <check_value value="this.ship.pilot? and global.$GT_Pilots.{this.ship.pilot}?"/>
        <check_value value="this.sector"/>
        <!-- Only Level 9+ pilots and when Mobile Intel is enabled -->
        <check_value value="@global.$GT_Pilots.{this.ship.pilot}.$Level ge 9"/>
        <check_value value="not global.$GT_GlobalSettings.$MobileIntel? or global.$GT_GlobalSettings.$MobileIntel.$Enable"/>
        <!-- PERFORMANCE: Do not run actions unless there is at least 1 station contact -->
        <!-- Vanilla pattern: use count_gravidar_contacts with min="1" to avoid per-scan work when nothing is detected -->
        <count_gravidar_contacts result="$_detectedStations" object="this.ship" class="class.station" docked="false" checkoperational="true" multiple="true" min="1"/>
      </conditions>
      <actions>
        <!-- Stations were detected (min=1 in conditions). Process a small capped number per scan to smooth spikes. -->
        <set_value name="$level" exact="@global.$GT_Pilots.{this.ship.pilot}.$Level"/>
        <set_value name="$detectedStations" exact="$_detectedStations"/>
        
        <!-- Cap work per scan event (prevents large bursts when many stations are in radar range) -->
        <set_value name="$stationsToProcess" exact="[$detectedStations.count, 5].min"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI-Intel] ' + this.ship.idcode + ' detected ' + $detectedStations.count + ' station(s) - processing ' + $stationsToProcess" chance="20"/>
        </do_if>
        
        <do_all exact="$stationsToProcess" counter="$i">
          <set_value name="$station" exact="$detectedStations.{$i}"/>
          <do_if value="$station.exists and $station.isoperational">
            <!-- Signal MD to process this station -->
            <signal_objects object="player.galaxy" param="'GT_Station_Detected'" param2="table[$ship=this.ship, $station=$station, $pilotLevel=$level]"/>
          </do_if>
        </do_all>
      </actions>
    </handler>
    
    <!-- Subordinate Resync Handler: Listen for commander order changes (like vanilla order.assist) -->
    <handler comment="Subordinate resync on commander order change">
      <conditions>
        <check_all>
          <event_object_order_ready object="this.ship.commander" check="false" comment="Commander's order ready"/>
          <check_value value="event.param == event.object.defaultorder" comment="It's the default order"/>
        </check_all>
      </conditions>
      <actions>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Commander order changed - restarting to resync settings'" chance="100"/>
        </do_if>
        <!-- Use abort_called_scripts like vanilla - forcefully restart at init label -->
        <abort_called_scripts resume="init"/>
      </actions>
    </handler>
    
    <!-- Commander change detection handler -->
    <!-- Tests if commander change detection interferes with trade execution -->
    <!-- This handler fires BEFORE the subordinate resync handler restarts the script -->
    <!-- Using this.assignedcontrolled like vanilla order.assist.xml -->
    <handler comment="Commander removed or changed">
      <conditions>
        <event_object_commander_set object="this.assignedcontrolled"/>
      </conditions>
      <actions>
        <set_value name="$newCommander" exact="event.param"/>
        
        <!-- Update state machine BEFORE script restarts -->
        <set_value name="$newCommanderHasGT" exact="false"/>
        <do_if value="@$newCommander.exists">
          <do_if value="$newCommander.defaultorder? and @$newCommander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$newCommanderHasGT" exact="true"/>
          </do_if>
        </do_if>
        
        <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
          $Ship = this.ship,
          $UpdateType = 'Commander_Changed',
          $Commander = $newCommander,
          $CommanderHasGT = $newCommanderHasGT
        ]"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] PHASE 6: Commander change detected for ' + this.ship.idcode + ' (commander: ' + (if @$newCommander.exists then @$newCommander.idcode else 'NONE') + ', has GT: ' + $newCommanderHasGT + ')'" chance="100"/>
        </do_if>
        
        <!-- NOTE: Script will restart via subordinate resync handler if commander has order change -->
        <!-- But signal is sent FIRST, so state manager can process it -->
      </actions>
    </handler>
    
    <handler>
      <conditions>
        <event_object_signalled object="this.ship" param="'GT_Training_Complete'"/>
      </conditions>
      <actions>
        <set_value name="$completionData" exact="event.param2"/>
        <set_value name="$completedLevel" exact="$completionData.$Level"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Training completed for level ' + $completedLevel + ' - setting flag to resume trading'" chance="100"/>
        </do_if>
        
        <!-- Set flag to resume trading (can't use resume in interrupt handler) -->
        <set_value name="this.$training_complete" exact="true"/>
        <remove_value name="this.$training_in_progress"/>
        <remove_value name="this.$training_transition"/>
        <remove_value name="this.$training_order_created"/>
      </actions>
    </handler>
    
    <handler>
      <conditions>
        <event_object_signalled object="this.ship" param="'GT_Training_Failed'"/>
      </conditions>
      <actions>
        <set_value name="$failureData" exact="event.param2"/>
        <set_value name="$reason" exact="$failureData.$Reason"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Training failed: ' + $reason + ' - setting flag to resume trading'" chance="100"/>
        </do_if>
        
        <!-- Set flag to resume trading (can't use resume in interrupt handler) -->
        <set_value name="this.$training_complete" exact="true"/>
        <remove_value name="this.$training_in_progress"/>
        <remove_value name="this.$training_transition"/>
        <remove_value name="this.$training_order_created"/>
      </actions>
    </handler>
    
    <!-- Order cancellation detection handler -->
    <!-- Detects when GT default order is cancelled -->
    <!-- Note: Ships always have a default order (Wait, Assist, etc.), so we check:
         1. If cancelled order was GT order (event.param.id == 'GalaxyTraderMK3')
         2. If ship is still GT-controlled (direct GT order OR subordinate with GT commander via Assist)
         3. Only act if ship is no longer GT-controlled -->
    <handler comment="GT order cancelled">
      <conditions>
        <event_object_order_cancelled object="this.ship" immediate="true"/>
        <!-- Note: Ships always have a default order (Wait, Assist, etc.), so we check the cancelled order ID and current default order -->
      </conditions>
      <actions>
        <!-- Check which order was cancelled -->
        <set_value name="$cancelledOrderId" exact="@event.param.id"/>
        <set_value name="$currentDefaultOrder" exact="@this.ship.defaultorder.id"/>
        
        <!-- Unified GT order status check (inline for AI scripts) -->
        <set_value name="$hasDirectGTOrder" exact="false"/>
        <set_value name="$hasGTCommander" exact="false"/>
        <set_value name="$isGTControlled" exact="false"/>
        
        <!-- Check direct GT order -->
        <do_if value="$currentDefaultOrder == 'GalaxyTraderMK3'">
          <set_value name="$hasDirectGTOrder" exact="true"/>
          <set_value name="$isGTControlled" exact="true"/>
        </do_if>
        
        <!-- Check commander status -->
        <do_if value="not $hasDirectGTOrder and this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
          <do_if value="this.ship.commander.defaultorder? and @this.ship.commander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$hasGTCommander" exact="true"/>
            <do_if value="$currentDefaultOrder == 'Assist'">
              <set_value name="$isGTControlled" exact="true"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Only act if GT order was actually cancelled (ship is no longer GT-controlled) -->
        <do_if value="not $isGTControlled">
          <!-- Check if GT order was explicitly cancelled OR if current default is not GT/Assist-with-GT-commander -->
          <do_if value="$cancelledOrderId == 'GalaxyTraderMK3' or not $cancelledOrderId">
            <!-- GT order is being cancelled â†’ send Phase 7 signal -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] PHASE 7: GT order cancelled for ' + this.ship.idcode + ' (interrupt handler, cancelled order: ' + (if $cancelledOrderId then $cancelledOrderId else 'NONE') + ', current default: ' + (if $currentDefaultOrder then $currentDefaultOrder else 'NONE') + ', still GT-controlled: ' + $isGTControlled + ')'" chance="100"/>
            </do_if>
            <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
              $Ship = this.ship,
              $UpdateType = 'GT_Order_Cancelled'
            ]"/>
            
            <!-- EVENT-DRIVEN: Trigger orphaned ship check -->
            <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.ship}?">
              <signal_objects object="player.galaxy" param="'GT_Check_Ship_Orphaned'" param2="table[$Ship = this.ship]"/>
            </do_if>
            
            <!-- Restore ship name if not GT-controlled (direct or subordinate) -->
            <do_if value="not $hasDirectGTOrder and not $hasGTCommander and this.ship.pilot?">
              <set_value name="$originalName" exact="null"/>
              <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName?">
                <set_value name="$originalName" exact="global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName"/>
              </do_if>
              
              <do_if value="$originalName">
                <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
                  $Ship = this.ship,
                  $Pilot = this.ship.pilot,
                  $Reason = 'GT order cancelled - restoring original name',
                  $OriginalName = $originalName
                ]"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-AI] PHASE 7: Name restoration signal sent for ' + this.ship.idcode" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
        <do_else>
          <!-- Ship is still GT-controlled (direct GT order or subordinate with GT commander) - skip -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Order cancelled interrupt fired but ship still GT-controlled (cancelled: ' + (if $cancelledOrderId then $cancelledOrderId else 'NONE') + ', current default: ' + (if $currentDefaultOrder then $currentDefaultOrder else 'NONE') + ', still GT-controlled: ' + $isGTControlled + ') - skipping Phase 7'" chance="100"/>
          </do_if>
        </do_else>
      </actions>
    </handler>

  </interrupts>
  
  <init>
    <set_order_syncpoint_reached order="this.ship.order"/>
    <set_command command="command.searchtrades"/>
    <set_command_action commandaction="commandaction.searchingtrades"/>
    
    <!-- Legacy persistent variables removed - no longer needed with unified maintenance system -->
    
    <!-- ============================================================================= -->
    <!-- SAVE GAME CLEANUP: Clear stale tracking data when loading from a save game  -->
    <!-- ============================================================================= -->
    <!-- Check if resupply tracking exists and verify if the order is still active.   -->
    <!-- Only remove tracking if the order no longer exists (stale data).             -->
    <!-- ============================================================================= -->
    <!-- PERFORMANCE: Optimized resupply order check - use order.id property instead of iterating all orders -->
    <do_if value="global.$GT_ResupplyOrders? and global.$GT_ResupplyOrders.{this.ship}?">
      <!-- Check if ship has active resupply/repair/equipment order using order.id (more efficient than iterating) -->
      <set_value name="$hasActiveResupplyOrder" exact="false"/>
      <!-- Our resupply uses order.build.equip, whose order id is 'Equip' (vanilla) -->
      <do_if value="this.ship.order? and (this.ship.order.id == 'Resupply' or this.ship.order.id == 'Repair' or this.ship.order.id == 'Equip')">
        <set_value name="$hasActiveResupplyOrder" exact="true"/>
      </do_if>
      
      <do_if value="not $hasActiveResupplyOrder">
        <!-- No active order - tracking is stale, remove it -->
        <remove_value name="global.$GT_ResupplyOrders.{this.ship}"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Cleared stale resupply tracking (no active order)'" chance="100"/>
        </do_if>
      </do_if>
      <do_else>
        <!-- Order still active - keep tracking -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Resupply order still active after save load - keeping tracking'" chance="100"/>
        </do_if>
      </do_else>
    </do_if>
    
    <!-- ============================================================================= -->
    <!-- MODULAR INITIALIZATION - REPLACES ~200 LINES OF COMPLEX INITIALIZATION CODE -->
    <!-- ============================================================================= -->
    
    <!-- CRITICAL DEBUG: Log that init block started -->
    <debug_text text="'[GT-AI] ' + this.ship.idcode + ': === INIT BLOCK STARTED === (Ship: ' + this.ship.knownname + ', Pilot: ' + (if this.ship.pilot then this.ship.pilot.name else 'NONE') + ')'" chance="100"/>
    
    <!-- Create order parameters table for library compatibility -->
    <set_value name="$orderParams" exact="table[]"/>
    
    <!-- Legacy maintenance variables removed - no longer needed with unified maintenance system -->
    
    <!-- SUBORDINATE HOME BASE INHERITANCE: If subordinate, ALWAYS inherit commander's home -->
    <set_value name="$effectiveHome" exact="$home"/>
    <do_if value="this.ship.commander and this.ship.commander.exists and this.ship.commander != this.ship">
      <!-- Ship is a subordinate - ALWAYS inherit commander's home sector -->
      <do_if value="this.ship.commander.defaultorder and this.ship.commander.defaultorder.$home?">
        <set_value name="$effectiveHome" exact="this.ship.commander.defaultorder.$home"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Subordinate inheriting home base from commander ' + this.ship.commander.idcode + ': ' + $effectiveHome.knownname" chance="100"/>
        </do_if>
      </do_if>
    </do_if>
    
    <!-- Store as script variable for persistence throughout execution -->
    <set_value name="this.$effectiveHome" exact="$effectiveHome"/>
    
    <!-- ============================================================================= -->
    <!-- SUBORDINATE SETTINGS INHERITANCE: Inherit strategic settings from commander -->
    <!-- ============================================================================= -->
    <set_value name="$isSubordinate" exact="this.ship.commander and this.ship.commander.exists and this.ship.commander != this.ship"/>
    <set_value name="$commanderOrder" exact="null"/>
    <do_if value="$isSubordinate">
      <set_value name="$commanderOrder" exact="this.ship.commander.defaultorder"/>
    </do_if>
    
    <!-- Sector Whitelist -->
    <set_value name="$effectiveSectorWhitelist" exact="$sectorwhitelist"/>
    <do_if value="$isSubordinate and $commanderOrder and $commanderOrder.$sectorwhitelist?">
      <set_value name="$effectiveSectorWhitelist" exact="$commanderOrder.$sectorwhitelist"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Subordinate inheriting sector whitelist from commander ' + this.ship.commander.idcode" chance="100"/>
        </do_if>
    </do_if>
    
    <!-- Fleet Coordination -->
    <set_value name="$effectiveFleetCoordination" exact="$fleetcoordination"/>
    <do_if value="$isSubordinate and $commanderOrder and $commanderOrder.$fleetcoordination?">
      <set_value name="$effectiveFleetCoordination" exact="$commanderOrder.$fleetcoordination"/>
    </do_if>
    
    <!-- Allow Illegal Wares -->
    <set_value name="$effectiveAllowIllegal" exact="$allowillegal"/>
    <do_if value="$isSubordinate and $commanderOrder and $commanderOrder.$allowillegal?">
      <set_value name="$effectiveAllowIllegal" exact="$commanderOrder.$allowillegal"/>
    </do_if>
    
    <!-- Ignore Carrier/Aux -->
    <set_value name="$effectiveIgnoreCarrierAux" exact="$ignorecarrieraux"/>
    <do_if value="$isSubordinate and $commanderOrder and $commanderOrder.$ignorecarrieraux?">
      <set_value name="$effectiveIgnoreCarrierAux" exact="$commanderOrder.$ignorecarrieraux"/>
    </do_if>
    
    <!-- Ignore Build Storage -->
    <set_value name="$effectiveIgnoreBuildStorage" exact="$ignorebuildstorage"/>
    <do_if value="$isSubordinate and $commanderOrder and $commanderOrder.$ignorebuildstorage?">
      <set_value name="$effectiveIgnoreBuildStorage" exact="$commanderOrder.$ignorebuildstorage"/>
    </do_if>
    
    <!-- Faction Priority -->
    <set_value name="$effectiveFactionPriority" exact="$factionpriority"/>
    <do_if value="$isSubordinate and $commanderOrder and $commanderOrder.$factionpriority?">
      <set_value name="$effectiveFactionPriority" exact="$commanderOrder.$factionpriority"/>
    </do_if>
    
    <!-- Auto Wares -->
    <set_value name="$effectiveAutoWares" exact="$autowares"/>
    <do_if value="$isSubordinate and $commanderOrder and $commanderOrder.$autowares?">
      <set_value name="$effectiveAutoWares" exact="$commanderOrder.$autowares"/>
    </do_if>
    
    <!-- Ware Basket -->
    <set_value name="$effectiveWareBasket" exact="$warebasket"/>
    <do_if value="$isSubordinate and $commanderOrder and $commanderOrder.$warebasket?">
      <set_value name="$effectiveWareBasket" exact="$commanderOrder.$warebasket"/>
    </do_if>
    
    <!-- Distance Penalty -->
    <set_value name="$effectiveDistancePenalty" exact="$distancepenalty"/>
    <do_if value="$isSubordinate and $commanderOrder and $commanderOrder.$distancepenalty?">
      <set_value name="$effectiveDistancePenalty" exact="$commanderOrder.$distancepenalty"/>
    </do_if>
    
    <!-- Logbook Entries -->
    <set_value name="$effectiveLogbookEntries" exact="$logbookentries"/>
    <do_if value="$isSubordinate and $commanderOrder and $commanderOrder.$logbookentries?">
      <set_value name="$effectiveLogbookEntries" exact="$commanderOrder.$logbookentries"/>
    </do_if>
    
    <!-- Notifications -->
    <set_value name="$effectiveNotifications" exact="$notifications"/>
    <do_if value="$isSubordinate and $commanderOrder and $commanderOrder.$notifications?">
      <set_value name="$effectiveNotifications" exact="$commanderOrder.$notifications"/>
    </do_if>
    
    <!-- Debug Level -->
    <set_value name="$effectiveDebugLevel" exact="$debuglevel"/>
    <do_if value="$isSubordinate and $commanderOrder and $commanderOrder.$debuglevel?">
      <set_value name="$effectiveDebugLevel" exact="$commanderOrder.$debuglevel"/>
    </do_if>
    
    <!-- Trade Evaluation Logging -->
    <set_value name="$effectiveTradeEval" exact="$tradeeval"/>
    <do_if value="$isSubordinate and $commanderOrder and $commanderOrder.$tradeeval?">
      <set_value name="$effectiveTradeEval" exact="$commanderOrder.$tradeeval"/>
    </do_if>
    
    <!-- PERFORMANCE: Calculate pilot skill once and reuse for both MaxBuy and MaxSell -->
    <!-- Calculate subordinate's pilot capability (only if subordinate) -->
    <set_value name="$pilotMaxJumps" exact="null"/>
    <do_if value="$isSubordinate and $commanderOrder">
      <!-- Calculate pilot skill once -->
      <set_value name="$pilotSkill" exact="1"/>
      <do_if value="@this.ship.pilot and @this.ship.pilot.skill and @this.ship.pilot.skill.management != null">
        <set_value name="$pilotSkill" exact="@this.ship.pilot.skill.management"/>
      </do_if>
      
      <!-- Calculate pilot's max jump capability once -->
      <do_if value="$pilotSkill le 2">
        <set_value name="$pilotMaxJumps" exact="1"/>
      </do_if>
      <do_elseif value="$pilotSkill le 5">
        <set_value name="$pilotMaxJumps" exact="3"/>
      </do_elseif>
      <do_elseif value="$pilotSkill le 8">
        <set_value name="$pilotMaxJumps" exact="5"/>
      </do_elseif>
      <do_elseif value="$pilotSkill le 11">
        <set_value name="$pilotMaxJumps" exact="10"/>
      </do_elseif>
      <do_elseif value="$pilotSkill le 13">
        <set_value name="$pilotMaxJumps" exact="15"/>
      </do_elseif>
      <do_else>
        <set_value name="$pilotMaxJumps" exact="25"/>
      </do_else>
    </do_if>
    
    <!-- Max Buy Distance - Inherit from commander, capped at pilot capability -->
    <set_value name="$effectiveMaxBuy" exact="$maxbuy"/>
    <do_if value="$isSubordinate and $commanderOrder and $commanderOrder.$maxbuy? and $pilotMaxJumps != null">
      <!-- Inherit commander's max, but cap at pilot capability (reuse calculated $pilotMaxJumps) -->
      <set_value name="$commanderMaxBuy" exact="$commanderOrder.$maxbuy"/>
      <set_value name="$effectiveMaxBuy" exact="[$commanderMaxBuy, $pilotMaxJumps].min"/>
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': MaxBuy inherited: commander=' + $commanderMaxBuy + ', pilot_cap=' + $pilotMaxJumps + ', effective=' + $effectiveMaxBuy" chance="100"/>
      </do_if>
    </do_if>
    
    <!-- Max Sell Distance - Inherit from commander, capped at pilot capability -->
    <set_value name="$effectiveMaxSell" exact="$maxsell"/>
    <do_if value="$isSubordinate and $commanderOrder and $commanderOrder.$maxsell? and $pilotMaxJumps != null">
      <!-- Inherit commander's max, but cap at pilot capability (reuse calculated $pilotMaxJumps) -->
      <set_value name="$commanderMaxSell" exact="$commanderOrder.$maxsell"/>
      <set_value name="$effectiveMaxSell" exact="[$commanderMaxSell, $pilotMaxJumps].min"/>
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': MaxSell inherited: commander=' + $commanderMaxSell + ', pilot_cap=' + $pilotMaxJumps + ', effective=' + $effectiveMaxSell" chance="100"/>
      </do_if>
    </do_if>
    
    <!-- Debug message for subordinates showing inherited settings -->
    <!-- PERFORMANCE: Only build inherited settings string if debug logging is enabled -->
    <!-- Skip expensive string concatenation loop if not needed -->
    <do_if value="$isSubordinate and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
      <set_value name="$inheritedSettings" exact="[]"/>
      <do_if value="$effectiveFleetCoordination != $fleetcoordination"><append_to_list name="$inheritedSettings" exact="'FleetCoord=' + $effectiveFleetCoordination"/></do_if>
      <do_if value="$effectiveAllowIllegal != $allowillegal"><append_to_list name="$inheritedSettings" exact="'AllowIllegal=' + $effectiveAllowIllegal"/></do_if>
      <do_if value="$effectiveFactionPriority != $factionpriority"><append_to_list name="$inheritedSettings" exact="'FactionPri=' + $effectiveFactionPriority"/></do_if>
      <do_if value="$effectiveAutoWares != $autowares"><append_to_list name="$inheritedSettings" exact="'AutoWares=' + $effectiveAutoWares"/></do_if>
      <do_if value="$effectiveDistancePenalty != $distancepenalty"><append_to_list name="$inheritedSettings" exact="'DistPenalty=' + $effectiveDistancePenalty + '%'"/></do_if>
      <do_if value="$effectiveLogbookEntries != $logbookentries"><append_to_list name="$inheritedSettings" exact="'Logbook=' + $effectiveLogbookEntries"/></do_if>
      <do_if value="$effectiveNotifications != $notifications"><append_to_list name="$inheritedSettings" exact="'Notify=' + $effectiveNotifications"/></do_if>
      <do_if value="$effectiveDebugLevel != $debuglevel"><append_to_list name="$inheritedSettings" exact="'Debug=' + $effectiveDebugLevel"/></do_if>
      <do_if value="$effectiveTradeEval != $tradeeval"><append_to_list name="$inheritedSettings" exact="'TradeEval=' + $effectiveTradeEval"/></do_if>
      <do_if value="$effectiveMaxBuy != $maxbuy"><append_to_list name="$inheritedSettings" exact="'MaxBuy=' + $effectiveMaxBuy + 'j'"/></do_if>
      <do_if value="$effectiveMaxSell != $maxsell"><append_to_list name="$inheritedSettings" exact="'MaxSell=' + $effectiveMaxSell + 'j'"/></do_if>
      
      <do_if value="$inheritedSettings.count gt 0">
        <set_value name="$inheritedSettingsText" exact="''"/>
        <do_all exact="$inheritedSettings.count" counter="$i">
          <set_value name="$inheritedSettingsText" exact="$inheritedSettingsText + $inheritedSettings.{$i}"/>
          <do_if value="$i lt $inheritedSettings.count">
            <set_value name="$inheritedSettingsText" exact="$inheritedSettingsText + ', '"/>
          </do_if>
        </do_all>
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Subordinate inherited settings from ' + this.ship.commander.idcode + ': ' + $inheritedSettingsText" chance="100"/>
      </do_if>
    </do_if>
    
    <set_value name="$orderParams.$home" exact="$effectiveHome"/>
    <set_value name="$orderParams.$maxbuy" exact="$effectiveMaxBuy"/>
    <set_value name="$orderParams.$maxsell" exact="$effectiveMaxSell"/>
    <set_value name="$orderParams.$allowillegal" exact="$effectiveAllowIllegal"/>
    <set_value name="$orderParams.$factionpriority" exact="$effectiveFactionPriority"/>
    <set_value name="$orderParams.$autowares" exact="$effectiveAutoWares"/>
    <set_value name="$orderParams.$warebasket" exact="$effectiveWareBasket"/>
    <set_value name="$orderParams.$distancepenalty" exact="$effectiveDistancePenalty"/>
    <set_value name="$orderParams.$notifications" exact="$effectiveNotifications"/>
    <set_value name="$orderParams.$cargotarget" exact="$cargotarget"/>
    <set_value name="$orderParams.$marketupdatefreq" exact="$marketupdatefreq"/>
    <set_value name="$orderParams.$debuglevel" exact="$effectiveDebugLevel"/>
    <set_value name="$orderParams.$tradeeval" exact="$effectiveTradeEval"/>
    <set_value name="$orderParams.$fleetcoordination" exact="$effectiveFleetCoordination"/>
    <set_value name="$orderParams.$logbookentries" exact="$effectiveLogbookEntries"/>
    <set_value name="$orderParams.$sectorwhitelist" exact="$effectiveSectorWhitelist"/>
    
    <!-- =========================================== -->
    <!-- HIGH-PERFORMANCE INITIALIZATION (Option A) -->
    <!-- =========================================== -->
    
    <!-- Fast variable assignment - using effective (inherited) values -->
    <set_value name="$gt_debuglevel" exact="$effectiveDebugLevel"/>
    <!-- Only set debugchance > 0 if GT debug logging is enabled globally -->
    <set_value name="$debugchance" exact="0"/>
    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
      <set_value name="$debugchance" exact="if $gt_debuglevel ge 2 then 100 else if $gt_debuglevel ge 1 then 50 else 0"/>
    </do_if>
    
    <!-- Core trading parameters (performance optimized) - using effective (inherited) values -->
    <set_value name="$gt_allowillegal" exact="$effectiveAllowIllegal"/>
    <set_value name="$gt_factionpriority" exact="$effectiveFactionPriority"/>
    <!-- Convert distance penalty from 0-100% to multiplier: 0%=0.0, 50%=1.0, 100%=2.0 -->
    <set_value name="$gt_distancepenalty" exact="$effectiveDistancePenalty / 50.0"/>
    <set_value name="$gt_cargotarget" exact="$cargotarget"/>
    <set_value name="$gt_marketupdatefreq" exact="$marketupdatefreq"/>
    <set_value name="$gt_logbookentries" exact="$effectiveLogbookEntries"/>
    
    <!-- Global defaults (fastest approach - direct assignment) -->
    <set_value name="$gt_enablexp" exact="true"/>
    <set_value name="$gt_autotraining" exact="true"/>
    <set_value name="$gt_fleetcoord" exact="false"/>
    
    <!-- Ware selection (optimized) - using effective inherited values -->
    <set_value name="$warebasket" exact="if $effectiveAutoWares then [] else $effectiveWareBasket"/>
    
    <!-- Single non-blocking signal to MD system -->
    <signal_objects object="player.galaxy" param="'GT_AI_Started'" param2="table[
      $Ship = this.ship,
      $Config = table[
        $allowillegal = $gt_allowillegal,
        $debuglevel = $gt_debuglevel,
        $autotraining = $gt_autotraining
      ]
    ]"/>
    
    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
      <debug_text text="'[GT-AI] ' + this.ship.idcode + ': High-performance initialization complete'" chance="$debugchance"/>
      <do_if value="@$effectiveHome.exists">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Operating with home base: ' + @$effectiveHome.knownname + ' (maxbuy=' + $effectiveMaxBuy + ', maxsell=' + $effectiveMaxSell + ')'" chance="$debugchance"/>
      </do_if>
    </do_if>
    
    <!-- Log configuration summary -->
    <do_if value="$gt_debuglevel ge 1 and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
      <debug_text text="'[GT-AI] ' + this.ship.idcode + ': === CONFIGURATION SUMMARY ==='" chance="100"/>
      <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Illegal=' + $effectiveAllowIllegal + ', DistancePenalty=' + $effectiveDistancePenalty + '%'" chance="100"/>
      <debug_text text="'[GT-AI] ' + this.ship.idcode + ': FleetCoord=' + $effectiveFleetCoordination + ', LogbookEntries=' + $effectiveLogbookEntries + ', Notifications=' + $effectiveNotifications" chance="100"/>
      <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Distance limits: MaxBuy=' + $effectiveMaxBuy + ' jumps, MaxSell=' + $effectiveMaxSell + ' jumps'" chance="100"/>
      <debug_text text="'[GT-AI] ' + this.ship.idcode + ': AutoWares=' + $effectiveAutoWares + ', WareBasket=' + $effectiveWareBasket.count + ' wares, TradeEval=' + $effectiveTradeEval" chance="100"/>
    </do_if>
    
    <!-- ============================================================================= -->
    <!-- END MODULAR INITIALIZATION                                                   -->
    <!-- ============================================================================= -->
    
    <!-- Initialize pilot tracking for event-driven pilot change detection -->
    <!-- Pilot changes are detected at natural restart points: -->
    <!-- - After successful trade completion (trade_completed label) -->
    <!-- - On script restart (init label) -->
    <set_value name="this.$trackedPilot" exact="this.ship.pilot"/>
    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
      <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Tracking pilot: ' + @this.$trackedPilot.name + ' (event-driven detection enabled)'" chance="$debugchance"/>
    </do_if>
    
    <!-- Do not initialize commander tracking here - let init label handle it -->
    <!-- This prevents false positives when script restarts after commander assignment -->
    <!-- The init label will detect changes by comparing with previous value -->
    
    <!-- Register pilot on first run (for initial assignment or ship with existing cargo) -->
    <!-- This ensures ships get renamed even when first assigned to GT order -->
    <do_if value="this.ship.pilot">
      <!-- NOTE: Cannot use wait/do_while in init block - pilot transfer check moved to main loop -->
      <!-- Pilot transfer takes time (crew transfer pod travel), but UI shows pilot as assigned immediately -->
      <!-- Main loop will check if pilot is actually on ship before proceeding -->
      
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': INITIAL REGISTRATION: Registering pilot ' + @this.ship.pilot.name + ' on order start'" chance="100"/>
      </do_if>
      <signal_objects object="player.galaxy" param="'GT_Update_Ship'" param2="table[
        $updateType = 'pilot_change',
        $ship = this.ship,
        $pilot = this.ship.pilot,
        $oldPilot = null
      ]"/>
      
      <!-- NOTE: Cannot use wait in init block - registration check will happen in main loop -->
      <!-- Registration happens synchronously via run_actions, but signal processing is asynchronous -->
      <!-- Main loop will check registration status before requesting trade search -->
    </do_if>
    
    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
      <debug_text text="'[GalaxyTrader MK3] ' + this.ship.idcode + ': === INITIALIZATION COMPLETE === Starting main trading loop...'" chance="100"/>
    </do_if>
    
  </init>
  
  <attention min="unknown">
    <actions>
      
      <!-- Debug: Confirm we entered attention block -->
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': === ATTENTION BLOCK ENTERED ==='" chance="100"/>
      </do_if>
      
      <!-- Subordinate reinitialization: Jump here to restart and re-inherit commander settings -->
      <label name="init"/>
      
      <!-- ======================================= -->
      <!-- PILOT CHANGE DETECTION (Script Restart) -->
      <!-- ======================================= -->
      <!-- Check for pilot changes when script restarts (natural restart point) -->
      <set_value name="$currentPilot" exact="@this.ship.pilot"/>
      <do_if value="this.$trackedPilot? and $currentPilot != this.$trackedPilot">
        <!-- Pilot changed! Send signal to MD system -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': PILOT CHANGE DETECTED on script restart! Old: ' + @this.$trackedPilot.name + ', New: ' + @$currentPilot.name" chance="100"/>
        </do_if>
        
        <signal_objects object="player.galaxy" param="'GT_Update_Ship'" param2="table[
          $updateType = 'pilot_change',
          $ship = this.ship,
          $pilot = $currentPilot,
          $oldPilot = this.$trackedPilot
        ]"/>
      </do_if>
      <!-- Update tracked pilot (always, even if no change) -->
      <set_value name="this.$trackedPilot" exact="$currentPilot"/>
      
      <!-- CRITICAL: Check if pilot is missing (pilot was transferred away) -->
      <!-- If GT order is running but ship has no pilot, cleanup and self-cancel -->
      <do_if value="not $currentPilot">
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': MISSING PILOT DETECTED - pilot was transferred away, cleaning up and self-canceling GT order'" chance="100"/>
        </do_if>
        
        <!-- Get original ship name from ship registry -->
        <set_value name="$originalName" exact="null"/>
        <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.ship}? and global.$GT_Ships.{this.ship}.$OriginalShipName?">
          <set_value name="$originalName" exact="global.$GT_Ships.{this.ship}.$OriginalShipName"/>
        </do_if>
        
        <!-- Send cleanup signal (name restoration handled by MD system) -->
        <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
          $Ship = this.ship,
          $Pilot = null,
          $Reason = 'Pilot transferred away - GT order cannot run without pilot',
          $OriginalName = $originalName
        ]"/>
        
        <!-- Cancel all active orders (trade orders, etc.) -->
        <cancel_all_orders object="this.ship"/>
        
        <!-- Self-cancel GT order -->
        <cancel_order order="this.ship.defaultorder"/>
        <return/>
      </do_if>
      
      <!-- Restore XPBlocked if BlockedLevel still exists (ship restart/reinit) -->
      <!-- Also update ship name to show ADVANCE label when XPBlocked is restored -->
      <do_if value="this.ship.pilot and global.$GT_Pilots.{this.ship.pilot}?">
        <do_if value="global.$GT_Pilots.{this.ship.pilot}.$BlockedLevel? and not global.$GT_Pilots.{this.ship.pilot}.$XPBlocked?">
          <set_value name="global.$GT_Pilots.{this.ship.pilot}.$XPBlocked" exact="true"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] Restored XPBlocked for pilot ' + this.ship.pilot.name + ' on ship restart (BlockedLevel: ' + global.$GT_Pilots.{this.ship.pilot}.$BlockedLevel + ')'" chance="100"/>
          </do_if>
          
          <!-- Update ship name to show ADVANCE label when XPBlocked is restored -->
          <!-- This ensures the ship name reflects the blocked state after restart -->
          <!-- Calculate rank title based on blocked level -->
          <set_value name="$blockedLevel" exact="global.$GT_Pilots.{this.ship.pilot}.$BlockedLevel"/>
          <set_value name="$rankTitle" exact="'Lehrling'"/>
          <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
            <set_value name="$rankIndex" exact="($blockedLevel / 3)i + 1"/>
            <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
              <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
            </do_if>
            <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
              <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
            </do_if>
          </do_if>
          <signal_objects object="player.galaxy" param="'GT_Update_Ship_Name'" param2="table[
            $ship = this.ship,
            $pilot = this.ship.pilot,
            $xp = @global.$GT_Pilots.{this.ship.pilot}.$XP,
            $level = $blockedLevel,
            $rank = $rankTitle,
            $nameType = 'blocked'
          ]"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] Updated ship name to show ADVANCE label after XPBlocked restoration: ' + this.ship.knownname" chance="100"/>
          </do_if>
        </do_if>
      </do_if>
      
      <!-- Initialize default order tracking -->
      <!-- Track the current default order to detect when GT order is removed -->
      <set_value name="$currentDefaultOrder" exact="@this.ship.defaultorder.id"/>
      <do_if value="not this.$trackedDefaultOrder?">
        <!-- First time - initialize tracked order -->
        <set_value name="this.$trackedDefaultOrder" exact="$currentDefaultOrder"/>
        
        <!-- Send GT_Order_Assigned signal when GT order is first assigned -->
        <do_if value="$currentDefaultOrder == 'GalaxyTraderMK3'">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] GT order assigned to ' + this.ship.idcode + ' - sending GT_Order_Assigned signal'" chance="100"/>
          </do_if>
          <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
            $Ship = this.ship,
            $UpdateType = 'GT_Order_Assigned',
            $MacroShipName = @this.ship.macro.name
          ]"/>
        </do_if>
      </do_if>
      <do_if value="this.$trackedDefaultOrder == 'GalaxyTraderMK3' and $currentDefaultOrder != 'GalaxyTraderMK3'">
        <!-- CRITICAL FIX: Check if ship is still GT-controlled via commander BEFORE sending cancellation -->
        <!-- When a subordinate is assigned to a commander, default order changes from GalaxyTraderMK3 to Assist -->
        <!-- But ship is still GT-controlled via commander - don't send cancellation signal -->
        <set_value name="$isStillGTControlled" exact="false"/>
        
        <!-- Check 1: Direct GT order -->
        <do_if value="$currentDefaultOrder == 'GalaxyTraderMK3'">
          <set_value name="$isStillGTControlled" exact="true"/>
        </do_if>
        
        <!-- Check 2: Subordinate to GT commander with Assist order -->
        <do_if value="not $isStillGTControlled and this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
          <do_if value="this.ship.commander.defaultorder? and @this.ship.commander.defaultorder.id == 'GalaxyTraderMK3'">
            <do_if value="$currentDefaultOrder == 'Assist'">
              <set_value name="$isStillGTControlled" exact="true"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Only send cancellation signal if ship is NO LONGER GT-controlled -->
        <do_if value="not $isStillGTControlled">
          <!-- GT order was removed â†’ send Phase 7 signal -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] PHASE 7: GT order cancelled for ' + this.ship.idcode + ' (detected in init label, old: ' + this.$trackedDefaultOrder + ', new: ' + (if $currentDefaultOrder then $currentDefaultOrder else 'NONE') + ', still GT-controlled: ' + $isStillGTControlled + ')'" chance="100"/>
          </do_if>
          <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
            $Ship = this.ship,
            $UpdateType = 'GT_Order_Cancelled'
          ]"/>
          
          <!-- EVENT-DRIVEN: Trigger orphaned ship check -->
          <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.ship}?">
            <signal_objects object="player.galaxy" param="'GT_Check_Ship_Orphaned'" param2="table[$Ship = this.ship]"/>
          </do_if>
        </do_if>
        <do_else>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] PHASE 7: Default order changed from GalaxyTraderMK3 to ' + (if $currentDefaultOrder then $currentDefaultOrder else 'NONE') + ' BUT ship still GT-controlled via commander - NOT sending cancellation'" chance="100"/>
          </do_if>
        </do_else>
        
        <!-- Restore ship name if not GT-controlled (direct or subordinate) -->
        <set_value name="$isSubordinateOfGTCommander" exact="false"/>
        <do_if value="this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
          <do_if value="this.ship.commander.defaultorder? and @this.ship.commander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$isSubordinateOfGTCommander" exact="true"/>
          </do_if>
        </do_if>
        
        <do_if value="not $isSubordinateOfGTCommander and this.ship.pilot?">
          <set_value name="$originalName" exact="null"/>
          <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName?">
            <set_value name="$originalName" exact="global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName"/>
          </do_if>
          
          <do_if value="$originalName">
            <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
              $Ship = this.ship,
              $Pilot = this.ship.pilot,
              $Reason = 'GT order cancelled - restoring original name',
              $OriginalName = $originalName
            ]"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] PHASE 7: Name restoration signal sent for ' + this.ship.idcode + ' (original name: ' + $originalName + ')'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Update tracked order -->
        <set_value name="this.$trackedDefaultOrder" exact="$currentDefaultOrder"/>
      </do_if>
      <do_elseif value="this.$trackedDefaultOrder != $currentDefaultOrder">
        <!-- Default order changed (but not GT removal) - just update tracked order -->
        <set_value name="this.$trackedDefaultOrder" exact="$currentDefaultOrder"/>
      </do_elseif>
      
      <!-- Initialize commander tracking and detect commander assignment -->
      <!-- This runs when script restarts (e.g., after commander assignment) -->
      <!-- Check for changes BEFORE initializing trackedCommander -->
      <set_value name="$currentCommander" exact="null"/>
      <do_if value="this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
        <set_value name="$currentCommander" exact="this.ship.commander"/>
      </do_if>
      
      <!-- Store previous tracked commander BEFORE checking/updating -->
      <set_value name="$previousTrackedCommander" exact="null"/>
      <do_if value="this.$trackedCommander?">
        <set_value name="$previousTrackedCommander" exact="this.$trackedCommander"/>
      </do_if>
      
      <!-- Log current state -->
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] PHASE 6 DEBUG: ' + this.ship.idcode + ' - currentCommander: ' + (if @$currentCommander.exists then @$currentCommander.idcode else 'NONE') + ', previousTrackedCommander: ' + (if @$previousTrackedCommander.exists then @$previousTrackedCommander.idcode else 'NONE')" chance="100"/>
      </do_if>
      
      <!-- Check if commander changed (compare with previous tracked value BEFORE updating) -->
      <do_if value="not this.$trackedCommander?">
        <!-- First time - initialize tracked commander and send signal if commander exists -->
        <set_value name="this.$trackedCommander" exact="$currentCommander"/>
        <do_if value="@$currentCommander.exists">
          <!-- Commander exists on first check - send initialization signal -->
          <set_value name="$newCommanderHasGT" exact="false"/>
          <do_if value="$currentCommander.defaultorder? and @$currentCommander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$newCommanderHasGT" exact="true"/>
          </do_if>
          
          <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
            $Ship = this.ship,
            $UpdateType = 'Commander_Changed',
            $Commander = $currentCommander,
            $CommanderHasGT = $newCommanderHasGT
          ]"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] PHASE 6: Commander initialized for ' + this.ship.idcode + ' (commander: ' + $currentCommander.idcode + ', has GT: ' + $newCommanderHasGT + ')'" chance="100"/>
          </do_if>
        </do_if>
      </do_if>
      <do_elseif value="((@$previousTrackedCommander.exists == true) and not (@$currentCommander.exists == true)) or (not (@$previousTrackedCommander.exists == true) and (@$currentCommander.exists == true))">
        <!-- Commander state changed (was null, now exists OR was exists, now null) -->
        <set_value name="$oldCommander" exact="$previousTrackedCommander"/>
        <set_value name="$newCommander" exact="$currentCommander"/>
        
        <!-- Check if old commander had GT order (for name restoration when subordinate removed) -->
        <set_value name="$oldCommanderHasGT" exact="false"/>
        <do_if value="@$oldCommander.exists">
          <do_if value="$oldCommander.defaultorder? and @$oldCommander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$oldCommanderHasGT" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Check if new commander has GT order -->
        <set_value name="$newCommanderHasGT" exact="false"/>
        <do_if value="@$newCommander.exists">
          <do_if value="$newCommander.defaultorder? and @$newCommander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$newCommanderHasGT" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Send state update signal -->
        <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
          $Ship = this.ship,
          $UpdateType = 'Commander_Changed',
          $Commander = $newCommander,
          $CommanderHasGT = $newCommanderHasGT
        ]"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] PHASE 6: Commander change detected for ' + this.ship.idcode + ' (old: ' + (if @$oldCommander.exists then @$oldCommander.idcode else 'NONE') + ', new: ' + (if @$newCommander.exists then @$newCommander.idcode else 'NONE') + ', has GT: ' + $newCommanderHasGT + ')'" chance="100"/>
        </do_if>
        
        <!-- If ship was subordinate to GT commander and is no longer subordinate, restore name -->
        <!-- This handles the case where a subordinate is removed from a GT commander -->
        <do_if value="$oldCommanderHasGT and not $newCommanderHasGT and this.ship.pilot?">
          <!-- Ship was subordinate to GT commander, now is not (either no commander or different commander without GT) -->
          <!-- Check if ship has direct GT order -->
          <set_value name="$hasDirectGTOrder" exact="false"/>
          <do_if value="this.ship.defaultorder? and @this.ship.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$hasDirectGTOrder" exact="true"/>
          </do_if>
          
          <!-- Restore name if ship doesn't have direct GT order -->
          <!-- If ship has direct GT order, it will keep GT name (independent GT ship) -->
          <do_if value="not $hasDirectGTOrder">
            <set_value name="$originalName" exact="null"/>
            <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName?">
              <set_value name="$originalName" exact="global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName"/>
            </do_if>
            
            <do_if value="$originalName">
              <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
                $Ship = this.ship,
                $Pilot = this.ship.pilot,
                $Reason = 'Subordinate removed from GT commander - restoring original name',
                $OriginalName = $originalName
              ]"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] PHASE 6: Name restoration signal sent for ' + this.ship.idcode + ' (removed from GT commander, no direct GT order, original name: ' + $originalName + ')'" chance="100"/>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Update tracked commander -->
        <set_value name="this.$trackedCommander" exact="$currentCommander"/>
      </do_elseif>
      <do_elseif value="(@$previousTrackedCommander.exists == true) and (@$currentCommander.exists == true) and $previousTrackedCommander != $currentCommander">
        <!-- Commander changed to different commander -->
        <set_value name="$oldCommander" exact="$previousTrackedCommander"/>
        <set_value name="$newCommander" exact="$currentCommander"/>
        
        <!-- Check if new commander has GT order -->
        <set_value name="$newCommanderHasGT" exact="false"/>
        <do_if value="$newCommander.defaultorder? and @$newCommander.defaultorder.id == 'GalaxyTraderMK3'">
          <set_value name="$newCommanderHasGT" exact="true"/>
        </do_if>
        
        <!-- Send state update signal -->
        <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
          $Ship = this.ship,
          $UpdateType = 'Commander_Changed',
          $Commander = $newCommander,
          $CommanderHasGT = $newCommanderHasGT
        ]"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] PHASE 6: Commander change detected for ' + this.ship.idcode + ' (old: ' + $oldCommander.idcode + ', new: ' + $newCommander.idcode + ', has GT: ' + $newCommanderHasGT + ')'" chance="100"/>
        </do_if>
        
        <!-- Update tracked commander -->
        <set_value name="this.$trackedCommander" exact="$currentCommander"/>
      </do_elseif>
      <do_else>
        <!-- Commander is the same - no change, but ensure tracked value is updated -->
        <set_value name="this.$trackedCommander" exact="$currentCommander"/>
      </do_else>
      
      <!-- Re-inherit settings from commander if this is a subordinate -->
      <do_if value="this.ship.commander and this.ship.commander.exists and this.ship.commander != this.ship">
        <set_value name="$commanderOrder" exact="this.ship.commander.defaultorder"/>
        <do_if value="$commanderOrder?">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Re-inheriting settings from commander ' + this.ship.commander.idcode" chance="100"/>
          </do_if>
          <!-- Re-inherit all commander settings -->
          <do_if value="$commanderOrder.$fleetcoordination?"><set_value name="$effectiveFleetCoordination" exact="$commanderOrder.$fleetcoordination"/></do_if>
          <do_if value="$commanderOrder.$allowillegal?"><set_value name="$effectiveAllowIllegal" exact="$commanderOrder.$allowillegal"/></do_if>
          <do_if value="$commanderOrder.$ignorecarrieraux?"><set_value name="$effectiveIgnoreCarrierAux" exact="$commanderOrder.$ignorecarrieraux"/></do_if>
          <do_if value="$commanderOrder.$ignorebuildstorage?"><set_value name="$effectiveIgnoreBuildStorage" exact="$commanderOrder.$ignorebuildstorage"/></do_if>
          <do_if value="$commanderOrder.$home?"><set_value name="$effectiveHome" exact="$commanderOrder.$home"/></do_if>
          <do_if value="$commanderOrder.$sectorwhitelist?"><set_value name="$effectiveSectorWhitelist" exact="$commanderOrder.$sectorwhitelist"/></do_if>
          <!-- Re-inherit max jump distances with pilot capability cap -->
          <do_if value="$commanderOrder.$maxbuy?">
            <!-- Calculate pilot capability -->
            <set_value name="$pilotSkill" exact="1"/>
            <do_if value="this.ship.pilot and this.ship.pilot.skill.management?">
              <set_value name="$pilotSkill" exact="this.ship.pilot.skill.management"/>
            </do_if>
            <set_value name="$pilotMaxJumps" exact="1"/>
            <do_if value="$pilotSkill le 2"><set_value name="$pilotMaxJumps" exact="1"/></do_if>
            <do_elseif value="$pilotSkill le 5"><set_value name="$pilotMaxJumps" exact="3"/></do_elseif>
            <do_elseif value="$pilotSkill le 8"><set_value name="$pilotMaxJumps" exact="5"/></do_elseif>
            <do_elseif value="$pilotSkill le 11"><set_value name="$pilotMaxJumps" exact="10"/></do_elseif>
            <do_elseif value="$pilotSkill le 13"><set_value name="$pilotMaxJumps" exact="15"/></do_elseif>
            <do_else><set_value name="$pilotMaxJumps" exact="25"/></do_else>
            <set_value name="$effectiveMaxBuy" exact="[$commanderOrder.$maxbuy, $pilotMaxJumps].min"/>
          </do_if>
          <do_if value="$commanderOrder.$maxsell?">
            <!-- Calculate pilot capability -->
            <set_value name="$pilotSkill" exact="1"/>
            <do_if value="this.ship.pilot and this.ship.pilot.skill.management?">
              <set_value name="$pilotSkill" exact="this.ship.pilot.skill.management"/>
            </do_if>
            <set_value name="$pilotMaxJumps" exact="1"/>
            <do_if value="$pilotSkill le 2"><set_value name="$pilotMaxJumps" exact="1"/></do_if>
            <do_elseif value="$pilotSkill le 5"><set_value name="$pilotMaxJumps" exact="3"/></do_elseif>
            <do_elseif value="$pilotSkill le 8"><set_value name="$pilotMaxJumps" exact="5"/></do_elseif>
            <do_elseif value="$pilotSkill le 11"><set_value name="$pilotMaxJumps" exact="10"/></do_elseif>
            <do_elseif value="$pilotSkill le 13"><set_value name="$pilotMaxJumps" exact="15"/></do_elseif>
            <do_else><set_value name="$pilotMaxJumps" exact="25"/></do_else>
            <set_value name="$effectiveMaxSell" exact="[$commanderOrder.$maxsell, $pilotMaxJumps].min"/>
          </do_if>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Settings re-inherited successfully'" chance="100"/>
          </do_if>
        </do_if>
      </do_if>
      
      <!-- Always initialize effectiveMaxBuy/effectiveMaxSell from order parameters -->
      <!-- This ensures variables exist even if ship is not a subordinate or commander lacks these properties -->
      <do_if value="not $effectiveMaxBuy?">
        <set_value name="$effectiveMaxBuy" exact="$maxbuy"/>
      </do_if>
      <do_if value="not $effectiveMaxSell?">
        <set_value name="$effectiveMaxSell" exact="$maxsell"/>
      </do_if>
      
      <!-- Initialize subordinate count tracking -->
      <!-- Track when this ship becomes a commander (gets subordinates) -->
      <set_value name="$currentSubordinateCount" exact="0"/>
      <do_if value="this.ship.subordinates?">
        <set_value name="$currentSubordinateCount" exact="this.ship.subordinates.count"/>
      </do_if>
      <do_if value="not this.$trackedSubordinateCount?">
        <!-- First time - initialize tracked count -->
        <set_value name="this.$trackedSubordinateCount" exact="$currentSubordinateCount"/>
      </do_if>
      
      <!-- Reset was_subordinate flag based on CURRENT state, not previous state -->
      <!-- This prevents false positives when a ship transitions from subordinate â†’ independent -->
      <!-- If ship has a direct GT order, it's independent, not orphaned -->
      <set_value name="$hasDirectGTOrder" exact="false"/>
      <do_if value="this.ship.defaultorder? and @this.ship.defaultorder.id == 'GalaxyTraderMK3'">
        <set_value name="$hasDirectGTOrder" exact="true"/>
      </do_if>
      
      <!-- Reset was_subordinate based on current commander status -->
      <set_value name="$isCurrentlySubordinate" exact="this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship"/>
      <set_value name="this.$was_subordinate" exact="$isCurrentlySubordinate"/>
      
      <!-- If ship has direct GT order but was previously subordinate, clear the flag -->
      <!-- This allows ships to transition from subordinate â†’ independent without being treated as orphaned -->
      <do_if value="$hasDirectGTOrder and not $isCurrentlySubordinate">
        <set_value name="this.$was_subordinate" exact="false"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Reset was_subordinate flag (has direct GT order, not subordinate)'" chance="100"/>
        </do_if>
      </do_if>
      
      <!-- =============================================== -->
      <!-- MAIN TRADING LOOP (Modularized)                -->
      <!-- =============================================== -->
      
      <label name="main_loop"/>
      
      <!-- Debug: Confirm we reached main loop -->
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': === MAIN LOOP STARTED === (Pilot: ' + (if this.ship.pilot then this.ship.pilot.name else 'NONE') + ')'" chance="100"/>
      </do_if>
      
      <!-- Check if GT order was removed (main loop detection) -->
      <!-- This catches cases where GT order is manually removed but script continues running -->
      <set_value name="$currentDefaultOrder" exact="@this.ship.defaultorder.id"/>
      <do_if value="not this.$trackedDefaultOrder?">
        <!-- First time - initialize tracked order -->
        <set_value name="this.$trackedDefaultOrder" exact="$currentDefaultOrder"/>
      </do_if>
      <do_if value="this.$trackedDefaultOrder == 'GalaxyTraderMK3' and $currentDefaultOrder != 'GalaxyTraderMK3'">
        <!-- GT order was removed â†’ send Phase 7 signal -->
        <debug_text text="'[GT-AI] PHASE 7: GT order cancelled for ' + this.ship.idcode + ' (detected in main loop, old: ' + this.$trackedDefaultOrder + ', new: ' + (if $currentDefaultOrder then $currentDefaultOrder else 'NONE') + ')'" chance="100"/>
        <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
          $Ship = this.ship,
          $UpdateType = 'GT_Order_Cancelled'
        ]"/>
        
        <!-- Restore ship name if not GT-controlled (direct or subordinate) -->
        <set_value name="$isSubordinateOfGTCommander" exact="false"/>
        <do_if value="this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
          <do_if value="this.ship.commander.defaultorder? and @this.ship.commander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$isSubordinateOfGTCommander" exact="true"/>
          </do_if>
        </do_if>
        
        <do_if value="not $isSubordinateOfGTCommander and this.ship.pilot?">
          <set_value name="$originalName" exact="null"/>
          <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName?">
            <set_value name="$originalName" exact="global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName"/>
          </do_if>
          
          <do_if value="$originalName">
            <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
              $Ship = this.ship,
              $Pilot = this.ship.pilot,
              $Reason = 'GT order cancelled - restoring original name',
              $OriginalName = $originalName
            ]"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] PHASE 7: Name restoration signal sent for ' + this.ship.idcode + ' (original name: ' + $originalName + ')'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Update tracked order -->
        <set_value name="this.$trackedDefaultOrder" exact="$currentDefaultOrder"/>
      </do_if>
      <do_elseif value="this.$trackedDefaultOrder != $currentDefaultOrder">
        <!-- Default order changed (but not GT removal) - just update tracked order -->
        <set_value name="this.$trackedDefaultOrder" exact="$currentDefaultOrder"/>
      </do_elseif>
      
      <!-- ======================================= -->
      <!-- MANDATORY TRAINING CHECK (BLOCKS ALL TRADING) -->
      <!-- ======================================= -->
      
      <!-- Check if training was completed by interrupt handler -->
      <do_if value="this.$training_complete?">
        <remove_value name="this.$training_complete"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Training completed - continuing with trading'" chance="100"/>
        </do_if>
      </do_if>
      
      <!-- Clear stale training flags when not in training -->
      <!-- These flags can persist when AI context is reused after rapid abort/restart -->
      <do_if value="this.$training_transition? or this.$training_order_created?">
        <do_if value="not this.ship.pilot or not global.$GT_Pilots.{this.ship.pilot}.$XPBlocked?">
          <!-- Pilot is not XP blocked, so training flags are stale - clear them -->
          <remove_value name="this.$training_transition"/>
          <remove_value name="this.$training_order_created"/>
          <remove_value name="this.$training_in_progress"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Cleared stale training flags (pilot not XP blocked)'" chance="100"/>
          </do_if>
        </do_if>
      </do_if>
      
      <!-- ======================================= -->
      <!-- PILOT CHANGE DETECTION (Event-Driven)  -->
      <!-- ======================================= -->
      <!-- NOTE: Pilot change detection moved to restart points (trade_completed, init) -->
      <!-- Polling removed - detection happens at natural restart points where GT order reruns -->
      <!-- This ensures detection happens when order naturally restarts, not constantly polling -->
      
      <!-- ======================================= -->
      <!-- Commander change detection (Main Loop) -->
      <!-- ======================================= -->
      <!-- Track the current commander and detect if it changes (assignment, removal, or change) -->
      <!-- This is more reliable than event_object_commander_set which may not fire during script restart -->
      <set_value name="$currentCommander" exact="null"/>
      <do_if value="this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
        <set_value name="$currentCommander" exact="this.ship.commander"/>
      </do_if>
      
      <!-- Check if commander changed (null to exists, exists to null, or different commander) -->
      <do_if value="not this.$trackedCommander?">
        <!-- First time check - initialize tracked commander -->
        <set_value name="this.$trackedCommander" exact="$currentCommander"/>
      </do_if>
      <do_elseif value="((@this.$trackedCommander.exists == true) and not (@$currentCommander.exists == true)) or (not (@this.$trackedCommander.exists == true) and (@$currentCommander.exists == true))">
        <!-- Commander state changed (was null, now exists OR was exists, now null) -->
        <set_value name="$oldCommander" exact="if this.$trackedCommander? then this.$trackedCommander else null"/>
        <set_value name="$newCommander" exact="$currentCommander"/>
        
        <!-- Check if old commander had GT order (for name restoration when subordinate removed) -->
        <set_value name="$oldCommanderHasGT" exact="false"/>
        <do_if value="@$oldCommander.exists">
          <do_if value="$oldCommander.defaultorder? and @$oldCommander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$oldCommanderHasGT" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Check if new commander has GT order -->
        <set_value name="$newCommanderHasGT" exact="false"/>
        <do_if value="@$newCommander.exists">
          <do_if value="$newCommander.defaultorder? and @$newCommander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$newCommanderHasGT" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Send state update signal -->
        <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
          $Ship = this.ship,
          $UpdateType = 'Commander_Changed',
          $Commander = $newCommander,
          $CommanderHasGT = $newCommanderHasGT
        ]"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] PHASE 6: Commander change detected for ' + this.ship.idcode + ' (old: ' + (if @$oldCommander.exists then @$oldCommander.idcode else 'NONE') + ', new: ' + (if @$newCommander.exists then @$newCommander.idcode else 'NONE') + ', has GT: ' + $newCommanderHasGT + ')'" chance="100"/>
        </do_if>
        
        <!-- If ship was subordinate to GT commander and is no longer subordinate, restore name -->
        <!-- This handles the case where a subordinate is removed from a GT commander -->
        <do_if value="$oldCommanderHasGT and not $newCommanderHasGT and this.ship.pilot?">
          <!-- Ship was subordinate to GT commander, now is not (either no commander or different commander without GT) -->
          <!-- Check if ship has direct GT order -->
          <set_value name="$hasDirectGTOrder" exact="false"/>
          <do_if value="this.ship.defaultorder? and @this.ship.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$hasDirectGTOrder" exact="true"/>
          </do_if>
          
          <!-- Restore name if ship doesn't have direct GT order -->
          <!-- If ship has direct GT order, it will keep GT name (independent GT ship) -->
          <do_if value="not $hasDirectGTOrder">
            <set_value name="$originalName" exact="null"/>
            <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName?">
              <set_value name="$originalName" exact="global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName"/>
            </do_if>
            
            <do_if value="$originalName">
              <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
                $Ship = this.ship,
                $Pilot = this.ship.pilot,
                $Reason = 'Subordinate removed from GT commander - restoring original name',
                $OriginalName = $originalName
              ]"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] PHASE 6: Name restoration signal sent for ' + this.ship.idcode + ' (removed from GT commander, no direct GT order, original name: ' + $originalName + ')'" chance="100"/>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
        
        <!-- Update tracked commander -->
        <set_value name="this.$trackedCommander" exact="$currentCommander"/>
      </do_elseif>
      <do_elseif value="(@this.$trackedCommander.exists == true) and (@$currentCommander.exists == true) and this.$trackedCommander != $currentCommander">
        <!-- Commander changed to different commander -->
        <set_value name="$oldCommander" exact="this.$trackedCommander"/>
        <set_value name="$newCommander" exact="$currentCommander"/>
        
        <!-- Check if new commander has GT order -->
        <set_value name="$newCommanderHasGT" exact="false"/>
        <do_if value="$newCommander.defaultorder? and @$newCommander.defaultorder.id == 'GalaxyTraderMK3'">
          <set_value name="$newCommanderHasGT" exact="true"/>
        </do_if>
        
        <!-- Send state update signal -->
        <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
          $Ship = this.ship,
          $UpdateType = 'Commander_Changed',
          $Commander = $newCommander,
          $CommanderHasGT = $newCommanderHasGT
        ]"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] PHASE 6: Commander change detected for ' + this.ship.idcode + ' (old: ' + $oldCommander.idcode + ', new: ' + $newCommander.idcode + ', has GT: ' + $newCommanderHasGT + ')'" chance="100"/>
        </do_if>
        
        <!-- If ship is no longer subordinate to GT commander, restore name -->
        <do_if value="not $newCommanderHasGT and this.ship.pilot?">
          <!-- Ship is no longer subordinate to GT commander -->
          <!-- Check if ship has direct GT order -->
          <set_value name="$hasDirectGTOrder" exact="false"/>
          <do_if value="this.ship.defaultorder? and @this.ship.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$hasDirectGTOrder" exact="true"/>
          </do_if>
          
          <!-- Restore name if ship doesn't have direct GT order -->
          <do_if value="not $hasDirectGTOrder">
            <set_value name="$originalName" exact="null"/>
            <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName?">
              <set_value name="$originalName" exact="global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName"/>
            </do_if>
            
            <do_if value="$originalName">
              <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
                $Ship = this.ship,
                $Pilot = this.ship.pilot,
                $Reason = 'Commander changed - no longer subordinate to GT commander',
                $OriginalName = $originalName
              ]"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] PHASE 6: Name restoration signal sent for ' + this.ship.idcode + ' (no longer subordinate to GT commander, original name: ' + $originalName + ')'" chance="100"/>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
        
      <!-- Update tracked commander -->
      <set_value name="this.$trackedCommander" exact="$currentCommander"/>
      </do_elseif>
      
      <!-- ======================================= -->
      <!-- Subordinate count detection (Main Loop) -->
      <!-- ======================================= -->
      <!-- Track when this ship becomes a commander (gets subordinates) or stops being one (loses all subordinates) -->
      <!-- This is important for ships that transition from subordinate â†’ commander -->
      <set_value name="$currentSubordinateCount" exact="0"/>
      <do_if value="this.ship.subordinates?">
        <set_value name="$currentSubordinateCount" exact="this.ship.subordinates.count"/>
      </do_if>
      
      <!-- Check if subordinate count changed -->
      <do_if value="not this.$trackedSubordinateCount?">
        <!-- First time check - initialize tracked count -->
        <set_value name="this.$trackedSubordinateCount" exact="$currentSubordinateCount"/>
      </do_if>
      <do_elseif value="this.$trackedSubordinateCount != $currentSubordinateCount">
        <!-- Subordinate count changed -->
        <set_value name="$oldSubordinateCount" exact="this.$trackedSubordinateCount"/>
        <set_value name="$newSubordinateCount" exact="$currentSubordinateCount"/>
        
        <!-- Determine if ship became a commander or stopped being one -->
        <set_value name="$wasCommander" exact="($oldSubordinateCount gt 0)"/>
        <set_value name="$isCommander" exact="($newSubordinateCount gt 0)"/>
        
        <!-- Send state update signal -->
        <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
          $Ship = this.ship,
          $UpdateType = 'Subordinate_Count_Changed',
          $OldSubordinateCount = $oldSubordinateCount,
          $NewSubordinateCount = $newSubordinateCount,
          $WasCommander = $wasCommander,
          $IsCommander = $isCommander
        ]"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] PHASE 6: Subordinate count changed for ' + this.ship.idcode + ' (old: ' + $oldSubordinateCount + ', new: ' + $newSubordinateCount + ', was commander: ' + $wasCommander + ', is commander: ' + $isCommander + ')'" chance="100"/>
        </do_if>
        
        <!-- Update tracked count -->
        <set_value name="this.$trackedSubordinateCount" exact="$currentSubordinateCount"/>
      </do_elseif>
      
      <!-- ======================================= -->
      <!-- SUBORDINATE COMMANDER CHECK            -->
      <!-- ======================================= -->
      <!-- Check if ship was a subordinate but lost its commander completely -->
      <!-- Track if ship was a subordinate when order started -->
      <do_if value="not this.$was_subordinate?">
        <!-- First time check - store if ship is currently a subordinate -->
        <set_value name="this.$was_subordinate" exact="this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship"/>
      </do_if>
      
      <!-- Check if subordinate lost its commander or commander lost GT order -->
      <!-- Unified GT order status check (inline for AI scripts) -->
      <set_value name="$hasDirectGTOrder" exact="false"/>
      <set_value name="$hasGTCommander" exact="false"/>
      <set_value name="$commanderExists" exact="false"/>
      <set_value name="$isSubordinate" exact="false"/>
      
      <!-- Check direct GT order -->
      <set_value name="$currentDefaultOrder" exact="@this.ship.defaultorder.id"/>
      <do_if value="$currentDefaultOrder == 'GalaxyTraderMK3'">
        <set_value name="$hasDirectGTOrder" exact="true"/>
      </do_if>
      
      <!-- Check commander status -->
      <do_if value="not $hasDirectGTOrder and this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
        <set_value name="$commanderExists" exact="true"/>
        <do_if value="this.ship.commander.defaultorder? and @this.ship.commander.defaultorder.id == 'GalaxyTraderMK3'">
          <set_value name="$hasGTCommander" exact="true"/>
          <do_if value="$currentDefaultOrder == 'Assist'">
            <set_value name="$isSubordinate" exact="true"/>
          </do_if>
        </do_if>
      </do_if>
      
      <!-- Check if ship was subordinate and lost commander completely -->
      <do_if value="this.$was_subordinate and not $hasDirectGTOrder">
        <do_if value="not $commanderExists">
          <!-- Subordinate lost its commander completely - restore name and self-abort -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': SUBORDINATE ORPHANED: Commander assignment completely removed - restoring ship name and self-aborting'" chance="100"/>
          </do_if>
          
          <!-- Send signal to restore ship name and cleanup -->
          <do_if value="this.ship.pilot?">
            <set_value name="$originalName" exact="null"/>
            <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName?">
              <set_value name="$originalName" exact="global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName"/>
            </do_if>
            
            <do_if value="$originalName">
              <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
                $Ship = this.ship,
                $Pilot = this.ship.pilot,
                $Reason = 'Subordinate commander assignment removed',
                $OriginalName = $originalName
              ]"/>
            </do_if>
          </do_if>
          
          <!-- Set flag to prevent duplicate signal in on_abort handler -->
          <set_value name="this.$subordinate_cleanup_sent" exact="true"/>
          
          <!-- Self-cancel GT order since subordinate is no longer assigned -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Self-canceling GT order - commander assignment removed'" chance="100"/>
          </do_if>
          <cancel_order order="this.ship.defaultorder"/>
          <return/>
        </do_if>
      </do_if>
      
      <!-- If subordinate and commander no longer has GT order, restore ship name and self-abort -->
      <do_if value="$commanderExists and not $hasGTCommander">
        <!-- Commander no longer has GT order - subordinate will follow commander's new order via Assist -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': SUBORDINATE ORPHANED: Commander ' + this.ship.commander.idcode + ' no longer has GT order - restoring ship name and self-aborting'" chance="100"/>
        </do_if>
        
        <!-- Send signal to restore ship name and cleanup -->
        <do_if value="this.ship.pilot?">
          <set_value name="$originalName" exact="null"/>
          <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName?">
            <set_value name="$originalName" exact="global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName"/>
          </do_if>
          
          <do_if value="$originalName">
            <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
              $Ship = this.ship,
              $Pilot = this.ship.pilot,
              $Reason = 'Subordinate commander changed to non-GT order',
              $OriginalName = $originalName
            ]"/>
          </do_if>
        </do_if>
        
        <!-- Set flag to prevent duplicate signal in on_abort handler -->
        <set_value name="this.$subordinate_cleanup_sent" exact="true"/>
        
        <!-- Self-cancel GT order since X4 will make us follow commander's new order anyway -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Self-canceling GT order - will follow commander via Assist'" chance="100"/>
        </do_if>
        <cancel_order order="this.ship.defaultorder"/>
        <return/>
      </do_if>
      
      <!-- Update subordinate tracking flag -->
      <do_if value="$isSubordinate">
        <set_value name="this.$was_subordinate" exact="true"/>
      </do_if>
      <do_else>
        <!-- Not a subordinate anymore - clear flag -->
        <set_value name="this.$was_subordinate" exact="false"/>
      </do_else>
      
      <!-- MANDATORY: Check if pilot is XP blocked - NO trading allowed if blocked -->
      <set_value name="$pilotXPBlocked" exact="false"/>
      <set_value name="$pilotNameForDebug" exact="'No Pilot'"/>
      
      <do_if value="this.ship.pilot and global.$GT_Pilots.{this.ship.pilot}?">
        <!-- Treat paused-with-training-needed as blocking to avoid any trading until training resumes -->
        <set_value name="$pilotXPBlocked" exact="global.$GT_Pilots.{this.ship.pilot}.$XPBlocked? or global.$GT_Pilots.{this.ship.pilot}.$PausedWithTrainingNeeded?"/>
        <set_value name="$pilotNameForDebug" exact="this.ship.pilot.name"/>
      </do_if>
      
      <!-- BLOCKING CONDITION: If pilot is XP blocked, training is MANDATORY before any trading -->
      <!-- Get both current level and blocked level for proper decision making -->
      <set_value name="$pilotLevel" exact="1"/>
      <set_value name="$blockedLevel" exact="1"/>
      <do_if value="this.ship.pilot and global.$GT_Pilots.{this.ship.pilot}?">
        <do_if value="global.$GT_Pilots.{this.ship.pilot}.$Level?">
          <set_value name="$pilotLevel" exact="global.$GT_Pilots.{this.ship.pilot}.$Level"/>
        </do_if>
        <do_if value="global.$GT_Pilots.{this.ship.pilot}.$BlockedLevel?">
          <set_value name="$blockedLevel" exact="global.$GT_Pilots.{this.ship.pilot}.$BlockedLevel"/>
        </do_if>
      </do_if>
      
      <!-- Show the decision logic -->
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': DECISION LOGIC: XPBlocked=' + $pilotXPBlocked + ', ManagementLevel=' + $pilotLevel + ', BlockedLevel=' + $blockedLevel + ', Pilot=' + $pilotNameForDebug" chance="100"/>
      </do_if>
      
      <do_if value="$pilotXPBlocked">
        <!-- Check if this is a legitimate training requirement (blocked level > 1) -->
        <do_if value="$blockedLevel gt 1">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': TRAINING MANDATORY: Pilot ' + $pilotNameForDebug + ' needs Level ' + $blockedLevel + ' training - no trading allowed until training completes'" chance="100"/>
          </do_if>
          <resume label="handle_mandatory_training"/>
        </do_if>
        <do_else>
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ':  Pilot XP blocked at Level 1 (invalid) - clearing block and proceeding with trading'" chance="100"/>
          <!-- Clear the incorrect XP block for Level 1 pilots -->
          <signal_objects object="player.galaxy" param="'GT_Clear_XP_Block'" param2="table[
            $Ship = this.ship,
            $Pilot = this.ship.pilot,
            $Reason = 'Level 1 pilots should never be XP blocked'
          ]"/>
        </do_else>
      </do_if>
      <do_elseif value="not $pilotXPBlocked">
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Pilot not XP blocked - proceeding to maintenance check'" chance="100"/>
        </do_if>
        <!-- Check maintenance needs before trading starts -->
        <resume label="check_maintenance"/>
      </do_elseif>
      
      <!-- ======================================= -->
      <!-- INITIAL MAINTENANCE CHECK              -->
      <!-- ======================================= -->
      
      <label name="check_maintenance"/>
      
      <!-- ============================================================================= -->
      <!-- PRE-TRADE MAINTENANCE CHECK (UNIFIED SYSTEM)                                  -->
      <!-- ============================================================================= -->
      <!-- Signal unified maintenance system and wait for completion.                    -->
      <!-- MD system handles ALL logic: checking, finding stations, creating orders,     -->
      <!-- and monitoring. AI script just triggers and waits - clean separation!         -->
      <!-- ============================================================================= -->
      
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Requesting maintenance check'" chance="100"/>
      </do_if>
      
      <!-- Signal unified maintenance system to analyze and prepare data -->
      <signal_objects object="player.galaxy" param="'GT_DoMaintenance'" param2="this.ship"/>
      
      <!-- Wait for MD system to prepare data -->
      <wait exact="0.5s"/>
      
      <!-- Create Repair order if data prepared -->
      <do_if value="global.$GT_RepairOrders? and global.$GT_RepairOrders.{this.ship}?">
        <set_value name="$repairData" exact="global.$GT_RepairOrders.{this.ship}"/>
        <set_value name="$repairStation" exact="$repairData.$Station"/>
        
        <!-- FINAL DOCKING VERIFICATION: Use find_dockingbay for accurate dock size/permission check -->
        <!-- This is more accurate than dockingallowed and catches dock size mismatches -->
        <set_value name="$canDockRepair" exact="false"/>
        <do_if value="@$repairStation.exists">
          <!-- Skip docking check for capital ships unless station is a station (capital ships can dock at stations) -->
          <set_value name="$checkDocking" exact="not this.ship.iscapitalship or ($repairStation.isclass.station)"/>
          <do_if value="$checkDocking">
            <find_dockingbay name="$testRepairDock" object="$repairStation" checkoperational="true" multiple="false">
              <match_dock size="this.ship.docksize" storage="false"/>
            </find_dockingbay>
            <do_if value="$testRepairDock">
              <set_value name="$canDockRepair" exact="true"/>
            </do_if>
            <do_else>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Repair docking check FAILED: ' + @$repairStation.knownname + 
                  '\n  Sector: ' + @$repairStation.sector.knownname + 
                  '\n  Reason: No dock available for ship size ' + this.ship.docksize + ' (station may not have L/XL docks)' +
                  '\n  â†’ Clearing repair order and continuing trading...'" 
                  chance="100"/>
              </do_if>
              <!-- Clear repair order data so we don't try again -->
              <remove_value name="global.$GT_RepairOrders.{this.ship}"/>
            </do_else>
          </do_if>
          <do_else>
            <!-- Capital ship docking at non-station - skip docking check -->
            <set_value name="$canDockRepair" exact="true"/>
          </do_else>
        </do_if>
        
        <!-- Only create repair order if docking check passed -->
        <do_if value="$canDockRepair">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Creating Repair order at ' + $repairStation.knownname" chance="100"/>
        
        <!-- Set flag to indicate maintenance transition for on_abort handler -->
        <set_value name="this.$maintenance_transition" exact="true"/>
        
        <create_order object="this.ship" id="'Repair'" immediate="false">
            <param name="destination" value="$repairStation"/>
          <param name="hullpercent" value="100"/>
          <param name="repairall" value="true"/>
          <param name="acceptedcost" value="$repairData.$AcceptedCost"/>
          <param name="urgent" value="false"/>
          <param name="internalorder" value="true"/>
        </create_order>
        </do_if>
      </do_if>
      
      <!-- Create Resupply order if data prepared -->
      <do_if value="global.$GT_ResupplyOrders? and global.$GT_ResupplyOrders.{this.ship}?">
        <set_value name="$resupplyData" exact="global.$GT_ResupplyOrders.{this.ship}"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'" chance="100"/>
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': CREATING RESUPPLY BUILD ORDER'" chance="100"/>
          <debug_text text="'[GT-AI]    Target Station: ' + $resupplyData.$Station.knownname" chance="100"/>
          <debug_text text="'[GT-AI]    Station Owner: ' + @$resupplyData.$Station.owner.knownname" chance="100"/>
          <debug_text text="'[GT-AI]    Station Sector: ' + @$resupplyData.$Station.sector.knownname" chance="100"/>
          <debug_text text="'[GT-AI]    Station exists: ' + $resupplyData.$Station.exists" chance="100"/>
          <debug_text text="'[GT-AI]    Station operational: ' + @$resupplyData.$Station.isoperational" chance="100"/>
          <debug_text text="'[GT-AI]    Distance from ship: ' + this.ship.gatedistance.{$resupplyData.$Station} + ' jumps'" chance="100"/>
        </do_if>
        
        <!-- Use vanilla's pattern: add_build_to_modify_ship with shopping list -->
        <!-- This is what actually creates the order with specific items to buy -->
        <set_value name="$buildSuccessful" exact="false"/>
        
        <!-- add_build_to_modify_ship SETS inventory, doesn't ADD to it -->
        <!-- Tables now include CURRENT equipment + NEW equipment (preserves existing) -->
        <!-- Check if tables have keys (they should always have keys now since we preserve existing equipment) -->
        <set_value name="$ammoTableKeys" exact="@$resupplyData.$AmmoTable.keys"/>
        <set_value name="$ammoTableCount" exact="@$ammoTableKeys.count"/>
        <set_value name="$unitTableKeys" exact="@$resupplyData.$UnitTable.keys"/>
        <set_value name="$unitTableCount" exact="@$unitTableKeys.count"/>
        
        <!-- Always call add_build_to_modify_ship if we have a resupply order (tables include existing + new equipment) -->
        <do_if value="$ammoTableCount? or $unitTableCount?">
          <set_value name="$resupplyStation" exact="$resupplyData.$Station"/>
          
          <!-- FINAL DOCKING VERIFICATION: Use find_dockingbay for accurate dock size/permission check -->
          <!-- This is more accurate than dockingallowed and catches dock size mismatches -->
          <set_value name="$canDockResupply" exact="false"/>
          <do_if value="@$resupplyStation.exists">
            <find_dockingbay name="$testResupplyDock" object="$resupplyStation" checkoperational="true" multiple="false">
              <match_dock size="this.ship.docksize" storage="false"/>
            </find_dockingbay>
            <do_if value="$testResupplyDock">
              <set_value name="$canDockResupply" exact="true"/>
            </do_if>
            <do_else>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Resupply docking check FAILED: ' + @$resupplyStation.knownname + 
                  '\n  Sector: ' + @$resupplyStation.sector.knownname + 
                  '\n  Reason: No dock available for ship size ' + this.ship.docksize + ' (station may not have L/XL docks)' +
                  '\n  â†’ Clearing resupply order and continuing trading...'" 
                  chance="100"/>
              </do_if>
              <!-- Clear resupply order data so we don't try again -->
              <remove_value name="global.$GT_ResupplyOrders.{this.ship}"/>
            </do_else>
          </do_if>
          
          <!-- Only create resupply order if docking check passed -->
          <do_if value="$canDockResupply">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Shopping list - Ammo types: ' + $ammoTableCount + ', Unit types: ' + $unitTableCount" chance="100"/>
          </do_if>
          
          <!-- Set flag to indicate maintenance transition for on_abort handler -->
          <set_value name="this.$maintenance_transition" exact="true"/>
          
          <!-- Use vanilla's add_build_to_modify_ship action -->
          <!-- Tables now include CURRENT equipment (preserves it) + NEW equipment (adds to it) -->
          <!-- Use immediate="false" so GT order waits for build order to complete -->
          <add_build_to_modify_ship 
              object="$resupplyStation" 
            buildobject="this.ship" 
            ammo="$resupplyData.$AmmoTable" 
            units="$resupplyData.$UnitTable" 
            immediate="false"
            internal="true"
            result="$buildSuccessful"/>
          
          <do_if value="$buildSuccessful">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Build order created successfully - waiting for completion'" chance="100"/>
              <debug_text text="'[GT-AI] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'" chance="100"/>
            </do_if>
            <!-- Build order will complete and trigger our order.build.equip patch to signal completion -->
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': FAILED to create build order!'" chance="100"/>
              <debug_text text="'[GT-AI]    This usually means the station cannot build the requested items'" chance="100"/>
              <debug_text text="'[GT-AI] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'" chance="100"/>
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ':  Build order creation failed - station cannot fulfill order'" chance="100"/>
            </do_if>
            
            <!-- Clean up resupply data -->
            <remove_value name="global.$GT_ResupplyOrders.{this.ship}"/>
            
            <!-- Apply cooldown to prevent immediate retry -->
            <do_if value="not global.$GT_MaintenanceFailedResupply?">
              <set_value name="global.$GT_MaintenanceFailedResupply" exact="table[]"/>
            </do_if>
            <set_value name="global.$GT_MaintenanceFailedResupply.{this.ship}" exact="player.age + 300s"/>
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': ðŸ•’ Applied 5-minute cooldown due to failed build order'" chance="100"/>
            
            <!-- Remove maintenance order flag -->
            <do_if value="global.$GT_MaintenanceOrders? and global.$GT_MaintenanceOrders.{this.ship}?">
              <remove_value name="global.$GT_MaintenanceOrders.{this.ship}"/>
            </do_if>
            
            <!-- Signal MD that we're done (failed) -->
            <signal_objects object="this.ship" param="'GT_Maintenance_Complete'"/>
          </do_else>
          </do_if>
          <!-- End: Only create resupply order if docking check passed -->
          <!-- End: Only create resupply order if docking check passed -->
        </do_if>
        <do_else>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ':  Empty shopping list - nothing to buy'" chance="100"/>
          </do_if>
          
          <!-- Clean up and skip -->
          <remove_value name="global.$GT_ResupplyOrders.{this.ship}"/>
          <do_if value="global.$GT_MaintenanceOrders? and global.$GT_MaintenanceOrders.{this.ship}?">
            <remove_value name="global.$GT_MaintenanceOrders.{this.ship}"/>
          </do_if>
          
          <signal_objects object="this.ship" param="'GT_Maintenance_Complete'"/>
        </do_else>
      </do_if>
      
      <!-- Wait for maintenance to complete -->
      <do_if value="(global.$GT_RepairOrders? and global.$GT_RepairOrders.{this.ship}?) or (global.$GT_ResupplyOrders? and global.$GT_ResupplyOrders.{this.ship}?)">
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': â³ Waiting for maintenance orders to complete (max 900s)...'" chance="100"/>
        </do_if>
        
        <wait max="900s">
          <interrupt>
            <conditions>
              <event_object_signalled object="this.ship" param="'GT_Maintenance_Complete'"/>
            </conditions>
            <actions>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Maintenance complete signal received, proceeding to trade search'" chance="100"/>
              </do_if>
              
              <!-- Clear maintenance transition flag -->
              <remove_value name="this.$maintenance_transition"/>
            </actions>
          </interrupt>
        </wait>
        
        <!-- Timeout fallback -->
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': â±ï¸ Maintenance timeout after 900s, proceeding anyway'" chance="100"/>
        
        <!-- Clear maintenance transition flag on timeout as well -->
        <remove_value name="this.$maintenance_transition"/>
      </do_if>
      <do_else>
        <!-- No maintenance needed -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': No maintenance needed, proceeding to trade search'" chance="100"/>
        </do_if>
      </do_else>
      
      <!-- Proceed to trading -->
      <resume label="start_trading"/>
      
      <!-- ======================================= -->
      <!-- HIGH-PERFORMANCE TRADING LOOP          -->
      <!-- ======================================= -->
      
      <!-- ========================================= -->
      <!-- MANDATORY TRAINING HANDLER              -->
      <!-- ========================================= -->
      
      <label name="handle_mandatory_training"/>
      
      <!-- Check if ship has an active DockAndTrain order -->
      <set_value name="$hasActiveTrainingOrder" exact="false"/>
      <do_if value="this.ship.orders.count gt 0">
        <do_all exact="this.ship.orders.count" counter="$i">
          <do_if value="this.ship.orders.{$i}.id == 'DockAndTrain'">
            <set_value name="$hasActiveTrainingOrder" exact="true"/>
            <break/>
          </do_if>
        </do_all>
      </do_if>
      
      <!-- ENHANCED LOGIC: Auto-restart training if it was previously interrupted -->
      <!-- Conditions for starting/restarting training:
           1. Auto-training is enabled
           2. Ship has a pilot with GT pilot data
           3. Either: training not in progress OR no active training order (interrupted training)
      -->
      <do_if value="$gt_autotraining and this.ship.pilot and global.$GT_Pilots.{this.ship.pilot}">
        <set_value name="$shouldStartTraining" exact="false"/>
        
        <!-- Case 1: Training not currently in progress -->
        <do_if value="not this.$training_in_progress?">
          <set_value name="$shouldStartTraining" exact="true"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Training not in progress - can start training'" chance="100"/>
          </do_if>
        </do_if>
        <!-- Case 2: Training was marked as in progress but no active training order (interrupted) -->
        <do_elseif value="this.$training_in_progress? and not $hasActiveTrainingOrder">
          <set_value name="$shouldStartTraining" exact="true"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': TRAINING INTERRUPTED: Previous training was aborted - restarting automatically'" chance="100"/>
          </do_if>
          <!-- Clear the stale flag -->
          <remove_value name="this.$training_in_progress"/>
        </do_elseif>
        
        <do_if value="$shouldStartTraining">
          <!-- CRITICAL: Only trigger training if XPBlocked is true -->
          <!-- If XPBlocked is false but BlockedLevel exists, it means training stations were not found previously -->
          <!-- In that case, don't trigger another search - ship should continue trading -->
          <set_value name="$xpBlocked" exact="false"/>
          <do_if value="global.$GT_Pilots.{this.ship.pilot}.$XPBlocked?">
            <set_value name="$xpBlocked" exact="true"/>
          </do_if>
          
          <do_if value="$xpBlocked">
            <!-- Get blocked level with safety check -->
            <set_value name="$blockedLevel" exact="1"/>
            <do_if value="global.$GT_Pilots.{this.ship.pilot}.$BlockedLevel?">
              <set_value name="$blockedLevel" exact="global.$GT_Pilots.{this.ship.pilot}.$BlockedLevel"/>
            </do_if>
            <do_else>
              <!-- Calculate current skill level as fallback -->
              <do_if value="global.$GT_Pilots.{this.ship.pilot}.$XP?">
                <set_value name="$currentXP" exact="global.$GT_Pilots.{this.ship.pilot}.$XP"/>
                <do_all exact="15" counter="$skillLevel">
                  <do_if value="$currentXP ge global.$GT_Config.$XP.$SkillThresholds.{$skillLevel}">
                    <set_value name="$blockedLevel" exact="$skillLevel"/>
                  </do_if>
                </do_all>
              </do_if>
            </do_else>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': ðŸŽ“ Initiating mandatory training for pilot ' + $pilotNameForDebug + ' (Level ' + $blockedLevel + ')'" chance="100"/>
            </do_if>
            
            <!-- Signal MD system to handle training -->
            <signal_objects object="player.galaxy" param="'GT_Training_Needed'" param2="table[
              $Ship = this.ship,
              $Pilot = this.ship.pilot,
              $RequiredLevel = $blockedLevel
            ]"/>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Training signal sent to MD system for pilot ' + $pilotNameForDebug" chance="100"/>
            </do_if>
          </do_if>
          <do_else>
            <!-- XPBlocked is false but BlockedLevel exists - training stations were not found previously -->
            <!-- Don't trigger another search - ship should continue trading -->
            <set_value name="$blockedLevelForDebug" exact="'none'"/>
            <do_if value="global.$GT_Pilots.{this.ship.pilot}.$BlockedLevel?">
              <set_value name="$blockedLevelForDebug" exact="global.$GT_Pilots.{this.ship.pilot}.$BlockedLevel"/>
            </do_if>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Training needed but XPBlocked=false (no training stations found previously) - continuing with trading. BlockedLevel=' + $blockedLevelForDebug" chance="100"/>
            </do_if>
            <!-- Break out of training handler and continue to trading -->
            <resume label="check_maintenance"/>
          </do_else>
        </do_if>
        <do_else>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': â³ Training already in progress (active order: ' + $hasActiveTrainingOrder + ') - waiting'" chance="100"/>
          </do_if>
        </do_else>
      </do_if>
      <do_else>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ':  Auto-training disabled or no pilot data - waiting'" chance="100"/>
        </do_if>
      </do_else>
      
      <!-- Wait and check again - training is mandatory -->
      <wait max="10s">
        <interrupt>
          <conditions>
            <event_object_signalled object="this.ship" param="'GT_Training_Station_Found'"/>
          </conditions>
          <actions>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Training station found during wait - proceeding immediately'" chance="100"/>
            </do_if>
          </actions>
        </interrupt>
      </wait>
      <resume label="main_loop"/>
      
      <!-- ========================================= -->
      <!-- EVENT-DRIVEN TRADE SEARCH WITH RETRY     -->
      <!-- ========================================= -->
      
      <label name="start_trading"/>
      
      <!-- Ensure effectiveMaxBuy/effectiveMaxSell are initialized before use -->
      <!-- These variables might not exist if start_trading is reached without going through init label -->
      <do_if value="not $effectiveMaxBuy?">
        <set_value name="$effectiveMaxBuy" exact="$maxbuy"/>
      </do_if>
      <do_if value="not $effectiveMaxSell?">
        <set_value name="$effectiveMaxSell" exact="$maxsell"/>
      </do_if>
      
      <!-- Initialize retry counter if not exists -->
      <do_if value="not this.$searchFailed?">
        <set_value name="this.$searchFailed" exact="0"/>
      </do_if>
      
      <!-- Signal MD system for trade opportunities -->
      <!-- Check if ship already has trade orders BEFORE requesting new trade -->
      <set_value name="$hasTradeOrders" exact="false"/>
      <do_if value="this.ship.tradeorders? and this.ship.tradeorders.count gt 0">
        <set_value name="$hasTradeOrders" exact="true"/>
      </do_if>
      
      <do_if value="$hasTradeOrders">
        <!-- Ship already has pending trade orders - wait instead of requesting more -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ':  Ship already has ' + this.ship.tradeorders.count + ' trade orders - waiting for completion'" chance="100"/>
        </do_if>
        
        <!-- Wait for trade completion -->
        <wait max="10s">
          <interrupt>
            <conditions>
              <check_any>
                <event_object_signalled object="this.ship" param="'GT_Trade_Completed'"/>
                <event_object_signalled object="this.ship" param="'GT_Trade_Failed'"/>
              </check_any>
            </conditions>
            <actions>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade order completed early - checking status immediately'" chance="100"/>
              </do_if>
            </actions>
          </interrupt>
        </wait>
        <resume label="main_loop"/>
      </do_if>
      <do_else>
        <!-- Ship ready for new trade - ensure ship is registered before requesting trade search -->
        <!-- This is critical when pilot is transferred to a new ship -->
        <set_value name="$shipNotRegistered" exact="false"/>
        <do_if value="not global.$GT_Ships? or not global.$GT_Ships.{this.ship}?">
          <!-- Ship not registered yet - wait a moment for registration to complete -->
          <!-- Registration happens via GT_Update_Ship signal sent in init block -->
          <set_value name="$shipNotRegistered" exact="true"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Ship not yet registered - waiting for registration to complete...'" chance="100"/>
          </do_if>
        </do_if>
        <!-- Wait for registration using a top-level loop (no waits inside conditionals) -->
        <set_value name="$regPending" exact="$shipNotRegistered? and $shipNotRegistered and (not global.$GT_Ships? or not global.$GT_Ships.{this.ship}?)"/>
        <do_while value="$regPending">
          <wait exact="500ms"/>
          <set_value name="$regPending" exact="$shipNotRegistered? and $shipNotRegistered and (not global.$GT_Ships? or not global.$GT_Ships.{this.ship}?)"/>
        </do_while>
        
        <!-- Check cargo status -->
        <!-- Only trade if cargo is EMPTY -->
        <set_value name="$hasCargo" exact="this.ship.cargo.free.all lt this.ship.cargo.capacity.all"/>
        
        <do_if value="$hasCargo">
          <!-- Ship has cargo - sell it first using our trade search -->
          <!-- CARGO DISPOSAL: Only log initial message once (prevent spam) -->
          <set_value name="$isFirstCargoDisposalAttempt" exact="false"/>
          <do_if value="not this.$cargoDisposalFailed? or this.$cargoDisposalFailed == 0">
            <set_value name="$isFirstCargoDisposalAttempt" exact="true"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Ship has cargo - finding best buyer using trade search...'" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- Set cargo disposal flag for ship name -->
          <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.ship}?">
            <set_value name="global.$GT_Ships.{this.ship}.$CargoDisposal" exact="true"/>
          </do_if>
          
          <!-- Trigger ship rename to show [CLEARANCE] state -->
          <do_if value="@this.ship.pilot and global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}?">
            <signal_objects object="player.galaxy" param="'GT_Update_Ship_Name'" param2="table[
              $ship=this.ship, 
              $pilot=this.ship.pilot, 
              $xp=global.$GT_Pilots.{this.ship.pilot}.$XP, 
              $level=global.$GT_Pilots.{this.ship.pilot}.$Level,
              $rank=@global.$GT_Pilots.{this.ship.pilot}.$CurrentRank,
              $nameType='trader'
            ]"/>
          </do_if>
          
          <!-- Write logbook entry about cargo safety - ONLY ON FIRST ATTEMPT -->
          <do_if value="$isFirstCargoDisposalAttempt and $gt_logbookentries">
            <!-- Construct logbook message using TextDB syntax (vanilla pattern) -->
            <set_value name="$logbookMessage" exact="{77000,3204}.[this.ship.knownname]"/>
            
            <signal_objects object="player.galaxy" param="'GT_WriteLogbook'" param2="table[
              $Message = $logbookMessage,
              $Category = 'upkeep',
              $Title = 'Cargo Safety: ' + this.ship.knownname,
              $Object = this.ship,
              $Interaction = 'showonmap',
              $CheckGlobalSettings = false
            ]"/>
          </do_if>
          
          <signal_objects object="player.galaxy" param="'GT_Find_Sell'" param2="table[
            $Ship = this.ship,
            $HomeBase = this.$effectiveHome,
            $MaxSell = $effectiveMaxSell,
            $DistancePenalty = $effectiveDistancePenalty,
            $FleetCoordination = $effectiveFleetCoordination,
            $IgnoreCarrierAux = $effectiveIgnoreCarrierAux,
            $IgnoreBuildStorage = $effectiveIgnoreBuildStorage
          ]"/>
        </do_if>
        <do_else>
          <!-- Ship cargo is EMPTY - look for buy opportunities -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Cargo empty - looking for trade opportunities...'" chance="100"/>
          </do_if>
          
          <!-- Clear cargo disposal flag (cargo is now empty) -->
          <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.ship}? and global.$GT_Ships.{this.ship}.$CargoDisposal?">
            <remove_value name="global.$GT_Ships.{this.ship}.$CargoDisposal"/>
            
            <!-- CARGO DISPOSAL: Reset cargo disposal failure counter when cargo is cleared -->
            <do_if value="this.$cargoDisposalFailed?">
              <set_value name="this.$cargoDisposalFailed" exact="0"/>
            </do_if>
            
            <!-- Trigger ship rename to remove [CLEARANCE] state -->
            <do_if value="@this.ship.pilot and global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}?">
              <signal_objects object="player.galaxy" param="'GT_Update_Ship_Name'" param2="table[
                $ship=this.ship, 
                $pilot=this.ship.pilot, 
                $xp=global.$GT_Pilots.{this.ship.pilot}.$XP, 
                $level=global.$GT_Pilots.{this.ship.pilot}.$Level,
                $rank=@global.$GT_Pilots.{this.ship.pilot}.$CurrentRank,
                $nameType='trader'
              ]"/>
            </do_if>
          </do_if>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': SENDING GT_Find_Trade signal to MD at game time ' + player.age" chance="100"/>
          </do_if>
          <signal_objects object="player.galaxy" param="'GT_Find_Trade'" param2="table[
            $Ship = this.ship,
            $HomeBase = this.$effectiveHome,
            $MaxBuy = $effectiveMaxBuy,
            $MaxSell = $effectiveMaxSell,
            $CargoTarget = $gt_cargotarget,
            $WareBasket = $warebasket,
            $AllowIllegal = $gt_allowillegal,
            $IgnoreCarrierAux = $effectiveIgnoreCarrierAux,
            $IgnoreBuildStorage = $effectiveIgnoreBuildStorage,
            $DistancePenalty = $effectiveDistancePenalty,
            $FleetCoordination = $effectiveFleetCoordination
          ]"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': GT_Find_Trade signal SENT, now at game time ' + player.age" chance="100"/>
          </do_if>
        </do_else>
      </do_else>
      
      <!-- Wait for MD system response with interrupt -->
      <!-- Increase timeout to 90s to account for delayed searches (skill-based delays up to ~30s) -->
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Entering wait state for MD response at game time ' + player.age" chance="100"/>
      </do_if>
      <label name="wait_for_response"/>
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Wait interrupt handler ACTIVE at game time ' + player.age" chance="100"/>
      </do_if>
      <!-- IMPORTANT: In X4, wait without min is RANDOM (0..max). Use min=max to avoid instant timeouts. -->
      <wait min="90s" max="90s" comment="Wait for MD system response (fixed 90s; interrupted immediately on response)">
        <interrupt>
          <conditions>
            <check_any>
              <event_object_signalled object="this.ship" param="'GT_Trade_Found'"/>
              <event_object_signalled object="this.ship" param="'GT_No_Trade_Found'"/>
              <!-- Destination threatened â†’ abort and restart main loop -->
              <event_object_signalled object="this.ship" param="'GT_Destination_Threatened'"/>
            </check_any>
          </conditions>
          <actions>
            <do_if value="event.param == 'GT_Trade_Found'">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] ' + this.ship.idcode + ': INTERRUPT FIRED: GT_Trade_Found received at game time ' + player.age" chance="100"/>
                <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade found by MD system - proceeding with execution'" chance="100"/>
              </do_if>
              <!-- Reset retry counter on successful trade -->
              <set_value name="this.$searchFailed" exact="0"/>
              
              <!-- CARGO DISPOSAL: Reset cargo disposal failure counter on successful trade -->
              <do_if value="this.$cargoDisposalFailed?">
                <set_value name="this.$cargoDisposalFailed" exact="0"/>
              </do_if>
              
              <!-- Clear reroute flag (new destination found) -->
              <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.ship}? and global.$GT_Ships.{this.ship}.$Rerouting?">
                <remove_value name="global.$GT_Ships.{this.ship}.$Rerouting"/>
                
                <!-- Trigger ship rename to remove [REROUTE] state -->
                <do_if value="@this.ship.pilot and global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}?">
                  <signal_objects object="player.galaxy" param="'GT_Update_Ship_Name'" param2="table[
                    $ship=this.ship, 
                    $pilot=this.ship.pilot, 
                    $xp=global.$GT_Pilots.{this.ship.pilot}.$XP, 
                    $level=global.$GT_Pilots.{this.ship.pilot}.$Level,
                    $rank=@global.$GT_Pilots.{this.ship.pilot}.$CurrentRank,
                    $nameType='trader'
                  ]"/>
                </do_if>
              </do_if>
              
              <resume label="trade_found"/>
            </do_if>
            <do_elseif value="event.param == 'GT_No_Trade_Found'">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] ' + this.ship.idcode + ': INTERRUPT FIRED: GT_No_Trade_Found received at game time ' + player.age" chance="100"/>
              </do_if>
              <!-- Check if this is a cargo disposal attempt -->
              <set_value name="$isCargoDisposal" exact="false"/>
              <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.ship}? and global.$GT_Ships.{this.ship}.$CargoDisposal?">
                <set_value name="$isCargoDisposal" exact="true"/>
              </do_if>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] ' + this.ship.idcode + ': RECEIVED GT_No_Trade_Found signal - starting retry logic (cargo disposal: ' + $isCargoDisposal + ')'" chance="100"/>
              </do_if>
              <resume label="no_trade_retry"/>
            </do_elseif>
            <do_elseif value="event.param == 'GT_Destination_Threatened'">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': INTERRUPT FIRED: Destination threatened - aborting current trade'" chance="100"/>
              
              <!-- Set reroute flag for ship name -->
              <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.ship}?">
                <set_value name="global.$GT_Ships.{this.ship}.$Rerouting" exact="true"/>
              </do_if>
              
              <!-- Trigger ship rename to show [REROUTE] state -->
              <do_if value="@this.ship.pilot and global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}?">
                <signal_objects object="player.galaxy" param="'GT_Update_Ship_Name'" param2="table[
                  $ship=this.ship, 
                  $pilot=this.ship.pilot, 
                  $xp=global.$GT_Pilots.{this.ship.pilot}.$XP, 
                  $level=global.$GT_Pilots.{this.ship.pilot}.$Level,
                  $rank=@global.$GT_Pilots.{this.ship.pilot}.$CurrentRank,
                  $nameType='trader'
                ]"/>
              </do_if>
              
              <!-- Player logbook notification about route threat -->
              <do_if value="$gt_logbookentries">
                <set_value name="$threatData" exact="event.param2"/>
                <set_value name="$threatenedSector" exact="@$threatData.$Sector"/>
                <set_value name="$threatLevel" exact="@$threatData.$ThreatLevel"/>
                <set_value name="$hasCargo" exact="this.ship.cargo.free.all lt this.ship.cargo.capacity.all"/>
                
                <!-- Construct logbook message using TextDB syntax (vanilla pattern) -->
                <set_value name="$logbookMessage" exact="{77000,3209}.[@$threatenedSector.knownname, $threatLevel, this.ship.knownname]"/>
                
                <signal_objects object="player.galaxy" param="'GT_WriteLogbook'" param2="table[
                  $Message = $logbookMessage,
                  $Category = 'alerts',
                  $Title = 'Route Threat Detected: ' + this.ship.knownname,
                  $Object = this.ship,
                  $Interaction = 'showonmap',
                  $Highlighted = true,
                  $CheckGlobalSettings = false
                ]"/>
              </do_if>
              
              <!-- Abort current trade, go back to main loop -->
              <!-- Cargo check will detect cargo and send GT_Find_Sell automatically -->
              <cancel_all_orders object="this.ship"/>
              <resume label="main_loop"/>
            </do_elseif>
          </actions>
        </interrupt>
      </wait>
      
      <!-- Timeout fallback - treat as no trade found -->
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': TIMEOUT: MD system response timeout at game time ' + player.age + ' - assuming no trades'" chance="100"/>
      </do_if>
      <resume label="no_trade_retry"/>
      
      <!-- ========================================= -->
      <!-- TRADE FOUND - VALIDATE BLACKLIST FIRST   -->
      <!-- ========================================= -->
      <label name="trade_found"/>
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': REACHED trade_found label - starting blacklist validation at game time ' + player.age" chance="100"/>
      </do_if>
      
      <!-- Initialize validation variables BEFORE do_if block to ensure they always exist -->
      <set_value name="$validTradeFound" exact="false"/>
      <set_value name="$pendingTrade" exact="null"/>
      <set_value name="$buyStation" exact="null"/>
      <set_value name="$sellStation" exact="null"/>
      <set_value name="$tradesChecked" exact="0"/>
      <set_value name="$tradesBlacklisted" exact="0"/>
      <set_value name="$tradesRejectedDocking" exact="0"/>
      <set_value name="$tradesRejectedPath" exact="0"/>
      <set_value name="$tradesRejectedDistance" exact="0"/>
      <set_value name="$tradesRejectedCargo" exact="0"/>
      <!-- Initialize $tradeList to prevent property lookup failures -->
      <set_value name="$tradeList" exact="[]"/>
      
      <!-- Iterate through trade list and validate each one -->
      <!-- MD provided a list of up to 20 trades - we try each until we find a valid one -->
      <do_if value="global.$GT_PendingTrades? and global.$GT_PendingTrades.{this.ship}?">
        <set_value name="$tradeList" exact="global.$GT_PendingTrades.{this.ship}"/>
        
        <!-- Ensure it's a list -->
        <do_if value="typeof $tradeList != datatype.list">
          <!-- Backward compat: single trade stored as table -->
          <set_value name="$tradeList" exact="[$tradeList]"/>
        </do_if>
        
        <!-- Use safe access for debug text -->
        <set_value name="$tradeListCountForDebug" exact="if $tradeList != null then $tradeList.count else 0"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Received ' + $tradeListCountForDebug + ' trades to validate'" chance="100"/>
        </do_if>
        
        <!-- Reset validation variables (already initialized above, but reset for clarity) -->
        <set_value name="$validTradeFound" exact="false"/>
        <set_value name="$pendingTrade" exact="null"/>
        <set_value name="$buyStation" exact="null"/>
        <set_value name="$sellStation" exact="null"/>
        <set_value name="$tradesChecked" exact="0"/>
        <set_value name="$tradesBlacklisted" exact="0"/>
        <set_value name="$tradesRejectedDocking" exact="0"/>
        <set_value name="$tradesRejectedPath" exact="0"/>
        <set_value name="$tradesRejectedDistance" exact="0"/>
        <set_value name="$tradesRejectedCargo" exact="0"/>
        
        <!-- Iterate through trade list -->
        <!-- Check if tradeList exists and has items before looping -->
        <do_if value="(if $tradeList != null then $tradeList.count else 0) gt 0">
          <do_all exact="$tradeList.count" counter="$tradeIdx">
            <set_value name="$currentTrade" exact="$tradeList.{$tradeIdx}"/>
            <set_value name="$tradesChecked" operation="add"/>
            
            <!-- Cooperative multitasking: yield CPU between trade validations -->
            <!-- Use global Performance.ValidationDelay setting (default: 50ms) -->
            <!-- Ensure validationDelay is never null -->
            <set_value name="$validationDelay" exact="50"/>
            <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$ValidationDelay?">
              <set_value name="$tempDelay" exact="@global.$GT_GlobalSettings.$Performance.$ValidationDelay"/>
              <!-- Only use if tempDelay is not null and is a valid number -->
              <do_if value="$tempDelay? and $tempDelay != null and $tempDelay gt 0">
                <set_value name="$validationDelay" exact="$tempDelay"/>
              </do_if>
            </do_if>
            <!-- Convert to time value (milliseconds) - ensure result is never null -->
            <set_value name="$validationDelayTime" exact="$validationDelay * 1ms"/>
            <!-- Fallback to 50ms if validationDelayTime is null -->
            <do_if value="not $validationDelayTime? or $validationDelayTime == null">
              <set_value name="$validationDelayTime" exact="50ms"/>
            </do_if>
            <!-- CRITICAL: wait must be at top level of loop, NOT inside conditionals -->
            <wait exact="$validationDelayTime"/>
            
            <!-- Check if currentTrade is valid before processing -->
            <do_if value="$currentTrade? and $currentTrade != null">
              <!-- Extract stations from trade (handle both new list format and old single-trade format) -->
              <!-- Initialize stations to null first, then extract -->
              <set_value name="$buyStation" exact="null"/>
              <set_value name="$sellStation" exact="null"/>
              
              <!-- Check if this is a sell-only trade first -->
              <set_value name="$isSellOnlyTrade" exact="false"/>
              <do_if value="$currentTrade.$IsSellOnly? and $currentTrade.$IsSellOnly">
                <set_value name="$isSellOnlyTrade" exact="true"/>
              </do_if>
              
              <!-- Extract buy station (may be null for sell-only trades) -->
              <do_if value="$currentTrade.$BuyStation?">
                <set_value name="$buyStation" exact="$currentTrade.$BuyStation"/>
              </do_if>
              <do_else>
                <do_if value="$currentTrade.$BuyOffer?">
                  <set_value name="$buyStation" exact="@$currentTrade.$BuyOffer.owner"/>
                </do_if>
              </do_else>
              
              <!-- Extract sell station (always required) -->
              <do_if value="$currentTrade.$SellStation?">
                <set_value name="$sellStation" exact="$currentTrade.$SellStation"/>
              </do_if>
              <do_else>
                <do_if value="$currentTrade.$SellOffer?">
                  <set_value name="$sellStation" exact="@$currentTrade.$SellOffer.owner"/>
                </do_if>
              </do_else>
              
              <!-- For sell-only trades, only require sellStation; for normal trades, require both -->
              <do_if value="$isSellOnlyTrade">
                <!-- Sell-only trade: only sellStation required -->
                <do_if value="$sellStation? and $sellStation != null">
                  <!-- Use safe access for tradeIdx in debug text -->
                  <set_value name="$tradeIdxSafe" exact="if $tradeIdx? then $tradeIdx else 0"/>
                  <set_value name="$tradeListCountSafe" exact="if $tradeList != null then $tradeList.count else 0"/>
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Validating SELL-ONLY trade ' + $tradeIdxSafe + '/' + $tradeListCountSafe + ': ' + (if $currentTrade.$Ware? then @$currentTrade.$Ware.name else 'Unknown') + ' (Ship cargo â†’ ' + (if $sellStation? then @$sellStation.knownname else 'Unknown') + ')'" chance="100"/>
                  </do_if>
                  
                  <!-- Check docking permissions FIRST (most common failure, cheapest check) -->
                  <!-- Skip buy-station checks for sell-only trades (ship already has cargo) -->
                  <!-- Also check if BuyStation is not a station (could be ship for sell-only trades) -->
                  <set_value name="$buyStationIsStation" exact="false"/>
                  <do_if value="$buyStation?">
                    <set_value name="$buyStationIsStation" exact="@$buyStation.isclass.station"/>
                  </do_if>
                  
                  <!-- Only check buy-station docking if it's NOT a sell-only trade (always true for sell-only) -->
                  <set_value name="$canDockAtBuyStation" exact="true"/>
                  
                  <!-- Always check sell-station docking -->
                  <set_value name="$canDockAtSellStation" exact="@$sellStation.dockingallowed.{this.assignedcontrolled}"/>
        
                <do_if value="not $canDockAtBuyStation or not $canDockAtSellStation">
                  <!-- DOCKING NOT ALLOWED - Skip to next trade -->
                  <set_value name="$tradesRejectedDocking" operation="add"/>
                  <set_value name="$deniedStation" exact="if not $canDockAtBuyStation then $buyStation else $sellStation"/>
                  <set_value name="$deniedType" exact="if not $canDockAtBuyStation then 'BUY' else 'SELL'"/>
                  
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade ' + $tradeIdxSafe + '/' + $tradeListCountSafe + ' DOCKING DENIED:' +
                      '\n  Station: ' + @$deniedStation.knownname + 
                      '\n  Sector: ' + @$deniedStation.sector.knownname + 
                      '\n  Type: ' + $deniedType + 
                      '\n  Reason: Docking not allowed (reputation, war, or permissions)' + 
                      '\n  â†’ Trying next trade in list...'" 
                      chance="100"/>
                  </do_if>
                  
                  <!-- Continue to next trade in list -->
                  <continue/>
                </do_if>
                
                <!-- Determine ship's blacklistgroup (same logic as vanilla's lib.define.blacklistgroup) -->
                <set_value name="$blacklistgroup" exact="blacklistgroup.civilian"/>
                <do_if value="(@this.assignedcontrolled.primarypurpose == purpose.fight) or (@this.assignedcontrolled.primarypurpose == purpose.auxiliary)">
                  <set_value name="$blacklistgroup" exact="blacklistgroup.military"/>
                </do_if>
                
                <!-- Check path reachability BEFORE blacklist (faster to fail on unreachable) -->
                <!-- For sell-only trades, skip buy-station pathfinding (ship already has cargo) -->
                <set_value name="$currentSector" exact="this.ship.sector"/>
                <!-- For sell-only trades, buySector is current sector (ship already has cargo) -->
                <set_value name="$buySector" exact="$currentSector"/>
                <do_if value="not $isSellOnlyTrade and $buyStation?">
                  <set_value name="$buySector" exact="$buyStation.sector"/>
                </do_if>
                <set_value name="$sellSector" exact="$sellStation.sector"/>
                
                <!-- Check if ship is in a blacklisted sector (needed for escape path calculation) -->
                <set_value name="$currentSectorIsBlacklisted" exact="false"/>
                <do_if value="$blacklistgroup?">
                  <set_value name="$currentSectorActivityBlacklisted" exact="@$currentSector.isblacklisted.{blacklisttype.sectoractivity}.{$blacklistgroup}.{this.assignedcontrolled}"/>
                  <set_value name="$currentSectorTravelBlacklisted" exact="@$currentSector.isblacklisted.{blacklisttype.sectortravel}.{$blacklistgroup}.{this.assignedcontrolled}"/>
                  <set_value name="$currentSectorIsBlacklisted" exact="$currentSectorActivityBlacklisted or $currentSectorTravelBlacklisted"/>
                </do_if>
        
        <!-- Calculate path distances with escape support -->
        <!-- Buy path calculation with escape support -->
        <!-- For sell-only trades, buy distance is always 0 (ship already has cargo, no buy travel needed) -->
        <set_value name="$buyDistance" exact="-1"/>
        <do_if value="$isSellOnlyTrade">
          <!-- Sell-only trade: Ship already has cargo, no buy travel needed -->
          <set_value name="$buyDistance" exact="0"/>
        </do_if>
        <do_elseif value="$buySector == $currentSector">
          <!-- Ship already in buy sector - no travel needed -->
          <set_value name="$buyDistance" exact="0"/>
        </do_elseif>
        <do_elseif value="$currentSectorIsBlacklisted">
          <!-- Ship escaping from blacklisted sector - use non-blacklist-aware gatedistance to find ANY path -->
          <set_value name="$buyDistance" exact="this.ship.gatedistance.{$buySector}"/>
        </do_elseif>
        <do_else>
          <!-- Normal case: Ship needs to travel TO buy sector - use blacklist-aware pathfinding -->
          <set_value name="$buyDistance" exact="this.ship.gatedistance.{$buySector}.{$blacklistgroup}.{this.ship}"/>
        </do_else>
        
        <!-- Sell path: Calculate based on buy location -->
        <set_value name="$sellDistance" exact="-1"/>
        <do_if value="$sellSector == $buySector">
          <!-- Buy and sell in same sector -->
          <set_value name="$sellDistance" exact="0"/>
        </do_if>
        <do_elseif value="$buySector == $currentSector">
          <!-- Ship is in buy sector (same as current) - check path FROM ship's current position to sell sector -->
          <!-- This allows escape: ship in Lasting Vengeance â†’ buy in Lasting Vengeance â†’ sell in safe sector -->
          <!-- If ship is in blacklisted sector, use NON-blacklist-aware gatedistance to find ANY path -->
          <!-- This allows escape even if all paths go through blacklisted sectors -->
          <do_if value="$currentSectorIsBlacklisted">
            <!-- Escape case: Use non-blacklist-aware distance to check if ANY path exists -->
            <set_value name="$sellDistance" exact="this.ship.gatedistance.{$sellSector}"/>
          </do_if>
          <do_else>
            <!-- Normal case: Use blacklist-aware distance -->
            <set_value name="$sellDistance" exact="this.ship.gatedistance.{$sellSector}.{$blacklistgroup}.{this.ship}"/>
          </do_else>
        </do_elseif>
        <do_else>
          <!-- Normal case: Need to travel from buy to sell sector -->
          <set_value name="$sellDistance" exact="$buySector.gatedistance.{$sellSector}.{$blacklistgroup}.{this.ship}"/>
        </do_else>
        
        <!-- Always log distance check to diagnose issues -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <set_value name="$buyStationNameForDebug" exact="if $isSellOnlyTrade then 'N/A (sell-only)' else (if $buyStation? then @$buyStation.knownname else 'Unknown')"/>
          <set_value name="$buySectorNameForDebug" exact="if $isSellOnlyTrade then 'N/A (sell-only)' else (if $buyStation? then @$buyStation.sector.knownname else 'Unknown')"/>
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': PATH check (blacklist-aware):' +
            '\n  Current sector: ' + @$currentSector.knownname +
            '\n  BUY: ' + $buyStationNameForDebug + ' (Sector: ' + $buySectorNameForDebug + ', Distance: ' + $buyDistance + ')' +
            '\n  SELL: ' + @$sellStation.knownname + ' (Sector: ' + @$sellStation.sector.knownname + ', Distance: ' + $sellDistance + ')' +
            '\n  Blacklist group: ' + $blacklistgroup +
            '\n  Result: ' + (if ($buyDistance lt 0 and not $isSellOnlyTrade) or $sellDistance lt 0 then 'BLOCKED' else 'OK')" 
            chance="100"/>
        </do_if>
        
        <!-- For sell-only trades, only check sell path (buy path is always 0) -->
        <set_value name="$pathBlocked" exact="false"/>
        <do_if value="not $isSellOnlyTrade">
          <do_if value="$buyDistance lt 0">
            <set_value name="$pathBlocked" exact="true"/>
          </do_if>
        </do_if>
        <do_if value="$sellDistance lt 0">
          <set_value name="$pathBlocked" exact="true"/>
        </do_if>
        
        <do_if value="$pathBlocked">
          <!-- PATH BLOCKED - Skip to next trade -->
          <set_value name="$tradesRejectedPath" operation="add"/>
          <set_value name="$unreachableStation" exact="if ($buyDistance lt 0 and not $isSellOnlyTrade) then $buyStation else $sellStation"/>
          <set_value name="$unreachableType" exact="if ($buyDistance lt 0 and not $isSellOnlyTrade) then 'BUY' else 'SELL'"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ':   Trade ' + $tradeIdx + '/' + (if $tradeList != null then $tradeList.count else 0) + ' PATH BLOCKED:' +
              '\n  Station: ' + @$unreachableStation.knownname + 
              '\n  Type: ' + $unreachableType + 
              '\n  Reason: No path exists (disconnected sectors, war, or gates destroyed)' + 
              '\n  â†’ Trying next trade in list...'" 
              chance="100"/>
          </do_if>
          
          <!-- Continue to next trade in list -->
          <continue/>
        </do_if>
              </do_if>
              <do_else>
                <!-- Sell-only trade missing sellStation - skip this trade -->
                <debug_text text="'[GT-AI] ' + this.ship.idcode + ':  Trade ' + (if $tradeIdx? then $tradeIdx else 0) + ' MISSING SELL STATION (sell-only trade requires sellStation)'" chance="100"/>
                <continue/>
              </do_else>
            </do_if>
            <do_else>
                <!-- Normal trade: require both buyStation and sellStation -->
                <do_if value="$buyStation? and $buyStation != null and $sellStation? and $sellStation != null">
                  <!-- Normal trade validation continues here - same as before but with buy checks -->
                  <!-- Use safe access for tradeIdx in debug text -->
                  <set_value name="$tradeIdxSafe" exact="if $tradeIdx? then $tradeIdx else 0"/>
                  <set_value name="$tradeListCountSafe" exact="if $tradeList != null then $tradeList.count else 0"/>
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Validating trade ' + $tradeIdxSafe + '/' + $tradeListCountSafe + ': ' + (if $currentTrade.$BuyOffer? then @$currentTrade.$BuyOffer.ware.name else 'Unknown') + ' (' + (if $buyStation? then @$buyStation.knownname else 'Unknown') + ' â†’ ' + (if $sellStation? then @$sellStation.knownname else 'Unknown') + ')'" chance="100"/>
                  </do_if>
                  
                  <!-- Check docking permissions FIRST (most common failure, cheapest check) -->
                  <set_value name="$canDockAtBuyStation" exact="@$buyStation.dockingallowed.{this.assignedcontrolled}"/>
                  <set_value name="$canDockAtSellStation" exact="@$sellStation.dockingallowed.{this.assignedcontrolled}"/>
                  
                  <do_if value="not $canDockAtBuyStation or not $canDockAtSellStation">
                    <!-- DOCKING NOT ALLOWED - Skip to next trade -->
                    <set_value name="$tradesRejectedDocking" operation="add"/>
                    <set_value name="$deniedStation" exact="if not $canDockAtBuyStation then $buyStation else $sellStation"/>
                    <set_value name="$deniedType" exact="if not $canDockAtBuyStation then 'BUY' else 'SELL'"/>
                    
                    <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade ' + $tradeIdxSafe + '/' + $tradeListCountSafe + ' DOCKING DENIED:' +
                      '\n  Station: ' + @$deniedStation.knownname + 
                      '\n  Sector: ' + @$deniedStation.sector.knownname + 
                      '\n  Type: ' + $deniedType + 
                      '\n  Reason: Docking not allowed (reputation, war, or permissions)' + 
                      '\n  â†’ Trying next trade in list...'" 
                      chance="100"/>
                    
                    <!-- Continue to next trade in list -->
                    <continue/>
                  </do_if>
                  
                  <!-- Determine ship's blacklistgroup (same logic as vanilla's lib.define.blacklistgroup) -->
                  <set_value name="$blacklistgroup" exact="blacklistgroup.civilian"/>
                  <do_if value="(@this.assignedcontrolled.primarypurpose == purpose.fight) or (@this.assignedcontrolled.primarypurpose == purpose.auxiliary)">
                    <set_value name="$blacklistgroup" exact="blacklistgroup.military"/>
                  </do_if>
                  
                  <!-- Check path reachability BEFORE blacklist (faster to fail on unreachable) -->
                  <set_value name="$currentSector" exact="this.ship.sector"/>
                  <set_value name="$buySector" exact="$buyStation.sector"/>
                  <set_value name="$sellSector" exact="$sellStation.sector"/>
                  
                  <!-- Check if ship is in a blacklisted sector (needed for escape path calculation) -->
                  <set_value name="$currentSectorIsBlacklisted" exact="false"/>
                  <do_if value="$blacklistgroup?">
                    <set_value name="$currentSectorActivityBlacklisted" exact="@$currentSector.isblacklisted.{blacklisttype.sectoractivity}.{$blacklistgroup}.{this.assignedcontrolled}"/>
                    <set_value name="$currentSectorTravelBlacklisted" exact="@$currentSector.isblacklisted.{blacklisttype.sectortravel}.{$blacklistgroup}.{this.assignedcontrolled}"/>
                    <set_value name="$currentSectorIsBlacklisted" exact="$currentSectorActivityBlacklisted or $currentSectorTravelBlacklisted"/>
                  </do_if>
                  
                  <!-- Calculate path distances with escape support -->
                  <!-- Buy path calculation with escape support -->
                  <!-- Buy path: If ship is already in buy sector, distance is 0 (no travel needed) -->
                  <set_value name="$buyDistance" exact="-1"/>
                  <do_if value="$buySector == $currentSector">
                    <!-- Ship already in buy sector - no travel needed -->
                    <set_value name="$buyDistance" exact="0"/>
                  </do_if>
                  <do_elseif value="$currentSectorIsBlacklisted">
                    <!-- Ship escaping from blacklisted sector - use non-blacklist-aware gatedistance to find ANY path -->
            <set_value name="$buyDistance" exact="this.ship.gatedistance.{$buySector}"/>
                  </do_elseif>
                  <do_else>
                    <!-- Normal case: Ship needs to travel TO buy sector - use blacklist-aware pathfinding -->
            <set_value name="$buyDistance" exact="this.ship.gatedistance.{$buySector}.{$blacklistgroup}.{this.ship}"/>
                  </do_else>
                  
                  <!-- Sell path: Calculate based on buy location -->
                  <set_value name="$sellDistance" exact="-1"/>
                  <do_if value="$sellSector == $buySector">
                    <!-- Buy and sell in same sector -->
                    <set_value name="$sellDistance" exact="0"/>
                  </do_if>
                  <do_elseif value="$buySector == $currentSector">
                    <!-- Ship is in buy sector (same as current) - check path FROM ship's current position to sell sector -->
                    <!-- This allows escape: ship in Lasting Vengeance â†’ buy in Lasting Vengeance â†’ sell in safe sector -->
                    <!-- If ship is in blacklisted sector, use NON-blacklist-aware gatedistance to find ANY path -->
                    <!-- This allows escape even if all paths go through blacklisted sectors -->
                    <do_if value="$currentSectorIsBlacklisted">
                      <!-- Escape case: Use non-blacklist-aware distance to check if ANY path exists -->
            <set_value name="$sellDistance" exact="this.ship.gatedistance.{$sellSector}"/>
                    </do_if>
                    <do_else>
                      <!-- Normal case: Use blacklist-aware distance -->
            <set_value name="$sellDistance" exact="this.ship.gatedistance.{$sellSector}.{$blacklistgroup}.{this.ship}"/>
                    </do_else>
                  </do_elseif>
                  <do_else>
                    <!-- Normal case: Need to travel from buy to sell sector -->
          <set_value name="$sellDistance" exact="$buySector.gatedistance.{$sellSector}.{$blacklistgroup}.{this.ship}"/>
                  </do_else>
                  
                  <!-- Always log distance check to diagnose issues -->
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-AI] ' + this.ship.idcode + ': PATH check (blacklist-aware):' +
                      '\n  Current sector: ' + @$currentSector.knownname +
                      '\n  BUY: ' + @$buyStation.knownname + ' (Sector: ' + @$buyStation.sector.knownname + ', Distance: ' + $buyDistance + ')' +
                      '\n  SELL: ' + @$sellStation.knownname + ' (Sector: ' + @$sellStation.sector.knownname + ', Distance: ' + $sellDistance + ')' +
                      '\n  Blacklist group: ' + $blacklistgroup +
                      '\n  Result: ' + (if $buyDistance lt 0 or $sellDistance lt 0 then 'BLOCKED' else 'OK')" 
                      chance="100"/>
                  </do_if>
                  
                  <do_if value="$buyDistance lt 0 or $sellDistance lt 0">
                    <!-- PATH BLOCKED - Skip to next trade -->
                    <set_value name="$tradesRejectedPath" operation="add"/>
                    <set_value name="$unreachableStation" exact="if $buyDistance lt 0 then $buyStation else $sellStation"/>
                    <set_value name="$unreachableType" exact="if $buyDistance lt 0 then 'BUY' else 'SELL'"/>
                    
                    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                      <debug_text text="'[GT-AI] ' + this.ship.idcode + ':   Trade ' + $tradeIdx + '/' + (if $tradeList != null then $tradeList.count else 0) + ' PATH BLOCKED:' +
                        '\n  Station: ' + @$unreachableStation.knownname + 
                        '\n  Type: ' + $unreachableType + 
                        '\n  Reason: No path exists (disconnected sectors, war, or gates destroyed)' + 
                        '\n  â†’ Trying next trade in list...'" 
                        chance="100"/>
                    </do_if>
                    
                    <!-- Continue to next trade in list -->
                    <continue/>
                  </do_if>
                </do_if>
                <do_else>
                  <!-- Normal trade missing stations - skip this trade -->
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-AI] ' + this.ship.idcode + ':  Trade ' + (if $tradeIdx? then $tradeIdx else 0) + ' MISSING STATIONS (normal trade requires both buy and sell stations)'" chance="100"/>
                  </do_if>
                  <continue/>
                </do_else>
              </do_else>
              
              <!-- Both sell-only and normal trades continue here (only if they passed initial checks) -->
              <!-- Validate distance from HOME SECTOR (not ship position) -->
              <!-- Subordinates ALWAYS use commander's home sector (via $effectiveHome) -->
              <!-- For non-subordinates: Always use defaultorder.$home as PRIMARY source (fixed value in order) -->
              <!-- Home sector is a fixed value in the order settings and should NEVER drift -->
              <!-- Ships must only trade with stations within maxbuy/maxsell from home sector -->
              <!-- Note: $effectiveHome already handles subordinates correctly (set at initialization) -->
              <set_value name="$homeBase" exact="this.$effectiveHome"/>
              
              <!-- Fallback: Only if effectiveHome is not available, check defaultorder.$home -->
              <do_if value="not $homeBase? or not $homeBase.exists">
                <set_value name="$homeBase" exact="@this.ship.defaultorder.$home"/>
                <do_if value="not $homeBase? or not $homeBase.exists">
                  <!-- REMOVED: Never fall back to ship.sector (causes cascading drift) -->
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-AI-ERROR] Home sector not found for ' + this.ship.idcode + ' - effectiveHome and defaultorder.$home are null! This should never happen.'" chance="100"/>
                  </do_if>
                  <!-- Emergency fallback only - this should never happen -->
                  <set_value name="$homeBase" exact="this.ship.sector"/>
                </do_if>
              </do_if>
              
              <!-- Extract home sector -->
              <set_value name="$homeSector" exact="null"/>
              <do_if value="@$homeBase.exists">
                <do_if value="$homeBase.isclass.station">
                  <set_value name="$homeSector" exact="$homeBase.sector"/>
                </do_if>
                <do_elseif value="$homeBase.isclass.sector">
                  <set_value name="$homeSector" exact="$homeBase"/>
                </do_elseif>
              </do_if>
              
              <do_if value="not $homeSector? or not $homeSector.exists">
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-AI-ERROR] Failed to extract home sector from homeBase for ' + this.ship.idcode + ' - using ship.sector as emergency fallback (THIS WILL CAUSE DRIFT!)'" chance="100"/>
                </do_if>
                <!-- Emergency fallback only - this should never happen -->
                <set_value name="$homeSector" exact="this.ship.sector"/>
              </do_if>
              
              <!-- Calculate distance from HOME SECTOR to stations (range-only, no blacklist) -->
              <!-- For sell-only trades, skip buy distance check (no buy station) -->
              <set_value name="$buyDistanceFromHome" exact="0"/>
              <set_value name="$sellDistanceFromHome" exact="-1"/>
              
              <do_if value="not $isSellOnlyTrade">
                <!-- Normal trade: check buy distance from home -->
                <set_value name="$buyDistanceFromHome" exact="-1"/>
                <do_if value="$buySector == $homeSector">
                  <set_value name="$buyDistanceFromHome" exact="0"/>
                </do_if>
                <do_else>
                  <set_value name="$buyDistanceFromHome" exact="$homeSector.gatedistance.{$buySector}"/>
                </do_else>
              </do_if>
              
              <!-- Always check sell distance from home -->
              <do_if value="$sellSector == $homeSector">
                <set_value name="$sellDistanceFromHome" exact="0"/>
              </do_if>
              <do_else>
                <set_value name="$sellDistanceFromHome" exact="$homeSector.gatedistance.{$sellSector}"/>
              </do_else>
              
              <!-- Show calculated distances for diagnosis -->
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <set_value name="$buyStationNameForDebug" exact="if $isSellOnlyTrade then 'N/A (sell-only)' else (if $buyStation? then @$buyStation.knownname else 'Unknown')"/>
                <set_value name="$buySectorNameForDebug" exact="if $isSellOnlyTrade then 'N/A (sell-only)' else (if $buyStation? then @$buyStation.sector.knownname else 'Unknown')"/>
                <debug_text text="'[GT-AI] ' + this.ship.idcode + ': HOME SECTOR distance check (trade ' + $tradeIdx + '):' +
                  '\n  Home sector: ' + @$homeSector.knownname +
                  '\n  BUY station: ' + $buyStationNameForDebug + ' (Sector: ' + $buySectorNameForDebug + ', Distance from home: ' + $buyDistanceFromHome + '/' + $maxbuy + ' jumps)' +
                  '\n  SELL station: ' + @$sellStation.knownname + ' (Sector: ' + @$sellStation.sector.knownname + ', Distance from home: ' + $sellDistanceFromHome + '/' + $maxsell + ' jumps)' +
                  '\n  Ship position: ' + @this.ship.sector.knownname +
                  '\n  Validation: ' + (if ($buyDistanceFromHome lt 0 or $sellDistanceFromHome lt 0 or ($buyDistanceFromHome gt $maxbuy and not $isSellOnlyTrade) or $sellDistanceFromHome gt $maxsell) then 'REJECTED' else 'PASSED')"
                  chance="100"/>
              </do_if>
              
              <!-- Reject if stations exceed maxDistance from home -->
              <!-- For sell-only trades, only check sell distance -->
              <set_value name="$distanceCheckFailed" exact="false"/>
              <do_if value="not $isSellOnlyTrade">
                <do_if value="$buyDistanceFromHome lt 0 or $buyDistanceFromHome gt $maxbuy">
                  <set_value name="$distanceCheckFailed" exact="true"/>
                </do_if>
              </do_if>
              <do_if value="$sellDistanceFromHome lt 0 or $sellDistanceFromHome gt $maxsell">
                <set_value name="$distanceCheckFailed" exact="true"/>
              </do_if>
              
              <do_if value="$distanceCheckFailed">
                <set_value name="$tradesRejectedDistance" operation="add"/>
                
                <set_value name="$buyStationNameForDebug" exact="if $isSellOnlyTrade then 'N/A (sell-only)' else (if $buyStation? then @$buyStation.knownname else 'Unknown')"/>
                <set_value name="$buySectorNameForDebug" exact="if $isSellOnlyTrade then 'N/A (sell-only)' else (if $buyStation? then @$buyStation.sector.knownname else 'Unknown')"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade ' + $tradeIdx + '/' + (if $tradeList != null then $tradeList.count else 0) + ' DISTANCE EXCEEDED:' +
                    '\n  BUY: ' + $buyStationNameForDebug + ' (Sector: ' + $buySectorNameForDebug + ', Distance from home: ' + $buyDistanceFromHome + '/' + $maxbuy + ' jumps)' +
                    '\n  SELL: ' + @$sellStation.knownname + ' (Sector: ' + @$sellStation.sector.knownname + ', Distance from home: ' + $sellDistanceFromHome + '/' + $maxsell + ' jumps)' +
                    '\n  Home sector: ' + @$homeSector.knownname +
                    '\n  Ship position: ' + @this.ship.sector.knownname +
                    '\n  Reason: Station(s) exceed maximum distance from home sector' +
                    '\n  â†’ Trying next trade in list...'"
                    chance="100"/>
                </do_if>
                
                <!-- Continue to next trade in list -->
                <continue/>
              </do_if>
              
              <!-- Check if ship is in a blacklisted sector -->
              <set_value name="$currentSectorIsBlacklisted" exact="false"/>
              <do_if value="$blacklistgroup?">
                <set_value name="$currentSectorActivityBlacklisted" exact="@$currentSector.isblacklisted.{blacklisttype.sectoractivity}.{$blacklistgroup}.{this.assignedcontrolled}"/>
                <set_value name="$currentSectorTravelBlacklisted" exact="@$currentSector.isblacklisted.{blacklisttype.sectortravel}.{$blacklistgroup}.{this.assignedcontrolled}"/>
                <set_value name="$currentSectorIsBlacklisted" exact="$currentSectorActivityBlacklisted or $currentSectorTravelBlacklisted"/>
              </do_if>
              
              <!-- Check if buy station OR its sector is blacklisted -->
              <!-- Always check target sector blacklist - escape only affects PATH, not destination -->
              <!-- For sell-only trades, skip buy station blacklist check (no buy station) -->
              <set_value name="$buyBlacklisted" exact="false"/>
              <do_if value="not $isSellOnlyTrade and $blacklistgroup? and $buyStation?">
                <!-- Check station itself (objectactivity) -->
                <set_value name="$buyStationBlacklisted" exact="@$buyStation.isblacklisted.{blacklisttype.objectactivity}.{$blacklistgroup}.{this.assignedcontrolled}"/>
                <!-- Check sector (sectoractivity AND sectortravel - same as vanilla) -->
                <set_value name="$buySectorActivityBlacklisted" exact="@$buyStation.sector.isblacklisted.{blacklisttype.sectoractivity}.{$blacklistgroup}.{this.assignedcontrolled}"/>
                <set_value name="$buySectorTravelBlacklisted" exact="@$buyStation.sector.isblacklisted.{blacklisttype.sectortravel}.{$blacklistgroup}.{this.assignedcontrolled}"/>
                
                <!-- Block buying in blacklisted sector (force escape) -->
                <!-- Ship in blacklisted sector must NOT buy in that sector -->
                <!-- Ship must escape by buying from a different (non-blacklisted) sector -->
                <do_if value="$buySectorActivityBlacklisted or $buySectorTravelBlacklisted">
                  <!-- Block buying in blacklisted sector (even if ship is already there) -->
                  <set_value name="$buyBlacklisted" exact="true"/>
                </do_if>
                <do_else>
                  <!-- Target sector is not blacklisted - only check station -->
                  <set_value name="$buyBlacklisted" exact="$buyStationBlacklisted"/>
                </do_else>
                
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <set_value name="$buyStationNameForDebug" exact="if $buyStation? then @$buyStation.knownname else 'Unknown'"/>
                  <set_value name="$buySectorNameForDebug" exact="if $buyStation? then @$buyStation.sector.knownname else 'Unknown'"/>
                  <debug_text text="'[GT-AI] ' + this.ship.idcode + ': BUY blacklist check:' +
                    '\n  Current sector: ' + @$currentSector.knownname + ' (blacklisted: ' + $currentSectorIsBlacklisted + ')' +
                    '\n  Station: ' + $buyStationNameForDebug + 
                    '\n  Sector: ' + $buySectorNameForDebug + 
                    '\n  Station (objectactivity): ' + $buyStationBlacklisted + 
                    '\n  Sector (sectoractivity): ' + $buySectorActivityBlacklisted + 
                    '\n  Sector (sectortravel): ' + $buySectorTravelBlacklisted + 
                    '\n  Ship in buy sector: ' + ($buySector == $currentSector) +
                    '\n  Final result: ' + $buyBlacklisted" 
                    chance="100"/>
                </do_if>
              </do_if>
              
              <!-- Check if sell station OR its sector is blacklisted -->
              <!-- Always check target sector blacklist - escape only affects PATH, not destination -->
              <set_value name="$sellBlacklisted" exact="false"/>
              <do_if value="$blacklistgroup?">
                <!-- Check station itself (objectactivity) -->
                <set_value name="$sellStationBlacklisted" exact="@$sellStation.isblacklisted.{blacklisttype.objectactivity}.{$blacklistgroup}.{this.assignedcontrolled}"/>
                <!-- Check sector (sectoractivity AND sectortravel - same as vanilla) -->
                <set_value name="$sellSectorActivityBlacklisted" exact="@$sellStation.sector.isblacklisted.{blacklisttype.sectoractivity}.{$blacklistgroup}.{this.assignedcontrolled}"/>
                <set_value name="$sellSectorTravelBlacklisted" exact="@$sellStation.sector.isblacklisted.{blacklisttype.sectortravel}.{$blacklistgroup}.{this.assignedcontrolled}"/>
                
                <!-- Always check if target sector is blacklisted -->
                <!-- Escape exception: Allow sell sector if ship is already IN it (escape FROM) -->
                <!-- But still block if ship needs to travel TO a blacklisted sector -->
                <do_if value="$sellSectorActivityBlacklisted or $sellSectorTravelBlacklisted">
                  <do_if value="$sellSector == $currentSector">
                    <!-- Ship is already in sell sector - allow escape FROM blacklisted sector -->
                    <!-- Only block if station itself is blacklisted -->
                    <set_value name="$sellBlacklisted" exact="$sellStationBlacklisted"/>
                  </do_if>
                  <do_else>
                    <!-- Ship needs to travel TO a blacklisted sector - BLOCK -->
                    <set_value name="$sellBlacklisted" exact="true"/>
                  </do_else>
                </do_if>
                <do_else>
                  <!-- Target sector is not blacklisted - only check station -->
                  <set_value name="$sellBlacklisted" exact="$sellStationBlacklisted"/>
                </do_else>
                
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-AI] ' + this.ship.idcode + ': SELL blacklist check:' +
                    '\n  Current sector: ' + @$currentSector.knownname + ' (blacklisted: ' + $currentSectorIsBlacklisted + ')' +
                    '\n  Station: ' + @$sellStation.knownname + 
                    '\n  Sector: ' + @$sellStation.sector.knownname + 
                    '\n  Station (objectactivity): ' + $sellStationBlacklisted + 
                    '\n  Sector (sectoractivity): ' + $sellSectorActivityBlacklisted + 
                    '\n  Sector (sectortravel): ' + $sellSectorTravelBlacklisted + 
                    '\n  Ship in sell sector: ' + ($sellSector == $currentSector) +
                    '\n  Final result: ' + $sellBlacklisted" 
                    chance="100"/>
                </do_if>
              </do_if>
              
              <!-- Block intra-sector trades in blacklisted sectors -->
              <!-- If ship is in blacklisted sector and both buy/sell are in same sector, block to force escape -->
              <set_value name="$isIntraSectorTradeInBlacklisted" exact="false"/>
              <do_if value="$currentSectorIsBlacklisted and $buySector == $currentSector and $sellSector == $currentSector">
                <set_value name="$isIntraSectorTradeInBlacklisted" exact="true"/>
                <set_value name="$buyBlacklisted" exact="true"/>  <!-- Block by marking as blacklisted -->
                
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-AI] ' + this.ship.idcode + ':   Intra-sector trade BLOCKED (escape required):' +
                    '\n  Current sector: ' + @$currentSector.knownname + ' (BLACKLISTED)' +
                    '\n  Buy/Sell: Both in ' + @$currentSector.knownname +
                    '\n  Reason: Ship must escape from blacklisted sector'"
                    chance="100"/>
                </do_if>
              </do_if>
              
              <!-- Check if trade is blacklisted -->
              <do_if value="$buyBlacklisted or $sellBlacklisted">
                <!-- BLACKLISTED - Skip to next trade in list -->
                <set_value name="$tradesBlacklisted" operation="add"/>
                <set_value name="$blacklistedStation" exact="if $buyBlacklisted then $buyStation else $sellStation"/>
                <set_value name="$tradeType" exact="if $buyBlacklisted then 'BUY' else 'SELL'"/>
                
                <!-- Determine what was blacklisted (station or sector) -->
                <set_value name="$blacklistReason" exact="'Sector (sectortravel)'"/>  <!-- Default to most common case -->
                <do_if value="$buyBlacklisted">
                  <do_if value="$buyStationBlacklisted">
                    <set_value name="$blacklistReason" exact="'Station (objectactivity)'"/>
                  </do_if>
                  <do_elseif value="$buySectorActivityBlacklisted">
                    <set_value name="$blacklistReason" exact="'Sector (sectoractivity)'"/>
                  </do_elseif>
                </do_if>
                <do_else>
                  <do_if value="$sellStationBlacklisted">
                    <set_value name="$blacklistReason" exact="'Station (objectactivity)'"/>
                  </do_if>
                  <do_elseif value="$sellSectorActivityBlacklisted">
                    <set_value name="$blacklistReason" exact="'Sector (sectoractivity)'"/>
                  </do_elseif>
                </do_else>
                
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade ' + $tradeIdx + '/' + (if $tradeList != null then $tradeList.count else 0) + ' BLACKLISTED:' +
                    '\n  Station: ' + @$blacklistedStation.knownname + 
                    '\n  Sector: ' + @$blacklistedStation.sector.knownname + 
                    '\n  Type: ' + $tradeType + 
                    '\n  Reason: ' + $blacklistReason + 
                    '\n  â†’ Trying next trade in list...'" 
                    chance="100"/>
                </do_if>
                
                <!-- Record failed sector for future filtering -->
                <signal_objects object="player.galaxy" param="'GT_Trade_Failed'" param2="table[
                  $Ship = this.ship,
                  $Reason = 'TRADEPARTNER_BLACKLISTED',
                  $FailureText = 'Trade partner is blacklisted (pre-validation)',
                  $Partner = $blacklistedStation,
                  $IsBuying = $buyBlacklisted,
                  $Ware = @$currentTrade.$Ware
                ]"/>
                
                <!-- Continue to next trade in list -->
                <continue/>
              </do_if>
              
              <!-- Check if ship can carry this ware type (cargo bay compatibility) -->
              <!-- Some wares (like Methane/gas) require special cargo bays that normal ships don't have -->
              <!-- For sell-only trades, use $Ware instead of $BuyOffer.ware -->
              <set_value name="$ware" exact="null"/>
              <do_if value="$isSellOnlyTrade and $currentTrade.$Ware?">
                <set_value name="$ware" exact="$currentTrade.$Ware"/>
              </do_if>
              <do_elseif value="$currentTrade.$BuyOffer?">
                <set_value name="$ware" exact="@$currentTrade.$BuyOffer.ware"/>
              </do_elseif>
              
              <do_if value="$ware? and $ware != null">
                <set_value name="$canCarryWareType" exact="this.ship.cargo.{$ware}.max gt 0"/>
                
                <do_if value="not $canCarryWareType">
                  <!-- SHIP CANNOT CARRY THIS WARE TYPE - Skip to next trade -->
                  <set_value name="$tradesRejectedCargo" operation="add"/>
                  
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-AI] ' + this.ship.idcode + ':  Trade ' + $tradeIdx + '/' + (if $tradeList != null then $tradeList.count else 0) + ' INCOMPATIBLE CARGO TYPE:' +
                      '\n  Ware: ' + @$ware.name + 
                      '\n  Reason: Ship does not have required cargo bay type (e.g., liquid/gas requires special containment)' +
                      '\n  Ship cargo max for this ware: ' + this.ship.cargo.{$ware}.max +
                      '\n  â†’ Trying next trade in list...'" 
                      chance="100"/>
                  </do_if>
                  
                  <!-- Continue to next trade in list -->
                  <continue/>
                </do_if>
                
                <!-- Validation passed - this trade is valid -->
                <!-- Note: Cargo space and money validation will be handled by clamp_trade_amount before order creation -->
                <!-- Use safe access for tradeIdx -->
                <set_value name="$tradeIdxSafe" exact="if $tradeIdx? then $tradeIdx else 0"/>
                <set_value name="$tradeListCountSafe" exact="if $tradeList != null then $tradeList.count else 0"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade ' + $tradeIdxSafe + '/' + $tradeListCountSafe + ' passed validation - checking offer availability...'" chance="100"/>
                </do_if>
                
                <!-- Check offer validity INSIDE loop before breaking -->
                <!-- This allows us to try the next trade if offers are consumed -->
                <!-- Initialize variables before conditionals to prevent property lookup errors -->
                <set_value name="$buyOfferStillValid" exact="true"/>
                <set_value name="$sellOfferStillValid" exact="false"/>
                <set_value name="$buyOfferAvailable" exact="null"/>
                <set_value name="$buyOfferAmount" exact="null"/>
                <set_value name="$sellOfferAvailable" exact="null"/>
                <set_value name="$sellOfferAmount" exact="null"/>
                
                <do_if value="$isSellOnlyTrade">
                  <!-- Sell-only trade: only check sell offer -->
                  <do_if value="$currentTrade.$SellOffer?">
                    <set_value name="$sellOfferAvailable" exact="$currentTrade.$SellOffer.available"/>
                    <set_value name="$sellOfferAmount" exact="@$currentTrade.$SellOffer.offeramount.{this.assignedcontrolled}"/>
                    <set_value name="$sellOfferStillValid" exact="$sellOfferAvailable and $sellOfferAmount ge $currentTrade.$Amount"/>
                  </do_if>
                  <do_else>
                    <!-- Sell-only trade but no sell offer - invalid -->
                    <set_value name="$sellOfferStillValid" exact="false"/>
                  </do_else>
                </do_if>
                <do_else>
                  <!-- Normal trade: check both offers -->
                  <do_if value="$currentTrade.$BuyOffer? and $currentTrade.$SellOffer?">
                    <!-- Check buy offer: available AND has enough amount for this ship (after reservations) -->
                    <set_value name="$buyOfferAvailable" exact="$currentTrade.$BuyOffer.available"/>
                    <set_value name="$buyOfferAmount" exact="@$currentTrade.$BuyOffer.offeramount.{this.assignedcontrolled}"/>
                    <set_value name="$buyOfferStillValid" exact="$buyOfferAvailable and $buyOfferAmount ge $currentTrade.$Amount"/>
                    
                    <!-- Check sell offer: available AND has enough amount for this ship (after reservations) -->
                    <set_value name="$sellOfferAvailable" exact="$currentTrade.$SellOffer.available"/>
                    <set_value name="$sellOfferAmount" exact="@$currentTrade.$SellOffer.offeramount.{this.assignedcontrolled}"/>
                    <set_value name="$sellOfferStillValid" exact="$sellOfferAvailable and $sellOfferAmount ge $currentTrade.$Amount"/>
                  </do_if>
                  <do_else>
                    <!-- Normal trade but missing offers - invalid -->
                    <set_value name="$buyOfferStillValid" exact="false"/>
                    <set_value name="$sellOfferStillValid" exact="false"/>
                  </do_else>
                </do_else>
                
                <!-- Check if offers are valid - conditional based on trade type -->
                <set_value name="$offersInvalid" exact="false"/>
                <do_if value="$isSellOnlyTrade">
                  <!-- Sell-only trade: only check sell offer -->
                  <set_value name="$offersInvalid" exact="not $sellOfferStillValid"/>
                </do_if>
                <do_else>
                  <!-- Normal trade: check both offers -->
                  <set_value name="$offersInvalid" exact="not $buyOfferStillValid or not $sellOfferStillValid"/>
                </do_else>
                
                <do_if value="$offersInvalid">
                  <!-- Offer became invalid - try next trade in list -->
                  <set_value name="$tradesRejectedDocking" operation="add"/>  <!-- Reuse counter for "offer invalid" -->
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-AI] ' + this.ship.idcode + ':  Trade ' + $tradeIdxSafe + '/' + $tradeListCountSafe + ' offer became invalid:' +
                      '\n  Trade type: ' + (if $isSellOnlyTrade then 'SELL-ONLY' else 'NORMAL') +
                      '\n  Buy offer: ' + (if $isSellOnlyTrade then 'N/A' else (if $buyOfferAvailable? then ('available=' + $buyOfferAvailable + ', amount=' + (if $buyOfferAmount? then $buyOfferAmount else 'null') + ' (needed: ' + $currentTrade.$Amount + ')') else 'MISSING')) +
                      '\n  Sell offer: available=' + (if $sellOfferAvailable? then $sellOfferAvailable else 'null') + ', amount=' + (if $sellOfferAmount? then $sellOfferAmount else 'null') + ' (needed: ' + $currentTrade.$Amount + ')' +
                      '\n  Reason: Offer consumed/reserved by another ship or missing' +
                      '\n  â†’ Trying next trade in list...'" 
                      chance="100"/>
                  </do_if>
                  
                  <!-- Continue to next trade in list -->
                  <continue/>
                </do_if>
                
                <!-- HYBRID APPROACH: Use clamp_trade_amount for final amount validation BEFORE breaking -->
                <!-- This handles cargo space, money, and offer availability automatically -->
                <!-- If clamping results in 0, continue to next trade instead of breaking -->
                <set_value name="$finalBuyAmount" exact="$currentTrade.$Amount"/>
                <set_value name="$finalSellAmount" exact="$currentTrade.$Amount"/>
                <set_value name="$buyClampReason" exact="null"/>
                <set_value name="$sellClampReason" exact="null"/>
                <set_value name="$clampFailed" exact="false"/>
                
                <!-- Clamp buy order amount (for non-sell-only trades) -->
                <do_if value="not $isSellOnlyTrade and $currentTrade.$BuyOffer?">
                  <clamp_trade_amount 
                    trade="$currentTrade.$BuyOffer" 
                    amount="$finalBuyAmount" 
                    buyer="this.ship" 
                    seller="@$currentTrade.$BuyOffer.seller" 
                    result="$finalBuyAmount"
                    reason="$buyClampReason"/>
                  
                  <do_if value="not $finalBuyAmount? or $finalBuyAmount == 0 or $finalBuyAmount lt 0">
                    <!-- Amount clamped to 0 or invalid - try next trade -->
                    <set_value name="$tradesRejectedCargo" operation="add"/>
                    <set_value name="$clampFailed" exact="true"/>
                    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                      <set_value name="$clampReasonText" exact="if $buyClampReason? then $buyClampReason else 'unknown'"/>
                      <set_value name="$amountStatus" exact="if not $finalBuyAmount? then 'null' else if $finalBuyAmount lt 0 then 'negative (' + $finalBuyAmount + ')' else 'zero'"/>
                      <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade ' + $tradeIdxSafe + '/' + $tradeListCountSafe + ' buy amount clamped to invalid value:' +
                        '\n  Original amount: ' + $currentTrade.$Amount +
                        '\n  Clamped amount: ' + $amountStatus +
                        '\n  Clamp reason: ' + $clampReasonText +
                        '\n  Reason: ' + (if $buyClampReason == 'buyer_cargo' then 'Insufficient cargo space' else if $buyClampReason == 'buyer_money' then 'Insufficient funds' else if $buyClampReason == 'seller_cargo' then 'Seller has insufficient stock' else 'Offer constraints') +
                        '\n  â†’ Trying next trade in list...'" 
                        chance="100"/>
                    </do_if>
                  </do_if>
                  
                  <do_if value="not $clampFailed and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging and $finalBuyAmount != $currentTrade.$Amount">
                    <set_value name="$clampReasonText" exact="if $buyClampReason? then $buyClampReason else 'unknown'"/>
                    <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade ' + $tradeIdxSafe + '/' + $tradeListCountSafe + ' buy amount adjusted:' +
                      '\n  Original: ' + $currentTrade.$Amount +
                      '\n  Clamped: ' + $finalBuyAmount +
                      '\n  Reason: ' + $clampReasonText"
                      chance="100"/>
                  </do_if>
                </do_if>
                
                <!-- Clamp sell order amount -->
                <do_if value="not $clampFailed and $currentTrade.$SellOffer?">
                  <do_if value="$isSellOnlyTrade">
                    <!-- Sell-only trade: Ship already has cargo, validate against ship cargo -->
                    <clamp_trade_amount 
                      trade="$currentTrade.$SellOffer" 
                      amount="$finalSellAmount" 
                      buyer="@$currentTrade.$SellOffer.buyer" 
                      seller="this.ship" 
                      result="$finalSellAmount"
                      reason="$sellClampReason"/>
                  </do_if>
                  <do_else>
                    <!-- Normal trade: Ship doesn't have cargo yet (will buy first), don't check seller cargo -->
                    <!-- Match vanilla pattern: clamp without seller parameter (only checks buyer constraints) -->
                    <!-- Vanilla comment: "it is possible that this doesn't have the wares yet if they still need to be bought" -->
                    <clamp_trade_amount 
                      trade="$currentTrade.$SellOffer" 
                      amount="$finalSellAmount" 
                      buyer="@$currentTrade.$SellOffer.buyer" 
                      result="$finalSellAmount"
                      reason="$sellClampReason"/>
                  </do_else>
                  
                  <do_if value="not $finalSellAmount? or $finalSellAmount == 0 or $finalSellAmount lt 0">
                    <!-- Amount clamped to 0 or invalid - try next trade -->
                    <set_value name="$tradesRejectedCargo" operation="add"/>
                    <set_value name="$clampFailed" exact="true"/>
                    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                      <set_value name="$clampReasonText" exact="if $sellClampReason? then $sellClampReason else 'unknown'"/>
                      <set_value name="$amountStatus" exact="if not $finalSellAmount? then 'null' else if $finalSellAmount lt 0 then 'negative (' + $finalSellAmount + ')' else 'zero'"/>
                      <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade ' + $tradeIdxSafe + '/' + $tradeListCountSafe + ' sell amount clamped to invalid value:' +
                        '\n  Trade type: ' + (if $isSellOnlyTrade then 'SELL-ONLY' else 'NORMAL') +
                        '\n  Original amount: ' + $currentTrade.$Amount +
                        '\n  Clamped amount: ' + $amountStatus +
                        '\n  Clamp reason: ' + $clampReasonText +
                        '\n  Reason: ' + (if $sellClampReason == 'buyer_cargo' then 'Buyer has insufficient cargo space' else if $sellClampReason == 'buyer_money' then 'Buyer has insufficient funds' else if $sellClampReason == 'seller_cargo' then 'Ship has insufficient cargo' else 'Offer constraints') +
                        '\n  â†’ Trying next trade in list...'" 
                        chance="100"/>
                    </do_if>
                  </do_if>
                  
                  <do_if value="not $clampFailed and @global.$GT_GlobalSettings.$Debug.$EnableDebugLogging and $finalSellAmount != $currentTrade.$Amount">
                    <set_value name="$clampReasonText" exact="if $sellClampReason? then $sellClampReason else 'unknown'"/>
                    <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade ' + $tradeIdxSafe + '/' + $tradeListCountSafe + ' sell amount adjusted:' +
                      '\n  Trade type: ' + (if $isSellOnlyTrade then 'SELL-ONLY' else 'NORMAL') +
                      '\n  Original: ' + $currentTrade.$Amount +
                      '\n  Clamped: ' + $finalSellAmount +
                      '\n  Reason: ' + $clampReasonText"
                      chance="100"/>
                  </do_if>
                </do_if>
                
                <!-- If clamping failed, continue to next trade -->
                <do_if value="$clampFailed">
                  <continue/>
                </do_if>
                
                <!-- FINAL DOCKING VERIFICATION: Use find_dockingbay for accurate dock size/permission check -->
                <!-- This is more accurate than dockingallowed and catches dock size mismatches -->
                <!-- Check BEFORE breaking so we can continue to next trade if docking fails -->
                <set_value name="$finalDockingCheck" exact="true"/>
                <!-- Mirror vanilla order.dock.xml: use $thisship for match_relation_to + match_dock -->
                <set_value name="$thisship" exact="this.ship"/>
                
                <!-- Check buy station docking (for non-sell-only trades) -->
                <!-- Mirror vanilla order.dock.xml: include trading="true" + match_relation_to (enemy not) -->
                <do_if value="not $isSellOnlyTrade and $finalDockingCheck and $buyStation?">
                  <find_dockingbay name="$testBuyDock" object="$buyStation" checkoperational="true" multiple="false">
                    <match_dock size="$thisship.docksize" trading="true" storage="false"/>
                    <match_relation_to object="$thisship" comparison="not" relation="enemy"/>
                  </find_dockingbay>
                  <do_if value="not $testBuyDock">
                    <set_value name="$finalDockingCheck" exact="false"/>
                    <set_value name="$tradesRejectedDocking" operation="add"/>
                    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                      <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade ' + $tradeIdxSafe + '/' + $tradeListCountSafe + ' Final docking check FAILED (buy station): ' + @$buyStation.knownname + 
                        '\n  Sector: ' + @$buyStation.sector.knownname + 
                        '\n  Reason: No dock available for ship size ' + this.ship.docksize + ' (station may not have L/XL docks)' +
                        '\n  â†’ Trying next trade in list...'" 
                        chance="100"/>
                    </do_if>
                  </do_if>
                </do_if>
                
                <!-- Check sell station docking -->
                <!-- Mirror vanilla order.dock.xml: include trading="true" + match_relation_to (enemy not) -->
                <do_if value="$finalDockingCheck and $sellStation?">
                  <find_dockingbay name="$testSellDock" object="$sellStation" checkoperational="true" multiple="false">
                    <match_dock size="$thisship.docksize" trading="true" storage="false"/>
                    <match_relation_to object="$thisship" comparison="not" relation="enemy"/>
                  </find_dockingbay>
                  <do_if value="not $testSellDock">
                    <set_value name="$finalDockingCheck" exact="false"/>
                    <set_value name="$tradesRejectedDocking" operation="add"/>
                    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                      <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade ' + $tradeIdxSafe + '/' + $tradeListCountSafe + ' Final docking check FAILED (sell station): ' + @$sellStation.knownname + 
                        '\n  Sector: ' + @$sellStation.sector.knownname + 
                        '\n  Reason: No dock available for ship size ' + this.ship.docksize + ' (station may not have L/XL docks)' +
                        '\n  â†’ Trying next trade in list...'" 
                        chance="100"/>
                    </do_if>
                  </do_if>
                </do_if>
                
                <!-- If final docking check failed, continue to next trade -->
                <do_if value="not $finalDockingCheck">
                  <continue/>
                </do_if>
                
                <!-- All checks passed including clamping and final docking verification - this trade is valid -->
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade ' + $tradeIdxSafe + '/' + $tradeListCountSafe + ' is VALID - using this trade!'" chance="100"/>
                </do_if>
                <set_value name="$validTradeFound" exact="true"/>
                <set_value name="$pendingTrade" exact="$currentTrade"/>
                <!-- Store clamped amounts in pendingTrade for use after loop -->
                <set_value name="$pendingTrade.$FinalBuyAmount" exact="$finalBuyAmount"/>
                <set_value name="$pendingTrade.$FinalSellAmount" exact="$finalSellAmount"/>
                <!-- Break out of loop - we found a valid trade -->
                <break/>
              </do_if>
              <do_else>
                <!-- Ware couldn't be extracted - skip this trade -->
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-AI] ' + this.ship.idcode + ':  Trade ' + (if $tradeIdx? then $tradeIdx else 0) + ' SKIPPED: Could not extract ware from trade data'" chance="100"/>
                </do_if>
                <continue/>
              </do_else>
            </do_if>
          
          <!-- Skip trade if currentTrade is null -->
          <do_else>
            <!-- Don't access $tradeIdx here - it might not exist if loop didn't execute -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ':  Trade SKIPPED: Trade data is null'" chance="100"/>
            </do_if>
            <!-- Only use continue if we're actually in the loop -->
            <do_if value="$tradeIdx?">
              <continue/>
            </do_if>
          </do_else>
          </do_all>
        </do_if>
        <do_else>
          <!-- Trade list is empty or null - no trades to validate -->
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ':  Trade list is empty or null - no trades to validate'" chance="100"/>
          <set_value name="$validTradeFound" exact="false"/>
        </do_else>
        
        <!-- After loop: Check if we found a valid trade -->
        <!-- Use safe access and check existence before accessing -->
        <do_if value="$validTradeFound? and $validTradeFound">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Validation PASSED - creating trade orders (checked ' + $tradesChecked + ' trades, ' + $tradesRejectedPath + ' unreachable, ' + $tradesRejectedDocking + ' docking denied, ' + $tradesRejectedDistance + ' distance exceeded, ' + $tradesRejectedCargo + ' insufficient cargo, ' + $tradesBlacklisted + ' blacklisted)'" chance="100"/>
          </do_if>
          
          <!-- Update pending trade entry with ACTUAL trade being executed -->
          <!-- Failure handler expects table with $BuyStation, $SellStation, $Ware -->
          <!-- Replace trade list with specific trade data for failure tracking -->
          <!-- Handle sell-only trades (BuyOffer may be null) -->
          <!-- Extract values from pendingTrade since loop variables may be out of scope -->
          <set_value name="$isSellOnlyTradeForPending" exact="false"/>
          <do_if value="$pendingTrade.$IsSellOnly? and $pendingTrade.$IsSellOnly">
            <set_value name="$isSellOnlyTradeForPending" exact="true"/>
          </do_if>
          
          <!-- Extract stations from pendingTrade (may have been set in loop, but extract to be safe) -->
          <set_value name="$buyStationForPending" exact="null"/>
          <set_value name="$sellStationForPending" exact="null"/>
          <do_if value="$pendingTrade.$BuyStation?">
            <set_value name="$buyStationForPending" exact="$pendingTrade.$BuyStation"/>
          </do_if>
          <do_elseif value="$pendingTrade.$BuyOffer?">
            <set_value name="$buyStationForPending" exact="@$pendingTrade.$BuyOffer.owner"/>
          </do_elseif>
          <do_else>
            <!-- Use loop variable if available, otherwise null (for sell-only trades) -->
            <set_value name="$buyStationForPending" exact="$buyStation"/>
          </do_else>
          
          <do_if value="$pendingTrade.$SellStation?">
            <set_value name="$sellStationForPending" exact="$pendingTrade.$SellStation"/>
          </do_if>
          <do_elseif value="$pendingTrade.$SellOffer?">
            <set_value name="$sellStationForPending" exact="@$pendingTrade.$SellOffer.owner"/>
          </do_elseif>
          <do_else>
            <!-- Use loop variable if available -->
            <set_value name="$sellStationForPending" exact="$sellStation"/>
          </do_else>
          
          <set_value name="$wareForPendingTrade" exact="null"/>
          <do_if value="$isSellOnlyTradeForPending and $pendingTrade.$Ware?">
            <set_value name="$wareForPendingTrade" exact="$pendingTrade.$Ware"/>
          </do_if>
          <do_elseif value="$pendingTrade.$BuyOffer?">
            <set_value name="$wareForPendingTrade" exact="@$pendingTrade.$BuyOffer.ware"/>
          </do_elseif>
          
          <do_if value="not global.$GT_PendingTrades?">
            <set_value name="global.$GT_PendingTrades" exact="table[]"/>
          </do_if>
          <set_value name="global.$GT_PendingTrades.{this.ship}" exact="table[
            $BuyStation = $buyStationForPending,
            $SellStation = $sellStationForPending,
            $Ware = $wareForPendingTrade
          ]"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <set_value name="$buyStationNameForDebug" exact="if $isSellOnlyTradeForPending then 'N/A (sell-only)' else (if $buyStationForPending? then @$buyStationForPending.knownname else 'Unknown')"/>
            <set_value name="$sellStationNameForDebug" exact="if $sellStationForPending? then @$sellStationForPending.knownname else 'Unknown'"/>
            <set_value name="$wareNameForDebug" exact="if $wareForPendingTrade? then @$wareForPendingTrade.name else 'Unknown'"/>
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Updated pending trade entry for failure tracking:' +
              '\n  Buy: ' + $buyStationNameForDebug +
              '\n  Sell: ' + $sellStationNameForDebug +
              '\n  Ware: ' + $wareNameForDebug"
              chance="100"/>
          </do_if>
          
          <!-- Final offer validity check and clamping moved inside loop -->
          <!-- Offers are validated and clamped before breaking out of the loop -->
          <!-- Final docking verification also moved inside loop - allows trying next trade if docking fails -->
          <!-- All checks passed including final docking verification (checked in loop) - safe to create orders with clamped amounts -->
          <!-- Clamped amounts are stored in $pendingTrade.$FinalBuyAmount and $pendingTrade.$FinalSellAmount -->
          <!-- Create X4 native TradePerform orders with blacklist routing -->
          <!-- CRITICAL: internal="true" is REQUIRED for vanilla to track pending trades and display count -->
          <!-- Without internal="true", vanilla won't set $internalorder in TradePerform, and pending trades won't be displayed -->
          <!-- For sell-only trades, skip buy order (ship already has cargo) -->
          <set_value name="$finalBuyAmount" exact="if $pendingTrade.$FinalBuyAmount? then $pendingTrade.$FinalBuyAmount else $pendingTrade.$Amount"/>
          <set_value name="$finalSellAmount" exact="if $pendingTrade.$FinalSellAmount? then $pendingTrade.$FinalSellAmount else $pendingTrade.$Amount"/>
          
          <!-- FINAL VALIDATION: Re-check offers with tradepartner to ensure trade rules are respected -->
          <!-- This catches cases where offers were found without tradepartner or trade rules changed -->
          <!-- Trade rules (e.g., "internal only") are enforced by find_*_offer when tradepartner is specified -->
          <set_value name="$buyOfferValid" exact="true"/>
          <set_value name="$sellOfferValid" exact="true"/>
          
          <!-- Validate buy offer (if not sell-only) -->
          <do_if value="not $isSellOnlyTradeForPending and $pendingTrade.$BuyOffer?">
            <set_value name="$buyStation" exact="null"/>
            <set_value name="$buyWare" exact="null"/>
            <do_if value="$pendingTrade.$BuyOffer.owner?">
              <set_value name="$buyStation" exact="@$pendingTrade.$BuyOffer.owner"/>
            </do_if>
            <do_if value="$pendingTrade.$BuyOffer.ware?">
              <set_value name="$buyWare" exact="@$pendingTrade.$BuyOffer.ware"/>
            </do_if>
            
            <do_if value="@$buyStation.exists and $buyWare != null">
              <find_sell_offer seller="$buyStation" wares="$buyWare" tradepartner="this.ship" result="$validatedBuyOffer"/>
              <do_if value="not $validatedBuyOffer.available">
                <set_value name="$buyOfferValid" exact="false"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Buy offer invalid (trade rules?) - station: ' + @$buyStation.knownname + ', ware: ' + @$buyWare.name" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- Validate sell offer -->
          <do_if value="$pendingTrade.$SellOffer?">
            <set_value name="$sellStation" exact="null"/>
            <set_value name="$sellWare" exact="null"/>
            <do_if value="$pendingTrade.$SellOffer.owner?">
              <set_value name="$sellStation" exact="@$pendingTrade.$SellOffer.owner"/>
            </do_if>
            <do_if value="$pendingTrade.$SellOffer.ware?">
              <set_value name="$sellWare" exact="@$pendingTrade.$SellOffer.ware"/>
            </do_if>
            
            <do_if value="@$sellStation.exists and $sellWare != null">
              <find_buy_offer buyer="$sellStation" wares="$sellWare" tradepartner="this.ship" result="$validatedSellOffer"/>
              <do_if value="not $validatedSellOffer.available">
                <set_value name="$sellOfferValid" exact="false"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Sell offer invalid (trade rules?) - station: ' + @$sellStation.knownname + ', ware: ' + @$sellWare.name" chance="100"/>
                </do_if>
              </do_if>
            </do_if>
          </do_if>
          
          <!-- If offers invalid, skip order creation and retry -->
          <do_if value="not $buyOfferValid or not $sellOfferValid">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade offers invalid (trade rules violation) - retrying search'" chance="100"/>
            </do_if>
            <signal_objects object="this.ship" param="'GT_No_Trade_Found'"/>
            <return/>
          </do_if>
          
          <!-- Enforce buildstorage/carrier-aux restrictions before creating orders -->
          <!-- Resolve effective flags (prefer MD-stored AI parameters, fallback to local effective flags) -->
          <set_value name="$enfIgnoreBuildStorage" exact="false"/>
          <do_if value="global.$GT_AIParameters? and global.$GT_AIParameters.{this.ship}? and global.$GT_AIParameters.{this.ship}.$IgnoreBuildStorage?">
            <set_value name="$enfIgnoreBuildStorage" exact="global.$GT_AIParameters.{this.ship}.$IgnoreBuildStorage"/>
          </do_if>
          <do_if value="not $enfIgnoreBuildStorage">
            <set_value name="$enfIgnoreBuildStorage" exact="$effectiveIgnoreBuildStorage"/>
          </do_if>
          
          <set_value name="$enfIgnoreCarrierAux" exact="false"/>
          <do_if value="global.$GT_AIParameters? and global.$GT_AIParameters.{this.ship}? and global.$GT_AIParameters.{this.ship}.$IgnoreCarrierAux?">
            <set_value name="$enfIgnoreCarrierAux" exact="global.$GT_AIParameters.{this.ship}.$IgnoreCarrierAux"/>
          </do_if>
          <do_if value="not $enfIgnoreCarrierAux">
            <set_value name="$enfIgnoreCarrierAux" exact="$effectiveIgnoreCarrierAux"/>
          </do_if>
          
          <!-- Extract stations if needed (debug section later also uses these vars) -->
          <set_value name="$buyStationForPending" exact="if $pendingTrade.$BuyStation? then $pendingTrade.$BuyStation else (if $pendingTrade.$BuyOffer? then @$pendingTrade.$BuyOffer.owner else null)"/>
          <set_value name="$sellStationForPending" exact="if $pendingTrade.$SellStation? then $pendingTrade.$SellStation else (if $pendingTrade.$SellOffer? then @$pendingTrade.$SellOffer.owner else null)"/>
          
          <!-- Buildstorage enforcement -->
          <do_if value="$enfIgnoreBuildStorage">
            <set_value name="$buyIsBuildStorage" exact="false"/>
            <do_if value="$buyStationForPending?">
              <set_value name="$buyIsBuildStorage" exact="$buyStationForPending.isclass.buildstorage"/>
            </do_if>
            <set_value name="$sellIsBuildStorage" exact="false"/>
            <do_if value="$sellStationForPending?">
              <set_value name="$sellIsBuildStorage" exact="$sellStationForPending.isclass.buildstorage"/>
            </do_if>
            <do_if value="$buyIsBuildStorage or $sellIsBuildStorage">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade rejected by buildstorage restriction (buy=' + $buyIsBuildStorage + ', sell=' + $sellIsBuildStorage + ')'" chance="100"/>
              </do_if>
              <signal_objects object="this.ship" param="'GT_No_Trade_Found'"/>
              <return/>
            </do_if>
          </do_if>
          
          <!-- Carrier/Aux enforcement (stations only) -->
          <do_if value="$enfIgnoreCarrierAux">
            <set_value name="$rejectCarrierAux" exact="false"/>
            <do_if value="$buyStationForPending? and $buyStationForPending.isclass.station">
              <set_value name="$buyPrimaryPurpose" exact="@$buyStationForPending.primarypurpose"/>
              <do_if value="$buyPrimaryPurpose == purpose.auxiliary or $buyPrimaryPurpose == purpose.fight">
                <set_value name="$rejectCarrierAux" exact="true"/>
              </do_if>
            </do_if>
            <do_if value="not $rejectCarrierAux and $sellStationForPending? and $sellStationForPending.isclass.station">
              <set_value name="$sellPrimaryPurpose" exact="@$sellStationForPending.primarypurpose"/>
              <do_if value="$sellPrimaryPurpose == purpose.auxiliary or $sellPrimaryPurpose == purpose.fight">
                <set_value name="$rejectCarrierAux" exact="true"/>
              </do_if>
            </do_if>
            <do_if value="$rejectCarrierAux">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade rejected by carrier/aux restriction'" chance="100"/>
              </do_if>
              <signal_objects object="this.ship" param="'GT_No_Trade_Found'"/>
              <return/>
            </do_if>
          </do_if>
          
          <!-- Offers valid - proceed with order creation -->
          <!-- CRITICAL FIX: Explicitly set internal="false" to ensure vanilla counts trade orders in "credits due from trades" -->
          <!-- Vanilla's GetCreditsDueFromPlayerTrades() only counts trade orders with internal="false" -->
          <!-- INVESTIGATION: Subordinates still not counted - may be vanilla limitation (excludes ships with commanders) -->
          <!-- Vanilla TradeRoutine pattern: internal="not $blacklist_override?" (usually false) -->
          <!-- NOTE: Even with internal="false", vanilla may exclude subordinates from credits due count -->
          <!-- This appears to be a vanilla design decision - subordinates' finances are part of commander's finances -->
          <set_value name="$tradeOrderInternal" exact="false"/>

          <do_if value="$pendingTrade.$SellOffer?">
            <create_trade_order object="this.ship" tradeoffer="$pendingTrade.$SellOffer" amount="$finalSellAmount" immediate="true" internal="$tradeOrderInternal"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Created SELL trade order (internal=' + $tradeOrderInternal + ', isSubordinate=' + $isSubordinate + ', hasCommander=' + (if this.ship.commander? and this.ship.commander.exists then 'true' else 'false') + ')'" chance="100"/>
            </do_if>
          </do_if>
          <do_if value="not $isSellOnlyTradeForPending and $pendingTrade.$BuyOffer?">
            <create_trade_order object="this.ship" tradeoffer="$pendingTrade.$BuyOffer" amount="$finalBuyAmount" immediate="true" internal="$tradeOrderInternal"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Created BUY trade order (internal=' + $tradeOrderInternal + ', isSubordinate=' + $isSubordinate + ', hasCommander=' + (if this.ship.commander? and this.ship.commander.exists then 'true' else 'false') + ')'" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- Add state update signal AFTER order creation -->
          <!-- This tests if sending a signal immediately after create_trade_order interferes with TradePerform initialization -->
          <!-- NOTE: No handler exists yet (Phase 3) - signal will be sent but not processed -->
          <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
            $Ship = this.ship,
            $UpdateType = 'Trade_Order_Created',
            $TradeOrderCount = this.ship.tradeorders.count
          ]"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': PHASE 2: State update signal sent (Trade_Order_Created)'" chance="100"/>
            
            <!-- Handle sell-only trades in debug output -->
            <set_value name="$buyOrderText" exact="if $isSellOnlyTradeForPending then 'N/A (sell-only - ship already has cargo)' else (if $buyStationForPending? then @$buyStationForPending.knownname + ' â†’ ' + (if $wareForPendingTrade? then @$wareForPendingTrade.name else 'Unknown') + ' (x' + $pendingTrade.$Amount + ')' else 'Unknown')"/>
            <set_value name="$sellOrderText" exact="if $sellStationForPending? then @$sellStationForPending.knownname else 'Unknown'"/>
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade orders created:' +
              '\n  BUY: ' + $buyOrderText +
              '\n  SELL: ' + $sellOrderText"
              chance="100"/>
          </do_if>
          
          <!-- Send logbook message when ship is escaping from blacklisted sector -->
          <set_value name="$isEscapeTrade" exact="false"/>
          <do_if value="$currentSectorIsBlacklisted">
            <!-- Check if trade leads to a different sector (escape route) -->
            <set_value name="$isEscapeTrade" exact="($buySector != $currentSector) or ($sellSector != $currentSector)"/>
          </do_if>
          
          <do_if value="$isEscapeTrade">
            <!-- Build escape route message using translation -->
            <!-- Extract values safely with null checks -->
            <set_value name="$escapeWare" exact="null"/>
            <set_value name="$escapeAmount" exact="0"/>
            <set_value name="$escapeProfit" exact="0"/>
            
            <!-- Extract ware from BuyOffer (more reliable than $Ware property) -->
            <do_if value="$pendingTrade.$BuyOffer? and $pendingTrade.$BuyOffer.ware?">
              <set_value name="$escapeWare" exact="$pendingTrade.$BuyOffer.ware.name"/>
            </do_if>
            <do_elseif value="$pendingTrade.$Ware?">
              <set_value name="$escapeWare" exact="$pendingTrade.$Ware.name"/>
            </do_elseif>
            
            <!-- Extract amount -->
            <do_if value="$pendingTrade.$Amount?">
              <set_value name="$escapeAmount" exact="$pendingTrade.$Amount"/>
            </do_if>
            
            <!-- Extract profit -->
            <do_if value="$pendingTrade.$Profit?">
              <set_value name="$escapeProfit" exact="$pendingTrade.$Profit"/>
            </do_if>
            
            <!-- Safe defaults for missing values -->
            <set_value name="$currentSectorName" exact="'Unknown Sector'"/>
            <do_if value="$currentSector?">
              <set_value name="$currentSectorNameTemp" exact="@$currentSector.knownname"/>
              <do_if value="$currentSectorNameTemp?">
                <set_value name="$currentSectorName" exact="$currentSectorNameTemp"/>
              </do_if>
            </do_if>
            
            <set_value name="$buyStationName" exact="'Unknown Station'"/>
            <do_if value="$buyStation?">
              <set_value name="$buyStationNameTemp" exact="@$buyStation.knownname"/>
              <do_if value="$buyStationNameTemp?">
                <set_value name="$buyStationName" exact="$buyStationNameTemp"/>
              </do_if>
            </do_if>
            
            <set_value name="$buySectorName" exact="'Unknown Sector'"/>
            <do_if value="$buySector?">
              <set_value name="$buySectorNameTemp" exact="@$buySector.knownname"/>
              <do_if value="$buySectorNameTemp?">
                <set_value name="$buySectorName" exact="$buySectorNameTemp"/>
              </do_if>
            </do_if>
            
            <set_value name="$sellStationName" exact="'Unknown Station'"/>
            <do_if value="$sellStation?">
              <set_value name="$sellStationNameTemp" exact="@$sellStation.knownname"/>
              <do_if value="$sellStationNameTemp?">
                <set_value name="$sellStationName" exact="$sellStationNameTemp"/>
              </do_if>
            </do_if>
            
            <set_value name="$sellSectorName" exact="'Unknown Sector'"/>
            <do_if value="$sellSector?">
              <set_value name="$sellSectorNameTemp" exact="@$sellSector.knownname"/>
              <do_if value="$sellSectorNameTemp?">
                <set_value name="$sellSectorName" exact="$sellSectorNameTemp"/>
              </do_if>
            </do_if>
            
            <set_value name="$wareInfo" exact="'Unknown Ware'"/>
            <do_if value="$escapeWare?">
              <set_value name="$wareInfo" exact="$escapeWare"/>
            </do_if>
            
            <!-- Build message using translation ID 3210 with 8 parameters -->
            <!-- Parameters: currentSector, buyStation, buySector, sellStation, sellSector, ware, amount, profit -->
            <set_value name="$escapeMessage" exact="{77000,3210}.[$currentSectorName,$buyStationName,$buySectorName,$sellStationName,$sellSectorName,$wareInfo,$escapeAmount,($escapeProfit / 100)]"/>
            
            <!-- Log the message being written -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': ESCAPE ROUTE LOGBOOK DEBUG:' + '\n  Current Sector: ' + $currentSectorName + '\n  Buy: ' + $buyStationName + ' (' + $buySectorName + ')' + '\n  Sell: ' + $sellStationName + ' (' + $sellSectorName + ')' + '\n  Ware: ' + $wareInfo + ' (x' + $escapeAmount + ')' + '\n  Profit: ' + ($escapeProfit / 100) + ' Cr'" chance="100"/>
            </do_if>
            
            <!-- Log the full message text that will be written to logbook -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': ESCAPE ROUTE LOGBOOK MESSAGE:' + '\n' + $escapeMessage" chance="100"/>
            </do_if>
            
            <!-- Construct logbook message using TextDB syntax (vanilla pattern) -->
            <set_value name="$logbookMessage" exact="{77000,3210}.[$currentSectorName,$buyStationName,$buySectorName,$sellStationName,$sellSectorName,$wareInfo,$escapeAmount,($escapeProfit / 100)]"/>
            
            <!-- Write to ship logbook -->
            <signal_objects object="player.galaxy" param="'GT_WriteLogbook'" param2="table[
              $Message = $logbookMessage,
              $Category = 'general',
              $Title = 'Escape Route: ' + this.ship.knownname,
              $Object = this.ship,
              $Interaction = 'showonmap',
              $CheckGlobalSettings = false
            ]"/>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Escape route logbook entry created'" chance="100"/>
            </do_if>
          </do_if>
          
          <!-- Log to ship logbook if enabled (moved from MD execution to after validation) -->
          <set_value name="$logbookEnabled" exact="false"/>
          <do_if value="@this.ship.defaultorder.id == 'GalaxyTraderMK3' and @this.ship.defaultorder.$logbookentries">
            <set_value name="$logbookEnabled" exact="true"/>
          </do_if>
          <do_elseif value="@this.ship.defaultorder.id == 'Assist' and @this.ship.commander.defaultorder.id == 'GalaxyTraderMK3' and @this.ship.commander.defaultorder.$logbookentries">
            <set_value name="$logbookEnabled" exact="true"/>
          </do_elseif>
          
          <do_if value="$logbookEnabled">
            <signal_objects object="player.galaxy" param="'GT_TradeLogging_LogTradeOrder'" param2="table[
              $Ship = this.ship,
              $BuyOffer = $pendingTrade.$BuyOffer,
              $SellOffer = $pendingTrade.$SellOffer,
              $Amount = $pendingTrade.$Amount,
              $Profit = $pendingTrade.$Profit,
              $BuyPrice = $pendingTrade.$BuyPrice / 100,
              $SellPrice = $pendingTrade.$SellPrice / 100,
              $IsSellOnly = $isSellOnlyTradeForPending
            ]"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Logbook entry queued (sell-only: ' + $isSellOnlyTradeForPending + ')'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
        <do_else>
          <!-- All trades in list were rejected - check reason -->
          <!-- Use safe access for variables that might not exist -->
          <set_value name="$tradesRejectedPathSafe" exact="if $tradesRejectedPath? then $tradesRejectedPath else 0"/>
          <set_value name="$tradesRejectedDockingSafe" exact="if $tradesRejectedDocking? then $tradesRejectedDocking else 0"/>
          <set_value name="$tradesRejectedDistanceSafe" exact="if $tradesRejectedDistance? then $tradesRejectedDistance else 0"/>
          <set_value name="$tradesRejectedCargoSafe" exact="if $tradesRejectedCargo? then $tradesRejectedCargo else 0"/>
          <set_value name="$tradesBlacklistedSafe" exact="if $tradesBlacklisted? then $tradesBlacklisted else 0"/>
          <!-- Use safe access for $tradeList.count -->
          <set_value name="$tradeListCountSafe" exact="if $tradeList != null then $tradeList.count else 0"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': ALL ' + $tradeListCountSafe + ' trades were rejected (path: ' + $tradesRejectedPathSafe + ', docking: ' + $tradesRejectedDockingSafe + ', distance: ' + $tradesRejectedDistanceSafe + ', cargo: ' + $tradesRejectedCargoSafe + ', blacklisted: ' + $tradesBlacklistedSafe + ') - entering retry logic'" chance="100"/>
          </do_if>
          
          <!-- If ALL trades rejected due to cargo space, trigger cargo disposal -->
          <!-- Use safe access for variable check -->
          <do_if value="$tradesRejectedCargoSafe gt 0 and $tradesRejectedCargoSafe == $tradeListCountSafe">
            <set_value name="$hasCargo" exact="this.ship.cargo.free.all lt this.ship.cargo.capacity.all"/>
            <do_if value="$hasCargo">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] ' + this.ship.idcode + ':  ALL trades rejected due to insufficient cargo space - triggering cargo disposal'" chance="100"/>
              </do_if>
              <!-- Ship has cargo but not enough space for any trade - find buyer for existing cargo -->
              <signal_objects object="player.galaxy" param="'GT_Find_Sell'" param2="table[
                $Ship = this.ship,
                $IgnoreCarrierAux = $effectiveIgnoreCarrierAux,
                $IgnoreBuildStorage = $effectiveIgnoreBuildStorage
              ]"/>
              <!-- Wait for cargo sale to complete before retrying -->
              <resume label="main_loop"/>
            </do_if>
          </do_if>
          
          <!-- Check if trades came from cache - if so, trigger live search instead of retrying cache -->
          <set_value name="$searchMethod" exact="@global.$GT_PendingTradesSearchMethod.{this.ship}"/>
          <do_if value="$searchMethod == 'cache'">
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': All cached trades rejected - triggering LIVE market search instead of retrying cache'" chance="100"/>
            </do_if>
            <!-- Clear pending trades to prevent retry -->
            <remove_value name="global.$GT_PendingTrades.{this.ship}"/>
            <remove_value name="global.$GT_PendingTradesSearchMethod.{this.ship}"/>
            <!-- Send signal to force live search (bypass cache) -->
            <!-- Include MaxBuy/MaxSell - use effective values if available, otherwise use defaults from order params -->
            <set_value name="$signalMaxBuy" exact="$maxbuy"/>
            <set_value name="$signalMaxSell" exact="$maxsell"/>
            <do_if value="$effectiveMaxBuy?">
              <set_value name="$signalMaxBuy" exact="$effectiveMaxBuy"/>
            </do_if>
            <do_if value="$effectiveMaxSell?">
              <set_value name="$signalMaxSell" exact="$effectiveMaxSell"/>
            </do_if>
            <signal_objects object="player.galaxy" param="'GT_Find_Trade'" param2="table[
              $Ship = this.ship,
              $HomeBase = this.$effectiveHome,
              $MaxBuy = $signalMaxBuy,
              $MaxSell = $signalMaxSell,
              $IgnoreCarrierAux = $effectiveIgnoreCarrierAux,
              $IgnoreBuildStorage = $effectiveIgnoreBuildStorage,
              $ForceLiveSearch = true
            ]"/>
            <!-- Resume main loop to wait for live search result -->
            <resume label="main_loop"/>
          </do_if>
          <do_else>
            <!-- Trades came from live search or search method unknown - use normal retry -->
            <resume label="no_trade_retry"/>
          </do_else>
        </do_else>
      </do_if>
      <do_else>
        <!-- No pending trade data - this shouldn't happen -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ':  GT_Trade_Found received but no pending trade data!'" chance="100"/>
        </do_if>
        <wait exact="5s"/>
        <resume label="main_loop"/>
      </do_else>
      
      <!-- Stability: vanilla-style micro-yield after creating trade orders -->
      <!-- NOTE: wait must be at top level (not inside any do_if/do_else) -->
      <wait exact="1ms"/>
      
      <!-- Non-blocking XP update signal -->
      <do_if value="$gt_enablexp and this.ship.pilot">
        <signal_objects object="player.galaxy" param="'GT_Update_Pilot_XP'" param2="table[
          $Ship = this.ship,
          $Pilot = this.ship.pilot
        ]"/>
      </do_if>
      
      <!-- Set ship to trading state -->
      <set_command command="command.trade"/>
      
      <!-- Wait for trade completion or failure signal from diff patch (event-driven, no polling) -->
      <wait max="300s" comment="Wait for trade completion or failure signal">
        <interrupt>
          <conditions>
            <check_any>
              <event_object_signalled object="this.ship" param="'GT_Trade_Completed'"/>
              <event_object_signalled object="this.ship" param="'GT_Trade_Failed'"/>
            </check_any>
          </conditions>
          <actions>
            <!-- Check which signal was received -->
            <do_if value="event.param == 'GT_Trade_Completed'">
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] Trade completed signal received for ' + this.ship.idcode" chance="100"/>
              </do_if>
              <set_value name="this.$tradeComplete" exact="true"/>
              
              <!-- Restore XPBlocked if BlockedLevel still exists (training stations may have become available) -->
              <do_if value="this.ship.pilot and global.$GT_Pilots.{this.ship.pilot}?">
                <do_if value="global.$GT_Pilots.{this.ship.pilot}.$BlockedLevel? and not global.$GT_Pilots.{this.ship.pilot}.$XPBlocked?">
                  <set_value name="global.$GT_Pilots.{this.ship.pilot}.$XPBlocked" exact="true"/>
                  <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                    <debug_text text="'[GT-AI] ðŸ”’ Restored XPBlocked for pilot ' + this.ship.pilot.name + ' after trade completion (BlockedLevel: ' + global.$GT_Pilots.{this.ship.pilot}.$BlockedLevel + ')'" chance="100"/>
                  </do_if>
                </do_if>
              </do_if>
            </do_if>
            <do_elseif value="event.param == 'GT_Trade_Failed'">
              <!-- Clear fallback or isolated flags on trade failure -->
              <do_if value="(global.$GT_FallbackTradeActive? and global.$GT_FallbackTradeActive.{this.ship}?) or (global.$GT_IsolatedTradeActive? and global.$GT_IsolatedTradeActive.{this.ship}?)">
                <do_if value="global.$GT_FallbackTradeActive? and global.$GT_FallbackTradeActive.{this.ship}?">
                  <remove_value name="global.$GT_FallbackTradeActive.{this.ship}"/>
                </do_if>
                <do_if value="global.$GT_IsolatedTradeActive? and global.$GT_IsolatedTradeActive.{this.ship}?">
                  <remove_value name="global.$GT_IsolatedTradeActive.{this.ship}"/>
                </do_if>
                
                <!-- Calculate rank title for ship name update -->
                <set_value name="$pilotLevel" exact="1"/>
                <set_value name="$pilotXP" exact="0"/>
                <set_value name="$rankTitle" exact="'Lehrling'"/>
                <do_if value="this.ship.pilot and global.$GT_Pilots.{this.ship.pilot}?">
                  <set_value name="$pilotLevel" exact="@global.$GT_Pilots.{this.ship.pilot}.$Level"/>
                  <do_if value="not $pilotLevel?">
                    <set_value name="$pilotLevel" exact="1"/>
                  </do_if>
                  <set_value name="$pilotXP" exact="@global.$GT_Pilots.{this.ship.pilot}.$XP"/>
                  <do_if value="not $pilotXP?">
                    <set_value name="$pilotXP" exact="0"/>
                  </do_if>
                  <do_if value="global.$GT_Config? and global.$GT_Config.$XP? and global.$GT_Config.$XP.$TraderTitles?">
                    <set_value name="$rankIndex" exact="($pilotLevel / 3)i + 1"/>
                    <do_if value="$rankIndex gt global.$GT_Config.$XP.$TraderTitles.keys.count">
                      <set_value name="$rankIndex" exact="global.$GT_Config.$XP.$TraderTitles.keys.count"/>
                    </do_if>
                    <do_if value="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}?">
                      <set_value name="$rankTitle" exact="global.$GT_Config.$XP.$TraderTitles.{$rankIndex}"/>
                    </do_if>
                  </do_if>
                </do_if>
                
                <!-- Update ship name back to normal -->
                <signal_objects object="player.galaxy" param="'GT_Update_Ship_Name'" param2="table[
                  $ship = this.ship,
                  $pilot = this.ship.pilot,
                  $xp = $pilotXP,
                  $level = $pilotLevel,
                  $rank = $rankTitle,
                  $nameType = 'trader'
                ]"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-AI] (' + this.ship.idcode + ') Trade failed - cleared [FALLBACK]/[ISOLATED] flags'" chance="100"/>
                </do_if>
              </do_if>
              <!-- Read structured payload (with legacy guard for backward compatibility) -->
              <set_value name="$failurePayload" exact="event.param2"/>
              
              <!-- Handle legacy payloads (string) vs new structured payloads (table) -->
              <set_value name="$isLegacyPayload" exact="false"/>
              <do_if value="typeof $failurePayload == datatype.string">
                <set_value name="$isLegacyPayload" exact="true"/>
                <set_value name="this.$failureReason" exact="$failurePayload"/>
                <set_value name="this.$tradeFailed" exact="true"/>
                <set_value name="this.$tryNextTrade" exact="false"/>
                <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                  <debug_text text="'[GT-AI] Trade failed (legacy payload) for ' + this.ship.idcode + ': ' + this.$failureReason" chance="100"/>
                </do_if>
              </do_if>
              <do_else>
                <!-- New structured payload -->
                <!-- Extract properties with safe access, then check if they exist -->
                <set_value name="$reasonTypeValue" exact="@$failurePayload.$ReasonType"/>
                <set_value name="$shouldTryNextValue" exact="@$failurePayload.$ShouldTryNext"/>
                <set_value name="$reasonType" exact="if $reasonTypeValue? then $reasonTypeValue else 'MARKET'"/>
                <set_value name="$shouldTryNext" exact="if $shouldTryNextValue? then $shouldTryNextValue else false"/>
                
                <set_value name="this.$failureReason" exact="$failurePayload.$Reason"/>
                <set_value name="this.$tradeFailed" exact="true"/>
                <set_value name="this.$tryNextTrade" exact="$shouldTryNext"/>
                
                <do_if value="$shouldTryNext">
                  <debug_text text="'[GT-AI] Pathfinding failed for ' + this.ship.idcode + ': ' + this.$failureReason + ' - trying next cached alternative'" chance="100"/>
                </do_if>
                <do_else>
                  <debug_text text="'[GT-AI] Trade failed for ' + this.ship.idcode + ': ' + this.$failureReason + ' - will search for new trade'" chance="100"/>
                </do_else>
              </do_else>
            </do_elseif>
            <resume label="trade_completed"/>
          </actions>
        </interrupt>
      </wait>
      
      <!-- Timeout fallback -->
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade completion timeout after 300s - resuming anyway'" chance="100"/>
      </do_if>
      
      <label name="trade_completed"/>
      
      <!-- ======================================= -->
      <!-- PILOT CHANGE DETECTION (After Trade)   -->
      <!-- ======================================= -->
      <!-- Check for pilot changes after successful trade completion -->
      <!-- This is a natural restart point where the GT default order reruns -->
      <set_value name="$currentPilot" exact="this.ship.pilot"/>
      <do_if value="this.$trackedPilot? and $currentPilot != this.$trackedPilot">
        <!-- Pilot changed! Send signal to MD system -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': PILOT CHANGE DETECTED after trade completion! Old: ' + @this.$trackedPilot.name + ', New: ' + @$currentPilot.name" chance="100"/>
        </do_if>
        
        <signal_objects object="player.galaxy" param="'GT_Update_Ship'" param2="table[
          $updateType = 'pilot_change',
          $ship = this.ship,
          $pilot = $currentPilot,
          $oldPilot = this.$trackedPilot
        ]"/>
      </do_if>
      <!-- Update tracked pilot (always, even if no change) -->
      <set_value name="this.$trackedPilot" exact="$currentPilot"/>
      
      <!-- CRITICAL: Check if pilot is missing (pilot was transferred away) -->
      <!-- If GT order is running but ship has no pilot, cleanup and self-cancel -->
      <do_if value="not $currentPilot">
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': MISSING PILOT DETECTED after trade completion - pilot was transferred away, cleaning up and self-canceling GT order'" chance="100"/>
        </do_if>
        
        <!-- Get original ship name from ship registry -->
        <set_value name="$originalName" exact="null"/>
        <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.ship}? and global.$GT_Ships.{this.ship}.$OriginalShipName?">
          <set_value name="$originalName" exact="global.$GT_Ships.{this.ship}.$OriginalShipName"/>
        </do_if>
        
        <!-- Send cleanup signal (name restoration handled by MD system) -->
        <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
          $Ship = this.ship,
          $Pilot = null,
          $Reason = 'Pilot transferred away - GT order cannot run without pilot',
          $OriginalName = $originalName
        ]"/>
        
        <!-- Cancel all active orders (trade orders, etc.) -->
        <cancel_all_orders object="this.ship"/>
        
        <!-- Self-cancel GT order -->
        <cancel_order order="this.ship.defaultorder"/>
        <return/>
      </do_if>
      
      <!-- Check if this is a pathfinding retry (try next cached alternative) -->
      <do_if value="this.$tryNextTrade?">
        <remove_value name="this.$tryNextTrade"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Immediately requesting next trade (cache will skip failed trades)'" chance="100"/>
        </do_if>
        <!-- Skip market update wait - immediately try next cached trade -->
        <resume label="main_loop"/>
      </do_if>
      
      <!-- NOTE: Auto-repair check has been moved to MD system (gt_trading_ai.xml TradeCompleted cue) -->
      <!-- This ensures it runs even when the order is aborted/replaced during trade execution -->
      
      <!-- Update market data interval -->
      <wait max="$gt_marketupdatefreq">
        <interrupt>
          <conditions>
            <check_any>
              <event_object_signalled object="this.ship" param="'GT_Trade_Found'" comment="New trade found"/>
              <event_object_signalled object="this.ship" param="'GT_No_Trade_Found'" comment="Wake-up signal"/>
            </check_any>
          </conditions>
          <actions>
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Signal received during market update wait - resuming immediately'" chance="100"/>
          </actions>
        </interrupt>
      </wait>
      <resume label="main_loop"/>
      
      <!-- ========================================= -->
      <!-- NO TRADE FOUND - ESCALATING RETRY LOGIC  -->
      <!-- ========================================= -->
      <label name="no_trade_retry"/>
      
      <!-- CARGO DISPOSAL: Track cargo disposal failures separately -->
      <set_value name="$isCargoDisposal" exact="false"/>
      <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.ship}? and global.$GT_Ships.{this.ship}.$CargoDisposal?">
        <set_value name="$isCargoDisposal" exact="true"/>
        <!-- Initialize cargo disposal failure counter if not exists -->
        <do_if value="not this.$cargoDisposalFailed?">
          <set_value name="this.$cargoDisposalFailed" exact="0"/>
        </do_if>
        <!-- Increment cargo disposal failure counter -->
        <set_value name="this.$cargoDisposalFailed" exact="this.$cargoDisposalFailed + 1"/>
      </do_if>
      <do_else>
        <!-- Normal trade search failure - increment normal counter -->
        <!-- Increment failure counter -->
        <set_value name="this.$searchFailed" exact="this.$searchFailed + 1"/>
      </do_else>
      
      <!-- Calculate escalating wait time: 10s, 20s, 30s, 40s, 50s, 60s (max) -->
      <!-- Use cargo disposal counter if this is cargo disposal, otherwise use normal counter -->
      <set_value name="$failureCount" exact="if $isCargoDisposal then this.$cargoDisposalFailed else this.$searchFailed"/>
      <set_value name="$waitTime" exact="[$failureCount * 10s, 60s].min"/>
      
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': No ' + (if $isCargoDisposal then 'cargo buyer' else 'profitable trades') + ' found (attempt ' + $failureCount + ') - waiting ' + ($waitTime/1s) + 's before retry'" chance="100"/>
      </do_if>
      
      <!-- Set ship to waiting state -->
      <set_command command="command.wait"/>
      <set_command_action commandaction="commandaction.standingby"/>
      
      <!-- Wait with escalating delay -->
      <!-- Track if wait was interrupted (so we don't write logbook if interrupted) -->
      <set_value name="$waitInterrupted" exact="false"/>
      <set_value name="$tradeFoundDuringWait" exact="false"/>
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Entering wait for ' + ($waitTime/1s) + 's at game time ' + player.age" chance="100"/>
      </do_if>
      <wait max="$waitTime" comment="Use max to allow interrupt">
        <interrupt>
          <conditions>
            <!-- Only GT_Trade_Found should interrupt retry wait -->
            <!-- GT_No_Trade_Found signals during retry wait are ignored to preserve escalating cooldown -->
            <event_object_signalled object="this.ship" param="'GT_Trade_Found'" comment="MD found a trade"/>
          </conditions>
          <actions>
            <set_value name="$waitInterrupted" exact="true"/>
            <set_value name="$tradeFoundDuringWait" exact="true"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Trade found during retry wait - resuming immediately'" chance="100"/>
            </do_if>
            <!-- Resume to trade_found label to process the trade -->
            <resume label="trade_found"/>
          </actions>
        </interrupt>
      </wait>
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Wait completed at game time ' + player.age + ' - continuing retry logic (trade found: ' + $tradeFoundDuringWait + ')'" chance="100"/>
      </do_if>
      
      <!-- Write logbook entry only if we've reached max wait (60s) AND wait completed naturally (not interrupted by trade found) -->
      <!-- Also check if we've already written a logbook entry recently to prevent duplicates -->
      <set_value name="$shouldWriteLogbook" exact="false"/>
      <set_value name="$shouldWriteCargoDisposalLogbook" exact="false"/>
      
      <!-- CARGO DISPOSAL: Separate logbook entry for cargo disposal failures -->
      <do_if value="$isCargoDisposal and $waitTime == 60s and not $tradeFoundDuringWait">
        <!-- Check if we've already written a cargo disposal failure logbook entry in the last 5 minutes (300s) -->
        <set_value name="$lastCargoDisposalLogbookTime" exact="0"/>
        <do_if value="this.$lastCargoDisposalLogbookEntryTime?">
          <set_value name="$lastCargoDisposalLogbookTime" exact="this.$lastCargoDisposalLogbookEntryTime"/>
        </do_if>
        <set_value name="$timeSinceLastCargoDisposalLogbook" exact="player.age - $lastCargoDisposalLogbookTime"/>
        <do_if value="$timeSinceLastCargoDisposalLogbook ge 300s or $lastCargoDisposalLogbookTime == 0">
          <!-- Haven't written cargo disposal failure logbook recently (or never) - OK to write -->
          <set_value name="$shouldWriteCargoDisposalLogbook" exact="true"/>
        </do_if>
      </do_if>
      
      <!-- Normal trade search logbook entry -->
      <do_if value="not $isCargoDisposal and $waitTime == 60s and not $tradeFoundDuringWait">
        <!-- Check if we've already written a logbook entry in the last 5 minutes (300s) -->
        <set_value name="$lastLogbookTime" exact="0"/>
        <do_if value="this.$lastLogbookEntryTime?">
          <set_value name="$lastLogbookTime" exact="this.$lastLogbookEntryTime"/>
        </do_if>
        <set_value name="$timeSinceLastLogbook" exact="player.age - $lastLogbookTime"/>
        <do_if value="$timeSinceLastLogbook ge 300s or $lastLogbookTime == 0">
          <!-- Haven't written logbook recently (or never) - OK to write -->
          <set_value name="$shouldWriteLogbook" exact="true"/>
        </do_if>
      </do_if>
      
      <!-- CARGO DISPOSAL: Write separate failure message for cargo disposal -->
      <do_if value="$shouldWriteCargoDisposalLogbook">
        <!-- Check if logbook enabled -->
        <set_value name="$logEnabled" exact="false"/>
        <do_if value="@this.ship.defaultorder.id == 'GalaxyTraderMK3' and @this.ship.defaultorder.$logbookentries">
          <set_value name="$logEnabled" exact="true"/>
        </do_if>
        <!-- Subordinates inherit logbook setting from commander -->
        <do_elseif value="@this.ship.defaultorder.id == 'Assist' and @this.ship.commander.defaultorder.id == 'GalaxyTraderMK3' and @this.ship.commander.defaultorder.$logbookentries">
          <set_value name="$logEnabled" exact="true"/>
        </do_elseif>
        
        <do_if value="$logEnabled">
          <!-- Get cargo info for logbook message -->
          <set_value name="$cargoList" exact="this.ship.cargo.list"/>
          <set_value name="$cargoTypes" exact="[]"/>
          <do_all exact="$cargoList.count" counter="$i">
            <set_value name="$ware" exact="$cargoList.{$i}"/>
            <set_value name="$amount" exact="this.ship.cargo.{$ware}.count"/>
            <append_to_list name="$cargoTypes" exact="@$ware.name + ' x' + $amount"/>
          </do_all>
          <set_value name="$cargoDescription" exact="if $cargoTypes.count gt 0 then $cargoTypes.{1} + (if $cargoTypes.count gt 1 then ', ' + $cargoTypes.{2} else '') + (if $cargoTypes.count gt 2 then ', ...' else '') else 'Unknown'"/>
          
          <!-- Write cargo disposal failure logbook entry -->
          <set_value name="$logbookMessage" exact="'Commander,\n\nI have been unable to find a buyer for my cargo after multiple attempts. My cargo hold contains: ' + $cargoDescription + '\n\nI have tried ' + $failureCount + ' times but cannot locate a suitable buyer within my trading range. This may be due to:\n- No stations buying these wares nearby\n- All potential buyers are blacklisted\n- Docking restrictions at available stations\n\nI will continue waiting and retrying periodically. You may want to manually assign a sell order or adjust my trading parameters.\n\nStatus: Waiting for buyer opportunity\n\nWith patience,\nAboard ' + this.ship.knownname"/>
          
          <signal_objects object="player.galaxy" param="'GT_WriteLogbook'" param2="table[
            $Message = $logbookMessage,
            $Category = 'alerts',
            $Title = 'Cargo Disposal Failed: ' + this.ship.knownname,
            $Object = this.ship,
            $Interaction = 'showonmap',
            $CheckGlobalSettings = false
          ]"/>
          
          <!-- Update last cargo disposal logbook entry time -->
          <set_value name="this.$lastCargoDisposalLogbookEntryTime" exact="player.age"/>
        </do_if>
      </do_if>
      
      <do_if value="$shouldWriteLogbook">
        <!-- Check if logbook enabled -->
        <set_value name="$logEnabled" exact="false"/>
        <do_if value="@this.ship.defaultorder.id == 'GalaxyTraderMK3' and @this.ship.defaultorder.$logbookentries">
          <set_value name="$logEnabled" exact="true"/>
        </do_if>
        <!-- Subordinates inherit logbook setting from commander -->
        <do_elseif value="@this.ship.defaultorder.id == 'Assist' and @this.ship.commander.defaultorder.id == 'GalaxyTraderMK3' and @this.ship.commander.defaultorder.$logbookentries">
          <set_value name="$logEnabled" exact="true"/>
        </do_elseif>
        
        <do_if value="$logEnabled">
          <!-- Tables guaranteed valid by GT_InitializeGlobalTables -->
          <!-- Get last search rejection stats from global (set by MD script) - per-ship storage -->
          <set_value name="$lastRejectionStats" exact="@global.$GT_SearchResult.$LastRejectionStats.{this.ship}"/>
          <set_value name="$totalRejected" exact="0"/>
          <set_value name="$tradesRejectedDocking" exact="0"/>
          <set_value name="$tradesRejectedProfit" exact="0"/>
          <set_value name="$tradesRejectedAmount" exact="0"/>
          <set_value name="$tradesRejectedBlacklist" exact="0"/>
          <set_value name="$sectorName" exact="''"/>
          <set_value name="$maxDistance" exact="10"/>
          <set_value name="$minAbsoluteProfit" exact="100"/>
          
          <do_if value="$lastRejectionStats?">
            <!-- Log what we retrieved -->
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] ' + this.ship.idcode + ': RETRIEVED LastRejectionStats:' +
                '\n  Total exists: ' + (if $lastRejectionStats.$Total? then 'yes' else 'no') +
                '\n  Total value: ' + (if $lastRejectionStats.$Total? then $lastRejectionStats.$Total else 'null') +
                '\n  Docking exists: ' + (if $lastRejectionStats.$Docking? then 'yes' else 'no') +
                '\n  Docking value: ' + (if $lastRejectionStats.$Docking? then $lastRejectionStats.$Docking else 'null') +
                '\n  Profit exists: ' + (if $lastRejectionStats.$Profit? then 'yes' else 'no') +
                '\n  Profit value: ' + (if $lastRejectionStats.$Profit? then $lastRejectionStats.$Profit else 'null') +
                '\n  Amount exists: ' + (if $lastRejectionStats.$Amount? then 'yes' else 'no') +
                '\n  Amount value: ' + (if $lastRejectionStats.$Amount? then $lastRejectionStats.$Amount else 'null') +
                '\n  Blacklist exists: ' + (if $lastRejectionStats.$Blacklist? then 'yes' else 'no') +
                '\n  Blacklist value: ' + (if $lastRejectionStats.$Blacklist? then $lastRejectionStats.$Blacklist else 'null') +
                '\n  SectorName exists: ' + (if $lastRejectionStats.$SectorName? then 'yes' else 'no') +
                '\n  SectorName value: ' + (if $lastRejectionStats.$SectorName? then $lastRejectionStats.$SectorName else 'null') +
                '\n  MaxDistance exists: ' + (if $lastRejectionStats.$MaxDistance? then 'yes' else 'no') +
                '\n  MaxDistance value: ' + (if $lastRejectionStats.$MaxDistance? then $lastRejectionStats.$MaxDistance else 'null') +
                '\n  MinAbsoluteProfit exists: ' + (if $lastRejectionStats.$MinAbsoluteProfit? then 'yes' else 'no') +
                '\n  MinAbsoluteProfit value: ' + (if $lastRejectionStats.$MinAbsoluteProfit? then $lastRejectionStats.$MinAbsoluteProfit else 'null')" 
                chance="100"/>
            </do_if>
            
            <!-- Extract values and default to 0 if null (memory:10529400 - ? checks existence, not null) -->
            <set_value name="$tradesRejectedDockingTemp" exact="@$lastRejectionStats.$Docking"/>
            <set_value name="$tradesRejectedDocking" exact="if $tradesRejectedDockingTemp? and $tradesRejectedDockingTemp != null then $tradesRejectedDockingTemp else 0"/>
            
            <set_value name="$tradesRejectedProfitTemp" exact="@$lastRejectionStats.$Profit"/>
            <set_value name="$tradesRejectedProfit" exact="if $tradesRejectedProfitTemp? and $tradesRejectedProfitTemp != null then $tradesRejectedProfitTemp else 0"/>
            
            <set_value name="$tradesRejectedAmountTemp" exact="@$lastRejectionStats.$Amount"/>
            <set_value name="$tradesRejectedAmount" exact="if $tradesRejectedAmountTemp? and $tradesRejectedAmountTemp != null then $tradesRejectedAmountTemp else 0"/>
            
            <set_value name="$tradesRejectedBlacklistTemp" exact="@$lastRejectionStats.$Blacklist"/>
            <set_value name="$tradesRejectedBlacklist" exact="if $tradesRejectedBlacklistTemp? and $tradesRejectedBlacklistTemp != null then $tradesRejectedBlacklistTemp else 0"/>
            
            <!-- Calculate totalRejected as sum of all rejection types -->
            <!-- This ensures consistency: totalRejected >= sum of individual rejection types -->
            <!-- Use LastRejectionStats.$Total as base, but ensure it's at least the sum of all rejection types -->
            <set_value name="$totalRejectedTemp" exact="@$lastRejectionStats.$Total"/>
            <set_value name="$totalRejectedFromStats" exact="if $totalRejectedTemp? and $totalRejectedTemp != null then $totalRejectedTemp else 0"/>
            
            <!-- Calculate sum of all rejection types -->
            <set_value name="$sumOfRejections" exact="$tradesRejectedDocking + $tradesRejectedProfit + $tradesRejectedAmount + $tradesRejectedBlacklist"/>
            
            <!-- Use the maximum of stored total and sum of rejections to ensure consistency -->
            <set_value name="$totalRejected" exact="if $totalRejectedFromStats gt $sumOfRejections then $totalRejectedFromStats else $sumOfRejections"/>
            
            <set_value name="$sectorNameTemp" exact="@$lastRejectionStats.$SectorName"/>
            <do_if value="$sectorNameTemp? and $sectorNameTemp != null and $sectorNameTemp != ''">
              <set_value name="$sectorName" exact="$sectorNameTemp"/>
            </do_if>
            <do_else>
              <!-- Fallback: Get current sector name directly from ship -->
              <set_value name="$sectorName" exact="@this.ship.sector.knownname"/>
            </do_else>
            
            <set_value name="$maxDistanceTemp" exact="@$lastRejectionStats.$MaxDistance"/>
            <do_if value="$maxDistanceTemp? and $maxDistanceTemp != null">
              <set_value name="$maxDistance" exact="$maxDistanceTemp"/>
            </do_if>
            <do_else>
              <set_value name="$maxDistance" exact="10"/>
            </do_else>
            
            <set_value name="$minAbsoluteProfitTemp" exact="@$lastRejectionStats.$MinAbsoluteProfit"/>
            <do_if value="$minAbsoluteProfitTemp? and $minAbsoluteProfitTemp != null">
              <set_value name="$minAbsoluteProfit" exact="$minAbsoluteProfitTemp"/>
            </do_if>
            <do_else>
              <set_value name="$minAbsoluteProfit" exact="100"/>
            </do_else>
          </do_if>
          <do_else>
            <!-- No rejection stats available - use defaults and get current sector as fallback -->
            <set_value name="$sectorName" exact="@this.ship.sector.knownname"/>
            <set_value name="$maxDistance" exact="10"/>
            <set_value name="$minAbsoluteProfit" exact="100"/>
          </do_else>
          
          <!-- Final safety check: Ensure sector name is not null -->
          <do_if value="not $sectorName? or $sectorName == null or $sectorName == ''">
            <set_value name="$sectorName" exact="@this.ship.sector.knownname"/>
            <do_if value="not $sectorName? or $sectorName == null or $sectorName == ''">
              <set_value name="$sectorName" exact="'Unknown Sector'"/>
            </do_if>
          </do_if>
          
          <!-- Log the logbook message data before generating -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': LOGBOOK MESSAGE DATA (No Trades Found):' +
              '\n  SectorName: ' + (if $sectorName? and $sectorName != null then $sectorName else 'null') +
              '\n  MaxDistance: ' + $maxDistance +
              '\n  MinAbsoluteProfit: ' + ($minAbsoluteProfit/100) + ' Cr' +
              '\n  TotalRejected: ' + $totalRejected +
              '\n  RejectedDocking: ' + $tradesRejectedDocking +
              '\n  RejectedProfit: ' + $tradesRejectedProfit +
              '\n  RejectedAmount: ' + $tradesRejectedAmount +
              '\n  RejectedBlacklist: ' + $tradesRejectedBlacklist +
              '\n  LastRejectionStats exists: ' + (if $lastRejectionStats? then 'yes' else 'no')" 
              chance="100"/>
          </do_if>
          
          <set_value name="$message" exact="{77000,3208}.[$sectorName,$maxDistance,($minAbsoluteProfit/100),$totalRejected,$tradesRejectedDocking,$tradesRejectedProfit,$tradesRejectedAmount,$tradesRejectedBlacklist]"/>
          
          <!-- Log the generated message -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': GENERATED LOGBOOK MESSAGE:' +
              '\n' + $message" 
              chance="100"/>
          </do_if>
          
          <!-- Construct logbook message using TextDB syntax (vanilla pattern) -->
          <set_value name="$logbookMessage" exact="{77000,3208}.[$sectorName,$maxDistance,($minAbsoluteProfit/100),$totalRejected,$tradesRejectedDocking,$tradesRejectedProfit,$tradesRejectedAmount,$tradesRejectedBlacklist]"/>
          
          <signal_objects object="player.galaxy" param="'GT_WriteLogbook'" param2="table[
            $Message = $logbookMessage,
            $Category = 'upkeep',
            $Title = 'No Trades Available: ' + this.ship.knownname,
            $Object = this.ship,
            $Interaction = 'showonmap',
            $CheckGlobalSettings = false
          ]"/>
          
          <!-- Log that logbook entry was created -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': No trades available logbook entry created'" chance="100"/>
          </do_if>
          
          <!-- Mark that we've written a logbook entry now -->
          <set_value name="this.$lastLogbookEntryTime" exact="player.age"/>
        </do_if>
      </do_if>
      
      <!-- Reset command state and resume search -->
      <set_command command="command.searchtrades"/>
      <set_command_action commandaction="commandaction.searchingtrades"/>
      
      <!-- Resume main trading loop -->
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Resuming main_loop label'" chance="100"/>
      </do_if>
      <resume label="main_loop"/>
      
      <!-- ========================================= -->
      <!-- AUTO-REPAIR HANDLING                     -->
      <!-- ========================================= -->
      <label name="start_repair"/>
      
      <!-- Retrieve repair destination from global data -->
      <set_value name="$repairStation" exact="global.$GT_AutoRepair.{this.ship}.$Station"/>
      
      <do_if value="$repairStation and $repairStation.exists">
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Hull at ' + this.ship.hullpercentage + '% - going for repairs at ' + $repairStation.knownname" chance="100"/>
        </do_if>
        
        <!-- Set repair command state -->
        <set_command command="command.repair"/>
        <set_command_action commandaction="commandaction.calculating"/>
        
        <!-- Create repair order -->
        <create_order object="this.ship" id="'Repair'" immediate="true">
          <param name="destination" value="$repairStation"/>
          <param name="repairall" value="true"/>
        </create_order>
        
        <!-- Wait for repair completion -->
        <set_value name="$repairComplete" exact="false"/>
        <wait max="3600s">
          <interrupt>
            <conditions>
              <event_object_signalled object="this.ship" param="'GT_RepairCompleted'"/>
            </conditions>
            <actions>
              <set_value name="$repairComplete" exact="true"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Repairs completed (hull now at ' + this.ship.hullpercentage + '%) - resuming trading'" chance="100"/>
              </do_if>
            </actions>
          </interrupt>
        </wait>
        
        <!-- Check if we timed out -->
        <do_if value="not $repairComplete">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Repair timeout after 1 hour - resuming trading anyway'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- Clean up repair tracking -->
        <do_if value="global.$GT_AutoRepair.{this.ship}?">
          <remove_value name="global.$GT_AutoRepair.{this.ship}"/>
        </do_if>
        
        <!-- Reset search failure counter since we're starting fresh -->
        <set_value name="this.$searchFailed" exact="0"/>
      </do_if>
      <do_else>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Repair station not found or no longer exists - resuming trading'" chance="100"/>
        </do_if>
      </do_else>
      
      <!-- Resume normal trading loop -->
      <resume label="main_loop"/>
      
      <!-- ========================================================================= -->
      <!-- CARGO SAFETY HANDLERS (In-Parallel Monitoring)                           -->
      <!-- These run in parallel with main trading loop via interrupt-based waits   -->
      <!-- ========================================================================= -->
      
      <!-- ========================================================================= -->
      <!-- DEAD CODE REMOVED: Emergency/Alternative Cargo & Threat Handlers         -->
      <!-- These complex systems were replaced with simple inline cargo check        -->
      <!-- Current implementation: Cargo check at line ~844 sends GT_Find_Sell      -->
      <!-- Threat handler now in interrupt section at lines ~917-941                -->
      <!-- ========================================================================= -->
      
    </actions>
  </attention>
  
  <on_abort>
    <!-- Enhanced cleanup when order is aborted/replaced -->
    <!-- Preserve pilot XP data when order is manually replaced by player -->
    <!-- Only completely wipe data in genuine cleanup scenarios (ship destroyed, pilot changed, etc.) -->
    <set_value name="$isActivelyTrading" exact="false"/>
    <set_value name="$isTrainingTransition" exact="false"/>
    
    <!-- Clean up resupply tracking if order aborted mid-resupply -->
    <!-- IMPORTANT: Do NOT clear during maintenance transitions (subordinates can be aborted/replaced while resupply order is active) -->
    <do_if value="not this.$maintenance_transition? and global.$GT_ResupplyOrders? and global.$GT_ResupplyOrders.{this.ship}?">
      <remove_value name="global.$GT_ResupplyOrders.{this.ship}"/>
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Cleaned up resupply tracking on order abort'" chance="100"/>
      </do_if>
    </do_if>
    
    <!-- Check if ship has active TradePerform orders -->
    <do_if value="this.ship.orders.count gt 1">
      <do_all exact="this.ship.orders.count" counter="$i">
        <do_if value="this.ship.orders.{$i}.id == 'TradePerform'">
          <set_value name="$isActivelyTrading" exact="true"/>
          <break/>
        </do_if>
      </do_all>
    </do_if>
    
    <!-- Check if a training order was recently created (within last 5 seconds) -->
    <do_if value="this.$training_order_created? and (player.age - this.$training_order_created) lt 5s">
      <set_value name="$isTrainingTransition" exact="true"/>
    </do_if>
    
    <!-- Also check the flag-based detection -->
    <do_if value="this.$training_transition?">
      <set_value name="$isTrainingTransition" exact="true"/>
    </do_if>
    
    <!-- Check if a maintenance order was recently created (repair/resupply) -->
    <set_value name="$isMaintenanceTransition" exact="false"/>
    <do_if value="this.$maintenance_transition?">
      <set_value name="$isMaintenanceTransition" exact="true"/>
    </do_if>
    
    <!-- Ship state and orders at removal detection -->
    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
      <set_value name="$debugShip" exact="this.ship"/>
      <set_value name="$debugDefaultOrder" exact="@$debugShip.defaultorder.id"/>
      <set_value name="$debugCommander" exact="@$debugShip.commander"/>
      <set_value name="$debugCommanderId" exact="if @$debugCommander.exists then @$debugCommander.idcode else 'NONE'"/>
      <set_value name="$debugCommanderOrder" exact="if @$debugCommander.exists and @$debugCommander.defaultorder != null then @$debugCommander.defaultorder.id else 'NONE'"/>
      <set_value name="$debugPilot" exact="@$debugShip.pilot"/>
      <set_value name="$debugPilotName" exact="if $debugPilot != null then @$debugPilot.knownname else 'NONE'"/>
      
      <!-- Build orders list -->
      <set_value name="$debugOrdersList" exact="[]"/>
      <set_value name="$debugOrdersCount" exact="$debugShip.orders.count"/>
      <do_all exact="$debugOrdersCount" counter="$i">
        <set_value name="$orderId" exact="@$debugShip.orders.{$i}.id"/>
        <append_to_list name="$debugOrdersList" exact="if $orderId then $orderId else 'UNKNOWN'"/>
      </do_all>
      <set_value name="$debugOrdersStr" exact="if $debugOrdersList.count gt 0 then $debugOrdersList.{1} + (if $debugOrdersList.count gt 1 then ', ' + $debugOrdersList.{2} else '') + (if $debugOrdersList.count gt 2 then ', ' + $debugOrdersList.{3} else '') + (if $debugOrdersList.count gt 3 then ', ' + $debugOrdersList.{4} else '') + (if $debugOrdersList.count gt 4 then ', ...' else '') else 'NONE'"/>
      
      <!-- Check GT order status -->
      <set_value name="$debugHasDirectGT" exact="false"/>
      <do_if value="$debugDefaultOrder == 'GalaxyTraderMK3'">
        <set_value name="$debugHasDirectGT" exact="true"/>
      </do_if>
      <set_value name="$debugHasGTCommander" exact="false"/>
      <do_if value="@$debugCommander.exists and $debugCommanderOrder == 'GalaxyTraderMK3'">
        <set_value name="$debugHasGTCommander" exact="true"/>
      </do_if>
      
      <!-- Check if in GT_Ships registry -->
      <set_value name="$debugInRegistry" exact="global.$GT_Ships? and global.$GT_Ships.{$debugShip}?"/>
      
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-AI] REMOVAL DETECTION DEBUG: ' + $debugShip.idcode + ' - COMPREHENSIVE STATE'" chance="100"/>
        <debug_text text="'[GT-AI]   Ship: ' + $debugShip.idcode + ' (' + (if $debugShip.knownname then $debugShip.knownname else 'UNNAMED') + ')'" chance="100"/>
        <debug_text text="'[GT-AI]   Pilot: ' + $debugPilotName + (if $debugPilot != null then ' (exists)' else ' (NONE)')" chance="100"/>
        <debug_text text="'[GT-AI]   Default Order: ' + (if $debugDefaultOrder then $debugDefaultOrder else 'NONE')" chance="100"/>
        <debug_text text="'[GT-AI]   Active Orders (' + $debugOrdersCount + '): ' + $debugOrdersStr" chance="100"/>
        <debug_text text="'[GT-AI]   Commander: ' + $debugCommanderId + ' (Order: ' + $debugCommanderOrder + ')'" chance="100"/>
        <debug_text text="'[GT-AI]   GT Status: Direct=' + $debugHasDirectGT + ', ViaCommander=' + $debugHasGTCommander + ', InRegistry=' + $debugInRegistry" chance="100"/>
        <debug_text text="'[GT-AI]   Flags: ActivelyTrading=' + $isActivelyTrading + ', TrainingTransition=' + $isTrainingTransition + ', MaintenanceTransition=' + $isMaintenanceTransition" chance="100"/>
      </do_if>
    </do_if>
    
    <!-- Order cancellation detection -->
    <!-- Only send signal if GT default order is actually cancelled -->
    <!-- on_abort can fire when trade orders are cancelled, but GT order might still be active -->
    <!-- Unified GT order status check (inline for AI scripts) -->
    <set_value name="$currentDefaultOrder" exact="@this.ship.defaultorder.id"/>
    <set_value name="$hasDirectGTOrder" exact="false"/>
    <set_value name="$hasGTCommander" exact="false"/>
    <set_value name="$isGTControlled" exact="false"/>
    
    <!-- Check direct GT order -->
    <do_if value="$currentDefaultOrder == 'GalaxyTraderMK3'">
      <set_value name="$hasDirectGTOrder" exact="true"/>
      <set_value name="$isGTControlled" exact="true"/>
    </do_if>
    
    <!-- Check commander status -->
    <do_if value="not $hasDirectGTOrder and this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
      <do_if value="this.ship.commander.defaultorder? and @this.ship.commander.defaultorder.id == 'GalaxyTraderMK3'">
        <set_value name="$hasGTCommander" exact="true"/>
        <do_if value="$currentDefaultOrder == 'Assist'">
          <set_value name="$isGTControlled" exact="true"/>
        </do_if>
      </do_if>
    </do_if>
    
    <set_value name="$isGTOrderCancelled" exact="false"/>
    
    <!-- If GT order is gone, process cleanup REGARDLESS of training/maintenance transitions -->
    <!-- Only skip Phase 7 if GT order is STILL ACTIVE AND there's a training/maintenance transition -->
    <do_if value="not $isGTControlled">
      <!-- GT order is gone - process cleanup even if training/maintenance/disposal orders exist -->
      <!-- Check if GT default order is still active -->
      <!-- If defaultorder.id is null, different, or not GalaxyTraderMK3, GT order was cancelled -->
      <do_if value="not $currentDefaultOrder">
        <!-- No default order â†’ GT order was cancelled -->
        <set_value name="$isGTOrderCancelled" exact="true"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] PHASE 7: GT order cancelled for ' + this.ship.idcode + ' (detected in on_abort, default order: NONE)'" chance="100"/>
        </do_if>
        <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
          $Ship = this.ship,
          $UpdateType = 'GT_Order_Cancelled'
        ]"/>
        
        <!-- EVENT-DRIVEN: Trigger orphaned ship check -->
        <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.ship}?">
          <signal_objects object="player.galaxy" param="'GT_Check_Ship_Orphaned'" param2="table[$Ship = this.ship]"/>
        </do_if>
        
        <!-- Restore ship name if not GT-controlled (direct or subordinate) -->
        <!-- Check if ship WAS a subordinate BEFORE GT order was cancelled -->
        <!-- Use this.$was_subordinate flag or check state manager state -->
        <set_value name="$wasSubordinateBeforeCancellation" exact="false"/>
        <do_if value="this.$was_subordinate?">
          <set_value name="$wasSubordinateBeforeCancellation" exact="true"/>
        </do_if>
        <do_elseif value="global.$GT_Ship_State? and global.$GT_Ship_State.{this.ship}?">
          <!-- Check state manager to see if ship was a subordinate -->
          <set_value name="$state" exact="global.$GT_Ship_State.{this.ship}"/>
          <do_if value="$state.$SubordinateState? and $state.$SubordinateState == 'subordinate'">
            <set_value name="$wasSubordinateBeforeCancellation" exact="true"/>
          </do_if>
        </do_elseif>
        
        <!-- Check if ship is CURRENTLY subordinate to GT commander -->
        <set_value name="$isSubordinateOfGTCommander" exact="false"/>
        <do_if value="this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
          <do_if value="this.ship.commander.defaultorder? and @this.ship.commander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$isSubordinateOfGTCommander" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Restore name if:
             1. Ship was NOT a subordinate before cancellation, OR
             2. Ship was a subordinate but is NO LONGER subordinate to GT commander -->
        <set_value name="$shouldRestoreName" exact="false"/>
        <do_if value="not $wasSubordinateBeforeCancellation">
          <!-- Ship was not a subordinate - restore name if not currently subordinate to GT commander -->
          <do_if value="not $isSubordinateOfGTCommander">
            <set_value name="$shouldRestoreName" exact="true"/>
          </do_if>
        </do_if>
        <do_elseif value="$wasSubordinateBeforeCancellation and not $isSubordinateOfGTCommander">
          <!-- Ship WAS a subordinate but is NO LONGER subordinate to GT commander - restore name -->
          <set_value name="$shouldRestoreName" exact="true"/>
        </do_elseif>
        
        <do_if value="$shouldRestoreName and this.ship.pilot?">
          <set_value name="$originalName" exact="null"/>
          <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName?">
            <set_value name="$originalName" exact="global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName"/>
          </do_if>
          
          <do_if value="$originalName">
            <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
              $Ship = this.ship,
              $Pilot = this.ship.pilot,
              $Reason = 'GT order cancelled - restoring original name',
              $OriginalName = $originalName
            ]"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] PHASE 7: Name restoration signal sent for ' + this.ship.idcode + ' (was subordinate: ' + $wasSubordinateBeforeCancellation + ', currently subordinate: ' + $isSubordinateOfGTCommander + ', original name: ' + $originalName + ')'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
      </do_if>
      <do_elseif value="$currentDefaultOrder != 'GalaxyTraderMK3'">
        <!-- Different default order â†’ Check if GT order was actually cancelled -->
        <!-- For subordinates with Assist order, trade order termination is NORMAL -->
        <!-- Only emit cleanup if ship NO LONGER has GT order (direct or via commander) -->
        <set_value name="$actualDefaultOrder" exact="@this.ship.defaultorder.id"/>
        
        <!-- Check if ship has direct GT order -->
        <set_value name="$hasDirectGTOrder" exact="false"/>
        <do_if value="$actualDefaultOrder == 'GalaxyTraderMK3'">
          <set_value name="$hasDirectGTOrder" exact="true"/>
        </do_if>
        
        <!-- Check if ship is subordinate to GT commander (current commander, not old) -->
        <set_value name="$hasGTCommander" exact="false"/>
        <do_if value="not $hasDirectGTOrder and this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
          <do_if value="this.ship.commander.defaultorder? and @this.ship.commander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$hasGTCommander" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Only emit cleanup if ship NO LONGER has GT order (direct or via commander) -->
        <!-- For subordinates, Assist order termination is handled by Assist order's on_abort -->
        <!-- Trade order termination is NORMAL and should NOT trigger cleanup -->
        <set_value name="$shouldEmitCleanup" exact="false"/>
        <do_if value="not $hasDirectGTOrder and not $hasGTCommander">
          <!-- No direct GT order and no GT commander = GT order truly gone -->
          <set_value name="$shouldEmitCleanup" exact="true"/>
        </do_if>
        
        <!-- Emit cleanup signal if GT order is gone -->
        <do_if value="$shouldEmitCleanup">
          <set_value name="$isGTOrderCancelled" exact="true"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] PHASE 7: GT order cancelled for ' + this.ship.idcode + ' (detected in on_abort, default order: ' + $currentDefaultOrder + ', has direct GT: ' + $hasDirectGTOrder + ', has GT commander: ' + $hasGTCommander + ')'" chance="100"/>
          </do_if>
          <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
            $Ship = this.ship,
            $UpdateType = 'GT_Order_Cancelled'
          ]"/>
        </do_if>
        <do_else>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI]  PHASE 7: Trade order aborted but GT order still active for ' + this.ship.idcode + ' (default order: ' + $currentDefaultOrder + ', has direct GT: ' + $hasDirectGTOrder + ', has GT commander: ' + $hasGTCommander + ') - NOT sending GT_Order_Cancelled'" chance="100"/>
          </do_if>
        </do_else>
        
        <!-- Restore ship name if not GT-controlled (direct or subordinate) -->
        <!-- Check if ship WAS a subordinate BEFORE GT order was cancelled -->
        <!-- Use this.$was_subordinate flag or check state manager state -->
        <set_value name="$wasSubordinateBeforeCancellation" exact="false"/>
        <do_if value="this.$was_subordinate?">
          <set_value name="$wasSubordinateBeforeCancellation" exact="true"/>
        </do_if>
        <do_elseif value="global.$GT_Ship_State? and global.$GT_Ship_State.{this.ship}?">
          <!-- Check state manager to see if ship was a subordinate -->
          <set_value name="$state" exact="global.$GT_Ship_State.{this.ship}"/>
          <do_if value="$state.$SubordinateState? and $state.$SubordinateState == 'subordinate'">
            <set_value name="$wasSubordinateBeforeCancellation" exact="true"/>
          </do_if>
        </do_elseif>
        
        <!-- Check if ship is CURRENTLY subordinate to GT commander -->
        <set_value name="$isSubordinateOfGTCommander" exact="false"/>
        <do_if value="this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
          <do_if value="this.ship.commander.defaultorder? and @this.ship.commander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$isSubordinateOfGTCommander" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Restore name if:
             1. Ship was NOT a subordinate before cancellation, OR
             2. Ship was a subordinate but is NO LONGER subordinate to GT commander -->
        <set_value name="$shouldRestoreName" exact="false"/>
        <do_if value="not $wasSubordinateBeforeCancellation">
          <!-- Ship was not a subordinate - restore name if not currently subordinate to GT commander -->
          <do_if value="not $isSubordinateOfGTCommander">
            <set_value name="$shouldRestoreName" exact="true"/>
          </do_if>
        </do_if>
        <do_elseif value="$wasSubordinateBeforeCancellation and not $isSubordinateOfGTCommander">
          <!-- Ship WAS a subordinate but is NO LONGER subordinate to GT commander - restore name -->
          <set_value name="$shouldRestoreName" exact="true"/>
        </do_elseif>
        
        <do_if value="$shouldRestoreName and this.ship.pilot?">
          <set_value name="$originalName" exact="null"/>
          <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName?">
            <set_value name="$originalName" exact="global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName"/>
          </do_if>
          
          <do_if value="$originalName">
            <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
              $Ship = this.ship,
              $Pilot = this.ship.pilot,
              $Reason = 'GT order cancelled - restoring original name',
              $OriginalName = $originalName
            ]"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] PHASE 7: Name restoration signal sent for ' + this.ship.idcode + ' (was subordinate: ' + $wasSubordinateBeforeCancellation + ', currently subordinate: ' + $isSubordinateOfGTCommander + ', original name: ' + $originalName + ')'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
      </do_elseif>
    </do_if>
    <do_elseif value="$hasDirectGTOrder or $hasGTCommander">
      <!-- GT order still active - only skip Phase 7 if there's a training/maintenance transition -->
      <!-- This prevents cleanup when GT order creates training/maintenance orders (normal behavior) -->
      <do_if value="not $isTrainingTransition and not $isMaintenanceTransition">
        <!-- GT order active, no transitions - check if default order changed -->
        <!-- (This is the original Phase 7 logic for when GT order is still active) -->
        <!-- Check if GT default order is still active -->
        <!-- If defaultorder.id is null, different, or not GalaxyTraderMK3, GT order was cancelled -->
        <do_if value="not $currentDefaultOrder">
          <!-- No default order â†’ GT order was cancelled -->
          <set_value name="$isGTOrderCancelled" exact="true"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] PHASE 7: GT order cancelled for ' + this.ship.idcode + ' (detected in on_abort, default order: NONE)'" chance="100"/>
          </do_if>
          <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
            $Ship = this.ship,
            $UpdateType = 'GT_Order_Cancelled'
          ]"/>
          
          <!-- Restore ship name if not GT-controlled (direct or subordinate) -->
          <!-- Check if ship WAS a subordinate BEFORE GT order was cancelled -->
          <!-- Use this.$was_subordinate flag or check state manager state -->
          <set_value name="$wasSubordinateBeforeCancellation" exact="false"/>
          <do_if value="this.$was_subordinate?">
            <set_value name="$wasSubordinateBeforeCancellation" exact="true"/>
          </do_if>
          <do_elseif value="global.$GT_Ship_State? and global.$GT_Ship_State.{this.ship}?">
            <!-- Check state manager to see if ship was a subordinate -->
            <set_value name="$state" exact="global.$GT_Ship_State.{this.ship}"/>
            <do_if value="$state.$SubordinateState? and $state.$SubordinateState == 'subordinate'">
              <set_value name="$wasSubordinateBeforeCancellation" exact="true"/>
            </do_if>
          </do_elseif>
          
          <!-- Check if ship is CURRENTLY subordinate to GT commander -->
          <set_value name="$isSubordinateOfGTCommander" exact="false"/>
          <do_if value="this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
            <do_if value="this.ship.commander.defaultorder? and @this.ship.commander.defaultorder.id == 'GalaxyTraderMK3'">
              <set_value name="$isSubordinateOfGTCommander" exact="true"/>
            </do_if>
          </do_if>
          
          <!-- Restore name if:
               1. Ship was NOT a subordinate before cancellation, OR
               2. Ship was a subordinate but is NO LONGER subordinate to GT commander -->
          <set_value name="$shouldRestoreName" exact="false"/>
          <do_if value="not $wasSubordinateBeforeCancellation">
            <!-- Ship was not a subordinate - restore name if not currently subordinate to GT commander -->
            <do_if value="not $isSubordinateOfGTCommander">
              <set_value name="$shouldRestoreName" exact="true"/>
            </do_if>
          </do_if>
          <do_elseif value="$wasSubordinateBeforeCancellation and not $isSubordinateOfGTCommander">
            <!-- Ship WAS a subordinate but is NO LONGER subordinate to GT commander - restore name -->
            <set_value name="$shouldRestoreName" exact="true"/>
          </do_elseif>
          
          <do_if value="$shouldRestoreName and this.ship.pilot?">
            <set_value name="$originalName" exact="null"/>
            <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName?">
              <set_value name="$originalName" exact="global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName"/>
            </do_if>
            
            <do_if value="$originalName">
              <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
                $Ship = this.ship,
                $Pilot = this.ship.pilot,
                $Reason = 'GT order cancelled - restoring original name',
                $OriginalName = $originalName
              ]"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] PHASE 7: Name restoration signal sent for ' + this.ship.idcode + ' (was subordinate: ' + $wasSubordinateBeforeCancellation + ', currently subordinate: ' + $isSubordinateOfGTCommander + ', original name: ' + $originalName + ')'" chance="100"/>
              </do_if>
            </do_if>
          </do_if>
        </do_if>
        <do_elseif value="$currentDefaultOrder != 'GalaxyTraderMK3'">
          <!-- Different default order â†’ Check if GT order was actually cancelled -->
          <!-- For subordinates with Assist order, trade order termination is NORMAL -->
          <!-- Only emit cleanup if ship NO LONGER has GT order (direct or via commander) -->
          <set_value name="$actualDefaultOrder" exact="@this.ship.defaultorder.id"/>
          
          <!-- Check if ship has direct GT order -->
          <set_value name="$hasDirectGTOrder" exact="false"/>
          <do_if value="$actualDefaultOrder == 'GalaxyTraderMK3'">
            <set_value name="$hasDirectGTOrder" exact="true"/>
          </do_if>
          
          <!-- Check if ship is subordinate to GT commander (current commander, not old) -->
          <set_value name="$hasGTCommander" exact="false"/>
          <do_if value="not $hasDirectGTOrder and this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
            <do_if value="this.ship.commander.defaultorder? and @this.ship.commander.defaultorder.id == 'GalaxyTraderMK3'">
              <set_value name="$hasGTCommander" exact="true"/>
            </do_if>
          </do_if>
          
          <!-- Only emit cleanup if ship NO LONGER has GT order (direct or via commander) -->
          <!-- For subordinates, Assist order termination is handled by Assist order's on_abort -->
          <!-- Trade order termination is NORMAL and should NOT trigger cleanup -->
          <set_value name="$shouldEmitCleanup" exact="false"/>
          <do_if value="not $hasDirectGTOrder and not $hasGTCommander">
            <!-- No direct GT order and no GT commander = GT order truly gone -->
            <set_value name="$shouldEmitCleanup" exact="true"/>
          </do_if>
          
          <!-- Emit cleanup signal if GT order is gone -->
          <do_if value="$shouldEmitCleanup">
            <set_value name="$isGTOrderCancelled" exact="true"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI] PHASE 7: GT order cancelled for ' + this.ship.idcode + ' (detected in on_abort, default order: ' + $currentDefaultOrder + ', has direct GT: ' + $hasDirectGTOrder + ', has GT commander: ' + $hasGTCommander + ')'" chance="100"/>
            </do_if>
            <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
              $Ship = this.ship,
              $UpdateType = 'GT_Order_Cancelled'
            ]"/>
          </do_if>
          <do_else>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-AI]  PHASE 7: Trade order aborted but GT order still active for ' + this.ship.idcode + ' (default order: ' + $currentDefaultOrder + ', has direct GT: ' + $hasDirectGTOrder + ', has GT commander: ' + $hasGTCommander + ') - NOT sending GT_Order_Cancelled'" chance="100"/>
            </do_if>
          </do_else>
          
          <!-- Restore ship name if not GT-controlled (direct or subordinate) -->
          <!-- Check if ship WAS a subordinate BEFORE GT order was cancelled -->
          <!-- Use this.$was_subordinate flag or check state manager state -->
          <set_value name="$wasSubordinateBeforeCancellation" exact="false"/>
          <do_if value="this.$was_subordinate?">
            <set_value name="$wasSubordinateBeforeCancellation" exact="true"/>
          </do_if>
          <do_elseif value="global.$GT_Ship_State? and global.$GT_Ship_State.{this.ship}?">
            <!-- Check state manager to see if ship was a subordinate -->
            <set_value name="$state" exact="global.$GT_Ship_State.{this.ship}"/>
            <do_if value="$state.$SubordinateState? and $state.$SubordinateState == 'subordinate'">
              <set_value name="$wasSubordinateBeforeCancellation" exact="true"/>
            </do_if>
          </do_elseif>
          
          <!-- Check if ship is CURRENTLY subordinate to GT commander -->
          <set_value name="$isSubordinateOfGTCommander" exact="false"/>
          <do_if value="this.ship.commander? and this.ship.commander.exists and this.ship.commander != this.ship">
            <do_if value="this.ship.commander.defaultorder? and @this.ship.commander.defaultorder.id == 'GalaxyTraderMK3'">
              <set_value name="$isSubordinateOfGTCommander" exact="true"/>
            </do_if>
          </do_if>
          
          <!-- Restore name if:
               1. Ship was NOT a subordinate before cancellation, OR
               2. Ship was a subordinate but is NO LONGER subordinate to GT commander -->
          <set_value name="$shouldRestoreName" exact="false"/>
          <do_if value="not $wasSubordinateBeforeCancellation">
            <!-- Ship was not a subordinate - restore name if not currently subordinate to GT commander -->
            <do_if value="not $isSubordinateOfGTCommander">
              <set_value name="$shouldRestoreName" exact="true"/>
            </do_if>
          </do_if>
          <do_elseif value="$wasSubordinateBeforeCancellation and not $isSubordinateOfGTCommander">
            <!-- Ship WAS a subordinate but is NO LONGER subordinate to GT commander - restore name -->
            <set_value name="$shouldRestoreName" exact="true"/>
          </do_elseif>
          
          <do_if value="$shouldRestoreName and this.ship.pilot?">
            <set_value name="$originalName" exact="null"/>
            <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName?">
              <set_value name="$originalName" exact="global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName"/>
            </do_if>
            
            <do_if value="$originalName">
              <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
                $Ship = this.ship,
                $Pilot = this.ship.pilot,
                $Reason = 'GT order cancelled - restoring original name',
                $OriginalName = $originalName
              ]"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-AI] PHASE 7: Name restoration signal sent for ' + this.ship.idcode + ' (was subordinate: ' + $wasSubordinateBeforeCancellation + ', currently subordinate: ' + $isSubordinateOfGTCommander + ', original name: ' + $originalName + ')'" chance="100"/>
              </do_if>
            </do_if>
          </do_if>
        </do_elseif>
        <do_else>
          <!-- GT order still active - this is just trade order cancellation, not GT order cancellation -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-AI] ' + this.ship.idcode + ': on_abort fired but GT order still active (default order: ' + $currentDefaultOrder + ') - skipping Phase 7 (trade order cancellation, not GT order cancellation)'" chance="100"/>
          </do_if>
        </do_else>
      </do_if>
      <do_else>
        <!-- GT order still active AND training/maintenance transition - skip Phase 7 (normal behavior) -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': GT order still active with training/maintenance transition - skipping Phase 7 (normal transition, not removal)'" chance="100"/>
        </do_if>
      </do_else>
    </do_elseif>
    
    <!-- Check if subordinate cleanup already sent signal (to avoid duplicate) -->
    <do_if value="this.$subordinate_cleanup_sent?">
      <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Subordinate cleanup signal already sent - skipping duplicate'" chance="100"/>
    </do_if>
    <do_else>
      <!-- Check for permanent removal FIRST, regardless of trading state -->
      <!-- When player stops order, we MUST restore name even if TradePerform orders are still active -->
      <!-- Unified GT order status check (inline for AI scripts) -->
      <!-- If GT order is gone (no direct, no commander), it's permanent removal REGARDLESS of trading state -->
      <set_value name="$isPermanentRemoval" exact="not $hasDirectGTOrder and not $hasGTCommander"/>
      
      <do_if value="$isPermanentRemoval">
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <set_value name="$debugOrdersCount" exact="this.ship.orders.count"/>
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': GT order removed (no direct GT, no GT commander) â†’ PERMANENT REMOVAL (actively trading: ' + $isActivelyTrading + ', orders count: ' + $debugOrdersCount + ')'" chance="100"/>
        </do_if>
      </do_if>
      <do_else>
        <!-- GT order still active - check other conditions -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': GT order still active (direct: ' + $hasDirectGTOrder + ', commander: ' + $hasGTCommander + ') - checking other removal conditions'" chance="100"/>
        </do_if>
        
        <!-- Additional checks: no default order, different order, or not registered -->
        <do_if value="not $currentDefaultOrder">
          <!-- No default order at all â†’ PERMANENT REMOVAL -->
          <set_value name="$isPermanentRemoval" exact="true"/>
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': No default order detected â†’ PERMANENT REMOVAL'" chance="100"/>
        </do_if>
        <do_elseif value="$currentDefaultOrder and $currentDefaultOrder != 'GalaxyTraderMK3' and $currentDefaultOrder != 'Assist'">
          <!-- Ship has a DIFFERENT permanent default order â†’ PERMANENT REMOVAL -->
          <set_value name="$isPermanentRemoval" exact="true"/>
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Different default order (' + $currentDefaultOrder + ') detected â†’ PERMANENT REMOVAL'" chance="100"/>
        </do_elseif>
        <do_elseif value="not (global.$GT_Ships? and global.$GT_Ships.{this.ship}?)">
          <!-- Ship was removed from GT (unregistered), definitely restore name -->
          <set_value name="$isPermanentRemoval" exact="true"/>
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Ship no longer registered in GT_Ships â†’ PERMANENT REMOVAL (even if actively trading)'" chance="100"/>
        </do_elseif>
      </do_else>
      
      <!-- Calculate subordinate status (needed for both permanent removal and pause checks) -->
      <set_value name="$isSubordinate" exact="$currentDefaultOrder == 'Assist' and $hasGTCommander"/>
      
      <!-- Always restore name on permanent removal, even if actively trading -->
      <do_if value="$isPermanentRemoval">
        <!-- Send ABORT signal: Restore ship name and clean up completely -->
        <do_if value="this.ship.pilot?">
          <set_value name="$originalName" exact="null"/>
          <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}? and global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName?">
            <set_value name="$originalName" exact="global.$GT_Pilots.{this.ship.pilot}.$OriginalShipName"/>
          </do_if>
          
          <do_if value="$originalName">
            <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
              $Ship = this.ship,
              $Pilot = this.ship.pilot,
              $Reason = 'Order permanently removed by player',
              $OriginalName = $originalName
            ]"/>
          </do_if>
        </do_if>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Sending ABORT signal (restore name, preserve XP) - permanent removal detected'" chance="100"/>
        </do_if>
        
        <!-- Clear training and maintenance flags -->
        <remove_value name="this.$training_in_progress"/>
        <remove_value name="this.$training_order_created"/>
        <remove_value name="this.$training_transition"/>
        <remove_value name="this.$maintenance_transition"/>
      </do_if>
      <!-- Only send PAUSE signal if NOT permanently removed AND NOT actively trading AND NOT transitioning -->
      <!-- CRITICAL: Don't pause subordinates with Assist order - they should stay registered -->
      <do_elseif value="not $isActivelyTrading and not $isTrainingTransition and not $isMaintenanceTransition and not $isSubordinate">
        <!-- Send PAUSE signal: Preserve everything (name and XP) for potential resume -->
        <set_value name="$pauseData" exact="table[
          $Ship = this.ship,
          $Pilot = this.ship.pilot,
          $Reason = 'Order temporarily replaced - preserving pilot data',
          $PreserveData = true
        ]"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Sending PAUSE signal (preserve everything for resume)'" chance="100"/>
        </do_if>
        <signal_objects object="player.galaxy" param="'GT_Ship_Order_Paused'" param2="$pauseData"/>
        
        <!-- Clear training and maintenance flags -->
        <remove_value name="this.$training_in_progress"/>
        <remove_value name="this.$training_order_created"/>
        <remove_value name="this.$training_transition"/>
        <remove_value name="this.$maintenance_transition"/>
      </do_elseif>
      <do_elseif value="$isSubordinate">
        <!-- Subordinate with Assist order - don't pause, stay registered -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Subordinate with Assist order - NOT sending PAUSE (staying registered)'" chance="100"/>
        </do_if>
      </do_elseif>
      <do_else>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-AI] ' + this.ship.idcode + ': Ship still actively trading/training/maintenance - NOT sending signals (will handle when orders complete)'" chance="100"/>
        </do_if>
      </do_else>
    </do_else>
  </on_abort>
  
</aiscript> 