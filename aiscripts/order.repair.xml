<?xml version="1.0" encoding="utf-8"?>
<diff>
  <!-- GalaxyTrader MK3: Repair completion signalling patch -->
  <!-- This patch adds immediate completion signalling when repair orders finish -->
  
  <add sel="//aiscript[@name='order.repair']/attention/actions/wait[@exact='10min']/interrupt/actions/debug_text" pos="after">
    
    <!-- GALAXYTRADER MK3: Repair completion signalling -->
    <do_if value="this.ship.pilot and this.ship.isplayerowned">
      <!-- Check if this pilot is managed by GalaxyTrader MK3 -->
      <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}?">
        
        <!-- Queue repair completion event -->
        <do_if value="not global.$GT_RepairCompleteQueue?">
          <set_value name="global.$GT_RepairCompleteQueue" exact="[]"/>
        </do_if>
        
        <set_value name="$repair_data" exact="table[
          $ship = this.ship,
          $pilot = this.ship.pilot,
          $timestamp = player.age
        ]"/>
        
        <append_to_list name="global.$GT_RepairCompleteQueue" exact="$repair_data"/>
        <set_value name="global.$GT_RepairCompletePending" exact="true"/>
        
        <debug_text text="'[GT-Repair] âœ… Repair complete for ' + this.ship.idcode + ', signalling completion'" chance="100"/>
      </do_if>
    </do_if>
    
  </add>
</diff>
