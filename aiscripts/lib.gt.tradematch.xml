<?xml version="1.0" encoding="utf-8"?>
<aiscript name="lib.gt.tradematch" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../ORIGINAL_MODS_DO NOT_MODIFY/X4Original/libraries/aiscripts.xsd" version="1">
  <params>
    <param name="ship" default="this.ship"/>
    <param name="sellOffers" default="[]"/>
    <param name="buyOffers" default="[]"/>
    <param name="homeSector" default="this.ship.sector"/>
    <param name="maxDistance" default="0"/>
    <param name="minROI" default="0"/>
    <param name="minAbsoluteProfit" default="0"/>
    <param name="distancePenalty" default="0.1"/>
    <param name="factionPriority" default="0"/>
    <param name="ignoreBuildStorage" default="false"/>
    <param name="ignoreCarrierAux" default="false"/>
    <param name="scoreMode" default="'sell'"/>
    <param name="maxTradesPerWare" default="20"/>
    <param name="debugchance" default="0"/>
    <param name="mode" default="'match'"/>
    <param name="lineType" default="'source'"/>
    <param name="sourceStation" default="null"/>
    <param name="station" default="null"/>
    <param name="wareText" default="null"/>
    <param name="isPlayerOwned" default="false"/>
    <param name="diagMode" default="'unknown'"/>
    <param name="unavailableFlag" default="'0'"/>
    <param name="amountText" default="'n/a'"/>
    <param name="altUnavailableFlag" default="'n/a'"/>
    <param name="altAmountText" default="'n/a'"/>
    <param name="cargoCount" default="0"/>
    <param name="cargoTarget" default="0"/>
    <param name="cargoRatio" default="0"/>
    <param name="ignoreTradeRules" default="false"/>
    <param name="tradeListInput" default="[]"/>
    <param name="rawNeedAmount" default="0"/>
    <param name="incomingReservedAmount" default="0"/>
    <param name="shipChunkAmount" default="1"/>
    <param name="availableTradeWaresCount" default="1"/>
    <param name="reservedCount" default="0"/>
    <param name="alreadyReservedByThisShip" default="false"/>
    <param name="fairnessCap" default="2"/>
  </params>
  <attention min="unknown">
    <actions>
      <do_if value="$mode == 'count_distinct_wares'">
        <create_list name="$distinctWares"/>
        <set_value name="$distinctCount" exact="0"/>
        <do_if value="$tradeListInput? and $tradeListInput.count gt 0">
          <do_all exact="$tradeListInput.count" counter="$dwi">
            <set_value name="$dwTrade" exact="$tradeListInput.{$dwi}"/>
            <set_value name="$dwWare" exact="null"/>
            <do_if value="$dwTrade? and $dwTrade.$Ware?">
              <set_value name="$dwWare" exact="$dwTrade.$Ware"/>
            </do_if>
            <do_if value="$dwWare?">
              <set_value name="$dwSeen" exact="false"/>
              <do_all exact="$distinctWares.count" counter="$dwj">
                <do_if value="$distinctWares.{$dwj} == $dwWare">
                  <set_value name="$dwSeen" exact="true"/>
                  <break/>
                </do_if>
              </do_all>
              <do_if value="not $dwSeen">
                <append_to_list name="$distinctWares" exact="$dwWare"/>
                <set_value name="$distinctCount" operation="add"/>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
        <return value="table[
          $DistinctWares = $distinctWares,
          $DistinctCount = $distinctCount
        ]"/>
      </do_if>

      <do_if value="$mode == 'ware_fairness'">
        <set_value name="$chunkSafe" exact="[1, $shipChunkAmount].max"/>
        <set_value name="$effectiveNeedAmount" exact="[$rawNeedAmount - $incomingReservedAmount, 0].max"/>
        <set_value name="$maxShipsForWare" exact="0"/>
        <do_if value="$effectiveNeedAmount gt 0">
          <set_value name="$maxShipsForWare" exact="(($effectiveNeedAmount + $chunkSafe - 1) / $chunkSafe)i"/>
          <do_if value="$availableTradeWaresCount gt 1 and $fairnessCap gt 0">
            <set_value name="$maxShipsForWare" exact="[$maxShipsForWare, $fairnessCap].min"/>
          </do_if>
        </do_if>
        <set_value name="$reservationAllowsTrade" exact="false"/>
        <do_if value="$alreadyReservedByThisShip or $reservedCount lt $maxShipsForWare">
          <set_value name="$reservationAllowsTrade" exact="true"/>
        </do_if>
        <return value="table[
          $EffectiveNeedAmount = $effectiveNeedAmount,
          $MaxShipsForWare = $maxShipsForWare,
          $ReservationAllowsTrade = $reservationAllowsTrade
        ]"/>
      </do_if>

      <do_if value="$mode == 'offerdiag_probe'">
        <set_value name="$diagModeResult" exact="'partner-filtered'"/>
        <set_value name="$altUnavailableFlagResult" exact="'n/a'"/>
        <set_value name="$altAmountTextResult" exact="'n/a'"/>
        <do_if value="$ignoreTradeRules and $station.isplayerowned">
          <set_value name="$diagModeResult" exact="'ignore-rules(player-owned)'"/>
          <set_value name="$altUnavailableFlagResult" exact="'1'"/>
          <set_value name="$altAmountTextResult" exact="'n/a'"/>
          <do_if value="$lineType == 'dest'">
            <find_buy_offer tradepartner="$ship" buyer="$station" wares="$wareText" result="$altOfferWithRules"/>
          </do_if>
          <do_else>
            <find_sell_offer tradepartner="$ship" seller="$station" wares="$wareText" result="$altOfferWithRules"/>
          </do_else>
          <do_if value="$altOfferWithRules == null or not $altOfferWithRules.available">
            <set_value name="$altUnavailableFlagResult" exact="'0'"/>
          </do_if>
          <do_if value="$altOfferWithRules != null">
            <set_value name="$altAmountTextResult" exact="$altOfferWithRules.offeramount.{$ship}"/>
          </do_if>
        </do_if>
        <return value="table[
          $Mode = $diagModeResult,
          $AltUnavailableFlag = $altUnavailableFlagResult,
          $AltAmountText = $altAmountTextResult
        ]"/>
      </do_if>

      <do_if value="$mode == 'offerdiag'">
        <set_value name="$ownerText" exact="if $isPlayerOwned then 'player' else 'foreign'"/>
        <set_value name="$detail" exact="''"/>
        <do_if value="$lineType == 'dest'">
          <set_value name="$detail" exact="$sourceStation.idcode + '->' + $station.idcode + ':' + $wareText + ' owner=' + $ownerText + ' mode=' + $diagMode + ' buy(unavailable=' + $unavailableFlag + ',amount=' + $amountText + ') altWithRules(unavailable=' + $altUnavailableFlag + ',amount=' + $altAmountText + ') cargo=' + $cargoCount + '/' + $cargoTarget + ' (' + $cargoRatio + '%)'"/>
        </do_if>
        <do_else>
          <set_value name="$detail" exact="$station.knownname + ' [' + $station.idcode + ']:' + $wareText + ' owner=' + $ownerText + ' mode=' + $diagMode + ' offer(unavailable=' + $unavailableFlag + ',amount=' + $amountText + ') altWithRules(unavailable=' + $altUnavailableFlag + ',amount=' + $altAmountText + ')'"/>
        </do_else>
        <return value="$detail"/>
      </do_if>

      <create_list name="$tradeList"/>
      <set_value name="$bestTrade" exact="null"/>
      <set_value name="$bestScore" exact="0"/>
      <set_value name="$tradesEvaluated" exact="0"/>
      <set_value name="$tradesRejected" exact="0"/>
      <set_value name="$supplyScoreDiagCount" exact="0"/>

      <!-- Read AI yield interval from global settings (persisted to instance var to survive waits) -->
      <set_value name="this.$gt_yieldMs" exact="1"/>
      <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Performance? and global.$GT_GlobalSettings.$Performance.$AIYieldInterval?">
        <set_value name="this.$gt_yieldMs" exact="[1, @global.$GT_GlobalSettings.$Performance.$AIYieldInterval].max"/>
      </do_if>

      <do_if value="not $sellOffers? or not $buyOffers? or $sellOffers.count == 0 or $buyOffers.count == 0">
        <return value="table[
          $Found = false,
          $BestTrade = null,
          $BestScore = 0,
          $TradeList = $tradeList,
          $TradesEvaluated = 0,
          $TradesRejected = 0
        ]"/>
      </do_if>

      <!-- Per-ware trade limiting: prevents a single high-volume ware (e.g. Energy Cells)
           from dominating the entire trade list. Each ware gets up to $maxTradesPerWare
           trades, ensuring diversity across all tradeable wares in the galaxy.
           Old version: MaxTradesPerWare=20 per ware. -->
      <set_value name="$tradesPerWare" exact="table[]"/>

      <do_all exact="$sellOffers.count" counter="$si">
        <set_value name="$sellOffer" exact="$sellOffers.{$si}"/>
        <set_value name="$ware" exact="@$sellOffer.ware"/>
        <set_value name="$buyStation" exact="if $sellOffer? and $sellOffer.owner? then @$sellOffer.owner else null"/>

        <!-- Per-ware early skip: if this ware already has max trades, skip entire inner loop -->
        <do_if value="$ware? and $tradesPerWare.{$ware}? and $tradesPerWare.{$ware} ge $maxTradesPerWare">
          <continue/>
        </do_if>

        <do_all exact="$buyOffers.count" counter="$bi">
          <set_value name="$buyOffer" exact="$buyOffers.{$bi}"/>
          <set_value name="$sellStation" exact="if $buyOffer? and $buyOffer.owner? then @$buyOffer.owner else null"/>

          <do_if value="@$buyOffer.ware != $ware">
            <continue/>
          </do_if>
          <!-- Per-ware trade cap (inner loop): stop producing more trades for this ware
               once the limit is reached. The outer-loop early skip handles the next sell offer,
               but a single sell offer can pair with hundreds of buy offers for the same ware. -->
          <do_if value="$ware? and $tradesPerWare.{$ware}? and $tradesPerWare.{$ware} ge $maxTradesPerWare">
            <break/>
          </do_if>
          <do_if value="$buyStation == null or $sellStation == null">
            <set_value name="$tradesRejected" operation="add"/>
            <continue/>
          </do_if>

          <!-- Build storage exclusion -->
          <do_if value="$ignoreBuildStorage">
            <do_if value="$buyStation.isbuildstorage or $sellStation.isbuildstorage">
              <set_value name="$tradesRejected" operation="add"/>
              <continue/>
            </do_if>
          </do_if>

          <!-- Carrier / auxiliary exclusion (stations are never carriers/auxiliaries, only ships can be) -->
          <do_if value="$ignoreCarrierAux">
            <do_if value="($buyStation.isclass.ship and ($buyStation.type == shiptype.carrier or $buyStation.type == shiptype.resupplier)) or ($sellStation.isclass.ship and ($sellStation.type == shiptype.carrier or $sellStation.type == shiptype.resupplier))">
              <set_value name="$tradesRejected" operation="add"/>
              <continue/>
            </do_if>
          </do_if>

          <!-- Shared amount semantics:
               Prefer per-ship effective offer amounts (offeramount.{ship}) to match vanilla
               trade resolution, especially for internal/no-money flows. Fallback to raw amount
               when offeramount is unavailable. -->
          <set_value name="$sellOfferAmount" exact="$sellOffer.offeramount.{$ship}"/>
          <do_if value="$sellOfferAmount == null">
            <set_value name="$sellOfferAmount" exact="$sellOffer.amount"/>
          </do_if>
          <do_if value="$sellOfferAmount == null">
            <set_value name="$sellOfferAmount" exact="0"/>
          </do_if>

          <set_value name="$buyOfferAmount" exact="$buyOffer.offeramount.{$ship}"/>
          <do_if value="$buyOfferAmount == null">
            <set_value name="$buyOfferAmount" exact="$buyOffer.amount"/>
          </do_if>
          <do_if value="$buyOfferAmount == null">
            <set_value name="$buyOfferAmount" exact="0"/>
          </do_if>

          <!-- UNIVERSAL CACHE BASIS:
               Do not bind cached trade amount/score to the writer ship's free cargo.
               Cache entries should represent station-side opportunity; per-ship execution
               amount is resolved later via clamp_trade_amount in order.trade.galaxytrader. -->
          <set_value name="$tradeAmount" exact="[$sellOfferAmount, $buyOfferAmount].min"/>
          <do_if value="$tradeAmount le 0">
            <set_value name="$tradesRejected" operation="add"/>
            <continue/>
          </do_if>

          <set_value name="$unitProfit" exact="$buyOffer.unitprice - $sellOffer.unitprice"/>
          <do_if value="$scoreMode == 'sell' and $unitProfit le 0">
            <set_value name="$tradesRejected" operation="add"/>
            <continue/>
          </do_if>

          <!-- Distance check: validate BOTH buy station and sell station -->
          <set_value name="$distBuy" exact="$homeSector.gatedistance.{$buyStation}"/>
          <do_if value="$distBuy lt 0 or $distBuy gt $maxDistance">
            <set_value name="$tradesRejected" operation="add"/>
            <continue/>
          </do_if>
          <set_value name="$distSell" exact="$homeSector.gatedistance.{$sellStation}"/>
          <do_if value="$distSell lt 0 or $distSell gt $maxDistance">
            <set_value name="$tradesRejected" operation="add"/>
            <continue/>
          </do_if>
          <!-- Use the greater distance for scoring (worst-case leg) -->
          <set_value name="$distance" exact="[$distBuy, $distSell].max"/>

          <set_value name="$distanceFactor" exact="1.0 + ($distance * $distancePenalty)"/>
          <set_value name="$score" exact="0"/>
          <set_value name="$volumePerUnit" exact="if $ware? and $ware.volume? then $ware.volume else 1"/>

          <do_if value="$scoreMode == 'supply'">
            <!-- Force integer credits to prevent any money-type propagation into float math. -->
            <set_value name="$priceFactor" exact="($sellOffer.unitprice / 1Cr)i"/>
            <do_if value="$priceFactor lt 1">
              <set_value name="$priceFactor" exact="1"/>
            </do_if>
            <!-- Focused diagnostics for the known supply score warning site.
                 Enabled only when global debug logging is on; hard-capped per run to avoid spam. -->
            <do_if value="global.$GT_GlobalSettings? and global.$GT_GlobalSettings.$Debug? and global.$GT_GlobalSettings.$Debug.$EnableDebugLogging and $supplyScoreDiagCount lt 8">
              <debug_text text="'[GT-TradeMatch] ' + $ship.idcode + ': supply-score diag ware=' + $ware + ' tradeAmount=' + $tradeAmount + ' distFactor=' + $distanceFactor + ' unitPriceMoney=' + $sellOffer.unitprice + ' unitPriceCr=' + ($sellOffer.unitprice / 1Cr) + ' priceFactor=' + $priceFactor + ' expr=' + $tradeAmount + '/(' + $distanceFactor + '*' + $priceFactor + ')'" chance="100"/>
              <set_value name="$supplyScoreDiagCount" operation="add"/>
            </do_if>
            <set_value name="$score" exact="$tradeAmount / ($distanceFactor * $priceFactor)"/>
          </do_if>
          <do_else>
            <set_value name="$grossProfit" exact="$unitProfit * $tradeAmount"/>
            <set_value name="$roi" exact="if $sellOffer.unitprice gt 0 then ($unitProfit * 100) / $sellOffer.unitprice else 0"/>
            <do_if value="$grossProfit lt $minAbsoluteProfit or $roi lt $minROI">
              <set_value name="$tradesRejected" operation="add"/>
              <continue/>
            </do_if>
            <!-- Keep score numeric (credits) to avoid float*money conversion warnings in bonuses. -->
            <set_value name="$score" exact="($grossProfit / 1Cr) / $distanceFactor"/>

            <!-- Faction priority bonus: boost score for trades involving player-owned stations -->
            <do_if value="$factionPriority gt 0">
              <set_value name="$factionBonus" exact="1.0"/>
              <do_if value="$buyStation.isplayerowned or $sellStation.isplayerowned">
                <set_value name="$factionBonus" exact="1.0 + ($factionPriority * 0.1)"/>
              </do_if>
              <set_value name="$score" exact="$score * $factionBonus"/>
            </do_if>
          </do_else>

          <set_value name="$trade" exact="table[
            $Ware = $ware,
            $BuyOffer = $sellOffer,
            $SellOffer = $buyOffer,
            $Amount = $tradeAmount,
            $OfferMaxAmount = $tradeAmount,
            $BuyOfferAmount = $sellOfferAmount,
            $SellOfferAmount = $buyOfferAmount,
            $Score = $score,
            $BuyStation = $buyStation,
            $SellStation = $sellStation,
            $BuySector = $buyStation.sector,
            $SellSector = $sellStation.sector,
            $Distance = $distance,
            $UnitProfit = $unitProfit,
            $BuyPrice = $sellOffer.unitprice,
            $SellPrice = $buyOffer.unitprice,
            $ProfitPerUnit = $unitProfit,
            $VolumePerUnit = $volumePerUnit,
            $Profit = ($unitProfit * $tradeAmount)
          ]"/>
          <append_to_list name="$tradeList" exact="$trade"/>
          <set_value name="$tradesEvaluated" operation="add"/>

          <!-- Track per-ware trade count -->
          <do_if value="$ware?">
            <do_if value="not $tradesPerWare.{$ware}?">
              <set_value name="$tradesPerWare.{$ware}" exact="0"/>
            </do_if>
            <set_value name="$tradesPerWare.{$ware}" operation="add"/>
          </do_if>

          <do_if value="$score gt $bestScore">
            <set_value name="$bestScore" exact="$score"/>
            <set_value name="$bestTrade" exact="$trade"/>
          </do_if>
        </do_all>

        <wait exact="this.$gt_yieldMs * 1ms" comment="Yield after each sell-offer loop"/>
      </do_all>

      <return value="table[
        $Found = ($bestTrade != null),
        $BestTrade = $bestTrade,
        $BestScore = $bestScore,
        $TradeList = $tradeList,
        $TradesEvaluated = $tradesEvaluated,
        $TradesRejected = $tradesRejected
      ]"/>
    </actions>
  </attention>
</aiscript>
