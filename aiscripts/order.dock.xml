<?xml version="1.0" encoding="utf-8"?>
<diff>
  <!-- GalaxyTrader MK3: Capture dock failure reasons for trade orders -->
  
  <!-- CRITICAL: When dock fails due to "no path to destination", signal parent trade order -->
  <add sel="//aiscript[@name='order.dock']/attention/actions/label[@name='nodestination']" pos="after">
    
    <!-- GALAXYTRADER MK3: Signal dock failure to parent trade order -->
    <do_if value="@$callerid.id == 'TradePerform'">
      <!-- This dock order was created by a trade order - signal the failure reason -->
      <do_if value="global.$GT_Pilots? and global.$GT_Pilots.{$thisship.pilot}?">
        <!-- Only for GT-managed pilots -->
        
        <!-- Determine specific failure reason -->
        <set_value name="$gt_dock_failure" exact="'ERR_NO_PATH_TO_DESTINATION'"/>
        <set_value name="$failuretext" exact="{1045, 124}" comment="No path to destination"/>
        
        <!-- Check if it's a blacklist issue -->
        <include_interrupt_actions ref="GetBlacklistgroup"/>
        <do_if value="$internalorder and @$destination.exists">
          <!-- Check if destination is blacklisted -->
          <do_if value="$destination.isblacklisted.{blacklisttype.objectactivity}.{$blacklistgroup}.{$thisship}">
            <set_value name="$gt_dock_failure" exact="'ERR_DESTINATION_BLACKLISTED'"/>
            <set_value name="$failuretext" exact="{1045, 124}" comment="Destination is blacklisted"/>
          </do_if>
          <do_elseif value="@$destination.sector.isblacklisted.{blacklisttype.sectortravel}.{$blacklistgroup}.{$thisship}">
            <set_value name="$gt_dock_failure" exact="'ERR_SECTOR_BLACKLISTED'"/>
            <set_value name="$failuretext" exact="{1045, 124}" comment="Sector is blacklisted"/>
          </do_elseif>
        </do_if>
        
        <!-- Store failure reason in global table for parent trade order to check -->
        <do_if value="not global.$GT_DockFailures?">
          <set_value name="global.$GT_DockFailures" exact="table[]"/>
        </do_if>
        
        <set_value name="global.$GT_DockFailures.{$thisship}" exact="table[
          $Reason = $gt_dock_failure,
          $FailureText = $failuretext,
          $Destination = $destination,
          $Timestamp = player.age
        ]"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Dock] âš  Dock FAILED for ' + $thisship.idcode + ': ' + $gt_dock_failure + ' (destination: ' + @$destination.knownname + ')'" chance="100"/>
        </do_if>
      </do_if>
    </do_if>
    
  </add>
  
</diff>
