<?xml version='1.0' encoding='utf-8'?>
<diff>
  <!-- GalaxyTrader MK3: Support for GT order inheritance by subordinates -->
  <add sel="/aiscript/attention/actions/do_if[@value='$order.exists or (@$orderdef and $createdefaultorder?)']/do_if[@value='(@$orderdef and $createdefaultorder?) or not $order.requiredskill or (this.combinedskill ge $order.requiredskill)']">
    <do_elseif value="$orderdef.$id == 'GalaxyTraderMK3'">
      <set_value name="$added"/>
      <do_if value="$createdefaultorder?">
        <create_order id="$orderdef.$id" object="this.assignedcontrolled" default="true">
          <param name="home" value="$orderdef.$home"/>
          <param name="maxbuy" value="$orderdef.$maxbuy"/>
          <param name="maxsell" value="$orderdef.$maxsell"/>
          <param name="autowares" value="$orderdef.$autowares"/>
          <param name="warebasket" value="$orderdef.$warebasket"/>
          <param name="allowillegal" value="$orderdef.$allowillegal"/>
          <param name="distancepenalty" value="$orderdef.$distancepenalty"/>
          <param name="notifications" value="$orderdef.$notifications"/>
          <param name="cargotarget" value="$orderdef.$cargotarget"/>
          <param name="marketupdatefreq" value="$orderdef.$marketupdatefreq"/>
          <param name="debuglevel" value="$orderdef.$debuglevel"/>
          <param name="tradeeval" value="$orderdef.$tradeeval"/>
        </create_order>
      </do_if>
      <do_else>
        <set_value name="$orderdef.$home" exact="$order.$home"/>
        <set_value name="$orderdef.$maxbuy" exact="$order.$maxbuy"/>
        <set_value name="$orderdef.$maxsell" exact="$order.$maxsell"/>
        <set_value name="$orderdef.$autowares" exact="$order.$autowares"/>
        <set_value name="$orderdef.$warebasket" exact="$order.$warebasket"/>
        <set_value name="$orderdef.$allowillegal" exact="$order.$allowillegal"/>
        <set_value name="$orderdef.$distancepenalty" exact="$order.$distancepenalty"/>
        <set_value name="$orderdef.$notifications" exact="$order.$notifications"/>
        <set_value name="$orderdef.$cargotarget" exact="$order.$cargotarget"/>
        <set_value name="$orderdef.$marketupdatefreq" exact="$order.$marketupdatefreq"/>
        <set_value name="$orderdef.$debuglevel" exact="$order.$debuglevel"/>
        <set_value name="$orderdef.$tradeeval" exact="$order.$tradeeval"/>
        <!-- CRITICAL: Ensure subordinate is registered in GT_Ships when inheriting GT order -->
        <!-- This ensures detection works even if AI script doesn't register the ship -->
        <do_if value="not global.$GT_Ships?">
          <set_value name="global.$GT_Ships" exact="table[]"/>
        </do_if>
        <do_if value="not global.$GT_Ships.{this.assignedcontrolled}?">
          <set_value name="global.$GT_Ships.{this.assignedcontrolled}" exact="table[]"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Registered subordinate in GT_Ships registry (inheriting GT order from commander)'" chance="100"/>
          </do_if>
        </do_if>
        
        <run_script name="$scriptname">
          <param name="home" value="$order.$home"/>
          <param name="maxbuy" value="$order.$maxbuy"/>
          <param name="maxsell" value="$order.$maxsell"/>
          <param name="autowares" value="$order.$autowares"/>
          <param name="warebasket" value="$order.$warebasket"/>
          <param name="allowillegal" value="$order.$allowillegal"/>
          <param name="distancepenalty" value="$order.$distancepenalty"/>
          <param name="notifications" value="$order.$notifications"/>
          <param name="cargotarget" value="$order.$cargotarget"/>
          <param name="marketupdatefreq" value="$order.$marketupdatefreq"/>
          <param name="debuglevel" value="$order.$debuglevel"/>
          <param name="tradeeval" value="$order.$tradeeval"/>
        </run_script>
      </do_else>
    </do_elseif>
  </add>
  
  <!-- PHASE 7: Detect when subordinate is removed (no commander detected) -->
  <!-- When a subordinate is removed, Assist order detects no commander and cancels itself -->
  <!-- This is the perfect place to detect GT order removal for subordinates -->
  <add sel="//aiscript[@name='order.assist']/attention/actions/do_if[@value='not @this.assignedcontrolled.commander.isclass.ship']" pos="after">
    
    <!-- PHASE 7: Detect GT order removal when subordinate is removed -->
    <!-- CRITICAL: This patch triggers when commander.isclass.ship is false -->
    <!-- This can mean: 1) Commander doesn't exist (removed), OR 2) Commander is station/buildstorage (still subordinate!) -->
    <!-- We must ONLY trigger if commander was actually REMOVED, not if commander is just a station -->
    
    <!-- CRITICAL FIX: Check if commander actually exists before processing -->
    <!-- If commander exists (even if not a ship), ship is still subordinate - don't trigger removal -->
    <set_value name="$commanderExists" exact="false"/>
    <do_if value="this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists">
      <set_value name="$commanderExists" exact="true"/>
    </do_if>
    
    <!-- Only process if commander was actually removed (doesn't exist) -->
    <do_if value="not $commanderExists">
      <!-- FIX 2: State-independent cleanup - check commander directly, initialize state if needed -->
      
      <!-- Initialize state registry if missing -->
      <do_if value="not global.$GT_Ship_State?">
        <set_value name="global.$GT_Ship_State" exact="table[]"/>
      </do_if>
      
      <!-- Initialize ship state if missing (lazy initialization) -->
      <do_if value="not global.$GT_Ship_State.{this.assignedcontrolled}?">
        <set_value name="global.$GT_Ship_State.{this.assignedcontrolled}" exact="table[
          $OperationalState = 'idle',
          $SubordinateState = 'independent',
          $Commander = null,
          $CommanderHasGT = false,
          $HasGTOrder = false,
          $HasAssistOrder = false,
          $ActiveTradeOrders = 0,
          $LastStateUpdate = player.age,
          $MacroShipName = null,
          $OriginalShipName = null
        ]"/>
      </do_if>
      
      <set_value name="$state" exact="global.$GT_Ship_State.{this.assignedcontrolled}"/>
      
      <!-- CRITICAL FIX: Check if ship is being newly assigned to a commander -->
      <!-- During assignment transition, commander might not be detected yet, but ship might have been idle before -->
      <!-- Get old commander from state (if tracked) -->
      <set_value name="$oldCommander" exact="null"/>
      <do_if value="$state.$Commander? and $state.$Commander.exists">
        <set_value name="$oldCommander" exact="$state.$Commander"/>
      </do_if>
      
      <!-- Check if ship is being newly assigned (had no commander before, now has one) -->
      <set_value name="$newlyAssignedToCommander" exact="false"/>
      <do_if value="(not $oldCommander.exists or $oldCommander == null) and this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists">
        <set_value name="$newlyAssignedToCommander" exact="true"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - NEWLY ASSIGNED to commander ' + this.assignedcontrolled.commander.idcode + ' (was idle before) - skipping cleanup'" chance="100"/>
        </do_if>
      </do_if>
      
      <!-- Only proceed if ship was NOT newly assigned -->
      <do_if value="not $newlyAssignedToCommander">
        <!-- Check if ship was subordinate to GT commander (commander was removed) -->
        <set_value name="$wasSubordinateToGTCommander" exact="false"/>
        
        <!-- Method 1: Check state (if it was tracked) -->
        <do_if value="$state.$SubordinateState? and $state.$SubordinateState == 'subordinate'">
          <do_if value="$state.$CommanderHasGT? and $state.$CommanderHasGT">
            <set_value name="$wasSubordinateToGTCommander" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Method 2: PRIMARY CHECK - Ship is in GT_Ships registry (indicates it was GT-controlled) -->
        <!-- ALL ships with GT orders are in global.$GT_Ships, regardless of modifications -->
        <do_if value="not $wasSubordinateToGTCommander and global.$GT_Ships? and global.$GT_Ships.{this.assignedcontrolled}?">
          <set_value name="$wasSubordinateToGTCommander" exact="true"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Ship is in GT_Ships registry - treating as GT subordinate removal'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- If ship was subordinate to GT commander and is now removed, restore name and send cancellation signal -->
        <do_if value="$wasSubordinateToGTCommander">
        <!-- CRITICAL FIX: Check if ship still has GT order (direct or via new commander) BEFORE sending cancellation -->
        <!-- Ship might have been reassigned to another GT commander or got direct GT order -->
        <set_value name="$stillHasGTOrder" exact="false"/>
        
        <!-- Check 1: Direct GT order -->
        <do_if value="this.assignedcontrolled.defaultorder? and @this.assignedcontrolled.defaultorder.id == 'GalaxyTraderMK3'">
          <set_value name="$stillHasGTOrder" exact="true"/>
        </do_if>
        
        <!-- Check 2: Subordinate to GT commander (new commander) -->
        <do_if value="not $stillHasGTOrder and this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists and this.assignedcontrolled.commander != this.assignedcontrolled">
          <do_if value="this.assignedcontrolled.commander.defaultorder? and @this.assignedcontrolled.commander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$stillHasGTOrder" exact="true"/>
          </do_if>
        </do_if>
      
        <!-- Only send cancellation signal if ship NO LONGER has GT order -->
        <do_if value="not $stillHasGTOrder">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-State] Phase 7: ' + this.assignedcontrolled.idcode + ' - Subordinate removed from GT commander (detected in Assist order) - GT order truly cancelled'" chance="100"/>
          </do_if>
          
          <!-- Update state to reflect GT order cancellation -->
          <set_value name="$state.$HasGTOrder" exact="false"/>
          <set_value name="$state.$OperationalState" exact="'orphaned'"/>
          <set_value name="$state.$ActiveTradeOrders" exact="0"/>
          <set_value name="$state.$Commander" exact="null"/>
          <set_value name="$state.$CommanderHasGT" exact="false"/>
          <set_value name="$state.$SubordinateState" exact="'orphaned'"/>
          <set_value name="$state.$LastStateUpdate" exact="player.age"/>
          
          <!-- MOD REMOVAL: Send GT_Ship_State_Update signal for mod removal system -->
          <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
            $Ship = this.assignedcontrolled,
            $UpdateType = 'GT_Order_Cancelled'
          ]"/>
          
            <!-- EVENT-DRIVEN: Trigger orphaned ship check for subordinate -->
            <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.assignedcontrolled}?">
              <signal_objects object="player.galaxy" param="'GT_Check_Ship_Orphaned'" param2="table[$Ship = this.assignedcontrolled]"/>
            </do_if>
        </do_if>
        <do_else>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-State] Phase 7: ' + this.assignedcontrolled.idcode + ' - Subordinate removed from GT commander BUT ship still has GT order (direct or via new commander) - NOT sending cancellation'" chance="100"/>
          </do_if>
        </do_else>
        </do_if>
      <!-- End: Only proceed if ship was NOT newly assigned -->
      </do_if>
      
      <!-- NAME RESTORATION: Restore ship name (only if no GT order) -->
      <set_value name="$hasDirectGTOrder" exact="false"/>
      <do_if value="this.assignedcontrolled.defaultorder? and @this.assignedcontrolled.defaultorder.id == 'GalaxyTraderMK3'">
        <set_value name="$hasDirectGTOrder" exact="true"/>
      </do_if>
      
      <do_if value="not $hasDirectGTOrder and this.assignedcontrolled.pilot?">
        <set_value name="$originalName" exact="null"/>
        <do_if value="$state.$OriginalShipName?">
          <set_value name="$originalName" exact="$state.$OriginalShipName"/>
        </do_if>
        <do_elseif value="global.$GT_Pilots? and global.$GT_Pilots.{this.assignedcontrolled.pilot}? and global.$GT_Pilots.{this.assignedcontrolled.pilot}.$OriginalShipName?">
          <set_value name="$originalName" exact="global.$GT_Pilots.{this.assignedcontrolled.pilot}.$OriginalShipName"/>
        </do_elseif>
        
        <do_if value="$originalName">
          <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
            $Ship = this.assignedcontrolled,
            $Pilot = this.assignedcontrolled.pilot,
            $Reason = 'Subordinate removed from GT commander - restoring original name',
            $OriginalName = $originalName
          ]"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-State] Phase 7: Name restoration signal sent for ' + this.assignedcontrolled.idcode + ' (removed from GT commander, original name: ' + $originalName + ')'" chance="100"/>
          </do_if>
        </do_if>
      </do_if>
    </do_if>
    <!-- End: Only process if commander was actually removed -->
    
  </add>
  
  <!-- FIX: Add null check for this.assignedcontrolled.order before accessing .isrunning (vanilla bug) -->
  <!-- Vanilla code has multiple instances of order.isrunning without null check -->
  <!-- Instance 1: Line 853 - after "not $added?" check -->
  <!-- Note: Selector uses contains() to match the value with "and" operator -->
  <replace sel="//aiscript[@name='order.assist']/attention/actions/do_if[@value='not $added?']/do_if[contains(@value, 'this.assignedcontrolled.order.isrunning')]">
    <do_if value="$failurereason?">
      <do_if value="this.assignedcontrolled.order?">
        <do_if value="this.assignedcontrolled.order.isrunning">
          <set_order_failed order="this.assignedcontrolled.order" text="$failurereason"/>
        </do_if>
      </do_if>
    </do_if>
  </replace>
  
  <!-- Instance 2: Line 870 - after remove_value $added, before wait -->
  <!-- Use a more specific path that includes context -->
  <replace sel="//aiscript[@name='order.assist']/attention/actions/remove_value[@name='$added']/following-sibling::*[1][self::do_if[@value='this.assignedcontrolled.order.isrunning']]">
    <do_if value="this.assignedcontrolled.order?">
      <do_if value="@this.assignedcontrolled.order.isrunning">
        <set_order_syncpoint_reached order="this.assignedcontrolled.order"/>
      </do_if>
    </do_if>
  </replace>
  
  <!-- PHASE 7: Detect when Assist order is aborted (catches "remove all commands and orders") -->
  <!-- When Assist order terminates, check if subordinate was GT-controlled and trigger cleanup -->
  <add sel="//aiscript[@name='order.assist']/attention" pos="after">
    <on_abort>
      <!-- PERFORMANCE FIX: Early exit check BEFORE any logging or property lookups -->
      <!-- If ship is not GT-controlled, exit immediately to prevent stutter -->
      <set_value name="$isGTControlled" exact="false"/>
      
      <!-- Quick check: Is ship in GT_Ships registry? -->
      <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.assignedcontrolled}?">
        <set_value name="$isGTControlled" exact="true"/>
      </do_if>
      
      <!-- Fallback check: Is ship tracked as subordinate to GT commander? -->
      <do_if value="not $isGTControlled and global.$GT_Ship_State? and global.$GT_Ship_State.{this.assignedcontrolled}?">
        <set_value name="$state" exact="global.$GT_Ship_State.{this.assignedcontrolled}"/>
        <do_if value="$state.$SubordinateState? and $state.$SubordinateState == 'subordinate'">
          <do_if value="$state.$CommanderHasGT? and $state.$CommanderHasGT">
            <set_value name="$isGTControlled" exact="true"/>
          </do_if>
        </do_if>
      </do_if>
      
      <!-- EARLY EXIT: If ship is not GT-controlled, exit immediately without any processing -->
      <do_if value="not $isGTControlled">
        <!-- Ship is not GT-controlled - no cleanup needed, exit silently -->
        <!-- This prevents stutter from constant property lookups for non-GT ships -->
        <return/>
      </do_if>
      
      <!-- Ship IS GT-controlled - proceed with cleanup logic -->
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Assist order aborted - checking if GT cleanup needed'" chance="100"/>
      </do_if>
      
      <!-- Check if ship was GT-controlled (is in GT_Ships registry) -->
      <!-- ALL ships with GT orders are in global.$GT_Ships, regardless of modifications -->
      <set_value name="$needsCleanup" exact="false"/>
      <set_value name="$wasGTControlled" exact="true"/>  <!-- Already confirmed above -->
      
      <!-- Initialize state registry reference for debug logging -->
      <set_value name="$state" exact="null"/>
      <do_if value="global.$GT_Ship_State? and global.$GT_Ship_State.{this.assignedcontrolled}?">
        <set_value name="$state" exact="global.$GT_Ship_State.{this.assignedcontrolled}"/>
      </do_if>
      
      <!-- PRIMARY CHECK: Ship is in GT_Ships registry (indicates it was GT-controlled) -->
      <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.assignedcontrolled}?">
        <set_value name="$wasGTControlled" exact="true"/>
        <set_value name="$needsCleanup" exact="true"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Ship is in GT_Ships registry - was GT-controlled'" chance="100"/>
        </do_if>
      </do_if>
      
      <!-- FALLBACK: Check state registry (if ship was tracked as subordinate) -->
      <do_if value="not $wasGTControlled and $state?">
        <do_if value="$state.$SubordinateState? and $state.$SubordinateState == 'subordinate'">
          <do_if value="$state.$CommanderHasGT? and $state.$CommanderHasGT">
            <set_value name="$wasGTControlled" exact="true"/>
            <set_value name="$needsCleanup" exact="true"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Ship was tracked as subordinate to GT commander - needs cleanup'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
      </do_if>
      
      <!-- If cleanup needed, trust the removal signal -->
      <!-- CRITICAL: Assist order aborting means subordinate was removed -->
      <!-- COMPREHENSIVE DEBUG LOGGING: Ship state and orders at removal detection -->
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <set_value name="$debugShip" exact="this.assignedcontrolled"/>
        <set_value name="$debugDefaultOrder" exact="@$debugShip.defaultorder.id"/>
        <set_value name="$debugCommander" exact="@$debugShip.commander"/>
        <set_value name="$debugCommanderId" exact="if @$debugCommander.exists then @$debugCommander.idcode else 'NONE'"/>
        <set_value name="$debugCommanderOrder" exact="if @$debugCommander.exists and @$debugCommander.defaultorder != null then @$debugCommander.defaultorder.id else 'NONE'"/>
        <set_value name="$debugPilot" exact="@$debugShip.pilot"/>
        <set_value name="$debugPilotName" exact="if $debugPilot != null then @$debugPilot.knownname else 'NONE'"/>
        
        <!-- Build orders list -->
        <set_value name="$debugOrdersList" exact="[]"/>
        <set_value name="$debugOrdersCount" exact="$debugShip.orders.count"/>
        <do_all exact="$debugOrdersCount" counter="$i">
          <set_value name="$orderId" exact="@$debugShip.orders.{$i}.id"/>
          <append_to_list name="$debugOrdersList" exact="if $orderId then $orderId else 'UNKNOWN'"/>
        </do_all>
        <set_value name="$debugOrdersStr" exact="if $debugOrdersList.count gt 0 then $debugOrdersList.{1} + (if $debugOrdersList.count gt 1 then ', ' + $debugOrdersList.{2} else '') + (if $debugOrdersList.count gt 2 then ', ' + $debugOrdersList.{3} else '') + (if $debugOrdersList.count gt 3 then ', ' + $debugOrdersList.{4} else '') + (if $debugOrdersList.count gt 4 then ', ...' else '') else 'NONE'"/>
        
        <!-- Check GT order status -->
        <set_value name="$debugHasDirectGT" exact="false"/>
        <do_if value="$debugDefaultOrder == 'GalaxyTraderMK3'">
          <set_value name="$debugHasDirectGT" exact="true"/>
        </do_if>
        <set_value name="$debugHasGTCommander" exact="false"/>
        <do_if value="@$debugCommander.exists and $debugCommanderOrder == 'GalaxyTraderMK3'">
          <set_value name="$debugHasGTCommander" exact="true"/>
        </do_if>
        
        <!-- Check if in GT_Ships registry -->
        <set_value name="$debugInRegistry" exact="global.$GT_Ships? and global.$GT_Ships.{$debugShip}?"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Assist] REMOVAL DETECTION DEBUG: ' + $debugShip.idcode + ' - COMPREHENSIVE STATE'" chance="100"/>
          <debug_text text="'[GT-Assist]   Ship: ' + $debugShip.idcode + ' (' + (if $debugShip.knownname then $debugShip.knownname else 'UNNAMED') + ')'" chance="100"/>
          <debug_text text="'[GT-Assist]   Pilot: ' + $debugPilotName + (if $debugPilot? then ' (exists)' else ' (NONE)')" chance="100"/>
          <debug_text text="'[GT-Assist]   Default Order: ' + (if $debugDefaultOrder then $debugDefaultOrder else 'NONE')" chance="100"/>
          <debug_text text="'[GT-Assist]   Active Orders (' + $debugOrdersCount + '): ' + $debugOrdersStr" chance="100"/>
          <debug_text text="'[GT-Assist]   Commander: ' + $debugCommanderId + ' (Order: ' + $debugCommanderOrder + ')'" chance="100"/>
          <debug_text text="'[GT-Assist]   GT Status: Direct=' + $debugHasDirectGT + ', ViaCommander=' + $debugHasGTCommander + ', InRegistry=' + $debugInRegistry" chance="100"/>
          <set_value name="$debugSubordinateState" exact="'NONE'"/>
          <set_value name="$debugCommanderHasGT" exact="'NONE'"/>
          <do_if value="$state?">
            <set_value name="$debugSubordinateState" exact="if $state.$SubordinateState? then $state.$SubordinateState else 'NONE'"/>
            <set_value name="$debugCommanderHasGT" exact="if $state.$CommanderHasGT? then $state.$CommanderHasGT else 'NONE'"/>
          </do_if>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist]   State: SubordinateState=' + $debugSubordinateState + ', CommanderHasGT=' + $debugCommanderHasGT" chance="100"/>
          </do_if>
        </do_if>
      </do_if>
      
      <!-- During abort window, ship.commander may still point to old commander (race condition) -->
      <!-- Solution: Snapshot commander before abort, then emit cleanup unconditionally if it was GT-controlled -->
      <do_if value="$needsCleanup">
        <!-- Snapshot commander BEFORE checking (captures state before abort clears it) -->
        <set_value name="$oldCommander" exact="@this.assignedcontrolled.commander"/>
        <set_value name="$oldCommanderHadGT" exact="false"/>
        <do_if value="@$oldCommander.exists and $oldCommander != this.assignedcontrolled">
          <do_if value="$oldCommander.defaultorder? and @$oldCommander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$oldCommanderHadGT" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Check if ship was subordinate to GT commander (before abort) -->
        <set_value name="$wasSubordinateToGT" exact="false"/>
        <do_if value="$oldCommanderHadGT">
          <set_value name="$wasSubordinateToGT" exact="true"/>
        </do_if>
        <do_elseif value="$state.$SubordinateState? and $state.$SubordinateState == 'subordinate'">
          <do_if value="$state.$CommanderHasGT? and $state.$CommanderHasGT">
            <set_value name="$wasSubordinateToGT" exact="true"/>
          </do_if>
        </do_elseif>
        
        <!-- Check if ship has direct GT order (not via commander) -->
        <set_value name="$hasDirectGTOrder" exact="false"/>
        <do_if value="this.assignedcontrolled.defaultorder? and @this.assignedcontrolled.defaultorder.id == 'GalaxyTraderMK3'">
          <set_value name="$hasDirectGTOrder" exact="true"/>
        </do_if>
        
        <!-- Check if reassigned to NEW GT commander OR newly assigned to GT commander (protect against immediate reassignment/new assignment) -->
        <set_value name="$reassignedToGTCommander" exact="false"/>
        <set_value name="$newlyAssignedToGTCommander" exact="false"/>
        <do_if value="this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists and this.assignedcontrolled.commander != this.assignedcontrolled">
          <!-- Check if this is a new assignment (ship had no commander before) -->
          <do_if value="not @$oldCommander.exists or $oldCommander == null">
            <!-- Ship had no commander before - this is a NEW assignment -->
            <do_if value="this.assignedcontrolled.commander.defaultorder? and @this.assignedcontrolled.commander.defaultorder.id == 'GalaxyTraderMK3'">
              <set_value name="$newlyAssignedToGTCommander" exact="true"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - NEWLY ASSIGNED to GT commander ' + this.assignedcontrolled.commander.idcode + ' - skipping cleanup (Assist order will restart)'" chance="100"/>
              </do_if>
            </do_if>
          </do_if>
          <do_elseif value="this.assignedcontrolled.commander != $oldCommander">
            <!-- Commander changed from one to another - check if new commander has GT order -->
            <do_if value="this.assignedcontrolled.commander.defaultorder? and @this.assignedcontrolled.commander.defaultorder.id == 'GalaxyTraderMK3'">
              <set_value name="$reassignedToGTCommander" exact="true"/>
            </do_if>
          </do_elseif>
        </do_if>
        
        <!-- CRITICAL FIX: Check if ship is STILL subordinate to SAME GT commander -->
        <!-- Assist order can restart (e.g., commander order change) without subordinate being removed -->
        <!-- Key insight: If default order is still "Assist" AND commander is SAME AND commander still has GT, ship is still subordinate -->
        <!-- If commander changed OR commander lost GT order OR default order changed, subordinate relationship ended -->
        <set_value name="$currentDefaultOrder" exact="@this.assignedcontrolled.defaultorder.id"/>
        <set_value name="$currentCommander" exact="null"/>
        <set_value name="$stillHasGTCommander" exact="false"/>
        <set_value name="$isStillSubordinate" exact="false"/>
        
        <!-- Get current commander -->
        <do_if value="this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists and this.assignedcontrolled.commander != this.assignedcontrolled">
          <set_value name="$currentCommander" exact="this.assignedcontrolled.commander"/>
        </do_if>
        
        <!-- Check if ship is still a subordinate to SAME GT commander -->
        <!-- CRITICAL: Must check if commander is SAME (not just if commander exists) -->
        <do_if value="$currentDefaultOrder == 'Assist' and $currentCommander? and $currentCommander == $oldCommander">
          <set_value name="$isStillSubordinate" exact="true"/>
          <!-- If still subordinate to SAME commander, check if commander still has GT order -->
          <do_if value="$currentCommander.defaultorder? and @$currentCommander.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$stillHasGTCommander" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Trust the removal signal: If Assist order is aborting and ship was subordinate to GT commander, emit cleanup -->
        <!-- Only suppress if ship is STILL subordinate to SAME GT commander OR was reassigned/newly assigned to another GT commander -->
        <!-- CRITICAL: If commander changed OR commander lost GT order OR default order changed, subordinate was removed -->
        <!-- EXCEPTION: Newly assigned ships (had no commander, now have GT commander) should skip cleanup - Assist order will restart -->
        <do_if value="$wasSubordinateToGT and not $reassignedToGTCommander and not $newlyAssignedToGTCommander and not ($isStillSubordinate and $stillHasGTCommander)">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Assist order aborted (subordinate removed from GT commander) - triggering cleanup unconditionally'" chance="100"/>
          </do_if>
          
          <!-- Initialize state if missing -->
          <do_if value="not global.$GT_Ship_State?">
            <set_value name="global.$GT_Ship_State" exact="table[]"/>
          </do_if>
          <do_if value="not global.$GT_Ship_State.{this.assignedcontrolled}?">
            <set_value name="global.$GT_Ship_State.{this.assignedcontrolled}" exact="table[
              $OperationalState = 'orphaned',
              $SubordinateState = 'orphaned',
              $Commander = null,
              $CommanderHasGT = false,
              $HasGTOrder = false,
              $HasAssistOrder = false,
              $ActiveTradeOrders = 0,
              $LastStateUpdate = player.age
            ]"/>
          </do_if>
          
          <set_value name="$state" exact="global.$GT_Ship_State.{this.assignedcontrolled}"/>
          
          <!-- Update state -->
          <set_value name="$state.$HasGTOrder" exact="false"/>
          <set_value name="$state.$OperationalState" exact="'orphaned'"/>
          <set_value name="$state.$ActiveTradeOrders" exact="0"/>
          <set_value name="$state.$Commander" exact="null"/>
          <set_value name="$state.$CommanderHasGT" exact="false"/>
          <set_value name="$state.$SubordinateState" exact="'orphaned'"/>
          <set_value name="$state.$LastStateUpdate" exact="player.age"/>
          
          <!-- Send cleanup signals -->
          <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
            $Ship = this.assignedcontrolled,
            $UpdateType = 'GT_Order_Cancelled'
          ]"/>
          
          <!-- EVENT-DRIVEN: Trigger orphaned ship check for subordinate -->
          <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.assignedcontrolled}?">
            <signal_objects object="player.galaxy" param="'GT_Check_Ship_Orphaned'" param2="table[$Ship = this.assignedcontrolled]"/>
          </do_if>
          
          <set_value name="$pilot" exact="@this.assignedcontrolled.pilot"/>
          <set_value name="$originalName" exact="null"/>
          <do_if value="$pilot? and global.$GT_Pilots.{$pilot}? and global.$GT_Pilots.{$pilot}.$OriginalShipName?">
            <set_value name="$originalName" exact="global.$GT_Pilots.{$pilot}.$OriginalShipName"/>
          </do_if>
          <do_elseif value="$state.$OriginalShipName?">
            <set_value name="$originalName" exact="$state.$OriginalShipName"/>
          </do_elseif>
          <do_else>
            <set_value name="$originalName" exact="@this.assignedcontrolled.macro.name"/>
          </do_else>
          
          <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
            $Ship = this.assignedcontrolled,
            $Pilot = $pilot,
            $Reason = 'Assist order aborted - GT order lost - restoring original name',
            $OriginalName = $originalName
          ]"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Cleanup signals sent (on_abort handler)'" chance="100"/>
          </do_if>
        </do_if>
        <do_elseif value="$hasDirectGTOrder">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Ship has direct GT order - no cleanup needed'" chance="100"/>
          </do_if>
        </do_elseif>
        <do_elseif value="$reassignedToGTCommander">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Ship reassigned to new GT commander - no cleanup needed'" chance="100"/>
          </do_if>
        </do_elseif>
        <do_elseif value="$isStillSubordinate and $stillHasGTCommander">
          <!-- NORMAL RESTART: Default order is still "Assist" and commander still has GT order -->
          <!-- This is a normal Assist order restart - ship is still a valid subordinate -->
          <!-- FALLBACK: Schedule delayed verification as safety net if DetectSubordinateRemoval didn't fire -->
          <!-- If ship was actually removed, state might be stale - delayed verification will catch it -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Default order still Assist, commander still has GT - normal restart (scheduling delayed verification as fallback)'" chance="100"/>
          </do_if>
          
          <!-- Only schedule if ship was GT-controlled (fallback for when DetectSubordinateRemoval doesn't fire) -->
          <do_if value="$wasGTControlled and $oldCommanderHadGT">
            <!-- Initialize delayed verification registry if needed -->
            <do_if value="not global.$GT_DelayedVerification?">
              <set_value name="global.$GT_DelayedVerification" exact="table[]"/>
            </do_if>
            
            <!-- Signal MD system to perform delayed verification -->
            <signal_objects object="player.galaxy" param="'GT_Delayed_Verification'" param2="table[
              $Ship = this.assignedcontrolled,
              $CheckTime = player.age
            ]"/>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Scheduled delayed verification as fallback (DetectSubordinateRemoval may not have fired)'" chance="100"/>
            </do_if>
          </do_if>
        </do_elseif>
        <do_elseif value="$isStillSubordinate and not $stillHasGTCommander">
          <!-- DELAYED VERIFICATION: Default order is still "Assist" but commander no longer has GT order -->
          <!-- State might not have updated immediately - schedule delayed verification -->
          <!-- This catches cases where "remove all commands and orders" is used but default order hasn't changed yet -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Default order still Assist but commander lost GT order - scheduling delayed verification (5s)'" chance="100"/>
          </do_if>
          
          <!-- Initialize delayed verification registry if needed -->
          <do_if value="not global.$GT_DelayedVerification?">
            <set_value name="global.$GT_DelayedVerification" exact="table[]"/>
          </do_if>
          
          <!-- Schedule delayed verification (5 seconds) -->
          <set_value name="global.$GT_DelayedVerification.{this.assignedcontrolled}" exact="player.age + 5s"/>
          
          <!-- Signal MD system to perform delayed verification -->
          <signal_objects object="player.galaxy" param="'GT_Delayed_Verification'" param2="table[
            $Ship = this.assignedcontrolled,
            $CheckTime = player.age + 5s
          ]"/>
        </do_elseif>
        <do_else>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Ship not subordinate to GT commander (default order: ' + (if $currentDefaultOrder then $currentDefaultOrder else 'NONE') + ') - no cleanup needed'" chance="100"/>
          </do_if>
        </do_else>
      </do_if>
    </on_abort>
  </add>
</diff> 