<?xml version='1.0' encoding='utf-8'?>
<diff>
  <!-- GalaxyTrader MK3: Support for GT order inheritance by subordinates -->
  <add sel="/aiscript/attention/actions/do_if[@value='$order.exists or (@$orderdef and $createdefaultorder?)']/do_if[@value='(@$orderdef and $createdefaultorder?) or not $order.requiredskill or (this.combinedskill ge $order.requiredskill)']">
    <do_elseif value="$orderdef.$id == 'GalaxyTraderMK3'">
      <set_value name="$added"/>
      <do_if value="$createdefaultorder?">
        <create_order id="$orderdef.$id" object="this.assignedcontrolled" default="true">
          <param name="home" value="$orderdef.$home"/>
          <param name="maxbuy" value="$orderdef.$maxbuy"/>
          <param name="maxsell" value="$orderdef.$maxsell"/>
          <param name="autowares" value="$orderdef.$autowares"/>
          <param name="warebasket" value="$orderdef.$warebasket"/>
          <param name="allowillegal" value="$orderdef.$allowillegal"/>
          <param name="risktolerance" value="$orderdef.$risktolerance"/>
          <param name="distancepenalty" value="$orderdef.$distancepenalty"/>
          <param name="notifications" value="$orderdef.$notifications"/>
          <param name="cargotarget" value="$orderdef.$cargotarget"/>
          <param name="marketupdatefreq" value="$orderdef.$marketupdatefreq"/>
          <param name="debuglevel" value="$orderdef.$debuglevel"/>
          <param name="tradeeval" value="$orderdef.$tradeeval"/>
        </create_order>
      </do_if>
      <do_else>
        <set_value name="$orderdef.$home" exact="$order.$home"/>
        <set_value name="$orderdef.$maxbuy" exact="$order.$maxbuy"/>
        <set_value name="$orderdef.$maxsell" exact="$order.$maxsell"/>
        <set_value name="$orderdef.$autowares" exact="$order.$autowares"/>
        <set_value name="$orderdef.$warebasket" exact="$order.$warebasket"/>
        <set_value name="$orderdef.$allowillegal" exact="$order.$allowillegal"/>
        <set_value name="$orderdef.$risktolerance" exact="$order.$risktolerance"/>
        <set_value name="$orderdef.$distancepenalty" exact="$order.$distancepenalty"/>
        <set_value name="$orderdef.$notifications" exact="$order.$notifications"/>
        <set_value name="$orderdef.$cargotarget" exact="$order.$cargotarget"/>
        <set_value name="$orderdef.$marketupdatefreq" exact="$order.$marketupdatefreq"/>
        <set_value name="$orderdef.$debuglevel" exact="$order.$debuglevel"/>
        <set_value name="$orderdef.$tradeeval" exact="$order.$tradeeval"/>
        <run_script name="$scriptname">
          <param name="home" value="$order.$home"/>
          <param name="maxbuy" value="$order.$maxbuy"/>
          <param name="maxsell" value="$order.$maxsell"/>
          <param name="autowares" value="$order.$autowares"/>
          <param name="warebasket" value="$order.$warebasket"/>
          <param name="allowillegal" value="$order.$allowillegal"/>
          <param name="risktolerance" value="$order.$risktolerance"/>
          <param name="distancepenalty" value="$order.$distancepenalty"/>
          <param name="notifications" value="$order.$notifications"/>
          <param name="cargotarget" value="$order.$cargotarget"/>
          <param name="marketupdatefreq" value="$order.$marketupdatefreq"/>
          <param name="debuglevel" value="$order.$debuglevel"/>
          <param name="tradeeval" value="$order.$tradeeval"/>
        </run_script>
      </do_else>
    </do_elseif>
  </add>
  
  <!-- ✅ PHASE 7: Detect when subordinate is removed (no commander detected) -->
  <!-- When a subordinate is removed, Assist order detects no commander and cancels itself -->
  <!-- This is the perfect place to detect GT order removal for subordinates -->
  <add sel="//aiscript[@name='order.assist']/attention/actions/do_if[@value='not @this.assignedcontrolled.commander.isclass.ship']" pos="after">
    
    <!-- ✅ PHASE 7: Detect GT order removal when subordinate is removed -->
    <!-- When a subordinate is removed, Assist order detects no commander -->
    <!-- Check if this ship was previously registered with GT order (as subordinate) -->
    <do_if value="global.$GT_Ship_State? and global.$GT_Ship_State.{this.assignedcontrolled}?">
      <set_value name="$state" exact="global.$GT_Ship_State.{this.assignedcontrolled}"/>
      
      <!-- If state says ship was a subordinate, check if it was subordinate to GT commander -->
      <do_if value="$state.$SubordinateState? and $state.$SubordinateState == 'subordinate'">
        <!-- Ship was a subordinate - check if commander had GT order -->
        <set_value name="$wasSubordinateToGTCommander" exact="false"/>
        <do_if value="$state.$CommanderHasGT? and $state.$CommanderHasGT">
          <set_value name="$wasSubordinateToGTCommander" exact="true"/>
        </do_if>
        
        <!-- If ship was subordinate to GT commander and is now removed, restore name -->
        <do_if value="$wasSubordinateToGTCommander">
          <debug_text text="'[GT-State] Phase 7: ' + this.assignedcontrolled.idcode + ' - Subordinate removed from GT commander (detected in Assist order)'" chance="100"/>
          
          <!-- Update state to reflect GT order cancellation -->
          <set_value name="$state.$HasGTOrder" exact="false"/>
          <set_value name="$state.$OperationalState" exact="'orphaned'"/>
          <set_value name="$state.$ActiveTradeOrders" exact="0"/>
          <set_value name="$state.$Commander" exact="null"/>
          <set_value name="$state.$CommanderHasGT" exact="false"/>
          <set_value name="$state.$SubordinateState" exact="'orphaned'"/>
          <set_value name="$state.$LastStateUpdate" exact="player.age"/>
          
          <!-- ✅ MOD REMOVAL: Send GT_Ship_State_Update signal for mod removal system -->
          <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
            $Ship = this.assignedcontrolled,
            $UpdateType = 'GT_Order_Cancelled'
          ]"/>
          
          <!-- ✅ NAME RESTORATION: Restore ship name -->
          <set_value name="$hasDirectGTOrder" exact="false"/>
          <do_if value="this.assignedcontrolled.defaultorder? and @this.assignedcontrolled.defaultorder.id == 'GalaxyTraderMK3'">
            <set_value name="$hasDirectGTOrder" exact="true"/>
          </do_if>
          
          <do_if value="not $hasDirectGTOrder and this.assignedcontrolled.pilot?">
            <set_value name="$originalName" exact="null"/>
            <do_if value="$state.$OriginalShipName?">
              <set_value name="$originalName" exact="$state.$OriginalShipName"/>
            </do_if>
            <do_elseif value="global.$GT_Pilots? and global.$GT_Pilots.{this.assignedcontrolled.pilot}? and global.$GT_Pilots.{this.assignedcontrolled.pilot}.$OriginalShipName?">
              <set_value name="$originalName" exact="global.$GT_Pilots.{this.assignedcontrolled.pilot}.$OriginalShipName"/>
            </do_elseif>
            
            <do_if value="$originalName">
              <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
                $Ship = this.assignedcontrolled,
                $Pilot = this.assignedcontrolled.pilot,
                $Reason = 'Subordinate removed from GT commander - restoring original name',
                $OriginalName = $originalName
              ]"/>
              <debug_text text="'[GT-State] Phase 7: Name restoration signal sent for ' + this.assignedcontrolled.idcode + ' (removed from GT commander, original name: ' + $originalName + ')'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
      </do_if>
    </do_if>
    
  </add>
  
  <!-- ✅ FIX: Add null check for this.assignedcontrolled.order before accessing .isrunning (vanilla bug) -->
  <!-- Vanilla code at line 870 tries to access order.isrunning without checking if order is null -->
  <!-- This happens when Assist order is cancelled (e.g., when subordinate is removed) -->
  <!-- X4 doesn't short-circuit: must use nested do_if, not "and" expression -->
  <replace sel="//aiscript[@name='order.assist']/attention/actions/do_if[@value='this.assignedcontrolled.order.isrunning']">
    <do_if value="this.assignedcontrolled.order?">
      <do_if value="this.assignedcontrolled.order.isrunning">
        <set_order_syncpoint_reached order="this.assignedcontrolled.order"/>
      </do_if>
    </do_if>
  </replace>
</diff> 