<?xml version='1.0' encoding='utf-8'?>
<diff>
  <!-- GalaxyTrader MK3: Support for GT order inheritance by subordinates -->
  <add sel="/aiscript/attention/actions/do_if[@value='$order.exists or (@$orderdef and $createdefaultorder?)']/do_if[@value='(@$orderdef and $createdefaultorder?) or not $order.requiredskill or (this.combinedskill ge $order.requiredskill)']">
    <do_elseif value="$orderdef.$id == 'GalaxyTraderMK3'">
      <set_value name="$added"/>
      <do_if value="$createdefaultorder?">
        <create_order id="$orderdef.$id" object="this.assignedcontrolled" default="true">
          <param name="home" value="$orderdef.$home"/>
          <param name="maxbuy" value="$orderdef.$maxbuy"/>
          <param name="maxsell" value="$orderdef.$maxsell"/>
          <param name="autowares" value="$orderdef.$autowares"/>
          <param name="warebasket" value="$orderdef.$warebasket"/>
          <param name="allowillegal" value="$orderdef.$allowillegal"/>
          <param name="distancepenalty" value="$orderdef.$distancepenalty"/>
          <param name="notifications" value="$orderdef.$notifications"/>
          <param name="cargotarget" value="$orderdef.$cargotarget"/>
          <param name="marketupdatefreq" value="$orderdef.$marketupdatefreq"/>
          <param name="debuglevel" value="$orderdef.$debuglevel"/>
          <param name="tradeeval" value="$orderdef.$tradeeval"/>
        </create_order>
        <!-- SAFEST: Persist inherited GT params for PLAYER ships only (used to restore default order if promoted commander loses it) -->
        <do_if value="this.assignedcontrolled.isplayerowned">
          <do_if value="not global.$GT_Ships?">
            <set_value name="global.$GT_Ships" exact="table[]"/>
          </do_if>
          <do_if value="not global.$GT_Ships.{this.assignedcontrolled}?">
            <set_value name="global.$GT_Ships.{this.assignedcontrolled}" exact="table[]"/>
          </do_if>
          <set_value name="global.$GT_Ships.{this.assignedcontrolled}.$InheritedGTDefaultOrderParams" exact="table[
            $Home = $orderdef.$home,
            $MaxBuy = $orderdef.$maxbuy,
            $MaxSell = $orderdef.$maxsell,
            $AutoWares = $orderdef.$autowares,
            $WareBasket = $orderdef.$warebasket,
            $AllowIllegal = $orderdef.$allowillegal,
            $DistancePenalty = $orderdef.$distancepenalty,
            $Notifications = $orderdef.$notifications,
            $CargoTarget = $orderdef.$cargotarget,
            $MarketUpdateFreq = $orderdef.$marketupdatefreq,
            $DebugLevel = $orderdef.$debuglevel,
            $TradeEval = $orderdef.$tradeeval
          ]"/>
        </do_if>
      </do_if>
      <do_else>
        <set_value name="$orderdef.$home" exact="$order.$home"/>
        <set_value name="$orderdef.$maxbuy" exact="$order.$maxbuy"/>
        <set_value name="$orderdef.$maxsell" exact="$order.$maxsell"/>
        <set_value name="$orderdef.$autowares" exact="$order.$autowares"/>
        <set_value name="$orderdef.$warebasket" exact="$order.$warebasket"/>
        <set_value name="$orderdef.$allowillegal" exact="$order.$allowillegal"/>
        <set_value name="$orderdef.$distancepenalty" exact="$order.$distancepenalty"/>
        <set_value name="$orderdef.$notifications" exact="$order.$notifications"/>
        <set_value name="$orderdef.$cargotarget" exact="$order.$cargotarget"/>
        <set_value name="$orderdef.$marketupdatefreq" exact="$order.$marketupdatefreq"/>
        <set_value name="$orderdef.$debuglevel" exact="$order.$debuglevel"/>
        <set_value name="$orderdef.$tradeeval" exact="$order.$tradeeval"/>
        <!-- CRITICAL: Ensure subordinate is registered in GT_Ships when inheriting GT order -->
        <!-- This ensures detection works even if AI script doesn't register the ship -->
        <!-- PERFORMANCE: Optimized to reduce property lookups when many ships register simultaneously -->
        <do_if value="global.$GT_Ships?">
          <!-- Table exists - quick check if ship already registered -->
          <do_if value="not global.$GT_Ships.{this.assignedcontrolled}?">
            <set_value name="global.$GT_Ships.{this.assignedcontrolled}" exact="table[]"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Registered subordinate in GT_Ships registry (inheriting GT order from commander)'" chance="10"/>
            </do_if>
          </do_if>
        </do_if>
        <do_else>
          <!-- Table doesn't exist - initialize and register -->
          <set_value name="global.$GT_Ships" exact="table[]"/>
          <set_value name="global.$GT_Ships.{this.assignedcontrolled}" exact="table[]"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Registered subordinate in GT_Ships registry (inheriting GT order from commander)'" chance="10"/>
          </do_if>
        </do_else>

        <!-- SAFEST: Persist inherited GT params for PLAYER ships only (used to restore default order if promoted commander loses it) -->
        <do_if value="this.assignedcontrolled.isplayerowned and global.$GT_Ships? and global.$GT_Ships.{this.assignedcontrolled}?">
          <set_value name="global.$GT_Ships.{this.assignedcontrolled}.$InheritedGTDefaultOrderParams" exact="table[
            $Home = $order.$home,
            $MaxBuy = $order.$maxbuy,
            $MaxSell = $order.$maxsell,
            $AutoWares = $order.$autowares,
            $WareBasket = $order.$warebasket,
            $AllowIllegal = $order.$allowillegal,
            $DistancePenalty = $order.$distancepenalty,
            $Notifications = $order.$notifications,
            $CargoTarget = $order.$cargotarget,
            $MarketUpdateFreq = $order.$marketupdatefreq,
            $DebugLevel = $order.$debuglevel,
            $TradeEval = $order.$tradeeval
          ]"/>
        </do_if>
        
        <run_script name="$scriptname">
          <param name="home" value="$order.$home"/>
          <param name="maxbuy" value="$order.$maxbuy"/>
          <param name="maxsell" value="$order.$maxsell"/>
          <param name="autowares" value="$order.$autowares"/>
          <param name="warebasket" value="$order.$warebasket"/>
          <param name="allowillegal" value="$order.$allowillegal"/>
          <param name="distancepenalty" value="$order.$distancepenalty"/>
          <param name="notifications" value="$order.$notifications"/>
          <param name="cargotarget" value="$order.$cargotarget"/>
          <param name="marketupdatefreq" value="$order.$marketupdatefreq"/>
          <param name="debuglevel" value="$order.$debuglevel"/>
          <param name="tradeeval" value="$order.$tradeeval"/>
        </run_script>
      </do_else>
    </do_elseif>
    <do_elseif value="$orderdef.$id == 'GalaxyTraderMK2'">
      <set_value name="$added"/>
      <do_if value="$createdefaultorder?">
        <create_order id="$orderdef.$id" object="this.assignedcontrolled" default="true">
          <param name="sourceStation" value="$orderdef.$sourceStation"/>
          <param name="sourceList" value="$orderdef.$sourceList"/>
          <param name="homeStation" value="null"/>
          <param name="destList" value="$orderdef.$destList"/>
          <param name="minStorage" value="$orderdef.$minStorage"/>
          <param name="staticStorage" value="$orderdef.$staticStorage"/>
          <param name="maxStorage" value="$orderdef.$maxStorage"/>
          <param name="autowares" value="$orderdef.$autowares"/>
          <param name="warebasket" value="$orderdef.$warebasket"/>
          <param name="ignoretraderules" value="$orderdef.$ignoretraderules"/>
          <param name="allowillegal" value="$orderdef.$allowillegal"/>
          <param name="bidirectional" value="$orderdef.$bidirectional"/>
          <param name="maxDistance" value="$orderdef.$maxDistance"/>
          <param name="fleetcoordination" value="$orderdef.$fleetcoordination"/>
          <param name="notifications" value="$orderdef.$notifications"/>
          <param name="debuglevel" value="$orderdef.$debuglevel"/>
        </create_order>
      </do_if>
      <do_else>
        <set_value name="$orderdef.$sourceStation" exact="$order.$sourceStation"/>
        <set_value name="$orderdef.$sourceList" exact="$order.$sourceList"/>
        <set_value name="$orderdef.$homeStation" exact="null"/>
        <set_value name="$orderdef.$destList" exact="$order.$destList"/>
        <set_value name="$orderdef.$minStorage" exact="$order.$minStorage"/>
        <set_value name="$orderdef.$staticStorage" exact="$order.$staticStorage"/>
        <set_value name="$orderdef.$maxStorage" exact="$order.$maxStorage"/>
        <set_value name="$orderdef.$autowares" exact="$order.$autowares"/>
        <set_value name="$orderdef.$warebasket" exact="$order.$warebasket"/>
        <set_value name="$orderdef.$ignoretraderules" exact="$order.$ignoretraderules"/>
        <set_value name="$orderdef.$allowillegal" exact="$order.$allowillegal"/>
        <set_value name="$orderdef.$bidirectional" exact="$order.$bidirectional"/>
        <set_value name="$orderdef.$maxDistance" exact="$order.$maxDistance"/>
        <set_value name="$orderdef.$fleetcoordination" exact="$order.$fleetcoordination"/>
        <set_value name="$orderdef.$notifications" exact="$order.$notifications"/>
        <set_value name="$orderdef.$debuglevel" exact="$order.$debuglevel"/>
        <run_script name="$scriptname">
          <param name="sourceStation" value="$order.$sourceStation"/>
          <param name="sourceList" value="$order.$sourceList"/>
          <param name="homeStation" value="null"/>
          <param name="destList" value="$order.$destList"/>
          <param name="minStorage" value="$order.$minStorage"/>
          <param name="staticStorage" value="$order.$staticStorage"/>
          <param name="maxStorage" value="$order.$maxStorage"/>
          <param name="autowares" value="$order.$autowares"/>
          <param name="warebasket" value="$order.$warebasket"/>
          <param name="ignoretraderules" value="$order.$ignoretraderules"/>
          <param name="allowillegal" value="$order.$allowillegal"/>
          <param name="bidirectional" value="$order.$bidirectional"/>
          <param name="maxDistance" value="$order.$maxDistance"/>
          <param name="fleetcoordination" value="$order.$fleetcoordination"/>
          <param name="notifications" value="$order.$notifications"/>
          <param name="debuglevel" value="$order.$debuglevel"/>
        </run_script>
      </do_else>
    </do_elseif>
  </add>

  <!-- SAFEST: If a GT-managed PLAYER ship is promoted to commander but loses its default order,
       restore it from cached inherited params so subordinates can inherit again. -->
  <add sel="//aiscript[@name='order.assist']/attention/actions/do_if[@value='not $added?']/debug_text[@filter='error' and contains(@text, 'default order not inherited from commander.')]" pos="before">
    <!-- IMPORTANT: Do NOT rely on a local $commander variable existing in this scope.
         Always derive the commander from the subordinate ship (this matches the vanilla error case). -->
    <!-- DEBUG: Log that we're attempting to fix the promotion window issue -->
    <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
      <debug_text text="'[GT-Assist] PROMOTION FIX: Attempting to restore default order for promoted commander (subordinate: ' + this.assignedcontrolled.idcode + ')'" chance="100"/>
    </do_if>
    <set_value name="$gtCommander" exact="@this.assignedcontrolled.commander"/>
    <do_if value="$gtCommander? and $gtCommander.exists and $gtCommander.isplayerowned">
      <!-- DEBUG: Log commander details -->
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <set_value name="$defaultOrderExists" exact="false"/>
        <set_value name="$defaultOrderId" exact="'null'"/>
        <do_if value="$gtCommander.defaultorder?">
          <set_value name="$defaultOrderExists" exact="true"/>
          <do_if value="@$gtCommander.defaultorder != null">
            <set_value name="$defaultOrderId" exact="@$gtCommander.defaultorder.id"/>
          </do_if>
        </do_if>
        <debug_text text="'[GT-Assist] PROMOTION FIX: Commander found: ' + $gtCommander.idcode + ', defaultorder exists: ' + (if $defaultOrderExists then 'yes' else 'no') + ', defaultorder value: ' + $defaultOrderId" chance="100"/>
      </do_if>
      <!-- Commander has no actionable default order (promotion window) -->
      <!-- CRITICAL FIX: Check both existence and null value properly -->
      <set_value name="$commanderHasDefaultOrder" exact="false"/>
      <do_if value="$gtCommander.defaultorder?">
        <do_if value="@$gtCommander.defaultorder != null">
          <set_value name="$commanderHasDefaultOrder" exact="true"/>
        </do_if>
      </do_if>
      <do_if value="not $commanderHasDefaultOrder">
        <!-- SAFEST: Restore from cached GT params with multiple fallbacks.
             Fallback chain:
             1. Promoted commander's own cached params (it was a subordinate moments ago)
             2. THIS subordinate's cached params
             3. ANY other subordinate's cached params (they all inherited from destroyed commander)
             4. GT_AIParameters for commander (if available)
             5. Default values derived from commander's properties -->
        <set_value name="$gtParams" exact="null"/>
        <set_value name="$paramsSource" exact="'none'"/>
        
        <!-- Fallback 1: Commander's own cached params -->
        <do_if value="not $gtParams? and global.$GT_Ships? and global.$GT_Ships.{$gtCommander}? and global.$GT_Ships.{$gtCommander}.$InheritedGTDefaultOrderParams?">
          <set_value name="$gtParams" exact="global.$GT_Ships.{$gtCommander}.$InheritedGTDefaultOrderParams"/>
          <set_value name="$paramsSource" exact="'commander_own'"/>
        </do_if>
        
        <!-- Fallback 2: THIS subordinate's cached params -->
        <do_if value="not $gtParams? and global.$GT_Ships? and global.$GT_Ships.{this.assignedcontrolled}? and global.$GT_Ships.{this.assignedcontrolled}.$InheritedGTDefaultOrderParams?">
          <set_value name="$gtParams" exact="global.$GT_Ships.{this.assignedcontrolled}.$InheritedGTDefaultOrderParams"/>
          <set_value name="$paramsSource" exact="'this_subordinate'"/>
        </do_if>
        
        <!-- Fallback 3: Check commander's OTHER subordinates for cached params (they all inherited from destroyed commander) -->
        <do_if value="not $gtParams? and $gtCommander.allsubordinates?">
          <set_value name="$commanderSubordinates" exact="@$gtCommander.allsubordinates"/>
          <do_if value="(if $commanderSubordinates != null then $commanderSubordinates.count else 0) gt 0">
            <do_all exact="$commanderSubordinates.count" counter="$subIdx">
              <set_value name="$otherSubordinate" exact="$commanderSubordinates.{$subIdx}"/>
              <do_if value="not $gtParams? and $otherSubordinate.exists and global.$GT_Ships? and global.$GT_Ships.{$otherSubordinate}? and global.$GT_Ships.{$otherSubordinate}.$InheritedGTDefaultOrderParams?">
                <set_value name="$gtParams" exact="global.$GT_Ships.{$otherSubordinate}.$InheritedGTDefaultOrderParams"/>
                <set_value name="$paramsSource" exact="'other_subordinate'"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>
        </do_if>
        
        <!-- Fallback 4: Check GT_AIParameters for commander (if it has a HomeBase, we can derive params) -->
        <do_if value="not $gtParams? and global.$GT_AIParameters? and global.$GT_AIParameters.{$gtCommander}? and global.$GT_AIParameters.{$gtCommander}.$HomeBase?">
          <set_value name="$homeBase" exact="global.$GT_AIParameters.{$gtCommander}.$HomeBase"/>
          <set_value name="$homeSector" exact="null"/>
          <do_if value="$homeBase.exists">
            <do_if value="$homeBase.isclass.station">
              <set_value name="$homeSector" exact="$homeBase.sector"/>
            </do_if>
            <do_elseif value="$homeBase.isclass.sector">
              <set_value name="$homeSector" exact="$homeBase"/>
            </do_elseif>
          </do_if>
          <do_if value="$homeSector? and $homeSector.exists">
            <!-- Build minimal params from GT_AIParameters -->
            <set_value name="$gtParams" exact="table[
              $Home = $homeSector,
              $MaxBuy = if global.$GT_AIParameters.{$gtCommander}.$MaxBuy? then global.$GT_AIParameters.{$gtCommander}.$MaxBuy else 100,
              $MaxSell = if global.$GT_AIParameters.{$gtCommander}.$MaxSell? then global.$GT_AIParameters.{$gtCommander}.$MaxSell else 100,
              $AutoWares = if global.$GT_AIParameters.{$gtCommander}.$AutoWares? then global.$GT_AIParameters.{$gtCommander}.$AutoWares else true,
              $WareBasket = if global.$GT_AIParameters.{$gtCommander}.$WareBasket? then global.$GT_AIParameters.{$gtCommander}.$WareBasket else [],
              $AllowIllegal = if global.$GT_AIParameters.{$gtCommander}.$AllowIllegal? then global.$GT_AIParameters.{$gtCommander}.$AllowIllegal else false,
              $DistancePenalty = if global.$GT_AIParameters.{$gtCommander}.$DistancePenalty? then global.$GT_AIParameters.{$gtCommander}.$DistancePenalty else 0.1,
              $Notifications = if global.$GT_AIParameters.{$gtCommander}.$Notifications? then global.$GT_AIParameters.{$gtCommander}.$Notifications else true,
              $CargoTarget = if global.$GT_AIParameters.{$gtCommander}.$CargoTarget? then global.$GT_AIParameters.{$gtCommander}.$CargoTarget else 0.9,
              $MarketUpdateFreq = if global.$GT_AIParameters.{$gtCommander}.$MarketUpdateFreq? then global.$GT_AIParameters.{$gtCommander}.$MarketUpdateFreq else 300,
              $DebugLevel = if global.$GT_AIParameters.{$gtCommander}.$DebugLevel? then global.$GT_AIParameters.{$gtCommander}.$DebugLevel else 1,
              $TradeEval = if global.$GT_AIParameters.{$gtCommander}.$TradeEval? then global.$GT_AIParameters.{$gtCommander}.$TradeEval else 'profit'
            ]"/>
            <set_value name="$paramsSource" exact="'gt_aiparameters'"/>
          </do_if>
        </do_if>
        
        <!-- Fallback 5: Use default values derived from commander's properties -->
        <do_if value="not $gtParams?">
          <set_value name="$defaultHome" exact="null"/>
          <!-- Use commander's current sector as last resort (defaultorder is null, so can't use it) -->
          <do_if value="$gtCommander.sector?">
            <set_value name="$defaultHome" exact="$gtCommander.sector"/>
          </do_if>
          <do_if value="$defaultHome? and $defaultHome.exists">
            <set_value name="$gtParams" exact="table[
              $Home = $defaultHome,
              $MaxBuy = 100,
              $MaxSell = 100,
              $AutoWares = true,
              $WareBasket = [],
              $AllowIllegal = false,
              $DistancePenalty = 0.1,
              $Notifications = true,
              $CargoTarget = 0.9,
              $MarketUpdateFreq = 300,
              $DebugLevel = 1,
              $TradeEval = 'profit'
            ]"/>
            <set_value name="$paramsSource" exact="'defaults'"/>
          </do_if>
        </do_if>
        
        <!-- Create order if we found params -->
        <do_if value="$gtParams? and $gtParams != null and $gtParams.$Home?">
            <create_order id="'GalaxyTraderMK3'" object="$gtCommander" default="true">
              <param name="home" value="$gtParams.$Home"/>
              <param name="maxbuy" value="$gtParams.$MaxBuy"/>
              <param name="maxsell" value="$gtParams.$MaxSell"/>
              <param name="autowares" value="$gtParams.$AutoWares"/>
              <param name="warebasket" value="$gtParams.$WareBasket"/>
              <param name="allowillegal" value="$gtParams.$AllowIllegal"/>
              <param name="distancepenalty" value="$gtParams.$DistancePenalty"/>
              <param name="notifications" value="$gtParams.$Notifications"/>
              <param name="cargotarget" value="$gtParams.$CargoTarget"/>
              <param name="marketupdatefreq" value="$gtParams.$MarketUpdateFreq"/>
              <param name="debuglevel" value="$gtParams.$DebugLevel"/>
              <param name="tradeeval" value="$gtParams.$TradeEval"/>
            </create_order>
            <!-- Optional: ensure commander is registered (doesn't change behavior, just preserves data) -->
            <do_if value="not global.$GT_Ships.{$gtCommander}?">
              <set_value name="global.$GT_Ships.{$gtCommander}" exact="table[]"/>
            </do_if>
            <set_value name="global.$GT_Ships.{$gtCommander}.$InheritedGTDefaultOrderParams" exact="$gtParams"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ': Restored missing default GT order on promoted commander ' + $gtCommander.idcode + ' (promotion window; source: ' + $paramsSource + ')'" chance="100"/>
            </do_if>
            <!-- Restart assist evaluation now that commander has an actionable default order -->
            <resume label="init"/>
        </do_if>
        <do_else>
          <!-- Log if we couldn't restore order -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] WARNING: ' + this.assignedcontrolled.idcode + ': Could not restore default GT order on promoted commander ' + $gtCommander.idcode + ' (no cached params found)'" chance="100"/>
          </do_if>
        </do_else>
      </do_if>
      <!-- End: Commander has no default order -->
    </do_if>
    <!-- End: Commander exists and is player owned -->
    <do_else>
      <!-- DEBUG: Log why we're not fixing -->
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <set_value name="$gtCommanderCheck" exact="@this.assignedcontrolled.commander"/>
        <debug_text text="'[GT-Assist] PROMOTION FIX: Skipping fix - commander check failed (commander exists: ' + (if $gtCommanderCheck? and $gtCommanderCheck.exists then 'yes' else 'no') + ', is player owned: ' + (if $gtCommanderCheck? and $gtCommanderCheck.exists and $gtCommanderCheck.isplayerowned then 'yes' else 'no') + ')'" chance="100"/>
      </do_if>
    </do_else>
  </add>
  
  <!-- PHASE 7: Detect when subordinate is removed (no commander detected) -->
  <!-- When a subordinate is removed, Assist order detects no commander and cancels itself -->
  <!-- This is the perfect place to detect GT order removal for subordinates -->
  <add sel="//aiscript[@name='order.assist']/attention/actions/do_if[@value='not @this.assignedcontrolled.commander.isclass.ship']" pos="after">
    
    <!-- PHASE 7: Detect GT order removal when subordinate is removed -->
    <!-- CRITICAL: This patch triggers when commander.isclass.ship is false -->
    <!-- This can mean: 1) Commander doesn't exist (removed), OR 2) Commander is station/buildstorage (still subordinate!) -->
    <!-- We must ONLY trigger if commander was actually REMOVED, not if commander is just a station -->
    
    <!-- CRITICAL FIX: Check if commander actually exists before processing -->
    <!-- If commander exists (even if not a ship), ship is still subordinate - don't trigger removal -->
    <set_value name="$commanderExists" exact="false"/>
    <do_if value="this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists">
      <set_value name="$commanderExists" exact="true"/>
    </do_if>
    
    <!-- Only process if commander was actually removed (doesn't exist) -->
    <do_if value="not $commanderExists">
      <!-- FIX 2: State-independent cleanup - check commander directly, initialize state if needed -->
      
      <!-- Initialize state registry if missing -->
      <do_if value="not global.$GT_Ship_State?">
        <set_value name="global.$GT_Ship_State" exact="table[]"/>
      </do_if>
      
      <!-- Initialize ship state if missing (lazy initialization) -->
      <do_if value="not global.$GT_Ship_State.{this.assignedcontrolled}?">
        <set_value name="global.$GT_Ship_State.{this.assignedcontrolled}" exact="table[
          $OperationalState = 'idle',
          $SubordinateState = 'independent',
          $Commander = null,
          $CommanderHasGT = false,
          $HasGTOrder = false,
          $HasAssistOrder = false,
          $ActiveTradeOrders = 0,
          $LastStateUpdate = player.age,
          $MacroShipName = null,
          $OriginalShipName = null
        ]"/>
      </do_if>
      
      <set_value name="$state" exact="global.$GT_Ship_State.{this.assignedcontrolled}"/>
      
      <!-- CRITICAL FIX: Check if ship is being newly assigned to a commander -->
      <!-- During assignment transition, commander might not be detected yet, but ship might have been idle before -->
      <!-- Get old commander from state (if tracked) -->
      <set_value name="$oldCommander" exact="null"/>
      <do_if value="$state.$Commander? and $state.$Commander.exists">
        <set_value name="$oldCommander" exact="$state.$Commander"/>
      </do_if>
      
      <!-- Check if ship is being newly assigned (had no commander before, now has one) -->
      <set_value name="$newlyAssignedToCommander" exact="false"/>
      <do_if value="(not $oldCommander.exists or $oldCommander == null) and this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists">
        <set_value name="$newlyAssignedToCommander" exact="true"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - NEWLY ASSIGNED to commander ' + this.assignedcontrolled.commander.idcode + ' (was idle before) - skipping cleanup'" chance="100"/>
        </do_if>
      </do_if>
      
      <!-- Only proceed if ship was NOT newly assigned -->
      <do_if value="not $newlyAssignedToCommander">
        <!-- Check if ship was subordinate to GT commander (commander was removed) -->
        <set_value name="$wasSubordinateToGTCommander" exact="false"/>
        
        <!-- Method 1: Check state (if it was tracked) -->
        <do_if value="$state.$SubordinateState? and $state.$SubordinateState == 'subordinate'">
          <do_if value="$state.$CommanderHasGT? and $state.$CommanderHasGT">
            <set_value name="$wasSubordinateToGTCommander" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Method 2: PRIMARY CHECK - Ship is in GT_Ships registry (indicates it was GT-controlled) -->
        <!-- ALL ships with GT orders are in global.$GT_Ships, regardless of modifications -->
        <do_if value="not $wasSubordinateToGTCommander and global.$GT_Ships? and global.$GT_Ships.{this.assignedcontrolled}?">
          <set_value name="$wasSubordinateToGTCommander" exact="true"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Ship is in GT_Ships registry - treating as GT subordinate removal'" chance="100"/>
          </do_if>
        </do_if>
        
        <!-- If ship was subordinate to GT commander and is now removed, restore name and send cancellation signal -->
        <do_if value="$wasSubordinateToGTCommander">
        <!-- CRITICAL FIX: Check if ship still has GT order (direct or via new commander) BEFORE sending cancellation -->
        <!-- Ship might have been reassigned to another GT commander or got direct GT order -->
        <set_value name="$stillHasGTOrder" exact="false"/>
        
        <!-- Check 1: Direct GT order -->
        <do_if value="this.assignedcontrolled.defaultorder? and (@this.assignedcontrolled.defaultorder.id == 'GalaxyTraderMK3' or @this.assignedcontrolled.defaultorder.id == 'GalaxyTraderMK2')">
          <set_value name="$stillHasGTOrder" exact="true"/>
        </do_if>
        
        <!-- Check 2: Subordinate to GT commander (new commander) -->
        <do_if value="not $stillHasGTOrder and this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists and this.assignedcontrolled.commander != this.assignedcontrolled">
          <do_if value="this.assignedcontrolled.commander.defaultorder? and (@this.assignedcontrolled.commander.defaultorder.id == 'GalaxyTraderMK3' or @this.assignedcontrolled.commander.defaultorder.id == 'GalaxyTraderMK2')">
            <set_value name="$stillHasGTOrder" exact="true"/>
          </do_if>
        </do_if>
      
        <!-- Only send cancellation signal if ship NO LONGER has GT order -->
        <do_if value="not $stillHasGTOrder">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-State] Phase 7: ' + this.assignedcontrolled.idcode + ' - Subordinate removed from GT commander (detected in Assist order) - GT order truly cancelled'" chance="100"/>
          </do_if>
          
          <!-- Update state to reflect GT order cancellation -->
          <set_value name="$state.$HasGTOrder" exact="false"/>
          <set_value name="$state.$OperationalState" exact="'orphaned'"/>
          <set_value name="$state.$ActiveTradeOrders" exact="0"/>
          <set_value name="$state.$Commander" exact="null"/>
          <set_value name="$state.$CommanderHasGT" exact="false"/>
          <set_value name="$state.$SubordinateState" exact="'orphaned'"/>
          <set_value name="$state.$LastStateUpdate" exact="player.age"/>
          
          <!-- MOD REMOVAL: Send GT_Ship_State_Update signal for mod removal system -->
          <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
            $Ship = this.assignedcontrolled,
            $UpdateType = 'GT_Order_Cancelled'
          ]"/>
          
            <!-- EVENT-DRIVEN: Trigger orphaned ship check for subordinate -->
            <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.assignedcontrolled}?">
              <signal_objects object="player.galaxy" param="'GT_Check_Ship_Orphaned'" param2="table[$Ship = this.assignedcontrolled]"/>
            </do_if>
        </do_if>
        <do_else>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-State] Phase 7: ' + this.assignedcontrolled.idcode + ' - Subordinate removed from GT commander BUT ship still has GT order (direct or via new commander) - NOT sending cancellation'" chance="100"/>
          </do_if>
        </do_else>
        </do_if>
      <!-- End: Only proceed if ship was NOT newly assigned -->
      </do_if>
      
      <!-- NAME RESTORATION: Restore ship name (only if no GT order) -->
      <set_value name="$hasDirectGTOrder" exact="false"/>
      <do_if value="this.assignedcontrolled.defaultorder? and (@this.assignedcontrolled.defaultorder.id == 'GalaxyTraderMK3' or @this.assignedcontrolled.defaultorder.id == 'GalaxyTraderMK2')">
        <set_value name="$hasDirectGTOrder" exact="true"/>
      </do_if>
      
      <do_if value="not $hasDirectGTOrder and this.assignedcontrolled.pilot?">
        <set_value name="$originalName" exact="null"/>
        <do_if value="$state.$OriginalShipName?">
          <set_value name="$originalName" exact="$state.$OriginalShipName"/>
        </do_if>
        <do_elseif value="global.$GT_Pilots? and global.$GT_Pilots.{this.assignedcontrolled.pilot}? and global.$GT_Pilots.{this.assignedcontrolled.pilot}.$OriginalShipName?">
          <set_value name="$originalName" exact="global.$GT_Pilots.{this.assignedcontrolled.pilot}.$OriginalShipName"/>
        </do_elseif>
        
        <do_if value="$originalName">
          <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
            $Ship = this.assignedcontrolled,
            $Pilot = this.assignedcontrolled.pilot,
            $Reason = 'Subordinate removed from GT commander - restoring original name',
            $OriginalName = $originalName
          ]"/>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-State] Phase 7: Name restoration signal sent for ' + this.assignedcontrolled.idcode + ' (removed from GT commander, original name: ' + $originalName + ')'" chance="100"/>
          </do_if>
        </do_if>
      </do_if>
    </do_if>
    <!-- End: Only process if commander was actually removed -->
    
  </add>
  
  <!-- FIX: Add null check for this.assignedcontrolled.order before accessing .isrunning (vanilla bug) -->
  <!-- Vanilla code has multiple instances of order.isrunning without null check -->
  <!-- Instance 1: Line 853 - after "not $added?" check -->
  <!-- Note: Selector uses contains() to match the value with "and" operator -->
  <replace sel="//aiscript[@name='order.assist']/attention/actions/do_if[@value='not $added?']/do_if[contains(@value, 'this.assignedcontrolled.order.isrunning')]">
    <do_if value="$failurereason?">
      <do_if value="this.assignedcontrolled.order?">
        <do_if value="this.assignedcontrolled.order.isrunning">
          <set_order_failed order="this.assignedcontrolled.order" text="$failurereason"/>
        </do_if>
      </do_if>
    </do_if>
  </replace>
  
  <!-- Instance 2: Line 870 - after remove_value $added, before wait -->
  <!-- Use a more specific path that includes context -->
  <replace sel="//aiscript[@name='order.assist']/attention/actions/remove_value[@name='$added']/following-sibling::*[1][self::do_if[@value='this.assignedcontrolled.order.isrunning']]">
    <do_if value="this.assignedcontrolled.order?">
      <do_if value="@this.assignedcontrolled.order.isrunning">
        <set_order_syncpoint_reached order="this.assignedcontrolled.order"/>
      </do_if>
    </do_if>
  </replace>
  
  <!-- PHASE 7: Detect when Assist order is aborted (catches "remove all commands and orders") -->
  <!-- When Assist order terminates, check if subordinate was GT-controlled and trigger cleanup -->
  <add sel="//aiscript[@name='order.assist']/attention" pos="after">
    <on_abort>
      <!-- PERFORMANCE FIX: Early exit check BEFORE any logging or property lookups -->
      <!-- If ship is not GT-controlled, exit immediately to prevent stutter -->
      <set_value name="$isGTControlled" exact="false"/>
      
      <!-- Quick check: Is ship in GT_Ships registry? -->
      <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.assignedcontrolled}?">
        <set_value name="$isGTControlled" exact="true"/>
      </do_if>
      
      <!-- Fallback check: Is ship tracked as subordinate to GT commander? -->
      <do_if value="not $isGTControlled and global.$GT_Ship_State? and global.$GT_Ship_State.{this.assignedcontrolled}?">
        <set_value name="$state" exact="global.$GT_Ship_State.{this.assignedcontrolled}"/>
        <do_if value="$state.$SubordinateState? and $state.$SubordinateState == 'subordinate'">
          <do_if value="$state.$CommanderHasGT? and $state.$CommanderHasGT">
            <set_value name="$isGTControlled" exact="true"/>
          </do_if>
        </do_if>
      </do_if>
      
      <!-- EARLY EXIT: If ship is not GT-controlled, exit immediately without any processing -->
      <do_if value="not $isGTControlled">
        <!-- Ship is not GT-controlled - no cleanup needed, exit silently -->
        <!-- This prevents stutter from constant property lookups for non-GT ships -->
        <return/>
      </do_if>
      
      <!-- Ship IS GT-controlled - proceed with cleanup logic -->
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Assist order aborted - checking if GT cleanup needed'" chance="100"/>
      </do_if>
      
      <!-- Check if ship was GT-controlled (is in GT_Ships registry) -->
      <!-- ALL ships with GT orders are in global.$GT_Ships, regardless of modifications -->
      <set_value name="$needsCleanup" exact="false"/>
      <set_value name="$wasGTControlled" exact="true"/>  <!-- Already confirmed above -->
      
      <!-- Initialize state registry reference for debug logging -->
      <set_value name="$state" exact="null"/>
      <do_if value="global.$GT_Ship_State? and global.$GT_Ship_State.{this.assignedcontrolled}?">
        <set_value name="$state" exact="global.$GT_Ship_State.{this.assignedcontrolled}"/>
      </do_if>
      
      <!-- PRIMARY CHECK: Ship is in GT_Ships registry (indicates it was GT-controlled) -->
      <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.assignedcontrolled}?">
        <set_value name="$wasGTControlled" exact="true"/>
        <set_value name="$needsCleanup" exact="true"/>
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Ship is in GT_Ships registry - was GT-controlled'" chance="100"/>
        </do_if>
      </do_if>
      
      <!-- FALLBACK: Check state registry (if ship was tracked as subordinate) -->
      <do_if value="not $wasGTControlled and $state?">
        <do_if value="$state.$SubordinateState? and $state.$SubordinateState == 'subordinate'">
          <do_if value="$state.$CommanderHasGT? and $state.$CommanderHasGT">
            <set_value name="$wasGTControlled" exact="true"/>
            <set_value name="$needsCleanup" exact="true"/>
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Ship was tracked as subordinate to GT commander - needs cleanup'" chance="100"/>
            </do_if>
          </do_if>
        </do_if>
      </do_if>
      
      <!-- If cleanup needed, trust the removal signal -->
      <!-- CRITICAL: Assist order aborting means subordinate was removed -->
      <!-- COMPREHENSIVE DEBUG LOGGING: Ship state and orders at removal detection -->
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <set_value name="$debugShip" exact="this.assignedcontrolled"/>
        <set_value name="$debugDefaultOrder" exact="@$debugShip.defaultorder.id"/>
        <set_value name="$debugCommander" exact="@$debugShip.commander"/>
        <set_value name="$debugCommanderId" exact="if @$debugCommander.exists then @$debugCommander.idcode else 'NONE'"/>
        <set_value name="$debugCommanderOrder" exact="if @$debugCommander.exists and @$debugCommander.defaultorder != null then @$debugCommander.defaultorder.id else 'NONE'"/>
        <set_value name="$debugPilot" exact="@$debugShip.pilot"/>
        <set_value name="$debugPilotName" exact="if $debugPilot != null then @$debugPilot.knownname else 'NONE'"/>
        
        <!-- Build orders list -->
        <set_value name="$debugOrdersList" exact="[]"/>
        <set_value name="$debugOrdersCount" exact="$debugShip.orders.count"/>
        <do_all exact="$debugOrdersCount" counter="$i">
          <set_value name="$orderId" exact="@$debugShip.orders.{$i}.id"/>
          <append_to_list name="$debugOrdersList" exact="if $orderId then $orderId else 'UNKNOWN'"/>
        </do_all>
        <set_value name="$debugOrdersStr" exact="if $debugOrdersList.count gt 0 then $debugOrdersList.{1} + (if $debugOrdersList.count gt 1 then ', ' + $debugOrdersList.{2} else '') + (if $debugOrdersList.count gt 2 then ', ' + $debugOrdersList.{3} else '') + (if $debugOrdersList.count gt 3 then ', ' + $debugOrdersList.{4} else '') + (if $debugOrdersList.count gt 4 then ', ...' else '') else 'NONE'"/>
        
        <!-- Check GT order status -->
        <set_value name="$debugHasDirectGT" exact="false"/>
        <do_if value="$debugDefaultOrder == 'GalaxyTraderMK3' or $debugDefaultOrder == 'GalaxyTraderMK2'">
          <set_value name="$debugHasDirectGT" exact="true"/>
        </do_if>
        <set_value name="$debugHasGTCommander" exact="false"/>
        <do_if value="@$debugCommander.exists and ($debugCommanderOrder == 'GalaxyTraderMK3' or $debugCommanderOrder == 'GalaxyTraderMK2')">
          <set_value name="$debugHasGTCommander" exact="true"/>
        </do_if>
        
        <!-- Check if in GT_Ships registry -->
        <set_value name="$debugInRegistry" exact="global.$GT_Ships? and global.$GT_Ships.{$debugShip}?"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-Assist] REMOVAL DETECTION DEBUG: ' + $debugShip.idcode + ' - COMPREHENSIVE STATE'" chance="100"/>
          <debug_text text="'[GT-Assist]   Ship: ' + $debugShip.idcode + ' (' + (if $debugShip.knownname then $debugShip.knownname else 'UNNAMED') + ')'" chance="100"/>
          <debug_text text="'[GT-Assist]   Pilot: ' + $debugPilotName + (if $debugPilot? then ' (exists)' else ' (NONE)')" chance="100"/>
          <debug_text text="'[GT-Assist]   Default Order: ' + (if $debugDefaultOrder then $debugDefaultOrder else 'NONE')" chance="100"/>
          <debug_text text="'[GT-Assist]   Active Orders (' + $debugOrdersCount + '): ' + $debugOrdersStr" chance="100"/>
          <debug_text text="'[GT-Assist]   Commander: ' + $debugCommanderId + ' (Order: ' + $debugCommanderOrder + ')'" chance="100"/>
          <debug_text text="'[GT-Assist]   GT Status: Direct=' + $debugHasDirectGT + ', ViaCommander=' + $debugHasGTCommander + ', InRegistry=' + $debugInRegistry" chance="100"/>
          <set_value name="$debugSubordinateState" exact="'NONE'"/>
          <set_value name="$debugCommanderHasGT" exact="'NONE'"/>
          <do_if value="$state?">
            <set_value name="$debugSubordinateState" exact="if $state.$SubordinateState? then $state.$SubordinateState else 'NONE'"/>
            <set_value name="$debugCommanderHasGT" exact="if $state.$CommanderHasGT? then $state.$CommanderHasGT else 'NONE'"/>
          </do_if>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist]   State: SubordinateState=' + $debugSubordinateState + ', CommanderHasGT=' + $debugCommanderHasGT" chance="100"/>
          </do_if>
        </do_if>
      </do_if>
      
      <!-- During abort window, ship.commander may still point to old commander (race condition) -->
      <!-- Solution: Snapshot commander before abort, then emit cleanup unconditionally if it was GT-controlled -->
      <do_if value="$needsCleanup">
        <!-- Snapshot commander BEFORE checking (captures state before abort clears it) -->
        <set_value name="$oldCommander" exact="@this.assignedcontrolled.commander"/>
        <set_value name="$oldCommanderHadGT" exact="false"/>
        <do_if value="@$oldCommander.exists and $oldCommander != this.assignedcontrolled">
          <do_if value="$oldCommander.defaultorder? and (@$oldCommander.defaultorder.id == 'GalaxyTraderMK3' or @$oldCommander.defaultorder.id == 'GalaxyTraderMK2')">
            <set_value name="$oldCommanderHadGT" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Check if ship was subordinate to GT commander (before abort) -->
        <set_value name="$wasSubordinateToGT" exact="false"/>
        <do_if value="$oldCommanderHadGT">
          <set_value name="$wasSubordinateToGT" exact="true"/>
        </do_if>
        <do_elseif value="$state.$SubordinateState? and $state.$SubordinateState == 'subordinate'">
          <do_if value="$state.$CommanderHasGT? and $state.$CommanderHasGT">
            <set_value name="$wasSubordinateToGT" exact="true"/>
          </do_if>
        </do_elseif>
        
        <!-- Check if ship has direct GT order (not via commander) -->
        <set_value name="$hasDirectGTOrder" exact="false"/>
        <do_if value="this.assignedcontrolled.defaultorder? and (@this.assignedcontrolled.defaultorder.id == 'GalaxyTraderMK3' or @this.assignedcontrolled.defaultorder.id == 'GalaxyTraderMK2')">
          <set_value name="$hasDirectGTOrder" exact="true"/>
        </do_if>
        
        <!-- Check if reassigned to NEW GT commander OR newly assigned to GT commander (protect against immediate reassignment/new assignment) -->
        <set_value name="$reassignedToGTCommander" exact="false"/>
        <set_value name="$newlyAssignedToGTCommander" exact="false"/>
        <do_if value="this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists and this.assignedcontrolled.commander != this.assignedcontrolled">
          <!-- Check if this is a new assignment (ship had no commander before) -->
          <do_if value="not @$oldCommander.exists or $oldCommander == null">
            <!-- Ship had no commander before - this is a NEW assignment -->
            <do_if value="this.assignedcontrolled.commander.defaultorder? and (@this.assignedcontrolled.commander.defaultorder.id == 'GalaxyTraderMK3' or @this.assignedcontrolled.commander.defaultorder.id == 'GalaxyTraderMK2')">
              <set_value name="$newlyAssignedToGTCommander" exact="true"/>
              <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
                <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - NEWLY ASSIGNED to GT commander ' + this.assignedcontrolled.commander.idcode + ' - skipping cleanup (Assist order will restart)'" chance="100"/>
              </do_if>
            </do_if>
          </do_if>
          <do_elseif value="this.assignedcontrolled.commander != $oldCommander">
            <!-- Commander changed from one to another - check if new commander has GT order -->
            <do_if value="this.assignedcontrolled.commander.defaultorder? and (@this.assignedcontrolled.commander.defaultorder.id == 'GalaxyTraderMK3' or @this.assignedcontrolled.commander.defaultorder.id == 'GalaxyTraderMK2')">
              <set_value name="$reassignedToGTCommander" exact="true"/>
            </do_if>
          </do_elseif>
        </do_if>
        
        <!-- CRITICAL FIX: Check if ship is STILL subordinate to SAME GT commander -->
        <!-- Assist order can restart (e.g., commander order change) without subordinate being removed -->
        <!-- Key insight: If default order is still "Assist" AND commander is SAME AND commander still has GT, ship is still subordinate -->
        <!-- If commander changed OR commander lost GT order OR default order changed, subordinate relationship ended -->
        <set_value name="$currentDefaultOrder" exact="@this.assignedcontrolled.defaultorder.id"/>
        <set_value name="$currentCommander" exact="null"/>
        <set_value name="$stillHasGTCommander" exact="false"/>
        <set_value name="$isStillSubordinate" exact="false"/>
        
        <!-- Get current commander -->
        <do_if value="this.assignedcontrolled.commander? and this.assignedcontrolled.commander.exists and this.assignedcontrolled.commander != this.assignedcontrolled">
          <set_value name="$currentCommander" exact="this.assignedcontrolled.commander"/>
        </do_if>
        
        <!-- Check if ship is still a subordinate to SAME GT commander -->
        <!-- CRITICAL: Must check if commander is SAME (not just if commander exists) -->
        <do_if value="$currentDefaultOrder == 'Assist' and $currentCommander? and $currentCommander == $oldCommander">
          <set_value name="$isStillSubordinate" exact="true"/>
          <!-- If still subordinate to SAME commander, check if commander still has GT order -->
          <do_if value="$currentCommander.defaultorder? and (@$currentCommander.defaultorder.id == 'GalaxyTraderMK3' or @$currentCommander.defaultorder.id == 'GalaxyTraderMK2')">
            <set_value name="$stillHasGTCommander" exact="true"/>
          </do_if>
        </do_if>
        
        <!-- Trust the removal signal: If Assist order is aborting and ship was subordinate to GT commander, emit cleanup -->
        <!-- Only suppress if ship is STILL subordinate to SAME GT commander OR was reassigned/newly assigned to another GT commander -->
        <!-- CRITICAL: If commander changed OR commander lost GT order OR default order changed, subordinate was removed -->
        <!-- EXCEPTION: Newly assigned ships (had no commander, now have GT commander) should skip cleanup - Assist order will restart -->
        <do_if value="$wasSubordinateToGT and not $reassignedToGTCommander and not $newlyAssignedToGTCommander and not ($isStillSubordinate and $stillHasGTCommander)">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Assist order aborted (subordinate removed from GT commander) - triggering cleanup unconditionally'" chance="100"/>
          </do_if>
          
          <!-- Initialize state if missing -->
          <do_if value="not global.$GT_Ship_State?">
            <set_value name="global.$GT_Ship_State" exact="table[]"/>
          </do_if>
          <do_if value="not global.$GT_Ship_State.{this.assignedcontrolled}?">
            <set_value name="global.$GT_Ship_State.{this.assignedcontrolled}" exact="table[
              $OperationalState = 'orphaned',
              $SubordinateState = 'orphaned',
              $Commander = null,
              $CommanderHasGT = false,
              $HasGTOrder = false,
              $HasAssistOrder = false,
              $ActiveTradeOrders = 0,
              $LastStateUpdate = player.age
            ]"/>
          </do_if>
          
          <set_value name="$state" exact="global.$GT_Ship_State.{this.assignedcontrolled}"/>
          
          <!-- Update state -->
          <set_value name="$state.$HasGTOrder" exact="false"/>
          <set_value name="$state.$OperationalState" exact="'orphaned'"/>
          <set_value name="$state.$ActiveTradeOrders" exact="0"/>
          <set_value name="$state.$Commander" exact="null"/>
          <set_value name="$state.$CommanderHasGT" exact="false"/>
          <set_value name="$state.$SubordinateState" exact="'orphaned'"/>
          <set_value name="$state.$LastStateUpdate" exact="player.age"/>
          
          <!-- Send cleanup signals -->
          <signal_objects object="player.galaxy" param="'GT_Ship_State_Update'" param2="table[
            $Ship = this.assignedcontrolled,
            $UpdateType = 'GT_Order_Cancelled'
          ]"/>
          
          <!-- EVENT-DRIVEN: Trigger orphaned ship check for subordinate -->
          <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.assignedcontrolled}?">
            <signal_objects object="player.galaxy" param="'GT_Check_Ship_Orphaned'" param2="table[$Ship = this.assignedcontrolled]"/>
          </do_if>
          
          <set_value name="$pilot" exact="@this.assignedcontrolled.pilot"/>
          <set_value name="$originalName" exact="null"/>
          <do_if value="$pilot? and global.$GT_Pilots.{$pilot}? and global.$GT_Pilots.{$pilot}.$OriginalShipName?">
            <set_value name="$originalName" exact="global.$GT_Pilots.{$pilot}.$OriginalShipName"/>
          </do_if>
          <do_elseif value="$state.$OriginalShipName?">
            <set_value name="$originalName" exact="$state.$OriginalShipName"/>
          </do_elseif>
          <do_else>
            <set_value name="$originalName" exact="@this.assignedcontrolled.macro.name"/>
          </do_else>
          
          <signal_objects object="player.galaxy" param="'GT_Ship_Order_Aborted'" param2="table[
            $Ship = this.assignedcontrolled,
            $Pilot = $pilot,
            $Reason = 'Assist order aborted - GT order lost - restoring original name',
            $OriginalName = $originalName
          ]"/>
          
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Cleanup signals sent (on_abort handler)'" chance="100"/>
          </do_if>
        </do_if>
        <do_elseif value="$hasDirectGTOrder">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Ship has direct GT order - no cleanup needed'" chance="100"/>
          </do_if>
        </do_elseif>
        <do_elseif value="$reassignedToGTCommander">
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Ship reassigned to new GT commander - no cleanup needed'" chance="100"/>
          </do_if>
        </do_elseif>
        <do_elseif value="$isStillSubordinate and $stillHasGTCommander">
          <!-- NORMAL RESTART: Default order is still "Assist" and commander still has GT order -->
          <!-- This is a normal Assist order restart - ship is still a valid subordinate -->
          <!-- FALLBACK: Schedule delayed verification as safety net if DetectSubordinateRemoval didn't fire -->
          <!-- If ship was actually removed, state might be stale - delayed verification will catch it -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Default order still Assist, commander still has GT - normal restart (scheduling delayed verification as fallback)'" chance="100"/>
          </do_if>
          
          <!-- Only schedule if ship was GT-controlled (fallback for when DetectSubordinateRemoval doesn't fire) -->
          <do_if value="$wasGTControlled and $oldCommanderHadGT">
            <!-- Initialize delayed verification registry if needed -->
            <do_if value="not global.$GT_DelayedVerification?">
              <set_value name="global.$GT_DelayedVerification" exact="table[]"/>
            </do_if>
            
            <!-- Signal MD system to perform delayed verification -->
            <signal_objects object="player.galaxy" param="'GT_Delayed_Verification'" param2="table[
              $Ship = this.assignedcontrolled,
              $CheckTime = player.age
            ]"/>
            
            <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
              <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Scheduled delayed verification as fallback (DetectSubordinateRemoval may not have fired)'" chance="100"/>
            </do_if>
          </do_if>
        </do_elseif>
        <do_elseif value="$isStillSubordinate and not $stillHasGTCommander">
          <!-- DELAYED VERIFICATION: Default order is still "Assist" but commander no longer has GT order -->
          <!-- State might not have updated immediately - schedule delayed verification -->
          <!-- This catches cases where "remove all commands and orders" is used but default order hasn't changed yet -->
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Default order still Assist but commander lost GT order - scheduling delayed verification (5s)'" chance="100"/>
          </do_if>
          
          <!-- Initialize delayed verification registry if needed -->
          <do_if value="not global.$GT_DelayedVerification?">
            <set_value name="global.$GT_DelayedVerification" exact="table[]"/>
          </do_if>
          
          <!-- Schedule delayed verification (5 seconds) -->
          <set_value name="global.$GT_DelayedVerification.{this.assignedcontrolled}" exact="player.age + 5s"/>
          
          <!-- Signal MD system to perform delayed verification -->
          <signal_objects object="player.galaxy" param="'GT_Delayed_Verification'" param2="table[
            $Ship = this.assignedcontrolled,
            $CheckTime = player.age + 5s
          ]"/>
        </do_elseif>
        <do_else>
          <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
            <debug_text text="'[GT-Assist] ' + this.assignedcontrolled.idcode + ' - Ship not subordinate to GT commander (default order: ' + (if $currentDefaultOrder then $currentDefaultOrder else 'NONE') + ') - no cleanup needed'" chance="100"/>
          </do_if>
        </do_else>
      </do_if>
    </on_abort>
  </add>
</diff> 