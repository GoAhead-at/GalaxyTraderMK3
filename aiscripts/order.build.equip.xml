<?xml version="1.0" encoding="utf-8"?>
<diff>
  <!-- GalaxyTrader MK3: Build.Equip completion signalling patch -->
  <!-- This patch adds completion signalling to notify the GT system when build.equip (resupply) is complete -->
  
  <!-- ========================================================================= -->
  <!-- START SIGNALING: Trigger ship name update when Equip starts (subordinates) -->
  <!-- ========================================================================= -->
  <!-- Subordinates can be in Equip without GT_ResupplyOrders tracking; UpdateShipName can derive [RESUPPLY]/[MAINTENANCE]
       from active order id (Equip/Resupply/Repair) + GT relationship checks. We just need to trigger the rename. -->
  <add sel="//aiscript[@name='order.build.equip']/attention[@min='unknown']/actions/label[@name='init']" pos="after">
    <set_value name="$gtRelated" exact="false"/>
    <do_if value="global.$GT_Ships? and global.$GT_Ships.{this.ship}?">
      <set_value name="$gtRelated" exact="true"/>
    </do_if>
    <do_elseif value="@this.ship.commander.defaultorder.id == 'GalaxyTraderMK3' or @this.ship.commander.defaultorder.id == 'GalaxyTraderMK2' or @this.ship.commander.defaultorder.id == 'GalaxyTraderMK1'">
      <set_value name="$gtRelated" exact="true"/>
    </do_elseif>
    
    <do_if value="$gtRelated">
      <signal_objects object="player.galaxy" param="'GT_Update_Ship_Name'" param2="table[
        $ship = this.ship,
        $pilot = @this.ship.pilot,
        $nameType = 'trader'
      ]"/>
    </do_if>
  </add>
  
  <!-- ========================================================================= -->
  <!-- COMPLETION SIGNALING: Notify GT system when Build.Equip completes       -->
  <!-- ========================================================================= -->
  <add sel="//aiscript[@name='order.build.equip']/attention[@min='unknown']/actions/label[@name='finish']" pos="before">
    <!-- Signal completion to GalaxyTrader system if this is a GT ship -->
    <do_if value="this.ship.pilot and this.ship.isplayerowned and global.$GT_Pilots? and global.$GT_Pilots.{this.ship.pilot}?">
      <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
        <debug_text text="'[GT-BuildEquip] Build.Equip (Resupply) complete for ' + this.ship.idcode" chance="100"/>
      </do_if>
      
      <!-- LOGGING: Show what was actually restocked when order finishes -->
      <set_value name="$resupplyOrder" exact="@global.$GT_ResupplyOrders.{this.ship}"/>
      <do_if value="$resupplyOrder?">
        <!-- Get "before" values from resupply order tracking -->
        <!-- FIX: Initialize to 0 if null (defensive check) -->
        <set_value name="$beforeCM" exact="@$resupplyOrder.$CountermeasuresBefore"/>
        <set_value name="$beforeCM" exact="if $beforeCM? then $beforeCM else 0"/>
        <set_value name="$beforeUnits" exact="@$resupplyOrder.$UnitsBefore"/>
        <set_value name="$beforeUnits" exact="if $beforeUnits? then $beforeUnits else 0"/>
        <set_value name="$beforeDefenseDrones" exact="@$resupplyOrder.$DefenseDronesBefore"/>
        <set_value name="$beforeDefenseDrones" exact="if $beforeDefenseDrones? then $beforeDefenseDrones else 0"/>
        <set_value name="$beforeCargoDrones" exact="@$resupplyOrder.$CargoDronesBefore"/>
        <set_value name="$beforeCargoDrones" exact="if $beforeCargoDrones? then $beforeCargoDrones else 0"/>
        <set_value name="$beforeLaserTowers" exact="@$resupplyOrder.$LaserTowersBefore"/>
        <set_value name="$beforeLaserTowers" exact="if $beforeLaserTowers? then $beforeLaserTowers else 0"/>
        <set_value name="$beforeRepairDrones" exact="@$resupplyOrder.$RepairDronesBefore"/>
        <set_value name="$beforeRepairDrones" exact="if $beforeRepairDrones? then $beforeRepairDrones else 0"/>
        
        <!-- Get current values -->
        <set_value name="$currentCM" exact="this.ship.ammostorage.countermeasure.count"/>
        <set_value name="$currentUnits" exact="this.ship.units.count"/>
        <set_value name="$currentDefenseDrones" exact="this.ship.units.{macro.ship_gen_s_fightingdrone_01_a_macro}.count"/>
        <set_value name="$currentCargoDrones" exact="this.ship.units.{macro.ship_gen_xs_cargodrone_empty_01_a_macro}.count"/>
        <set_value name="$currentLaserTowers" exact="this.ship.units.{macro.ship_gen_xs_lasertower_01_a_macro}.count"/>
        <set_value name="$currentRepairDrones" exact="this.ship.units.{macro.ship_gen_xs_repairdrone_01_a_macro}.count"/>
        
        <!-- DEBUG: Log before values to see what we're reading -->
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-BuildEquip] Reading resupply order tracking for ' + this.ship.idcode + ': BeforeCM=' + $beforeCM + ', BeforeUnits=' + $beforeUnits" chance="100"/>
        </do_if>
        
        <!-- Calculate what was gained -->
        <set_value name="$cmGained" exact="$currentCM - $beforeCM"/>
        <set_value name="$defenseGained" exact="$currentDefenseDrones - $beforeDefenseDrones"/>
        <set_value name="$cargoGained" exact="$currentCargoDrones - $beforeCargoDrones"/>
        <set_value name="$towersGained" exact="$currentLaserTowers - $beforeLaserTowers"/>
        <set_value name="$repairGained" exact="$currentRepairDrones - $beforeRepairDrones"/>
        <set_value name="$unitsGained" exact="$currentUnits - $beforeUnits"/>
        
        <!-- Build summary of what was restocked -->
        <set_value name="$restockedItems" exact="[]"/>
        <do_if value="$cmGained gt 0">
          <append_to_list name="$restockedItems" exact="'CM +' + $cmGained"/>
        </do_if>
        <do_if value="$defenseGained gt 0">
          <append_to_list name="$restockedItems" exact="'Defense Drones +' + $defenseGained"/>
        </do_if>
        <do_if value="$cargoGained gt 0">
          <append_to_list name="$restockedItems" exact="'Cargo Drones +' + $cargoGained"/>
        </do_if>
        <do_if value="$towersGained gt 0">
          <append_to_list name="$restockedItems" exact="'Laser Towers +' + $towersGained"/>
        </do_if>
        <do_if value="$repairGained gt 0">
          <append_to_list name="$restockedItems" exact="'Repair Drones +' + $repairGained"/>
        </do_if>
        
        <set_value name="$restockedSummary" exact="if $restockedItems.count gt 0 then $restockedItems.{1} + (if $restockedItems.count gt 1 then ', ' + $restockedItems.{2} else '') + (if $restockedItems.count gt 2 then ', ' + $restockedItems.{3} else '') + (if $restockedItems.count gt 3 then ', ' + $restockedItems.{4} else '') + (if $restockedItems.count gt 4 then ', ' + $restockedItems.{5} else '') else 'NOTHING'"/>
        
        <do_if value="@global.$GT_GlobalSettings.$Debug.$EnableDebugLogging">
          <debug_text text="'[GT-BuildEquip] RESTOCKED for ' + this.ship.idcode + ': ' + $restockedSummary" chance="100"/>
          <debug_text text="'[GT-BuildEquip] DETAILED RESTOCK for ' + this.ship.idcode + ':'" chance="100"/>
          <debug_text text="'[GT-BuildEquip]   Countermeasures: ' + $beforeCM + ' ' + $currentCM + ' (gained: ' + $cmGained + ')'" chance="100"/>
          <debug_text text="'[GT-BuildEquip]   Defense Drones: ' + $beforeDefenseDrones + ' ' + $currentDefenseDrones + ' (gained: ' + $defenseGained + ')'" chance="100"/>
          <debug_text text="'[GT-BuildEquip]   Cargo Drones: ' + $beforeCargoDrones + ' ' + $currentCargoDrones + ' (gained: ' + $cargoGained + ')'" chance="100"/>
          <debug_text text="'[GT-BuildEquip]   Laser Towers: ' + $beforeLaserTowers + ' ' + $currentLaserTowers + ' (gained: ' + $towersGained + ')'" chance="100"/>
          <debug_text text="'[GT-BuildEquip]   Repair Drones: ' + $beforeRepairDrones + ' ' + $currentRepairDrones + ' (gained: ' + $repairGained + ')'" chance="100"/>
          <debug_text text="'[GT-BuildEquip]   Total Units: ' + $beforeUnits + ' ' + $currentUnits + ' (gained: ' + $unitsGained + ')'" chance="100"/>
        </do_if>
      </do_if>
      
      <!-- Queue completion notification -->
      <do_if value="not global.$GT_ResupplyCompleteQueue?">
        <set_value name="global.$GT_ResupplyCompleteQueue" exact="[]"/>
      </do_if>
      
      <append_to_list name="global.$GT_ResupplyCompleteQueue" exact="table[
        $ship = this.ship,
        $time = player.age
      ]"/>
      
      <!-- EVENT-DRIVEN: Signal MD cue directly (no polling needed) -->
      <signal_objects object="player.galaxy" param="'GT_ResupplyComplete'"/>
    </do_if>
  </add>
  
</diff>
